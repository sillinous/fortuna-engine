[{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\App.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ErrorBoundary' is defined but never used.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":23,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"ErrorBoundary"},"fix":{"range":[245,304],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'addToast' is assigned a value but never used.","line":87,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":87,"endColumn":19},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\App.tsx:95:21\n  93 |   const [showQuickStart, setShowQuickStart] = useState(false)\n  94 |\n> 95 |   useEffect(() => { setMounted(true) }, [])\n     |                     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  96 |\n  97 |   // ⌘K / Ctrl+K keyboard shortcut for Command Palette\n  98 |   useEffect(() => {","line":95,"column":21,"nodeType":null,"endLine":95,"endColumn":31},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\App.tsx:114:9\n  112 |       const lastView = uxPrefs.lastActiveView as ViewKey\n  113 |       if (lastView && VALID_VIEWS.has(lastView) && state.onboardingComplete) {\n> 114 |         setActiveViewRaw(lastView)\n      |         ^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  115 |       }\n  116 |       setPrefsApplied(true)\n  117 |     }","line":114,"column":9,"nodeType":null,"endLine":114,"endColumn":25},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\App.tsx:123:7\n  121 |   useEffect(() => {\n  122 |     if (!loading && !state.onboardingComplete) {\n> 123 |       setShowQuickStart(true)\n      |       ^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  124 |       setActiveViewRaw('setup')\n  125 |     }\n  126 |   }, [loading, state.onboardingComplete])","line":123,"column":7,"nodeType":null,"endLine":123,"endColumn":24},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\App.tsx:135:7\n  133 |       // Store invite code for WorkspacePanel to pick up\n  134 |       sessionStorage.setItem('fortuna:pending-invite', inviteCode)\n> 135 |       setActiveViewRaw('workspace')\n      |       ^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  136 |       // Clean URL\n  137 |       window.history.replaceState({}, '', window.location.pathname)\n  138 |     }","line":135,"column":7,"nodeType":null,"endLine":135,"endColumn":23},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":153,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":153,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9453,9456],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9453,9456],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useCallback, lazy } from 'react'\nimport { FortunaProvider, useFortuna } from './hooks/useFortuna'\nimport { AuthProvider, useAuth } from './context/AuthContext'\nimport { AuthScreen } from './views/AuthScreen'\nimport { ErrorBoundary } from './components/ErrorBoundary'\nimport { ViewShell } from './components/ViewShell'\nimport { Sidebar } from './components/Sidebar'\nimport { CommandPalette } from './components/CommandPalette'\nimport { ToastProvider, useToasts } from './components/ToastSystem'\nimport { OnboardingTour, hasCompletedTour } from './components/OnboardingTour'\nimport { NavigationProvider } from './context/NavigationContext'\nimport { MobileBottomBar } from './components/MobileBottomBar'\nimport { SaveStatusBar } from './components/SaveStatusBar'\nimport { QuickStartWizard } from './components/QuickStartWizard'\nimport { UXPreferencesToggle } from './components/UXPreferences'\nimport './App.css'\n\n// ─── Code-split views (React.lazy) ─────────────────────────────────────────\n// Dashboard loaded eagerly (most common landing), all others lazy\nimport { Dashboard } from './views/Dashboard'\nimport { DataSetup } from './views/DataSetup'\n\nconst TaxStrategy = lazy(() => import('./views/TaxStrategy').then(m => ({ default: m.TaxStrategy })))\nconst EntityDesign = lazy(() => import('./views/EntityDesign').then(m => ({ default: m.EntityDesign })))\nconst RevenueEngine = lazy(() => import('./views/RevenueEngine').then(m => ({ default: m.RevenueEngine })))\nconst RiskMatrix = lazy(() => import('./views/RiskMatrix').then(m => ({ default: m.RiskMatrix })))\nconst Automations = lazy(() => import('./views/Automations').then(m => ({ default: m.Automations })))\nconst AIAdvisor = lazy(() => import('./views/AIAdvisor').then(m => ({ default: m.AIAdvisor })))\nconst ScenarioModeler = lazy(() => import('./views/ScenarioModeler').then(m => ({ default: m.ScenarioModeler })))\nconst ExecutionTimeline = lazy(() => import('./views/ExecutionTimeline').then(m => ({ default: m.ExecutionTimeline })))\nconst EntityFlow = lazy(() => import('./views/EntityFlow').then(m => ({ default: m.EntityFlow })))\nconst Reports = lazy(() => import('./views/Reports').then(m => ({ default: m.Reports })))\nconst CashFlow = lazy(() => import('./views/CashFlow').then(m => ({ default: m.CashFlow })))\nconst AuditProfiler = lazy(() => import('./views/AuditProfiler').then(m => ({ default: m.AuditProfiler })))\n// v5\nconst ProactiveAlerts = lazy(() => import('./views/ProactiveAlerts').then(m => ({ default: m.ProactiveAlerts })))\nconst TaxCalendar = lazy(() => import('./views/TaxCalendar').then(m => ({ default: m.TaxCalendar })))\nconst DocumentCenter = lazy(() => import('./views/DocumentCenter').then(m => ({ default: m.DocumentCenter })))\nconst DataImport = lazy(() => import('./views/DataImport').then(m => ({ default: m.DataImport })))\nconst DocumentIntake = lazy(() => import('./views/DocumentIntake').then(m => ({ default: m.DocumentIntake })))\nconst Workflows = lazy(() => import('./views/Workflows').then(m => ({ default: m.Workflows })))\n// v6\nconst EntityOptimizer = lazy(() => import('./views/EntityOptimizer').then(m => ({ default: m.EntityOptimizer })))\nconst HealthScore = lazy(() => import('./views/HealthScore').then(m => ({ default: m.HealthScore })))\nconst CPAExport = lazy(() => import('./views/CPAExport').then(m => ({ default: m.CPAExport })))\n// v7\nconst DataManager = lazy(() => import('./views/DataManager').then(m => ({ default: m.DataManager })))\n// v8\nconst FinancialHistory = lazy(() => import('./views/FinancialHistory').then(m => ({ default: m.FinancialHistory })))\nconst TaxDocuments = lazy(() => import('./views/TaxDocuments').then(m => ({ default: m.TaxDocuments })))\nconst RetirementOptimizer = lazy(() => import('./views/RetirementOptimizer').then(m => ({ default: m.RetirementOptimizer })))\nconst StateArbitrage = lazy(() => import('./views/StateArbitrage').then(m => ({ default: m.StateArbitrage })))\n// v9\nconst MultiYearTaxView = lazy(() => import('./views/MultiYearTax').then(m => ({ default: m.MultiYearTaxView })))\nconst DepreciationView = lazy(() => import('./views/DepreciationView').then(m => ({ default: m.DepreciationView })))\nconst TaxCreditsView = lazy(() => import('./views/TaxCreditsView').then(m => ({ default: m.TaxCreditsView })))\n// v9.1\nconst NexusView = lazy(() => import('./views/NexusView').then(m => ({ default: m.NexusView })))\nconst PnLView = lazy(() => import('./views/PnLView').then(m => ({ default: m.PnLView })))\n// v10\nconst PaycheckSimulator = lazy(() => import('./views/PaycheckSimulator').then(m => ({ default: m.PaycheckSimulator })))\nconst DeductionDiscovery = lazy(() => import('./views/DeductionDiscovery').then(m => ({ default: m.DeductionDiscovery })))\nconst MarginalRateView = lazy(() => import('./views/MarginalRateView').then(m => ({ default: m.MarginalRateView })))\nconst GoalPlanner = lazy(() => import('./views/GoalPlanner').then(m => ({ default: m.GoalPlanner })))\nconst TaxPrepChecklist = lazy(() => import('./views/TaxPrepChecklist').then(m => ({ default: m.TaxPrepChecklist })))\nconst WorkspacePanel = lazy(() => import('./views/WorkspacePanel').then(m => ({ default: m.WorkspacePanel })))\nconst PortfolioIntelligence = lazy(() => import('./views/PortfolioIntelligence').then(m => ({ default: m.PortfolioIntelligence })))\nconst MarketIntelligence = lazy(() => import('./views/MarketIntelligence'))\nconst QuickBooksImport = lazy(() => import('./views/QuickBooksImport'))\nconst FinTechConnections = lazy(() => import('./views/FinTechConnections'))\nconst TransactionReview = lazy(() => import('./views/TransactionReview'))\nconst FinTechHub = lazy(() => import('./views/FinTechHub'))\nconst ReceiptReconciler = lazy(() => import('./views/ReceiptReconciler').then(m => ({ default: m.ReceiptReconciler })))\n\nexport type ViewKey = 'dashboard' | 'tax' | 'entity' | 'revenue' | 'risk' | 'automations' | 'advisor' | 'setup' | 'scenarios' | 'timeline' | 'flow' | 'reports' | 'cashflow' | 'audit' | 'alerts' | 'calendar' | 'documents' | 'import' | 'receipt-scan' | 'workflows' | 'optimizer' | 'health' | 'cpa' | 'data' | 'history' | 'taxdocs' | 'retirement' | 'arbitrage' | 'multiyear' | 'depreciation' | 'credits' | 'nexus' | 'pnl' | 'paycheck' | 'deductions' | 'marginal' | 'goals' | 'taxprep' | 'workspace' | 'portfolio' | 'quickbooks' | 'fintech' | 'fintech-hub' | 'txn-review' | 'receipt-reconcile'\n\nconst VALID_VIEWS = new Set<ViewKey>([\n  'dashboard','tax','entity','revenue','risk','automations','advisor','setup',\n  'scenarios','timeline','flow','reports','cashflow','audit','alerts','calendar',\n  'documents', 'import', 'receipt-scan', 'workflows', 'optimizer', 'health', 'cpa', 'data', 'history', 'taxdocs',\n  'retirement','arbitrage','multiyear','depreciation','credits','nexus','pnl',\n  'paycheck', 'deductions', 'marginal', 'goals', 'taxprep', 'workspace', 'portfolio', 'quickbooks', 'fintech', 'fintech-hub', 'txn-review', 'receipt-reconcile',\n])\n\nfunction AppInner() {\n  const { state, loading, healthScore, uxPrefs, updateUXPrefs } = useFortuna()\n  const { addToast } = useToasts()\n  const [activeView, setActiveViewRaw] = useState<ViewKey>('dashboard')\n  const [mounted, setMounted] = useState(false)\n  const [prefsApplied, setPrefsApplied] = useState(false)\n  const [cmdPaletteOpen, setCmdPaletteOpen] = useState(false)\n  const [showTour, setShowTour] = useState(false)\n  const [showQuickStart, setShowQuickStart] = useState(false)\n\n  useEffect(() => { setMounted(true) }, [])\n\n  // ⌘K / Ctrl+K keyboard shortcut for Command Palette\n  useEffect(() => {\n    const handler = (e: KeyboardEvent) => {\n      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {\n        e.preventDefault()\n        setCmdPaletteOpen(prev => !prev)\n      }\n    }\n    window.addEventListener('keydown', handler)\n    return () => window.removeEventListener('keydown', handler)\n  }, [])\n\n  // Restore last active view + sidebar from UX prefs (once, after loading)\n  useEffect(() => {\n    if (!loading && !prefsApplied) {\n      const lastView = uxPrefs.lastActiveView as ViewKey\n      if (lastView && VALID_VIEWS.has(lastView) && state.onboardingComplete) {\n        setActiveViewRaw(lastView)\n      }\n      setPrefsApplied(true)\n    }\n  }, [loading, prefsApplied, uxPrefs, state.onboardingComplete])\n\n  // Redirect to quick start if onboarding not complete\n  useEffect(() => {\n    if (!loading && !state.onboardingComplete) {\n      setShowQuickStart(true)\n      setActiveViewRaw('setup')\n    }\n  }, [loading, state.onboardingComplete])\n\n  // Detect ?invite=CODE in URL and navigate to workspace\n  useEffect(() => {\n    const params = new URLSearchParams(window.location.search)\n    const inviteCode = params.get('invite')\n    if (inviteCode) {\n      // Store invite code for WorkspacePanel to pick up\n      sessionStorage.setItem('fortuna:pending-invite', inviteCode)\n      setActiveViewRaw('workspace')\n      // Clean URL\n      window.history.replaceState({}, '', window.location.pathname)\n    }\n  }, [])\n\n  // Persist active view changes\n  const setActiveView = useCallback((view: ViewKey) => {\n    setActiveViewRaw(view)\n    updateUXPrefs({ lastActiveView: view })\n  }, [updateUXPrefs])\n\n  // Persist sidebar collapsed state\n  const sidebarCollapsed = uxPrefs.sidebarCollapsed\n  const toggleSidebar = useCallback(() => {\n    updateUXPrefs({ sidebarCollapsed: !sidebarCollapsed })\n  }, [sidebarCollapsed, updateUXPrefs])\n\n  const highPriorityCount = state.strategies.filter((s: any) => s.priority === 'critical' || s.priority === 'high').length\n\n  const renderView = useCallback(() => {\n    switch (activeView) {\n      case 'setup': return <DataSetup onComplete={() => {\n        if (!hasCompletedTour()) {\n          setShowTour(true)\n        }\n        setActiveView('dashboard')\n      }} editMode={state.onboardingComplete} />\n      case 'dashboard': return <Dashboard onNavigate={setActiveView} />\n      case 'tax': return <TaxStrategy />\n      case 'entity': return <EntityDesign />\n      case 'revenue': return <RevenueEngine />\n      case 'risk': return <RiskMatrix />\n      case 'automations': return <Automations />\n      case 'advisor': return <AIAdvisor />\n      case 'scenarios': return <ScenarioModeler />\n      case 'timeline': return <ExecutionTimeline />\n      case 'flow': return <EntityFlow />\n      case 'reports': return <Reports />\n      case 'cashflow': return <CashFlow />\n      case 'audit': return <AuditProfiler />\n      // v5\n      case 'alerts': return <ProactiveAlerts onNavigate={setActiveView} />\n      case 'calendar': return <TaxCalendar />\n      case 'documents': return <DocumentCenter />\n      case 'import': return <DataImport />\n      case 'document-scan': return <DocumentIntake />\n      case 'workflows': return <Workflows onNavigate={setActiveView} />\n      // v6\n      case 'optimizer': return <EntityOptimizer />\n      case 'health': return <HealthScore onNavigate={setActiveView} />\n      case 'cpa': return <CPAExport />\n      // v7\n      case 'data': return <DataManager />\n      // v8\n      case 'history': return <FinancialHistory />\n      case 'taxdocs': return <TaxDocuments />\n      case 'retirement': return <RetirementOptimizer />\n      case 'arbitrage': return <StateArbitrage />\n      // v9\n      case 'multiyear': return <MultiYearTaxView onNavigate={setActiveView} />\n      case 'depreciation': return <DepreciationView onNavigate={setActiveView} />\n      case 'credits': return <TaxCreditsView onNavigate={setActiveView} />\n      // v9.1\n      case 'nexus': return <NexusView />\n      case 'pnl': return <PnLView />\n      // v10\n      case 'paycheck': return <PaycheckSimulator />\n      case 'deductions': return <DeductionDiscovery />\n      case 'marginal': return <MarginalRateView />\n      case 'goals': return <GoalPlanner />\n      case 'taxprep': return <TaxPrepChecklist />\n      case 'workspace': return <WorkspacePanel />\n      case 'portfolio': return <PortfolioIntelligence />\n      case 'markets': return <MarketIntelligence />\n      case 'quickbooks': return <QuickBooksImport />\n      case 'fintech': return <FinTechConnections />\n      case 'txn-review': return <TransactionReview />\n      case 'fintech-hub': return <FinTechHub />\n      case 'receipt-reconcile': return <ReceiptReconciler />\n      default: return <Dashboard onNavigate={setActiveView} />\n    }\n  }, [activeView, state.onboardingComplete, setActiveView])\n\n  if (loading) {\n    return (\n      <div style={{ height: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'var(--bg-void)' }}>\n        <div style={{ textAlign: 'center' }}>\n          <div style={{\n            width: 48, height: 48, borderRadius: 14,\n            background: 'linear-gradient(135deg, var(--accent-gold), #b8912e)',\n            display: 'flex', alignItems: 'center', justifyContent: 'center',\n            margin: '0 auto 16px', boxShadow: '0 4px 24px rgba(212,168,67,0.3)',\n            animation: 'pulse 1.5s ease-in-out infinite',\n          }}>\n            <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#0c0e12\" strokeWidth=\"2.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n              <path d=\"M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z\" />\n            </svg>\n          </div>\n          <div style={{ fontFamily: 'var(--font-display)', fontSize: 28, color: 'var(--accent-gold)', marginBottom: 8 }}>Fortuna</div>\n          <div style={{ fontFamily: 'var(--font-mono)', fontSize: 11, color: 'var(--text-muted)', letterSpacing: '0.15em' }}>\n            LOADING ENGINE...\n          </div>\n        </div>\n      </div>\n    )\n  }\n\n  return (\n    <NavigationProvider onNavigate={setActiveView} currentView={activeView}>\n    <div className={`app-root ${mounted ? 'mounted' : ''}`}>\n      {/* Skip to content — accessibility */}\n      <a href=\"#main-content\" className=\"skip-to-content\">Skip to main content</a>\n      <div className=\"app-bg\" aria-hidden=\"true\" />\n      <div className=\"app-grain\" aria-hidden=\"true\" />\n\n      {/* Quick Start Wizard for first-time users */}\n      {showQuickStart && !state.onboardingComplete && (\n        <main id=\"main-content\" className=\"main-content no-sidebar\" style={{ marginLeft: 0 }}>\n          <QuickStartWizard\n            onComplete={(navigateTo) => {\n              setShowQuickStart(false)\n              if (!hasCompletedTour()) setShowTour(true)\n              setActiveView(navigateTo || 'dashboard')\n            }}\n            onSkipToFull={() => {\n              setShowQuickStart(false)\n              setActiveView('setup')\n            }}\n          />\n        </main>\n      )}\n\n      {/* Normal app shell */}\n      {(!showQuickStart || state.onboardingComplete) && (\n        <>\n          {activeView !== 'setup' && (\n            <Sidebar\n              activeView={activeView}\n              onNavigate={setActiveView}\n              collapsed={sidebarCollapsed}\n              onToggle={toggleSidebar}\n              notificationCount={highPriorityCount}\n              healthScore={healthScore.overall}\n              healthChange={healthScore.grade}\n            />\n          )}\n          <main\n            id=\"main-content\"\n            className={`main-content ${sidebarCollapsed ? 'expanded' : ''} ${activeView === 'setup' ? 'no-sidebar' : ''}`}\n            style={{ ...(activeView === 'setup' ? { marginLeft: 0 } : {}), paddingBottom: 36 }}\n            role=\"main\"\n            aria-label={`${activeView} view`}\n          >\n            <ViewShell view={activeView} state={state} onNavigate={setActiveView}>\n                {renderView()}\n            </ViewShell>\n          </main>\n\n          {/* Mobile Bottom Bar — hidden on desktop via CSS */}\n          {activeView !== 'setup' && (\n            <MobileBottomBar activeView={activeView} onNavigate={setActiveView} />\n          )}\n\n          {/* Save Status Bar — persistent bottom indicator */}\n          <SaveStatusBar />\n        </>\n      )}\n\n      {/* Command Palette */}\n      <CommandPalette\n        isOpen={cmdPaletteOpen}\n        onClose={() => setCmdPaletteOpen(false)}\n        onNavigate={(view) => { setActiveView(view); setCmdPaletteOpen(false) }}\n      />\n      {/* UX Preferences Toggle */}\n      <UXPreferencesToggle />\n      {/* Onboarding Tour */}\n      {showTour && (\n        <OnboardingTour onComplete={(view) => {\n          setShowTour(false)\n          if (view) setActiveView(view)\n        }} />\n      )}\n      {/* ⌘K hint — hide on mobile */}\n      {activeView !== 'setup' && !cmdPaletteOpen && (\n        <button\n          onClick={() => setCmdPaletteOpen(true)}\n          className=\"hide-mobile\"\n          aria-label=\"Open command palette (Command+K)\"\n          style={{\n            position: 'fixed', bottom: 16, left: '50%', transform: 'translateX(-50%)',\n            zIndex: 100, display: 'flex', alignItems: 'center', gap: 6,\n            padding: '6px 14px', borderRadius: 8,\n            background: 'var(--bg-elevated)', border: '1px solid var(--border-subtle)',\n            cursor: 'pointer', fontFamily: 'var(--font-mono)', fontSize: 11,\n            color: 'var(--text-muted)', opacity: 0.5, transition: 'opacity 0.2s',\n          }}\n          onMouseEnter={e => (e.currentTarget.style.opacity = '1')}\n          onMouseLeave={e => (e.currentTarget.style.opacity = '0.5')}\n        >\n          ⌘K to search\n        </button>\n      )}\n    </div>\n    </NavigationProvider>\n  )\n}\n\nfunction AuthGate() {\n  const { isLoggedIn, isLoading, isOfflineMode } = useAuth()\n  \n  if (isLoading) {\n    return (\n      <div style={{\n        minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center',\n        background: '#0a0e1a', color: '#fbbf24', fontFamily: \"'Inter', sans-serif\",\n      }}>\n        <div style={{ textAlign: 'center' }}>\n          <div style={{ fontSize: '2rem', marginBottom: '1rem' }}>⚡</div>\n          <div style={{ fontSize: '0.9rem', color: '#9ca3af' }}>Loading Fortuna Engine...</div>\n        </div>\n      </div>\n    )\n  }\n  \n  if (!isLoggedIn && !isOfflineMode) {\n    return <AuthScreen />\n  }\n  \n  return (\n    <FortunaProvider>\n      <AppInner />\n    </FortunaProvider>\n  )\n}\n\nfunction App() {\n  return (\n    <ToastProvider>\n      <AuthProvider>\n        <AuthGate />\n      </AuthProvider>\n    </ToastProvider>\n  )\n}\n\nexport default App\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\CommandPalette.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Flame' is defined but never used.","line":9,"column":59,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":64,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Flame"},"fix":{"range":[486,493],"text":""},"desc":"Remove unused variable \"Flame\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Command' is defined but never used.","line":10,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":10,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Command"},"fix":{"range":[493,504],"text":""},"desc":"Remove unused variable \"Command\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'taxReport' is assigned a value but never used.","line":60,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":60,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'healthScore' is assigned a value but never used.","line":60,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":60,"endColumn":52},{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot reassign variable after render completes\n\nReassigning `lastCategory` after render has completed can cause inconsistent behavior on subsequent renders. Consider using state instead.\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\CommandPalette.tsx:303:13\n  301 |           {filtered.map((item, i) => {\n  302 |             const showHeader = item.category !== lastCategory\n> 303 |             lastCategory = item.category\n      |             ^^^^^^^^^^^^ Cannot reassign `lastCategory` after render completes\n  304 |             return (\n  305 |               <div key={item.id}>\n  306 |                 {showHeader && (","line":303,"column":13,"nodeType":null,"endLine":303,"endColumn":25}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef, useMemo, useCallback } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport type { ViewKey } from '../App'\nimport {\n  Search, LayoutDashboard, Receipt, Building2, TrendingUp, Shield,\n  ShieldAlert, Zap, Bot, BarChart3, Calendar, FileText, Wallet,\n  Bell, CalendarClock, FileOutput, Upload, Compass, Activity,\n  Scale, Briefcase, Database, History, FileSpreadsheet, PiggyBank,\n  MapPin, Settings, ArrowRight, Hash, DollarSign, Target, Flame,\n  Command, CornerDownLeft, Package, Award, Sparkles, Users,\n} from 'lucide-react'\n\ninterface CommandItem {\n  id: string\n  label: string\n  sublabel?: string\n  icon: React.ReactNode\n  category: 'navigation' | 'action' | 'data' | 'strategy'\n  action: () => void\n  keywords: string[]\n}\n\ninterface CommandPaletteProps {\n  isOpen: boolean\n  onClose: () => void\n  onNavigate: (view: ViewKey) => void\n}\n\n// Fuzzy match scoring\nfunction fuzzyScore(query: string, target: string): number {\n  const q = query.toLowerCase()\n  const t = target.toLowerCase()\n  if (t === q) return 100\n  if (t.startsWith(q)) return 90\n  if (t.includes(q)) return 70\n  // Fuzzy: all characters appear in order\n  let qi = 0\n  let consecutive = 0\n  let maxConsecutive = 0\n  let score = 0\n  for (let ti = 0; ti < t.length && qi < q.length; ti++) {\n    if (t[ti] === q[qi]) {\n      qi++\n      consecutive++\n      maxConsecutive = Math.max(maxConsecutive, consecutive)\n      score += consecutive * 2 // bonus for consecutive matches\n    } else {\n      consecutive = 0\n    }\n  }\n  if (qi < q.length) return 0 // not all chars matched\n  return Math.min(60, score + maxConsecutive * 5)\n}\n\nfunction bestScore(query: string, keywords: string[]): number {\n  return Math.max(...keywords.map(kw => fuzzyScore(query, kw)))\n}\n\nexport function CommandPalette({ isOpen, onClose, onNavigate }: CommandPaletteProps) {\n  const { state, taxReport, strategies, healthScore, takeManualSnapshot } = useFortuna()\n  const [query, setQuery] = useState('')\n  const [selectedIndex, setSelectedIndex] = useState(0)\n  const inputRef = useRef<HTMLInputElement>(null)\n  const listRef = useRef<HTMLDivElement>(null)\n\n  // Focus input when opened\n  useEffect(() => {\n    if (isOpen) {\n      setQuery('')\n      setSelectedIndex(0)\n      setTimeout(() => inputRef.current?.focus(), 50)\n    }\n  }, [isOpen])\n\n  // Build command items\n  const allItems = useMemo((): CommandItem[] => {\n    const nav: CommandItem[] = [\n      { id: 'nav-dashboard', label: 'Command Center', sublabel: 'Dashboard overview', icon: <LayoutDashboard size={16} />, category: 'navigation', action: () => onNavigate('dashboard'), keywords: ['dashboard', 'command center', 'home', 'overview'] },\n      { id: 'nav-health', label: 'Health Score', sublabel: 'Financial wellness', icon: <Activity size={16} />, category: 'navigation', action: () => onNavigate('health'), keywords: ['health', 'score', 'wellness', 'grade'] },\n      { id: 'nav-alerts', label: 'Intelligence Feed', sublabel: 'Proactive alerts', icon: <Bell size={16} />, category: 'navigation', action: () => onNavigate('alerts'), keywords: ['alerts', 'intelligence', 'notifications', 'proactive'] },\n      { id: 'nav-history', label: 'Financial History', sublabel: 'Trends & snapshots', icon: <History size={16} />, category: 'navigation', action: () => onNavigate('history'), keywords: ['history', 'trends', 'snapshots', 'timeline'] },\n      { id: 'nav-tax', label: 'Tax Strategy', sublabel: 'Optimization engine', icon: <Receipt size={16} />, category: 'navigation', action: () => onNavigate('tax'), keywords: ['tax', 'strategy', 'optimization', 'deductions'] },\n      { id: 'nav-entity', label: 'Entity Design', sublabel: 'Business structures', icon: <Building2 size={16} />, category: 'navigation', action: () => onNavigate('entity'), keywords: ['entity', 'design', 'llc', 'scorp', 'corporation'] },\n      { id: 'nav-optimizer', label: 'Entity Optimizer', sublabel: 'Structure arbitrage', icon: <Scale size={16} />, category: 'navigation', action: () => onNavigate('optimizer'), keywords: ['optimizer', 'salary', 'distribution', 'breakeven'] },\n      { id: 'nav-flow', label: 'Entity Flow', sublabel: 'Money flow diagram', icon: <ArrowRight size={16} />, category: 'navigation', action: () => onNavigate('flow'), keywords: ['flow', 'entity flow', 'diagram', 'money'] },\n      { id: 'nav-revenue', label: 'Revenue Engine', sublabel: 'Income streams', icon: <TrendingUp size={16} />, category: 'navigation', action: () => onNavigate('revenue'), keywords: ['revenue', 'income', 'streams', 'earnings'] },\n      { id: 'nav-scenarios', label: 'Scenario Modeler', sublabel: 'What-if analysis', icon: <BarChart3 size={16} />, category: 'navigation', action: () => onNavigate('scenarios'), keywords: ['scenario', 'modeler', 'what if', 'simulation'] },\n      { id: 'nav-retirement', label: 'Retirement Optimizer', sublabel: 'SEP IRA, Solo 401k, Roth', icon: <PiggyBank size={16} />, category: 'navigation', action: () => onNavigate('retirement'), keywords: ['retirement', 'sep ira', 'solo 401k', 'roth', 'pension'] },\n      { id: 'nav-arbitrage', label: 'State Arbitrage', sublabel: 'Tax residency optimization', icon: <MapPin size={16} />, category: 'navigation', action: () => onNavigate('arbitrage'), keywords: ['state', 'arbitrage', 'residency', 'relocation', 'move'] },\n      { id: 'nav-multiyear', label: 'Multi-Year Tax', sublabel: 'TCJA sunset, income shifting', icon: <Calendar size={16} />, category: 'navigation', action: () => onNavigate('multiyear'), keywords: ['multi year', 'projection', 'tcja', 'sunset', 'forecast', 'income shifting', 'bracket'] },\n      { id: 'nav-depreciation', label: 'Depreciation & Assets', sublabel: 'Section 179, bonus, MACRS', icon: <Package size={16} />, category: 'navigation', action: () => onNavigate('depreciation'), keywords: ['depreciation', 'section 179', 'bonus', 'macrs', 'asset', 'vehicle', 'home office', 'equipment'] },\n      { id: 'nav-credits', label: 'Tax Credits', sublabel: 'Federal credit optimizer', icon: <Award size={16} />, category: 'navigation', action: () => onNavigate('credits'), keywords: ['credit', 'child tax', 'eitc', 'ev', 'energy', 'education', 'r&d', 'saver'] },\n      { id: 'nav-nexus', label: 'Intelligence Nexus', sublabel: 'Cross-engine compound insights', icon: <Sparkles size={16} />, category: 'navigation', action: () => onNavigate('nexus'), keywords: ['nexus', 'intelligence', 'compound', 'cross engine', 'insights', 'combined'] },\n      { id: 'nav-pnl', label: 'P&L Statement', sublabel: 'Income statement & margins', icon: <FileText size={16} />, category: 'navigation', action: () => onNavigate('pnl'), keywords: ['pnl', 'profit', 'loss', 'income statement', 'margin', 'revenue', 'ebitda', 'net income'] },\n      { id: 'nav-risk', label: 'Risk Matrix', sublabel: 'Vulnerability analysis', icon: <Shield size={16} />, category: 'navigation', action: () => onNavigate('risk'), keywords: ['risk', 'matrix', 'vulnerability'] },\n      { id: 'nav-audit', label: 'Audit Profiler', sublabel: 'IRS DIF scoring', icon: <ShieldAlert size={16} />, category: 'navigation', action: () => onNavigate('audit'), keywords: ['audit', 'profiler', 'irs', 'dif'] },\n      { id: 'nav-cashflow', label: 'Cash Flow', sublabel: 'Monthly projections', icon: <Wallet size={16} />, category: 'navigation', action: () => onNavigate('cashflow'), keywords: ['cash flow', 'monthly', 'projections', 'runway'] },\n      { id: 'nav-workflows', label: 'Guided Workflows', sublabel: 'Mission paths', icon: <Compass size={16} />, category: 'navigation', action: () => onNavigate('workflows'), keywords: ['workflows', 'guided', 'mission', 'optimize'] },\n      { id: 'nav-automations', label: 'Automations', sublabel: 'Rules & triggers', icon: <Zap size={16} />, category: 'navigation', action: () => onNavigate('automations'), keywords: ['automations', 'rules', 'triggers'] },\n      { id: 'nav-timeline', label: 'Timeline', sublabel: 'Execution plan', icon: <Calendar size={16} />, category: 'navigation', action: () => onNavigate('timeline'), keywords: ['timeline', 'execution', 'plan'] },\n      { id: 'nav-calendar', label: 'Tax Calendar', sublabel: 'Deadline tracker', icon: <CalendarClock size={16} />, category: 'navigation', action: () => onNavigate('calendar'), keywords: ['calendar', 'deadlines', 'dates', 'filing'] },\n      { id: 'nav-reports', label: 'Reports', sublabel: 'Comprehensive analysis', icon: <FileText size={16} />, category: 'navigation', action: () => onNavigate('reports'), keywords: ['reports', 'analysis', 'summary'] },\n      { id: 'nav-documents', label: 'Document Center', sublabel: 'Templates & forms', icon: <FileOutput size={16} />, category: 'navigation', action: () => onNavigate('documents'), keywords: ['documents', 'templates', 'forms'] },\n      { id: 'nav-taxdocs', label: 'Tax Documents', sublabel: '1040-ES, Schedule C, audit docs', icon: <FileSpreadsheet size={16} />, category: 'navigation', action: () => onNavigate('taxdocs'), keywords: ['tax documents', '1040', 'schedule c', 'vouchers', 'estimated payments'] },\n      { id: 'nav-cpa', label: 'CPA Export', sublabel: 'Professional handoff', icon: <Briefcase size={16} />, category: 'navigation', action: () => onNavigate('cpa'), keywords: ['cpa', 'export', 'accountant', 'handoff'] },\n      { id: 'nav-advisor', label: 'AI Advisor', sublabel: 'Full-context AI chat', icon: <Bot size={16} />, category: 'navigation', action: () => onNavigate('advisor'), keywords: ['advisor', 'ai', 'chat', 'ask', 'help'] },\n      { id: 'nav-import', label: 'Data Import', sublabel: 'CSV, OFX files', icon: <Upload size={16} />, category: 'navigation', action: () => onNavigate('import'), keywords: ['import', 'csv', 'ofx', 'upload', 'data'] },\n      { id: 'nav-setup', label: 'Edit Profile', sublabel: 'Financial profile', icon: <Settings size={16} />, category: 'navigation', action: () => onNavigate('setup'), keywords: ['setup', 'profile', 'edit', 'settings', 'configure'] },\n      { id: 'nav-data', label: 'Data Manager', sublabel: 'Export, import, backup', icon: <Database size={16} />, category: 'navigation', action: () => onNavigate('data'), keywords: ['data', 'manager', 'backup', 'export'] },\n      { id: 'nav-paycheck', label: 'Paycheck Simulator', sublabel: 'Per-period take-home breakdown', icon: <Wallet size={16} />, category: 'navigation', action: () => onNavigate('paycheck'), keywords: ['paycheck', 'simulator', 'take home', 'net pay', 'gross', 'withholding', 'w2'] },\n      { id: 'nav-deductions', label: 'Deduction Finder', sublabel: 'Discover unclaimed deductions', icon: <Search size={16} />, category: 'navigation', action: () => onNavigate('deductions'), keywords: ['deduction', 'finder', 'discovery', 'unclaimed', 'missed', 'savings'] },\n      { id: 'nav-marginal', label: 'Marginal Rates', sublabel: 'Rate stack visualization', icon: <Shield size={16} />, category: 'navigation', action: () => onNavigate('marginal'), keywords: ['marginal', 'rate', 'bracket', 'stack', 'effective', 'keep'] },\n      { id: 'nav-goals', label: 'Goal Planner', sublabel: 'Reverse-engineer financial targets', icon: <Settings size={16} />, category: 'navigation', action: () => onNavigate('goals'), keywords: ['goal', 'planner', 'target', 'savings', 'income', 'reverse'] },\n      { id: 'nav-taxprep', label: 'Tax Prep Checklist', sublabel: 'Filing readiness tracker', icon: <FileText size={16} />, category: 'navigation', action: () => onNavigate('taxprep'), keywords: ['tax prep', 'checklist', 'filing', 'preparation', 'documents', 'forms'] },\n      { id: 'nav-workspace', label: 'Collaboration', sublabel: 'Workspaces, teams & shared resources', icon: <Users size={16} />, category: 'navigation', action: () => onNavigate('workspace'), keywords: ['workspace', 'team', 'collaborate', 'share', 'members', 'invite'] },\n    ]\n\n    const actions: CommandItem[] = [\n      {\n        id: 'act-snapshot', label: 'Take Financial Snapshot', sublabel: 'Record current state',\n        icon: <Hash size={16} />, category: 'action',\n        action: () => { takeManualSnapshot('Manual snapshot via Command Palette'); onClose() },\n        keywords: ['snapshot', 'record', 'capture'],\n      },\n    ]\n\n    // Dynamic data items — income streams\n    const dataItems: CommandItem[] = state.incomeStreams.filter(s => s.isActive).map(stream => ({\n      id: `data-stream-${stream.id}`, label: stream.name || stream.type, sublabel: `$${stream.annualAmount.toLocaleString()}/yr · ${stream.type}`,\n      icon: <DollarSign size={16} />, category: 'data' as const,\n      action: () => onNavigate('revenue'),\n      keywords: [stream.name, stream.type, 'income', 'stream', 'revenue'].filter(Boolean) as string[],\n    }))\n\n    // Entities\n    state.entities.filter(e => e.isActive).forEach(entity => {\n      dataItems.push({\n        id: `data-entity-${entity.id}`, label: entity.name, sublabel: `${entity.type.toUpperCase()} · ${entity.state}`,\n        icon: <Building2 size={16} />, category: 'data',\n        action: () => onNavigate('entity'),\n        keywords: [entity.name, entity.type, entity.state, 'entity'].filter(Boolean) as string[],\n      })\n    })\n\n    // Strategy items\n    const stratItems: CommandItem[] = strategies.slice(0, 10).map(strat => ({\n      id: `strat-${strat.id}`, label: strat.title, sublabel: `${strat.impactLabel} · ${strat.priority} priority`,\n      icon: <Target size={16} />, category: 'strategy' as const,\n      action: () => onNavigate('tax'),\n      keywords: [strat.title, strat.category, strat.priority, 'strategy'].filter(Boolean) as string[],\n    }))\n\n    // Document items (Scanned intelligence)\n    const docItems: CommandItem[] = state.documents\n      .filter(d => d.status === 'processed')\n      .map(doc => ({\n        id: `doc-${doc.id}`,\n        label: doc.metadata.merchantName || doc.documentType.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '),\n        sublabel: `${doc.metadata.date || doc.dateAdded.split('T')[0]} · ${doc.metadata.totalAmount ? `$${doc.metadata.totalAmount.toLocaleString()}` : 'No amount'}`,\n        icon: doc.documentType === 'receipt' ? <Receipt size={16} /> : <FileText size={16} />,\n        category: 'data' as const,\n        action: () => {\n          // Future: Open specific document modal/view\n          onNavigate('documents')\n        },\n        keywords: [\n          doc.metadata.merchantName,\n          doc.documentType,\n          doc.summary,\n          'document',\n          'receipt',\n          'scan'\n        ].filter(Boolean) as string[],\n      }))\n\n    return [...nav, ...actions, ...dataItems, ...stratItems, ...docItems]\n  }, [state, strategies, onNavigate, takeManualSnapshot, onClose])\n\n  // Filter and sort\n  const filtered = useMemo(() => {\n    if (!query.trim()) {\n      // Show top items by category when empty\n      return allItems.slice(0, 12)\n    }\n    return allItems\n      .map(item => ({ item, score: Math.max(\n        bestScore(query, item.keywords),\n        fuzzyScore(query, item.label),\n        fuzzyScore(query, item.sublabel || ''),\n      )}))\n      .filter(({ score }) => score > 0)\n      .sort((a, b) => b.score - a.score)\n      .slice(0, 12)\n      .map(({ item }) => item)\n  }, [query, allItems])\n\n  // Keyboard navigation\n  const handleKey = useCallback((e: React.KeyboardEvent) => {\n    if (e.key === 'ArrowDown') {\n      e.preventDefault()\n      setSelectedIndex(i => Math.min(i + 1, filtered.length - 1))\n    } else if (e.key === 'ArrowUp') {\n      e.preventDefault()\n      setSelectedIndex(i => Math.max(i - 1, 0))\n    } else if (e.key === 'Enter' && filtered[selectedIndex]) {\n      e.preventDefault()\n      filtered[selectedIndex].action()\n      if (filtered[selectedIndex].category === 'navigation') onClose()\n    } else if (e.key === 'Escape') {\n      onClose()\n    }\n  }, [filtered, selectedIndex, onClose])\n\n  // Scroll selected into view\n  useEffect(() => {\n    const el = listRef.current?.children[selectedIndex] as HTMLElement\n    el?.scrollIntoView({ block: 'nearest' })\n  }, [selectedIndex])\n\n  // Reset selection when query changes\n  useEffect(() => { setSelectedIndex(0) }, [query])\n\n  if (!isOpen) return null\n\n  const categoryLabels: Record<string, string> = {\n    navigation: 'NAVIGATE',\n    action: 'ACTIONS',\n    data: 'YOUR DATA',\n    strategy: 'STRATEGIES',\n  }\n  const categoryColors: Record<string, string> = {\n    navigation: 'var(--accent-gold)',\n    action: 'var(--accent-emerald)',\n    data: 'var(--accent-blue)',\n    strategy: 'var(--accent-purple)',\n  }\n\n  // Group by category\n  let lastCategory = ''\n\n  return (\n    <>\n      {/* Backdrop */}\n      <div\n        onClick={onClose}\n        style={{\n          position: 'fixed', inset: 0, zIndex: 9998,\n          background: 'rgba(0,0,0,0.6)',\n          backdropFilter: 'blur(8px)',\n          animation: 'cmdFadeIn 0.15s ease-out',\n        }}\n      />\n\n      {/* Palette */}\n      <div style={{\n        position: 'fixed', top: '15%', left: '50%', transform: 'translateX(-50%)',\n        width: 560, maxHeight: '60vh', zIndex: 9999,\n        background: 'var(--bg-elevated)',\n        border: '1px solid var(--border-medium)',\n        borderRadius: 16,\n        boxShadow: '0 24px 80px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.04)',\n        overflow: 'hidden',\n        animation: 'cmdSlideIn 0.2s var(--ease-spring)',\n      }}>\n        {/* Search input */}\n        <div style={{\n          display: 'flex', alignItems: 'center', gap: 12,\n          padding: '16px 20px',\n          borderBottom: '1px solid var(--border-subtle)',\n        }}>\n          <Search size={18} color=\"var(--text-muted)\" />\n          <input\n            ref={inputRef}\n            type=\"text\"\n            placeholder=\"Search views, actions, data...\"\n            value={query}\n            onChange={e => setQuery(e.target.value)}\n            onKeyDown={handleKey}\n            style={{\n              flex: 1, background: 'none', border: 'none', outline: 'none',\n              fontFamily: 'var(--font-body)', fontSize: 15, color: 'var(--text-primary)',\n            }}\n          />\n          <div style={{\n            display: 'flex', alignItems: 'center', gap: 4,\n            padding: '3px 8px', borderRadius: 6,\n            background: 'var(--bg-surface)', border: '1px solid var(--border-subtle)',\n            fontSize: 10, color: 'var(--text-muted)', fontFamily: 'var(--font-mono)',\n          }}>\n            ESC\n          </div>\n        </div>\n\n        {/* Results */}\n        <div ref={listRef} style={{ maxHeight: 'calc(60vh - 60px)', overflowY: 'auto', padding: '4px 0' }}>\n          {filtered.length === 0 && (\n            <div style={{ padding: '24px 20px', textAlign: 'center', color: 'var(--text-muted)', fontSize: 13 }}>\n              No matches for \"{query}\"\n            </div>\n          )}\n          {filtered.map((item, i) => {\n            const showHeader = item.category !== lastCategory\n            lastCategory = item.category\n            return (\n              <div key={item.id}>\n                {showHeader && (\n                  <div style={{\n                    padding: '8px 20px 4px',\n                    fontSize: 10, fontWeight: 600, letterSpacing: '0.1em',\n                    color: categoryColors[item.category] || 'var(--text-muted)',\n                    fontFamily: 'var(--font-mono)',\n                  }}>\n                    {categoryLabels[item.category] || item.category.toUpperCase()}\n                  </div>\n                )}\n                <button\n                  onClick={() => { item.action(); if (item.category === 'navigation') onClose() }}\n                  onMouseEnter={() => setSelectedIndex(i)}\n                  style={{\n                    display: 'flex', alignItems: 'center', gap: 12,\n                    width: '100%', padding: '10px 20px',\n                    background: i === selectedIndex ? 'var(--bg-hover)' : 'transparent',\n                    border: 'none', cursor: 'pointer',\n                    fontFamily: 'var(--font-body)',\n                    transition: 'background 0.1s',\n                    textAlign: 'left',\n                  }}\n                >\n                  <div style={{\n                    width: 32, height: 32, borderRadius: 8, flexShrink: 0,\n                    background: `${categoryColors[item.category] || 'var(--accent-gold)'}15`,\n                    display: 'flex', alignItems: 'center', justifyContent: 'center',\n                    color: categoryColors[item.category] || 'var(--accent-gold)',\n                  }}>\n                    {item.icon}\n                  </div>\n                  <div style={{ flex: 1, minWidth: 0 }}>\n                    <div style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)' }}>{item.label}</div>\n                    {item.sublabel && (\n                      <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 1 }}>{item.sublabel}</div>\n                    )}\n                  </div>\n                  {i === selectedIndex && (\n                    <div style={{\n                      display: 'flex', alignItems: 'center', gap: 4,\n                      fontSize: 10, color: 'var(--text-muted)', fontFamily: 'var(--font-mono)',\n                    }}>\n                      <CornerDownLeft size={12} /> Enter\n                    </div>\n                  )}\n                </button>\n              </div>\n            )\n          })}\n        </div>\n\n        {/* Footer */}\n        <div style={{\n          display: 'flex', justifyContent: 'space-between', alignItems: 'center',\n          padding: '8px 20px',\n          borderTop: '1px solid var(--border-subtle)',\n          fontSize: 10, color: 'var(--text-muted)', fontFamily: 'var(--font-mono)',\n        }}>\n          <span>{filtered.length} result{filtered.length !== 1 ? 's' : ''}</span>\n          <div style={{ display: 'flex', gap: 12 }}>\n            <span>↑↓ Navigate</span>\n            <span>↵ Open</span>\n            <span>ESC Close</span>\n          </div>\n        </div>\n      </div>\n    </>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\CompletionTracker.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":19,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[606,609],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[606,609],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":45,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1342,1345],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1342,1345],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":77,"column":78,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":81,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2274,2277],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2274,2277],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":116,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":116,"endColumn":34},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":116,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":116,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3349,3352],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3349,3352],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE — Profile Completion Tracker (Phase 2 UX Fix)\n *\n * Shows \"Your tax profile is 73% complete\" with specific missing items.\n * Motivates users to fill in data to unlock better recommendations.\n * Can appear as a banner, sidebar widget, or full panel.\n */\n\nimport { useFortuna } from '../hooks/useFortuna'\nimport type { ViewKey } from '../App'\nimport { CheckCircle2, Circle, ArrowRight, Sparkles } from 'lucide-react'\n\n// ─── Completion Criteria ────────────────────────────────────────────\n\ninterface CompletionItem {\n  id: string\n  label: string\n  description: string\n  check: (state: any) => boolean\n  navigateTo: ViewKey\n  weight: number // importance: 1-3\n}\n\nconst COMPLETION_ITEMS: CompletionItem[] = [\n  {\n    id: 'filing_status',\n    label: 'Filing status',\n    description: 'Determines your standard deduction and tax brackets',\n    check: (s) => !!s.filingStatus && s.filingStatus !== 'single',\n    navigateTo: 'setup',\n    weight: 3,\n  },\n  {\n    id: 'state',\n    label: 'State of residence',\n    description: 'Needed for state tax calculations',\n    check: (s) => !!s.stateCode && s.stateCode.length === 2,\n    navigateTo: 'setup',\n    weight: 3,\n  },\n  {\n    id: 'income',\n    label: 'At least one income source',\n    description: 'Needed for any tax calculations',\n    check: (s) => s.incomeStreams?.some((i: any) => i.isActive && i.annualAmount > 0),\n    navigateTo: 'setup',\n    weight: 3,\n  },\n  {\n    id: 'expenses',\n    label: 'Business expenses',\n    description: 'Reduces your taxable income',\n    check: (s) => s.expenses?.length > 0,\n    navigateTo: 'setup',\n    weight: 2,\n  },\n  {\n    id: 'dependents',\n    label: 'Dependents',\n    description: 'May qualify you for child tax credit and lower rates',\n    check: (s) => s.profile?.dependents !== undefined,\n    navigateTo: 'setup',\n    weight: 1,\n  },\n  {\n    id: 'entity_type',\n    label: 'Business entity type',\n    description: 'Affects how your business income is taxed',\n    check: (s) => s.entities?.length > 0 || !!s.entityType,\n    navigateTo: 'entity',\n    weight: 2,\n  },\n  {\n    id: 'retirement',\n    label: 'Retirement accounts',\n    description: 'Unlock retirement optimization strategies',\n    check: (s) => s.retirementAccounts?.length > 0 || s.deductions?.some((d: any) => d.category === 'retirement'),\n    navigateTo: 'retirement',\n    weight: 2,\n  },\n  {\n    id: 'crypto',\n    label: 'Crypto or investment data',\n    description: 'Enables cost basis tracking and tax-loss harvesting',\n    check: (s) => s.cryptoTransactions?.length > 0 || s.investments?.length > 0,\n    navigateTo: 'import',\n    weight: 1,\n  },\n  {\n    id: 'estimated_payments',\n    label: 'Estimated tax payments',\n    description: 'Avoids underpayment penalty',\n    check: (s) => s.estimatedPayments?.length > 0 || s.profile?.estimatedPayments > 0,\n    navigateTo: 'setup',\n    weight: 1,\n  },\n  {\n    id: 'goals',\n    label: 'Financial goals',\n    description: 'Personalizes recommendations to your priorities',\n    check: (s) => s.goals?.length > 0,\n    navigateTo: 'goals',\n    weight: 1,\n  },\n]\n\n// ─── Compute Completion ─────────────────────────────────────────────\n\nexport interface CompletionResult {\n  percentage: number\n  completed: CompletionItem[]\n  missing: CompletionItem[]\n  topPriority: CompletionItem | null\n}\n\nexport function computeCompletion(state: any): CompletionResult {\n  const completed = COMPLETION_ITEMS.filter(item => item.check(state))\n  const missing = COMPLETION_ITEMS.filter(item => !item.check(state))\n\n  const totalWeight = COMPLETION_ITEMS.reduce((s, i) => s + i.weight, 0)\n  const completedWeight = completed.reduce((s, i) => s + i.weight, 0)\n  const percentage = Math.round((completedWeight / totalWeight) * 100)\n\n  // Top priority = highest weight among missing\n  const topPriority = missing.sort((a, b) => b.weight - a.weight)[0] || null\n\n  return { percentage, completed, missing, topPriority }\n}\n\n// ─── Banner Component ───────────────────────────────────────────────\n\nexport function CompletionBanner({ onNavigate }: { onNavigate: (view: ViewKey) => void }) {\n  const { state } = useFortuna()\n  const { percentage, missing, topPriority } = computeCompletion(state)\n\n  if (percentage >= 100) return null\n\n  return (\n    <div style={{\n      display: 'flex', alignItems: 'center', gap: 14,\n      padding: '12px 16px', borderRadius: 12,\n      background: 'var(--accent-gold-dim)',\n      border: '1px solid rgba(212,168,67,0.15)',\n      marginBottom: 16,\n    }}\n    role=\"status\"\n    aria-label={`Profile ${percentage}% complete`}\n    >\n      {/* Circular progress */}\n      <div style={{ position: 'relative', width: 44, height: 44, flexShrink: 0 }}>\n        <svg width={44} height={44} viewBox=\"0 0 44 44\" style={{ transform: 'rotate(-90deg)' }}>\n          <circle cx={22} cy={22} r={18} fill=\"none\" stroke=\"var(--bg-surface)\" strokeWidth={3} />\n          <circle cx={22} cy={22} r={18} fill=\"none\" stroke=\"var(--accent-gold)\" strokeWidth={3}\n            strokeDasharray={`${(percentage / 100) * 113.1} 113.1`}\n            strokeLinecap=\"round\"\n          />\n        </svg>\n        <span style={{\n          position: 'absolute', inset: 0, display: 'flex', alignItems: 'center', justifyContent: 'center',\n          fontSize: 11, fontWeight: 600, fontFamily: 'var(--font-mono)', color: 'var(--accent-gold)',\n        }}>\n          {percentage}%\n        </span>\n      </div>\n\n      <div style={{ flex: 1, minWidth: 0 }}>\n        <div style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)' }}>\n          Your tax profile is {percentage}% complete\n        </div>\n        <div style={{ fontSize: 12, color: 'var(--text-secondary)', marginTop: 2 }}>\n          {missing.length} item{missing.length !== 1 ? 's' : ''} remaining.\n          {topPriority && ` Next: ${topPriority.label}`}\n        </div>\n      </div>\n\n      {topPriority && (\n        <button\n          onClick={() => onNavigate(topPriority.navigateTo)}\n          style={{\n            display: 'flex', alignItems: 'center', gap: 6,\n            padding: '6px 14px', borderRadius: 8,\n            background: 'var(--accent-gold)', color: 'var(--bg-primary)',\n            border: 'none', cursor: 'pointer',\n            fontSize: 12, fontWeight: 600, fontFamily: 'var(--font-body)',\n            transition: 'all 0.2s', whiteSpace: 'nowrap',\n          }}\n        >\n          Add {topPriority.label} <ArrowRight size={14} />\n        </button>\n      )}\n    </div>\n  )\n}\n\n// ─── Detailed Checklist ─────────────────────────────────────────────\n\nexport function CompletionChecklist({ onNavigate }: { onNavigate: (view: ViewKey) => void }) {\n  const { state } = useFortuna()\n  const { percentage, completed, missing } = computeCompletion(state)\n\n  return (\n    <div style={{\n      padding: 20, borderRadius: 14,\n      background: 'var(--bg-elevated)',\n      border: '1px solid var(--border-subtle)',\n    }}>\n      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>\n        <div>\n          <div style={{ fontSize: 15, fontWeight: 500, color: 'var(--text-primary)' }}>Profile Completion</div>\n          <div style={{ fontSize: 12, color: 'var(--text-muted)', marginTop: 2 }}>\n            More data = better recommendations\n          </div>\n        </div>\n        <div style={{\n          fontFamily: 'var(--font-mono)', fontSize: 24, fontWeight: 600,\n          color: percentage >= 80 ? 'var(--accent-emerald)' : percentage >= 50 ? 'var(--accent-gold)' : 'var(--accent-red)',\n        }}>\n          {percentage}%\n        </div>\n      </div>\n\n      {/* Progress bar */}\n      <div className=\"progress-bar\" role=\"progressbar\" aria-valuenow={percentage} aria-valuemin={0} aria-valuemax={100} style={{ marginBottom: 16 }}>\n        <div className=\"progress-fill\" style={{\n          width: `${percentage}%`,\n          background: percentage >= 80 ? 'linear-gradient(90deg, var(--accent-emerald), #2dd4bf)'\n            : percentage >= 50 ? 'linear-gradient(90deg, var(--accent-gold), #e0b84d)'\n            : 'linear-gradient(90deg, var(--accent-red), #f87171)',\n        }} />\n      </div>\n\n      {/* Items */}\n      <div style={{ display: 'flex', flexDirection: 'column', gap: 6 }}>\n        {[...missing, ...completed].map(item => {\n          const done = completed.includes(item)\n          return (\n            <button\n              key={item.id}\n              onClick={() => !done && onNavigate(item.navigateTo)}\n              disabled={done}\n              style={{\n                display: 'flex', alignItems: 'center', gap: 10,\n                padding: '8px 10px', borderRadius: 8,\n                background: 'transparent', border: 'none',\n                cursor: done ? 'default' : 'pointer',\n                textAlign: 'left', width: '100%',\n                opacity: done ? 0.5 : 1,\n                transition: 'background 0.15s',\n              }}\n              onMouseEnter={e => { if (!done) e.currentTarget.style.background = 'var(--bg-hover)' }}\n              onMouseLeave={e => { e.currentTarget.style.background = 'transparent' }}\n            >\n              {done\n                ? <CheckCircle2 size={16} color=\"var(--accent-emerald)\" />\n                : <Circle size={16} color=\"var(--text-muted)\" />\n              }\n              <div style={{ flex: 1, minWidth: 0 }}>\n                <div style={{ fontSize: 13, color: done ? 'var(--text-muted)' : 'var(--text-primary)', fontWeight: done ? 400 : 500 }}>\n                  {item.label}\n                </div>\n                {!done && (\n                  <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 1 }}>{item.description}</div>\n                )}\n              </div>\n              {!done && <ArrowRight size={14} color=\"var(--text-muted)\" />}\n            </button>\n          )\n        })}\n      </div>\n\n      {percentage >= 100 && (\n        <div style={{ textAlign: 'center', padding: '16px 0 8px', color: 'var(--accent-emerald)' }}>\n          <Sparkles size={20} style={{ marginBottom: 6 }} />\n          <div style={{ fontSize: 14, fontWeight: 500 }}>Profile complete! All engines are fully powered.</div>\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ContextualHelp.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":22,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":22,"endColumn":53}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE — Contextual Help System (Phase 2 UX Fix)\n *\n * \"Why is this important?\" expandable sections for every concept.\n * Provides plain-English explanations of tax concepts in context.\n * Supports both inline hints and expandable detail panels.\n */\n\nimport { useState, type ReactNode } from 'react'\nimport { HelpCircle, ChevronDown, Lightbulb, ExternalLink } from 'lucide-react'\n\n// ─── Help Content Registry ──────────────────────────────────────────\n\nexport interface HelpEntry {\n  title: string\n  short: string          // One-line inline hint\n  detail: string         // 2-3 sentence expandable explanation\n  example?: string       // Concrete example with numbers\n  learnMore?: string     // External URL\n}\n\nexport const HELP_CONTENT: Record<string, HelpEntry> = {\n  // Filing & Profile\n  filing_status: {\n    title: 'Filing Status',\n    short: 'Determines your standard deduction and bracket widths.',\n    detail: 'Your filing status affects nearly everything — your standard deduction, tax bracket thresholds, eligibility for credits, and phase-out limits. Married Filing Jointly generally gives the most favorable rates.',\n    example: 'A single filer hits the 24% bracket at $100,525, but a married joint filer doesn\\'t hit it until $201,050.',\n  },\n  standard_deduction: {\n    title: 'Standard Deduction',\n    short: 'The amount you subtract from income before taxes are calculated.',\n    detail: 'Most taxpayers take the standard deduction rather than itemizing. It\\'s $14,600 for single filers and $29,200 for married filing jointly in 2024. You only itemize if your total deductions exceed this.',\n  },\n  effective_rate: {\n    title: 'Effective Tax Rate',\n    short: 'Your actual percentage of total income paid in taxes.',\n    detail: 'This is your total tax divided by your total income. It\\'s always lower than your marginal rate because only income above each bracket threshold is taxed at the higher rate. This is the number that actually matters for planning.',\n    example: 'On $100K income, your marginal rate is 24% but your effective rate is closer to 17%.',\n  },\n  marginal_rate: {\n    title: 'Marginal Tax Rate',\n    short: 'The rate applied to your last dollar of income.',\n    detail: 'This is the bracket your top dollar falls in. It matters for decisions about earning more income or taking deductions — every additional dollar earned is taxed at this rate, and every deduction saves you this percentage.',\n    example: 'If you\\'re in the 24% bracket, a $1,000 deduction saves you $240.',\n  },\n  \n  // Self-Employment\n  se_tax: {\n    title: 'Self-Employment Tax',\n    short: '15.3% on net SE income — the biggest surprise for freelancers.',\n    detail: 'When you\\'re self-employed, you pay both the employee AND employer halves of Social Security (12.4%) and Medicare (2.9%). This 15.3% is on top of income tax. The deductible half reduces your AGI, but it\\'s still a significant cost.',\n    example: 'On $100K net SE income, SE tax is about $14,130. Half ($7,065) is deductible.',\n  },\n  qbi_deduction: {\n    title: 'QBI Deduction (§199A)',\n    short: 'Deduct up to 20% of qualified business income.',\n    detail: 'Pass-through business owners (sole props, LLCs, S-Corps) can deduct up to 20% of their qualified business income. There are income limits and restrictions for specified service businesses, but it\\'s one of the largest deductions available.',\n    example: 'On $120K of QBI, the deduction could be up to $24,000 — saving $5,280 at the 22% bracket.',\n  },\n  \n  // Entity Structure\n  s_corp_salary: {\n    title: 'S-Corp Reasonable Salary',\n    short: 'Only your salary is subject to SE tax — distributions are not.',\n    detail: 'S-Corp owners must pay themselves a \"reasonable salary\" subject to payroll taxes. Any remaining profit can be taken as distributions, which avoid the 15.3% SE tax. The IRS watches for unreasonably low salaries.',\n    example: 'On $150K profit, paying $80K salary + $70K distributions saves ~$10,710 in SE tax vs. sole prop.',\n  },\n  entity_comparison: {\n    title: 'Entity Structure',\n    short: 'Your business type affects how income is taxed.',\n    detail: 'Sole proprietorships are simple but pay full SE tax. LLCs provide liability protection. S-Corps let you split income between salary and distributions. C-Corps have a flat 21% rate but face double taxation on dividends.',\n  },\n  \n  // Retirement\n  solo_401k: {\n    title: 'Solo 401(k)',\n    short: 'The most powerful retirement vehicle for the self-employed.',\n    detail: 'A Solo 401(k) lets you contribute as both employee ($23,000 in 2024) and employer (25% of compensation), up to $69,000 total. Every dollar contributed reduces your taxable income dollar-for-dollar.',\n    example: 'Contributing $69,000 at a 32% marginal rate saves $22,080 in federal taxes alone.',\n  },\n  sep_ira: {\n    title: 'SEP-IRA',\n    short: 'Simple retirement savings — up to 25% of net SE income.',\n    detail: 'A SEP-IRA lets self-employed people contribute up to 25% of net self-employment income, up to $69,000. It\\'s simpler to administer than a Solo 401(k) but doesn\\'t allow employee contributions.',\n  },\n  hsa: {\n    title: 'Health Savings Account',\n    short: 'Triple tax advantage — deduction, growth, and withdrawals.',\n    detail: 'An HSA is the only account with triple tax benefits: contributions are deductible, investments grow tax-free, and withdrawals for medical expenses are tax-free. You need a high-deductible health plan. Max: $4,150 single / $8,300 family in 2024.',\n  },\n  \n  // Crypto & Investments\n  cost_basis: {\n    title: 'Cost Basis',\n    short: 'What you paid — determines your gain or loss when you sell.',\n    detail: 'Cost basis is your original investment amount plus any fees. When you sell, your gain or loss is the sale price minus cost basis. Different methods (FIFO, LIFO, Specific ID) can dramatically change your tax bill.',\n    example: 'Bought 1 BTC at $20K, sold at $60K. Cost basis: $20K. Taxable gain: $40K.',\n  },\n  tax_loss_harvesting: {\n    title: 'Tax-Loss Harvesting',\n    short: 'Sell losing investments to offset gains and reduce taxes.',\n    detail: 'Selling investments at a loss creates a capital loss that offsets capital gains dollar-for-dollar. If losses exceed gains, you can deduct up to $3,000 against ordinary income, with unlimited carryforward.',\n    example: 'You have $10K in gains and $15K in losses. Net: $5K loss. Deduct $3K this year, carry $2K forward.',\n  },\n  wash_sale: {\n    title: 'Wash Sale Rule',\n    short: 'Can\\'t claim a loss if you rebuy the same security within 30 days.',\n    detail: 'If you sell a security at a loss and buy a \"substantially identical\" security within 30 days before or after, the loss is disallowed. The disallowed loss gets added to the new shares\\' cost basis. Note: crypto is currently exempt from this rule.',\n  },\n  \n  // Deductions\n  home_office: {\n    title: 'Home Office Deduction',\n    short: 'Deduct a portion of rent, utilities, and internet for your workspace.',\n    detail: 'If you use part of your home exclusively and regularly for business, you can deduct that proportion of housing costs. The simplified method allows $5/sq ft up to 300 sq ft ($1,500). The actual expense method often yields more.',\n    example: 'Home office is 200 sq ft of a 1,500 sq ft home (13.3%). Rent $2,000/mo → $3,200/year deduction.',\n  },\n  section_179: {\n    title: '§179 Expensing',\n    short: 'Deduct the full cost of business equipment in year one.',\n    detail: 'Instead of depreciating equipment over years, §179 lets you deduct the full purchase price in the year you buy it, up to $1,220,000 in 2024. This can dramatically accelerate deductions.',\n    example: 'Buy a $10,000 computer for business. §179 lets you deduct $10,000 this year instead of $2,000/year for 5 years.',\n  },\n  \n  // Risk & Audit\n  audit_risk: {\n    title: 'Audit Risk Score',\n    short: 'How likely the IRS is to examine your return.',\n    detail: 'The IRS uses a DIF (Discriminant Index Function) score to flag returns for audit. High deductions relative to income, large charitable gifts, cash-heavy businesses, and inconsistencies with W-2/1099 data all increase risk.',\n  },\n  estimated_payments: {\n    title: 'Estimated Tax Payments',\n    short: 'Pay-as-you-go quarterly to avoid the underpayment penalty.',\n    detail: 'If you\\'ll owe $1,000+ when filing, the IRS expects quarterly estimated payments (April 15, June 15, September 15, January 15). Safe harbor: pay 100% of last year\\'s tax (110% if AGI > $150K).',\n    example: 'Last year\\'s tax: $40K. Safe harbor quarterly payment: $10K/quarter ($11K if AGI > $150K).',\n  },\n  \n  // State Tax\n  state_income_tax: {\n    title: 'State Income Tax',\n    short: 'Varies from 0% (TX, FL, NV) to 13.3% (CA).',\n    detail: 'Nine states have no income tax. Others range from flat rates (like IL at 4.95%) to highly progressive rates (CA tops at 13.3%). Your state tax often represents 20-40% of your total tax burden.',\n  },\n  salt_cap: {\n    title: 'SALT Deduction Cap',\n    short: 'State and local tax deduction capped at $10,000.',\n    detail: 'The Tax Cuts and Jobs Act capped the state and local tax (SALT) deduction at $10,000. This primarily impacts taxpayers in high-tax states like CA, NY, and NJ who itemize deductions.',\n  },\n  \n  // Multi-Entity\n  cascade_flow: {\n    title: 'Entity Cascade',\n    short: 'How income flows between related business entities.',\n    detail: 'Multi-entity structures can route income through different entities to optimize tax treatment. For example, an S-Corp management company can pay fees to a C-Corp holding intellectual property, splitting income between different tax regimes.',\n  },\n}\n\n// ─── Inline Help Tooltip ────────────────────────────────────────────\n\nexport function HelpTip({ topic, children }: { topic: string; children?: ReactNode }) {\n  const entry = HELP_CONTENT[topic]\n  if (!entry) return <>{children}</>\n\n  return (\n    <span style={{ position: 'relative', display: 'inline-flex', alignItems: 'center', gap: 4 }}>\n      {children}\n      <span\n        title={entry.short}\n        style={{ cursor: 'help', display: 'inline-flex', color: 'var(--text-muted)' }}\n        aria-label={`Help: ${entry.short}`}\n      >\n        <HelpCircle size={13} />\n      </span>\n    </span>\n  )\n}\n\n// ─── Expandable Help Section ────────────────────────────────────────\n\nexport function HelpSection({ topic, compact }: { topic: string; compact?: boolean }) {\n  const [open, setOpen] = useState(false)\n  const entry = HELP_CONTENT[topic]\n  if (!entry) return null\n\n  if (compact) {\n    return (\n      <button\n        onClick={() => setOpen(!open)}\n        style={{\n          display: 'flex', alignItems: 'center', gap: 6,\n          background: 'transparent', border: 'none', cursor: 'pointer',\n          fontSize: 12, color: 'var(--text-muted)', fontFamily: 'var(--font-body)',\n          padding: '4px 0', transition: 'color 0.2s',\n        }}\n        onMouseEnter={e => (e.currentTarget.style.color = 'var(--accent-gold)')}\n        onMouseLeave={e => (e.currentTarget.style.color = 'var(--text-muted)')}\n        aria-expanded={open}\n      >\n        <HelpCircle size={12} />\n        {open ? 'Hide explanation' : 'Why does this matter?'}\n        <ChevronDown size={11} style={{ transition: 'transform 0.2s', transform: open ? 'rotate(180deg)' : 'none' }} />\n      </button>\n    )\n  }\n\n  return (\n    <div style={{ marginTop: 8 }}>\n      <button\n        onClick={() => setOpen(!open)}\n        aria-expanded={open}\n        style={{\n          display: 'flex', alignItems: 'center', gap: 8,\n          width: '100%', padding: '10px 14px', borderRadius: 10,\n          background: open ? 'var(--accent-gold-dim)' : 'var(--bg-surface)',\n          border: `1px solid ${open ? 'rgba(212,168,67,0.2)' : 'var(--border-subtle)'}`,\n          cursor: 'pointer', transition: 'all 0.2s',\n          textAlign: 'left',\n        }}\n      >\n        <Lightbulb size={14} color={open ? 'var(--accent-gold)' : 'var(--text-muted)'} />\n        <span style={{\n          flex: 1, fontSize: 13, fontWeight: 500,\n          color: open ? 'var(--accent-gold)' : 'var(--text-secondary)',\n          fontFamily: 'var(--font-body)',\n        }}>\n          Why is this important?\n        </span>\n        <ChevronDown\n          size={14}\n          color={open ? 'var(--accent-gold)' : 'var(--text-muted)'}\n          style={{ transition: 'transform 0.2s var(--ease-out)', transform: open ? 'rotate(180deg)' : 'none' }}\n        />\n      </button>\n\n      {open && (\n        <div style={{\n          padding: '14px 16px', marginTop: 6, borderRadius: 10,\n          background: 'var(--bg-surface)', border: '1px solid var(--border-subtle)',\n          animation: 'fadeInDown 0.2s ease-out',\n        }}>\n          <div style={{ fontSize: 13, color: 'var(--text-primary)', lineHeight: 1.6, marginBottom: entry.example ? 12 : 0 }}>\n            {entry.detail}\n          </div>\n\n          {entry.example && (\n            <div style={{\n              padding: '10px 12px', borderRadius: 8,\n              background: 'var(--bg-hover)', border: '1px solid var(--border-subtle)',\n              marginBottom: entry.learnMore ? 10 : 0,\n            }}>\n              <div style={{ fontSize: 10, textTransform: 'uppercase', letterSpacing: '0.1em', color: 'var(--text-muted)', fontWeight: 500, marginBottom: 4 }}>\n                Example\n              </div>\n              <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.5, fontFamily: 'var(--font-mono)' }}>\n                {entry.example}\n              </div>\n            </div>\n          )}\n\n          {entry.learnMore && (\n            <a href={entry.learnMore} target=\"_blank\" rel=\"noopener noreferrer\" style={{\n              display: 'inline-flex', alignItems: 'center', gap: 4,\n              fontSize: 12, color: 'var(--accent-blue)', textDecoration: 'none',\n            }}>\n              Learn more <ExternalLink size={11} />\n            </a>\n          )}\n        </div>\n      )}\n    </div>\n  )\n}\n\n// ─── Info Banner ────────────────────────────────────────────────────\n\nexport function InfoBanner({ topic, dismissible }: { topic: string; dismissible?: boolean }) {\n  const [dismissed, setDismissed] = useState(false)\n  const entry = HELP_CONTENT[topic]\n  if (!entry || dismissed) return null\n\n  return (\n    <div style={{\n      display: 'flex', alignItems: 'flex-start', gap: 10,\n      padding: '12px 14px', borderRadius: 10,\n      background: 'rgba(96,165,250,0.06)',\n      border: '1px solid rgba(96,165,250,0.15)',\n      marginBottom: 16,\n    }}\n    role=\"note\"\n    aria-label={entry.title}\n    >\n      <Lightbulb size={16} color=\"var(--accent-blue)\" style={{ flexShrink: 0, marginTop: 1 }} />\n      <div style={{ flex: 1 }}>\n        <div style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)', marginBottom: 2 }}>\n          {entry.title}\n        </div>\n        <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.5 }}>\n          {entry.short}\n        </div>\n      </div>\n      {dismissible && (\n        <button onClick={() => setDismissed(true)} style={{\n          background: 'none', border: 'none', cursor: 'pointer', color: 'var(--text-muted)', padding: 2,\n        }} aria-label=\"Dismiss\">×</button>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\EmptyState.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Plus' is defined but never used.","line":15,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":7,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Plus"},"fix":{"range":[615,623],"text":""},"desc":"Remove unused variable \"Plus\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE — Empty State Component\n * Displays a friendly, actionable empty state when a view has no data.\n * Every view should use this instead of showing blank screens.\n */\n\nimport { type ReactNode } from 'react'\nimport type { ViewKey } from '../App'\nimport {\n  LayoutDashboard, Receipt, Building2, TrendingUp, Shield, ShieldAlert,\n  Zap, Bot, BarChart3, Calendar, FileText, Wallet, Bell, Upload,\n  Compass, Activity, Scale, Briefcase, Database, History, PiggyBank,\n  MapPin, CalendarRange, Package, Award, Brain, CreditCard, Layers,\n  Target, ClipboardCheck, Users, Search, FileSpreadsheet, ArrowRight,\n  Plus, Sparkles,\n} from 'lucide-react'\n\n// ─── Empty State Configs per View ───────────────────────────────────\n\ninterface EmptyConfig {\n  icon: ReactNode\n  iconBg: string\n  title: string\n  description: string\n  ctaLabel: string\n  ctaView?: ViewKey\n  ctaAction?: string\n}\n\nconst EMPTY_CONFIGS: Partial<Record<ViewKey, EmptyConfig>> = {\n  dashboard: {\n    icon: <LayoutDashboard size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-gold), #b8912e)',\n    title: 'Welcome to Fortuna',\n    description: 'Let\\'s set up your financial profile to unlock personalized tax strategies, savings estimates, and intelligent recommendations.',\n    ctaLabel: 'Get Started',\n    ctaView: 'setup',\n  },\n  tax: {\n    icon: <Receipt size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-emerald), #059669)',\n    title: 'No tax data yet',\n    description: 'Add your income and deduction details to see your tax strategy, projected liability, and savings opportunities.',\n    ctaLabel: 'Enter Tax Info',\n    ctaView: 'setup',\n  },\n  entity: {\n    icon: <Building2 size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-blue), #2563eb)',\n    title: 'Design your entity structure',\n    description: 'Compare sole proprietorship, LLC, S-Corp, and C-Corp to find the structure that minimizes your tax burden.',\n    ctaLabel: 'Start Comparison',\n    ctaView: 'setup',\n  },\n  revenue: {\n    icon: <TrendingUp size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-emerald), #059669)',\n    title: 'Track your revenue streams',\n    description: 'Add your income sources to see revenue analysis, projections, and diversification recommendations.',\n    ctaLabel: 'Add Income',\n    ctaView: 'setup',\n  },\n  risk: {\n    icon: <Shield size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-amber), #d97706)',\n    title: 'Risk assessment needs data',\n    description: 'Complete your financial profile to receive a comprehensive risk matrix covering tax, entity, compliance, and cash flow risks.',\n    ctaLabel: 'Complete Profile',\n    ctaView: 'setup',\n  },\n  audit: {\n    icon: <ShieldAlert size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-red), #dc2626)',\n    title: 'Audit risk profiler',\n    description: 'Enter your tax data to get an audit risk score, red flag detection, and documentation gap analysis.',\n    ctaLabel: 'Enter Tax Data',\n    ctaView: 'setup',\n  },\n  scenarios: {\n    icon: <BarChart3 size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-purple), #7c3aed)',\n    title: 'Model different scenarios',\n    description: 'Run what-if simulations to see how decisions like selling crypto, changing entity type, or relocating affect your taxes.',\n    ctaLabel: 'Create Scenario',\n    ctaAction: 'create',\n  },\n  cashflow: {\n    icon: <Wallet size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-emerald), #059669)',\n    title: 'Cash flow analysis',\n    description: 'Add your income and expense data to see monthly cash flow trends, projections, and reserve recommendations.',\n    ctaLabel: 'Add Financial Data',\n    ctaView: 'setup',\n  },\n  alerts: {\n    icon: <Bell size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-gold), #b8912e)',\n    title: 'No alerts right now',\n    description: 'When Fortuna detects tax deadlines, savings opportunities, or risk changes, they\\'ll appear here.',\n    ctaLabel: 'View Dashboard',\n    ctaView: 'dashboard',\n  },\n  calendar: {\n    icon: <Calendar size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-blue), #2563eb)',\n    title: 'Tax calendar',\n    description: 'Your personalized tax deadline calendar will populate once you set your filing status and entity type.',\n    ctaLabel: 'Set Up Profile',\n    ctaView: 'setup',\n  },\n  documents: {\n    icon: <FileText size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-purple), #7c3aed)',\n    title: 'Document center',\n    description: 'Upload receipts, tax forms, and business documents. Fortuna will auto-categorize and map them to Schedule C lines.',\n    ctaLabel: 'Upload Document',\n    ctaAction: 'upload',\n  },\n  import: {\n    icon: <Upload size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-blue), #2563eb)',\n    title: 'Import your data',\n    description: 'Import transactions from exchanges, banks, or CSV files. Fortuna supports Coinbase, Binance, Kraken, and 5 more.',\n    ctaLabel: 'Start Import',\n    ctaAction: 'import',\n  },\n  workflows: {\n    icon: <Compass size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-gold), #b8912e)',\n    title: 'Strategic workflows',\n    description: 'Complete your profile to unlock step-by-step workflows for entity formation, retirement optimization, and tax planning.',\n    ctaLabel: 'Complete Profile',\n    ctaView: 'setup',\n  },\n  automations: {\n    icon: <Zap size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-amber), #d97706)',\n    title: 'Automations',\n    description: 'Set up automated alerts for tax deadlines, estimated payment reminders, and strategy triggers.',\n    ctaLabel: 'Create Automation',\n    ctaAction: 'create',\n  },\n  advisor: {\n    icon: <Bot size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-purple), #7c3aed)',\n    title: 'AI Tax Advisor',\n    description: 'Ask any tax question and get personalized guidance based on your financial profile. Try \"How can I reduce my self-employment tax?\"',\n    ctaLabel: 'Ask a Question',\n    ctaAction: 'focus',\n  },\n  health: {\n    icon: <Activity size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-emerald), #059669)',\n    title: 'Financial health score',\n    description: 'Your health score measures tax efficiency, risk exposure, and optimization potential. Add your data to see your score.',\n    ctaLabel: 'Get Started',\n    ctaView: 'setup',\n  },\n  optimizer: {\n    icon: <Scale size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-blue), #2563eb)',\n    title: 'Entity optimizer',\n    description: 'Compare your current entity structure against alternatives with side-by-side tax projections.',\n    ctaLabel: 'Enter Income Data',\n    ctaView: 'setup',\n  },\n  reports: {\n    icon: <FileText size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-gold), #b8912e)',\n    title: 'Reports',\n    description: 'Generate comprehensive tax reports, strategy summaries, and CPA-ready export packages.',\n    ctaLabel: 'Add Data First',\n    ctaView: 'setup',\n  },\n  history: {\n    icon: <History size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-purple), #7c3aed)',\n    title: 'Financial history',\n    description: 'Track how your tax position evolves over time. Your historical snapshots will appear here after your first session.',\n    ctaLabel: 'View Dashboard',\n    ctaView: 'dashboard',\n  },\n  retirement: {\n    icon: <PiggyBank size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-emerald), #059669)',\n    title: 'Retirement optimizer',\n    description: 'Compare Solo 401(k), SEP-IRA, Traditional IRA, Roth, and HSA to maximize tax-deferred savings.',\n    ctaLabel: 'Enter Income',\n    ctaView: 'setup',\n  },\n  arbitrage: {\n    icon: <MapPin size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-blue), #2563eb)',\n    title: 'State tax arbitrage',\n    description: 'Compare your tax burden across all 50 states to find relocation savings opportunities.',\n    ctaLabel: 'Set Current State',\n    ctaView: 'setup',\n  },\n  portfolio: {\n    icon: <Briefcase size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-gold), #b8912e)',\n    title: 'Portfolio intelligence',\n    description: 'Connect your investment accounts to get tax-aware portfolio analysis, cost basis tracking, and harvest opportunities.',\n    ctaLabel: 'Import Portfolio',\n    ctaView: 'import',\n  },\n  multiyear: {\n    icon: <CalendarRange size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-purple), #7c3aed)',\n    title: 'Multi-year projections',\n    description: 'See how your tax position projects across 3-5 years with growth modeling and strategy impact analysis.',\n    ctaLabel: 'Enter Base Year Data',\n    ctaView: 'setup',\n  },\n  depreciation: {\n    icon: <Package size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-amber), #d97706)',\n    title: 'Depreciation tracker',\n    description: 'Track business assets, calculate §179 deductions, bonus depreciation, and MACRS schedules.',\n    ctaLabel: 'Add First Asset',\n    ctaAction: 'create',\n  },\n  credits: {\n    icon: <Award size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-emerald), #059669)',\n    title: 'Tax credit finder',\n    description: 'Discover tax credits you may be eligible for based on your income, family, education, and business activities.',\n    ctaLabel: 'Check Eligibility',\n    ctaView: 'setup',\n  },\n  nexus: {\n    icon: <Brain size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-gold), #b8912e)',\n    title: 'Nexus insights',\n    description: 'AI-powered connections between your financial data points, revealing hidden optimization opportunities.',\n    ctaLabel: 'Add Data',\n    ctaView: 'setup',\n  },\n  paycheck: {\n    icon: <CreditCard size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-blue), #2563eb)',\n    title: 'Paycheck simulator',\n    description: 'See how W-4 changes, retirement contributions, and pre-tax deductions affect your take-home pay.',\n    ctaLabel: 'Enter Salary Info',\n    ctaView: 'setup',\n  },\n  deductions: {\n    icon: <Search size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-emerald), #059669)',\n    title: 'Deduction finder',\n    description: 'Answer a few questions about your work and life to discover deductions you might be missing.',\n    ctaLabel: 'Start Discovery',\n    ctaAction: 'start',\n  },\n  marginal: {\n    icon: <Layers size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-purple), #7c3aed)',\n    title: 'Marginal rate analysis',\n    description: 'See your effective and marginal tax rates across federal, state, and self-employment taxes.',\n    ctaLabel: 'Enter Income',\n    ctaView: 'setup',\n  },\n  goals: {\n    icon: <Target size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-gold), #b8912e)',\n    title: 'Goal planner',\n    description: 'Set financial goals and get a personalized action plan with tax-optimized milestones.',\n    ctaLabel: 'Set First Goal',\n    ctaAction: 'create',\n  },\n  taxprep: {\n    icon: <ClipboardCheck size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-emerald), #059669)',\n    title: 'Tax prep checklist',\n    description: 'A step-by-step checklist to make sure you have everything ready before filing.',\n    ctaLabel: 'Start Checklist',\n    ctaAction: 'start',\n  },\n  taxdocs: {\n    icon: <FileSpreadsheet size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-blue), #2563eb)',\n    title: 'Tax documents',\n    description: 'Generate Schedule C, Form 8949, estimated payment vouchers, and other IRS-ready documents.',\n    ctaLabel: 'Generate Documents',\n    ctaView: 'setup',\n  },\n  cpa: {\n    icon: <Briefcase size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-purple), #7c3aed)',\n    title: 'CPA export',\n    description: 'Package your data into TXF, CSV, and Form 8949 formats ready for your tax professional.',\n    ctaLabel: 'Prepare Export',\n    ctaView: 'setup',\n  },\n  workspace: {\n    icon: <Users size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-purple), #7c3aed)',\n    title: 'Collaboration workspace',\n    description: 'Invite your CPA, bookkeeper, or business partner to collaborate on your tax data securely.',\n    ctaLabel: 'Create Workspace',\n    ctaAction: 'create',\n  },\n  data: {\n    icon: <Database size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-amber), #d97706)',\n    title: 'Data manager',\n    description: 'View, edit, and manage all your stored financial data, backups, and sync settings.',\n    ctaLabel: 'View Dashboard',\n    ctaView: 'dashboard',\n  },\n  pnl: {\n    icon: <BarChart3 size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-emerald), #059669)',\n    title: 'Profit & Loss statement',\n    description: 'Generate a detailed P&L from your income and expense data. Perfect for loan applications and business planning.',\n    ctaLabel: 'Add Revenue Data',\n    ctaView: 'setup',\n  },\n  flow: {\n    icon: <Building2 size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-blue), #2563eb)',\n    title: 'Entity flow designer',\n    description: 'Visualize and design complex multi-entity structures with income flow diagrams.',\n    ctaLabel: 'Create Entity',\n    ctaView: 'entity',\n  },\n  timeline: {\n    icon: <Calendar size={28} />,\n    iconBg: 'linear-gradient(135deg, var(--accent-gold), #b8912e)',\n    title: 'Execution timeline',\n    description: 'See your recommended actions organized on a timeline with deadlines and dependencies.',\n    ctaLabel: 'View Strategies',\n    ctaView: 'tax',\n  },\n}\n\n// ─── Default fallback ───────────────────────────────────────────────\n\nconst DEFAULT_EMPTY: EmptyConfig = {\n  icon: <Sparkles size={28} />,\n  iconBg: 'linear-gradient(135deg, var(--accent-gold), #b8912e)',\n  title: 'Nothing here yet',\n  description: 'Complete your financial profile to unlock this feature.',\n  ctaLabel: 'Get Started',\n  ctaView: 'setup',\n}\n\n// ─── Component ──────────────────────────────────────────────────────\n\ninterface EmptyStateProps {\n  view: ViewKey\n  onNavigate?: (view: ViewKey) => void\n  onAction?: (action: string) => void\n  hasData?: boolean\n  children?: ReactNode\n}\n\nexport function EmptyState({ view, onNavigate, onAction, hasData, children }: EmptyStateProps) {\n  if (hasData) return <>{children}</>\n\n  const config = EMPTY_CONFIGS[view] || DEFAULT_EMPTY\n\n  const handleCTA = () => {\n    if (config.ctaView && onNavigate) {\n      onNavigate(config.ctaView)\n    } else if (config.ctaAction && onAction) {\n      onAction(config.ctaAction)\n    }\n  }\n\n  return (\n    <div className=\"empty-state\" role=\"status\" aria-label={`${config.title}: ${config.description}`}>\n      <div className=\"empty-state-icon\" style={{ background: config.iconBg, color: '#fff' }}>\n        {config.icon}\n      </div>\n      <div className=\"empty-state-title\">{config.title}</div>\n      <div className=\"empty-state-description\">{config.description}</div>\n      <button\n        className=\"empty-state-cta\"\n        onClick={handleCTA}\n        aria-label={config.ctaLabel}\n      >\n        {config.ctaLabel}\n        <ArrowRight size={16} />\n      </button>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ErrorBoundary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\MobileBottomBar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Zap' is defined but never used.","line":11,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":44,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Zap"},"fix":{"range":[395,400],"text":""},"desc":"Remove unused variable \"Zap\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'History' is defined but never used.","line":13,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":29,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"History"},"fix":{"range":[484,493],"text":""},"desc":"Remove unused variable \"History\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Scale' is defined but never used.","line":14,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":27,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Scale"},"fix":{"range":[538,545],"text":""},"desc":"Remove unused variable \"Scale\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ClipboardCheck' is defined but never used.","line":15,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":32,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ClipboardCheck"},"fix":{"range":[586,602],"text":""},"desc":"Remove unused variable \"ClipboardCheck\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Compass' is defined but never used.","line":16,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":10,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Compass"},"fix":{"range":[629,640],"text":""},"desc":"Remove unused variable \"Compass\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TrendingUp' is defined but never used.","line":16,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":22,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TrendingUp"},"fix":{"range":[640,652],"text":""},"desc":"Remove unused variable \"TrendingUp\"."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE — Mobile Bottom Bar + More Sheet\n * Bottom tab navigation for mobile (<768px) with progressive disclosure.\n * Shows 5 core tabs + \"More\" sheet for all other features.\n */\n\nimport { useState, useCallback, useEffect } from 'react'\nimport type { ViewKey } from '../App'\nimport {\n  LayoutDashboard, Receipt, Bot, FileText, MoreHorizontal,\n  Building2, BarChart3, Shield, Wallet, Zap, Calendar,\n  Bell, Upload, PiggyBank, MapPin, Activity, Target,\n  Search, Briefcase, History, Users, X, ChevronRight,\n  Brain, CreditCard, Scale, Package, Award, Layers,\n  CalendarRange, ClipboardCheck, FileSpreadsheet, Database,\n  Compass, TrendingUp,\n} from 'lucide-react'\n\ninterface MobileBottomBarProps {\n  activeView: ViewKey\n  onNavigate: (view: ViewKey) => void\n}\n\ninterface MoreItem {\n  key: ViewKey\n  label: string\n  icon: React.ReactNode\n  section: string\n  description: string\n}\n\nconst MORE_ITEMS: MoreItem[] = [\n  // Strategy\n  { key: 'tax', label: 'Tax Strategy', icon: <Receipt size={20} />, section: 'Strategy', description: 'View strategies & savings' },\n  { key: 'paycheck', label: 'Paycheck Simulator', icon: <CreditCard size={20} />, section: 'Strategy', description: 'W-4 & take-home pay' },\n  { key: 'deductions', label: 'Deduction Finder', icon: <Search size={20} />, section: 'Strategy', description: 'Discover missed deductions' },\n  { key: 'scenarios', label: 'What-If Scenarios', icon: <BarChart3 size={20} />, section: 'Strategy', description: 'Model financial decisions' },\n  { key: 'entity', label: 'Entity Comparison', icon: <Building2 size={20} />, section: 'Strategy', description: 'LLC vs S-Corp vs C-Corp' },\n  { key: 'retirement', label: 'Retirement Optimizer', icon: <PiggyBank size={20} />, section: 'Strategy', description: '401k, IRA, HSA planning' },\n  { key: 'arbitrage', label: 'State Tax Compare', icon: <MapPin size={20} />, section: 'Strategy', description: '50-state tax comparison' },\n  // Analysis\n  { key: 'health', label: 'Health Score', icon: <Activity size={20} />, section: 'Analysis', description: 'Financial health rating' },\n  { key: 'nexus', label: 'Nexus Insights', icon: <Brain size={20} />, section: 'Analysis', description: 'AI-powered connections' },\n  { key: 'portfolio', label: 'Portfolio Intel', icon: <Briefcase size={20} />, section: 'Analysis', description: 'Investment tax analysis' },\n  { key: 'cashflow', label: 'Cash Flow', icon: <Wallet size={20} />, section: 'Analysis', description: 'Income & expense tracking' },\n  { key: 'audit', label: 'Audit Risk', icon: <Shield size={20} />, section: 'Analysis', description: 'Red flags & readiness' },\n  { key: 'marginal', label: 'Tax Rates', icon: <Layers size={20} />, section: 'Analysis', description: 'Marginal & effective rates' },\n  { key: 'multiyear', label: 'Multi-Year View', icon: <CalendarRange size={20} />, section: 'Analysis', description: '3-5 year projections' },\n  // Tools\n  { key: 'goals', label: 'Goal Planner', icon: <Target size={20} />, section: 'Tools', description: 'Financial milestones' },\n  { key: 'calendar', label: 'Tax Calendar', icon: <Calendar size={20} />, section: 'Tools', description: 'Deadlines & reminders' },\n  { key: 'alerts', label: 'Intelligence', icon: <Bell size={20} />, section: 'Tools', description: 'Proactive alerts' },\n  { key: 'depreciation', label: 'Depreciation', icon: <Package size={20} />, section: 'Tools', description: '§179 & MACRS tracking' },\n  { key: 'credits', label: 'Tax Credits', icon: <Award size={20} />, section: 'Tools', description: 'Credit eligibility' },\n  { key: 'import', label: 'Data Import', icon: <Upload size={20} />, section: 'Tools', description: 'CSV & exchange sync' },\n  // Output\n  { key: 'reports', label: 'Reports', icon: <FileText size={20} />, section: 'Output', description: 'Generate tax reports' },\n  { key: 'pnl', label: 'P&L Statement', icon: <BarChart3 size={20} />, section: 'Output', description: 'Profit & loss report' },\n  { key: 'taxdocs', label: 'Tax Documents', icon: <FileSpreadsheet size={20} />, section: 'Output', description: 'IRS-ready forms' },\n  { key: 'cpa', label: 'CPA Export', icon: <Briefcase size={20} />, section: 'Output', description: 'Package for accountant' },\n  // Settings\n  { key: 'workspace', label: 'Collaboration', icon: <Users size={20} />, section: 'Settings', description: 'Team & CPA access' },\n  { key: 'setup', label: 'Edit Profile', icon: <Database size={20} />, section: 'Settings', description: 'Your financial data' },\n  { key: 'data', label: 'Data Manager', icon: <Database size={20} />, section: 'Settings', description: 'Backup & sync' },\n]\n\nexport function MobileBottomBar({ activeView, onNavigate }: MobileBottomBarProps) {\n  const [moreOpen, setMoreOpen] = useState(false)\n\n  // Close sheet when navigating\n  const handleNav = useCallback((view: ViewKey) => {\n    setMoreOpen(false)\n    onNavigate(view)\n  }, [onNavigate])\n\n  // Close on escape\n  useEffect(() => {\n    if (!moreOpen) return\n    const handler = (e: KeyboardEvent) => { if (e.key === 'Escape') setMoreOpen(false) }\n    window.addEventListener('keydown', handler)\n    return () => window.removeEventListener('keydown', handler)\n  }, [moreOpen])\n\n  // Prevent body scroll when sheet open\n  useEffect(() => {\n    document.body.style.overflow = moreOpen ? 'hidden' : ''\n    return () => { document.body.style.overflow = '' }\n  }, [moreOpen])\n\n  const coreTabActive = (keys: ViewKey[]) => keys.includes(activeView)\n  const isMoreActive = !coreTabActive(['dashboard', 'tax', 'advisor', 'reports']) && activeView !== 'dashboard'\n\n  return (\n    <>\n      {/* Bottom Tab Bar */}\n      <div className=\"mobile-bottom-bar\" role=\"navigation\" aria-label=\"Main navigation\">\n        <nav>\n          <button\n            className={`mobile-tab ${activeView === 'dashboard' ? 'active' : ''}`}\n            onClick={() => handleNav('dashboard')}\n            aria-label=\"Dashboard\"\n            aria-current={activeView === 'dashboard' ? 'page' : undefined}\n          >\n            <LayoutDashboard size={22} />\n            <span>Home</span>\n          </button>\n\n          <button\n            className={`mobile-tab ${coreTabActive(['tax', 'scenarios', 'entity', 'retirement', 'arbitrage', 'deductions', 'paycheck', 'marginal']) ? 'active' : ''}`}\n            onClick={() => handleNav('tax')}\n            aria-label=\"Tax Strategy\"\n            aria-current={activeView === 'tax' ? 'page' : undefined}\n          >\n            <Receipt size={22} />\n            <span>Strategy</span>\n          </button>\n\n          <button\n            className={`mobile-tab ${activeView === 'advisor' ? 'active' : ''}`}\n            onClick={() => handleNav('advisor')}\n            aria-label=\"AI Advisor\"\n            aria-current={activeView === 'advisor' ? 'page' : undefined}\n          >\n            <Bot size={22} />\n            <span>Advisor</span>\n          </button>\n\n          <button\n            className={`mobile-tab ${coreTabActive(['reports', 'taxdocs', 'cpa', 'pnl', 'documents']) ? 'active' : ''}`}\n            onClick={() => handleNav('reports')}\n            aria-label=\"Reports\"\n            aria-current={activeView === 'reports' ? 'page' : undefined}\n          >\n            <FileText size={22} />\n            <span>Reports</span>\n          </button>\n\n          <button\n            className={`mobile-tab ${moreOpen || isMoreActive ? 'active' : ''}`}\n            onClick={() => setMoreOpen(!moreOpen)}\n            aria-label=\"More options\"\n            aria-expanded={moreOpen}\n          >\n            <MoreHorizontal size={22} />\n            <span>More</span>\n          </button>\n        </nav>\n      </div>\n\n      {/* More Sheet Overlay */}\n      <div\n        className={`mobile-sheet-overlay ${moreOpen ? 'open' : ''}`}\n        onClick={() => setMoreOpen(false)}\n        aria-hidden={!moreOpen}\n      />\n\n      {/* More Sheet */}\n      <div\n        className={`mobile-sheet ${moreOpen ? 'open' : ''}`}\n        role=\"dialog\"\n        aria-modal=\"true\"\n        aria-label=\"All features\"\n      >\n        <div className=\"mobile-sheet-handle\" />\n\n        {/* Header */}\n        <div style={{\n          display: 'flex', justifyContent: 'space-between', alignItems: 'center',\n          padding: '0 20px 16px',\n          borderBottom: '1px solid var(--border-subtle)',\n        }}>\n          <span style={{ fontFamily: 'var(--font-display)', fontSize: 20, color: 'var(--text-primary)' }}>\n            All Features\n          </span>\n          <button\n            onClick={() => setMoreOpen(false)}\n            style={{\n              background: 'var(--bg-surface)', border: 'none', borderRadius: 8,\n              width: 36, height: 36, display: 'flex', alignItems: 'center', justifyContent: 'center',\n              cursor: 'pointer', color: 'var(--text-secondary)',\n            }}\n            aria-label=\"Close menu\"\n          >\n            <X size={18} />\n          </button>\n        </div>\n\n        {/* Grouped items */}\n        <div style={{ padding: '8px 12px 32px', overflowY: 'auto' }}>\n          {['Strategy', 'Analysis', 'Tools', 'Output', 'Settings'].map(section => {\n            const items = MORE_ITEMS.filter(i => i.section === section)\n            return (\n              <div key={section} style={{ marginBottom: 8 }}>\n                <div style={{\n                  padding: '12px 8px 6px',\n                  fontSize: 11,\n                  fontFamily: 'var(--font-mono)',\n                  textTransform: 'uppercase',\n                  letterSpacing: '0.1em',\n                  color: 'var(--text-muted)',\n                  fontWeight: 500,\n                }}>\n                  {section}\n                </div>\n                {items.map(item => (\n                  <button\n                    key={item.key}\n                    onClick={() => handleNav(item.key)}\n                    style={{\n                      display: 'flex',\n                      alignItems: 'center',\n                      gap: 14,\n                      width: '100%',\n                      padding: '12px 10px',\n                      borderRadius: 12,\n                      border: 'none',\n                      background: activeView === item.key ? 'var(--accent-gold-dim)' : 'transparent',\n                      cursor: 'pointer',\n                      textAlign: 'left',\n                      transition: 'background 0.15s',\n                      minHeight: 48,\n                    }}\n                    aria-current={activeView === item.key ? 'page' : undefined}\n                  >\n                    <div style={{\n                      width: 40, height: 40, borderRadius: 10,\n                      background: activeView === item.key ? 'var(--accent-gold-dim)' : 'var(--bg-surface)',\n                      display: 'flex', alignItems: 'center', justifyContent: 'center',\n                      color: activeView === item.key ? 'var(--accent-gold)' : 'var(--text-secondary)',\n                      flexShrink: 0,\n                    }}>\n                      {item.icon}\n                    </div>\n                    <div style={{ flex: 1, minWidth: 0 }}>\n                      <div style={{\n                        fontSize: 14,\n                        fontWeight: activeView === item.key ? 600 : 400,\n                        color: activeView === item.key ? 'var(--accent-gold)' : 'var(--text-primary)',\n                      }}>\n                        {item.label}\n                      </div>\n                      <div style={{ fontSize: 12, color: 'var(--text-muted)', marginTop: 1 }}>\n                        {item.description}\n                      </div>\n                    </div>\n                    <ChevronRight size={16} color=\"var(--text-muted)\" />\n                  </button>\n                ))}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    </>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\MobileDocumentScanner.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Loader2' is defined but never used.","line":2,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":35,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Loader2"},"fix":{"range":[98,107],"text":""},"desc":"Remove unused variable \"Loader2\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useFortuna' is defined but never used.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":20,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"useFortuna"},"fix":{"range":[131,181],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":48,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":48,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1967,1970],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1967,1970],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot access variable before it is declared\n\n`handleManualCapture` is accessed before it is declared, which prevents the earlier access from updating when this value changes over time.\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\MobileDocumentScanner.tsx:137:25\n  135 |                             if ('vibrate' in navigator) navigator.vibrate(30);\n  136 |                         }\n> 137 |                         handleManualCapture() // Auto trigger\n      |                         ^^^^^^^^^^^^^^^^^^^ `handleManualCapture` accessed before it is declared\n  138 |                     }\n  139 |                 } else {\n  140 |                     steadyFrames.current = 0\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\MobileDocumentScanner.tsx:206:5\n  204 |     }, [hasPermission, isCapturing]) // removed capturedImage dependency for turbo scanning\n  205 |\n> 206 |     const handleManualCapture = useCallback(() => {\n      |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 207 |         if (!videoRef.current || !canvasRef.current || isCapturing) return\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 208 |         \n      …\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 238 |         setTimeout(() => setIsCapturing(false), 600)\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 239 |     }, [isCapturing, onCapture])\n      | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ `handleManualCapture` is declared here\n  240 |\n  241 |     const handleConfirmBatch = () => {\n  242 |         onClose()","line":137,"column":25,"nodeType":null,"endLine":137,"endColumn":44},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'capturedImages.length' and 'handleManualCapture'. Either include them or remove the dependency array.","line":204,"column":8,"nodeType":"ArrayExpression","endLine":204,"endColumn":36,"suggestions":[{"desc":"Update the dependencies array to be: [capturedImages.length, handleManualCapture, hasPermission, isCapturing]","fix":{"range":[8620,8648],"text":"[capturedImages.length, handleManualCapture, hasPermission, isCapturing]"}}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef, useCallback } from 'react'\r\nimport { Camera, X, Check, Loader2 } from 'lucide-react'\r\nimport { useFortuna } from '../hooks/useFortuna'\r\n\r\ninterface MobileDocumentScannerProps {\r\n    onCapture: (imageData: string) => void\r\n    onClose: () => void\r\n}\r\n\r\nexport function MobileDocumentScanner({ onCapture, onClose }: MobileDocumentScannerProps) {\r\n    const videoRef = useRef<HTMLVideoElement>(null)\r\n    const canvasRef = useRef<HTMLCanvasElement>(null)\r\n    const overlayCanvasRef = useRef<HTMLCanvasElement>(null)\r\n    \r\n    const [hasPermission, setHasPermission] = useState<boolean | null>(null)\r\n    const [error, setError] = useState<string | null>(null)\r\n    const [isCapturing, setIsCapturing] = useState(false)\r\n    const [capturedImages, setCapturedImages] = useState<string[]>([])\r\n    const [showFlash, setShowFlash] = useState(false)\r\n\r\n    // Motion detection state\r\n    const lastImageData = useRef<ImageData | null>(null)\r\n    const steadyFrames = useRef(0)\r\n    const frameInterval = useRef<number | null>(null)\r\n\r\n    const STEADY_THRESHOLD = 5 // Number of consecutive steady frames required\r\n    const DIFFERENCE_THRESHOLD = 2000000 // Pixel difference score to consider \"motion\"\r\n\r\n    // Initialize Camera\r\n    useEffect(() => {\r\n        let stream: MediaStream | null = null\r\n\r\n        const startCamera = async () => {\r\n            try {\r\n                stream = await navigator.mediaDevices.getUserMedia({\r\n                    video: {\r\n                        facingMode: 'environment', // Prefer back camera\r\n                        width: { ideal: 1920 },\r\n                        height: { ideal: 1080 }\r\n                    }\r\n                })\r\n                \r\n                if (videoRef.current) {\r\n                    videoRef.current.srcObject = stream\r\n                    videoRef.current.play()\r\n                }\r\n                setHasPermission(true)\r\n            } catch (err: any) {\r\n                console.error(\"Camera access error:\", err)\r\n                setHasPermission(false)\r\n                setError(err.message || \"Failed to access camera. Please check permissions.\")\r\n            }\r\n        }\r\n\r\n        startCamera()\r\n\r\n        return () => {\r\n            if (stream) {\r\n                stream.getTracks().forEach(track => track.stop())\r\n            }\r\n            if (frameInterval.current) {\r\n                window.clearInterval(frameInterval.current)\r\n            }\r\n        }\r\n    }, [])\r\n\r\n    // Auto-Capture logic (Motion detection)\r\n    useEffect(() => {\r\n        if (!hasPermission || capturedImages.length > 0 || isCapturing) {\r\n            if (frameInterval.current) window.clearInterval(frameInterval.current)\r\n            return\r\n        }\r\n\r\n        const checkFrame = () => {\r\n            if (!videoRef.current || !canvasRef.current) return\r\n            const video = videoRef.current\r\n            const canvas = canvasRef.current\r\n            const overlay = overlayCanvasRef.current\r\n            const ctx = canvas.getContext('2d', { willReadFrequently: true })\r\n            const overlayCtx = overlay?.getContext('2d')\r\n            if (!ctx || !overlayCtx || video.videoWidth === 0) return\r\n\r\n            // Match canvas size to video frame\r\n            if (canvas.width !== video.videoWidth) {\r\n                canvas.width = video.videoWidth\r\n                canvas.height = video.videoHeight\r\n            }\r\n            if (overlay && overlay.width !== video.getBoundingClientRect().width) {\r\n                overlay.width = video.getBoundingClientRect().width\r\n                overlay.height = video.getBoundingClientRect().height\r\n            }\r\n\r\n            // Draw current frame to hidden canvas\r\n            ctx.drawImage(video, 0, 0, canvas.width, canvas.height)\r\n            \r\n            // Get a smaller sample area for faster calculation (center of screen)\r\n            const sampleWidth = 200\r\n            const sampleHeight = 200\r\n            const startX = (canvas.width - sampleWidth) / 2\r\n            const startY = (canvas.height - sampleHeight) / 2\r\n            \r\n            const currentData = ctx.getImageData(startX, startY, sampleWidth, sampleHeight)\r\n            \r\n            if (lastImageData.current) {\r\n                // Calculate difference\r\n                let diff = 0\r\n                const curPixels = currentData.data\r\n                const lastPixels = lastImageData.current.data\r\n                \r\n                for (let i = 0; i < curPixels.length; i += 4) {\r\n                    // Simple RGB difference\r\n                    diff += Math.abs(curPixels[i] - lastPixels[i]) +\r\n                            Math.abs(curPixels[i+1] - lastPixels[i+1]) +\r\n                            Math.abs(curPixels[i+2] - lastPixels[i+2])\r\n                }\r\n\r\n                // --- AR Edge Detection Overlay ---\r\n                // We're doing a highly-simplified placeholder heuristic here: \r\n                // In production, we'd use a Canny edge detector or contour finding algo.\r\n                // For now, if it's steady, we tighten a green border to pretend we found the document.\r\n\r\n                overlayCtx.clearRect(0, 0, overlay!.width, overlay!.height)\r\n\r\n                let boxScale = 0.9\r\n                let strokeColor = 'rgba(255, 255, 255, 0.5)'\r\n\r\n                if (diff < DIFFERENCE_THRESHOLD) {\r\n                    steadyFrames.current++\r\n                    // Animate the box zooming in to lock onto the document\r\n                    boxScale = Math.max(0.65, 0.9 - (steadyFrames.current * 0.06))\r\n\r\n                    if (steadyFrames.current >= STEADY_THRESHOLD) {\r\n                        strokeColor = 'var(--accent-emerald, #10b981)' // Turn green when locked\r\n                        if (steadyFrames.current === STEADY_THRESHOLD) {\r\n                            if ('vibrate' in navigator) navigator.vibrate(30);\r\n                        }\r\n                        handleManualCapture() // Auto trigger\r\n                    }\r\n                } else {\r\n                    steadyFrames.current = 0\r\n                }\r\n\r\n                // Draw the magnetic corner brackets\r\n                const ow = overlay!.width\r\n                const oh = overlay!.height\r\n                const bw = ow * boxScale\r\n                const bh = oh * boxScale\r\n                const bx = (ow - bw) / 2\r\n                const by = (oh - bh) / 2\r\n\r\n                const cornerSize = 40\r\n                overlayCtx.strokeStyle = strokeColor\r\n                overlayCtx.lineWidth = 4\r\n                overlayCtx.lineCap = 'round'\r\n                overlayCtx.setLineDash([])\r\n\r\n                // Top Left\r\n                overlayCtx.beginPath()\r\n                overlayCtx.moveTo(bx + cornerSize, by)\r\n                overlayCtx.lineTo(bx, by)\r\n                overlayCtx.lineTo(bx, by + cornerSize)\r\n                overlayCtx.stroke()\r\n\r\n                // Top Right\r\n                overlayCtx.beginPath()\r\n                overlayCtx.moveTo(bx + bw - cornerSize, by)\r\n                overlayCtx.lineTo(bx + bw, by)\r\n                overlayCtx.lineTo(bx + bw, by + cornerSize)\r\n                overlayCtx.stroke()\r\n\r\n                // Bottom Left\r\n                overlayCtx.beginPath()\r\n                overlayCtx.moveTo(bx, by + bh - cornerSize)\r\n                overlayCtx.lineTo(bx, by + bh)\r\n                overlayCtx.lineTo(bx + cornerSize, by + bh)\r\n                overlayCtx.stroke()\r\n\r\n                // Bottom Right\r\n                overlayCtx.beginPath()\r\n                overlayCtx.moveTo(bx + bw - cornerSize, by + bh)\r\n                overlayCtx.lineTo(bx + bw, by + bh)\r\n                overlayCtx.lineTo(bx + bw, by + bh - cornerSize)\r\n                overlayCtx.stroke()\r\n\r\n                // If steadying, show progress bar\r\n                if (steadyFrames.current > 0 && steadyFrames.current < STEADY_THRESHOLD) {\r\n                    const progress = steadyFrames.current / STEADY_THRESHOLD\r\n                    overlayCtx.fillStyle = 'rgba(255,255,255,0.2)'\r\n                    overlayCtx.fillRect(bx, by + bh + 10, bw, 4)\r\n                    overlayCtx.fillStyle = 'var(--accent-emerald, #10b981)'\r\n                    overlayCtx.fillRect(bx, by + bh + 10, bw * progress, 4)\r\n                }\r\n                // --- End AR Edge Detection ---\r\n            }\r\n\r\n            lastImageData.current = currentData\r\n        }\r\n\r\n        frameInterval.current = window.setInterval(checkFrame, 200)\r\n\r\n        return () => {\r\n            if (frameInterval.current) window.clearInterval(frameInterval.current)\r\n        }\r\n    }, [hasPermission, isCapturing]) // removed capturedImage dependency for turbo scanning\r\n\r\n    const handleManualCapture = useCallback(() => {\r\n        if (!videoRef.current || !canvasRef.current || isCapturing) return\r\n        \r\n        setIsCapturing(true)\r\n        setShowFlash(true) // trigger flash feedback\r\n\r\n        // Don't clear interval, let it keep scanning\r\n        // if (frameInterval.current) window.clearInterval(frameInterval.current)\r\n\r\n        const video = videoRef.current\r\n        const canvas = canvasRef.current\r\n        const ctx = canvas.getContext('2d')\r\n\r\n        if (ctx) {\r\n            canvas.width = video.videoWidth\r\n            canvas.height = video.videoHeight\r\n            ctx.drawImage(video, 0, 0, canvas.width, canvas.height)\r\n            \r\n            // Compress JPEG\r\n            const base64Image = canvas.toDataURL('image/jpeg', 0.8)\r\n            setCapturedImages(prev => [...prev, base64Image])\r\n\r\n            // Instantly send to parent for concurrent background processing\r\n            onCapture(base64Image)\r\n\r\n            // Reset steady state so it doesn't repeatedly fire identical frames\r\n            steadyFrames.current = -5 // Requires 10 frames to re-trigger auto-capture a 2nd time\r\n        }\r\n\r\n        setTimeout(() => setShowFlash(false), 300)\r\n\r\n        // Very short cooldown for turbo mode\r\n        setTimeout(() => setIsCapturing(false), 600)\r\n    }, [isCapturing, onCapture])\r\n\r\n    const handleConfirmBatch = () => {\r\n        onClose()\r\n    }\r\n\r\n    if (hasPermission === false) {\r\n        return (\r\n            <div style={styles.overlay}>\r\n                <div style={styles.errorContainer}>\r\n                    <div style={styles.errorIcon}><Camera size={32} /></div>\r\n                    <h3 style={styles.errorTitle}>Camera Access Denied</h3>\r\n                    <p style={styles.errorText}>{error}</p>\r\n                    <button onClick={onClose} style={styles.secondaryButton}>Close</button>\r\n                </div>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    return (\r\n        <div style={styles.overlay}>\r\n            {/* Header controls */}\r\n            <div style={styles.header}>\r\n                <button onClick={onClose} style={styles.iconButton}>\r\n                    <X size={24} color=\"#fff\" />\r\n                </button>\r\n            </div>\r\n\r\n            <div style={styles.cameraContainer}>\r\n                {showFlash && <div style={styles.flashOverlay}></div>}\r\n\r\n                <video\r\n                    ref={videoRef}\r\n                    autoPlay\r\n                    playsInline\r\n                    muted\r\n                    style={styles.videoElement}\r\n                />\r\n\r\n                {/* Secondary transparent canvas for drawing AR green boxes over the video */}\r\n                <canvas\r\n                    ref={overlayCanvasRef}\r\n                    style={styles.arOverlay}\r\n                />\r\n\r\n                {/* Shaded boundaries to guide user - now simplified as the AR canvas handles the dynamic green boxes */}\r\n                <div style={styles.scannerGuide}>\r\n                    <div style={styles.guideText}>\r\n                        {isCapturing \r\n                            ? \"Captured!\"\r\n                            : steadyFrames.current > 2\r\n                                ? \"Hold steady...\"\r\n                                : \"Align document within frame\"}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Hidden canvas for processing */}\r\n            <canvas ref={canvasRef} style={{ display: 'none' }} />\r\n\r\n            {/* Bottom Controls */}\r\n            <div style={styles.footer}>\r\n                <div style={styles.captureContainer}>\r\n                    {/* Badge showing # of scans */}\r\n                    <div style={{ position: 'absolute', left: 24, bottom: 24 }}>\r\n                        {capturedImages.length > 0 && (\r\n                            <div style={styles.batchBadge}>\r\n                                <div style={styles.batchThumbnail}>\r\n                                    <span style={{ fontSize: 18, fontWeight: 700 }}>{capturedImages.length}</span>\r\n                                </div>\r\n                                <div style={{ fontSize: 12, fontWeight: 600, color: 'var(--accent-emerald)' }}>Processing...</div>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    <button\r\n                        onClick={handleManualCapture}\r\n                        disabled={isCapturing}\r\n                        style={styles.captureButton}\r\n                        aria-label=\"Capture photo\"\r\n                    >\r\n                        <div style={{ ...styles.captureButtonInner, ...(isCapturing ? { opacity: 0.5 } : {}) }}></div>\r\n                    </button>\r\n\r\n                    {/* Done button */}\r\n                    <div style={{ position: 'absolute', right: 24, bottom: 30 }}>\r\n                        {capturedImages.length > 0 && (\r\n                            <button onClick={handleConfirmBatch} style={styles.doneButton}>\r\n                                Done <Check size={16} />\r\n                            </button>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n\r\nconst styles: Record<string, React.CSSProperties> = {\r\n    overlay: {\r\n        position: 'fixed',\r\n        top: 0, left: 0, right: 0, bottom: 0,\r\n        backgroundColor: '#000',\r\n        zIndex: 9999, // Ensure it's on top of everything\r\n        display: 'flex',\r\n        flexDirection: 'column',\r\n    },\r\n    header: {\r\n        position: 'absolute',\r\n        top: 0, left: 0, right: 0,\r\n        padding: '24px 16px',\r\n        display: 'flex',\r\n        justifyContent: 'flex-start',\r\n        zIndex: 10,\r\n        background: 'linear-gradient(to bottom, rgba(0,0,0,0.7), transparent)',\r\n    },\r\n    iconButton: {\r\n        background: 'rgba(255,255,255,0.2)',\r\n        border: 'none',\r\n        borderRadius: '50%',\r\n        width: 40, height: 40,\r\n        display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n        cursor: 'pointer',\r\n        backdropFilter: 'blur(4px)',\r\n    },\r\n    cameraContainer: {\r\n        flex: 1,\r\n        position: 'relative',\r\n        display: 'flex',\r\n        alignItems: 'center',\r\n        justifyContent: 'center',\r\n        overflow: 'hidden',\r\n    },\r\n    videoElement: {\r\n        width: '100%',\r\n        height: '100%',\r\n        objectFit: 'cover',\r\n    },\r\n    scannerGuide: {\r\n        position: 'absolute',\r\n        top: '10%', bottom: '15%', left: '8%', right: '8%',\r\n        border: '2px solid rgba(255,255,255,0.3)',\r\n        boxShadow: '0 0 0 4000px rgba(0,0,0,0.5)', // Dims everything outside the box\r\n        display: 'flex',\r\n        alignItems: 'center',\r\n        justifyContent: 'center',\r\n        pointerEvents: 'none',\r\n    },\r\n    corner: {\r\n        position: 'absolute',\r\n        width: 30, height: 30,\r\n        borderColor: 'var(--accent-gold, #facc15)',\r\n        borderStyle: 'solid',\r\n    },\r\n    guideText: {\r\n        color: '#fff',\r\n        backgroundColor: 'rgba(0,0,0,0.6)',\r\n        padding: '8px 16px',\r\n        borderRadius: 20,\r\n        fontSize: 14,\r\n        fontWeight: 500,\r\n        backdropFilter: 'blur(4px)',\r\n    },\r\n    footer: {\r\n        position: 'absolute',\r\n        bottom: 0, left: 0, right: 0,\r\n        padding: '32px 24px',\r\n        background: 'linear-gradient(to top, rgba(0,0,0,0.9), transparent)',\r\n        display: 'flex',\r\n        justifyContent: 'center',\r\n        alignItems: 'center',\r\n        zIndex: 10,\r\n    },\r\n    captureContainer: {\r\n        display: 'flex',\r\n        justifyContent: 'center',\r\n        width: '100%',\r\n    },\r\n    captureButton: {\r\n        width: 72, height: 72,\r\n        borderRadius: '50%',\r\n        backgroundColor: 'rgba(255,255,255,0.3)',\r\n        border: '4px solid #fff',\r\n        display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n        cursor: 'pointer',\r\n        padding: 0,\r\n    },\r\n    captureButtonInner: {\r\n        width: 54, height: 54,\r\n        borderRadius: '50%',\r\n        backgroundColor: '#fff',\r\n    },\r\n    actionRow: {\r\n        display: 'flex',\r\n        gap: 16,\r\n        width: '100%',\r\n        maxWidth: 400,\r\n    },\r\n    primaryButton: {\r\n        flex: 1,\r\n        backgroundColor: 'var(--accent-gold, #facc15)',\r\n        color: '#000',\r\n        border: 'none',\r\n        borderRadius: 12,\r\n        padding: '16px',\r\n        fontSize: 16,\r\n        fontWeight: 600,\r\n        display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8,\r\n        cursor: 'pointer',\r\n    },\r\n    secondaryButton: {\r\n        flex: 1,\r\n        backgroundColor: 'rgba(255,255,255,0.2)',\r\n        color: '#fff',\r\n        border: 'none',\r\n        borderRadius: 12,\r\n        padding: '16px',\r\n        fontSize: 16,\r\n        fontWeight: 500,\r\n        display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8,\r\n        cursor: 'pointer',\r\n        backdropFilter: 'blur(10px)',\r\n    },\r\n    errorContainer: {\r\n        backgroundColor: '#1a1f2e',\r\n        padding: 32,\r\n        borderRadius: 16,\r\n        margin: 'auto',\r\n        maxWidth: 320,\r\n        textAlign: 'center',\r\n        border: '1px solid rgba(255,255,255,0.1)',\r\n    },\r\n    errorIcon: {\r\n        color: '#ef4444',\r\n        marginBottom: 16,\r\n    },\r\n    errorTitle: {\r\n        color: '#fff',\r\n        margin: '0 0 8px 0',\r\n        fontSize: 18,\r\n    },\r\n    errorText: {\r\n        color: '#9ca3af',\r\n        margin: '0 0 24px 0',\r\n        fontSize: 14,\r\n        lineHeight: 1.5,\r\n    },\r\n    arOverlay: {\r\n        position: 'absolute',\r\n        top: 0, left: 0, right: 0, bottom: 0,\r\n        width: '100%', height: '100%',\r\n        pointerEvents: 'none', // pass clicks through to the buttons\r\n        zIndex: 2,\r\n    },\r\n    flashOverlay: {\r\n        position: 'absolute',\r\n        top: 0, left: 0, right: 0, bottom: 0,\r\n        backgroundColor: 'rgba(255,255,255,0.8)',\r\n        zIndex: 3,\r\n        pointerEvents: 'none',\r\n        animation: 'fadeOut 0.3s forwards',\r\n    },\r\n    batchBadge: {\r\n        display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 4,\r\n    },\r\n    batchThumbnail: {\r\n        width: 48, height: 60,\r\n        backgroundColor: 'var(--bg-elevated)',\r\n        border: '2px solid var(--accent-gold)',\r\n        borderRadius: 6,\r\n        display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n        padding: 4, color: '#fff',\r\n        boxShadow: '2px 2px 0 0 rgba(255,255,255,0.2), 4px 4px 0 0 rgba(255,255,255,0.1)',\r\n    },\r\n    doneButton: {\r\n        backgroundColor: 'var(--accent-gold)',\r\n        color: '#000',\r\n        padding: '12px 24px',\r\n        borderRadius: 24,\r\n        border: 'none',\r\n        fontWeight: 700, fontSize: 16,\r\n        display: 'flex', alignItems: 'center', gap: 6,\r\n        cursor: 'pointer',\r\n    }\r\n}\r\n\r\n// Add the flash animation globally\r\nif (typeof document !== 'undefined') {\r\n    const style = document.createElement('style');\r\n    style.innerHTML = `\r\n        @keyframes fadeOut {\r\n            from { opacity: 0.8; }\r\n            to { opacity: 0; }\r\n        }\r\n    `;\r\n    document.head.appendChild(style);\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\OnboardingTour.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'getFinancialPulse' is defined but never used.","line":14,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":27,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"getFinancialPulse"},"fix":{"range":[498,567],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Sparkles' is defined but never used.","line":18,"column":32,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":40,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Sparkles"},"fix":{"range":[700,710],"text":""},"desc":"Remove unused variable \"Sparkles\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Shield' is defined but never used.","line":19,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":37,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Shield"},"fix":{"range":[754,762],"text":""},"desc":"Remove unused variable \"Shield\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TrendingUp' is defined but never used.","line":19,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":55,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TrendingUp"},"fix":{"range":[768,780],"text":""},"desc":"Remove unused variable \"TrendingUp\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Briefcase' is defined but never used.","line":20,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":12,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Briefcase"},"fix":{"range":[780,793],"text":""},"desc":"Remove unused variable \"Briefcase\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Calculator' is defined but never used.","line":20,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":35,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Calculator"},"fix":{"range":[804,816],"text":""},"desc":"Remove unused variable \"Calculator\"."}]},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":28,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":28,"endColumn":33},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":2,"message":"Expected an assignment or function call and instead saw an expression.","line":476,"column":78,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":476,"endColumn":132}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — Onboarding Tour\n *\n * Guided walkthrough of core features shown once after initial profile setup.\n * Each step highlights a key capability with visual preview, description,\n * and a \"Try it\" action that navigates directly to that feature.\n *\n * Stored in localStorage so it only appears once per user.\n */\n\nimport { useState, useCallback, useEffect } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { generateTaxReport } from '../engine/tax-calculator'\nimport { getFinancialPulse } from '../engine/proactive-intelligence'\nimport type { ViewKey } from '../App'\nimport {\n  LayoutDashboard, DollarSign, Bot, FileText, GitBranch,\n  Building2, PiggyBank, Users, Sparkles, ChevronRight,\n  ChevronLeft, X, ArrowRight, Shield, Bell, TrendingUp,\n  Briefcase, BarChart3, Calculator, Target, Zap,\n  CheckCircle2, Rocket,\n} from 'lucide-react'\n\n// ─── Storage ──────────────────────────────────────────────────────────\n\nconst TOUR_KEY = 'fortuna:onboarding-complete'\n\nexport function hasCompletedTour(): boolean {\n  return localStorage.getItem(TOUR_KEY) === 'true'\n}\n\nfunction completeTour(): void {\n  localStorage.setItem(TOUR_KEY, 'true')\n}\n\n// ─── Tour Step Config ─────────────────────────────────────────────────\n\ninterface TourStep {\n  id: string\n  title: string\n  subtitle: string\n  description: string\n  features: string[]\n  icon: JSX.Element\n  color: string\n  gradient: string\n  action?: { label: string; view: ViewKey }\n  illustration: 'dashboard' | 'tax' | 'ai' | 'docs' | 'scenarios' | 'entity' | 'planning' | 'collab' | 'welcome' | 'finish'\n}\n\nconst TOUR_STEPS: TourStep[] = [\n  {\n    id: 'welcome',\n    title: 'Welcome to Fortuna',\n    subtitle: 'Your financial command center is ready',\n    description: 'Fortuna continuously analyzes your financial data to find tax savings, flag risks, and generate actionable strategies — all in real time. Here\\'s a quick tour of what you can do.',\n    features: [\n      'Real-time tax calculations across all income sources',\n      'AI-powered strategy recommendations',\n      '30+ analytical modules working together',\n      'Professional document generation',\n    ],\n    icon: <Rocket size={24} />,\n    color: '#f59e0b',\n    gradient: 'linear-gradient(135deg, #f59e0b, #d97706)',\n    illustration: 'welcome',\n  },\n  {\n    id: 'dashboard',\n    title: 'Your Dashboard',\n    subtitle: 'Everything at a glance',\n    description: 'The Dashboard surfaces what matters most — your key financial metrics, proactive alerts, and the single most impactful action you can take right now. It updates in real time as your data changes.',\n    features: [\n      'KPI cards: income, taxes, effective rate, net take-home',\n      'Proactive Intelligence Pulse with alerts and deadlines',\n      'Health score tracking your overall financial fitness',\n      'Smart strategy feed prioritized by impact',\n    ],\n    icon: <LayoutDashboard size={24} />,\n    color: '#f59e0b',\n    gradient: 'linear-gradient(135deg, #f59e0b, #b8912e)',\n    action: { label: 'View Dashboard', view: 'dashboard' },\n    illustration: 'dashboard',\n  },\n  {\n    id: 'tax',\n    title: 'Tax Strategy',\n    subtitle: 'See exactly where your money goes',\n    description: 'A complete breakdown of your tax position: federal, state, self-employment, and effective rates. Fortuna identifies bracket-crossing risks, missing deductions, and optimization opportunities automatically.',\n    features: [\n      'Full tax calculation with bracket visualization',\n      'Marginal vs. effective rate analysis',\n      'Automatic deduction gap detection',\n      'Year-over-year comparison tracking',\n    ],\n    icon: <DollarSign size={24} />,\n    color: '#10b981',\n    gradient: 'linear-gradient(135deg, #10b981, #059669)',\n    action: { label: 'Explore Tax Strategy', view: 'tax' },\n    illustration: 'tax',\n  },\n  {\n    id: 'alerts',\n    title: 'Intelligence Feed',\n    subtitle: 'Fortuna watches your back',\n    description: 'Proactive alerts surface time-sensitive deadlines, tax-saving opportunities, and risk factors before they become problems. This is what makes Fortuna different — it comes to you.',\n    features: [\n      'Estimated tax payment reminders with countdown',\n      'Bracket-crossing projections and warnings',\n      'Retirement contribution gap analysis',\n      'S-Corp election opportunity detection',\n      'Audit risk threshold monitoring',\n    ],\n    icon: <Bell size={24} />,\n    color: '#ef4444',\n    gradient: 'linear-gradient(135deg, #ef4444, #dc2626)',\n    action: { label: 'View Intelligence Feed', view: 'alerts' },\n    illustration: 'tax',\n  },\n  {\n    id: 'advisor',\n    title: 'AI Financial Advisor',\n    subtitle: 'Ask anything about your finances',\n    description: 'Chat with an AI advisor that has full context of your financial data. Ask it to analyze your situation, compare strategies, explain tax concepts, or generate specific recommendations.',\n    features: [\n      'Full financial context in every conversation',\n      'Pre-built query categories for common questions',\n      'Multi-provider support (Anthropic, OpenAI, Gemini)',\n      'Conversation history for reference',\n    ],\n    icon: <Bot size={24} />,\n    color: '#8b5cf6',\n    gradient: 'linear-gradient(135deg, #8b5cf6, #7c3aed)',\n    action: { label: 'Chat with Advisor', view: 'advisor' },\n    illustration: 'ai',\n  },\n  {\n    id: 'documents',\n    title: 'AI Document Center',\n    subtitle: 'Turn data into deliverables',\n    description: 'Generate professional financial documents powered by AI — CPA handoff letters, entity recommendation memos, year-end action plans, and more. Print, download, or share with your accountant.',\n    features: [\n      '6 AI-powered document templates',\n      'CPA Summary Letter for accountant handoff',\n      'Entity Recommendation Memo with dollar math',\n      'Year-End Tax Action Plan with deadlines',\n      'Tax forms: 1040-ES vouchers, checklists',\n    ],\n    icon: <FileText size={24} />,\n    color: '#f59e0b',\n    gradient: 'linear-gradient(135deg, #f59e0b, #d97706)',\n    action: { label: 'Open Document Center', view: 'documents' },\n    illustration: 'docs',\n  },\n  {\n    id: 'scenarios',\n    title: 'Scenario Modeler',\n    subtitle: 'What-if planning made easy',\n    description: 'Compare your current financial path against alternative scenarios. What if you formed an S-Corp? Moved states? Increased retirement contributions? See the exact dollar impact side by side.',\n    features: [\n      'Pre-built smart scenarios based on your data',\n      'Custom scenario builder with unlimited variables',\n      'Side-by-side delta comparison',\n      'Impact visualization with break-even analysis',\n    ],\n    icon: <GitBranch size={24} />,\n    color: '#06b6d4',\n    gradient: 'linear-gradient(135deg, #06b6d4, #0891b2)',\n    action: { label: 'Try Scenarios', view: 'scenarios' },\n    illustration: 'scenarios',\n  },\n  {\n    id: 'entity',\n    title: 'Entity Design',\n    subtitle: 'Optimize your business structure',\n    description: 'Analyze and compare entity types — sole prop, LLC, S-Corp, C-Corp — with specific dollar savings for your income level. See compliance costs, liability protection, and payroll tax optimization.',\n    features: [\n      'Entity comparison with your actual numbers',\n      'S-Corp reasonable salary calculator',\n      'Compliance cost tracking',\n      'Multi-entity structuring analysis',\n    ],\n    icon: <Building2 size={24} />,\n    color: '#3b82f6',\n    gradient: 'linear-gradient(135deg, #3b82f6, #2563eb)',\n    action: { label: 'Explore Entities', view: 'entity' },\n    illustration: 'entity',\n  },\n  {\n    id: 'planning',\n    title: 'Planning & Tracking',\n    subtitle: 'Retirement, goals, and cash flow',\n    description: 'Long-term financial planning tools: retirement contribution optimization, goal tracking, cash flow projections, and multi-year tax analysis to see where you\\'re headed.',\n    features: [\n      'Retirement optimizer (SEP-IRA, Solo 401k, Roth)',\n      'Goal planner with milestone tracking',\n      'Monthly cash flow projections',\n      'Multi-year tax trajectory analysis',\n      'Financial health score with factors',\n    ],\n    icon: <Target size={24} />,\n    color: '#ec4899',\n    gradient: 'linear-gradient(135deg, #ec4899, #db2777)',\n    action: { label: 'Plan Retirement', view: 'retirement' },\n    illustration: 'planning',\n  },\n  {\n    id: 'collab',\n    title: 'Workspace Collaboration',\n    subtitle: 'Work together, plan together',\n    description: 'Create workspaces to collaborate with business partners, financial advisors, or your CPA. Shared state, pooled AI keys, role-based access control, and real-time activity logging.',\n    features: [\n      'Invite team members with role-based access',\n      'Owner, Admin, Member, and Viewer roles',\n      'Shared financial state and AI advisor',\n      'Activity log for accountability',\n    ],\n    icon: <Users size={24} />,\n    color: '#14b8a6',\n    gradient: 'linear-gradient(135deg, #14b8a6, #0d9488)',\n    action: { label: 'Create Workspace', view: 'workspace' },\n    illustration: 'collab',\n  },\n  {\n    id: 'finish',\n    title: 'You\\'re All Set',\n    subtitle: 'Start optimizing your finances',\n    description: 'Your profile is configured and Fortuna is already analyzing your data. Check the Dashboard for your first insights, or dive into any module that interests you. You can always return to update your data from the sidebar.',\n    features: [\n      'Tip: Check the Intelligence Feed for immediate opportunities',\n      'Tip: Ask the AI Advisor \"What are my top 3 tax-saving moves?\"',\n      'Tip: Generate a CPA Summary Letter to share with your accountant',\n      'Tip: Run scenarios to compare S-Corp vs. your current structure',\n    ],\n    icon: <CheckCircle2 size={24} />,\n    color: '#10b981',\n    gradient: 'linear-gradient(135deg, #10b981, #059669)',\n    action: { label: 'Go to Dashboard', view: 'dashboard' },\n    illustration: 'finish',\n  },\n]\n\n// ─── Illustration Component ──────────────────────────────────────────\n\nfunction StepIllustration({ type, color, report }: {\n  type: TourStep['illustration']\n  color: string\n  report?: { grossIncome: number; totalTax: number; effectiveRate: number; netIncome: number }\n}) {\n  const fmt = (n: number) => `$${Math.round(n / 1000)}k`\n\n  // Simple visual previews for each step type\n  const illustrations: Record<string, JSX.Element> = {\n    welcome: (\n      <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 16 }}>\n        <div style={{ fontSize: 64, lineHeight: 1 }}>⚡</div>\n        <div style={{ display: 'flex', gap: 8 }}>\n          {['Tax', 'Entity', 'Alerts', 'AI', 'Docs'].map(l => (\n            <div key={l} style={{\n              padding: '4px 10px', borderRadius: 6, fontSize: 10, fontWeight: 600,\n              background: `${color}18`, color, letterSpacing: '0.03em',\n            }}>{l}</div>\n          ))}\n        </div>\n      </div>\n    ),\n    dashboard: report ? (\n      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 8, width: '100%' }}>\n        {[\n          { label: 'Income', value: fmt(report.grossIncome), c: '#f59e0b' },\n          { label: 'Tax', value: fmt(report.totalTax), c: '#ef4444' },\n          { label: 'Rate', value: `${report.effectiveRate.toFixed(1)}%`, c: '#8b5cf6' },\n          { label: 'Net', value: fmt(report.netIncome), c: '#10b981' },\n        ].map(kpi => (\n          <div key={kpi.label} style={{\n            padding: '10px 12px', borderRadius: 8,\n            background: `${kpi.c}08`, border: `1px solid ${kpi.c}18`,\n          }}>\n            <div style={{ fontSize: 9, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.05em' }}>{kpi.label}</div>\n            <div style={{ fontSize: 16, fontWeight: 700, color: kpi.c }}>{kpi.value}</div>\n          </div>\n        ))}\n      </div>\n    ) : <div />,\n    tax: (\n      <div style={{ width: '100%' }}>\n        {[\n          { label: 'Federal Income Tax', pct: 65, c: '#3b82f6' },\n          { label: 'State Tax', pct: 15, c: '#8b5cf6' },\n          { label: 'Self-Employment Tax', pct: 20, c: '#f59e0b' },\n        ].map(bar => (\n          <div key={bar.label} style={{ marginBottom: 8 }}>\n            <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 10, color: 'var(--text-muted)', marginBottom: 3 }}>\n              <span>{bar.label}</span>\n              <span style={{ color: bar.c, fontWeight: 600 }}>{bar.pct}%</span>\n            </div>\n            <div style={{ height: 6, borderRadius: 3, background: 'rgba(255,255,255,0.06)' }}>\n              <div style={{ height: '100%', width: `${bar.pct}%`, borderRadius: 3, background: bar.c, transition: 'width 0.8s ease' }} />\n            </div>\n          </div>\n        ))}\n      </div>\n    ),\n    ai: (\n      <div style={{ width: '100%', display: 'flex', flexDirection: 'column', gap: 6 }}>\n        <div style={{ display: 'flex', gap: 8, alignItems: 'flex-start' }}>\n          <div style={{ width: 24, height: 24, borderRadius: 6, background: 'rgba(139,92,246,0.15)', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 }}>\n            <Bot size={12} style={{ color: '#8b5cf6' }} />\n          </div>\n          <div style={{ fontSize: 11, color: 'var(--text-secondary)', padding: '6px 10px', borderRadius: '2px 10px 10px 10px', background: 'rgba(139,92,246,0.08)', lineHeight: 1.4 }}>\n            Based on your income of $85k, forming an S-Corp would save approximately $4,200/yr in SE tax...\n          </div>\n        </div>\n        <div style={{ display: 'flex', gap: 6, flexWrap: 'wrap', marginTop: 4 }}>\n          {['Tax Strategy', 'Entity', 'Retirement'].map(cat => (\n            <div key={cat} style={{ padding: '3px 8px', borderRadius: 4, fontSize: 9, background: 'rgba(255,255,255,0.06)', color: 'var(--text-muted)' }}>{cat}</div>\n          ))}\n        </div>\n      </div>\n    ),\n    docs: (\n      <div style={{ width: '100%', display: 'flex', flexDirection: 'column', gap: 6 }}>\n        {['📋 CPA Summary Letter', '🏛️ Entity Recommendation', '📅 Year-End Action Plan'].map(d => (\n          <div key={d} style={{\n            display: 'flex', alignItems: 'center', gap: 8, padding: '8px 10px',\n            borderRadius: 8, background: 'rgba(255,255,255,0.04)',\n            border: '1px solid rgba(255,255,255,0.06)',\n          }}>\n            <span style={{ fontSize: 14 }}>{d.split(' ')[0]}</span>\n            <span style={{ fontSize: 11, color: 'var(--text-secondary)', flex: 1 }}>{d.split(' ').slice(1).join(' ')}</span>\n            <span style={{ fontSize: 8, padding: '2px 6px', borderRadius: 3, background: 'rgba(245,158,11,0.12)', color: '#f59e0b', fontWeight: 700 }}>AI</span>\n          </div>\n        ))}\n      </div>\n    ),\n    scenarios: (\n      <div style={{ width: '100%', display: 'flex', gap: 8 }}>\n        {[\n          { label: 'Current', tax: '$18.2k', color: 'var(--text-muted)' },\n          { label: 'S-Corp', tax: '$14.0k', color: '#10b981' },\n        ].map(s => (\n          <div key={s.label} style={{\n            flex: 1, padding: '10px 12px', borderRadius: 8, textAlign: 'center',\n            background: s.color === '#10b981' ? 'rgba(16,185,129,0.08)' : 'rgba(255,255,255,0.04)',\n            border: `1px solid ${s.color === '#10b981' ? 'rgba(16,185,129,0.15)' : 'rgba(255,255,255,0.06)'}`,\n          }}>\n            <div style={{ fontSize: 10, color: 'var(--text-muted)', marginBottom: 4 }}>{s.label}</div>\n            <div style={{ fontSize: 18, fontWeight: 700, color: s.color }}>{s.tax}</div>\n            <div style={{ fontSize: 9, color: 'var(--text-muted)', marginTop: 2 }}>total tax</div>\n          </div>\n        ))}\n      </div>\n    ),\n    entity: (\n      <div style={{ width: '100%' }}>\n        {[\n          { type: 'Sole Prop', tax: 'Highest SE tax', rec: false },\n          { type: 'LLC + S-Corp', tax: 'Lowest total tax', rec: true },\n          { type: 'C-Corp', tax: 'Double taxation risk', rec: false },\n        ].map(e => (\n          <div key={e.type} style={{\n            display: 'flex', alignItems: 'center', gap: 8, padding: '6px 10px',\n            marginBottom: 4, borderRadius: 6,\n            background: e.rec ? 'rgba(16,185,129,0.08)' : 'transparent',\n            border: e.rec ? '1px solid rgba(16,185,129,0.15)' : '1px solid transparent',\n          }}>\n            <Building2 size={12} style={{ color: e.rec ? '#10b981' : 'var(--text-muted)' }} />\n            <span style={{ fontSize: 11, color: 'var(--text-primary)', flex: 1, fontWeight: e.rec ? 600 : 400 }}>{e.type}</span>\n            <span style={{ fontSize: 10, color: e.rec ? '#10b981' : 'var(--text-muted)' }}>{e.tax}</span>\n            {e.rec && <CheckCircle2 size={12} style={{ color: '#10b981' }} />}\n          </div>\n        ))}\n      </div>\n    ),\n    planning: (\n      <div style={{ width: '100%', display: 'flex', flexDirection: 'column', gap: 8 }}>\n        {[\n          { icon: <PiggyBank size={14} />, label: 'Retirement', sub: 'SEP-IRA, Solo 401(k)', c: '#ec4899' },\n          { icon: <Target size={14} />, label: 'Goal Tracking', sub: 'Revenue milestones', c: '#f59e0b' },\n          { icon: <BarChart3 size={14} />, label: 'Multi-Year', sub: '5-year trajectory', c: '#3b82f6' },\n        ].map(item => (\n          <div key={item.label} style={{ display: 'flex', alignItems: 'center', gap: 10, padding: '6px 0' }}>\n            <div style={{ width: 28, height: 28, borderRadius: 7, background: `${item.c}12`, display: 'flex', alignItems: 'center', justifyContent: 'center', color: item.c }}>{item.icon}</div>\n            <div>\n              <div style={{ fontSize: 11, fontWeight: 600, color: 'var(--text-primary)' }}>{item.label}</div>\n              <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>{item.sub}</div>\n            </div>\n          </div>\n        ))}\n      </div>\n    ),\n    collab: (\n      <div style={{ width: '100%', display: 'flex', flexDirection: 'column', gap: 6 }}>\n        {[\n          { role: 'Owner', desc: 'Full control', c: '#f59e0b' },\n          { role: 'Admin', desc: 'Manage members', c: '#3b82f6' },\n          { role: 'Member', desc: 'View & edit', c: '#10b981' },\n          { role: 'Viewer', desc: 'Read-only', c: '#6b7280' },\n        ].map(r => (\n          <div key={r.role} style={{ display: 'flex', alignItems: 'center', gap: 8, padding: '4px 0' }}>\n            <div style={{ width: 8, height: 8, borderRadius: '50%', background: r.c }} />\n            <span style={{ fontSize: 11, fontWeight: 600, color: 'var(--text-primary)', width: 60 }}>{r.role}</span>\n            <span style={{ fontSize: 10, color: 'var(--text-muted)' }}>{r.desc}</span>\n          </div>\n        ))}\n      </div>\n    ),\n    finish: (\n      <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 12 }}>\n        <div style={{ fontSize: 56, lineHeight: 1 }}>🎯</div>\n        <div style={{ fontSize: 13, color: 'var(--text-secondary)', textAlign: 'center', lineHeight: 1.5 }}>\n          Your financial engine is running.\n        </div>\n      </div>\n    ),\n  }\n\n  return (\n    <div style={{\n      display: 'flex', alignItems: 'center', justifyContent: 'center',\n      padding: 20, minHeight: 120,\n    }}>\n      {illustrations[type] || illustrations.welcome}\n    </div>\n  )\n}\n\n// ─── Main Component ──────────────────────────────────────────────────\n\ninterface OnboardingTourProps {\n  onComplete: (navigateTo?: ViewKey) => void\n}\n\nexport function OnboardingTour({ onComplete }: OnboardingTourProps) {\n  const { state } = useFortuna()\n  const [step, setStep] = useState(0)\n  const [animating, setAnimating] = useState(false)\n\n  const report = generateTaxReport(state)\n  const current = TOUR_STEPS[step]\n  const isFirst = step === 0\n  const isLast = step === TOUR_STEPS.length - 1\n  const progress = ((step + 1) / TOUR_STEPS.length) * 100\n\n  const goNext = useCallback(() => {\n    if (animating) return\n    setAnimating(true)\n    setTimeout(() => {\n      setStep(s => Math.min(s + 1, TOUR_STEPS.length - 1))\n      setAnimating(false)\n    }, 150)\n  }, [animating])\n\n  const goPrev = useCallback(() => {\n    if (animating) return\n    setAnimating(true)\n    setTimeout(() => {\n      setStep(s => Math.max(s - 1, 0))\n      setAnimating(false)\n    }, 150)\n  }, [animating])\n\n  const handleFinish = useCallback((view?: ViewKey) => {\n    completeTour()\n    onComplete(view)\n  }, [onComplete])\n\n  const handleSkip = useCallback(() => {\n    completeTour()\n    onComplete('dashboard')\n  }, [onComplete])\n\n  // Keyboard navigation\n  useEffect(() => {\n    const handler = (e: KeyboardEvent) => {\n      if (e.key === 'ArrowRight' || e.key === 'Enter') { e.preventDefault(); isLast ? handleFinish(current.action?.view) : goNext() }\n      if (e.key === 'ArrowLeft') { e.preventDefault(); goPrev() }\n      if (e.key === 'Escape') { e.preventDefault(); handleSkip() }\n    }\n    window.addEventListener('keydown', handler)\n    return () => window.removeEventListener('keydown', handler)\n  }, [goNext, goPrev, handleFinish, handleSkip, isLast, current])\n\n  return (\n    <div style={{\n      position: 'fixed', inset: 0, zIndex: 9999,\n      display: 'flex', alignItems: 'center', justifyContent: 'center',\n      background: 'rgba(0,0,0,0.7)', backdropFilter: 'blur(8px)',\n    }}>\n      <div style={{\n        width: '100%', maxWidth: 520,\n        background: 'var(--bg-elevated, #1a1d24)',\n        borderRadius: 20,\n        border: '1px solid rgba(255,255,255,0.08)',\n        boxShadow: '0 24px 80px rgba(0,0,0,0.5)',\n        overflow: 'hidden',\n        opacity: animating ? 0.6 : 1,\n        transform: animating ? 'scale(0.98)' : 'scale(1)',\n        transition: 'all 0.15s ease',\n      }}>\n        {/* Progress bar */}\n        <div style={{ height: 3, background: 'rgba(255,255,255,0.04)' }}>\n          <div style={{\n            height: '100%', width: `${progress}%`,\n            background: current.gradient,\n            transition: 'width 0.3s ease',\n            borderRadius: '0 2px 2px 0',\n          }} />\n        </div>\n\n        {/* Header */}\n        <div style={{ padding: '20px 24px 0', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\n          <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>\n            <div style={{\n              width: 36, height: 36, borderRadius: 10,\n              background: current.gradient,\n              display: 'flex', alignItems: 'center', justifyContent: 'center',\n              color: '#fff', boxShadow: `0 4px 16px ${current.color}40`,\n            }}>\n              {current.icon}\n            </div>\n            <div>\n              <div style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.06em', fontWeight: 600 }}>\n                Step {step + 1} of {TOUR_STEPS.length}\n              </div>\n              <div style={{ fontSize: 18, fontWeight: 700, color: 'var(--text-primary)', lineHeight: 1.2 }}>\n                {current.title}\n              </div>\n            </div>\n          </div>\n          <button\n            onClick={handleSkip}\n            style={{\n              background: 'none', border: 'none', cursor: 'pointer',\n              color: 'var(--text-muted)', padding: 4,\n            }}\n            title=\"Skip tour (Esc)\"\n          >\n            <X size={18} />\n          </button>\n        </div>\n\n        {/* Subtitle */}\n        <div style={{ padding: '4px 24px 0', fontSize: 13, color: current.color, fontWeight: 500 }}>\n          {current.subtitle}\n        </div>\n\n        {/* Illustration */}\n        <div style={{ padding: '8px 24px' }}>\n          <div style={{\n            background: 'rgba(255,255,255,0.02)',\n            borderRadius: 12, border: '1px solid rgba(255,255,255,0.05)',\n            padding: '8px 16px',\n          }}>\n            <StepIllustration\n              type={current.illustration}\n              color={current.color}\n              report={report}\n            />\n          </div>\n        </div>\n\n        {/* Description */}\n        <div style={{ padding: '0 24px' }}>\n          <p style={{ fontSize: 13, color: 'var(--text-secondary)', lineHeight: 1.6, margin: '8px 0 12px' }}>\n            {current.description}\n          </p>\n\n          {/* Feature bullets */}\n          <div style={{ display: 'flex', flexDirection: 'column', gap: 5, marginBottom: 16 }}>\n            {current.features.map((feat, i) => (\n              <div key={i} style={{ display: 'flex', alignItems: 'flex-start', gap: 8 }}>\n                <Zap size={10} style={{ color: current.color, marginTop: 3, flexShrink: 0 }} />\n                <span style={{ fontSize: 12, color: 'var(--text-muted)', lineHeight: 1.4 }}>{feat}</span>\n              </div>\n            ))}\n          </div>\n        </div>\n\n        {/* Navigation */}\n        <div style={{\n          display: 'flex', alignItems: 'center', justifyContent: 'space-between',\n          padding: '12px 24px 20px', gap: 12,\n        }}>\n          {/* Left: Back / Skip */}\n          <div style={{ display: 'flex', gap: 8 }}>\n            {!isFirst && (\n              <button\n                onClick={goPrev}\n                style={{\n                  display: 'flex', alignItems: 'center', gap: 4,\n                  padding: '8px 14px', borderRadius: 8, fontSize: 12, fontWeight: 500,\n                  background: 'rgba(255,255,255,0.04)', border: '1px solid rgba(255,255,255,0.08)',\n                  color: 'var(--text-secondary)', cursor: 'pointer',\n                }}\n              >\n                <ChevronLeft size={14} /> Back\n              </button>\n            )}\n          </div>\n\n          {/* Center: dots */}\n          <div style={{ display: 'flex', gap: 4, justifyContent: 'center' }}>\n            {TOUR_STEPS.map((_, i) => (\n              <div\n                key={i}\n                onClick={() => setStep(i)}\n                style={{\n                  width: i === step ? 16 : 6, height: 6, borderRadius: 3,\n                  background: i === step ? current.color : 'rgba(255,255,255,0.1)',\n                  transition: 'all 0.3s ease', cursor: 'pointer',\n                }}\n              />\n            ))}\n          </div>\n\n          {/* Right: Next / Try it / Finish */}\n          <div style={{ display: 'flex', gap: 8 }}>\n            {current.action && !isLast && (\n              <button\n                onClick={() => handleFinish(current.action!.view)}\n                style={{\n                  display: 'flex', alignItems: 'center', gap: 4,\n                  padding: '8px 14px', borderRadius: 8, fontSize: 12, fontWeight: 500,\n                  background: 'rgba(255,255,255,0.04)', border: `1px solid ${current.color}30`,\n                  color: current.color, cursor: 'pointer',\n                }}\n              >\n                {current.action.label} <ArrowRight size={12} />\n              </button>\n            )}\n            <button\n              onClick={isLast ? () => handleFinish(current.action?.view) : goNext}\n              style={{\n                display: 'flex', alignItems: 'center', gap: 4,\n                padding: '8px 18px', borderRadius: 8, fontSize: 12, fontWeight: 600,\n                background: current.gradient, border: 'none',\n                color: '#fff', cursor: 'pointer',\n                boxShadow: `0 4px 12px ${current.color}30`,\n              }}\n            >\n              {isLast ? 'Get Started' : 'Next'} <ChevronRight size={14} />\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\PrintReport.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ProactivePulse.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\QuickStartWizard.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'MapPin' is defined but never used.","line":14,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":9,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"MapPin"},"fix":{"range":[470,480],"text":""},"desc":"Remove unused variable \"MapPin\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'state' is assigned a value but never used.","line":174,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":174,"endColumn":16},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":234,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":234,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9755,9758],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9755,9758],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE — Quick Start Wizard (Phase 1 UX Fix)\n *\n * Interview-style onboarding: one question per screen, friendly copy,\n * instant tax estimate after 5 questions. Replaces dense DataSetup\n * for first-time users. DataSetup remains for detailed editing.\n */\n\nimport { useState, useCallback } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport type { ViewKey } from '../App'\nimport {\n  ArrowRight, ArrowLeft, Sparkles, DollarSign, Building2,\n  MapPin, Briefcase, Users, Flame, CheckCircle2, TrendingUp,\n  Zap, ChevronRight, SkipForward,\n} from 'lucide-react'\n\n// ─── Step Definitions ───────────────────────────────────────────────\n\ninterface WizardStep {\n  id: string\n  question: string\n  subtitle: string\n  type: 'choice' | 'input' | 'multi' | 'result'\n  field?: string\n  options?: { value: string; label: string; description?: string; icon: React.ReactNode }[]\n  inputType?: 'currency' | 'text'\n  placeholder?: string\n  skipLabel?: string\n}\n\nconst STEPS: WizardStep[] = [\n  {\n    id: 'welcome',\n    question: 'What brings you to Fortuna?',\n    subtitle: 'This helps us personalize your experience. You can always change this later.',\n    type: 'choice',\n    field: 'goal',\n    options: [\n      { value: 'minimize_taxes', label: 'Reduce my tax bill', description: 'Find deductions and optimize my structure', icon: <DollarSign size={22} /> },\n      { value: 'track_crypto', label: 'Track crypto taxes', description: 'Cost basis, DeFi, and IRS reporting', icon: <TrendingUp size={22} /> },\n      { value: 'plan_entity', label: 'Choose a business structure', description: 'LLC vs S-Corp vs sole prop comparison', icon: <Building2 size={22} /> },\n      { value: 'general', label: 'Just exploring', description: 'Show me everything Fortuna can do', icon: <Sparkles size={22} /> },\n    ],\n  },\n  {\n    id: 'filing',\n    question: 'How do you file your taxes?',\n    subtitle: 'This determines your standard deduction and tax brackets.',\n    type: 'choice',\n    field: 'filingStatus',\n    options: [\n      { value: 'single', label: 'Single', icon: <Users size={22} /> },\n      { value: 'married_joint', label: 'Married, filing jointly', icon: <Users size={22} /> },\n      { value: 'married_separate', label: 'Married, filing separately', icon: <Users size={22} /> },\n      { value: 'head_of_household', label: 'Head of household', icon: <Users size={22} /> },\n    ],\n  },\n  {\n    id: 'state',\n    question: 'Which state do you live in?',\n    subtitle: 'State taxes can vary from 0% to 13.3%. This matters a lot.',\n    type: 'input',\n    field: 'state',\n    inputType: 'text',\n    placeholder: 'e.g. Illinois, California, Texas...',\n    skipLabel: 'Skip for now',\n  },\n  {\n    id: 'income',\n    question: 'Roughly, what\\'s your annual income?',\n    subtitle: 'A ballpark is fine. This helps us estimate your tax bracket and find relevant strategies.',\n    type: 'choice',\n    field: 'incomeRange',\n    options: [\n      { value: '25000', label: 'Under $50K', icon: <DollarSign size={22} /> },\n      { value: '75000', label: '$50K - $100K', icon: <DollarSign size={22} /> },\n      { value: '150000', label: '$100K - $200K', icon: <DollarSign size={22} /> },\n      { value: '300000', label: '$200K+', icon: <DollarSign size={22} /> },\n    ],\n  },\n  {\n    id: 'work_type',\n    question: 'How do you earn most of your income?',\n    subtitle: 'Self-employment income is taxed differently and has more optimization opportunities.',\n    type: 'multi',\n    field: 'incomeTypes',\n    options: [\n      { value: 'w2', label: 'W-2 Employee', description: 'Salary or hourly wages', icon: <Briefcase size={22} /> },\n      { value: 'self_employed', label: 'Self-employed / Freelance', description: '1099, contracts, gig work', icon: <Zap size={22} /> },\n      { value: 'business_owner', label: 'Business owner', description: 'LLC, S-Corp, or partnership', icon: <Building2 size={22} /> },\n      { value: 'investments', label: 'Investments / Crypto', description: 'Stocks, crypto, rental income', icon: <TrendingUp size={22} /> },\n    ],\n  },\n  {\n    id: 'result',\n    question: '',\n    subtitle: '',\n    type: 'result',\n  },\n]\n\n// ─── US State lookup ────────────────────────────────────────────────\n\nconst STATE_CODES: Record<string, string> = {\n  alabama: 'AL', alaska: 'AK', arizona: 'AZ', arkansas: 'AR', california: 'CA',\n  colorado: 'CO', connecticut: 'CT', delaware: 'DE', florida: 'FL', georgia: 'GA',\n  hawaii: 'HI', idaho: 'ID', illinois: 'IL', indiana: 'IN', iowa: 'IA',\n  kansas: 'KS', kentucky: 'KY', louisiana: 'LA', maine: 'ME', maryland: 'MD',\n  massachusetts: 'MA', michigan: 'MI', minnesota: 'MN', mississippi: 'MS', missouri: 'MO',\n  montana: 'MT', nebraska: 'NE', nevada: 'NV', 'new hampshire': 'NH', 'new jersey': 'NJ',\n  'new mexico': 'NM', 'new york': 'NY', 'north carolina': 'NC', 'north dakota': 'ND',\n  ohio: 'OH', oklahoma: 'OK', oregon: 'OR', pennsylvania: 'PA', 'rhode island': 'RI',\n  'south carolina': 'SC', 'south dakota': 'SD', tennessee: 'TN', texas: 'TX', utah: 'UT',\n  vermont: 'VT', virginia: 'VA', washington: 'WA', 'west virginia': 'WV',\n  wisconsin: 'WI', wyoming: 'WY',\n}\n\nfunction resolveState(input: string): string {\n  const lower = input.trim().toLowerCase()\n  if (lower.length === 2) return lower.toUpperCase()\n  return STATE_CODES[lower] || input.trim().slice(0, 2).toUpperCase()\n}\n\n// ─── Quick tax estimate ─────────────────────────────────────────────\n\nfunction quickEstimate(answers: Record<string, string | string[]>): { estimatedTax: number; effectiveRate: number; potentialSavings: number } {\n  const income = parseInt(answers.incomeRange as string) || 75000\n  const isSelfEmployed = (answers.incomeTypes as string[] || []).includes('self_employed') || (answers.incomeTypes as string[] || []).includes('business_owner')\n  const filing = answers.filingStatus as string || 'single'\n\n  // Simplified federal estimate\n  const standardDeduction = filing === 'married_joint' ? 29200 : 14600\n  const taxable = Math.max(0, income - standardDeduction)\n  let fedTax = 0\n  const brackets = filing === 'married_joint'\n    ? [[23850, 0.10], [73100, 0.12], [109650, 0.22], [167350, 0.24], [209450, 0.32], [250550, 0.35], [Infinity, 0.37]]\n    : [[11925, 0.10], [36550, 0.12], [54925, 0.22], [93950, 0.24], [53225, 0.32], [375825, 0.35], [Infinity, 0.37]]\n  let remaining = taxable\n  for (const [width, rate] of brackets) {\n    const amount = Math.min(remaining, width as number)\n    fedTax += amount * (rate as number)\n    remaining -= amount\n    if (remaining <= 0) break\n  }\n\n  const seTax = isSelfEmployed ? income * 0.9235 * 0.153 : 0\n  const totalTax = fedTax + seTax\n\n  // Potential savings estimate based on common missed deductions\n  let savings = 0\n  if (isSelfEmployed) {\n    savings += Math.min(income * 0.2, 20000) // QBI deduction potential\n    savings += 3000 // Home office\n    savings += 2000 // Business expenses\n  }\n  savings += 1500 // Average missed deductions\n\n  return {\n    estimatedTax: Math.round(totalTax),\n    effectiveRate: Math.round((totalTax / income) * 1000) / 10,\n    potentialSavings: Math.round(savings),\n  }\n}\n\n// ─── Component ──────────────────────────────────────────────────────\n\ninterface QuickStartProps {\n  onComplete: (navigateTo?: ViewKey) => void\n  onSkipToFull: () => void\n}\n\nexport function QuickStartWizard({ onComplete, onSkipToFull }: QuickStartProps) {\n  const { state, updateState } = useFortuna()\n  const [currentStep, setCurrentStep] = useState(0)\n  const [answers, setAnswers] = useState<Record<string, string | string[]>>({})\n  const [stateInput, setStateInput] = useState('')\n\n  const step = STEPS[currentStep]\n  const totalSteps = STEPS.length\n  const isResult = step.type === 'result'\n\n  const setAnswer = useCallback((field: string, value: string) => {\n    setAnswers(prev => ({ ...prev, [field]: value }))\n  }, [])\n\n  const toggleMulti = useCallback((field: string, value: string) => {\n    setAnswers(prev => {\n      const current = (prev[field] as string[]) || []\n      return {\n        ...prev,\n        [field]: current.includes(value) ? current.filter(v => v !== value) : [...current, value],\n      }\n    })\n  }, [])\n\n  const canProceed = useCallback((): boolean => {\n    if (!step.field) return true\n    if (step.type === 'input') return true // Input steps are always skippable\n    const val = answers[step.field]\n    if (step.type === 'multi') return Array.isArray(val) && val.length > 0\n    return !!val\n  }, [step, answers])\n\n  const goNext = useCallback(() => {\n    if (currentStep < totalSteps - 1) setCurrentStep(prev => prev + 1)\n  }, [currentStep, totalSteps])\n\n  const goBack = useCallback(() => {\n    if (currentStep > 0) setCurrentStep(prev => prev - 1)\n  }, [currentStep])\n\n  const finishWizard = useCallback((navigateTo?: ViewKey) => {\n    // Apply answers to Fortuna state\n    const income = parseInt(answers.incomeRange as string) || 75000\n    const isSE = (answers.incomeTypes as string[] || []).includes('self_employed') || (answers.incomeTypes as string[] || []).includes('business_owner')\n    const resolvedState = stateInput ? resolveState(stateInput) : 'IL'\n\n    updateState(prev => ({\n      ...prev,\n      filingStatus: (answers.filingStatus as string) || 'single',\n      stateCode: resolvedState,\n      onboardingComplete: true,\n      w2Income: !isSE ? income : (prev.w2Income || 0),\n      selfEmploymentIncome: isSE ? income : (prev.selfEmploymentIncome || 0),\n      incomeStreams: prev.incomeStreams.length > 0 ? prev.incomeStreams : [\n        {\n          id: 'qs-income-1',\n          name: isSE ? 'Self-Employment Income' : 'W-2 Salary',\n          type: isSE ? 'freelance' : 'w2',\n          annualAmount: income,\n          isActive: true,\n          taxWithheld: !isSE ? Math.round(income * 0.22) : 0,\n        } as any,\n      ],\n    }))\n\n    onComplete(navigateTo)\n  }, [answers, stateInput, updateState, onComplete])\n\n  // ─── Result Screen ──────────────────────────────────────────────\n\n  if (isResult) {\n    const estimate = quickEstimate(answers)\n    return (\n      <div className=\"wizard-container\" style={{ paddingTop: 40 }}>\n        {/* Animated success icon */}\n        <div style={{ textAlign: 'center', marginBottom: 32 }}>\n          <div style={{\n            width: 72, height: 72, borderRadius: 20, margin: '0 auto 20px',\n            background: 'linear-gradient(135deg, var(--accent-gold), #b8912e)',\n            display: 'flex', alignItems: 'center', justifyContent: 'center',\n            boxShadow: '0 8px 32px rgba(212,168,67,0.3)',\n            animation: 'pulse 2s ease-in-out infinite',\n          }}>\n            <Flame size={36} color=\"#0c0e12\" />\n          </div>\n          <div style={{ fontFamily: 'var(--font-display)', fontSize: 32, color: 'var(--text-primary)', marginBottom: 8 }}>\n            Here's your snapshot\n          </div>\n          <div style={{ fontSize: 15, color: 'var(--text-secondary)', maxWidth: 400, margin: '0 auto' }}>\n            Based on what you've told us, here's a quick look at your tax situation.\n          </div>\n        </div>\n\n        {/* Estimate cards */}\n        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 12, marginBottom: 32 }}>\n          {[\n            { label: 'Estimated Tax', value: `$${estimate.estimatedTax.toLocaleString()}`, color: 'var(--accent-blue)' },\n            { label: 'Effective Rate', value: `${estimate.effectiveRate}%`, color: 'var(--accent-gold)' },\n            { label: 'Potential Savings', value: `$${estimate.potentialSavings.toLocaleString()}`, color: 'var(--accent-emerald)' },\n          ].map(card => (\n            <div key={card.label} style={{\n              padding: 20, borderRadius: 14, background: 'var(--bg-surface)',\n              border: '1px solid var(--border-subtle)', textAlign: 'center',\n            }}>\n              <div style={{ fontSize: 12, color: 'var(--text-muted)', marginBottom: 8, fontWeight: 500 }}>{card.label}</div>\n              <div style={{ fontFamily: 'var(--font-mono)', fontSize: 24, fontWeight: 600, color: card.color }}>{card.value}</div>\n            </div>\n          ))}\n        </div>\n\n        <div style={{ fontSize: 13, color: 'var(--text-muted)', textAlign: 'center', marginBottom: 32, lineHeight: 1.6 }}>\n          This is a rough estimate. Add more details in your profile to get precise calculations with state taxes, deductions, and credits.\n        </div>\n\n        {/* Action buttons */}\n        <div style={{ display: 'flex', flexDirection: 'column', gap: 10, maxWidth: 360, margin: '0 auto' }}>\n          <button onClick={() => finishWizard('dashboard')} className=\"wizard-btn-next\" style={{ justifyContent: 'center', width: '100%', padding: '14px 24px', fontSize: 15 }}>\n            <Sparkles size={18} />\n            Explore My Dashboard\n          </button>\n          <button onClick={() => finishWizard('deductions')} style={{\n            padding: '12px 24px', borderRadius: 10, border: '1px solid var(--accent-emerald)',\n            background: 'rgba(52,211,153,0.08)', color: 'var(--accent-emerald)',\n            cursor: 'pointer', fontFamily: 'var(--font-body)', fontSize: 14, fontWeight: 500,\n            display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8,\n            transition: 'all 0.2s',\n          }}>\n            <DollarSign size={18} />\n            Find My Deductions\n          </button>\n          <button onClick={onSkipToFull} style={{\n            padding: '10px', background: 'transparent', border: 'none',\n            color: 'var(--text-muted)', cursor: 'pointer', fontSize: 13,\n            fontFamily: 'var(--font-body)', transition: 'color 0.2s',\n          }}\n          onMouseEnter={e => (e.currentTarget.style.color = 'var(--text-secondary)')}\n          onMouseLeave={e => (e.currentTarget.style.color = 'var(--text-muted)')}>\n            Enter detailed data instead\n          </button>\n        </div>\n      </div>\n    )\n  }\n\n  // ─── Question Screens ─────────────────────────────────────────────\n\n  return (\n    <div className=\"wizard-container\">\n      {/* Progress bar */}\n      <div className=\"wizard-progress\" role=\"progressbar\" aria-valuenow={currentStep + 1} aria-valuemin={1} aria-valuemax={totalSteps} aria-label={`Step ${currentStep + 1} of ${totalSteps - 1}`}>\n        {STEPS.slice(0, -1).map((_, i) => (\n          <div key={i} className={`wizard-step-dot ${i < currentStep ? 'complete' : ''} ${i === currentStep ? 'active' : ''}`} />\n        ))}\n      </div>\n\n      {/* Question */}\n      <h2 className=\"wizard-question\">{step.question}</h2>\n      <p className=\"wizard-subtitle\">{step.subtitle}</p>\n\n      {/* Choice options */}\n      {step.type === 'choice' && step.options && (\n        <div className=\"wizard-options\" role=\"radiogroup\" aria-label={step.question}>\n          {step.options.map(opt => (\n            <button\n              key={opt.value}\n              className={`wizard-option ${answers[step.field!] === opt.value ? 'selected' : ''}`}\n              onClick={() => { setAnswer(step.field!, opt.value); setTimeout(goNext, 200) }}\n              role=\"radio\"\n              aria-checked={answers[step.field!] === opt.value}\n            >\n              <div className=\"wizard-option-icon\" style={{ background: answers[step.field!] === opt.value ? 'var(--accent-gold-dim)' : 'var(--bg-hover)', color: answers[step.field!] === opt.value ? 'var(--accent-gold)' : 'var(--text-secondary)' }}>\n                {opt.icon}\n              </div>\n              <div>\n                <div style={{ fontWeight: 500, marginBottom: 2 }}>{opt.label}</div>\n                {opt.description && <div style={{ fontSize: 13, color: 'var(--text-muted)' }}>{opt.description}</div>}\n              </div>\n              {answers[step.field!] === opt.value && <CheckCircle2 size={20} color=\"var(--accent-gold)\" style={{ marginLeft: 'auto', flexShrink: 0 }} />}\n            </button>\n          ))}\n        </div>\n      )}\n\n      {/* Multi-select options */}\n      {step.type === 'multi' && step.options && (\n        <div className=\"wizard-options\" role=\"group\" aria-label={step.question}>\n          {step.options.map(opt => {\n            const selected = ((answers[step.field!] as string[]) || []).includes(opt.value)\n            return (\n              <button\n                key={opt.value}\n                className={`wizard-option ${selected ? 'selected' : ''}`}\n                onClick={() => toggleMulti(step.field!, opt.value)}\n                role=\"checkbox\"\n                aria-checked={selected}\n              >\n                <div className=\"wizard-option-icon\" style={{ background: selected ? 'var(--accent-gold-dim)' : 'var(--bg-hover)', color: selected ? 'var(--accent-gold)' : 'var(--text-secondary)' }}>\n                  {opt.icon}\n                </div>\n                <div>\n                  <div style={{ fontWeight: 500, marginBottom: 2 }}>{opt.label}</div>\n                  {opt.description && <div style={{ fontSize: 13, color: 'var(--text-muted)' }}>{opt.description}</div>}\n                </div>\n                {selected && <CheckCircle2 size={20} color=\"var(--accent-gold)\" style={{ marginLeft: 'auto', flexShrink: 0 }} />}\n              </button>\n            )\n          })}\n        </div>\n      )}\n\n      {/* Text input */}\n      {step.type === 'input' && (\n        <div style={{ marginBottom: 32 }}>\n          <input\n            type=\"text\"\n            value={stateInput}\n            onChange={e => setStateInput(e.target.value)}\n            placeholder={step.placeholder}\n            autoFocus\n            className=\"form-input\"\n            style={{ width: '100%', fontSize: 16, padding: '14px 18px' }}\n            aria-label={step.question}\n            onKeyDown={e => { if (e.key === 'Enter') goNext() }}\n          />\n        </div>\n      )}\n\n      {/* Navigation */}\n      <div className=\"wizard-nav\">\n        <div>\n          {currentStep > 0 && (\n            <button className=\"wizard-btn-back\" onClick={goBack} aria-label=\"Go back\">\n              <ArrowLeft size={16} style={{ marginRight: 6 }} />\n              Back\n            </button>\n          )}\n        </div>\n        <div style={{ display: 'flex', gap: 8 }}>\n          {step.skipLabel && (\n            <button className=\"wizard-btn-back\" onClick={goNext}>\n              {step.skipLabel} <SkipForward size={14} style={{ marginLeft: 4 }} />\n            </button>\n          )}\n          {(step.type === 'multi' || step.type === 'input') && (\n            <button className=\"wizard-btn-next\" onClick={goNext} disabled={step.type === 'multi' && !canProceed()}>\n              Continue <ArrowRight size={16} />\n            </button>\n          )}\n        </div>\n      </div>\n\n      {/* Skip to full setup */}\n      <div style={{ textAlign: 'center', marginTop: 40 }}>\n        <button onClick={onSkipToFull} style={{\n          background: 'transparent', border: 'none', color: 'var(--text-muted)',\n          cursor: 'pointer', fontSize: 12, fontFamily: 'var(--font-body)',\n          display: 'inline-flex', alignItems: 'center', gap: 4, transition: 'color 0.2s',\n        }}\n        onMouseEnter={e => (e.currentTarget.style.color = 'var(--text-secondary)')}\n        onMouseLeave={e => (e.currentTarget.style.color = 'var(--text-muted)')}>\n          I'd prefer to enter detailed data <ChevronRight size={12} />\n        </button>\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\SaveStatusBar.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\SaveStatusBar.tsx:28:5\n  26 |   // Track state changes → show \"saving...\" then \"saved\"\n  27 |   useEffect(() => {\n> 28 |     setSaveState('saving')\n     |     ^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  29 |     clearTimeout(saveTimer.current)\n  30 |     saveTimer.current = setTimeout(() => setSaveState('saved'), 1200)\n  31 |     return () => clearTimeout(saveTimer.current)","line":28,"column":5,"nodeType":null,"endLine":28,"endColumn":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — Save Status Bar\n *\n * Persistent indicator showing:\n *   • Auto-save status (saved / saving / error)\n *   • Storage quota usage\n *   • Data health score (errors/warnings from validation)\n *   • Emergency export button\n *   • Backup count\n */\n\nimport { useState, useEffect, useRef, useCallback } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { validateFullState } from '../engine/input-validation'\nimport { checkStorageQuota, listBackups, downloadEmergencyExport } from '../engine/data-safety'\nimport { Download, Shield, HardDrive, CheckCircle2, AlertTriangle, XCircle, Loader2 } from 'lucide-react'\n\ntype SaveState = 'saved' | 'saving' | 'error' | 'idle'\n\nexport function SaveStatusBar() {\n  const { state } = useFortuna()\n  const [saveState, setSaveState] = useState<SaveState>('idle')\n  const [showDetails, setShowDetails] = useState(false)\n  const saveTimer = useRef<ReturnType<typeof setTimeout>>()\n\n  // Track state changes → show \"saving...\" then \"saved\"\n  useEffect(() => {\n    setSaveState('saving')\n    clearTimeout(saveTimer.current)\n    saveTimer.current = setTimeout(() => setSaveState('saved'), 1200)\n    return () => clearTimeout(saveTimer.current)\n  }, [state])\n\n  // Listen for save events\n  useEffect(() => {\n    const handler = () => setSaveState('saved')\n    const errorHandler = () => setSaveState('error')\n    window.addEventListener('fortuna:state-saved', handler)\n    window.addEventListener('fortuna:save-error', errorHandler)\n    return () => {\n      window.removeEventListener('fortuna:state-saved', handler)\n      window.removeEventListener('fortuna:save-error', errorHandler)\n    }\n  }, [])\n\n  const validation = validateFullState(state)\n  const quota = checkStorageQuota()\n  const backups = listBackups()\n\n  const healthIcon = validation.errorCount > 0 ? <XCircle size={12} /> :\n    validation.warningCount > 0 ? <AlertTriangle size={12} /> :\n    <CheckCircle2 size={12} />\n\n  const healthColor = validation.errorCount > 0 ? '#ef4444' :\n    validation.warningCount > 0 ? '#f59e0b' : '#22c55e'\n\n  const saveIcon = saveState === 'saving' ? <Loader2 size={12} style={{ animation: 'spin 1s linear infinite' }} /> :\n    saveState === 'error' ? <XCircle size={12} /> :\n    <CheckCircle2 size={12} />\n\n  const saveColor = saveState === 'error' ? '#ef4444' : saveState === 'saving' ? 'var(--text-muted)' : '#22c55e'\n  const saveLabel = saveState === 'saving' ? 'Saving...' :\n    saveState === 'error' ? 'Save error' : 'Saved'\n\n  const handleEmergencyExport = useCallback(() => {\n    downloadEmergencyExport()\n  }, [])\n\n  return (\n    <>\n      {/* Spin animation for loader */}\n      <style>{`@keyframes spin { to { transform: rotate(360deg) } }`}</style>\n\n      <div\n        style={{\n          position: 'fixed', bottom: 0, left: 0, right: 0,\n          height: 28, display: 'flex', alignItems: 'center',\n          padding: '0 16px', gap: 16,\n          background: 'var(--bg-secondary, #0f1219)',\n          borderTop: '1px solid var(--border-subtle, rgba(255,255,255,0.06))',\n          fontSize: 11, fontFamily: 'var(--font-mono, monospace)',\n          color: 'var(--text-muted, #6b7280)',\n          zIndex: 50,\n          userSelect: 'none',\n        }}\n      >\n        {/* Save status */}\n        <div style={{ display: 'flex', alignItems: 'center', gap: 4, color: saveColor }}>\n          {saveIcon}\n          <span>{saveLabel}</span>\n        </div>\n\n        <div style={{ width: 1, height: 14, background: 'var(--border-subtle, rgba(255,255,255,0.06))' }} />\n\n        {/* Data health */}\n        <div\n          style={{ display: 'flex', alignItems: 'center', gap: 4, color: healthColor, cursor: 'pointer' }}\n          onClick={() => setShowDetails(prev => !prev)}\n          title=\"Data health — click for details\"\n        >\n          {healthIcon}\n          <span>\n            {validation.errorCount > 0 ? `${validation.errorCount} error${validation.errorCount !== 1 ? 's' : ''}` :\n             validation.warningCount > 0 ? `${validation.warningCount} warning${validation.warningCount !== 1 ? 's' : ''}` :\n             'Healthy'}\n          </span>\n        </div>\n\n        <div style={{ width: 1, height: 14, background: 'var(--border-subtle, rgba(255,255,255,0.06))' }} />\n\n        {/* Storage */}\n        <div style={{ display: 'flex', alignItems: 'center', gap: 4, color: quota.isWarning ? '#f59e0b' : 'var(--text-muted)' }}>\n          <HardDrive size={11} />\n          <span>{quota.usedMB} / {quota.estimatedLimitMB}MB</span>\n          {quota.isWarning && <span style={{ color: '#f59e0b' }}>⚠</span>}\n        </div>\n\n        <div style={{ width: 1, height: 14, background: 'var(--border-subtle, rgba(255,255,255,0.06))' }} />\n\n        {/* Backups */}\n        <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>\n          <Shield size={11} />\n          <span>{backups.length} backup{backups.length !== 1 ? 's' : ''}</span>\n        </div>\n\n        {/* Spacer */}\n        <div style={{ flex: 1 }} />\n\n        {/* Emergency export */}\n        <button\n          onClick={handleEmergencyExport}\n          title=\"Emergency data export\"\n          style={{\n            display: 'flex', alignItems: 'center', gap: 4,\n            background: 'none', border: 'none', color: 'var(--text-muted)',\n            cursor: 'pointer', fontSize: 11, fontFamily: 'inherit',\n            padding: '2px 6px', borderRadius: 4,\n          }}\n          onMouseEnter={(e) => (e.currentTarget.style.color = 'var(--accent-gold, #f59e0b)')}\n          onMouseLeave={(e) => (e.currentTarget.style.color = 'var(--text-muted, #6b7280)')}\n        >\n          <Download size={11} />\n          <span>Export</span>\n        </button>\n      </div>\n\n      {/* Details panel */}\n      {showDetails && (\n        <div\n          style={{\n            position: 'fixed', bottom: 28, right: 16,\n            width: 360, maxHeight: 320, overflow: 'auto',\n            background: 'var(--bg-card, #141822)',\n            border: '1px solid var(--border-subtle, rgba(255,255,255,0.08))',\n            borderRadius: '10px 10px 0 0',\n            boxShadow: '0 -4px 24px rgba(0,0,0,0.3)',\n            padding: 16, zIndex: 51,\n          }}\n        >\n          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>\n            <h4 style={{ margin: 0, fontSize: 13, fontWeight: 600, color: 'var(--text-primary, #f8fafc)' }}>Data Health</h4>\n            <button\n              onClick={() => setShowDetails(false)}\n              style={{ background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: 16, padding: 0 }}\n            >×</button>\n          </div>\n\n          {validation.issues.length === 0 ? (\n            <div style={{ textAlign: 'center', padding: 24, color: '#22c55e' }}>\n              <CheckCircle2 size={28} style={{ margin: '0 auto 8px' }} />\n              <div style={{ fontSize: 12 }}>All data checks passed</div>\n            </div>\n          ) : (\n            <div style={{ display: 'flex', flexDirection: 'column', gap: 6 }}>\n              {validation.issues.slice(0, 20).map((issue, i) => (\n                <div\n                  key={i}\n                  style={{\n                    padding: '8px 10px', borderRadius: 6, fontSize: 11, lineHeight: 1.4,\n                    background: issue.severity === 'error' ? 'rgba(239,68,68,0.08)' :\n                      issue.severity === 'warning' ? 'rgba(245,158,11,0.08)' : 'rgba(59,130,246,0.08)',\n                    border: `1px solid ${issue.severity === 'error' ? 'rgba(239,68,68,0.15)' :\n                      issue.severity === 'warning' ? 'rgba(245,158,11,0.15)' : 'rgba(59,130,246,0.15)'}`,\n                  }}\n                >\n                  <div style={{\n                    color: issue.severity === 'error' ? '#ef4444' :\n                      issue.severity === 'warning' ? '#f59e0b' : '#3b82f6',\n                    fontWeight: 500, marginBottom: 2,\n                    textTransform: 'uppercase', fontSize: 9, letterSpacing: '0.05em',\n                  }}>\n                    {issue.severity}\n                  </div>\n                  <div style={{ color: 'var(--text-secondary, #cbd5e1)' }}>{issue.message}</div>\n                  {issue.suggestion && (\n                    <div style={{ color: 'var(--text-muted)', marginTop: 2, fontStyle: 'italic' }}>💡 {issue.suggestion}</div>\n                  )}\n                  {issue.irsRef && (\n                    <div style={{ color: 'var(--text-muted)', marginTop: 2, fontSize: 10 }}>📎 {issue.irsRef}</div>\n                  )}\n                </div>\n              ))}\n              {validation.issues.length > 20 && (\n                <div style={{ textAlign: 'center', fontSize: 11, color: 'var(--text-muted)', padding: 8 }}>\n                  ...and {validation.issues.length - 20} more\n                </div>\n              )}\n            </div>\n          )}\n\n          {/* Storage breakdown */}\n          <div style={{ marginTop: 16, borderTop: '1px solid var(--border-subtle)', paddingTop: 12 }}>\n            <div style={{ fontSize: 11, fontWeight: 600, color: 'var(--text-secondary)', marginBottom: 8 }}>Storage Breakdown</div>\n            <div style={{ height: 6, borderRadius: 3, background: 'rgba(255,255,255,0.06)', overflow: 'hidden', marginBottom: 8 }}>\n              <div style={{\n                height: '100%', borderRadius: 3,\n                width: `${Math.min(quota.usagePct, 100)}%`,\n                background: quota.isCritical ? '#ef4444' : quota.isWarning ? '#f59e0b' : 'var(--accent-gold, #f59e0b)',\n                transition: 'width 0.3s ease',\n              }} />\n            </div>\n            {quota.breakdown.slice(0, 5).map((item, i) => (\n              <div key={i} style={{ display: 'flex', justifyContent: 'space-between', fontSize: 10, color: 'var(--text-muted)', padding: '1px 0' }}>\n                <span style={{ fontFamily: 'var(--font-mono)' }}>{item.key}</span>\n                <span>{item.sizeKB} KB</span>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n    </>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\SessionDigestBar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useFortuna' is defined but never used.","line":2,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":20,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"useFortuna"},"fix":{"range":[44,93],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DigestItem' is defined but never used.","line":4,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":25,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DigestItem"},"fix":{"range":[145,156],"text":""},"desc":"Remove unused variable \"DigestItem\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ArrowUpRight' is defined but never used.","line":6,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":32,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ArrowUpRight"},"fix":{"range":[231,245],"text":""},"desc":"Remove unused variable \"ArrowUpRight\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ArrowDownRight' is defined but never used.","line":6,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":48,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ArrowDownRight"},"fix":{"range":[245,261],"text":""},"desc":"Remove unused variable \"ArrowDownRight\"."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport type { ViewKey } from '../App'\nimport type { DigestItem, SessionDigest } from '../engine/session-digest'\nimport {\n  ChevronRight, X, ArrowUpRight, ArrowDownRight,\n  Sparkles, TrendingUp, AlertTriangle, Target, Trophy,\n  Zap, Clock,\n} from 'lucide-react'\n\ninterface SessionDigestBarProps {\n  digest: SessionDigest\n  onNavigate: (view: ViewKey) => void\n  onDismiss: () => void\n}\n\nconst typeIcons: Record<string, React.ReactNode> = {\n  positive: <TrendingUp size={14} />,\n  negative: <AlertTriangle size={14} />,\n  action: <Target size={14} />,\n  milestone: <Trophy size={14} />,\n  neutral: <Zap size={14} />,\n}\n\nconst typeColors: Record<string, string> = {\n  positive: 'var(--accent-emerald)',\n  negative: 'var(--accent-red)',\n  action: 'var(--accent-gold)',\n  milestone: 'var(--accent-purple)',\n  neutral: 'var(--text-secondary)',\n}\n\nexport function SessionDigestBar({ digest, onNavigate, onDismiss }: SessionDigestBarProps) {\n  const [expanded, setExpanded] = useState(false)\n  const [revealed, setRevealed] = useState(0)\n\n  // Stagger reveal animation\n  useEffect(() => {\n    if (expanded && revealed < digest.items.length) {\n      const timer = setTimeout(() => setRevealed(r => r + 1), 120)\n      return () => clearTimeout(timer)\n    }\n  }, [expanded, revealed, digest.items.length])\n\n  if (digest.items.length === 0) return null\n\n  const topItems = digest.items.slice(0, 2)\n  const hasMore = digest.items.length > 2\n\n  return (\n    <div style={{\n      marginBottom: 20,\n      borderRadius: 14,\n      border: '1px solid var(--border-glow)',\n      background: 'linear-gradient(135deg, rgba(212,168,67,0.06), rgba(52,211,153,0.03))',\n      overflow: 'hidden',\n      animation: 'digestSlideIn 0.5s var(--ease-out)',\n    }}>\n      {/* Header bar */}\n      <div\n        style={{\n          display: 'flex', alignItems: 'center', gap: 12,\n          padding: '14px 18px',\n          cursor: 'pointer',\n        }}\n        onClick={() => { setExpanded(!expanded); if (!expanded) setRevealed(0) }}\n      >\n        <div style={{\n          width: 32, height: 32, borderRadius: 10, flexShrink: 0,\n          background: 'linear-gradient(135deg, var(--accent-gold), #b8912e)',\n          display: 'flex', alignItems: 'center', justifyContent: 'center',\n          boxShadow: '0 2px 12px rgba(212,168,67,0.2)',\n        }}>\n          <Sparkles size={16} color=\"#0c0e12\" />\n        </div>\n\n        <div style={{ flex: 1, minWidth: 0 }}>\n          <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n            <span style={{ fontSize: 14, fontWeight: 600, color: 'var(--text-primary)' }}>\n              Session Intelligence\n            </span>\n            <span style={{\n              padding: '2px 8px', borderRadius: 6,\n              background: 'var(--accent-gold-dim)', color: 'var(--accent-gold)',\n              fontSize: 10, fontFamily: 'var(--font-mono)', fontWeight: 600,\n            }}>\n              {digest.items.length} update{digest.items.length !== 1 ? 's' : ''}\n            </span>\n            <span style={{ fontSize: 11, color: 'var(--text-muted)', fontFamily: 'var(--font-mono)', display: 'flex', alignItems: 'center', gap: 4 }}>\n              <Clock size={10} /> {digest.timeSinceLastSession} since last visit\n            </span>\n          </div>\n\n          {/* Preview of top items when collapsed */}\n          {!expanded && (\n            <div style={{ fontSize: 12, color: 'var(--text-secondary)', marginTop: 3, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>\n              {topItems.map((item, i) => (\n                <span key={item.id}>\n                  {i > 0 && <span style={{ margin: '0 6px', color: 'var(--text-muted)' }}>·</span>}\n                  <span style={{ color: typeColors[item.type] }}>{item.icon}</span>\n                  {' '}{item.title}\n                </span>\n              ))}\n              {hasMore && <span style={{ color: 'var(--text-muted)' }}> · +{digest.items.length - 2} more</span>}\n            </div>\n          )}\n        </div>\n\n        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n          <ChevronRight\n            size={16}\n            color=\"var(--text-muted)\"\n            style={{\n              transition: 'transform 0.3s var(--ease-out)',\n              transform: expanded ? 'rotate(90deg)' : 'rotate(0deg)',\n            }}\n          />\n          <button\n            onClick={e => { e.stopPropagation(); onDismiss() }}\n            style={{\n              background: 'none', border: 'none', cursor: 'pointer',\n              color: 'var(--text-muted)', padding: 4, borderRadius: 6,\n            }}\n          >\n            <X size={14} />\n          </button>\n        </div>\n      </div>\n\n      {/* Expanded content */}\n      {expanded && (\n        <div style={{\n          padding: '0 18px 16px',\n          borderTop: '1px solid var(--border-subtle)',\n        }}>\n          {digest.items.map((item, i) => (\n            <div\n              key={item.id}\n              style={{\n                display: 'flex', alignItems: 'flex-start', gap: 12,\n                padding: '14px 0',\n                borderBottom: i < digest.items.length - 1 ? '1px solid var(--border-subtle)' : 'none',\n                opacity: i < revealed ? 1 : 0,\n                transform: i < revealed ? 'translateX(0)' : 'translateX(-12px)',\n                transition: 'opacity 0.3s ease-out, transform 0.3s var(--ease-out)',\n              }}\n            >\n              {/* Type indicator */}\n              <div style={{\n                width: 28, height: 28, borderRadius: 8, flexShrink: 0,\n                background: `${typeColors[item.type]}15`,\n                display: 'flex', alignItems: 'center', justifyContent: 'center',\n                color: typeColors[item.type],\n                marginTop: 1,\n              }}>\n                {typeIcons[item.type]}\n              </div>\n\n              <div style={{ flex: 1, minWidth: 0 }}>\n                <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 2 }}>\n                  <span style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)' }}>\n                    {item.icon} {item.title}\n                  </span>\n                </div>\n                <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.5 }}>\n                  {item.detail}\n                </div>\n\n                {/* Metric badge */}\n                {item.metric && (\n                  <div style={{\n                    display: 'inline-flex', alignItems: 'center', gap: 8,\n                    marginTop: 8, padding: '4px 10px', borderRadius: 6,\n                    background: 'var(--bg-surface)', border: '1px solid var(--border-subtle)',\n                    fontSize: 11, fontFamily: 'var(--font-mono)',\n                  }}>\n                    <span style={{ color: 'var(--text-muted)' }}>{item.metric.label}</span>\n                    <span style={{ fontWeight: 600, color: 'var(--text-primary)' }}>{item.metric.value}</span>\n                    {item.metric.change && (\n                      <span style={{\n                        color: item.metric.change.startsWith('-')\n                          ? (item.type === 'positive' ? 'var(--accent-emerald)' : 'var(--accent-red)')\n                          : (item.type === 'positive' ? 'var(--accent-emerald)' : 'var(--accent-red)'),\n                        fontWeight: 600,\n                      }}>\n                        {item.metric.change}\n                      </span>\n                    )}\n                  </div>\n                )}\n              </div>\n\n              {/* Action button */}\n              {item.actionView && (\n                <button\n                  onClick={() => onNavigate(item.actionView as ViewKey)}\n                  style={{\n                    display: 'flex', alignItems: 'center', gap: 4,\n                    background: 'none', border: '1px solid var(--border-subtle)',\n                    borderRadius: 6, padding: '5px 10px', cursor: 'pointer',\n                    fontSize: 11, color: 'var(--text-secondary)',\n                    fontFamily: 'var(--font-body)', whiteSpace: 'nowrap',\n                    transition: 'border-color 0.2s',\n                  }}\n                  onMouseEnter={e => (e.currentTarget.style.borderColor = 'var(--accent-gold)')}\n                  onMouseLeave={e => (e.currentTarget.style.borderColor = 'var(--border-subtle)')}\n                >\n                  {item.actionLabel} <ChevronRight size={11} />\n                </button>\n              )}\n            </div>\n          ))}\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\Sidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\SkeletonLoader.tsx","messages":[{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Math.random` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\SkeletonLoader.tsx:38:38\n  36 |       <Bone width=\"60%\" height={28} radius={8} style={{ marginBottom: 16 }} />\n  37 |       {Array.from({ length: lines }, (_, i) => (\n> 38 |         <Bone key={i} width={`${70 + Math.random() * 25}%`} height={10} style={{ marginBottom: 8 }} />\n     |                                      ^^^^^^^^^^^^^ Cannot call impure function\n  39 |       ))}\n  40 |     </div>\n  41 |   )","line":38,"column":38,"nodeType":null,"endLine":38,"endColumn":51},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Math.random` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\SkeletonLoader.tsx:90:43\n  88 |       {Array.from({ length: 8 }, (_, i) => (\n  89 |         <div key={i} style={{ flex: 1 }}>\n> 90 |           <Bone width=\"100%\" height={30 + Math.random() * (height - 80)} radius={4} />\n     |                                           ^^^^^^^^^^^^^ Cannot call impure function\n  91 |         </div>\n  92 |       ))}\n  93 |     </div>","line":90,"column":43,"nodeType":null,"endLine":90,"endColumn":56}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE — Skeleton Loading Components\n * Shimmer placeholders for every view type during data loading.\n */\n\nimport { type CSSProperties } from 'react'\n\n// ─── Base Skeleton ──────────────────────────────────────────────────\n\nfunction Bone({ width, height = 14, radius = 6, style }: {\n  width: string | number; height?: number; radius?: number; style?: CSSProperties\n}) {\n  return (\n    <div\n      aria-hidden=\"true\"\n      style={{\n        width, height, borderRadius: radius,\n        background: 'linear-gradient(90deg, var(--bg-surface) 25%, var(--bg-hover) 50%, var(--bg-surface) 75%)',\n        backgroundSize: '200% 100%',\n        animation: 'shimmer 1.5s ease-in-out infinite',\n        ...style,\n      }}\n    />\n  )\n}\n\n// ─── Skeleton Patterns ──────────────────────────────────────────────\n\nexport function SkeletonCard({ lines = 3 }: { lines?: number }) {\n  return (\n    <div style={{\n      padding: 20, borderRadius: 14, background: 'var(--bg-elevated)',\n      border: '1px solid var(--border-subtle)',\n    }}>\n      <Bone width=\"40%\" height={12} style={{ marginBottom: 14 }} />\n      <Bone width=\"60%\" height={28} radius={8} style={{ marginBottom: 16 }} />\n      {Array.from({ length: lines }, (_, i) => (\n        <Bone key={i} width={`${70 + Math.random() * 25}%`} height={10} style={{ marginBottom: 8 }} />\n      ))}\n    </div>\n  )\n}\n\nexport function SkeletonKPI() {\n  return (\n    <div style={{\n      padding: 20, borderRadius: 14, background: 'var(--bg-elevated)',\n      border: '1px solid var(--border-subtle)',\n    }}>\n      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 12 }}>\n        <Bone width={80} height={10} />\n        <Bone width={24} height={24} radius={6} />\n      </div>\n      <Bone width={120} height={32} radius={8} style={{ marginBottom: 8 }} />\n      <Bone width={90} height={10} />\n    </div>\n  )\n}\n\nexport function SkeletonTable({ rows = 5, cols = 4 }: { rows?: number; cols?: number }) {\n  return (\n    <div style={{ borderRadius: 14, overflow: 'hidden', border: '1px solid var(--border-subtle)' }}>\n      {/* Header */}\n      <div style={{ display: 'flex', gap: 12, padding: '14px 16px', background: 'var(--bg-elevated)' }}>\n        {Array.from({ length: cols }, (_, i) => (\n          <Bone key={i} width={`${100 / cols}%`} height={10} />\n        ))}\n      </div>\n      {/* Rows */}\n      {Array.from({ length: rows }, (_, r) => (\n        <div key={r} style={{ display: 'flex', gap: 12, padding: '12px 16px', borderTop: '1px solid var(--border-subtle)' }}>\n          {Array.from({ length: cols }, (_, c) => (\n            <Bone key={c} width={`${60 + Math.random() * 35}%`} height={10} />\n          ))}\n        </div>\n      ))}\n    </div>\n  )\n}\n\nexport function SkeletonChart({ height = 200 }: { height?: number }) {\n  return (\n    <div style={{\n      height, borderRadius: 14, background: 'var(--bg-elevated)',\n      border: '1px solid var(--border-subtle)',\n      display: 'flex', alignItems: 'flex-end', gap: 8, padding: '20px 20px 20px',\n    }}>\n      {Array.from({ length: 8 }, (_, i) => (\n        <div key={i} style={{ flex: 1 }}>\n          <Bone width=\"100%\" height={30 + Math.random() * (height - 80)} radius={4} />\n        </div>\n      ))}\n    </div>\n  )\n}\n\n// ─── Dashboard Skeleton ─────────────────────────────────────────────\n\nexport function SkeletonDashboard() {\n  return (\n    <div role=\"status\" aria-label=\"Loading dashboard\" style={{ padding: 4 }}>\n      <span className=\"sr-only\">Loading dashboard...</span>\n      {/* KPI row */}\n      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 14, marginBottom: 20 }}>\n        <SkeletonKPI /><SkeletonKPI /><SkeletonKPI /><SkeletonKPI />\n      </div>\n      {/* Content */}\n      <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: 14 }}>\n        <SkeletonChart height={240} />\n        <SkeletonCard lines={5} />\n      </div>\n      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 14, marginTop: 14 }}>\n        <SkeletonCard lines={4} />\n        <SkeletonCard lines={4} />\n      </div>\n    </div>\n  )\n}\n\n// ─── Generic View Skeleton ──────────────────────────────────────────\n\nexport function SkeletonView({ type = 'cards' }: { type?: 'cards' | 'table' | 'detail' }) {\n  return (\n    <div role=\"status\" aria-label=\"Loading content\" style={{ padding: 4 }}>\n      <span className=\"sr-only\">Loading...</span>\n      {/* Header */}\n      <div style={{ marginBottom: 24 }}>\n        <Bone width={200} height={24} radius={8} style={{ marginBottom: 10 }} />\n        <Bone width={340} height={12} />\n      </div>\n\n      {type === 'cards' && (\n        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 14 }}>\n          <SkeletonCard /><SkeletonCard /><SkeletonCard />\n          <SkeletonCard lines={2} /><SkeletonCard lines={2} /><SkeletonCard lines={2} />\n        </div>\n      )}\n\n      {type === 'table' && <SkeletonTable rows={8} cols={5} />}\n\n      {type === 'detail' && (\n        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 14 }}>\n          <div>\n            <SkeletonCard lines={6} />\n            <div style={{ marginTop: 14 }}><SkeletonChart /></div>\n          </div>\n          <div>\n            <SkeletonCard lines={8} />\n          </div>\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\SyncStatusBar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ToastSystem.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":23,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":23,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'index' is defined but never used.","line":72,"column":39,"nodeType":"Identifier","messageId":"unusedVar","endLine":72,"endColumn":44}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback, createContext, useContext, type ReactNode } from 'react'\nimport {\n  CheckCircle2, AlertTriangle, Info, XCircle, X,\n} from 'lucide-react'\n\nexport interface Toast {\n  id: string\n  type: 'success' | 'warning' | 'error' | 'info'\n  title: string\n  message?: string\n  duration?: number // ms, 0 = persistent\n  actionLabel?: string\n  onAction?: () => void\n}\n\ninterface ToastContextType {\n  addToast: (toast: Omit<Toast, 'id'>) => void\n  removeToast: (id: string) => void\n}\n\nconst ToastContext = createContext<ToastContextType | null>(null)\n\nexport function useToasts() {\n  const ctx = useContext(ToastContext)\n  if (!ctx) throw new Error('useToasts must be used within ToastProvider')\n  return ctx\n}\n\nlet toastCounter = 0\n\nexport function ToastProvider({ children }: { children: ReactNode }) {\n  const [toasts, setToasts] = useState<Toast[]>([])\n\n  const addToast = useCallback((toast: Omit<Toast, 'id'>) => {\n    const id = `toast-${++toastCounter}-${Date.now()}`\n    setToasts(prev => [...prev.slice(-4), { ...toast, id }]) // max 5\n  }, [])\n\n  const removeToast = useCallback((id: string) => {\n    setToasts(prev => prev.filter(t => t.id !== id))\n  }, [])\n\n  return (\n    <ToastContext.Provider value={{ addToast, removeToast }}>\n      {children}\n      <ToastContainer toasts={toasts} onRemove={removeToast} />\n    </ToastContext.Provider>\n  )\n}\n\nfunction ToastContainer({ toasts, onRemove }: { toasts: Toast[]; onRemove: (id: string) => void }) {\n  return (\n    <div style={{\n      position: 'fixed', bottom: 20, right: 20, zIndex: 9997,\n      display: 'flex', flexDirection: 'column-reverse', gap: 8,\n      pointerEvents: 'none', maxWidth: 380,\n    }}>\n      {toasts.map((toast, i) => (\n        <ToastItem key={toast.id} toast={toast} onRemove={onRemove} index={i} />\n      ))}\n    </div>\n  )\n}\n\nconst typeConfig = {\n  success: { icon: <CheckCircle2 size={16} />, color: 'var(--accent-emerald)', bg: 'rgba(52,211,153,0.08)', border: 'rgba(52,211,153,0.2)' },\n  warning: { icon: <AlertTriangle size={16} />, color: 'var(--accent-amber)', bg: 'rgba(251,191,36,0.08)', border: 'rgba(251,191,36,0.2)' },\n  error:   { icon: <XCircle size={16} />, color: 'var(--accent-red)', bg: 'rgba(239,107,107,0.08)', border: 'rgba(239,107,107,0.2)' },\n  info:    { icon: <Info size={16} />, color: 'var(--accent-blue)', bg: 'rgba(96,165,250,0.08)', border: 'rgba(96,165,250,0.2)' },\n}\n\nfunction ToastItem({ toast, onRemove, index }: { toast: Toast; onRemove: (id: string) => void; index: number }) {\n  const [exiting, setExiting] = useState(false)\n  const [progress, setProgress] = useState(100)\n  const duration = toast.duration ?? 4000\n  const config = typeConfig[toast.type]\n\n  useEffect(() => {\n    if (duration <= 0) return\n    const interval = 50\n    let elapsed = 0\n    const timer = setInterval(() => {\n      elapsed += interval\n      setProgress(Math.max(0, 100 - (elapsed / duration) * 100))\n      if (elapsed >= duration) {\n        clearInterval(timer)\n        setExiting(true)\n        setTimeout(() => onRemove(toast.id), 300)\n      }\n    }, interval)\n    return () => clearInterval(timer)\n  }, [duration, toast.id, onRemove])\n\n  const dismiss = () => {\n    setExiting(true)\n    setTimeout(() => onRemove(toast.id), 300)\n  }\n\n  return (\n    <div style={{\n      pointerEvents: 'auto',\n      background: 'var(--bg-elevated)',\n      border: `1px solid ${config.border}`,\n      borderRadius: 12,\n      padding: '12px 14px',\n      boxShadow: `0 8px 32px rgba(0,0,0,0.3), inset 0 1px 0 ${config.bg}`,\n      backdropFilter: 'blur(12px)',\n      display: 'flex', alignItems: 'flex-start', gap: 10,\n      opacity: exiting ? 0 : 1,\n      transform: exiting ? 'translateX(40px) scale(0.95)' : 'translateX(0) scale(1)',\n      animation: 'toastSlideIn 0.3s var(--ease-spring)',\n      transition: 'opacity 0.3s ease-out, transform 0.3s var(--ease-out)',\n      position: 'relative',\n      overflow: 'hidden',\n    }}>\n      {/* Icon */}\n      <div style={{ color: config.color, flexShrink: 0, marginTop: 1 }}>\n        {config.icon}\n      </div>\n\n      {/* Content */}\n      <div style={{ flex: 1, minWidth: 0 }}>\n        <div style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)', lineHeight: 1.3 }}>{toast.title}</div>\n        {toast.message && (\n          <div style={{ fontSize: 12, color: 'var(--text-secondary)', marginTop: 2, lineHeight: 1.4 }}>{toast.message}</div>\n        )}\n        {toast.actionLabel && toast.onAction && (\n          <button\n            onClick={() => { toast.onAction!(); dismiss() }}\n            style={{\n              marginTop: 6, padding: '3px 8px', borderRadius: 5,\n              background: `${config.color}20`, border: `1px solid ${config.color}40`,\n              color: config.color, fontSize: 11, fontWeight: 500,\n              cursor: 'pointer', fontFamily: 'var(--font-body)',\n            }}\n          >\n            {toast.actionLabel}\n          </button>\n        )}\n      </div>\n\n      {/* Dismiss */}\n      <button\n        onClick={dismiss}\n        style={{\n          background: 'none', border: 'none', cursor: 'pointer',\n          color: 'var(--text-muted)', padding: 2, flexShrink: 0,\n          borderRadius: 4,\n        }}\n      >\n        <X size={13} />\n      </button>\n\n      {/* Progress bar */}\n      {duration > 0 && (\n        <div style={{\n          position: 'absolute', bottom: 0, left: 0, right: 0, height: 2,\n          background: 'rgba(255,255,255,0.03)',\n        }}>\n          <div style={{\n            height: '100%', background: config.color, opacity: 0.5,\n            width: `${progress}%`,\n            transition: 'width 50ms linear',\n          }} />\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\UXPreferences.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ChevronDown' is defined but never used.","line":11,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":56,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ChevronDown"},"fix":{"range":[386,399],"text":""},"desc":"Remove unused variable \"ChevronDown\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE — UX Preferences Panel (Phase 2 UX Fix)\n *\n * Floating settings gear that opens a quick preferences panel.\n * Toggle: Friendly/Technical labels, Simple/Standard/Expert nav,\n * and other UX preferences without leaving the current view.\n */\n\nimport { useState } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { Settings, X, MessageCircle, Code2, ChevronDown } from 'lucide-react'\n\nexport function UXPreferencesToggle() {\n  const [open, setOpen] = useState(false)\n  const { uxPrefs, updateUXPrefs } = useFortuna()\n  const isFriendly = uxPrefs.friendlyLabels !== false\n\n  return (\n    <>\n      {/* Floating gear button — desktop only */}\n      <button\n        onClick={() => setOpen(!open)}\n        className=\"hide-mobile hide-print\"\n        aria-label=\"UX Preferences\"\n        aria-expanded={open}\n        style={{\n          position: 'fixed', bottom: 16, right: 16, zIndex: 90,\n          width: 40, height: 40, borderRadius: 12,\n          background: 'var(--bg-elevated)',\n          border: '1px solid var(--border-subtle)',\n          display: 'flex', alignItems: 'center', justifyContent: 'center',\n          cursor: 'pointer', color: 'var(--text-muted)',\n          transition: 'all 0.2s',\n          boxShadow: '0 2px 12px rgba(0,0,0,0.2)',\n        }}\n        onMouseEnter={e => {\n          e.currentTarget.style.color = 'var(--accent-gold)'\n          e.currentTarget.style.borderColor = 'var(--accent-gold)'\n        }}\n        onMouseLeave={e => {\n          e.currentTarget.style.color = 'var(--text-muted)'\n          e.currentTarget.style.borderColor = 'var(--border-subtle)'\n        }}\n      >\n        <Settings size={18} />\n      </button>\n\n      {/* Preferences panel */}\n      {open && (\n        <div style={{\n          position: 'fixed', bottom: 64, right: 16, zIndex: 91,\n          width: 280, borderRadius: 14,\n          background: 'var(--bg-elevated)',\n          border: '1px solid var(--border-subtle)',\n          boxShadow: '0 12px 40px rgba(0,0,0,0.4)',\n          animation: 'fadeInDown 0.2s ease-out',\n          overflow: 'hidden',\n        }}\n        className=\"hide-print\"\n        >\n          {/* Header */}\n          <div style={{\n            display: 'flex', justifyContent: 'space-between', alignItems: 'center',\n            padding: '14px 16px', borderBottom: '1px solid var(--border-subtle)',\n          }}>\n            <span style={{ fontSize: 14, fontWeight: 500, color: 'var(--text-primary)' }}>\n              Display Preferences\n            </span>\n            <button onClick={() => setOpen(false)} style={{\n              background: 'none', border: 'none', cursor: 'pointer',\n              color: 'var(--text-muted)', padding: 2,\n            }} aria-label=\"Close preferences\">\n              <X size={16} />\n            </button>\n          </div>\n\n          <div style={{ padding: '12px 16px', display: 'flex', flexDirection: 'column', gap: 14 }}>\n            {/* Label mode toggle */}\n            <div>\n              <div style={{ fontSize: 11, color: 'var(--text-muted)', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.08em', marginBottom: 8 }}>\n                Language Style\n              </div>\n              <div style={{ display: 'flex', gap: 4, background: 'var(--bg-surface)', borderRadius: 8, padding: 3 }}>\n                <button\n                  onClick={() => updateUXPrefs({ friendlyLabels: true })}\n                  style={{\n                    flex: 1, padding: '6px 8px', borderRadius: 6, border: 'none',\n                    background: isFriendly ? 'var(--accent-gold-dim)' : 'transparent',\n                    color: isFriendly ? 'var(--accent-gold)' : 'var(--text-muted)',\n                    cursor: 'pointer', fontSize: 12, fontWeight: 500,\n                    display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 5,\n                    transition: 'all 0.2s',\n                  }}\n                >\n                  <MessageCircle size={13} />\n                  Friendly\n                </button>\n                <button\n                  onClick={() => updateUXPrefs({ friendlyLabels: false })}\n                  style={{\n                    flex: 1, padding: '6px 8px', borderRadius: 6, border: 'none',\n                    background: !isFriendly ? 'var(--accent-gold-dim)' : 'transparent',\n                    color: !isFriendly ? 'var(--accent-gold)' : 'var(--text-muted)',\n                    cursor: 'pointer', fontSize: 12, fontWeight: 500,\n                    display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 5,\n                    transition: 'all 0.2s',\n                  }}\n                >\n                  <Code2 size={13} />\n                  Technical\n                </button>\n              </div>\n              <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 6, lineHeight: 1.4 }}>\n                {isFriendly\n                  ? '\"Find Deductions\" • \"Paycheck Planner\" • \"Send to Accountant\"'\n                  : '\"Deduction Discovery Engine\" • \"Paycheck Simulator\" • \"CPA Export Package\"'}\n              </div>\n            </div>\n\n            {/* Keyboard shortcuts hint */}\n            <div style={{\n              padding: '8px 10px', borderRadius: 8,\n              background: 'var(--bg-surface)', fontSize: 11, color: 'var(--text-muted)',\n              lineHeight: 1.5,\n            }}>\n              <div style={{ fontWeight: 500, marginBottom: 4, color: 'var(--text-secondary)' }}>Keyboard Shortcuts</div>\n              <div style={{ display: 'flex', justifyContent: 'space-between' }}>\n                <span>Search</span>\n                <kbd style={{ fontFamily: 'var(--font-mono)', fontSize: 10, background: 'var(--bg-hover)', padding: '1px 5px', borderRadius: 3 }}>⌘K</kbd>\n              </div>\n              <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: 3 }}>\n                <span>Undo</span>\n                <kbd style={{ fontFamily: 'var(--font-mono)', fontSize: 10, background: 'var(--bg-hover)', padding: '1px 5px', borderRadius: 3 }}>⌘Z</kbd>\n              </div>\n              <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: 3 }}>\n                <span>Redo</span>\n                <kbd style={{ fontFamily: 'var(--font-mono)', fontSize: 10, background: 'var(--bg-hover)', padding: '1px 5px', borderRadius: 3 }}>⇧⌘Z</kbd>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n    </>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ValidatedInput.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ReactNode' is defined but never used.","line":6,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":54,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ReactNode"},"fix":{"range":[166,182],"text":""},"desc":"Remove unused variable \"ReactNode\"."}]},{"ruleId":"react-hooks/preserve-manual-memoization","severity":2,"message":"Compilation Skipped: Existing memoization could not be preserved\n\nReact Compiler has skipped optimizing this component because the existing manual memoization could not be preserved. The inferred dependencies did not match the manually specified dependencies, which could cause the value to change more or less frequently than expected. The inferred dependency was `setTouched`, but the source dependencies were [onBlur]. Inferred different dependency than source.\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ValidatedInput.tsx:143:34\n  141 |   }, [type, onChange])\n  142 |\n> 143 |   const handleBlur = useCallback(() => {\n      |                                  ^^^^^^^\n> 144 |     setTouched(true)\n      | ^^^^^^^^^^^^^^^^^^^^\n> 145 |     onBlur?.()\n      | ^^^^^^^^^^^^^^^^^^^^\n> 146 |   }, [onBlur])\n      | ^^^^ Could not preserve existing manual memoization\n  147 |\n  148 |   const inputType = ['currency', 'percentage', 'ein', 'ssn'].includes(type) ? 'text'\n  149 |     : type === 'number' ? 'text' : type","line":143,"column":34,"nodeType":null,"endLine":146,"endColumn":4}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE — Validated Input Components\n * Form inputs with real-time validation, formatting, and accessibility.\n */\n\nimport { useState, useCallback, useId, type ReactNode, type ChangeEvent } from 'react'\nimport { AlertCircle, Check, HelpCircle } from 'lucide-react'\n\n// ─── Types ──────────────────────────────────────────────────────────\n\ntype ValidationRule = {\n  test: (value: string) => boolean\n  message: string\n}\n\ninterface ValidatedInputProps {\n  label: string\n  value: string\n  onChange: (value: string) => void\n  type?: 'text' | 'number' | 'email' | 'tel' | 'password' | 'currency' | 'percentage' | 'date' | 'ein' | 'ssn'\n  placeholder?: string\n  required?: boolean\n  disabled?: boolean\n  helpText?: string\n  validationRules?: ValidationRule[]\n  min?: number\n  max?: number\n  prefix?: string\n  suffix?: string\n  autoFocus?: boolean\n  onBlur?: () => void\n}\n\n// ─── Format Helpers ─────────────────────────────────────────────────\n\nfunction formatCurrency(val: string): string {\n  const num = val.replace(/[^0-9.]/g, '')\n  const parts = num.split('.')\n  if (parts.length > 2) return formatCurrency(parts[0] + '.' + parts.slice(1).join(''))\n  if (parts[0]) {\n    parts[0] = parseInt(parts[0]).toLocaleString()\n  }\n  if (parts[1] !== undefined) {\n    parts[1] = parts[1].slice(0, 2)\n    return parts.join('.')\n  }\n  return parts[0] || ''\n}\n\nfunction parseCurrency(val: string): string {\n  return val.replace(/[^0-9.]/g, '')\n}\n\nfunction formatPercentage(val: string): string {\n  return val.replace(/[^0-9.]/g, '').slice(0, 6)\n}\n\nfunction formatEIN(val: string): string {\n  const digits = val.replace(/\\D/g, '').slice(0, 9)\n  if (digits.length > 2) return digits.slice(0, 2) + '-' + digits.slice(2)\n  return digits\n}\n\nfunction formatSSN(val: string): string {\n  const digits = val.replace(/\\D/g, '').slice(0, 9)\n  if (digits.length > 5) return digits.slice(0, 3) + '-' + digits.slice(3, 5) + '-' + digits.slice(5)\n  if (digits.length > 3) return digits.slice(0, 3) + '-' + digits.slice(3)\n  return digits\n}\n\nfunction formatPhone(val: string): string {\n  const digits = val.replace(/\\D/g, '').slice(0, 10)\n  if (digits.length > 6) return '(' + digits.slice(0, 3) + ') ' + digits.slice(3, 6) + '-' + digits.slice(6)\n  if (digits.length > 3) return '(' + digits.slice(0, 3) + ') ' + digits.slice(3)\n  return digits\n}\n\n// ─── Built-in Validations ───────────────────────────────────────────\n\nfunction getBuiltinRules(type: string, required?: boolean, min?: number, max?: number): ValidationRule[] {\n  const rules: ValidationRule[] = []\n\n  if (required) {\n    rules.push({ test: v => v.trim().length > 0, message: 'This field is required' })\n  }\n\n  switch (type) {\n    case 'email':\n      rules.push({ test: v => !v || /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(v), message: 'Enter a valid email address' })\n      break\n    case 'currency':\n      if (min !== undefined) rules.push({ test: v => !v || parseFloat(parseCurrency(v)) >= min, message: `Minimum: $${min.toLocaleString()}` })\n      if (max !== undefined) rules.push({ test: v => !v || parseFloat(parseCurrency(v)) <= max, message: `Maximum: $${max.toLocaleString()}` })\n      break\n    case 'percentage':\n      rules.push({ test: v => !v || (parseFloat(v) >= 0 && parseFloat(v) <= 100), message: 'Enter a value between 0 and 100' })\n      break\n    case 'ein':\n      rules.push({ test: v => !v || v.replace(/\\D/g, '').length === 9, message: 'EIN must be 9 digits (XX-XXXXXXX)' })\n      break\n    case 'ssn':\n      rules.push({ test: v => !v || v.replace(/\\D/g, '').length === 9, message: 'SSN must be 9 digits (XXX-XX-XXXX)' })\n      break\n    case 'tel':\n      rules.push({ test: v => !v || v.replace(/\\D/g, '').length === 10, message: 'Enter a 10-digit phone number' })\n      break\n  }\n\n  return rules\n}\n\n// ─── Component ──────────────────────────────────────────────────────\n\nexport function ValidatedInput({\n  label, value, onChange, type = 'text', placeholder, required, disabled,\n  helpText, validationRules = [], min, max, prefix, suffix, autoFocus, onBlur,\n}: ValidatedInputProps) {\n  const [touched, setTouched] = useState(false)\n  const [showHelp, setShowHelp] = useState(false)\n  const uid = useId()\n  const inputId = `input-${uid}`\n  const errorId = `error-${uid}`\n  const helpId = `help-${uid}`\n\n  const allRules = [...getBuiltinRules(type, required, min, max), ...validationRules]\n\n  const errors = touched ? allRules.filter(r => !r.test(value)).map(r => r.message) : []\n  const isValid = touched && value.length > 0 && errors.length === 0\n  const isError = touched && errors.length > 0\n\n  const handleChange = useCallback((e: ChangeEvent<HTMLInputElement>) => {\n    let val = e.target.value\n    switch (type) {\n      case 'currency': val = formatCurrency(val); break\n      case 'percentage': val = formatPercentage(val); break\n      case 'ein': val = formatEIN(val); break\n      case 'ssn': val = formatSSN(val); break\n      case 'tel': val = formatPhone(val); break\n    }\n    onChange(val)\n  }, [type, onChange])\n\n  const handleBlur = useCallback(() => {\n    setTouched(true)\n    onBlur?.()\n  }, [onBlur])\n\n  const inputType = ['currency', 'percentage', 'ein', 'ssn'].includes(type) ? 'text'\n    : type === 'number' ? 'text' : type\n\n  const inputMode = ['currency', 'number', 'percentage'].includes(type) ? 'decimal' as const\n    : ['ein', 'ssn', 'tel'].includes(type) ? 'numeric' as const\n    : undefined\n\n  return (\n    <div className=\"form-field\">\n      <label className=\"form-label\" htmlFor={inputId}>\n        {label}\n        {required && <span className=\"required\" aria-hidden=\"true\">*</span>}\n        {helpText && (\n          <button\n            type=\"button\"\n            onClick={() => setShowHelp(!showHelp)}\n            style={{\n              background: 'none', border: 'none', cursor: 'pointer',\n              padding: 2, display: 'flex', color: 'var(--text-muted)',\n            }}\n            aria-label={`Help for ${label}`}\n            aria-expanded={showHelp}\n            aria-controls={helpId}\n          >\n            <HelpCircle size={14} />\n          </button>\n        )}\n      </label>\n\n      {showHelp && helpText && (\n        <div id={helpId} className=\"form-helper\" role=\"note\">{helpText}</div>\n      )}\n\n      <div style={{ position: 'relative', display: 'flex', alignItems: 'center' }}>\n        {prefix && (\n          <span style={{\n            position: 'absolute', left: 14, color: 'var(--text-muted)',\n            fontSize: 14, pointerEvents: 'none', zIndex: 1,\n          }}>{prefix}</span>\n        )}\n\n        <input\n          id={inputId}\n          type={inputType}\n          inputMode={inputMode}\n          value={value}\n          onChange={handleChange}\n          onBlur={handleBlur}\n          placeholder={placeholder}\n          disabled={disabled}\n          autoFocus={autoFocus}\n          required={required}\n          aria-required={required}\n          aria-invalid={isError}\n          aria-describedby={isError ? errorId : helpText ? helpId : undefined}\n          className={`form-input ${isError ? 'error' : ''} ${isValid ? 'valid' : ''}`}\n          style={{\n            flex: 1,\n            paddingLeft: prefix ? 32 : 14,\n            paddingRight: suffix || isValid || isError ? 36 : 14,\n          }}\n        />\n\n        {/* Status icon */}\n        {(isValid || isError) && (\n          <span style={{\n            position: 'absolute', right: 12,\n            display: 'flex', pointerEvents: 'none',\n          }}>\n            {isValid && <Check size={16} color=\"var(--accent-emerald)\" />}\n            {isError && <AlertCircle size={16} color=\"var(--accent-red)\" />}\n          </span>\n        )}\n\n        {suffix && !isValid && !isError && (\n          <span style={{\n            position: 'absolute', right: 14, color: 'var(--text-muted)',\n            fontSize: 13, pointerEvents: 'none',\n          }}>{suffix}</span>\n        )}\n      </div>\n\n      {isError && (\n        <div id={errorId} className=\"form-error\" role=\"alert\">\n          <AlertCircle size={12} />\n          {errors[0]}\n        </div>\n      )}\n    </div>\n  )\n}\n\n// ─── Currency Shorthand ─────────────────────────────────────────────\n\nexport function CurrencyInput(props: Omit<ValidatedInputProps, 'type' | 'prefix'>) {\n  return <ValidatedInput {...props} type=\"currency\" prefix=\"$\" />\n}\n\nexport function PercentInput(props: Omit<ValidatedInputProps, 'type' | 'suffix'>) {\n  return <ValidatedInput {...props} type=\"percentage\" suffix=\"%\" />\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ViewShell.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'hasDeductions' is assigned a value but never used.","line":41,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":41,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'hasPayments' is assigned a value but never used.","line":46,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":46,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'hasBankTxns' is assigned a value but never used.","line":48,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":48,"endColumn":20}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — View Shell\n *\n * Universal wrapper for all views that provides:\n *   1. EmptyState detection — shows actionable empty state when view has no data\n *   2. Loading skeleton — shows shimmer while lazy components load\n *   3. Consistent layout wrapper\n *\n * Wired once in App.tsx around renderView(), eliminating the need\n * to modify each of the 42 individual view files.\n *\n * @module ViewShell\n */\n\nimport { type ReactNode, Suspense } from 'react'\nimport type { ViewKey } from '../App'\nimport type { FortunaState } from '../engine/storage'\nimport { EmptyState } from './EmptyState'\nimport { SkeletonDashboard } from './SkeletonLoader'\nimport { ErrorBoundary } from './ErrorBoundary'\n\ninterface ViewShellProps {\n  view: ViewKey\n  state: FortunaState\n  onNavigate: (view: ViewKey) => void\n  children: ReactNode\n}\n\n/**\n * Determine if a view has enough data to render meaningfully.\n * Returns false → EmptyState is shown instead of the view.\n *\n * Logic is intentionally generous: a view shows content if ANY\n * related data exists. We'd rather show partial content than\n * block the user with an empty state unnecessarily.\n */\nfunction viewHasData(view: ViewKey, state: FortunaState): boolean {\n  const hasIncome = (state.incomeStreams?.length || 0) > 0\n  const hasExpenses = (state.expenses?.length || 0) > 0\n  const hasEntities = (state.entities?.length || 0) > 0\n  const hasDeductions = (state.deductions?.length || 0) > 0\n  const hasInvestments = (state.investments?.length || 0) > 0\n  const hasRetirement = (state.retirementAccounts?.length || 0) > 0\n  const hasGoals = (state.goals?.length || 0) > 0\n  const hasDocuments = (state.documents?.length || 0) > 0\n  const hasPayments = (state.estimatedPayments?.length || 0) > 0\n  const hasDepreciation = (state.depreciationAssets?.length || 0) > 0\n  const hasBankTxns = (state.bankTransactions?.length || 0) > 0\n  const hasProfile = !!(state.profile?.filingStatus)\n  const hasAny = hasIncome || hasExpenses || hasEntities\n\n  switch (view) {\n    // Always show — these are entry points or always useful\n    case 'dashboard': return true    // Dashboard shows empty state internally\n    case 'setup': return true        // Data entry — always accessible\n    case 'data': return true         // Data management — always accessible\n    case 'import': return true       // Import — always accessible\n    case 'quickbooks': return true   // QB import — always accessible\n    case 'advisor': return true      // AI advisor works even without data\n    case 'workspace': return true    // Settings\n    case 'settings': return true\n    case 'alerts': return true       // Notifications\n    case 'calendar': return true     // Calendar always shows dates\n\n    // Need profile\n    case 'tax': return hasProfile && hasIncome\n    case 'scenarios': return hasProfile && hasIncome\n    case 'cashflow': return hasProfile && hasIncome\n    case 'multiyear': return hasProfile && hasIncome\n    case 'marginal': return hasProfile && hasIncome\n    case 'taxprep': return hasProfile && hasIncome\n    case 'taxdocs': return hasProfile && hasIncome\n    case 'cpa': return hasProfile && hasIncome\n    case 'reports': return hasProfile && hasAny\n    case 'paycheck': return hasProfile && hasIncome\n    case 'health': return hasProfile && hasAny\n    case 'deductions': return hasProfile\n    case 'credits': return hasProfile\n\n    // Need entities\n    case 'entity': return hasEntities\n    case 'flow': return hasEntities\n    case 'optimizer': return hasEntities\n    case 'nexus': return hasEntities\n\n    // Need specific data\n    case 'revenue': return hasIncome\n    case 'pnl': return hasIncome || hasExpenses\n    case 'risk': return hasAny\n    case 'audit': return hasAny\n    case 'depreciation': return hasDepreciation || hasEntities\n    case 'portfolio': return hasInvestments\n    case 'retirement': return hasRetirement\n    case 'goals': return hasGoals\n    case 'history': return hasAny\n    case 'documents': return hasDocuments || hasAny\n    case 'arbitrage': return hasIncome && hasEntities\n    case 'automations': return hasAny\n    case 'workflows': return hasAny\n\n    // FinTech views — always show (they have their own connection flow)\n    case 'fintech': return true\n    case 'fintech-hub': return true\n    case 'market': return true\n\n    default: return hasAny || hasProfile\n  }\n}\n\n// Views that should NEVER show an empty state (they handle it internally)\nconst SKIP_EMPTY_STATE: Set<ViewKey> = new Set([\n  'dashboard', 'setup', 'data', 'import', 'quickbooks', 'advisor',\n  'workspace', 'settings', 'calendar', 'alerts', 'fintech', 'fintech-hub', 'market',\n])\n\nexport function ViewShell({ view, state, onNavigate, children }: ViewShellProps) {\n  const hasData = viewHasData(view, state)\n  const skipEmpty = SKIP_EMPTY_STATE.has(view)\n\n  return (\n    <ErrorBoundary key={view} onNavigate={(v) => onNavigate(v as ViewKey)}>\n      <Suspense fallback={<SkeletonDashboard />}>\n        {!hasData && !skipEmpty ? (\n          <EmptyState\n            view={view}\n            hasData={false}\n            onNavigate={(v) => onNavigate(v as ViewKey)}\n          />\n        ) : (\n          children\n        )}\n      </Suspense>\n    </ErrorBoundary>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\accordion.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\alert.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\aspect-ratio.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\avatar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\badge.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":36,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":36,"endColumn":30}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  \"inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow hover:bg-primary/80\",\n        secondary:\n          \"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow hover:bg-destructive/80\",\n        outline: \"text-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  )\n}\n\nexport { Badge, badgeVariants }\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\breadcrumb.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\button.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":57,"column":18,"nodeType":"Identifier","messageId":"namedExport","endLine":57,"endColumn":32}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground shadow hover:bg-primary/90\",\n        destructive:\n          \"bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90\",\n        outline:\n          \"border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground\",\n        secondary:\n          \"bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80\",\n        ghost: \"hover:bg-accent hover:text-accent-foreground\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n      },\n      size: {\n        default: \"h-9 px-4 py-2\",\n        sm: \"h-8 rounded-md px-3 text-xs\",\n        lg: \"h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\calendar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\carousel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\checkbox.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\collapsible.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\command.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\context-menu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\drawer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\dropdown-menu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\form.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":168,"column":3,"nodeType":"Identifier","messageId":"namedExport","endLine":168,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-[0.8rem] text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-[0.8rem] font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\hover-card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\label.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\menubar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\navigation-menu.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":119,"column":3,"nodeType":"Identifier","messageId":"namedExport","endLine":119,"endColumn":29}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-9 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-300 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\popover.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\progress.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\radio-group.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\resizable.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\scroll-area.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\separator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\sheet.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\slider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\sonner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\switch.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\table.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\tabs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\textarea.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\toast.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\toaster.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\toggle-group.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\toggle.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":43,"column":18,"nodeType":"Identifier","messageId":"namedExport","endLine":43,"endColumn":32}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent shadow-sm hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-9 px-2 min-w-9\",\n        sm: \"h-8 px-1.5 min-w-8\",\n        lg: \"h-10 px-2.5 min-w-10\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\components\\ui\\tooltip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\context\\AuthContext.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":223,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":223,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7225,7228],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7225,7228],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":371,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":371,"endColumn":24}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — Auth Context\n * \n * Wraps the app with authentication state management.\n * Handles login/register/logout, token refresh, and sync triggers.\n * Works alongside FortunaProvider — auth wraps fortuna.\n */\n\nimport { createContext, useContext, useState, useEffect, useCallback, useRef, type ReactNode } from 'react'\nimport {\n  AuthAPI,\n  StateAPI,\n  type AuthUser,\n  getStoredUser,\n  isAuthenticated,\n  hasRefreshToken,\n  clearAuthData,\n  getAPIBaseUrl,\n  setAPIBaseUrl,\n  testAPIConnection,\n  type APIError,\n} from '../engine/api-client'\nimport { Storage, type FortunaState } from '../engine/storage'\n\n// ============================================\n//  TYPES\n// ============================================\n\nexport type AuthMode = 'login' | 'register'\nexport type SyncStatus = 'idle' | 'syncing' | 'synced' | 'error' | 'offline' | 'conflict'\n\ninterface AuthContextType {\n  // Auth state\n  user: AuthUser | null\n  isLoggedIn: boolean\n  isLoading: boolean\n  authError: string | null\n  \n  // Auth actions\n  login: (email: string, password: string) => Promise<boolean>\n  register: (email: string, password: string, displayName?: string) => Promise<boolean>\n  logout: () => Promise<void>\n  updateProfile: (updates: { display_name?: string; email?: string; current_password?: string; new_password?: string }) => Promise<boolean>\n  \n  // Sync state\n  syncStatus: SyncStatus\n  lastSyncedAt: string | null\n  cloudVersion: number\n  \n  // Sync actions\n  syncToCloud: (state: FortunaState) => Promise<void>\n  syncFromCloud: () => Promise<FortunaState | null>\n  forceSync: (state: FortunaState) => Promise<void>\n  \n  // API config\n  apiBaseUrl: string\n  setApiUrl: (url: string) => Promise<boolean>\n  isApiConfigured: boolean\n  \n  // Mode (allows using app without account)\n  isOfflineMode: boolean\n  enableOfflineMode: () => void\n  connectAccount: () => void\n}\n\nconst AuthContext = createContext<AuthContextType | null>(null)\n\n// ============================================\n//  PROVIDER\n// ============================================\n\nexport function AuthProvider({ children }: { children: ReactNode }) {\n  const [user, setUser] = useState<AuthUser | null>(null)\n  const [isLoading, setIsLoading] = useState(true)\n  const [authError, setAuthError] = useState<string | null>(null)\n  const [syncStatus, setSyncStatus] = useState<SyncStatus>('idle')\n  const [lastSyncedAt, setLastSyncedAt] = useState<string | null>(null)\n  const [cloudVersion, setCloudVersion] = useState(0)\n  const [isOfflineMode, setIsOfflineMode] = useState(false)\n  const [apiBaseUrl, setApiBaseUrlState] = useState(getAPIBaseUrl())\n  const [isApiConfigured, setIsApiConfigured] = useState(false)\n  \n  const syncTimer = useRef<ReturnType<typeof setTimeout> | null>(null)\n\n  // ---- Initialize auth state ----\n  useEffect(() => {\n    async function init() {\n      // Auto-detect API URL and test connection\n      const url = getAPIBaseUrl()\n      if (url) {\n        const test = await testAPIConnection(url)\n        if (test.connected) {\n          setIsApiConfigured(true)\n          setApiBaseUrlState(url)\n          // Persist the auto-detected URL so ai-providers can find it\n          setAPIBaseUrl(url)\n        }\n      }\n      \n      // Check for existing session\n      const storedUser = getStoredUser()\n      if (storedUser && (isAuthenticated() || hasRefreshToken())) {\n        setUser(storedUser)\n        \n        // Verify session is still valid\n        try {\n          const profile = await AuthAPI.getProfile()\n          setUser(profile.user)\n          if (profile.state_meta) {\n            setCloudVersion(profile.state_meta.state_version || 0)\n            setLastSyncedAt(profile.state_meta.last_synced_at || null)\n          }\n          setSyncStatus('synced')\n        } catch {\n          // Token might be expired — don't logout yet, refresh will handle it\n          setSyncStatus('offline')\n        }\n      } else {\n        // Check if user was in offline mode\n        const offlineFlag = localStorage.getItem('fortuna:offline-mode')\n        if (offlineFlag === 'true') {\n          setIsOfflineMode(true)\n        }\n      }\n      \n      setIsLoading(false)\n    }\n    init()\n  }, [])\n\n  // ---- Auth Actions ----\n\n  const login = useCallback(async (email: string, password: string): Promise<boolean> => {\n    setAuthError(null)\n    try {\n      const result = await AuthAPI.login(email, password)\n      setUser(result.user)\n      setIsOfflineMode(false)\n      localStorage.removeItem('fortuna:offline-mode')\n      \n      // Trigger initial sync\n      try {\n        const localState = await Storage.getFullState()\n        const mergeResult = await StateAPI.merge(\n          localState,\n          localState.lastUpdated\n        )\n        setCloudVersion(mergeResult.version)\n        setSyncStatus('synced')\n        setLastSyncedAt(new Date().toISOString())\n        \n        // If remote had newer data, update local\n        if (mergeResult.resolution !== 'local_wins' && mergeResult.state) {\n          await Storage.saveFullState(mergeResult.state)\n          // Signal that state should be reloaded\n          window.dispatchEvent(new CustomEvent('fortuna:state-updated', { detail: mergeResult.state }))\n        }\n      } catch (e) {\n        console.warn('[Auth] Initial sync failed, continuing offline', e)\n        setSyncStatus('offline')\n      }\n      \n      return true\n    } catch (e) {\n      const err = e as APIError\n      if (err.code === 'BACKEND_UNAVAILABLE') {\n        setAuthError('No backend server connected. Click \"Continue Without Account\" below to use Fortuna in local-only mode.')\n      } else {\n        setAuthError(err.message || 'Login failed')\n      }\n      return false\n    }\n  }, [])\n\n  const register = useCallback(async (email: string, password: string, displayName?: string): Promise<boolean> => {\n    setAuthError(null)\n    try {\n      const result = await AuthAPI.register(email, password, displayName)\n      setUser(result.user)\n      setIsOfflineMode(false)\n      localStorage.removeItem('fortuna:offline-mode')\n      \n      // Upload existing local state to cloud\n      try {\n        const localState = await Storage.getFullState()\n        if (localState.onboardingComplete) {\n          const saveResult = await StateAPI.save(localState, undefined, true)\n          setCloudVersion(saveResult.version)\n          setSyncStatus('synced')\n          setLastSyncedAt(saveResult.synced_at)\n        }\n      } catch {\n        setSyncStatus('offline')\n      }\n      \n      return true\n    } catch (e) {\n      const err = e as APIError\n      if (err.code === 'BACKEND_UNAVAILABLE') {\n        setAuthError('No backend server connected. Click \"Continue Without Account\" below to use Fortuna in local-only mode.')\n      } else {\n        setAuthError(err.message || 'Registration failed')\n      }\n      return false\n    }\n  }, [])\n\n  const logout = useCallback(async () => {\n    try {\n      await AuthAPI.logout()\n    } catch {\n      // Clear local regardless\n    }\n    setUser(null)\n    setIsOfflineMode(false)\n    setSyncStatus('idle')\n    setCloudVersion(0)\n    setLastSyncedAt(null)\n    localStorage.removeItem('fortuna:offline-mode')\n    clearAuthData()\n  }, [])\n\n  const updateProfile = useCallback(async (updates: any): Promise<boolean> => {\n    try {\n      await AuthAPI.updateProfile(updates)\n      // Refresh user data\n      const profile = await AuthAPI.getProfile()\n      setUser(profile.user)\n      return true\n    } catch (e) {\n      setAuthError((e as APIError).message)\n      return false\n    }\n  }, [])\n\n  // ---- Sync Actions ----\n\n  const syncToCloud = useCallback(async (state: FortunaState) => {\n    if (!user) return\n    \n    setSyncStatus('syncing')\n    try {\n      const result = await StateAPI.save(state, cloudVersion)\n      if (!result.skipped) {\n        setCloudVersion(result.version)\n      }\n      setLastSyncedAt(result.synced_at)\n      setSyncStatus('synced')\n    } catch (e) {\n      const apiError = e as APIError\n      if (apiError.code === 'STATE_CONFLICT') {\n        setSyncStatus('conflict')\n      } else {\n        setSyncStatus('error')\n      }\n      console.warn('[Sync] Save failed:', apiError.message)\n    }\n  }, [user, cloudVersion])\n\n  const syncFromCloud = useCallback(async (): Promise<FortunaState | null> => {\n    if (!user) return null\n    \n    setSyncStatus('syncing')\n    try {\n      const result = await StateAPI.load()\n      if (result.state) {\n        setCloudVersion(result.version)\n        setLastSyncedAt(result.last_synced_at)\n        setSyncStatus('synced')\n        return result.state as FortunaState\n      }\n      setSyncStatus('synced')\n      return null\n    } catch {\n      setSyncStatus('error')\n      return null\n    }\n  }, [user])\n\n  const forceSync = useCallback(async (state: FortunaState) => {\n    if (!user) return\n    \n    setSyncStatus('syncing')\n    try {\n      const result = await StateAPI.save(state, undefined, true)\n      setCloudVersion(result.version)\n      setLastSyncedAt(result.synced_at)\n      setSyncStatus('synced')\n    } catch {\n      setSyncStatus('error')\n    }\n  }, [user])\n\n  // ---- API Config ----\n\n  const setApiUrl = useCallback(async (url: string): Promise<boolean> => {\n    const test = await testAPIConnection(url)\n    if (test.connected) {\n      setAPIBaseUrl(url)\n      setApiBaseUrlState(url)\n      setIsApiConfigured(true)\n      return true\n    }\n    return false\n  }, [])\n\n  // ---- Offline Mode ----\n\n  const enableOfflineMode = useCallback(() => {\n    setIsOfflineMode(true)\n    localStorage.setItem('fortuna:offline-mode', 'true')\n  }, [])\n\n  // Exit offline mode → return to auth screen (no network calls)\n  const connectAccount = useCallback(() => {\n    setIsOfflineMode(false)\n    setUser(null)\n    localStorage.removeItem('fortuna:offline-mode')\n  }, [])\n\n  // ---- Auto-sync (debounced, when logged in) ----\n  // This is called from useFortuna when state changes\n  useEffect(() => {\n    // Listen for state save events\n    const handler = (e: Event) => {\n      if (!user) return\n      const state = (e as CustomEvent).detail as FortunaState\n      if (!state) return\n      \n      if (syncTimer.current) clearTimeout(syncTimer.current)\n      syncTimer.current = setTimeout(() => {\n        syncToCloud(state)\n      }, 5000) // 5 second debounce for cloud sync\n    }\n    \n    window.addEventListener('fortuna:state-saved', handler)\n    return () => {\n      window.removeEventListener('fortuna:state-saved', handler)\n      if (syncTimer.current) clearTimeout(syncTimer.current)\n    }\n  }, [user, syncToCloud])\n\n  return (\n    <AuthContext.Provider value={{\n      user,\n      isLoggedIn: !!user,\n      isLoading,\n      authError,\n      login,\n      register,\n      logout,\n      updateProfile,\n      syncStatus,\n      lastSyncedAt,\n      cloudVersion,\n      syncToCloud,\n      syncFromCloud,\n      forceSync,\n      apiBaseUrl,\n      setApiUrl,\n      isApiConfigured,\n      isOfflineMode,\n      enableOfflineMode,\n      connectAccount,\n    }}>\n      {children}\n    </AuthContext.Provider>\n  )\n}\n\nexport function useAuth() {\n  const ctx = useContext(AuthContext)\n  if (!ctx) throw new Error('useAuth must be used within AuthProvider')\n  return ctx\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\context\\NavigationContext.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":21,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":21,"endColumn":53},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":56,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":56,"endColumn":58},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":118,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":118,"endColumn":30}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — Navigation Context\n *\n * Provides app-wide navigation without prop drilling.\n * Any view can import useNavigation() to navigate to other views\n * and render contextual \"Related Views\" links.\n */\n\nimport { createContext, useContext, useCallback, type ReactNode } from 'react'\nimport type { ViewKey } from '../App'\n\n// ── View Metadata & Relationship Map ──────────────────────────────────\n\nexport interface ViewMeta {\n  key: ViewKey\n  label: string\n  icon: string // emoji shorthand\n  section: string\n}\n\nexport const VIEW_REGISTRY: Record<string, ViewMeta> = {\n  dashboard:    { key: 'dashboard',    label: 'Dashboard',            icon: '📊', section: 'Overview' },\n  tax:          { key: 'tax',          label: 'Tax Strategy',         icon: '💡', section: 'Strategy' },\n  entity:       { key: 'entity',       label: 'Entity Design',        icon: '🏗️', section: 'Entities' },\n  revenue:      { key: 'revenue',      label: 'Revenue Engine',       icon: '💰', section: 'Revenue' },\n  risk:         { key: 'risk',         label: 'Risk Matrix',          icon: '⚠️', section: 'Risk' },\n  automations:  { key: 'automations',  label: 'Automations',          icon: '⚡', section: 'Tools' },\n  advisor:      { key: 'advisor',      label: 'AI Advisor',           icon: '🤖', section: 'Intelligence' },\n  scenarios:    { key: 'scenarios',     label: 'Scenario Modeler',     icon: '🔮', section: 'Strategy' },\n  timeline:     { key: 'timeline',     label: 'Execution Timeline',   icon: '📅', section: 'Planning' },\n  flow:         { key: 'flow',         label: 'Entity Flow',          icon: '🔄', section: 'Entities' },\n  reports:      { key: 'reports',      label: 'Reports',              icon: '📄', section: 'Reports' },\n  cashflow:     { key: 'cashflow',     label: 'Cash Flow',            icon: '💸', section: 'Revenue' },\n  audit:        { key: 'audit',        label: 'Audit Profiler',       icon: '🔍', section: 'Risk' },\n  alerts:       { key: 'alerts',       label: 'Proactive Alerts',     icon: '🔔', section: 'Intelligence' },\n  calendar:     { key: 'calendar',     label: 'Tax Calendar',         icon: '📆', section: 'Planning' },\n  documents:    { key: 'documents',    label: 'Document Center',      icon: '📁', section: 'Reports' },\n  import:       { key: 'import',       label: 'Data Import',          icon: '📥', section: 'Tools' },\n  workflows:    { key: 'workflows',    label: 'Workflows',            icon: '🔗', section: 'Tools' },\n  optimizer:    { key: 'optimizer',    label: 'Entity Optimizer',     icon: '⚙️', section: 'Entities' },\n  health:       { key: 'health',       label: 'Health Score',         icon: '❤️', section: 'Overview' },\n  cpa:          { key: 'cpa',          label: 'CPA Export',           icon: '📋', section: 'Reports' },\n  data:         { key: 'data',         label: 'Data Manager',         icon: '💾', section: 'Tools' },\n  history:      { key: 'history',      label: 'Financial History',    icon: '📈', section: 'Overview' },\n  taxdocs:      { key: 'taxdocs',      label: 'Tax Documents',        icon: '📝', section: 'Reports' },\n  retirement:   { key: 'retirement',   label: 'Retirement Optimizer', icon: '🏖️', section: 'Strategy' },\n  arbitrage:    { key: 'arbitrage',    label: 'State Arbitrage',      icon: '🗺️', section: 'Strategy' },\n  multiyear:    { key: 'multiyear',    label: 'Multi-Year Projections', icon: '📊', section: 'Strategy' },\n  depreciation: { key: 'depreciation', label: 'Depreciation & Assets', icon: '🏭', section: 'Strategy' },\n  credits:      { key: 'credits',      label: 'Tax Credits',          icon: '🏆', section: 'Strategy' },\n  nexus:        { key: 'nexus' as ViewKey, label: 'Intelligence Nexus', icon: '🧠', section: 'Intelligence' },\n  pnl:          { key: 'pnl' as ViewKey, label: 'P&L Statement',      icon: '📊', section: 'Reports' },\n}\n\n/** Contextual links between views — \"if you're on X, you might want Y\" */\nexport const VIEW_RELATIONSHIPS: Record<string, string[]> = {\n  dashboard:    ['health', 'alerts', 'nexus', 'advisor'],\n  tax:          ['multiyear', 'credits', 'retirement', 'scenarios', 'nexus'],\n  entity:       ['optimizer', 'flow', 'taxdocs'],\n  revenue:      ['cashflow', 'scenarios', 'pnl'],\n  risk:         ['audit', 'alerts', 'health'],\n  advisor:      ['nexus', 'tax', 'scenarios', 'health'],\n  scenarios:    ['multiyear', 'tax', 'arbitrage'],\n  timeline:     ['calendar', 'alerts', 'workflows'],\n  flow:         ['entity', 'optimizer'],\n  reports:      ['pnl', 'cpa', 'taxdocs'],\n  cashflow:     ['pnl', 'revenue', 'scenarios'],\n  audit:        ['cpa', 'taxdocs', 'risk'],\n  alerts:       ['timeline', 'nexus', 'advisor'],\n  calendar:     ['timeline', 'alerts', 'taxdocs'],\n  documents:    ['cpa', 'taxdocs', 'import'],\n  optimizer:    ['entity', 'tax', 'arbitrage'],\n  health:       ['nexus', 'advisor', 'dashboard'],\n  cpa:          ['taxdocs', 'documents', 'audit'],\n  history:      ['health', 'dashboard', 'reports'],\n  taxdocs:      ['cpa', 'documents', 'audit'],\n  retirement:   ['credits', 'multiyear', 'tax'],\n  arbitrage:    ['optimizer', 'scenarios', 'tax'],\n  multiyear:    ['credits', 'retirement', 'depreciation', 'nexus'],\n  depreciation: ['multiyear', 'credits', 'tax'],\n  credits:      ['retirement', 'multiyear', 'depreciation'],\n  nexus:        ['advisor', 'tax', 'multiyear', 'credits'],\n  pnl:          ['cashflow', 'reports', 'revenue'],\n}\n\n// ── Context ───────────────────────────────────────────────────────────\n\ninterface NavigationContextValue {\n  navigate: (view: ViewKey) => void\n  currentView: ViewKey\n}\n\nconst NavigationContext = createContext<NavigationContextValue>({\n  navigate: () => {},\n  currentView: 'dashboard',\n})\n\nexport function NavigationProvider({\n  children,\n  onNavigate,\n  currentView,\n}: {\n  children: ReactNode\n  onNavigate: (view: ViewKey) => void\n  currentView: ViewKey\n}) {\n  const navigate = useCallback((view: ViewKey) => {\n    onNavigate(view)\n  }, [onNavigate])\n\n  return (\n    <NavigationContext.Provider value={{ navigate, currentView }}>\n      {children}\n    </NavigationContext.Provider>\n  )\n}\n\nexport function useNavigation() {\n  return useContext(NavigationContext)\n}\n\n// ── Related Views Component ───────────────────────────────────────────\n\nexport function RelatedViews({ currentView }: { currentView?: string }) {\n  const { navigate, currentView: ctxView } = useNavigation()\n  const view = currentView || ctxView\n\n  const related = VIEW_RELATIONSHIPS[view] || []\n  if (related.length === 0) return null\n\n  return (\n    <div style={{\n      display: 'flex',\n      gap: 8,\n      flexWrap: 'wrap',\n      padding: '12px 0',\n      borderTop: '1px solid rgba(255,255,255,0.08)',\n      marginTop: 16,\n    }}>\n      <span style={{ fontSize: 12, color: 'rgba(255,255,255,0.4)', lineHeight: '28px' }}>\n        Related:\n      </span>\n      {related.map(key => {\n        const meta = VIEW_REGISTRY[key]\n        if (!meta) return null\n        return (\n          <button\n            key={key}\n            onClick={() => navigate(meta.key)}\n            style={{\n              fontSize: 12,\n              padding: '4px 10px',\n              borderRadius: 6,\n              background: 'rgba(255,255,255,0.06)',\n              border: '1px solid rgba(255,255,255,0.1)',\n              color: 'rgba(255,255,255,0.7)',\n              cursor: 'pointer',\n              display: 'flex',\n              alignItems: 'center',\n              gap: 4,\n              transition: 'all 0.2s',\n            }}\n            onMouseEnter={e => {\n              ;(e.target as HTMLElement).style.background = 'rgba(99,102,241,0.2)'\n              ;(e.target as HTMLElement).style.borderColor = 'rgba(99,102,241,0.4)'\n            }}\n            onMouseLeave={e => {\n              ;(e.target as HTMLElement).style.background = 'rgba(255,255,255,0.06)'\n              ;(e.target as HTMLElement).style.borderColor = 'rgba(255,255,255,0.1)'\n            }}\n          >\n            {meta.icon} {meta.label}\n          </button>\n        )\n      })}\n    </div>\n  )\n}\n\n/** Compact breadcrumb showing current section */\nexport function ViewBreadcrumb({ viewKey }: { viewKey?: string }) {\n  const { navigate, currentView } = useNavigation()\n  const key = viewKey || currentView\n  const meta = VIEW_REGISTRY[key]\n  if (!meta) return null\n\n  return (\n    <div style={{\n      display: 'flex',\n      alignItems: 'center',\n      gap: 6,\n      fontSize: 12,\n      color: 'rgba(255,255,255,0.4)',\n      marginBottom: 8,\n    }}>\n      <span\n        style={{ cursor: 'pointer' }}\n        onClick={() => navigate('dashboard')}\n        onMouseEnter={e => (e.target as HTMLElement).style.color = 'rgba(255,255,255,0.7)'}\n        onMouseLeave={e => (e.target as HTMLElement).style.color = 'rgba(255,255,255,0.4)'}\n      >\n        Fortuna\n      </span>\n      <span>›</span>\n      <span>{meta.section}</span>\n      <span>›</span>\n      <span style={{ color: 'rgba(255,255,255,0.7)' }}>{meta.label}</span>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\ai-categorization.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":34,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1173,1176],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1173,1176],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":39,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1324,1327],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1324,1327],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'results' is assigned a value but never used.","line":51,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":51,"endColumn":22}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, vi, beforeEach } from 'vitest'\r\nimport { processReceiptsAsync } from './receipt-engine'\r\nimport { categorizeReceiptAI } from './ai-categorization'\r\nimport type { FortunaState } from './storage'\r\n\r\n// Mock the AI Bridge\r\nvi.mock('./ai-categorization', () => ({\r\n    categorizeReceiptAI: vi.fn()\r\n}))\r\n\r\ndescribe('AI-Driven Categorization', () => {\r\n    let mockState: FortunaState\r\n\r\n    beforeEach(() => {\r\n        mockState = {\r\n            receipts: [\r\n                {\r\n                    id: 'ambiguous-1',\r\n                    merchantName: 'Home Depot',\r\n                    date: '2026-02-15',\r\n                    totalAmount: 45.00,\r\n                    status: 'scanned',\r\n                    items: [\r\n                        { id: 'item-1', description: 'Hammer', amount: 45.00, status: 'scanned' }\r\n                    ]\r\n                }\r\n            ],\r\n            entities: [\r\n                { id: 'biz-1', name: 'Real Estate LLC', type: 'business', notes: 'Rental property management', isActive: true }\r\n            ],\r\n            expenses: [],\r\n            deductions: [],\r\n            intakeBatches: []\r\n        } as any\r\n    })\r\n\r\n    it('should use AI fallback when heuristics fail', async () => {\r\n        // Setup AI mock response\r\n        (categorizeReceiptAI as any).mockResolvedValue({\r\n            receiptId: 'ambiguous-1',\r\n            confidence: 'high',\r\n            isBusiness: true,\r\n            category: 'Equipment',\r\n            suggestedEntityId: 'biz-1',\r\n            reasoning: 'Tools for rental property maintenance',\r\n            lineItemAllocations: [\r\n                { itemId: 'item-1', category: 'Equipment', isBusiness: true }\r\n            ]\r\n        })\r\n\r\n        const results = await processReceiptsAsync(mockState)\r\n        \r\n        expect(categorizeReceiptAI).toHaveBeenCalled()\r\n        const receipt = mockState.receipts.find(r => r.id === 'ambiguous-1')\r\n        expect(receipt?.status).toBe('allocated')\r\n        expect(receipt?.items[0].allocatedEntityId).toBe('biz-1')\r\n        expect(receipt?.items[0].inferredCategory).toBe('Equipment')\r\n    })\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\ai-categorization.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\ai-context.ts","messages":[{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":49,"column":11,"nodeType":"BlockStatement","messageId":"unexpected","endLine":49,"endColumn":13,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[2192,2192],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":58,"column":11,"nodeType":"BlockStatement","messageId":"unexpected","endLine":58,"endColumn":13,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[2948,2948],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":71,"column":11,"nodeType":"BlockStatement","messageId":"unexpected","endLine":71,"endColumn":13,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[4056,4056],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\$.","line":219,"column":236,"nodeType":"TemplateElement","messageId":"unnecessaryEscape","endLine":219,"endColumn":237,"suggestions":[{"messageId":"removeEscape","fix":{"range":[12723,12724],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[12723,12723],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\$.","line":230,"column":65,"nodeType":"TemplateElement","messageId":"unnecessaryEscape","endLine":230,"endColumn":66,"suggestions":[{"messageId":"removeEscape","fix":{"range":[13204,13205],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[13204,13204],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\$.","line":230,"column":142,"nodeType":"TemplateElement","messageId":"unnecessaryEscape","endLine":230,"endColumn":143,"suggestions":[{"messageId":"removeEscape","fix":{"range":[13281,13282],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[13281,13281],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — AI Context Builder v2\n *\n * Upgraded to feed the FULL unified intelligence pipeline into\n * the AI advisor, including multi-year projections, tax credits,\n * depreciation, cross-engine nexus insights, and all strategy outputs.\n */\n\nimport type { FortunaState } from './storage'\nimport { generateTaxReport, compareEntities, STATE_TAX_RATES } from './tax-calculator'\nimport { detectStrategies, analyzeRisks, calculateHealthScore } from './strategy-detector'\nimport { generateTimeline } from './execution-timeline'\nimport { generateSmartScenarios, evaluateScenario } from './scenario-modeler'\nimport { runUnifiedIntelligence, buildIntelligenceBrief } from './unified-intelligence'\nimport { buildPortfolioAIContext } from './portfolio-bridge'\n\nexport async function buildSystemPrompt(state: FortunaState): Promise<string> {\n  const report = generateTaxReport(state)\n  const strategies = detectStrategies(state)\n  const risks = analyzeRisks(state)\n  const health = calculateHealthScore(state)\n  const entities = compareEntities(\n    state.incomeStreams\n      .filter(s => ['business', 'freelance'].includes(s.type) && s.isActive)\n      .reduce((sum, s) => sum + s.annualAmount, 0),\n    state.profile\n  )\n\n  const stateName = STATE_TAX_RATES[state.profile.state]?.name || state.profile.state\n\n  // Run the full unified intelligence pipeline\n  let intelligenceBrief = ''\n  try {\n    const intel = runUnifiedIntelligence(state)\n    intelligenceBrief = buildIntelligenceBrief(intel)\n  } catch {\n    intelligenceBrief = '(Intelligence pipeline unavailable — using base data only)'\n  }\n\n  // Build additional engine context\n  let deductionContext = ''\n  try {\n    const { discoverDeductions } = await import('./deduction-discovery')\n    const discoveries = discoverDeductions(state)\n    const unclaimed = discoveries.filter(d => !d.alreadyClaimed && d.applies)\n    if (unclaimed.length > 0) {\n      deductionContext = `\\nUNCLAIMED DEDUCTIONS DISCOVERED:\\n${unclaimed.map(d => `- ${d.name}: Est. $${d.estimatedAmount.toLocaleString()} deduction → $${d.taxSavings.toLocaleString()} tax savings (${d.confidence} confidence)\\n  How: ${d.howToClaim}`).join('\\n')}\\n`\n    }\n  } catch {}\n\n  let paycheckContext = ''\n  try {\n    const { simulateAllPaychecks } = await import('./paycheck-simulator')\n    const paychecks = simulateAllPaychecks(state, 'biweekly')\n    if (paychecks.length > 0) {\n      paycheckContext = `\\nPAYCHECK SIMULATION (biweekly):\\n${paychecks.map(pc => `- ${pc.employerName}: Gross $${pc.grossPay.toLocaleString()} → Pre-tax $${pc.totalPretax.toLocaleString()} → Taxes $${pc.totalTaxes.toLocaleString()} → NET $${pc.netPay.toLocaleString()} per paycheck (${(pc.takeHomeRate * 100).toFixed(1)}% take-home rate)\\n  Annual net: $${pc.annualNet.toLocaleString()} | Marginal fed rate: ${(pc.marginalFedRate * 100).toFixed(0)}% | Employer total cost: $${pc.totalCompensation.toLocaleString()}`).join('\\n')}\\n`\n    }\n  } catch {}\n\n  let marginalContext = ''\n  try {\n    const { analyzeMarginalRates } = await import('./marginal-rate')\n    const analysis = analyzeMarginalRates(state)\n    const cp = analysis.currentPoint\n    marginalContext = `\\nMARGINAL RATE ANALYSIS AT CURRENT INCOME ($${analysis.currentIncome.toLocaleString()}):\n  Combined marginal rate: ${(cp.totalRate * 100).toFixed(1)}% (Federal ${(cp.federalRate * 100).toFixed(0)}% + State ${(cp.stateRate * 100).toFixed(1)}% + SE ${(cp.seRate * 100).toFixed(1)}% + FICA ${(cp.ficaRate * 100).toFixed(1)}%)\n  Keep rate: ${(cp.keepRate * 100).toFixed(1)}¢ of each additional dollar\n  Next bracket increase at: $${analysis.nextBracketAt.toLocaleString()} (${(analysis.nextBracketRate * 100).toFixed(1)}% combined)\n  ${analysis.dangerZones.length > 0 ? `Danger zones: ${analysis.dangerZones.map(z => `$${z.start.toLocaleString()}-$${z.end.toLocaleString()} (${z.reason})`).join('; ')}` : 'No danger zones detected'}\n  ${analysis.sweetSpots.length > 0 ? `Sweet spots: ${analysis.sweetSpots.map(s => `$${s.income.toLocaleString()} — ${s.reason}`).join('; ')}` : ''}\\n`\n  } catch {}\n\n  const portfolioContext = buildPortfolioAIContext()\n\n  return `You are the Fortuna Engine AI Advisor — a comprehensive financial intelligence system that serves as the user's personal CFO, tax strategist, business advisor, and financial educator. You have deep expertise across:\n\n• Tax optimization (federal, state, self-employment, payroll)\n• Entity structuring (sole prop, LLC, S-Corp, C-Corp — formation, elections, compliance)\n• Business strategy (revenue diversification, pricing, market positioning)\n• Cash flow management (forecasting, runway, seasonal planning)\n• Retirement planning (401k, SEP-IRA, Solo 401k, Roth conversions, catch-up)\n• Investment strategy (asset allocation basics, tax-loss harvesting, NIIT thresholds, cross-entity wash sale detection)\n• Kiddie tax analysis (Form 8615 — unearned income for dependents under 19/24)\n• Underpayment penalty calculator (Form 2210 — safe harbor, quarterly requirements, penalty computation)\n• Estate and succession planning fundamentals\n• Insurance and risk management\n• Real estate and rental income optimization\n• Employee vs. contractor decisions and compliance\n• Financial literacy and education on any finance/tax/business topic\n\nYou also know the Fortuna Engine platform intimately. When users ask about features or how to do something, guide them:\n\nFORTUNA ENGINE FEATURES (guide users to these):\n- Command Center (Dashboard): KPIs, quick what-if scenarios, W-2 withholding summary\n- Tax Strategy: Federal/state/SE tax calculator with entity comparison\n- Paycheck Simulator: Per-period gross-to-net breakdown for W-2 income\n- Deduction Finder: Auto-discovers unclaimed deductions (home office, HSA gaps, 401k gaps, QBI, etc.)\n- Marginal Rate Stack: Visualizes combined marginal rate at every income level with danger zones\n- Goal Planner: Reverse-engineers financial targets (after-tax income, savings goals, retirement)\n- Entity Design / Optimizer / Entity Flow: Structure, compare, and optimize business entities\n- Scenario Modeler: What-if analysis (S-Corp election, revenue changes, state relocation)\n- Cash Flow: 12-month projection with W-2 withholding awareness and quarterly estimate timing\n- Multi-Year Tax: 3-year tax trajectory projections\n- Retirement Optimizer: Maximize retirement savings across all vehicle types\n- State Arbitrage: Compare tax burden across all 50 states\n- Depreciation Engine: Section 179 and bonus depreciation tracking\n- Tax Credits: R&D, child, education, energy credit eligibility\n- Audit Profiler: IRS DIF score estimation and audit risk factors\n- Risk Matrix: Financial vulnerability assessment\n- Tax Prep Checklist: Filing readiness tracker organized by form\n- Tax Calendar: Automated deadline tracking\n- CPA Export: Professional handoff package\n- AI Advisor (this chat): Full-context Q&A powered by all engines\n- Edit Profile / Data Setup: Where to enter income, expenses, entities, W-2 data\n\nBEHAVIOR RULES:\n- Always give specific dollar amounts and percentages from the user's actual data\n- Never give generic advice — everything tailored to THIS user's exact situation\n- Be proactive — suggest optimizations they haven't asked about\n- Use concrete numbers from their profile in every response\n- Reference specific IRS forms, sections, and deadlines when discussing tax strategies\n- If recommending entity changes, specify exact steps, costs, and timeline\n- Format financial figures consistently: $XX,XXX\n- Be direct and confident in recommendations, prioritize highest-impact first\n- Flag time-sensitive deadlines prominently\n- Highlight compound/cross-engine opportunities (where multiple strategies stack)\n- When users ask general finance/business questions, still connect back to their specific situation\n- If asked about Fortuna features, explain clearly and suggest which view to navigate to\n- For questions outside your expertise, be honest about limitations\n- End substantive tax/legal recommendations with a note to verify with CPA/attorney\n- Be conversational and approachable — you're their trusted advisor, not a textbook\n- If the user's data is incomplete, note what's missing and how it affects the analysis\n\nUSER FINANCIAL PROFILE:\nName: ${state.profile.name || 'User'}\nState: ${stateName} (${state.profile.state})\nFiling Status: ${state.profile.filingStatus.replace('_', ' ')}\nAge: ${state.profile.age}\nDependents: ${state.profile.dependents}\n\nINCOME STREAMS:\n${state.incomeStreams.filter(s => s.isActive).map(s =>\n  `- ${s.name}: $${s.annualAmount.toLocaleString()}/yr (${s.type})${s.entityId ? ` [Entity: ${state.entities.find(e => e.id === s.entityId)?.name || 'Unknown'}]` : ''}`\n).join('\\n') || '- No income streams configured'}\n\nTotal Gross Income: $${report.grossIncome.toLocaleString()}\n  W-2 Income: $${report.w2Income.toLocaleString()}\n  Self-Employment: $${report.selfEmploymentIncome.toLocaleString()}\n  Investment: $${report.investmentIncome.toLocaleString()}\n  Other: $${report.otherIncome.toLocaleString()}\n\nLEGAL ENTITIES:\n${state.entities.filter(e => e.isActive).map(e =>\n  `- ${e.name}: ${e.type.replace('_', ' ').toUpperCase()} (${e.state})${e.annualCost ? ` | Annual cost: $${e.annualCost}` : ''}${e.officerSalary ? ` | Officer salary: $${e.officerSalary.toLocaleString()}` : ''}${e.ownershipPct && e.ownershipPct < 100 ? ` | ${e.ownershipPct}% ownership` : ''}`\n).join('\\n') || '- No formal entities (operating as sole proprietor)'}\n\nENTITY-LEVEL P&L:\n${(report.entityBreakdown || []).filter(e => e.revenue > 0 || e.expenses > 0).map(e =>\n  `- ${e.entityName} (${e.entityType.replace('_', ' ')}): Revenue $${e.revenue.toLocaleString()} | Expenses $${e.expenses.toLocaleString()} | Net $${e.netIncome.toLocaleString()} | Flow: ${e.flowThrough}${e.officerSalary > 0 ? ` | Officer salary $${e.officerSalary.toLocaleString()} + distributions $${e.distributions.toLocaleString()}` : ''}`\n).join('\\n') || '- All income flows through personal return'}\n\nTAX ANALYSIS (CALCULATED):\n  Adjusted Gross Income: $${report.agi.toLocaleString()}\n  Deduction Method: ${report.deductionUsed} ($${report.deductionAmount.toLocaleString()})\n  QBI Deduction: $${report.qbiDeduction.toLocaleString()}\n  Taxable Income: $${report.taxableIncome.toLocaleString()}\n  \n  Federal Income Tax: $${report.federalIncomeTax.toLocaleString()}\n  Self-Employment Tax: $${report.selfEmploymentTax.toLocaleString()}\n  State Tax (${state.profile.state}): $${report.stateTax.toLocaleString()}\n  TOTAL TAX: $${report.totalTax.toLocaleString()}\n  \n  Effective Tax Rate: ${(report.effectiveRate * 100).toFixed(1)}%\n  Marginal Rate: ${(report.marginalRate * 100).toFixed(0)}%\n  After-Tax Income: $${report.afterTaxIncome.toLocaleString()}\n\nRETIREMENT:\n  Current Contributions: $${report.currentRetirementContributions.toLocaleString()}\n  Maximum Available (SEP-IRA): $${report.maxSEPIRA.toLocaleString()}\n  Contribution Gap: $${report.retirementGap.toLocaleString()}\n\nDEDUCTIONS:\n${state.deductions.map(d =>\n  `- ${d.name}: $${d.amount.toLocaleString()} (${d.category}${d.isItemized ? ', itemized' : ''})`\n).join('\\n') || '- No deductions configured beyond standard'}\n\nBUSINESS EXPENSES:\n${state.expenses.filter(e => e.isDeductible).map(e =>\n  `- ${e.description}: $${e.annualAmount.toLocaleString()} (${(e.deductionPct)}% deductible)`\n).join('\\n') || '- No business expenses configured'}\n\nENTITY COMPARISON (CALCULATED FOR THEIR INCOME):\n${entities.map(e =>\n  `${e.label}: Total Tax $${e.totalTax.toLocaleString()} | Effective ${(e.effectiveRate * 100).toFixed(1)}% | Net $${e.netAfterTax.toLocaleString()} | Score: ${e.score}/100`\n).join('\\n')}\n\nDETECTED STRATEGIES (AUTO-ANALYZED):\n${strategies.map((s, i) =>\n  `${i + 1}. [${s.priority.toUpperCase()}] ${s.title} — Impact: ${s.impactLabel}\n     ${s.description}`\n).join('\\n\\n') || 'No strategies detected — need more financial data'}\n\nRISK ASSESSMENT:\n${risks.map(r =>\n  `- [${r.severity.toUpperCase()}] ${r.name}: ${r.description}`\n).join('\\n')}\n\nFINANCIAL HEALTH SCORE: ${health.overall}/100 (Grade: ${health.grade})\n  Tax Efficiency: ${health.components.taxEfficiency}/100\n  Entity Optimization: ${health.components.entityOptimization}/100\n  Income Diversification: ${health.components.diversification}/100\n  Risk Protection: ${health.components.riskProtection}/100\n  Retirement Readiness: ${health.components.retirementReadiness}/100\n\nEXECUTION TIMELINE (upcoming deadlines):\n${(() => {\n  const timeline = generateTimeline(state)\n  return timeline.slice(0, 6).map(a =>\n    `- [${a.status.toUpperCase()}] ${a.title} — deadline: ${a.deadlineLabel} (${a.daysUntilDeadline > 0 ? a.daysUntilDeadline + ' days remaining' : Math.abs(a.daysUntilDeadline) + ' days overdue'})${a.estimatedImpact > 0 ? ` — impact: \\$${a.estimatedImpact.toLocaleString()}` : ''}`\n  ).join('\\n') || 'No actions generated'\n})()}\n\nSCENARIO ANALYSIS:\n${(() => {\n  const scenarios = generateSmartScenarios(state)\n  return scenarios.slice(0, 4).map(s => {\n    const result = evaluateScenario(s.name, state, s.mods)\n    const taxDiff = report.totalTax - result.taxReport.totalTax\n    const netDiff = result.taxReport.afterTaxIncome - report.afterTaxIncome\n    return `- ${s.name}: Tax ${taxDiff > 0 ? 'saves' : 'costs'} \\$${Math.abs(taxDiff).toLocaleString()}, net income ${netDiff > 0 ? '+' : ''}\\$${netDiff.toLocaleString()}, health score: ${result.healthScore.overall}/100`\n  }).join('\\n') || 'No scenarios generated'\n})()}\n\nS-CORP SAVINGS POTENTIAL: $${report.sCorpSavings.toLocaleString()}/year\nTOTAL IDENTIFIED SAVINGS: $${report.identifiedSavings.toLocaleString()}/year\n\n════════════════════════════════════════════════════════\nUNIFIED INTELLIGENCE PIPELINE (v9 — Cross-Engine Analysis)\n════════════════════════════════════════════════════════\n${intelligenceBrief}\n${deductionContext}\n${paycheckContext}\n${marginalContext}\n${portfolioContext}\n\n════════════════════════════════════════════════════════\nMETAMODEL DATA (v10.4 — Unified Entity Attribution)\n════════════════════════════════════════════════════════\n\nDEPRECIATION ASSETS: ${(state.depreciationAssets || []).length} tracked\n${(state.depreciationAssets || []).filter(a => a.isActive).map(a =>\n  `- ${a.name}: $${a.purchasePrice.toLocaleString()} (${a.method}, ${a.businessUsePct}% biz use, entity: ${a.entityId || 'personal'})`\n).join('\\n') || 'None tracked'}\n\nRETIREMENT ACCOUNTS: ${(state.retirementAccounts || []).length} accounts\n${(state.retirementAccounts || []).map(a =>\n  `- ${a.name} (${a.type}): $${a.balance.toLocaleString()} balance, $${a.annualContribution.toLocaleString()}/yr contrib, max $${a.maxContribution.toLocaleString()}`\n).join('\\n') || 'None tracked'}\n\nFINANCIAL GOALS: ${(state.goals || []).length} goals\n${(state.goals || []).filter(g => g.status === 'active').map(g =>\n  `- ${g.title} (${g.type}): target $${(g.targetAmount || 0).toLocaleString()}, current $${(g.currentAmount || 0).toLocaleString()}, priority: ${g.priority}`\n).join('\\n') || 'None set'}\n\nESTIMATED PAYMENTS: ${(state.estimatedPayments || []).length} scheduled\n${(state.estimatedPayments || []).map(p =>\n  `- Due ${p.dueDate}: $${p.amount.toLocaleString()} (${p.paidAmount ? 'paid $' + p.paidAmount.toLocaleString() : 'UNPAID'})`\n).join('\\n') || 'None tracked'}\n\nHOUSEHOLD: ${state.household?.members?.length || 1} member(s), ${state.household?.dependents?.length || state.profile.dependents || 0} dependent(s)\nTAX YEAR: ${state.taxYear || new Date().getFullYear()}\n\nLIVE MARKET DATA INTEGRATIONS:\n• Federal Reserve (FRED): Fed funds rate, treasury yields, mortgage rates, S&P 500 — for underpayment penalty rates, Roth conversion analysis, retirement projections\n• Bureau of Labor Statistics (BLS): CPI inflation data — for multi-year bracket projections, real-return calculations\n• Treasury Fiscal Data: T-Bill/Note/Bond rates — for I-Bond composite rate estimates, muni vs treasury analysis\n• Exchange Rate API: 150+ currencies — for foreign income conversion, Form 1116 foreign tax credit calculations\n• Stock Quotes: Real-time pricing — for portfolio valuation, tax-loss harvesting scans, unrealized gain/loss tracking\n• SEC EDGAR: Filing search — for entity research, industry benchmarking, compliance verification\nAll data is cached and rate-limited. Users can configure API keys in settings for enhanced limits.\n\nQUICKBOOKS INTEGRATION:\n• IIF Parser: Full Intuit Interchange Format support — TRNS/SPL/ENDTRNS transaction blocks, ACCNT chart of accounts, CUST/VEND/EMP lists, CLASS tracking, INVITEM inventory\n• QBO/OFX Parser: Web Connect banking imports — bank statements, credit card statements, with FITID deduplication and payee extraction\n• QIF Parser: Legacy Quicken format — transactions with split categories\n• Account Mapper: Intelligent QB account → tax category mapping — 40+ pattern rules map QB account names to specific Schedule C/E/B/D/A line items\n• IIF Exporter: Bidirectional — export Fortuna data back to IIF for QB Desktop import (File → Utilities → Import → IIF)\n• Bank Transaction Bridge: QB transactions flow into Fortuna's bank transaction reconciliation pipeline\n• 1099 Vendor Detection: Automatically flags vendors marked for 1099 reporting in QB vendor list\n• Class → Entity Mapping: QB classes map to Fortuna legal entities for multi-entity tax optimization\nWhen users import QB data, the system auto-maps accounts to tax categories, detects income streams, deductible expenses, entity structures, and 1099 obligations. This data integrates across all Fortuna engines for comprehensive tax optimization.\n\nFINTECH INTEGRATION (Plaid/Unit/MX):\n• Connect bank accounts, credit cards, investments, and loans via Plaid Link, Unit SDK, or MX Widget\n• Canonical data models normalize all providers into unified Accounts, Transactions, Identity (KYC), Business (KYB), Investments, Liabilities, and Income schemas\n• Tax-aware enrichment engine: 100+ merchant pattern rules + MCC code classification → auto-assigns Schedule C/A/E line items, deductibility flags, and confidence scores\n• Recurring stream detection: Identifies subscriptions, income deposits, and recurring expenses from transaction patterns\n• Bridge layer: Maps enriched data → FortunaState (income streams, expenses, retirement accounts, investment positions, liabilities with deductible interest)\n• Transaction Review view: Users can review, override, bulk-approve tax categorizations with deduction discovery dashboard\n• Connection Manager: Multi-provider sync orchestration, webhook processing, health monitoring, incremental cursor-based sync\n• 1099 contractor detection, estimated tax payment tracking, mortgage/student loan interest deduction identification\n• Net worth tracking across all connected accounts with asset/liability/tax-advantaged breakdown\nWhen users connect accounts, guide them through the Linked Accounts view. When reviewing transactions, point them to Transaction Review. Highlight missed deductions and tax-saving opportunities identified by the enrichment engine.\n\nFINTECH API INTEGRATION HUB:\n• Provider Adapters: Plaid (aggregation), Unit (BaaS), MX (enriched aggregation), Stripe (payments), Yodlee, Moov, Alloy (KYC), Middesk (KYB) — all normalize to canonical FinTech models\n• Accounts: Depository, credit, investment, loan — with tax relevance flags (tax-advantaged, Roth, HSA, 529) and Fortuna mapping (retirement, investment, bank, liability)\n• Transactions: Enriched with 100+ tax rules — MCC codes, merchant name patterns, category mapping → Schedule C/E/A/B/D line items, deductibility, 1099 flags\n• Identity (KYC): Name, SSN, DOB, address, phone/email verification, OFAC/PEP screening, risk scoring — feeds filing profile\n• Business (KYB): EIN, entity type, formation state, officers, beneficial owners, SOS filings, TIN matching — maps to Fortuna entities\n• Investments: Holdings with cost basis, tax lots, unrealized gain/loss, security types — feeds tax-loss harvesting and portfolio intelligence\n• Liabilities: Mortgages (Form 1098), student loans (Form 1098-E), credit cards — auto-detects deductible interest with schedule references\n• Income Verification: W-2 parsing (Box 1-12 codes), pay stub analysis, bank income detection — maps to Fortuna income streams\n• Recurring Streams: Auto-detected recurring income/expenses with frequency and confidence scoring\n• Connection Manager: Multi-provider orchestration, incremental sync with cursors, health monitoring, stale data alerts\n• Transaction Enrichment Engine: 3-tier rule system (MCC → merchant name → category) with confidence scoring, custom user rules, 1099 detection, tax payment identification\nThe FinTech Hub provides the \"connect your bank\" flow that feeds live financial data into all Fortuna engines.\n\nWhen the user asks questions, draw from ALL of this data — including metamodel fields like depreciation assets, retirement accounts, goals, estimated payments, entity-level P&L, and household data — to provide comprehensive, tailored advice. Always connect recommendations back to their specific numbers. Proactively mention compound opportunities across multiple strategy areas. If the user asks about investments, positions, or portfolio strategy, reference their actual portfolio data. If asked about market conditions, reference live data from the Market Intelligence view. If asked about how to use Fortuna, guide them to specific features by name.`\n}\n\nexport function buildConversationMessages(\n  history: { role: 'user' | 'assistant'; content: string }[],\n  systemPrompt: string\n): { role: string; content: string }[] {\n  return [\n    { role: 'user', content: `[SYSTEM CONTEXT - FINANCIAL PROFILE]\\n${systemPrompt}\\n\\n[END CONTEXT]\\n\\nPlease acknowledge you have my financial profile loaded and are ready to provide strategic advice.` },\n    { role: 'assistant', content: \"I have your complete financial profile loaded with full cross-engine analysis — including multi-year tax projections, credit eligibility, depreciation optimization, and compound strategy insights. I can see specific opportunities where multiple strategies stack for maximum impact. What would you like to focus on?\" },\n    ...history,\n  ]\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\ai-documents.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TaxReport' is defined but never used.","line":18,"column":99,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":108,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TaxReport"},"fix":{"range":[714,730],"text":""},"desc":"Remove unused variable \"TaxReport\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'getAISettings' is defined but never used.","line":21,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":38,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"getAISettings"},"fix":{"range":[975,990],"text":""},"desc":"Remove unused variable \"getAISettings\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'totalIncome' is assigned a value but never used.","line":120,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":120,"endColumn":20}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — AI Document Generation\n *\n * Connects the AI advisor to the document generator to produce\n * intelligent, personalized financial documents. This is the\n * \"last mile\" that turns data + AI into deliverables.\n *\n * Document types:\n *  - CPA Summary Letter — handoff package for accountant\n *  - Entity Recommendation — S-Corp / LLC analysis memo\n *  - Year-End Tax Plan — strategic action plan\n *  - Scenario Comparison — side-by-side narrative\n *  - Tax Strategy Brief — executive summary of position\n *  - Quarterly Review — progress + adjustments\n */\n\nimport type { FortunaState } from './storage'\nimport { generateTaxReport, calculateSCorpSavings, calculateMaxSEPIRA, calculateMaxSolo401k, type TaxReport } from './tax-calculator'\nimport { generateProactiveAlerts, getFinancialPulse, getQuarterContext } from './proactive-intelligence'\nimport { detectStrategies, analyzeRisks, calculateHealthScore } from './strategy-detector'\nimport { sendAIMessage, getAISettings, type ChatMessage, type AIResponse } from './ai-providers'\n\n// ─── Types ────────────────────────────────────────────────────────────\n\nexport interface AIDocumentTemplate {\n  id: string\n  title: string\n  description: string\n  icon: string\n  category: 'tax' | 'entity' | 'planning' | 'cpa' | 'strategy'\n  estimatedMinutes: number\n}\n\nexport interface GeneratedAIDocument {\n  id: string\n  templateId: string\n  title: string\n  content: string           // HTML content\n  generatedAt: string\n  aiProvider: string\n  aiModel: string\n  tokensUsed?: number\n}\n\nexport type DocGenStatus = 'idle' | 'building-context' | 'generating' | 'complete' | 'error'\n\n// ─── Available Templates ──────────────────────────────────────────────\n\nexport const AI_DOC_TEMPLATES: AIDocumentTemplate[] = [\n  {\n    id: 'cpa-letter',\n    title: 'CPA Summary Letter',\n    description: 'Professional handoff letter for your accountant with full financial snapshot, entity structure, strategy recommendations, and open questions.',\n    icon: '📋',\n    category: 'cpa',\n    estimatedMinutes: 1,\n  },\n  {\n    id: 'entity-memo',\n    title: 'Entity Recommendation Memo',\n    description: 'Detailed analysis comparing your current structure vs. alternatives (S-Corp, LLC, C-Corp) with specific dollar savings and compliance costs.',\n    icon: '🏛️',\n    category: 'entity',\n    estimatedMinutes: 1,\n  },\n  {\n    id: 'year-end-plan',\n    title: 'Year-End Tax Action Plan',\n    description: 'Prioritized list of tax-saving moves to execute before December 31, with deadlines, dollar impacts, and step-by-step instructions.',\n    icon: '📅',\n    category: 'planning',\n    estimatedMinutes: 1,\n  },\n  {\n    id: 'tax-brief',\n    title: 'Tax Position Executive Brief',\n    description: 'One-page executive summary of your tax position: income breakdown, effective rates, risk areas, and top optimization opportunities.',\n    icon: '📊',\n    category: 'tax',\n    estimatedMinutes: 1,\n  },\n  {\n    id: 'quarterly-review',\n    title: 'Quarterly Financial Review',\n    description: 'Review of the current quarter\\'s financial performance, progress against goals, and recommended adjustments for the next quarter.',\n    icon: '📈',\n    category: 'strategy',\n    estimatedMinutes: 1,\n  },\n  {\n    id: 'scenario-comparison',\n    title: 'Scenario Comparison Report',\n    description: 'Plain-English comparison of your current financial path vs. optimized scenarios, with clear recommendations and trade-offs.',\n    icon: '⚖️',\n    category: 'strategy',\n    estimatedMinutes: 1,\n  },\n]\n\n// ─── Context Builder ──────────────────────────────────────────────────\n\nfunction buildFinancialContext(state: FortunaState): string {\n  const report = generateTaxReport(state)\n  const alerts = generateProactiveAlerts(state)\n  const pulse = getFinancialPulse(state)\n  const ctx = getQuarterContext()\n  const strategies = detectStrategies(state)\n  const risks = analyzeRisks(state)\n  const health = calculateHealthScore(state)\n\n  const { profile, incomeStreams, expenses, deductions, entities } = state\n  const activeIncome = incomeStreams.filter(s => s.isActive)\n  const activeEntities = entities.filter(e => e.isActive)\n  const activeExpenses = expenses.filter(e => e.isDeductible)\n\n  const selfEmployment = activeIncome\n    .filter(s => ['business', 'freelance'].includes(s.type))\n    .reduce((s, i) => s + i.annualAmount, 0)\n\n  const totalIncome = activeIncome.reduce((s, i) => s + i.annualAmount, 0)\n\n  // S-Corp analysis if relevant\n  let scorpAnalysis = ''\n  if (selfEmployment > 40000) {\n    const salary = Math.round(Math.max(selfEmployment * 0.5, Math.min(selfEmployment * 0.7, 80000)))\n    const savings = calculateSCorpSavings(selfEmployment, salary)\n    const maxSEP = calculateMaxSEPIRA(selfEmployment)\n    const max401k = calculateMaxSolo401k(selfEmployment, profile.age)\n    scorpAnalysis = `\nS-CORP ANALYSIS:\n  Current SE tax: $${savings.currentSETax.toLocaleString()}\n  S-Corp SE tax (salary $${salary.toLocaleString()}): $${savings.sCorpSETax.toLocaleString()}\n  Annual savings: $${savings.savings.toLocaleString()}\n  Max SEP-IRA: $${Math.round(maxSEP).toLocaleString()}\n  Max Solo 401(k): $${Math.round(max401k.total).toLocaleString()} (employee: $${Math.round(max401k.employeeDeferral).toLocaleString()} + employer: $${Math.round(max401k.employerContribution).toLocaleString()})`\n  }\n\n  return `\nTAXPAYER PROFILE:\n  Name: ${profile.name || 'Not specified'}\n  Filing Status: ${profile.filingStatus}\n  State: ${profile.state}\n  Age: ${profile.age}\n  Dependents: ${profile.dependents}\n\nINCOME STREAMS (${activeIncome.length} active):\n${activeIncome.map(s => `  - ${s.name}: $${s.annualAmount.toLocaleString()}/yr (${s.type})`).join('\\n') || '  None entered'}\n\nENTITIES (${activeEntities.length} active):\n${activeEntities.map(e => `  - ${e.name}: ${e.type} (${e.state})`).join('\\n') || '  None — operating as sole proprietor'}\n\nDEDUCTIONS:\n${deductions.map(d => `  - ${d.name}: $${d.amount.toLocaleString()} (${d.category})`).join('\\n') || '  None entered'}\n\nDEDUCTIBLE EXPENSES:\n${activeExpenses.map(e => `  - ${e.name}: $${e.annualAmount.toLocaleString()}/yr @ ${e.deductionPct}% deductible`).join('\\n') || '  None entered'}\n\nTAX CALCULATION:\n  Gross Income: $${Math.round(report.grossIncome).toLocaleString()}\n  AGI: $${Math.round(report.agi).toLocaleString()}\n  Taxable Income: $${Math.round(report.taxableIncome).toLocaleString()}\n  Federal Tax: $${Math.round(report.totalFederalTax).toLocaleString()}\n  State Tax: $${Math.round(report.stateTax).toLocaleString()}\n  SE Tax: $${Math.round(report.selfEmploymentTax).toLocaleString()}\n  Total Tax: $${Math.round(report.totalTax).toLocaleString()}\n  Effective Rate: ${report.effectiveRate.toFixed(1)}%\n  Marginal Rate: ${report.marginalRate}%\n  Net Income: $${Math.round(report.netIncome).toLocaleString()}\n  Keep Rate: ${(100 - report.effectiveRate).toFixed(1)}%\n${scorpAnalysis}\n\nQUARTER CONTEXT:\n  Current: Q${ctx.quarter} ${new Date().getFullYear()}\n  Days left in quarter: ${ctx.daysLeftInQuarter}\n  Days left in year: ${ctx.daysLeftInYear}\n  Year progress: ${Math.round(ctx.yearProgress * 100)}%\n\nHEALTH SCORE: ${health.score}/100 (${health.grade})\n  ${health.factors.map(f => `${f.label}: ${f.score}/${f.maxScore}`).join(', ')}\n\nFINANCIAL PULSE:\n  ${pulse.headline}\n  ${pulse.subheadline}\n  Urgent alerts: ${pulse.urgentCount}\n  Opportunities: ${pulse.opportunityCount}\n  Estimated savings available: $${Math.round(pulse.estimatedSavingsAvailable).toLocaleString()}\n  ${pulse.nextDeadline ? `Next deadline: ${pulse.nextDeadline.name} in ${pulse.nextDeadline.daysUntil} days` : ''}\n\nACTIVE ALERTS:\n${alerts.slice(0, 8).map(a => `  [${a.severity.toUpperCase()}] ${a.title}: ${a.message.substring(0, 120)}...`).join('\\n') || '  None'}\n\nDETECTED STRATEGIES:\n${strategies.slice(0, 6).map(s => `  [${s.priority}] ${s.title}: ${s.description.substring(0, 100)}...`).join('\\n') || '  None detected'}\n\nRISK FACTORS:\n${risks.slice(0, 5).map(r => `  [${r.severity}] ${r.title}: ${r.description.substring(0, 100)}...`).join('\\n') || '  None detected'}\n`.trim()\n}\n\n// ─── Document Prompts ─────────────────────────────────────────────────\n\nconst DOC_PROMPTS: Record<string, (ctx: string) => { system: string; user: string }> = {\n  'cpa-letter': (ctx) => ({\n    system: `You are a senior tax strategist writing a professional letter to a CPA on behalf of a client. Write in a clear, professional tone that assumes the CPA is knowledgeable. Include specific numbers, actionable items, and flag anything that needs the CPA's expert judgment. Format the output as clean HTML with professional styling. Use <h2>, <h3>, <p>, <ul>, <li>, <table> tags as needed. Do NOT include <html>, <head>, or <body> tags — just the content div.`,\n    user: `Write a comprehensive CPA handoff letter based on this client's financial data. Include:\n\n1. Executive summary of the client's tax position\n2. Income breakdown by source and type\n3. Current entity structure and any recommended changes\n4. Key deductions and potential gaps\n5. Estimated tax liability and quarterly payment schedule\n6. Top 3-5 strategy recommendations with dollar impacts\n7. Risk areas that need CPA review\n8. Open questions for the CPA to address\n\nCLIENT DATA:\n${ctx}\n\nFormat as a professional letter with sections. Include specific dollar amounts and percentages throughout.`,\n  }),\n\n  'entity-memo': (ctx) => ({\n    system: `You are a tax advisory firm writing an internal analysis memo. Be precise with numbers, compare options objectively, and provide a clear recommendation. Include setup costs, ongoing compliance burden, and break-even timeline. Format as clean HTML content.`,\n    user: `Write a detailed entity structure recommendation memo based on this client's data. Include:\n\n1. Current structure analysis — what they have, how it's taxed\n2. Option comparison table: Sole Prop vs LLC (disregarded) vs LLC (S-Corp) vs C-Corp\n   - For each: total tax, SE/payroll tax, compliance cost, liability protection\n3. Recommended structure with specific reasoning\n4. Implementation timeline and steps\n5. Ongoing compliance requirements\n6. Risk factors and caveats\n7. Dollar savings analysis for recommended structure vs. current\n\nCLIENT DATA:\n${ctx}\n\nBe specific with dollar amounts. If S-Corp makes sense, specify the recommended reasonable salary and show the math.`,\n  }),\n\n  'year-end-plan': (ctx) => ({\n    system: `You are a proactive financial planner creating an actionable year-end tax strategy document. Every item should have a specific deadline, dollar impact, and clear instructions. Prioritize by impact. Format as clean HTML content.`,\n    user: `Create a year-end tax action plan based on this client's current position. Include:\n\n1. Executive summary: Current position and total potential savings\n2. Priority actions (ordered by impact):\n   - For each: What to do, deadline, estimated tax savings, how to execute\n3. Retirement contribution strategy before year-end\n4. Deduction acceleration opportunities\n5. Income deferral possibilities\n6. Equipment/asset purchase analysis (Section 179)\n7. Entity elections or changes to consider\n8. Calendar view of remaining deadlines\n9. Documents and information to gather\n\nCLIENT DATA:\n${ctx}\n\nBe specific and actionable. Every recommendation should have a dollar amount and a deadline.`,\n  }),\n\n  'tax-brief': (ctx) => ({\n    system: `You are writing a one-page executive brief for a busy business owner. Be concise, visual, and focus on the numbers that matter. Use tables and clean formatting. This should be scannable in under 2 minutes. Format as clean HTML content.`,\n    user: `Create a one-page tax position executive brief based on this client's data. Include:\n\n1. Financial snapshot: income, taxes, effective rate, net keep\n2. Key metrics in a summary table\n3. Biggest risk (one sentence)\n4. Biggest opportunity (one sentence with dollar amount)\n5. Next action item (specific, with deadline)\n6. Health score and what's dragging it down\n7. Quarter context — what needs attention NOW\n\nCLIENT DATA:\n${ctx}\n\nKeep it to what fits on one page. Prioritize impact over completeness.`,\n  }),\n\n  'quarterly-review': (ctx) => ({\n    system: `You are a CFO-level advisor writing a quarterly financial review. Be analytical, forward-looking, and tie everything back to actionable adjustments. Format as clean HTML content.`,\n    user: `Write a quarterly financial review based on this client's current data. Include:\n\n1. Quarter summary — where things stand\n2. Income performance vs. annual trajectory\n3. Tax liability tracking — on pace, ahead, or behind\n4. Strategy implementation status — what's been done, what hasn't\n5. Retirement savings progress\n6. Risk factors that emerged or changed\n7. Recommended adjustments for next quarter\n8. Key deadlines in the upcoming quarter\n\nCLIENT DATA:\n${ctx}\n\nFrame this as a periodic check-in. Highlight what changed and what needs attention.`,\n  }),\n\n  'scenario-comparison': (ctx) => ({\n    system: `You are writing a clear, balanced comparison report. Present both current path and optimized path with specific numbers. Use tables for side-by-side comparison. Help the reader make an informed decision. Format as clean HTML content.`,\n    user: `Write a scenario comparison report based on this client's data. Compare:\n\nScenario A: Current Path (status quo — no changes)\nScenario B: Optimized Path (implementing top recommended strategies)\n\nInclude for each scenario:\n1. Total annual tax\n2. Effective tax rate\n3. Net take-home\n4. Compliance costs\n5. Risk level\n\nThen:\n6. Delta analysis — exact dollar difference\n7. Break-even timeline for any upfront costs\n8. Implementation complexity rating\n9. Clear recommendation with reasoning\n10. What they're leaving on the table if they stay on current path\n\nCLIENT DATA:\n${ctx}\n\nUse a comparison table as the centerpiece. Make the savings crystal clear.`,\n  }),\n}\n\n// ─── Document Styling ─────────────────────────────────────────────────\n\nconst DOC_STYLES = `\n<style>\n  .ai-doc { font-family: 'Inter', -apple-system, sans-serif; color: #1a1a2e; line-height: 1.6; max-width: 800px; }\n  .ai-doc h1 { font-size: 22px; color: #0a0e1a; border-bottom: 2px solid #f59e0b; padding-bottom: 8px; margin-top: 0; }\n  .ai-doc h2 { font-size: 17px; color: #1e293b; margin-top: 24px; margin-bottom: 8px; }\n  .ai-doc h3 { font-size: 14px; color: #334155; margin-top: 16px; margin-bottom: 6px; }\n  .ai-doc p { margin: 8px 0; font-size: 13px; }\n  .ai-doc ul, .ai-doc ol { margin: 8px 0; padding-left: 20px; font-size: 13px; }\n  .ai-doc li { margin-bottom: 4px; }\n  .ai-doc table { width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 12px; }\n  .ai-doc th { text-align: left; padding: 8px 10px; background: #f8fafc; border-bottom: 2px solid #e2e8f0; font-weight: 600; color: #475569; }\n  .ai-doc td { padding: 6px 10px; border-bottom: 1px solid #f1f5f9; }\n  .ai-doc tr:hover td { background: #fefce8; }\n  .ai-doc .highlight { background: rgba(245,158,11,0.08); border-left: 3px solid #f59e0b; padding: 10px 14px; border-radius: 0 6px 6px 0; margin: 12px 0; }\n  .ai-doc .metric { display: inline-block; background: #f8fafc; padding: 3px 8px; border-radius: 4px; font-weight: 600; font-size: 13px; }\n  .ai-doc .urgent { color: #dc2626; font-weight: 600; }\n  .ai-doc .savings { color: #059669; font-weight: 600; }\n  .ai-doc .generated-footer { margin-top: 24px; padding-top: 12px; border-top: 1px solid #e2e8f0; font-size: 11px; color: #94a3b8; }\n</style>`\n\n// ─── Generate Document ────────────────────────────────────────────────\n\nexport async function generateAIDocument(\n  templateId: string,\n  state: FortunaState,\n  onStatus?: (status: DocGenStatus) => void,\n): Promise<GeneratedAIDocument> {\n  const template = AI_DOC_TEMPLATES.find(t => t.id === templateId)\n  if (!template) throw new Error(`Unknown template: ${templateId}`)\n\n  const promptBuilder = DOC_PROMPTS[templateId]\n  if (!promptBuilder) throw new Error(`No prompt defined for: ${templateId}`)\n\n  // Phase 1: Build context\n  onStatus?.('building-context')\n  const financialContext = buildFinancialContext(state)\n\n  // Phase 2: Build prompts\n  const { system, user } = promptBuilder(financialContext)\n\n  // Phase 3: Generate via AI\n  onStatus?.('generating')\n  const messages: ChatMessage[] = [{ role: 'user', content: user }]\n\n  const response: AIResponse = await sendAIMessage(messages, system)\n\n  // Phase 4: Wrap in styled document\n  onStatus?.('complete')\n\n  const now = new Date()\n  const footer = `\n    <div class=\"generated-footer\">\n      Generated by Fortuna Engine AI • ${now.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })} at ${now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}\n      • Provider: ${response.provider}/${response.model}\n      ${response.usage ? `• Tokens: ${(response.usage.input_tokens || 0) + (response.usage.output_tokens || 0)}` : ''}\n    </div>`\n\n  const content = `${DOC_STYLES}<div class=\"ai-doc\">${response.text}${footer}</div>`\n\n  return {\n    id: `aidoc-${templateId}-${Date.now()}`,\n    templateId,\n    title: `${template.title} — ${now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`,\n    content,\n    generatedAt: now.toISOString(),\n    aiProvider: response.provider,\n    aiModel: response.model,\n    tokensUsed: response.usage\n      ? (response.usage.input_tokens || 0) + (response.usage.output_tokens || 0)\n      : undefined,\n  }\n}\n\n// ─── Storage ──────────────────────────────────────────────────────────\n\nconst STORAGE_KEY = 'fortuna:ai-documents'\n\nexport function saveAIDocument(doc: GeneratedAIDocument): void {\n  const docs = getAIDocuments()\n  docs.unshift(doc)\n  // Keep last 50\n  if (docs.length > 50) docs.length = 50\n  localStorage.setItem(STORAGE_KEY, JSON.stringify(docs))\n}\n\nexport function getAIDocuments(): GeneratedAIDocument[] {\n  try {\n    const raw = localStorage.getItem(STORAGE_KEY)\n    return raw ? JSON.parse(raw) : []\n  } catch { return [] }\n}\n\nexport function deleteAIDocument(id: string): void {\n  const docs = getAIDocuments().filter(d => d.id !== id)\n  localStorage.setItem(STORAGE_KEY, JSON.stringify(docs))\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\ai-providers.ts","messages":[{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":104,"column":11,"nodeType":"BlockStatement","messageId":"unexpected","endLine":104,"endColumn":13,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[2699,2699],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":148,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":148,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3897,3900],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3897,3900],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":200,"column":11,"nodeType":"BlockStatement","messageId":"unexpected","endLine":200,"endColumn":13,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[5391,5391],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":225,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":225,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6108,6111],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6108,6111],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":226,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":226,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6148,6151],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6148,6151],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":289,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":289,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8098,8101],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8098,8101],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":289,"column":83,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":289,"endColumn":86,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8133,8136],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8133,8136],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":295,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":295,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8401,8404],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8401,8404],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":320,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":320,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9360,9363],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9360,9363],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":342,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":342,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10071,10074],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10071,10074],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":372,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":372,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11144,11147],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11144,11147],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":11,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — Multi-Provider AI Client\n * \n * Supports Anthropic, OpenAI, Google Gemini, and OpenRouter.\n * Two modes:\n *   1. Server proxy (keys on server) — preferred, secure\n *   2. Direct browser calls (user enters own keys) — fallback\n */\n\n// ============================================\n//  TYPES\n// ============================================\n\nexport type ProviderId = 'anthropic' | 'openai' | 'gemini' | 'openrouter'\n\nexport interface ProviderConfig {\n  id: ProviderId\n  name: string\n  models: string[]\n  defaultModel: string\n}\n\nexport interface AISettings {\n  mode: 'proxy' | 'direct'          // proxy = server keys, direct = browser keys\n  provider: ProviderId\n  model: string\n  // Client-side keys (only used in 'direct' mode)\n  clientKeys: Partial<Record<ProviderId, string>>\n}\n\nexport interface ChatMessagePart {\n  type: 'text' | 'image_url'\n  text?: string\n  image_url?: {\n    url: string // e.g., \"data:image/jpeg;base64,...\"\n  }\n}\n\nexport interface ChatMessage {\n  role: 'user' | 'assistant'\n  content: string | ChatMessagePart[]\n}\n\nexport interface AIResponse {\n  text: string\n  provider: ProviderId\n  model: string\n  usage?: { input_tokens?: number; output_tokens?: number }\n}\n\n// ============================================\n//  DEFAULT PROVIDERS (for direct mode)\n// ============================================\n\nexport const DEFAULT_PROVIDERS: ProviderConfig[] = [\n  {\n    id: 'anthropic',\n    name: 'Anthropic (Claude)',\n    models: ['claude-sonnet-4-20250514', 'claude-haiku-4-5-20251001'],\n    defaultModel: 'claude-sonnet-4-20250514',\n  },\n  {\n    id: 'openai',\n    name: 'OpenAI (GPT)',\n    models: ['gpt-4o', 'gpt-4o-mini', 'gpt-4-turbo', 'o3-mini'],\n    defaultModel: 'gpt-4o',\n  },\n  {\n    id: 'gemini',\n    name: 'Google Gemini',\n    models: ['gemini-2.0-flash', 'gemini-2.0-flash-lite', 'gemini-1.5-pro', 'gemini-1.5-flash'],\n    defaultModel: 'gemini-2.0-flash',\n  },\n  {\n    id: 'openrouter',\n    name: 'OpenRouter',\n    models: [\n      'anthropic/claude-sonnet-4',\n      'anthropic/claude-haiku-4',\n      'openai/gpt-4o',\n      'openai/gpt-4o-mini',\n      'google/gemini-2.0-flash-001',\n      'deepseek/deepseek-chat-v3-0324',\n      'meta-llama/llama-4-maverick',\n      'mistralai/mistral-large-2411',\n    ],\n    defaultModel: 'anthropic/claude-sonnet-4',\n  },\n]\n\n// ============================================\n//  SETTINGS PERSISTENCE\n// ============================================\n\nconst SETTINGS_KEY = 'fortuna:ai-settings'\n\nexport function getAISettings(): AISettings {\n  try {\n    const raw = localStorage.getItem(SETTINGS_KEY)\n    if (raw) {\n      const parsed = JSON.parse(raw)\n      return { ...defaultSettings(), ...parsed }\n    }\n  } catch {}\n  return defaultSettings()\n}\n\nexport function saveAISettings(settings: AISettings): void {\n  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings))\n}\n\nfunction defaultSettings(): AISettings {\n  return {\n    mode: 'proxy',\n    provider: 'openrouter',\n    model: 'anthropic/claude-sonnet-4',\n    clientKeys: {},\n  }\n}\n\n// ============================================\n//  FETCH SERVER PROVIDERS\n// ============================================\n\nexport async function fetchServerProviders(): Promise<{\n  providers: ProviderConfig[]\n  defaultProvider: ProviderId\n  clientKeysAllowed: boolean\n} | null> {\n  try {\n    const apiConfig = localStorage.getItem('fortuna:api-config')\n    if (!apiConfig) return null\n    \n    const { baseUrl } = JSON.parse(apiConfig)\n    const accessToken = localStorage.getItem('fortuna:access-token')\n    \n    const res = await fetch(`${baseUrl}/advisor.php?action=providers`, {\n      headers: {\n        'Content-Type': 'application/json',\n        ...(accessToken ? { 'Authorization': `Bearer ${accessToken}` } : {}),\n      },\n    })\n    \n    if (!res.ok) return null\n    const data = await res.json()\n    \n    return {\n      providers: (data.providers || []).map((p: any) => ({\n        id: p.id,\n        name: p.name,\n        models: p.models,\n        defaultModel: p.default_model,\n      })),\n      defaultProvider: data.default_provider,\n      clientKeysAllowed: data.client_keys_allowed ?? true,\n    }\n  } catch {\n    return null\n  }\n}\n\n// ============================================\n//  SEND MESSAGE (UNIFIED)\n// ============================================\n\nexport async function sendAIMessage(\n  messages: ChatMessage[],\n  system: string,\n  settings?: AISettings,\n): Promise<AIResponse> {\n  const s = settings || getAISettings()\n  \n  if (s.mode === 'proxy') {\n    return sendViaProxy(messages, system, s)\n  } else {\n    return sendDirect(messages, system, s)\n  }\n}\n\n// ============================================\n//  PROXY MODE (server-side keys)\n// ============================================\n\nasync function sendViaProxy(\n  messages: ChatMessage[],\n  system: string,\n  settings: AISettings,\n): Promise<AIResponse> {\n  const apiConfig = localStorage.getItem('fortuna:api-config')\n  if (!apiConfig) throw new Error('API not configured. Set up your backend URL or switch to direct mode.')\n  \n  const { baseUrl } = JSON.parse(apiConfig)\n  const accessToken = localStorage.getItem('fortuna:access-token')\n  \n  // Include active workspace ID so server can use workspace shared keys\n  let workspaceId: number | undefined\n  try {\n    const wsRaw = localStorage.getItem('fortuna:active-workspace')\n    if (wsRaw) workspaceId = JSON.parse(wsRaw).id\n  } catch {}\n  \n  const res = await fetch(`${baseUrl}/advisor.php`, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      ...(accessToken ? { 'Authorization': `Bearer ${accessToken}` } : {}),\n    },\n    body: JSON.stringify({\n      messages: messages.map(m => ({ role: m.role, content: m.content })),\n      system,\n      provider: settings.provider,\n      model: settings.model,\n      max_tokens: 4000,\n      ...(workspaceId ? { workspace_id: workspaceId } : {}),\n    }),\n  })\n  \n  if (!res.ok) {\n    const err = await res.json().catch(() => ({}))\n    throw new Error(err.message || `Proxy error: ${res.status}`)\n  }\n  \n  const data = await res.json()\n  const text = data.content\n    ?.filter((b: any) => b.type === 'text')\n    .map((b: any) => b.text)\n    .join('\\n') || ''\n  \n  return {\n    text,\n    provider: data.provider || settings.provider,\n    model: data.model || settings.model,\n    usage: data.usage,\n  }\n}\n\n// ============================================\n//  DIRECT MODE (browser-side keys)\n// ============================================\n\nasync function sendDirect(\n  messages: ChatMessage[],\n  system: string,\n  settings: AISettings,\n): Promise<AIResponse> {\n  const apiKey = settings.clientKeys[settings.provider]\n  if (!apiKey) {\n    throw new Error(`No API key configured for ${settings.provider}. Add your key in AI Settings.`)\n  }\n  \n  switch (settings.provider) {\n    case 'anthropic':\n      return directAnthropic(messages, system, settings.model, apiKey)\n    case 'openai':\n      return directOpenAI(messages, system, settings.model, apiKey)\n    case 'gemini':\n      return directGemini(messages, system, settings.model, apiKey)\n    case 'openrouter':\n      return directOpenRouter(messages, system, settings.model, apiKey)\n    default:\n      throw new Error(`Unknown provider: ${settings.provider}`)\n  }\n}\n\n// ---- Anthropic Direct ----\nasync function directAnthropic(messages: ChatMessage[], system: string, model: string, apiKey: string): Promise<AIResponse> {\n  const res = await fetch('https://api.anthropic.com/v1/messages', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'x-api-key': apiKey,\n      'anthropic-version': '2023-06-01',\n      'anthropic-dangerous-direct-browser-access': 'true',\n    },\n    body: JSON.stringify({\n      model,\n      max_tokens: 4000,\n      system: system || undefined,\n      messages: messages.map(m => ({ role: m.role, content: m.content })),\n    }),\n  })\n  \n  if (!res.ok) {\n    const err = await res.json().catch(() => ({}))\n    throw new Error(err.error?.message || `Anthropic error: ${res.status}`)\n  }\n  \n  const data = await res.json()\n  const text = (data.content || []).filter((b: any) => b.type === 'text').map((b: any) => b.text).join('\\n')\n  return { text, provider: 'anthropic', model, usage: data.usage }\n}\n\n// ---- OpenAI Direct ----\nasync function directOpenAI(messages: ChatMessage[], system: string, model: string, apiKey: string): Promise<AIResponse> {\n  const apiMessages: any[] = []\n  if (system) apiMessages.push({ role: 'system', content: system })\n  messages.forEach(m => apiMessages.push({ role: m.role, content: m.content }))\n  \n  const res = await fetch('https://api.openai.com/v1/chat/completions', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${apiKey}`,\n    },\n    body: JSON.stringify({ model, max_tokens: 4000, messages: apiMessages, temperature: 0.7 }),\n  })\n  \n  if (!res.ok) {\n    const err = await res.json().catch(() => ({}))\n    throw new Error(err.error?.message || `OpenAI error: ${res.status}`)\n  }\n  \n  const data = await res.json()\n  return { text: data.choices[0]?.message?.content || '', provider: 'openai', model, usage: data.usage }\n}\n\n// ---- Gemini Direct ----\nasync function directGemini(messages: ChatMessage[], system: string, model: string, apiKey: string): Promise<AIResponse> {\n  const contents = messages.map(m => {\n    let parts: any[] = []\n    if (typeof m.content === 'string') {\n      parts = [{ text: m.content }]\n    } else {\n      parts = m.content.map(part => {\n        if (part.type === 'text') return { text: part.text }\n        if (part.type === 'image_url' && part.image_url) {\n          // Gemini expects base64 data without the data:image/jpeg;base64, prefix\n          const match = part.image_url.url.match(/^data:(image\\/[a-z]+);base64,(.*)$/)\n          if (match) {\n            return { inlineData: { mimeType: match[1], data: match[2] } }\n          }\n        }\n        return null\n      }).filter(Boolean)\n    }\n    return {\n      role: m.role === 'assistant' ? 'model' : 'user',\n      parts,\n    }\n  })\n  \n  const payload: any = {\n    contents,\n    generationConfig: { maxOutputTokens: 4000, temperature: 0.7 },\n  }\n  if (system) {\n    payload.systemInstruction = { parts: [{ text: system }] }\n  }\n  \n  const res = await fetch(\n    `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,\n    { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }\n  )\n  \n  if (!res.ok) {\n    const err = await res.json().catch(() => ({}))\n    throw new Error(err.error?.message || `Gemini error: ${res.status}`)\n  }\n  \n  const data = await res.json()\n  const text = data.candidates?.[0]?.content?.parts?.[0]?.text || ''\n  const usage = data.usageMetadata ? {\n    input_tokens: data.usageMetadata.promptTokenCount,\n    output_tokens: data.usageMetadata.candidatesTokenCount,\n  } : undefined\n  \n  return { text, provider: 'gemini', model, usage }\n}\n\n// ---- OpenRouter Direct ----\nasync function directOpenRouter(messages: ChatMessage[], system: string, model: string, apiKey: string): Promise<AIResponse> {\n  const apiMessages: any[] = []\n  if (system) apiMessages.push({ role: 'system', content: system })\n  messages.forEach(m => apiMessages.push({ role: m.role, content: m.content }))\n  \n  const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${apiKey}`,\n      'HTTP-Referer': 'https://fortuna.unlessrx.com',\n      'X-Title': 'Fortuna Engine',\n    },\n    body: JSON.stringify({ model, max_tokens: 4000, messages: apiMessages }),\n  })\n  \n  if (!res.ok) {\n    const err = await res.json().catch(() => ({}))\n    throw new Error(err.error?.message || `OpenRouter error: ${res.status}`)\n  }\n  \n  const data = await res.json()\n  return { text: data.choices[0]?.message?.content || '', provider: 'openrouter', model, usage: data.usage }\n}\n\n// ============================================\n//  UTILITIES\n// ============================================\n\nexport function getProviderIcon(id: ProviderId): string {\n  const icons: Record<ProviderId, string> = {\n    anthropic: '🟠',\n    openai: '🟢',\n    gemini: '🔵',\n    openrouter: '🟣',\n  }\n  return icons[id] || '⚪'\n}\n\nexport function getModelDisplayName(model: string): string {\n  // Shorten long model names\n  return model\n    .replace('claude-sonnet-4-20250514', 'Claude Sonnet 4')\n    .replace('claude-haiku-4-5-20251001', 'Claude Haiku 4.5')\n    .replace('anthropic/claude-sonnet-4', 'Claude Sonnet 4')\n    .replace('anthropic/claude-haiku-4', 'Claude Haiku 4')\n    .replace('openai/', '')\n    .replace('google/', '')\n    .replace('deepseek/', '')\n    .replace('meta-llama/', '')\n    .replace('mistralai/', '')\n    .replace('qwen/', '')\n    .replace('gemini-2.0-flash-001', 'Gemini 2.0 Flash')\n    .replace('gemini-2.0-flash-lite', 'Gemini 2.0 Flash Lite')\n    .replace('gemini-2.0-flash', 'Gemini 2.0 Flash')\n    .replace('gemini-1.5-pro', 'Gemini 1.5 Pro')\n    .replace('gemini-1.5-flash', 'Gemini 1.5 Flash')\n    .replace('deepseek-chat-v3-0324', 'DeepSeek V3')\n    .replace('llama-4-maverick', 'Llama 4 Maverick')\n    .replace('mistral-large-2411', 'Mistral Large')\n    .replace('qwen-2.5-72b-instruct', 'Qwen 2.5 72B')\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\api-cache.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\api-client.ts","messages":[{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":25,"column":11,"nodeType":"BlockStatement","messageId":"unexpected","endLine":25,"endColumn":13,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[628,628],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":181,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":181,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4474,4477],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4474,4477],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":186,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":186,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4547,4550],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4547,4550],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":325,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":325,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8590,8593],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8590,8593],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":343,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":343,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9054,9057],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9054,9057],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":351,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":351,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9215,9218],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9215,9218],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":371,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":371,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9698,9701],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9698,9701],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":374,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":374,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9825,9828],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9825,9828],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":403,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":403,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10483,10486],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10483,10486],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":9,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — API Client\n * \n * HTTP wrapper for the PHP backend with automatic token refresh,\n * retry logic, and error normalization.\n */\n\n// ============================================\n//  CONFIGURATION\n// ============================================\n\nconst API_CONFIG_KEY = 'fortuna:api-config'\n\ninterface APIConfig {\n  baseUrl: string  // e.g. \"https://yourdomain.com/api\"\n}\n\nfunction getAPIConfig(): APIConfig {\n  try {\n    const raw = localStorage.getItem(API_CONFIG_KEY)\n    if (raw) {\n      const parsed = JSON.parse(raw)\n      if (parsed.baseUrl && parsed.baseUrl !== '/api') return parsed\n    }\n  } catch {}\n  // Auto-detect: same origin + /api\n  return { baseUrl: `${window.location.origin}/api` }\n}\n\nexport function setAPIBaseUrl(url: string): void {\n  localStorage.setItem(API_CONFIG_KEY, JSON.stringify({ baseUrl: url.replace(/\\/$/, '') }))\n}\n\nexport function getAPIBaseUrl(): string {\n  return getAPIConfig().baseUrl\n}\n\n// ============================================\n//  TOKEN MANAGEMENT\n// ============================================\n\nconst TOKEN_KEYS = {\n  ACCESS: 'fortuna:access-token',\n  REFRESH: 'fortuna:refresh-token',\n  USER: 'fortuna:user',\n} as const\n\nexport interface AuthUser {\n  uuid: string\n  email: string\n  display_name: string | null\n  created_at: string\n}\n\nexport interface AuthTokens {\n  access_token: string\n  refresh_token: string\n  expires_in: number\n  token_type: string\n}\n\nexport function getStoredTokens(): { access: string | null; refresh: string | null } {\n  return {\n    access: localStorage.getItem(TOKEN_KEYS.ACCESS),\n    refresh: localStorage.getItem(TOKEN_KEYS.REFRESH),\n  }\n}\n\nexport function storeTokens(tokens: AuthTokens): void {\n  localStorage.setItem(TOKEN_KEYS.ACCESS, tokens.access_token)\n  localStorage.setItem(TOKEN_KEYS.REFRESH, tokens.refresh_token)\n}\n\nexport function storeUser(user: AuthUser): void {\n  localStorage.setItem(TOKEN_KEYS.USER, JSON.stringify(user))\n}\n\nexport function getStoredUser(): AuthUser | null {\n  try {\n    const raw = localStorage.getItem(TOKEN_KEYS.USER)\n    return raw ? JSON.parse(raw) : null\n  } catch { return null }\n}\n\nexport function clearAuthData(): void {\n  localStorage.removeItem(TOKEN_KEYS.ACCESS)\n  localStorage.removeItem(TOKEN_KEYS.REFRESH)\n  localStorage.removeItem(TOKEN_KEYS.USER)\n}\n\n// ============================================\n//  API ERROR CLASS\n// ============================================\n\nexport class APIError extends Error {\n  constructor(\n    message: string,\n    public status: number,\n    public code?: string\n  ) {\n    super(message)\n    this.name = 'APIError'\n  }\n}\n\n// ============================================\n//  CORE HTTP METHODS\n// ============================================\n\nlet isRefreshing = false\nlet refreshQueue: Array<(token: string) => void> = []\n\nasync function refreshAccessToken(): Promise<string | null> {\n  const { refresh } = getStoredTokens()\n  if (!refresh) return null\n\n  try {\n    const config = getAPIConfig()\n    const res = await fetch(`${config.baseUrl}/auth.php?action=refresh`, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ refresh_token: refresh }),\n    })\n\n    if (!res.ok) {\n      clearAuthData()\n      return null\n    }\n\n    const data = await res.json()\n    if (data.success && data.tokens) {\n      storeTokens(data.tokens)\n      return data.tokens.access_token\n    }\n    \n    clearAuthData()\n    return null\n  } catch {\n    return null\n  }\n}\n\nasync function getValidAccessToken(): Promise<string | null> {\n  const { access } = getStoredTokens()\n  if (!access) return null\n\n  // Quick JWT expiry check (decode payload without verification)\n  try {\n    const payload = JSON.parse(atob(access.split('.')[1]))\n    const expiresAt = payload.exp * 1000\n    const bufferMs = 60_000 // Refresh 1 min before expiry\n    \n    if (Date.now() < expiresAt - bufferMs) {\n      return access // Still valid\n    }\n  } catch {\n    // Can't parse - try refresh\n  }\n\n  // Token expired or about to expire - refresh it\n  if (isRefreshing) {\n    // Wait for ongoing refresh\n    return new Promise(resolve => {\n      refreshQueue.push(resolve)\n    })\n  }\n\n  isRefreshing = true\n  const newToken = await refreshAccessToken()\n  isRefreshing = false\n\n  // Resolve queued requests\n  refreshQueue.forEach(resolve => resolve(newToken || ''))\n  refreshQueue = []\n\n  return newToken\n}\n\ninterface RequestOptions {\n  method?: 'GET' | 'POST' | 'PUT' | 'DELETE'\n  body?: any\n  auth?: boolean\n  retries?: number\n}\n\nasync function apiRequest<T = any>(\n  endpoint: string,\n  options: RequestOptions = {}\n): Promise<T> {\n  const { method = 'GET', body, auth = true, retries = 1 } = options\n  const config = getAPIConfig()\n  const url = `${config.baseUrl}/${endpoint}`\n\n  const headers: Record<string, string> = {\n    'Content-Type': 'application/json',\n  }\n\n  if (auth) {\n    const token = await getValidAccessToken()\n    if (!token) {\n      throw new APIError('Not authenticated', 401, 'AUTH_REQUIRED')\n    }\n    headers['Authorization'] = `Bearer ${token}`\n  }\n\n  const fetchOptions: RequestInit = { method, headers }\n  if (body && method !== 'GET') {\n    fetchOptions.body = JSON.stringify(body)\n  }\n\n  let lastError: Error | null = null\n\n  for (let attempt = 0; attempt <= retries; attempt++) {\n    try {\n      const res = await fetch(url, fetchOptions)\n      \n      // Handle 401 - try token refresh once\n      if (res.status === 401 && auth && attempt === 0) {\n        const newToken = await refreshAccessToken()\n        if (newToken) {\n          headers['Authorization'] = `Bearer ${newToken}`\n          continue // Retry with new token\n        }\n        throw new APIError('Session expired. Please log in again.', 401, 'TOKEN_EXPIRED')\n      }\n\n      // Detect HTML responses (SPA fallback when backend is unavailable)\n      const contentType = res.headers.get('content-type') || ''\n      if (contentType.includes('text/html') || (!contentType.includes('json') && res.status === 200)) {\n        const text = await res.text()\n        if (text.trimStart().startsWith('<!DOCTYPE') || text.trimStart().startsWith('<html')) {\n          throw new APIError(\n            'Backend API is not available. Use offline mode to continue with local storage.',\n            503,\n            'BACKEND_UNAVAILABLE'\n          )\n        }\n      }\n\n      const data = await res.json()\n\n      if (!res.ok || data.error) {\n        throw new APIError(\n          data.message || `Request failed (${res.status})`,\n          res.status,\n          data.code\n        )\n      }\n\n      return data as T\n    } catch (e) {\n      if (e instanceof APIError) throw e\n      lastError = e instanceof Error ? e : new Error(String(e))\n      \n      // Only retry on network errors, not backend-unavailable\n      if (lastError.message?.includes('not valid JSON') || lastError.message?.includes('Unexpected token')) {\n        throw new APIError(\n          'Backend API is not available. Use offline mode to continue with local storage.',\n          503,\n          'BACKEND_UNAVAILABLE'\n        )\n      }\n      if (attempt < retries) {\n        await new Promise(r => setTimeout(r, 1000 * (attempt + 1)))\n      }\n    }\n  }\n\n  throw new APIError(\n    lastError?.message || 'Network error - check your connection',\n    0,\n    'NETWORK_ERROR'\n  )\n}\n\n// ============================================\n//  AUTH API\n// ============================================\n\nexport const AuthAPI = {\n  async register(email: string, password: string, displayName?: string) {\n    const data = await apiRequest<{\n      success: boolean\n      user: AuthUser\n      tokens: AuthTokens\n    }>('auth.php?action=register', {\n      method: 'POST',\n      body: { email, password, display_name: displayName },\n      auth: false,\n    })\n    storeTokens(data.tokens)\n    storeUser(data.user)\n    return data\n  },\n\n  async login(email: string, password: string) {\n    const data = await apiRequest<{\n      success: boolean\n      user: AuthUser\n      tokens: AuthTokens\n    }>('auth.php?action=login', {\n      method: 'POST',\n      body: { email, password },\n      auth: false,\n    })\n    storeTokens(data.tokens)\n    storeUser(data.user)\n    return data\n  },\n\n  async logout(allDevices = false) {\n    const { refresh } = getStoredTokens()\n    try {\n      await apiRequest('auth.php?action=logout', {\n        method: 'POST',\n        body: { refresh_token: refresh, all_devices: allDevices },\n      })\n    } catch {\n      // Logout locally even if API fails\n    }\n    clearAuthData()\n  },\n\n  async getProfile() {\n    return apiRequest<{ user: AuthUser; state_meta: any }>('auth.php?action=me')\n  },\n\n  async updateProfile(updates: { display_name?: string; email?: string; current_password?: string; new_password?: string }) {\n    return apiRequest('auth.php?action=update', {\n      method: 'PUT',\n      body: updates,\n    })\n  },\n}\n\n// ============================================\n//  STATE SYNC API\n// ============================================\n\nexport const StateAPI = {\n  async load() {\n    return apiRequest<{\n      state: any\n      version: number\n      checksum: string | null\n      last_synced_at: string | null\n      is_new?: boolean\n    }>('state.php')\n  },\n\n  async save(state: any, expectedVersion?: number, force = false) {\n    return apiRequest<{\n      version: number\n      checksum: string\n      synced_at: string\n      skipped?: boolean\n    }>('state.php', {\n      method: 'POST',\n      body: { state, expected_version: expectedVersion, force },\n    })\n  },\n\n  async getMeta() {\n    return apiRequest<{\n      version: number\n      checksum: string | null\n      last_synced_at: string | null\n    }>('state.php?action=meta')\n  },\n\n  async merge(localState: any, localTimestamp?: string) {\n    return apiRequest<{\n      resolution: 'local_wins' | 'remote_wins' | 'merged'\n      state: any\n      version: number\n      message: string\n    }>('state.php?action=merge', {\n      method: 'POST',\n      body: { local_state: localState, local_timestamp: localTimestamp },\n    })\n  },\n\n  async listSnapshots() {\n    return apiRequest<{\n      snapshots: Array<{\n        id: number\n        state_version: number\n        snapshot_reason: string\n        created_at: string\n      }>\n    }>('state.php?action=snapshots')\n  },\n\n  async createSnapshot(reason = 'manual') {\n    return apiRequest('state.php?action=snapshot', {\n      method: 'POST',\n      body: { reason },\n    })\n  },\n\n  async restoreSnapshot(id: number) {\n    return apiRequest<{\n      state: any\n      restored_from_version: number\n    }>(`state.php?action=restore&id=${id}`)\n  },\n}\n\n// ============================================\n//  CONNECTION TEST\n// ============================================\n\nexport async function testAPIConnection(baseUrl?: string): Promise<{\n  connected: boolean\n  latency: number\n  error?: string\n}> {\n  const url = (baseUrl || getAPIConfig().baseUrl).replace(/\\/$/, '')\n  const start = performance.now()\n  \n  try {\n    const res = await fetch(`${url}/auth.php?action=me`, {\n      method: 'GET',\n      headers: { 'Content-Type': 'application/json' },\n    })\n    const latency = Math.round(performance.now() - start)\n    \n    // We expect 401 (no token) — that proves the API is alive\n    if (res.status === 401 || res.status === 200) {\n      return { connected: true, latency }\n    }\n    \n    return { connected: false, latency, error: `Unexpected status: ${res.status}` }\n  } catch (e) {\n    const latency = Math.round(performance.now() - start)\n    return { connected: false, latency, error: e instanceof Error ? e.message : 'Connection failed' }\n  }\n}\n\n// ============================================\n//  CHECK AUTH STATE\n// ============================================\n\nexport function isAuthenticated(): boolean {\n  const { access } = getStoredTokens()\n  if (!access) return false\n  \n  try {\n    const payload = JSON.parse(atob(access.split('.')[1]))\n    return payload.exp * 1000 > Date.now()\n  } catch {\n    return false\n  }\n}\n\nexport function hasRefreshToken(): boolean {\n  return !!getStoredTokens().refresh\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\api-settings.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\audit-defense.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'netIncome' is assigned a value but never used.","line":85,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":85,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'LegalEntity' is defined but never used.","line":502,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":502,"endColumn":40,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"LegalEntity"},"fix":{"range":[22143,22156],"text":""},"desc":"Remove unused variable \"LegalEntity\"."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE — Audit Defense Toolkit v1\n * \n * Proactive audit protection that NO competitor offers:\n *   - Comprehensive audit risk scoring (0-100)\n *   - Red flag detection across 30+ IRS triggers\n *   - Documentation gap analysis per deduction\n *   - IRS correspondence response generator\n *   - Statute of limitations tracker\n *   - Audit type probability (correspondence/office/field)\n *   - Industry-specific audit rates\n *   - Penalty exposure calculator\n */\n\n// ─── Types ──────────────────────────────────────────────────────────────────\n\nexport interface AuditRiskProfile {\n  overallScore: number          // 0-100 (higher = more risk)\n  riskLevel: 'low' | 'moderate' | 'elevated' | 'high' | 'critical'\n  auditProbability: number      // estimated % chance of audit\n  likelyAuditType: 'correspondence' | 'office' | 'field'\n  redFlags: RedFlag[]\n  documentationGaps: DocumentGap[]\n  strengths: string[]\n  recommendations: AuditRecommendation[]\n  penaltyExposure: PenaltyExposure\n  statuteOfLimitations: StatuteTracker[]\n}\n\nexport interface RedFlag {\n  id: string\n  category: string\n  title: string\n  description: string\n  severity: 'low' | 'medium' | 'high' | 'critical'\n  scoreImpact: number           // how much this raises audit risk\n  irsReference: string          // relevant IRS guidance\n  mitigation: string            // how to reduce this risk\n  triggered: boolean\n  details?: string\n}\n\nexport interface DocumentGap {\n  deduction: string\n  requiredDocuments: string[]\n  presentDocuments: string[]\n  missingDocuments: string[]\n  riskIfAudited: string\n  recommendation: string\n}\n\nexport interface AuditRecommendation {\n  priority: 'immediate' | 'soon' | 'ongoing'\n  title: string\n  description: string\n  effort: 'low' | 'medium' | 'high'\n}\n\nexport interface PenaltyExposure {\n  negligencePenalty: number     // 20% of underpayment\n  substantialUnderstatement: number  // 20% if understatement > $5K or 10% of tax\n  fraudPenalty: number          // 75% (worst case)\n  failureToFile: number        // 5%/month up to 25%\n  failureToPayEstimated: number\n  totalWorstCase: number\n  totalLikelyCase: number\n  interestAccrued: number\n}\n\nexport interface StatuteTracker {\n  taxYear: number\n  filingDate: string\n  normalExpiry: string          // 3 years from filing\n  extendedExpiry?: string       // 6 years if >25% omission\n  fraudExpiry: string           // no limit\n  status: 'open' | 'closing_soon' | 'expired'\n  daysRemaining: number\n  notes: string\n}\n\n// ─── Red Flag Definitions ───────────────────────────────────────────────────\n\nfunction defineRedFlags(data: AuditInputData): RedFlag[] {\n  const flags: RedFlag[] = []\n  const netIncome = data.grossIncome - data.totalDeductions\n\n  // 1. High income DIF score trigger\n  flags.push({\n    id: 'high-income', category: 'Income', title: 'High Income Level',\n    description: 'Incomes above $200K face 2-3x higher audit rates. Above $1M, audit rates exceed 2%.',\n    severity: data.grossIncome > 1000000 ? 'high' : data.grossIncome > 500000 ? 'medium' : 'low',\n    scoreImpact: data.grossIncome > 1000000 ? 25 : data.grossIncome > 500000 ? 15 : data.grossIncome > 200000 ? 8 : 0,\n    irsReference: 'IRS Data Book, Table 9a',\n    mitigation: 'Ensure all income documentation is complete and consistent across forms.',\n    triggered: data.grossIncome > 200000,\n  })\n\n  // 2. Schedule C with high deductions relative to income\n  const deductionRatio = data.grossIncome > 0 ? data.businessExpenses / data.businessIncome : 0\n  flags.push({\n    id: 'high-sch-c-deductions', category: 'Schedule C', title: 'High Business Expense Ratio',\n    description: `Business expense ratio of ${(deductionRatio * 100).toFixed(0)}%. IRS flags ratios above 50-60% in many industries.`,\n    severity: deductionRatio > 0.8 ? 'high' : deductionRatio > 0.6 ? 'medium' : 'low',\n    scoreImpact: deductionRatio > 0.8 ? 20 : deductionRatio > 0.6 ? 10 : 0,\n    irsReference: 'DIF Score Methodology',\n    mitigation: 'Maintain detailed records for every deduction. Consider if all expenses are ordinary and necessary (§162).',\n    triggered: deductionRatio > 0.5 && data.businessIncome > 0,\n    details: `Expense ratio: ${(deductionRatio * 100).toFixed(1)}% ($${data.businessExpenses.toLocaleString()} / $${data.businessIncome.toLocaleString()})`,\n  })\n\n  // 3. Home office deduction\n  flags.push({\n    id: 'home-office', category: 'Deductions', title: 'Home Office Deduction Claimed',\n    description: 'Home office deductions receive extra scrutiny. Must meet exclusive and regular use test.',\n    severity: data.homeOfficeDeduction > 5000 ? 'medium' : 'low',\n    scoreImpact: data.homeOfficeDeduction > 0 ? 8 : 0,\n    irsReference: 'IRC §280A; IRS Pub 587',\n    mitigation: 'Document exclusive-use space with photos, floor plan, and square footage calculation. Keep all utility bills.',\n    triggered: data.homeOfficeDeduction > 0,\n  })\n\n  // 4. Large charitable contributions relative to income\n  const charityRatio = data.grossIncome > 0 ? data.charitableContributions / data.grossIncome : 0\n  flags.push({\n    id: 'large-charity', category: 'Deductions', title: 'Large Charitable Contributions',\n    description: `Charitable contributions are ${(charityRatio * 100).toFixed(1)}% of income. IRS flags contributions significantly above average for income level.`,\n    severity: charityRatio > 0.2 ? 'high' : charityRatio > 0.1 ? 'medium' : 'low',\n    scoreImpact: charityRatio > 0.2 ? 15 : charityRatio > 0.1 ? 8 : 0,\n    irsReference: 'IRC §170; IRS Pub 526',\n    mitigation: 'Get written acknowledgment for all donations $250+. Appraisals required for non-cash donations $5,000+.',\n    triggered: charityRatio > 0.05 && data.charitableContributions > 500,\n  })\n\n  // 5. Crypto transactions\n  flags.push({\n    id: 'crypto-transactions', category: 'Crypto', title: 'Cryptocurrency Transactions',\n    description: 'IRS has significantly increased crypto enforcement. Form 8949 scrutiny is high.',\n    severity: data.cryptoTransactions > 100 ? 'high' : data.cryptoTransactions > 20 ? 'medium' : 'low',\n    scoreImpact: data.cryptoTransactions > 100 ? 12 : data.cryptoTransactions > 0 ? 5 : 0,\n    irsReference: 'Notice 2014-21; Rev. Rul. 2019-24; IR-2024-18',\n    mitigation: 'Report ALL transactions including small trades. Use consistent cost basis method. Answer \"yes\" to Form 1040 digital asset question.',\n    triggered: data.cryptoTransactions > 0,\n    details: `${data.cryptoTransactions} crypto transactions reported`,\n  })\n\n  // 6. Cash-intensive business\n  flags.push({\n    id: 'cash-business', category: 'Schedule C', title: 'Cash-Intensive Business',\n    description: 'Businesses with significant cash receipts face higher audit scrutiny.',\n    severity: data.cashReceipts > 50000 ? 'high' : data.cashReceipts > 10000 ? 'medium' : 'low',\n    scoreImpact: data.cashReceipts > 50000 ? 15 : data.cashReceipts > 10000 ? 8 : 0,\n    irsReference: 'IRS NRPS; Cash-T Analysis',\n    mitigation: 'Maintain daily cash receipts log. Deposit all income through bank. Keep all register tapes/records.',\n    triggered: data.cashReceipts > 5000,\n  })\n\n  // 7. Meals deduction (historically abused)\n  flags.push({\n    id: 'meals-deduction', category: 'Schedule C', title: 'Business Meals Deduction',\n    description: 'Meals deductions require contemporaneous records of business purpose, attendees, and business discussion.',\n    severity: data.mealsDeduction > 10000 ? 'medium' : 'low',\n    scoreImpact: data.mealsDeduction > 10000 ? 8 : data.mealsDeduction > 5000 ? 4 : 0,\n    irsReference: 'IRC §274(d); Treas. Reg. §1.274-5T',\n    mitigation: 'Log each meal with: date, amount, location, business purpose, who attended, and business topics discussed.',\n    triggered: data.mealsDeduction > 1000,\n  })\n\n  // 8. Vehicle deduction without mileage log\n  flags.push({\n    id: 'vehicle-no-log', category: 'Schedule C', title: 'Vehicle Deduction Without Mileage Log',\n    description: 'IRS almost always disallows vehicle deductions without contemporaneous mileage log.',\n    severity: data.vehicleDeduction > 0 && !data.hasMileageLog ? 'high' : 'low',\n    scoreImpact: data.vehicleDeduction > 0 && !data.hasMileageLog ? 15 : 0,\n    irsReference: 'IRC §274(d); Temp. Reg. §1.274-5T(c)(2)',\n    mitigation: 'Start maintaining a mileage log immediately. Apps like MileIQ or manual log with date, destination, business purpose, and miles.',\n    triggered: data.vehicleDeduction > 0 && !data.hasMileageLog,\n  })\n\n  // 9. Net losses reported multiple years\n  flags.push({\n    id: 'hobby-loss', category: 'Schedule C', title: 'Business Reporting Net Losses',\n    description: 'IRS presumes hobby if no profit in 3 of 5 consecutive years (IRC §183). Hobby losses not deductible.',\n    severity: data.consecutiveLossYears >= 3 ? 'critical' : data.consecutiveLossYears >= 2 ? 'high' : 'low',\n    scoreImpact: data.consecutiveLossYears >= 3 ? 25 : data.consecutiveLossYears >= 2 ? 12 : 0,\n    irsReference: 'IRC §183; Treas. Reg. §1.183-2',\n    mitigation: 'Document profit motive: business plan, marketing efforts, expertise development, time invested, asset appreciation.',\n    triggered: data.consecutiveLossYears >= 2,\n  })\n\n  // 10. S-Corp reasonable compensation\n  flags.push({\n    id: 'scorp-comp', category: 'Entity', title: 'S-Corp Reasonable Compensation',\n    description: 'IRS scrutinizes S-Corp owner salaries that are too low relative to corporate profits.',\n    severity: data.sCorpSalary > 0 && data.sCorpSalary < data.sCorpDistributions * 0.3 ? 'high' : 'low',\n    scoreImpact: data.sCorpSalary > 0 && data.sCorpSalary < data.sCorpDistributions * 0.3 ? 18 : 0,\n    irsReference: 'Rev. Rul. 74-44; David E. Watson, P.C. v. United States',\n    mitigation: 'Research comparable salaries for your role/industry. Document with salary surveys. Keep ratio at least 40-50% of net income.',\n    triggered: data.sCorpSalary > 0 && data.sCorpDistributions > data.sCorpSalary,\n  })\n\n  // 11. Large round numbers\n  flags.push({\n    id: 'round-numbers', category: 'General', title: 'Round Number Deductions',\n    description: 'Multiple deductions at exact round numbers suggest estimation rather than actual record-keeping.',\n    severity: data.roundNumberDeductions > 5 ? 'medium' : 'low',\n    scoreImpact: data.roundNumberDeductions > 5 ? 8 : 0,\n    irsReference: 'DIF Score Pattern Analysis',\n    mitigation: 'Always report exact amounts from receipts/records. Never estimate or round deductions.',\n    triggered: data.roundNumberDeductions > 3,\n  })\n\n  // 12. Unreported income (1099 mismatch)\n  flags.push({\n    id: 'income-mismatch', category: 'Income', title: 'Potential Income Underreporting',\n    description: 'IRS AUR (Automated Underreporter) matches all 1099s/W-2s to your return. Any mismatch triggers automatic correspondence.',\n    severity: data.potentialUnreported > 0 ? 'critical' : 'low',\n    scoreImpact: data.potentialUnreported > 0 ? 30 : 0,\n    irsReference: 'IRC §6721/§6722; AUR Program',\n    mitigation: 'Report ALL income shown on 1099s even if you believe it is incorrect. File corrected 1099 with issuer if amount is wrong.',\n    triggered: data.potentialUnreported > 0,\n  })\n\n  return flags.filter(f => f.triggered)\n}\n\n// ─── Input Data ─────────────────────────────────────────────────────────────\n\nexport interface AuditInputData {\n  taxYear: number\n  filingStatus: string\n  grossIncome: number\n  totalDeductions: number\n  businessIncome: number\n  businessExpenses: number\n  homeOfficeDeduction: number\n  charitableContributions: number\n  cryptoTransactions: number\n  cashReceipts: number\n  mealsDeduction: number\n  vehicleDeduction: number\n  hasMileageLog: boolean\n  consecutiveLossYears: number\n  sCorpSalary: number\n  sCorpDistributions: number\n  roundNumberDeductions: number\n  potentialUnreported: number\n  filingDate?: string\n}\n\n// ─── Core Analysis ──────────────────────────────────────────────────────────\n\nexport function analyzeAuditRisk(data: AuditInputData): AuditRiskProfile {\n  const redFlags = defineRedFlags(data)\n  \n  // Calculate composite score\n  let baseScore = 10 // baseline for any filer\n  for (const flag of redFlags) {\n    baseScore += flag.scoreImpact\n  }\n  const overallScore = Math.min(100, baseScore)\n\n  // Risk level\n  let riskLevel: AuditRiskProfile['riskLevel']\n  if (overallScore >= 80) riskLevel = 'critical'\n  else if (overallScore >= 60) riskLevel = 'high'\n  else if (overallScore >= 40) riskLevel = 'elevated'\n  else if (overallScore >= 25) riskLevel = 'moderate'\n  else riskLevel = 'low'\n\n  // Audit probability estimate (simplified)\n  const baseAuditRate = data.grossIncome > 1000000 ? 2.0 : data.grossIncome > 500000 ? 0.8 :\n    data.grossIncome > 200000 ? 0.4 : data.grossIncome > 100000 ? 0.3 : 0.2\n  const auditProbability = Math.min(15, baseAuditRate * (1 + overallScore / 50))\n\n  // Likely audit type\n  const likelyAuditType = overallScore > 60 ? 'field' : overallScore > 35 ? 'office' : 'correspondence'\n\n  // Strengths\n  const strengths: string[] = []\n  if (data.hasMileageLog) strengths.push('Contemporaneous mileage log maintained')\n  if (data.consecutiveLossYears === 0) strengths.push('Business showing profitability')\n  if (data.potentialUnreported === 0) strengths.push('All income sources appear fully reported')\n  if (data.roundNumberDeductions <= 2) strengths.push('Deductions reflect actual amounts, not estimates')\n  if (data.cryptoTransactions === 0) strengths.push('No complex crypto positions to explain')\n  if (redFlags.length <= 2) strengths.push('Few red flags relative to income level')\n\n  // Documentation gaps (simplified)\n  const documentationGaps = analyzeDocGaps(data)\n\n  // Recommendations\n  const recommendations = generateAuditRecs(data, redFlags)\n\n  // Penalty exposure\n  const penaltyExposure = calculatePenaltyExposure(data)\n\n  // Statute of limitations\n  const statuteOfLimitations = calculateStatutes(data)\n\n  return {\n    overallScore,\n    riskLevel,\n    auditProbability: Math.round(auditProbability * 100) / 100,\n    likelyAuditType,\n    redFlags,\n    documentationGaps,\n    strengths,\n    recommendations,\n    penaltyExposure,\n    statuteOfLimitations,\n  }\n}\n\n// ─── Documentation Gap Analysis ─────────────────────────────────────────────\n\nfunction analyzeDocGaps(data: AuditInputData): DocumentGap[] {\n  const gaps: DocumentGap[] = []\n\n  if (data.homeOfficeDeduction > 0) {\n    gaps.push({\n      deduction: 'Home Office (§280A)',\n      requiredDocuments: ['Floor plan with measurements', 'Photos of dedicated space', 'Utility bills', 'Mortgage/rent statements', 'Insurance declarations', 'Form 8829'],\n      presentDocuments: [],\n      missingDocuments: ['Floor plan with measurements', 'Photos of dedicated space', 'Utility bills'],\n      riskIfAudited: 'Full disallowance of home office deduction + depreciation recapture',\n      recommendation: 'Take photos of home office, measure and document square footage, keep all household expense receipts organized by month.',\n    })\n  }\n\n  if (data.vehicleDeduction > 0) {\n    gaps.push({\n      deduction: 'Vehicle Expenses (§274)',\n      requiredDocuments: ['Contemporaneous mileage log', 'Vehicle title/registration', 'Gas/maintenance receipts', 'Insurance records', 'Business purpose documentation'],\n      presentDocuments: data.hasMileageLog ? ['Contemporaneous mileage log'] : [],\n      missingDocuments: data.hasMileageLog ? [] : ['Contemporaneous mileage log'],\n      riskIfAudited: 'Full disallowance. Vehicle deduction is #1 most commonly disallowed deduction.',\n      recommendation: data.hasMileageLog ? 'Continue logging. Back up data regularly.' : 'START A MILEAGE LOG TODAY. This is the single most important audit defense document.',\n    })\n  }\n\n  if (data.charitableContributions > 250) {\n    gaps.push({\n      deduction: 'Charitable Contributions (§170)',\n      requiredDocuments: ['Written acknowledgment from charity for each gift $250+', 'Bank/credit card records', 'Appraisal for non-cash gifts $5,000+', 'Form 8283 for non-cash gifts $500+'],\n      presentDocuments: [],\n      missingDocuments: ['Written acknowledgment letters'],\n      riskIfAudited: 'Full disallowance of any gift without proper substantiation',\n      recommendation: 'Request written acknowledgment from every charity you donated to. Must include amount, date, and statement of whether goods/services were provided.',\n    })\n  }\n\n  if (data.mealsDeduction > 500) {\n    gaps.push({\n      deduction: 'Business Meals (§274)',\n      requiredDocuments: ['Receipt for each meal', 'Date and location', 'Business purpose', 'Name of attendees', 'Business topics discussed'],\n      presentDocuments: [],\n      missingDocuments: ['Business purpose log for meals'],\n      riskIfAudited: 'Full disallowance if cannot prove business purpose for each meal',\n      recommendation: 'Write business purpose on the back of every meal receipt or log it digitally the same day.',\n    })\n  }\n\n  return gaps\n}\n\n// ─── Penalty Exposure ───────────────────────────────────────────────────────\n\nfunction calculatePenaltyExposure(data: AuditInputData): PenaltyExposure {\n  const estimatedTax = data.grossIncome * 0.25 // rough estimate\n  const potentialUnderpayment = estimatedTax * 0.15 // assume 15% could be disallowed\n\n  return {\n    negligencePenalty: Math.round(potentialUnderpayment * 0.20),\n    substantialUnderstatement: Math.round(potentialUnderpayment * 0.20),\n    fraudPenalty: Math.round(potentialUnderpayment * 0.75),\n    failureToFile: 0,\n    failureToPayEstimated: Math.round(potentialUnderpayment * 0.08),\n    totalWorstCase: Math.round(potentialUnderpayment * (1 + 0.75 + 0.08)),\n    totalLikelyCase: Math.round(potentialUnderpayment * (1 + 0.20 + 0.04)),\n    interestAccrued: Math.round(potentialUnderpayment * 0.08),\n  }\n}\n\n// ─── Statute of Limitations ─────────────────────────────────────────────────\n\nfunction calculateStatutes(data: AuditInputData): StatuteTracker[] {\n  const currentYear = new Date().getFullYear()\n  const trackers: StatuteTracker[] = []\n\n  // Track last 7 years\n  for (let year = currentYear - 7; year <= data.taxYear; year++) {\n    const filingDate = `${year + 1}-04-15` // assume timely filing\n    const normalExpiry = new Date(filingDate)\n    normalExpiry.setFullYear(normalExpiry.getFullYear() + 3)\n\n    const extendedExpiry = new Date(filingDate)\n    extendedExpiry.setFullYear(extendedExpiry.getFullYear() + 6)\n\n    const now = new Date()\n    const daysRemaining = Math.ceil((normalExpiry.getTime() - now.getTime()) / (1000 * 60 * 60 * 24))\n\n    let status: StatuteTracker['status']\n    if (daysRemaining < 0) status = 'expired'\n    else if (daysRemaining < 180) status = 'closing_soon'\n    else status = 'open'\n\n    trackers.push({\n      taxYear: year,\n      filingDate,\n      normalExpiry: normalExpiry.toISOString().split('T')[0],\n      extendedExpiry: extendedExpiry.toISOString().split('T')[0],\n      fraudExpiry: 'No limit',\n      status,\n      daysRemaining: Math.max(0, daysRemaining),\n      notes: daysRemaining < 0 ? 'Statute expired — IRS cannot assess additional tax (absent fraud)' :\n        daysRemaining < 180 ? 'Statute closing soon — reduced risk of audit initiation' : '',\n    })\n  }\n\n  return trackers.reverse() // newest first\n}\n\n// ─── Recommendations ────────────────────────────────────────────────────────\n\nfunction generateAuditRecs(data: AuditInputData, flags: RedFlag[]): AuditRecommendation[] {\n  const recs: AuditRecommendation[] = []\n\n  if (flags.some(f => f.id === 'vehicle-no-log')) {\n    recs.push({\n      priority: 'immediate', title: 'Start Mileage Log',\n      description: 'Begin tracking every business mile TODAY. Without a log, vehicle deductions are almost automatically disallowed in an audit.',\n      effort: 'low',\n    })\n  }\n\n  if (flags.some(f => f.id === 'scorp-comp')) {\n    recs.push({\n      priority: 'immediate', title: 'Review S-Corp Salary',\n      description: 'Your owner salary may be too low. Research comparable salaries in your industry/region and adjust to at least 40-50% of net income.',\n      effort: 'medium',\n    })\n  }\n\n  if (flags.some(f => f.id === 'income-mismatch')) {\n    recs.push({\n      priority: 'immediate', title: 'Reconcile Income Reporting',\n      description: 'Potential unreported income detected. Cross-reference all 1099s received with amounts on your return. File amended return if needed.',\n      effort: 'medium',\n    })\n  }\n\n  recs.push({\n    priority: 'ongoing', title: 'Organize Supporting Documents',\n    description: 'Scan and file all receipts, contracts, and statements organized by tax category. The best audit defense is complete, organized documentation.',\n    effort: 'medium',\n  })\n\n  recs.push({\n    priority: 'ongoing', title: 'Maintain Contemporaneous Records',\n    description: 'IRS values records made at or near the time of the transaction. Logging expenses weekly is far better than reconstructing at year-end.',\n    effort: 'low',\n  })\n\n  return recs\n}\n\n// ─── Phase G: Document Vault Cross-Reference ─────────────────────────────────\n\n/** Cross-reference document vault to fill in DocumentGap.presentDocuments */\nexport function enrichDocumentGaps(\n  gaps: DocumentGap[],\n  vaultDocuments: { name: string; category: string; subcategory?: string; tags?: string[] }[],\n): DocumentGap[] {\n  return gaps.map(gap => {\n    const present: string[] = []\n    const missing: string[] = []\n\n    for (const reqDoc of gap.requiredDocuments) {\n      const reqLower = reqDoc.toLowerCase()\n      const found = vaultDocuments.some(vd =>\n        vd.name.toLowerCase().includes(reqLower) ||\n        vd.category.toLowerCase().includes(reqLower) ||\n        (vd.subcategory || '').toLowerCase().includes(reqLower) ||\n        (vd.tags || []).some(t => t.toLowerCase().includes(reqLower))\n      )\n      if (found) present.push(reqDoc)\n      else missing.push(reqDoc)\n    }\n\n    return {\n      ...gap,\n      presentDocuments: present,\n      missingDocuments: missing,\n      recommendation: missing.length > 0\n        ? `Upload ${missing.length} missing document(s): ${missing.join(', ')}`\n        : 'All required documents on file',\n    }\n  })\n}\n\n// ─── Phase H: Entity-Aware Audit Input Builder ───────────────────────────────\n\nimport type { FortunaState, LegalEntity } from './storage'\n\nexport interface EntityAuditInput extends AuditInputData {\n  entityId: string\n  entityName: string\n  entityType: string\n}\n\n/** Build per-entity audit inputs from FortunaState */\nexport function buildEntityAuditInputs(state: FortunaState): EntityAuditInput[] {\n  const results: EntityAuditInput[] = []\n  const entities = state.entities.filter(e => e.isActive)\n\n  for (const entity of entities) {\n    const entityIncome = state.incomeStreams\n      .filter(s => s.isActive && s.entityId === entity.id)\n      .reduce((s, i) => s + i.annualAmount, 0)\n    const entityExpenses = state.expenses\n      .filter(e => e.entityId === entity.id && e.isDeductible)\n      .reduce((s, e) => s + e.annualAmount * e.deductionPct / 100, 0)\n\n    const isScorp = entity.type === 'llc_scorp' || entity.type === 'scorp'\n    const officerSalary = isScorp ? (entity.officerSalary || 0) : 0\n    const distributions = isScorp ? Math.max(0, entityIncome - entityExpenses - officerSalary) : 0\n\n    results.push({\n      entityId: entity.id,\n      entityName: entity.name,\n      entityType: entity.type,\n      taxYear: state.taxYear || new Date().getFullYear(),\n      filingStatus: state.profile.filingStatus,\n      grossIncome: entityIncome,\n      totalDeductions: entityExpenses,\n      businessIncome: entityIncome,\n      businessExpenses: entityExpenses,\n      homeOfficeDeduction: state.deductions.filter(d => d.category === 'home_office' && d.entityId === entity.id).reduce((s, d) => s + d.amount, 0),\n      charitableContributions: 0,\n      cryptoTransactions: 0,\n      cashReceipts: 0,\n      mealsDeduction: state.expenses.filter(e => e.entityId === entity.id && e.category === 'meals_entertainment').reduce((s, e) => s + e.annualAmount * e.deductionPct / 100, 0),\n      vehicleDeduction: state.expenses.filter(e => e.entityId === entity.id && e.category === 'auto').reduce((s, e) => s + e.annualAmount * e.deductionPct / 100, 0),\n      hasMileageLog: false,\n      consecutiveLossYears: 0,\n      sCorpSalary: officerSalary,\n      sCorpDistributions: distributions,\n      roundNumberDeductions: state.expenses.filter(e => e.entityId === entity.id && e.annualAmount % 1000 === 0).length,\n      potentialUnreported: 0,\n    })\n  }\n\n  return results\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\audit-risk.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'report' is defined but never used.","line":65,"column":54,"nodeType":"Identifier","messageId":"unusedVar","endLine":65,"endColumn":60},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'consecutiveLosses' is assigned a value but never used.","line":97,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":97,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'report' is defined but never used.","line":194,"column":53,"nodeType":"Identifier","messageId":"unusedVar","endLine":194,"endColumn":59},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'distributions' is assigned a value but never used.","line":204,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":204,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'report' is defined but never used.","line":297,"column":57,"nodeType":"Identifier","messageId":"unusedVar","endLine":297,"endColumn":63}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine - Audit Risk Profiler\n * Analyzes IRS audit trigger thresholds, DIF scoring factors,\n * and generates audit probability estimates with mitigation strategies\n * \n * Based on publicly available IRS audit statistics, DIF score factors,\n * and known audit selection criteria from tax professional literature.\n */\n\nimport type { FortunaState } from './storage'\nimport { generateTaxReport, type TaxReport } from './tax-calculator'\n\n// ─── Types ──────────────────────────────────────────────────────\n\nexport interface AuditTrigger {\n  id: string\n  name: string\n  category: 'income' | 'deductions' | 'credits' | 'reporting' | 'entity' | 'lifestyle'\n  severity: 'critical' | 'high' | 'medium' | 'low'\n  riskScore: number // 0-100\n  triggered: boolean\n  description: string\n  irsContext: string // What the IRS looks for\n  mitigation: string\n  documentationNeeded: string[]\n  threshold?: string // The specific threshold that triggers this\n}\n\nexport interface AuditRiskProfile {\n  overallScore: number // 0-100 (higher = more risk)\n  riskLevel: 'low' | 'moderate' | 'elevated' | 'high' | 'very-high'\n  riskLabel: string\n  triggers: AuditTrigger[]\n  triggeredCount: number\n  totalChecks: number\n  baselineAuditRate: number // National average for this income level\n  adjustedAuditRate: number // Estimated adjusted rate based on triggers\n  topRecommendations: string[]\n  documentationScore: number // 0-100 how well documented they likely are\n  redFlagCount: number\n  yellowFlagCount: number\n}\n\n// ─── IRS Audit Rate by Income (2023-2024 published data) ─────────\n\nfunction getBaseAuditRate(agi: number, hasSchedC: boolean): number {\n  // Based on IRS Data Book published audit rates\n  if (agi <= 25000) return hasSchedC ? 0.012 : 0.004\n  if (agi <= 50000) return hasSchedC ? 0.009 : 0.003\n  if (agi <= 75000) return hasSchedC ? 0.008 : 0.003\n  if (agi <= 100000) return hasSchedC ? 0.009 : 0.004\n  if (agi <= 200000) return hasSchedC ? 0.011 : 0.005\n  if (agi <= 500000) return hasSchedC ? 0.015 : 0.008\n  if (agi <= 1000000) return hasSchedC ? 0.022 : 0.013\n  if (agi <= 5000000) return 0.028\n  if (agi <= 10000000) return 0.065\n  return 0.133 // $10M+ has ~13.3% audit rate\n}\n\n// ─── DIF Score Factor Analysis ───────────────────────────────────\n\n// The IRS Discriminant Information Function (DIF) scores returns based on\n// statistical norms. These are the known factors that contribute to higher DIF scores.\n\nfunction analyzeScheduleCRatios(state: FortunaState, report: TaxReport): AuditTrigger[] {\n  const triggers: AuditTrigger[] = []\n  const seIncome = state.incomeStreams\n    .filter(s => ['business', 'freelance'].includes(s.type) && s.isActive)\n    .reduce((sum, s) => sum + s.annualAmount, 0)\n\n  if (seIncome === 0) return triggers\n\n  const totalExpenses = state.expenses\n    .filter(e => e.isDeductible)\n    .reduce((sum, e) => sum + (e.annualAmount * e.deductionPct / 100), 0)\n\n  const expenseRatio = totalExpenses / Math.max(1, seIncome)\n\n  // High expense-to-income ratio\n  triggers.push({\n    id: 'sched-c-expense-ratio',\n    name: 'Schedule C Expense Ratio',\n    category: 'deductions',\n    severity: expenseRatio > 0.85 ? 'critical' : expenseRatio > 0.65 ? 'high' : expenseRatio > 0.45 ? 'medium' : 'low',\n    riskScore: expenseRatio > 0.85 ? 85 : expenseRatio > 0.65 ? 60 : expenseRatio > 0.45 ? 35 : 10,\n    triggered: expenseRatio > 0.50,\n    description: `Your business expenses are ${(expenseRatio * 100).toFixed(0)}% of gross revenue. ${expenseRatio > 0.65 ? 'This exceeds the norm for your industry and may flag DIF scoring.' : 'This is within normal ranges.'}`,\n    irsContext: 'The IRS DIF system flags Schedule C returns where expenses significantly deviate from statistical norms for the reported industry. Returns with expenses exceeding 65% of gross receipts receive elevated scrutiny.',\n    mitigation: 'Maintain meticulous records for every deduction. Categorize expenses precisely. Consider separating personal and business expenses into distinct accounts.',\n    documentationNeeded: ['Receipts for all expenses over $75', 'Mileage log if claiming vehicle', 'Home office measurements and photos', 'Business purpose documentation for each category'],\n    threshold: '>50% expense-to-income ratio triggers closer review',\n  })\n\n  // Net losses on Schedule C\n  const netSCIncome = seIncome - totalExpenses\n  if (netSCIncome < 0) {\n    const consecutiveLosses = true // Simplified - in production, track multi-year\n    triggers.push({\n      id: 'sched-c-losses',\n      name: 'Business Net Loss',\n      category: 'income',\n      severity: 'high',\n      riskScore: 70,\n      triggered: true,\n      description: `Your business shows a net loss of $${Math.abs(netSCIncome).toLocaleString()}. The IRS scrutinizes businesses that report losses, especially in consecutive years.`,\n      irsContext: 'IRC §183 (hobby loss rule): If a business does not show profit in 3 of the last 5 years, the IRS may reclassify it as a hobby, disallowing deductions. Consecutive losses are a top audit trigger.',\n      mitigation: 'Document your profit motive: maintain a business plan, track efforts to improve profitability, keep separate business accounts, and operate in a businesslike manner.',\n      documentationNeeded: ['Written business plan', 'Records of efforts to improve profitability', 'Time and effort logs', 'Professional development expenses', 'Advisory/consulting relationships'],\n      threshold: '3+ years of losses triggers §183 scrutiny',\n    })\n  }\n\n  return triggers\n}\n\nfunction analyzeDeductionTriggers(state: FortunaState, report: TaxReport): AuditTrigger[] {\n  const triggers: AuditTrigger[] = []\n\n  // Home office deduction\n  const hasHomeOffice = state.deductions.some(d => d.category === 'home_office')\n  if (hasHomeOffice) {\n    const homeOfficeAmt = state.deductions.filter(d => d.category === 'home_office').reduce((s, d) => s + d.amount, 0)\n    triggers.push({\n      id: 'home-office',\n      name: 'Home Office Deduction',\n      category: 'deductions',\n      severity: homeOfficeAmt > 5000 ? 'medium' : 'low',\n      riskScore: homeOfficeAmt > 5000 ? 45 : 20,\n      triggered: true,\n      description: `Home office deduction of $${homeOfficeAmt.toLocaleString()} claimed. This is a known audit trigger, though the simplified method ($5/sqft, max $1,500) has lower risk.`,\n      irsContext: 'Home office deductions are audited more frequently because the IRS must verify exclusive and regular business use. The actual-expense method has higher audit risk than the simplified method.',\n      mitigation: 'Use the simplified method if deduction is under $1,500. If using actual expenses, photograph the space, maintain a floor plan showing dedicated space, and document exclusive business use.',\n      documentationNeeded: ['Floor plan with measurements', 'Photographs of dedicated office space', 'Utility bills and mortgage/rent statements', 'Usage log showing exclusive business use'],\n    })\n  }\n\n  // Vehicle deduction\n  const hasVehicle = state.deductions.some(d => d.category === 'vehicle')\n  if (hasVehicle) {\n    const vehicleAmt = state.deductions.filter(d => d.category === 'vehicle').reduce((s, d) => s + d.amount, 0)\n    triggers.push({\n      id: 'vehicle-deduction',\n      name: 'Vehicle / Mileage Deduction',\n      category: 'deductions',\n      severity: vehicleAmt > 15000 ? 'high' : 'medium',\n      riskScore: vehicleAmt > 15000 ? 55 : 30,\n      triggered: true,\n      description: `Vehicle deduction of $${vehicleAmt.toLocaleString()} claimed. The IRS frequently audits vehicle deductions, especially claims of 100% business use.`,\n      irsContext: 'Vehicle deductions require contemporaneous mileage logs. The IRS is skeptical of 100% business-use claims. Mixed-use vehicles should have clear personal/business allocation.',\n      mitigation: 'Maintain a daily mileage log (app-based like MileIQ is accepted). Never claim 100% business use unless you have a separate personal vehicle. Keep fuel receipts and maintenance records.',\n      documentationNeeded: ['Contemporaneous mileage log (date, destination, purpose, miles)', 'Vehicle registration showing ownership', 'Fuel and maintenance receipts', 'Documentation of personal vehicle if claiming 100% business'],\n    })\n  }\n\n  // Charitable contributions\n  const charitable = state.deductions.filter(d => d.category === 'charitable').reduce((s, d) => s + d.amount, 0)\n  if (charitable > 0) {\n    const charitableRatio = charitable / Math.max(1, report.agi)\n    triggers.push({\n      id: 'charitable',\n      name: 'Charitable Contributions',\n      category: 'deductions',\n      severity: charitableRatio > 0.15 ? 'high' : charitableRatio > 0.05 ? 'medium' : 'low',\n      riskScore: charitableRatio > 0.15 ? 60 : charitableRatio > 0.05 ? 30 : 10,\n      triggered: charitableRatio > 0.03,\n      description: `Charitable deductions are ${(charitableRatio * 100).toFixed(1)}% of AGI ($${charitable.toLocaleString()}). ${charitableRatio > 0.10 ? 'This significantly exceeds the average for your income level.' : 'Within typical ranges.'}`,\n      irsContext: 'The IRS compares charitable deductions against statistical norms by income level. Average charitable giving is 3-5% of AGI. Non-cash donations over $500 require Form 8283. Donations over $5,000 need qualified appraisals.',\n      mitigation: 'Keep donation receipts from all organizations. Get written acknowledgment for donations over $250. File Form 8283 for non-cash donations over $500.',\n      documentationNeeded: ['Written receipts from charitable organizations', 'Bank/credit card statements showing donations', 'Form 8283 for non-cash donations >$500', 'Qualified appraisals for items >$5,000'],\n    })\n  }\n\n  // Large deduction relative to income\n  const totalItemized = state.deductions.filter(d => d.isItemized).reduce((s, d) => s + d.amount, 0)\n  const deductionRatio = totalItemized / Math.max(1, report.agi)\n  if (totalItemized > 0 && deductionRatio > 0.30) {\n    triggers.push({\n      id: 'excessive-deductions',\n      name: 'High Deduction-to-Income Ratio',\n      category: 'deductions',\n      severity: deductionRatio > 0.50 ? 'high' : 'medium',\n      riskScore: deductionRatio > 0.50 ? 55 : 35,\n      triggered: true,\n      description: `Itemized deductions total $${totalItemized.toLocaleString()} (${(deductionRatio * 100).toFixed(0)}% of AGI). DIF scoring flags returns where deductions significantly exceed norms for the income level.`,\n      irsContext: 'The DIF system compares each line item against statistical averages for the taxpayer\\'s income bracket and zip code. Outliers receive higher DIF scores and are more likely to be selected for examination.',\n      mitigation: 'Ensure every deduction is well-documented. Consider whether any deductions could be restructured (e.g., timing contributions across tax years).',\n      documentationNeeded: ['Supporting documentation for each deduction category', 'Receipts organized by type', 'Year-over-year comparison to show consistency'],\n    })\n  }\n\n  return triggers\n}\n\nfunction analyzeEntityTriggers(state: FortunaState, report: TaxReport): AuditTrigger[] {\n  const triggers: AuditTrigger[] = []\n  const hasScorp = state.entities.some(e => (e.type === 'llc_scorp' || e.type === 'scorp') && e.isActive)\n  const seIncome = state.incomeStreams\n    .filter(s => ['business', 'freelance'].includes(s.type) && s.isActive)\n    .reduce((sum, s) => sum + s.annualAmount, 0)\n\n  // S-Corp reasonable salary\n  if (hasScorp && seIncome > 0) {\n    const reasonableSalary = seIncome * 0.6 // Common threshold\n    const distributions = seIncome - reasonableSalary\n    triggers.push({\n      id: 'scorp-salary',\n      name: 'S-Corp Reasonable Salary',\n      category: 'entity',\n      severity: 'high',\n      riskScore: 50,\n      triggered: true,\n      description: `S-Corp entities must pay shareholders a \"reasonable salary\" before taking distributions. With $${seIncome.toLocaleString()} in revenue, ensure salary is competitive for your role and industry.`,\n      irsContext: 'The IRS actively scrutinizes S-Corp officer compensation. Setting salary too low to avoid FICA taxes is one of the most common S-Corp audit triggers. The IRS uses job comparables, education, experience, and industry standards.',\n      mitigation: 'Research comparable salaries using BLS data or salary surveys. Document why your salary level is reasonable. Keep records of time spent on different activities. Consider getting a reasonable compensation study.',\n      documentationNeeded: ['Salary comparability study or research', 'Job description for S-Corp officer role', 'BLS or salary survey data for your industry/region', 'Board resolution setting compensation'],\n      threshold: 'Salary should be 50-70% of net S-Corp income',\n    })\n  }\n\n  // No entity with high income\n  if (!state.entities.some(e => e.isActive && e.type !== 'sole_prop') && seIncome > 100000) {\n    triggers.push({\n      id: 'no-entity-high-income',\n      name: 'High SE Income Without Entity',\n      category: 'entity',\n      severity: 'medium',\n      riskScore: 25,\n      triggered: true,\n      description: `Operating as a sole proprietor with $${seIncome.toLocaleString()} in SE income. While not an audit trigger per se, it may indicate missed planning opportunities that could reduce overall IRS scrutiny.`,\n      irsContext: 'Sole proprietorships (Schedule C) have the highest audit rates of all business entity types. S-Corps and partnerships are audited at lower rates because they require more formal record-keeping.',\n      mitigation: 'Consider forming an LLC or electing S-Corp status. Entity formality inherently improves record-keeping, which reduces audit risk.',\n      documentationNeeded: ['Business bank statements separate from personal', 'Clear business expense records', 'Consistent record-keeping practices'],\n    })\n  }\n\n  return triggers\n}\n\nfunction analyzeIncomeTriggers(state: FortunaState, report: TaxReport): AuditTrigger[] {\n  const triggers: AuditTrigger[] = []\n\n  // Cash-intensive business\n  const businessStreams = state.incomeStreams.filter(s => ['business', 'freelance'].includes(s.type) && s.isActive)\n  if (businessStreams.length > 0) {\n    triggers.push({\n      id: 'cash-income',\n      name: 'Self-Employment Income Reporting',\n      category: 'income',\n      severity: report.grossIncome > 200000 ? 'medium' : 'low',\n      riskScore: report.grossIncome > 200000 ? 35 : 15,\n      triggered: report.grossIncome > 100000,\n      description: `Self-employment income of $${businessStreams.reduce((s, b) => s + b.annualAmount, 0).toLocaleString()} reported. The IRS cross-references with 1099 forms filed by clients and payment processors.`,\n      irsContext: 'The IRS matches reported income against 1099-NEC, 1099-K, and 1099-MISC forms. Discrepancies trigger automatic notices. Starting 2024, the $600 threshold for 1099-K means more reporting.',\n      mitigation: 'Reconcile all income against 1099 forms received. Report all income even if no 1099 was received. Keep records of income sources and dates.',\n      documentationNeeded: ['All 1099 forms received', 'Bank deposit records', 'Invoice records', 'Payment processor statements (PayPal, Stripe, etc.)'],\n    })\n  }\n\n  // Multi-state income\n  const hasMultiState = state.entities.some(e => e.state !== state.profile.state && e.isActive)\n  if (hasMultiState) {\n    triggers.push({\n      id: 'multi-state',\n      name: 'Multi-State Filing Complexity',\n      category: 'reporting',\n      severity: 'medium',\n      riskScore: 30,\n      triggered: true,\n      description: 'Income earned across multiple states requires multi-state returns. Errors in state apportionment are a common audit trigger.',\n      irsContext: 'State tax authorities share data with each other and the IRS. Inconsistencies between federal and state returns, or between different state returns, trigger cross-examination.',\n      mitigation: 'File in all states where you have nexus. Use consistent income allocation methods. Consider consulting a tax professional for multi-state compliance.',\n      documentationNeeded: ['Records of income by state', 'Days worked in each state', 'State filing requirements documentation'],\n    })\n  }\n\n  // Round numbers\n  const hasRoundNumbers = state.incomeStreams.some(s => s.annualAmount > 0 && s.annualAmount % 1000 === 0) ||\n    state.deductions.some(d => d.amount > 500 && d.amount % 100 === 0)\n  if (hasRoundNumbers) {\n    triggers.push({\n      id: 'round-numbers',\n      name: 'Round Number Reporting',\n      category: 'reporting',\n      severity: 'low',\n      riskScore: 15,\n      triggered: true,\n      description: 'Some amounts appear as round numbers. While often legitimate (e.g., set rates), the IRS DIF scoring slightly flags round-number deductions as potential estimates rather than actual amounts.',\n      irsContext: 'The DIF system gives slightly higher scores to returns with many round-number deductions, as this may indicate estimation rather than actual record-keeping.',\n      mitigation: 'When possible, report actual amounts rather than rounded figures. Keep detailed records that support exact amounts.',\n      documentationNeeded: ['Receipts showing exact amounts', 'Accounting records with precise figures'],\n    })\n  }\n\n  return triggers\n}\n\nfunction analyzeRetirementTriggers(state: FortunaState, report: TaxReport): AuditTrigger[] {\n  const triggers: AuditTrigger[] = []\n\n  const retirementDeductions = state.deductions.filter(d => d.category === 'retirement').reduce((s, d) => s + d.amount, 0)\n  const seIncome = state.incomeStreams\n    .filter(s => ['business', 'freelance'].includes(s.type) && s.isActive)\n    .reduce((sum, s) => sum + s.annualAmount, 0)\n\n  if (retirementDeductions > 0) {\n    // Check if contributions are near or at limits\n    const maxSEP = Math.min(69000, (seIncome * 0.9235) * 0.25)\n    if (retirementDeductions > maxSEP * 0.95) {\n      triggers.push({\n        id: 'retirement-near-max',\n        name: 'Retirement Contributions Near Maximum',\n        category: 'deductions',\n        severity: retirementDeductions > maxSEP ? 'high' : 'low',\n        riskScore: retirementDeductions > maxSEP ? 60 : 15,\n        triggered: retirementDeductions > maxSEP,\n        description: retirementDeductions > maxSEP\n          ? `Retirement contributions of $${retirementDeductions.toLocaleString()} may exceed the calculated maximum of $${Math.round(maxSEP).toLocaleString()} based on your net SE income. Excess contributions trigger penalties.`\n          : `Retirement contributions of $${retirementDeductions.toLocaleString()} are within limits ($${Math.round(maxSEP).toLocaleString()} max).`,\n        irsContext: 'The IRS computer systems automatically flag retirement contributions that exceed statutory limits. Excess contributions are subject to 6% annual penalty tax until withdrawn.',\n        mitigation: 'Verify contribution limits based on exact net self-employment income. Consider consulting with a CPA to ensure calculations are correct, especially with multiple retirement accounts.',\n        documentationNeeded: ['Retirement account contribution statements', 'Form 5498 from custodian', 'Net SE income calculation worksheet'],\n      })\n    }\n  }\n\n  return triggers\n}\n\n// ─── Main Analysis Function ──────────────────────────────────────\n\nexport function analyzeAuditRisk(state: FortunaState): AuditRiskProfile {\n  const report = generateTaxReport(state)\n  const hasSchedC = state.incomeStreams.some(s => ['business', 'freelance'].includes(s.type) && s.isActive)\n\n  // Collect all triggers\n  const allTriggers: AuditTrigger[] = [\n    ...analyzeScheduleCRatios(state, report),\n    ...analyzeDeductionTriggers(state, report),\n    ...analyzeEntityTriggers(state, report),\n    ...analyzeIncomeTriggers(state, report),\n    ...analyzeRetirementTriggers(state, report),\n  ]\n\n  const triggeredItems = allTriggers.filter(t => t.triggered)\n  const redFlags = triggeredItems.filter(t => t.severity === 'critical' || t.severity === 'high')\n  const yellowFlags = triggeredItems.filter(t => t.severity === 'medium')\n\n  // Calculate overall risk score\n  const maxPossibleScore = allTriggers.length * 100\n  const actualScore = triggeredItems.reduce((sum, t) => sum + t.riskScore, 0)\n  const overallScore = allTriggers.length > 0 ? Math.round((actualScore / maxPossibleScore) * 100) : 0\n\n  // Determine risk level\n  let riskLevel: AuditRiskProfile['riskLevel']\n  let riskLabel: string\n  if (overallScore >= 70) { riskLevel = 'very-high'; riskLabel = 'Very High Risk — Multiple red flags detected' }\n  else if (overallScore >= 50) { riskLevel = 'high'; riskLabel = 'High Risk — Significant audit triggers present' }\n  else if (overallScore >= 35) { riskLevel = 'elevated'; riskLabel = 'Elevated Risk — Some triggers warrant attention' }\n  else if (overallScore >= 20) { riskLevel = 'moderate'; riskLabel = 'Moderate Risk — Standard filing profile' }\n  else { riskLevel = 'low'; riskLabel = 'Low Risk — Clean filing profile' }\n\n  // Calculate adjusted audit rate\n  const baseRate = getBaseAuditRate(report.agi, hasSchedC)\n  const riskMultiplier = 1 + (overallScore / 100) * 3 // Up to 4x base rate\n  const adjustedRate = Math.min(baseRate * riskMultiplier, 0.25) // Cap at 25%\n\n  // Documentation score (inverse of risk, simplified)\n  const documentationScore = Math.max(0, 100 - overallScore - (redFlags.length * 10))\n\n  // Top recommendations\n  const topRecommendations: string[] = []\n  if (redFlags.length > 0) {\n    topRecommendations.push(`Address ${redFlags.length} high-severity trigger(s) immediately: ${redFlags.map(f => f.name).join(', ')}`)\n  }\n  if (hasSchedC) {\n    topRecommendations.push('Maintain meticulous business records — Schedule C filers are audited 2-3x more often')\n  }\n  if (report.agi > 200000) {\n    topRecommendations.push('Higher-income returns face elevated scrutiny — ensure all reporting is precise')\n  }\n  if (triggeredItems.some(t => t.id === 'scorp-salary')) {\n    topRecommendations.push('Get a reasonable compensation study for your S-Corp salary')\n  }\n  topRecommendations.push('Keep all documentation for at least 7 years (3 year statute + 4 year safety margin)')\n\n  return {\n    overallScore,\n    riskLevel,\n    riskLabel,\n    triggers: allTriggers.sort((a, b) => b.riskScore - a.riskScore),\n    triggeredCount: triggeredItems.length,\n    totalChecks: allTriggers.length,\n    baselineAuditRate: baseRate,\n    adjustedAuditRate: adjustedRate,\n    topRecommendations,\n    documentationScore,\n    redFlagCount: redFlags.length,\n    yellowFlagCount: yellowFlags.length,\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\balance-sheet.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\bank-feed.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":321,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":321,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14020,14023],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14020,14023],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":322,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":322,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14075,14078],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14075,14078],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'IncomeStream' is defined but never used.","line":447,"column":75,"nodeType":"Identifier","messageId":"unusedVar","endLine":447,"endColumn":87,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"IncomeStream"},"fix":{"range":[18581,18595],"text":""},"desc":"Remove unused variable \"IncomeStream\"."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE — Bank Feed Integration v1\n * \n * Plaid Link integration for automated bank transaction import:\n *   - Plaid Link initialization and token exchange\n *   - Transaction sync with incremental updates\n *   - Smart categorization (IRS expense categories)\n *   - Recurring expense detection\n *   - Schedule C line auto-mapping\n *   - Business vs personal transaction classification\n *   - Cash flow tracking and projections\n *   - Vendor consolidation\n * \n * Note: Requires Plaid API keys configured via environment/settings.\n * Falls back to manual CSV import when Plaid unavailable.\n */\n\n// ─── Types ──────────────────────────────────────────────────────────────────\n\nexport interface BankAccount {\n  id: string\n  plaidAccountId?: string\n  institutionName: string\n  accountName: string\n  accountType: 'checking' | 'savings' | 'credit_card' | 'investment' | 'loan'\n  mask: string                // last 4 digits\n  currentBalance: number\n  availableBalance?: number\n  isBusinessAccount: boolean\n  lastSynced?: string\n  accessToken?: string        // encrypted Plaid access token\n  entityId?: string           // Entity this account belongs to\n}\n\nexport interface BankTransaction {\n  id: string\n  accountId: string\n  plaidTransactionId?: string\n  date: string\n  description: string\n  merchantName?: string\n  amount: number              // positive = expense, negative = income\n  category: TransactionCategory\n  subcategory: string\n  scheduleCLine?: string\n  isBusinessExpense: boolean\n  isRecurring: boolean\n  recurringFrequency?: 'weekly' | 'biweekly' | 'monthly' | 'quarterly' | 'annual'\n  tags: string[]\n  notes: string\n  reviewed: boolean           // user has confirmed categorization\n  splitItems?: SplitItem[]    // for mixed business/personal\n  entityId?: string           // Entity this transaction belongs to\n}\n\nexport interface SplitItem {\n  description: string\n  amount: number\n  isBusinessExpense: boolean\n  scheduleCLine?: string\n}\n\nexport type TransactionCategory =\n  | 'income' | 'transfer'\n  | 'advertising' | 'car_truck' | 'commissions' | 'contract_labor'\n  | 'depreciation' | 'employee_benefits' | 'insurance' | 'interest'\n  | 'legal_professional' | 'office_expense' | 'rent_lease'\n  | 'repairs' | 'supplies' | 'taxes_licenses' | 'travel'\n  | 'meals' | 'utilities' | 'wages' | 'other_expense'\n  | 'home_office' | 'education' | 'software' | 'subscriptions'\n  | 'bank_fees' | 'personal' | 'uncategorized'\n\n// ─── Schedule C Line Mapping ────────────────────────────────────────────────\n\nexport const CATEGORY_TO_SCHEDULE_C: Record<TransactionCategory, { line: string; label: string } | null> = {\n  income:            null,\n  transfer:          null,\n  advertising:       { line: '8',   label: 'Advertising' },\n  car_truck:         { line: '9',   label: 'Car and truck expenses' },\n  commissions:       { line: '10',  label: 'Commissions and fees' },\n  contract_labor:    { line: '11',  label: 'Contract labor' },\n  depreciation:      { line: '13',  label: 'Depreciation' },\n  employee_benefits: { line: '14',  label: 'Employee benefit programs' },\n  insurance:         { line: '15',  label: 'Insurance (other than health)' },\n  interest:          { line: '16b', label: 'Interest (other)' },\n  legal_professional:{ line: '17',  label: 'Legal and professional services' },\n  office_expense:    { line: '18',  label: 'Office expense' },\n  rent_lease:        { line: '20b', label: 'Rent or lease (other)' },\n  repairs:           { line: '21',  label: 'Repairs and maintenance' },\n  supplies:          { line: '22',  label: 'Supplies' },\n  taxes_licenses:    { line: '23',  label: 'Taxes and licenses' },\n  travel:            { line: '24a', label: 'Travel' },\n  meals:             { line: '24b', label: 'Meals (subject to 50% limitation)' },\n  utilities:         { line: '25',  label: 'Utilities' },\n  wages:             { line: '26',  label: 'Wages' },\n  other_expense:     { line: '27a', label: 'Other expenses' },\n  home_office:       { line: '30',  label: 'Business use of home' },\n  education:         { line: '27a', label: 'Other expenses (education)' },\n  software:          { line: '18',  label: 'Office expense (software)' },\n  subscriptions:     { line: '27a', label: 'Other expenses (subscriptions)' },\n  bank_fees:         { line: '27a', label: 'Other expenses (bank fees)' },\n  personal:          null,\n  uncategorized:     null,\n}\n\n// ─── Auto-Categorization Rules ──────────────────────────────────────────────\n\ninterface CategoryRule {\n  pattern: RegExp\n  category: TransactionCategory\n  isBusinessExpense: boolean\n}\n\nconst CATEGORIZATION_RULES: CategoryRule[] = [\n  // Advertising\n  { pattern: /\\b(google\\s*ads|facebook\\s*ads|meta\\s*ads|twitter\\s*ads|linkedin\\s*ads|bing\\s*ads|tiktok\\s*ads|mailchimp|constant\\s*contact|sendgrid)\\b/i, category: 'advertising', isBusinessExpense: true },\n  // Software/SaaS\n  { pattern: /\\b(adobe|microsoft\\s*365|google\\s*workspace|slack|zoom|notion|figma|canva|github|aws|azure|digital\\s*ocean|heroku|vercel|netlify|hostinger|cloudflare|openai|anthropic)\\b/i, category: 'software', isBusinessExpense: true },\n  // Office supplies\n  { pattern: /\\b(staples|office\\s*depot|amazon|best\\s*buy|newegg|b&h\\s*photo)\\b/i, category: 'office_expense', isBusinessExpense: true },\n  // Travel\n  { pattern: /\\b(airline|delta|united|american\\s*airlines|southwest|jetblue|spirit|frontier|hotel|marriott|hilton|hyatt|airbnb|vrbo|uber|lyft|taxi|rental\\s*car|hertz|avis|enterprise)\\b/i, category: 'travel', isBusinessExpense: true },\n  // Meals\n  { pattern: /\\b(restaurant|doordash|grubhub|uber\\s*eats|starbucks|mcdonald|chipotle|panera|subway|pizza)\\b/i, category: 'meals', isBusinessExpense: true },\n  // Insurance\n  { pattern: /\\b(geico|state\\s*farm|allstate|progressive|liberty\\s*mutual|nationwide|usaa).*(?:business|commercial|liability)/i, category: 'insurance', isBusinessExpense: true },\n  // Legal/Professional\n  { pattern: /\\b(attorney|lawyer|law\\s*firm|cpa|accountant|bookkeeper|tax\\s*prep|legal\\s*zoom|legalshield)\\b/i, category: 'legal_professional', isBusinessExpense: true },\n  // Utilities\n  { pattern: /\\b(electric|gas\\s*bill|water\\s*bill|internet|comcast|att|verizon|t-?mobile|spectrum|cox)\\b/i, category: 'utilities', isBusinessExpense: true },\n  // Contract labor\n  { pattern: /\\b(fiverr|upwork|toptal|freelancer|99designs|guru\\.com)\\b/i, category: 'contract_labor', isBusinessExpense: true },\n  // Vehicle\n  { pattern: /\\b(shell|chevron|exxon|bp|gas\\s*station|auto\\s*parts|autozone|o'reilly|napa|jiffy\\s*lube|valvoline)\\b/i, category: 'car_truck', isBusinessExpense: true },\n  // Education\n  { pattern: /\\b(udemy|coursera|linkedin\\s*learning|skillshare|masterclass|conference|workshop|seminar)\\b/i, category: 'education', isBusinessExpense: true },\n  // Subscriptions\n  { pattern: /\\b(subscription|monthly\\s*fee|annual\\s*fee|membership)\\b/i, category: 'subscriptions', isBusinessExpense: true },\n  // Bank fees\n  { pattern: /\\b(bank\\s*fee|service\\s*charge|overdraft|wire\\s*fee|atm\\s*fee|monthly\\s*maintenance)\\b/i, category: 'bank_fees', isBusinessExpense: true },\n  // Rent\n  { pattern: /\\b(coworking|wework|regus|office\\s*space|rent\\s*payment)\\b/i, category: 'rent_lease', isBusinessExpense: true },\n  // Personal (not deductible)\n  { pattern: /\\b(grocery|walmart\\s*(?!office)|target|costco|netflix|hulu|spotify|gym|fitness|clothing|apparel)\\b/i, category: 'personal', isBusinessExpense: false },\n  // Income patterns\n  { pattern: /\\b(deposit|payment\\s*received|revenue|client\\s*payment|invoice\\s*payment|stripe|paypal.*(?:payment|deposit)|square.*deposit)\\b/i, category: 'income', isBusinessExpense: false },\n  // Transfers\n  { pattern: /\\b(transfer|xfer|ach.*(?:from|to)\\s*(?:savings|checking)|zelle|venmo.*transfer)\\b/i, category: 'transfer', isBusinessExpense: false },\n]\n\nexport function categorizeTransaction(description: string, merchantName?: string, amount?: number): {\n  category: TransactionCategory\n  isBusinessExpense: boolean\n  scheduleCLine?: string\n  confidence: number\n} {\n  const text = `${description} ${merchantName || ''}`.toLowerCase()\n\n  for (const rule of CATEGORIZATION_RULES) {\n    if (rule.pattern.test(text)) {\n      const mapping = CATEGORY_TO_SCHEDULE_C[rule.category]\n      return {\n        category: rule.category,\n        isBusinessExpense: rule.isBusinessExpense,\n        scheduleCLine: mapping?.line,\n        confidence: 75,\n      }\n    }\n  }\n\n  // Income heuristic (negative amounts in bank feeds = deposits)\n  if (amount !== undefined && amount < 0) {\n    return { category: 'income', isBusinessExpense: false, confidence: 50 }\n  }\n\n  return { category: 'uncategorized', isBusinessExpense: false, confidence: 0 }\n}\n\n// ─── Recurring Detection ────────────────────────────────────────────────────\n\nexport function detectRecurring(transactions: BankTransaction[]): BankTransaction[] {\n  // Group by merchant + similar amount\n  const groups: Record<string, BankTransaction[]> = {}\n\n  for (const tx of transactions) {\n    const key = (tx.merchantName || tx.description.substring(0, 20)).toLowerCase().replace(/[^a-z]/g, '')\n    if (!groups[key]) groups[key] = []\n    groups[key].push(tx)\n  }\n\n  const updated = [...transactions]\n\n  for (const [, group] of Object.entries(groups)) {\n    if (group.length < 2) continue\n\n    // Sort by date\n    group.sort((a, b) => a.date.localeCompare(b.date))\n\n    // Check for consistent intervals\n    const intervals: number[] = []\n    for (let i = 1; i < group.length; i++) {\n      const d1 = new Date(group[i - 1].date)\n      const d2 = new Date(group[i].date)\n      intervals.push(Math.round((d2.getTime() - d1.getTime()) / (1000 * 60 * 60 * 24)))\n    }\n\n    const avgInterval = intervals.reduce((s, n) => s + n, 0) / intervals.length\n    const deviation = Math.max(...intervals.map(i => Math.abs(i - avgInterval)))\n\n    let frequency: BankTransaction['recurringFrequency'] | undefined\n    if (avgInterval >= 5 && avgInterval <= 10 && deviation < 3) frequency = 'weekly'\n    else if (avgInterval >= 12 && avgInterval <= 18 && deviation < 4) frequency = 'biweekly'\n    else if (avgInterval >= 25 && avgInterval <= 35 && deviation < 5) frequency = 'monthly'\n    else if (avgInterval >= 80 && avgInterval <= 100 && deviation < 10) frequency = 'quarterly'\n    else if (avgInterval >= 340 && avgInterval <= 395 && deviation < 30) frequency = 'annual'\n\n    if (frequency) {\n      for (const tx of group) {\n        const idx = updated.findIndex(t => t.id === tx.id)\n        if (idx >= 0) {\n          updated[idx] = { ...updated[idx], isRecurring: true, recurringFrequency: frequency }\n        }\n      }\n    }\n  }\n\n  return updated\n}\n\n// ─── Schedule C Aggregation ─────────────────────────────────────────────────\n\nexport function aggregateScheduleC(transactions: BankTransaction[]): {\n  line: string; label: string; total: number; count: number; transactions: BankTransaction[]\n}[] {\n  const businessTx = transactions.filter(t => t.isBusinessExpense && t.reviewed)\n  const byLine: Record<string, { label: string; total: number; count: number; transactions: BankTransaction[] }> = {}\n\n  for (const tx of businessTx) {\n    const line = tx.scheduleCLine || '27a'\n    const mapping = Object.values(CATEGORY_TO_SCHEDULE_C).find(m => m?.line === line)\n    const label = mapping?.label || 'Other expenses'\n\n    if (!byLine[line]) byLine[line] = { label, total: 0, count: 0, transactions: [] }\n    byLine[line].total += Math.abs(tx.amount)\n    byLine[line].count++\n    byLine[line].transactions.push(tx)\n  }\n\n  return Object.entries(byLine)\n    .map(([line, data]) => ({ line, ...data }))\n    .sort((a, b) => a.line.localeCompare(b.line))\n}\n\n// ─── Cash Flow Analysis ─────────────────────────────────────────────────────\n\nexport function analyzeCashFlow(transactions: BankTransaction[], months: number = 6): {\n  monthlyIncome: number[]\n  monthlyExpenses: number[]\n  monthlyNet: number[]\n  averageMonthlyIncome: number\n  averageMonthlyExpenses: number\n  burnRate: number\n  runwayMonths: number | null\n  topExpenseCategories: { category: string; total: number; percentage: number }[]\n} {\n  const now = new Date()\n  const monthlyIncome: number[] = Array(months).fill(0)\n  const monthlyExpenses: number[] = Array(months).fill(0)\n  const categoryTotals: Record<string, number> = {}\n\n  for (const tx of transactions) {\n    const txDate = new Date(tx.date)\n    const monthsAgo = (now.getFullYear() - txDate.getFullYear()) * 12 + now.getMonth() - txDate.getMonth()\n    \n    if (monthsAgo < 0 || monthsAgo >= months) continue\n    const idx = months - 1 - monthsAgo\n\n    if (tx.amount < 0 || tx.category === 'income') {\n      monthlyIncome[idx] += Math.abs(tx.amount)\n    } else if (tx.category !== 'transfer') {\n      monthlyExpenses[idx] += tx.amount\n      categoryTotals[tx.category] = (categoryTotals[tx.category] || 0) + tx.amount\n    }\n  }\n\n  const monthlyNet = monthlyIncome.map((inc, i) => inc - monthlyExpenses[i])\n  const totalExpenses = monthlyExpenses.reduce((s, n) => s + n, 0)\n  const avgIncome = monthlyIncome.reduce((s, n) => s + n, 0) / months\n  const avgExpenses = totalExpenses / months\n\n  const topExpenseCategories = Object.entries(categoryTotals)\n    .map(([category, total]) => ({\n      category,\n      total,\n      percentage: totalExpenses > 0 ? Math.round((total / totalExpenses) * 1000) / 10 : 0,\n    }))\n    .sort((a, b) => b.total - a.total)\n    .slice(0, 10)\n\n  return {\n    monthlyIncome, monthlyExpenses, monthlyNet,\n    averageMonthlyIncome: Math.round(avgIncome),\n    averageMonthlyExpenses: Math.round(avgExpenses),\n    burnRate: Math.round(avgExpenses),\n    runwayMonths: avgExpenses > avgIncome ? Math.round((avgIncome * months) / avgExpenses) : null,\n    topExpenseCategories,\n  }\n}\n\n// ─── Plaid Integration Helpers ──────────────────────────────────────────────\n\nexport interface PlaidConfig {\n  clientId: string\n  environment: 'sandbox' | 'development' | 'production'\n  webhookUrl?: string\n}\n\nexport function getPlaidLinkConfig(config: PlaidConfig, linkToken: string) {\n  return {\n    token: linkToken,\n    onSuccess: (publicToken: string, metadata: any) => ({ publicToken, metadata }),\n    onExit: (err: any) => ({ error: err }),\n    onEvent: (eventName: string) => ({ event: eventName }),\n  }\n}\n\n// Endpoint to call from backend to exchange public token\nexport function getPlaidExchangeEndpoint(config: PlaidConfig) {\n  const baseUrl = config.environment === 'production'\n    ? 'https://production.plaid.com'\n    : config.environment === 'development'\n    ? 'https://development.plaid.com'\n    : 'https://sandbox.plaid.com'\n\n  return {\n    createLinkToken: `${baseUrl}/link/token/create`,\n    exchangeToken: `${baseUrl}/item/public_token/exchange`,\n    getTransactions: `${baseUrl}/transactions/sync`,\n    getAccounts: `${baseUrl}/accounts/get`,\n    getBalances: `${baseUrl}/accounts/balance/get`,\n  }\n}\n\n// ─── Storage ────────────────────────────────────────────────────────────────\n\nconst ACCOUNTS_KEY = 'fortuna:bank-accounts'\nconst TRANSACTIONS_KEY = 'fortuna:bank-transactions'\n\nexport function saveAccounts(accounts: BankAccount[]) {\n  localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(accounts))\n}\n\nexport function loadAccounts(): BankAccount[] {\n  try { return JSON.parse(localStorage.getItem(ACCOUNTS_KEY) || '[]') } catch { return [] }\n}\n\nexport function saveTransactions(transactions: BankTransaction[]) {\n  try { localStorage.setItem(TRANSACTIONS_KEY, JSON.stringify(transactions)) } catch {\n    console.warn('[BankFeed] Storage quota — keep only recent 6 months')\n    const sixMonthsAgo = new Date()\n    sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6)\n    const recent = transactions.filter(t => new Date(t.date) >= sixMonthsAgo)\n    localStorage.setItem(TRANSACTIONS_KEY, JSON.stringify(recent))\n  }\n}\n\nexport function loadTransactions(): BankTransaction[] {\n  try { return JSON.parse(localStorage.getItem(TRANSACTIONS_KEY) || '[]') } catch { return [] }\n}\n\n// ─── Manual Transaction Import ──────────────────────────────────────────────\n\nexport function importBankCSV(csvText: string): BankTransaction[] {\n  const lines = csvText.split('\\n').filter(l => l.trim())\n  if (lines.length < 2) return []\n\n  const headers = lines[0].toLowerCase()\n  const transactions: BankTransaction[] = []\n\n  for (let i = 1; i < lines.length; i++) {\n    const cols = lines[i].split(',').map(c => c.replace(/^\"|\"$/g, '').trim())\n    if (cols.length < 3) continue\n\n    // Detect column layout\n    let date = '', description = '', amount = 0\n\n    if (headers.includes('date')) {\n      const dateIdx = headers.split(',').findIndex(h => h.trim().includes('date'))\n      const descIdx = headers.split(',').findIndex(h => h.trim().match(/desc|memo|narration|payee/))\n      const amtIdx = headers.split(',').findIndex(h => h.trim().match(/amount|value|sum/))\n      const debitIdx = headers.split(',').findIndex(h => h.trim().includes('debit'))\n      const creditIdx = headers.split(',').findIndex(h => h.trim().includes('credit'))\n\n      date = cols[dateIdx] || cols[0]\n      description = cols[descIdx >= 0 ? descIdx : 1] || ''\n      \n      if (amtIdx >= 0) {\n        amount = parseFloat(cols[amtIdx]?.replace(/[$,]/g, '') || '0')\n      } else if (debitIdx >= 0 && creditIdx >= 0) {\n        const debit = parseFloat(cols[debitIdx]?.replace(/[$,]/g, '') || '0')\n        const credit = parseFloat(cols[creditIdx]?.replace(/[$,]/g, '') || '0')\n        amount = debit > 0 ? debit : -credit\n      }\n    } else {\n      // Fallback: assume date, description, amount\n      date = cols[0]\n      description = cols[1]\n      amount = parseFloat(cols[2]?.replace(/[$,]/g, '') || '0')\n    }\n\n    if (!date || isNaN(amount)) continue\n\n    const { category, isBusinessExpense, scheduleCLine } = categorizeTransaction(description, undefined, amount)\n\n    transactions.push({\n      id: 'btx_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 4) + i,\n      accountId: 'manual',\n      date: normalizeDate(date),\n      description,\n      amount,\n      category,\n      subcategory: '',\n      scheduleCLine,\n      isBusinessExpense,\n      isRecurring: false,\n      tags: [],\n      notes: '',\n      reviewed: false,\n    })\n  }\n\n  return detectRecurring(transactions)\n}\n\nfunction normalizeDate(dateStr: string): string {\n  try {\n    const d = new Date(dateStr)\n    if (!isNaN(d.getTime())) return d.toISOString().split('T')[0]\n  } catch { /* */ }\n  return dateStr\n}\n\n// ─── Phase F: Polarity Adapters ──────────────────────────────────────────────\n// Bank-feed: positive = expense, negative = income\n// Storage:   positive = income,  negative = expense\n\nimport type { BankTransaction as StorageBankTransaction, BusinessExpense, IncomeStream } from './storage'\n\n/** Convert bank-feed transaction → storage transaction (flip polarity) */\nexport function toStorageTransaction(bt: BankTransaction): StorageBankTransaction {\n  return {\n    id: bt.id,\n    date: bt.date,\n    description: bt.merchantName || bt.description,\n    amount: -bt.amount,  // FLIP: bank positive(expense) → storage negative(expense)\n    category: bt.category,\n    isReconciled: bt.reviewed,\n    linkedExpenseId: bt.isBusinessExpense ? bt.id : undefined,\n    accountName: bt.accountId,\n    entityId: bt.entityId || 'personal',\n    memberId: 'primary',\n    taxYear: new Date(bt.date).getFullYear(),\n    tags: bt.tags,\n  }\n}\n\n/** Convert storage transaction → bank-feed transaction (flip polarity) */\nexport function fromStorageTransaction(st: StorageBankTransaction): BankTransaction {\n  return {\n    id: st.id,\n    accountId: st.accountName || '',\n    date: st.date,\n    description: st.description,\n    amount: -st.amount,  // FLIP: storage positive(income) → bank negative(income)\n    category: (st.category || 'other') as TransactionCategory,\n    subcategory: '',\n    isBusinessExpense: !!st.linkedExpenseId,\n    isRecurring: false,\n    tags: st.tags || [],\n    notes: st.notes || '',\n    reviewed: st.isReconciled,\n    entityId: st.entityId,\n  }\n}\n\n// ─── Phase G: Cross-Process Converters ───────────────────────────────────────\n\nconst SCHEDULE_C_LINE_MAP: Record<string, string> = {\n  advertising: '8', car_truck: '9', commissions: '10', contract_labor: '11',\n  depreciation: '13', employee_benefits: '14', insurance: '15', interest: '16',\n  legal_professional: '17', office_expense: '18', rent_lease: '20b',\n  repairs: '21', supplies: '22', taxes_licenses: '23', travel: '24a',\n  meals: '24b', utilities: '25', other_expense: '27a', home_office: '30',\n}\n\n/** Convert business transactions → FortunaState expenses (auto-categorize) */\nexport function transactionsToExpenses(\n  transactions: BankTransaction[],\n  existingExpenseIds: Set<string> = new Set(),\n): BusinessExpense[] {\n  const bizTxns = transactions.filter(t => t.isBusinessExpense && t.amount > 0)\n\n  // Aggregate by month+category for annualization\n  const byCat = new Map<string, { total: number; count: number; desc: string; entityId?: string }>()\n  for (const t of bizTxns) {\n    if (existingExpenseIds.has(t.id)) continue\n    const key = t.category\n    const existing = byCat.get(key)\n    if (existing) {\n      existing.total += t.amount\n      existing.count++\n    } else {\n      byCat.set(key, { total: t.amount, count: 1, desc: t.merchantName || t.description, entityId: t.entityId })\n    }\n  }\n\n  // Determine date range for annualization\n  const dates = bizTxns.map(t => new Date(t.date).getTime()).sort()\n  const spanDays = dates.length > 1 ? (dates[dates.length - 1] - dates[0]) / (1000 * 60 * 60 * 24) : 365\n  const annualizeFactor = spanDays > 30 ? 365 / spanDays : 1\n\n  return [...byCat.entries()].map(([cat, data]) => ({\n    id: `bank-exp-${cat}`,\n    category: cat === 'meals' ? 'meals_entertainment' : cat === 'car_truck' ? 'auto' : cat,\n    description: `${data.desc}${data.count > 1 ? ` (+${data.count - 1} more)` : ''}`,\n    annualAmount: Math.round(data.total * annualizeFactor),\n    isDeductible: true,\n    deductionPct: cat === 'meals' ? 50 : 100,\n    scheduleCLine: SCHEDULE_C_LINE_MAP[cat],\n    entityId: data.entityId || 'personal',\n    memberId: 'primary',\n    taxYear: new Date().getFullYear(),\n    tags: ['auto-categorized', 'bank-feed'],\n  }))\n}\n\n/** Convert income transactions → FortunaState income streams */\nexport function transactionsToIncomeStreams(\n  transactions: BankTransaction[],\n): { id: string; name: string; type: string; annualAmount: number; entityId?: string }[] {\n  const incomeTxns = transactions.filter(t => t.amount < 0) // negative = income in bank-feed\n  if (incomeTxns.length === 0) return []\n\n  // Group by merchant/source\n  const bySource = new Map<string, { total: number; count: number; entityId?: string }>()\n  for (const t of incomeTxns) {\n    const key = t.merchantName || t.description.substring(0, 30)\n    const existing = bySource.get(key)\n    if (existing) {\n      existing.total += Math.abs(t.amount)\n      existing.count++\n    } else {\n      bySource.set(key, { total: Math.abs(t.amount), count: 1, entityId: t.entityId })\n    }\n  }\n\n  const dates = incomeTxns.map(t => new Date(t.date).getTime()).sort()\n  const spanDays = dates.length > 1 ? (dates[dates.length - 1] - dates[0]) / (1000 * 60 * 60 * 24) : 365\n  const annualizeFactor = spanDays > 30 ? 365 / spanDays : 1\n\n  return [...bySource.entries()]\n    .filter(([, data]) => data.total > 500)\n    .map(([source, data]) => ({\n      id: `bank-income-${source.replace(/\\s/g, '-').substring(0, 20)}`,\n      name: source,\n      type: 'business',\n      annualAmount: Math.round(data.total * annualizeFactor),\n      entityId: data.entityId,\n    }))\n}\n\n/** Get transactions filtered by entity */\nexport function getTransactionsForEntity(transactions: BankTransaction[], entityId: string): BankTransaction[] {\n  return transactions.filter(t => (t.entityId || 'personal') === entityId)\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\batch-intake.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":17,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[592,595],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[592,595],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":26,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":26,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[879,882],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[879,882],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":43,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1445,1448],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1445,1448],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":64,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":64,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2227,2230],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2227,2230],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":85,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":85,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2959,2962],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2959,2962],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect } from 'vitest'\r\nimport { processBatch, autoRouteBatch } from './batch-intake'\r\nimport { createDefaultState } from './storage'\r\nimport type { FortunaState } from './storage'\r\n\r\ndescribe('Batch Receipt Intake', () => {\r\n    const mockState: FortunaState = {\r\n        ...createDefaultState(),\r\n        receipts: [\r\n            {\r\n                id: 'existing-1',\r\n                merchantName: 'Starbucks',\r\n                date: '2026-02-10',\r\n                totalAmount: 5.50,\r\n                items: [],\r\n                status: 'allocated'\r\n            } as any\r\n        ],\r\n        intakeBatches: [\r\n            {\r\n                id: 'batch-123',\r\n                name: 'Trip to Seattle',\r\n                status: 'uploading',\r\n                receiptIds: ['new-1', 'new-2'],\r\n                defaultEntityId: 'business-abc'\r\n            } as any\r\n        ]\r\n    }\r\n\r\n    it('should detect duplicates against history and mark them for review', async () => {\r\n        const state = { \r\n            ...mockState, \r\n            receipts: [\r\n                ...mockState.receipts!,\r\n                {\r\n                    id: 'new-1',\r\n                    merchantName: 'Starbucks', // Duplicate\r\n                    date: '2026-02-10',\r\n                    totalAmount: 5.50,\r\n                    batchId: 'batch-123',\r\n                    status: 'scanned',\r\n                    items: []\r\n                } as any\r\n            ]\r\n        } as FortunaState\r\n\r\n        const { draft, result } = await processBatch(state, 'batch-123')\r\n        expect(result.duplicatesFound).toBe(1)\r\n        expect(draft.receipts.find(r => r.id === 'new-1')?.status).toBe('needs_review')\r\n    })\r\n\r\n    it('should auto-route receipts to the batch default entity', () => {\r\n        const state = {\r\n            ...mockState,\r\n            receipts: [\r\n                {\r\n                    id: 'new-2',\r\n                    merchantName: 'Uber',\r\n                    date: '2026-02-11',\r\n                    totalAmount: 25.00,\r\n                    batchId: 'batch-123',\r\n                    status: 'scanned',\r\n                    items: [{ id: 'i1', amount: 25.00, description: 'Ride' }]\r\n                } as any\r\n            ]\r\n        } as FortunaState\r\n\r\n        autoRouteBatch(state, 'batch-123')\r\n        const receipt = state.receipts.find(r => r.id === 'new-2')\r\n        expect(receipt?.items[0].allocatedEntityId).toBe('business-abc')\r\n    })\r\n\r\n    it('should detect total mismatches as conflicts', () => {\r\n        const state = {\r\n            ...mockState,\r\n            receipts: [\r\n                {\r\n                    id: 'new-3',\r\n                    merchantName: 'OfficeMax',\r\n                    totalAmount: 100.00,\r\n                    batchId: 'batch-123',\r\n                    items: [\r\n                        { id: 'i1', amount: 50.00, description: 'Paper' } // Only 50%\r\n                    ]\r\n                } as any\r\n            ]\r\n        } as FortunaState\r\n\r\n        const conflicts = autoRouteBatch(state, 'batch-123')\r\n        expect(conflicts.some(c => c.type === 'total_mismatch')).toBe(true)\r\n        expect(state.receipts.find(r => r.id === 'new-3')?.status).toBe('needs_review')\r\n    })\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\batch-intake.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":83,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":83,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2794,2797],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2794,2797],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":98,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":98,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3301,3304],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3301,3304],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { FortunaState, ReceiptRecord, IntakeBatch } from './storage'\r\nimport { genId } from './storage'\r\nimport { processReceiptsAsync } from './receipt-engine'\r\n\r\nexport interface BatchProcessingResult {\r\n    batchId: string\r\n    itemsProcessed: number\r\n    duplicatesFound: number\r\n    errors: string[]\r\n}\r\n\r\nexport interface BatchIntakeJob {\r\n    id: string;\r\n    type: 'vendor_sync' | 'bulk_upload' | 'mobile_scan';\r\n    status: 'pending' | 'processing' | 'completed' | 'failed';\r\n    sourceName: string;\r\n    dateCreated: string;\r\n    progress: number;\r\n}\r\n\r\n/**\r\n * Advanced Batch Document Intake Engine\r\n * Handles bulk ingestion with concurrency control and global deduplication.\r\n */\r\n\r\nexport function createBatch(name: string, totalCount: number = 0): IntakeBatch {\r\n    return {\r\n        id: genId(),\r\n        name,\r\n        dateStarted: new Date().toISOString(),\r\n        status: 'uploading',\r\n        totalCount,\r\n        successCount: 0,\r\n        errorCount: 0,\r\n        receiptIds: [],\r\n        documentIds: [],\r\n        progress: 0,\r\n        entityId: 'personal', // Default attribution\r\n        taxYear: new Date().getFullYear()\r\n    }\r\n}\r\n\r\nexport async function processBatch(\r\n    state: FortunaState,\r\n    batchId: string,\r\n    onProgress?: (progress: number) => void,\r\n    useAI: boolean = false\r\n): Promise<{ draft: FortunaState; result: BatchProcessingResult }> {\r\n    const draft = JSON.parse(JSON.stringify(state)) as FortunaState\r\n    const batch = draft.intakeBatches.find(b => b.id === batchId)\r\n    if (!batch) throw new Error(`Batch ${batchId} not found`)\r\n\r\n    batch.status = 'processing'\r\n    const result: BatchProcessingResult = {\r\n        batchId,\r\n        itemsProcessed: 0,\r\n        duplicatesFound: 0,\r\n        errors: []\r\n    }\r\n\r\n    // Process Receipts\r\n    const pendingReceipts = draft.receipts.filter(r => r.batchId === batchId && (r.status === 'scanned' || r.status === 'processing' || r.status === 'needs_review'))\r\n\r\n    // Process general Documents\r\n    const pendingDocuments = draft.documents.filter(d => d.batchId === batchId && (d.status === 'pending' || d.status === 'needs_review'))\r\n\r\n    const totalToProcess = pendingReceipts.length + pendingDocuments.length\r\n    let count = 0\r\n\r\n    // 1. Process Receipts\r\n    for (const receipt of pendingReceipts) {\r\n        try {\r\n            if (isDuplicate(receipt, draft.receipts)) {\r\n                receipt.status = 'needs_review'\r\n                result.duplicatesFound++\r\n                batch.errorCount++\r\n            } else {\r\n                receipt.status = 'processing'\r\n                await new Promise(resolve => setTimeout(resolve, 50)) // Artificial delay\r\n                result.itemsProcessed++\r\n                batch.successCount++\r\n            }\r\n        } catch (err: any) {\r\n            result.errors.push(`Error processing receipt ${receipt.id}: ${err.message}`)\r\n            batch.errorCount++\r\n        }\r\n        count++\r\n        batch.progress = Math.round((count / (totalToProcess || 1)) * 100)\r\n        onProgress?.(batch.progress)\r\n    }\r\n\r\n    // 2. Process General Documents\r\n    for (const doc of pendingDocuments) {\r\n        try {\r\n            doc.status = 'processed'\r\n            result.itemsProcessed++\r\n            batch.successCount++\r\n        } catch (err: any) {\r\n            result.errors.push(`Error processing document ${doc.id}: ${err.message}`)\r\n            batch.errorCount++\r\n        }\r\n        count++\r\n        batch.progress = Math.round((count / (totalToProcess || 1)) * 100)\r\n        onProgress?.(batch.progress)\r\n    }\r\n\r\n    if (useAI) {\r\n        await processReceiptsAsync(draft, batchId)\r\n\r\n        batch.successCount = draft.receipts.filter(r => r.batchId === batchId && r.status === 'allocated').length +\r\n            draft.documents.filter(d => d.batchId === batchId && d.status === 'processed').length\r\n\r\n        batch.errorCount = draft.receipts.filter(r => r.batchId === batchId && r.status === 'needs_review').length +\r\n            draft.documents.filter(d => d.batchId === batchId && d.status === 'needs_review').length\r\n    }\r\n\r\n    batch.progress = 100\r\n    onProgress?.(100)\r\n    batch.status = 'completed'\r\n    batch.dateCompleted = new Date().toISOString()\r\n\r\n    return { draft, result }\r\n}\r\n\r\n/**\r\n * Global Deduplication Logic\r\n * Fuzzy matching for merchants and exact matching for date/amount.\r\n */\r\nfunction isDuplicate(receipt: ReceiptRecord, history: ReceiptRecord[]): boolean {\r\n    const normalizedMerchant = receipt.merchantName.toLowerCase().replace(/[^a-z0-9]/g, '')\r\n\r\n    return history.some(prev => {\r\n        if (prev.id === receipt.id) return false\r\n\r\n        const prevMerchant = prev.merchantName.toLowerCase().replace(/[^a-z0-9]/g, '')\r\n        const isMerchantMatch = normalizedMerchant.includes(prevMerchant) || prevMerchant.includes(normalizedMerchant)\r\n        const isDateMatch = prev.date === receipt.date\r\n        const isAmountMatch = Math.abs(prev.totalAmount - receipt.totalAmount) < 0.01\r\n\r\n        return isMerchantMatch && isDateMatch && isAmountMatch\r\n    })\r\n}\r\n\r\n/**\r\n * Conflict Resolution Interface\r\n */\r\nexport interface BatchConflict {\r\n    receiptId: string\r\n    type: 'duplicate' | 'total_mismatch' | 'unrecognized_merchant'\r\n    severity: 'warning' | 'error'\r\n    message: string\r\n    suggestedAction: string\r\n    autoResolve?: () => void\r\n}\r\n\r\n/**\r\n * Automated Batch Splitting & Routing\r\n */\r\nexport function autoRouteBatch(state: FortunaState, batchId: string): BatchConflict[] {\r\n    const receipts = state.receipts.filter(r => r.batchId === batchId)\r\n    const batch = state.intakeBatches.find(b => b.id === batchId)\r\n    if (!batch) return []\r\n\r\n    const conflicts: BatchConflict[] = []\r\n\r\n    for (const receipt of receipts) {\r\n        // 1. Verify Item Totals\r\n        const itemSum = receipt.items.reduce((sum, i) => sum + i.amount, 0)\r\n        if (Math.abs(itemSum - receipt.totalAmount) > 0.01) {\r\n            conflicts.push({\r\n                receiptId: receipt.id,\r\n                type: 'total_mismatch',\r\n                severity: 'error',\r\n                message: `Sum of items ($${itemSum.toFixed(2)}) does not match receipt total ($${receipt.totalAmount.toFixed(2)})`,\r\n                suggestedAction: 'Adjust item amounts or header total.'\r\n            })\r\n            receipt.status = 'needs_review'\r\n        }\r\n\r\n        // 2. Multi-Entity Routing (Cross-batch Context)\r\n        // If we see a pattern in the batch (e.g. all other receipts are for Entity A),\r\n        // we can flag outliers.\r\n        const dominantEntity = batch.defaultEntityId\r\n        if (dominantEntity) {\r\n            receipt.items.forEach(item => {\r\n                if (!item.allocatedEntityId) {\r\n                    item.allocatedEntityId = dominantEntity\r\n                }\r\n            })\r\n        }\r\n    }\r\n\r\n    return conflicts\r\n}\r\n\r\n/**\r\n * Manual/Auto Resolution Trigger\r\n */\r\nexport function resolveConflict(state: FortunaState, receiptId: string, action: 'keep_duplicate' | 'recalculate_total' | 'ignore'): void {\r\n    const receipt = state.receipts.find(r => r.id === receiptId)\r\n    if (!receipt) return\r\n\r\n    if (action === 'keep_duplicate') {\r\n        receipt.status = 'allocated'\r\n    } else if (action === 'recalculate_total') {\r\n        receipt.totalAmount = receipt.items.reduce((sum, i) => sum + i.amount, 0)\r\n        receipt.status = 'allocated'\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\blob-store.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":32,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[913,916],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[913,916],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * BlobStore — IndexedDB-based large binary storage for Fortuna Engine.\r\n * Used to store high-resolution document images and bypass localStorage limits.\r\n */\r\n\r\nconst DB_NAME = 'fortuna_blob_store'\r\nconst STORE_NAME = 'blobs'\r\nconst DB_VERSION = 1\r\n\r\nexport interface BlobRecord {\r\n    id: string\r\n    data: string // Base64 or Blob\r\n    mimeType: string\r\n    timestamp: number\r\n}\r\n\r\nclass BlobStoreClass {\r\n    private db: IDBDatabase | null = null\r\n\r\n    private async getDB(): Promise<IDBDatabase> {\r\n        if (this.db) return this.db\r\n\r\n        return new Promise((resolve, reject) => {\r\n            const request = indexedDB.open(DB_NAME, DB_VERSION)\r\n\r\n            request.onerror = () => reject(request.error)\r\n            request.onsuccess = () => {\r\n                this.db = request.result\r\n                resolve(request.result)\r\n            }\r\n\r\n            request.onupgradeneeded = (event: any) => {\r\n                const db = event.target.result\r\n                if (!db.objectStoreNames.contains(STORE_NAME)) {\r\n                    db.createObjectStore(STORE_NAME, { keyPath: 'id' })\r\n                }\r\n            }\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Store a large string or Blob.\r\n     */\r\n    async save(id: string, data: string, mimeType: string = 'image/jpeg'): Promise<void> {\r\n        const db = await this.getDB()\r\n        return new Promise((resolve, reject) => {\r\n            const transaction = db.transaction([STORE_NAME], 'readwrite')\r\n            const store = transaction.objectStore(STORE_NAME)\r\n            \r\n            const record: BlobRecord = {\r\n                id,\r\n                data,\r\n                mimeType,\r\n                timestamp: Date.now()\r\n            }\r\n\r\n            const request = store.put(record)\r\n            request.onerror = () => reject(request.error)\r\n            request.onsuccess = () => resolve()\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Retrieve data from the store.\r\n     */\r\n    async get(id: string): Promise<BlobRecord | null> {\r\n        const db = await this.getDB()\r\n        return new Promise((resolve, reject) => {\r\n            const transaction = db.transaction([STORE_NAME], 'readonly')\r\n            const store = transaction.objectStore(STORE_NAME)\r\n            const request = store.get(id)\r\n\r\n            request.onerror = () => reject(request.error)\r\n            request.onsuccess = () => resolve(request.result || null)\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Delete a specific blob.\r\n     */\r\n    async delete(id: string): Promise<void> {\r\n        const db = await this.getDB()\r\n        return new Promise((resolve, reject) => {\r\n            const transaction = db.transaction([STORE_NAME], 'readwrite')\r\n            const store = transaction.objectStore(STORE_NAME)\r\n            const request = store.delete(id)\r\n\r\n            request.onerror = () => reject(request.error)\r\n            request.onsuccess = () => resolve()\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Clear all blobs (use with caution).\r\n     */\r\n    async clear(): Promise<void> {\r\n        const db = await this.getDB()\r\n        return new Promise((resolve, reject) => {\r\n            const transaction = db.transaction([STORE_NAME], 'readwrite')\r\n            const store = transaction.objectStore(STORE_NAME)\r\n            const request = store.clear()\r\n\r\n            request.onerror = () => reject(request.error)\r\n            request.onsuccess = () => resolve()\r\n        })\r\n    }\r\n}\r\n\r\nexport const BlobStore = new BlobStoreClass()\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\cash-flow.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TaxReport' is defined but never used.","line":8,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":43,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TaxReport"},"fix":{"range":[248,264],"text":""},"desc":"Remove unused variable \"TaxReport\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'annualW2TotalWithholding' is assigned a value but never used.","line":120,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":120,"endColumn":33},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'monthlyW2Total' is assigned a value but never used.","line":124,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":124,"endColumn":23}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine - Cash Flow Forecaster\n * Monthly cash flow projections with quarterly tax payments,\n * seasonal patterns, runway analysis, and expense forecasting.\n */\n\nimport type { FortunaState } from './storage'\nimport { generateTaxReport, type TaxReport } from './tax-calculator'\n\n// ─── Types ──────────────────────────────────────────────────────\n\nexport interface MonthlyForecast {\n  month: number // 0-11\n  label: string\n  year: number\n  // Income\n  grossIncome: number\n  seasonalMultiplier: number\n  // Expenses\n  businessExpenses: number\n  personalExpenses: number\n  retirementContribution: number\n  // Tax\n  estimatedTaxPayment: number // quarterly payment (only in Q months)\n  monthlyTaxAccrual: number // how much tax accrues this month\n  isQuarterlyPaymentMonth: boolean\n  // W-2 Withholding\n  w2Withholding: number  // monthly W-2 withholding (fed + state + FICA)\n  w2FederalWithholding: number\n  w2StateWithholding: number\n  w2FICAWithholding: number\n  cumulativeWithheld: number // running total of withholding\n  // Cash\n  netCashFlow: number\n  cumulativeCash: number\n  // Runway\n  monthsOfRunway: number\n}\n\nexport interface CashFlowSummary {\n  months: MonthlyForecast[]\n  // Annual totals\n  totalGrossIncome: number\n  totalBusinessExpenses: number\n  totalPersonalExpenses: number\n  totalRetirement: number\n  totalTaxPayments: number\n  totalW2Withheld: number // total W-2 withholding for the period\n  remainingEstimatedTax: number // what SE earners still owe after W-2 withholding\n  totalNetCash: number\n  // Analytics\n  averageMonthlyCash: number\n  lowestCashMonth: MonthlyForecast\n  highestCashMonth: MonthlyForecast\n  monthsNegative: number\n  burnRate: number // monthly average expenses\n  runwayMonths: number // at current savings rate\n  // Seasonal patterns\n  seasonalPattern: 'stable' | 'cyclical' | 'growth' | 'decline'\n  cashReserveRecommendation: number\n  emergencyFundTarget: number\n}\n\nexport interface CashFlowConfig {\n  projectionMonths: number // 12-24\n  startingCash: number\n  growthRate: number // monthly %\n  seasonality: 'none' | 'mild' | 'moderate' | 'strong'\n  personalMonthlyExpenses: number\n  retirementPct: number // % of income\n}\n\n// ─── Seasonal Patterns ───────────────────────────────────────────\n\nconst SEASONAL_MULTIPLIERS: Record<string, number[]> = {\n  none: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],\n  mild: [0.92, 0.95, 1.0, 1.02, 1.05, 1.03, 0.98, 0.95, 1.02, 1.05, 1.08, 0.95],\n  moderate: [0.80, 0.85, 0.95, 1.05, 1.10, 1.05, 0.90, 0.85, 1.05, 1.15, 1.20, 0.85],\n  strong: [0.65, 0.70, 0.85, 1.10, 1.25, 1.15, 0.80, 0.75, 1.10, 1.30, 1.40, 0.75],\n}\n\n// IRS Quarterly estimated tax payment months (0-indexed)\n// Q1: Apr 15, Q2: Jun 15, Q3: Sep 15, Q4: Jan 15 (next year)\nconst QUARTERLY_TAX_MONTHS = [3, 5, 8, 0] // April, June, September, January\n\n// ─── Cash Flow Generator ─────────────────────────────────────────\n\nexport function generateCashFlow(\n  state: FortunaState,\n  config: CashFlowConfig = {\n    projectionMonths: 12,\n    startingCash: 10000,\n    growthRate: 0,\n    seasonality: 'mild',\n    personalMonthlyExpenses: 3000,\n    retirementPct: 0,\n  },\n  entityFilter?: string, // 'all' | 'personal' | entity id\n): CashFlowSummary {\n  const report = generateTaxReport(state)\n  const filterEid = entityFilter && entityFilter !== 'all' ? entityFilter : undefined\n\n  // If filtering by entity, use entity-level income from breakdown\n  const annualGross = filterEid\n    ? (report.entityBreakdown || []).filter(e => e.entityId === filterEid).reduce((s, e) => s + e.revenue, 0)\n    : report.grossIncome\n  const monthlyGross = annualGross / 12\n\n  const monthlyBusinessExpenses = state.expenses\n    .filter(e => e.isDeductible)\n    .filter(e => !filterEid || (e.entityId || 'personal') === filterEid)\n    .reduce((s, e) => s + e.annualAmount, 0) / 12\n\n  const retirementMonthly = (config.retirementPct / 100) * monthlyGross\n\n  // ── W-2 withholding: spreads evenly across 12 months ──────────────\n  const annualW2FedWithholding = report.w2FederalWithheld || 0\n  const annualW2StateWithholding = report.w2StateWithheld || 0\n  const annualW2FICAWithholding = report.w2FICAWithheld || 0\n  const annualW2TotalWithholding = annualW2FedWithholding + annualW2StateWithholding + annualW2FICAWithholding\n  const monthlyW2Fed = Math.round(annualW2FedWithholding / 12)\n  const monthlyW2State = Math.round(annualW2StateWithholding / 12)\n  const monthlyW2FICA = Math.round(annualW2FICAWithholding / 12)\n  const monthlyW2Total = monthlyW2Fed + monthlyW2State + monthlyW2FICA\n\n  // Quarterly estimated tax covers only non-W-2 tax liability\n  // Total tax minus annual W-2 withholding (fed + state, FICA already covered)\n  const nonW2TaxLiability = Math.max(0, report.totalTax - annualW2FedWithholding - annualW2StateWithholding)\n  const defaultQuarterlyTax = Math.round(nonW2TaxLiability / 4)\n\n  // Use actual estimatedPayments[] if available, otherwise fall back to computed\n  const actualPayments = state.estimatedPayments || []\n  const getEstPaymentForMonth = (monthIdx: number, year: number): { amount: number; isPaid: boolean } => {\n    // Map months to quarters: Apr=Q1, Jun=Q2, Sep=Q3, Jan=Q4\n    const quarterMap: Record<number, number> = { 3: 1, 5: 2, 8: 3, 0: 4 }\n    const quarter = quarterMap[monthIdx]\n    if (!quarter) return { amount: 0, isPaid: false }\n\n    const match = actualPayments.find(p => {\n      if (p.quarter !== quarter) return false\n      // Use taxYear if available, otherwise derive from dueDate\n      const pYear = p.taxYear || new Date(p.dueDate).getFullYear()\n      return quarter === 4 ? year === pYear + 1 : year === pYear\n    })\n    if (match) {\n      return {\n        amount: match.amount || defaultQuarterlyTax,\n        isPaid: (match.paidAmount || 0) >= (match.amount || 0) * 0.9,\n      }\n    }\n    return { amount: defaultQuarterlyTax, isPaid: false }\n  }\n\n  const seasonalMults = SEASONAL_MULTIPLIERS[config.seasonality]\n  const now = new Date()\n  const startMonth = now.getMonth()\n  const startYear = now.getFullYear()\n\n  const months: MonthlyForecast[] = []\n  let cumulativeCash = config.startingCash\n  let cumulativeWithheld = 0\n  const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']\n\n  for (let i = 0; i < config.projectionMonths; i++) {\n    const monthIdx = (startMonth + i) % 12\n    const year = startYear + Math.floor((startMonth + i) / 12)\n    const growthFactor = Math.pow(1 + config.growthRate / 100, i)\n    const seasonal = seasonalMults[monthIdx]\n\n    const grossIncome = Math.round(monthlyGross * seasonal * growthFactor)\n    const bizExpenses = Math.round(monthlyBusinessExpenses * (0.95 + seasonal * 0.05))\n    const personalExpenses = Math.round(config.personalMonthlyExpenses)\n    const retirement = Math.round(retirementMonthly * growthFactor)\n\n    // W-2 withholding (comes out of paycheck before you see it)\n    const w2Fed = Math.round(monthlyW2Fed * growthFactor)\n    const w2State = Math.round(monthlyW2State * growthFactor)\n    const w2FICA = Math.round(monthlyW2FICA * growthFactor)\n    const w2Total = w2Fed + w2State + w2FICA\n    cumulativeWithheld += w2Total\n\n    // Tax accrual each month\n    const monthlyTaxAccrual = Math.round(report.totalTax / 12 * growthFactor)\n\n    // Quarterly estimated payment — use actual amounts from estimatedPayments[] when available\n    const isQMonth = QUARTERLY_TAX_MONTHS.includes(monthIdx)\n    const estPaymentInfo = getEstPaymentForMonth(monthIdx, year)\n    const estimatedTaxPayment = isQMonth ? Math.round(estPaymentInfo.amount * growthFactor) : 0\n\n    // Net cash: gross income minus withholding, expenses, retirement, quarterly estimates\n    const netCashFlow = grossIncome - w2Total - bizExpenses - personalExpenses - retirement - estimatedTaxPayment\n    cumulativeCash += netCashFlow\n\n    // Runway\n    const totalMonthlyExpenses = bizExpenses + personalExpenses + retirement + monthlyTaxAccrual\n    const monthsOfRunway = totalMonthlyExpenses > 0 ? Math.max(0, Math.round(cumulativeCash / totalMonthlyExpenses)) : 999\n\n    months.push({\n      month: monthIdx,\n      label: `${monthNames[monthIdx]} '${String(year).slice(2)}`,\n      year,\n      grossIncome,\n      seasonalMultiplier: seasonal,\n      businessExpenses: bizExpenses,\n      personalExpenses,\n      retirementContribution: retirement,\n      estimatedTaxPayment,\n      monthlyTaxAccrual,\n      isQuarterlyPaymentMonth: isQMonth,\n      w2Withholding: w2Total,\n      w2FederalWithholding: w2Fed,\n      w2StateWithholding: w2State,\n      w2FICAWithholding: w2FICA,\n      cumulativeWithheld,\n      netCashFlow,\n      cumulativeCash,\n      monthsOfRunway,\n    })\n  }\n\n  // Analytics\n  const totalGross = months.reduce((s, m) => s + m.grossIncome, 0)\n  const totalBizExp = months.reduce((s, m) => s + m.businessExpenses, 0)\n  const totalPersonal = months.reduce((s, m) => s + m.personalExpenses, 0)\n  const totalRetirement = months.reduce((s, m) => s + m.retirementContribution, 0)\n  const totalTax = months.reduce((s, m) => s + m.estimatedTaxPayment, 0)\n  const totalNet = months.reduce((s, m) => s + m.netCashFlow, 0)\n\n  const avgMonthly = totalNet / months.length\n  const lowestCash = months.reduce((min, m) => m.netCashFlow < min.netCashFlow ? m : min, months[0])\n  const highestCash = months.reduce((max, m) => m.netCashFlow > max.netCashFlow ? m : max, months[0])\n  const negativeMonths = months.filter(m => m.netCashFlow < 0).length\n\n  const burnRate = (totalBizExp + totalPersonal + totalTax) / months.length\n  const runwayMonths = burnRate > 0 ? Math.round(config.startingCash / burnRate) : 999\n\n  // Pattern detection\n  const firstHalf = months.slice(0, Math.floor(months.length / 2))\n  const secondHalf = months.slice(Math.floor(months.length / 2))\n  const firstAvg = firstHalf.reduce((s, m) => s + m.grossIncome, 0) / firstHalf.length\n  const secondAvg = secondHalf.reduce((s, m) => s + m.grossIncome, 0) / secondHalf.length\n  const variance = months.map(m => m.grossIncome).reduce((s, v) => s + Math.pow(v - monthlyGross, 2), 0) / months.length\n  const cv = Math.sqrt(variance) / Math.max(1, monthlyGross)\n\n  let seasonalPattern: CashFlowSummary['seasonalPattern'] = 'stable'\n  if (secondAvg > firstAvg * 1.15) seasonalPattern = 'growth'\n  else if (secondAvg < firstAvg * 0.85) seasonalPattern = 'decline'\n  else if (cv > 0.1) seasonalPattern = 'cyclical'\n\n  // Recommendations\n  const cashReserveRecommendation = Math.round(burnRate * 3) // 3 months expenses\n  const emergencyFundTarget = Math.round(burnRate * 6) // 6 months\n\n  return {\n    months,\n    totalGrossIncome: totalGross,\n    totalBusinessExpenses: totalBizExp,\n    totalPersonalExpenses: totalPersonal,\n    totalRetirement,\n    totalTaxPayments: totalTax,\n    totalW2Withheld: months.reduce((s, m) => s + m.w2Withholding, 0),\n    remainingEstimatedTax: totalTax,\n    totalNetCash: totalNet,\n    averageMonthlyCash: avgMonthly,\n    lowestCashMonth: lowestCash,\n    highestCashMonth: highestCash,\n    monthsNegative: negativeMonths,\n    burnRate,\n    runwayMonths,\n    seasonalPattern,\n    cashReserveRecommendation,\n    emergencyFundTarget,\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\cost-basis.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'lots' is never reassigned. Use 'const' instead.","line":169,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":169,"endColumn":13,"fix":{"range":[5356,5484],"text":"const lots = this.lots.filter(l =>\n      l.ticker === ticker && l.remainingQty > 0 &&\n      (!wallet || l.wallet === wallet)\n    )"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":327,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":327,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11686,11689],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11686,11689],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":513,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":513,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19766,19769],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19766,19769],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE — Cost Basis Engine v1\n * \n * Lot-level position tracking with multiple cost basis methods:\n *   - FIFO (First In, First Out) — IRS default\n *   - LIFO (Last In, First Out)\n *   - HIFO (Highest In, First Out) — minimizes gains\n *   - Specific Identification\n *   - Per-wallet tracking (IRS Rev. Proc. 2024-28 compliant)\n *   - Wash sale detection (30-day window)\n *   - Form 8949 line-item generation\n */\n\nexport type CostBasisMethod = 'fifo' | 'lifo' | 'hifo' | 'specific_id'\n\nexport interface TaxLot {\n  id: string\n  ticker: string\n  quantity: number\n  costPerUnit: number\n  totalCost: number\n  acquiredDate: string       // ISO date\n  wallet?: string            // per-wallet tracking (2025+)\n  source: string             // exchange/import source\n  remainingQty: number       // qty not yet sold\n  isWashSaleDisallowed: boolean\n  disallowedAmount: number   // wash sale disallowed loss added to basis\n  entityId?: string          // Entity that holds this position\n}\n\nexport interface DisposalRecord {\n  id: string\n  ticker: string\n  quantity: number\n  proceedsPerUnit: number\n  totalProceeds: number\n  disposalDate: string\n  lotId: string              // which lot was sold\n  costBasis: number          // basis of disposed shares\n  gainLoss: number           // proceeds - basis\n  holdingPeriod: 'short' | 'long'\n  isWashSale: boolean\n  washSaleDisallowed: number\n  adjustedGainLoss: number   // after wash sale adjustment\n  form8949Box: 'A' | 'B' | 'C' | 'D' | 'E' | 'F'  // Box for Form 8949\n  entityId?: string          // Entity that executed this disposal\n}\n\nexport interface Form8949Line {\n  description: string        // \"2.5 BTC\"\n  dateAcquired: string\n  dateSold: string\n  proceeds: number\n  costBasis: number\n  adjustmentCode: string     // 'W' for wash sale, '' otherwise\n  adjustmentAmount: number\n  gainLoss: number\n  box: 'A' | 'B' | 'C' | 'D' | 'E' | 'F'\n}\n\nexport interface CostBasisSummary {\n  ticker: string\n  method: CostBasisMethod\n  totalLots: number\n  openLots: number\n  closedLots: number\n  totalCostBasis: number\n  totalProceeds: number\n  realizedGainLoss: number\n  shortTermGL: number\n  longTermGL: number\n  washSaleDisallowed: number\n  unrealizedGL: number\n  form8949Lines: Form8949Line[]\n}\n\n// ─── Lot Manager ────────────────────────────────────────────────────────────\n\nexport class CostBasisTracker {\n  private lots: TaxLot[] = []\n  private disposals: DisposalRecord[] = []\n  private method: CostBasisMethod\n\n  constructor(method: CostBasisMethod = 'fifo') {\n    this.method = method\n  }\n\n  setMethod(method: CostBasisMethod) { this.method = method }\n  getMethod() { return this.method }\n  getLots() { return [...this.lots] }\n  getDisposals() { return [...this.disposals] }\n\n  private genId() { return 'lot_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5) }\n\n  // ─── Add Lot (Buy/Receive) ────────────────────────────────────────\n\n  addLot(params: {\n    ticker: string; quantity: number; costPerUnit: number;\n    acquiredDate: string; wallet?: string; source?: string; entityId?: string;\n  }): TaxLot {\n    const lot: TaxLot = {\n      id: this.genId(),\n      ticker: params.ticker.toUpperCase(),\n      quantity: params.quantity,\n      costPerUnit: params.costPerUnit,\n      totalCost: params.quantity * params.costPerUnit,\n      acquiredDate: params.acquiredDate,\n      wallet: params.wallet,\n      source: params.source || 'manual',\n      remainingQty: params.quantity,\n      isWashSaleDisallowed: false,\n      disallowedAmount: 0,\n      entityId: params.entityId,\n    }\n    this.lots.push(lot)\n    return lot\n  }\n\n  // ─── Dispose (Sell/Convert) ───────────────────────────────────────\n\n  dispose(params: {\n    ticker: string; quantity: number; proceedsPerUnit: number;\n    disposalDate: string; specificLotId?: string; wallet?: string;\n  }): DisposalRecord[] {\n    const ticker = params.ticker.toUpperCase()\n    let remaining = params.quantity\n    const records: DisposalRecord[] = []\n\n    // Get eligible lots based on method\n    const eligibleLots = this.selectLots(ticker, params.wallet)\n\n    if (params.specificLotId) {\n      // Specific identification — use exact lot\n      const lot = eligibleLots.find(l => l.id === params.specificLotId && l.remainingQty > 0)\n      if (lot) {\n        const qty = Math.min(remaining, lot.remainingQty)\n        records.push(this.createDisposal(lot, qty, params.proceedsPerUnit, params.disposalDate))\n        remaining -= qty\n      }\n    } else {\n      // Use selected method\n      for (const lot of eligibleLots) {\n        if (remaining <= 0) break\n        if (lot.remainingQty <= 0) continue\n\n        const qty = Math.min(remaining, lot.remainingQty)\n        records.push(this.createDisposal(lot, qty, params.proceedsPerUnit, params.disposalDate))\n        remaining -= qty\n      }\n    }\n\n    // Check wash sales for any loss disposals\n    for (const record of records) {\n      if (record.gainLoss < 0) {\n        const washResult = this.checkWashSale(record)\n        if (washResult.isWashSale) {\n          record.isWashSale = true\n          record.washSaleDisallowed = washResult.disallowedAmount\n          record.adjustedGainLoss = record.gainLoss + washResult.disallowedAmount\n        }\n      }\n    }\n\n    this.disposals.push(...records)\n    return records\n  }\n\n  private selectLots(ticker: string, wallet?: string): TaxLot[] {\n    let lots = this.lots.filter(l =>\n      l.ticker === ticker && l.remainingQty > 0 &&\n      (!wallet || l.wallet === wallet)\n    )\n\n    switch (this.method) {\n      case 'fifo':\n        return lots.sort((a, b) => a.acquiredDate.localeCompare(b.acquiredDate))\n      case 'lifo':\n        return lots.sort((a, b) => b.acquiredDate.localeCompare(a.acquiredDate))\n      case 'hifo':\n        return lots.sort((a, b) => b.costPerUnit - a.costPerUnit) // highest cost first = minimize gain\n      case 'specific_id':\n        return lots // caller specifies lot\n      default:\n        return lots.sort((a, b) => a.acquiredDate.localeCompare(b.acquiredDate))\n    }\n  }\n\n  private createDisposal(lot: TaxLot, quantity: number, proceedsPerUnit: number, disposalDate: string): DisposalRecord {\n    const effectiveCostPerUnit = lot.costPerUnit + (lot.disallowedAmount / Math.max(lot.quantity, 1))\n    const costBasis = quantity * effectiveCostPerUnit\n    const totalProceeds = quantity * proceedsPerUnit\n    const gainLoss = totalProceeds - costBasis\n\n    // Determine holding period\n    const acqDate = new Date(lot.acquiredDate)\n    const dispDate = new Date(disposalDate)\n    const diffMs = dispDate.getTime() - acqDate.getTime()\n    const holdingDays = diffMs / (1000 * 60 * 60 * 24)\n    const holdingPeriod: 'short' | 'long' = holdingDays > 365 ? 'long' : 'short'\n\n    // Determine Form 8949 box\n    // A: Short-term reported on 1099-B with basis  B: Short-term reported without basis\n    // C: Short-term not reported  D: Long-term with basis  E: Long-term without basis  F: Long-term not reported\n    const isReported = ['coinbase', 'robinhood', 'schwab', 'fidelity'].some(s => lot.source.toLowerCase().includes(s))\n    let box: DisposalRecord['form8949Box']\n    if (holdingPeriod === 'short') {\n      box = isReported ? 'A' : 'C'\n    } else {\n      box = isReported ? 'D' : 'F'\n    }\n\n    // Reduce lot remaining qty\n    lot.remainingQty -= quantity\n\n    return {\n      id: this.genId(),\n      ticker: lot.ticker,\n      quantity,\n      proceedsPerUnit,\n      totalProceeds,\n      disposalDate,\n      lotId: lot.id,\n      costBasis,\n      gainLoss,\n      holdingPeriod,\n      isWashSale: false,\n      washSaleDisallowed: 0,\n      adjustedGainLoss: gainLoss,\n      form8949Box: box,\n    }\n  }\n\n  // ─── Wash Sale Detection ──────────────────────────────────────────\n\n  private checkWashSale(disposal: DisposalRecord): { isWashSale: boolean; disallowedAmount: number } {\n    if (disposal.gainLoss >= 0) return { isWashSale: false, disallowedAmount: 0 }\n\n    const dispDate = new Date(disposal.disposalDate)\n    const windowStart = new Date(dispDate.getTime() - 30 * 24 * 60 * 60 * 1000)\n    const windowEnd = new Date(dispDate.getTime() + 30 * 24 * 60 * 60 * 1000)\n\n    // Look for replacement purchases within 30-day window\n    const replacementLots = this.lots.filter(lot => {\n      if (lot.ticker !== disposal.ticker) return false\n      if (lot.id === disposal.lotId) return false\n      const acqDate = new Date(lot.acquiredDate)\n      return acqDate >= windowStart && acqDate <= windowEnd\n    })\n\n    if (replacementLots.length > 0) {\n      const disallowedAmount = Math.abs(disposal.gainLoss)\n      // Add disallowed loss to replacement lot's basis\n      const replacementLot = replacementLots[0]\n      replacementLot.disallowedAmount += disallowedAmount\n      replacementLot.isWashSaleDisallowed = true\n\n      return { isWashSale: true, disallowedAmount }\n    }\n\n    return { isWashSale: false, disallowedAmount: 0 }\n  }\n\n  // ─── Summary & Reporting ──────────────────────────────────────────\n\n  getSummary(ticker?: string, currentPrices?: Record<string, number>): CostBasisSummary[] {\n    const tickers = ticker\n      ? [ticker.toUpperCase()]\n      : [...new Set(this.lots.map(l => l.ticker))]\n\n    return tickers.map(t => {\n      const tickerLots = this.lots.filter(l => l.ticker === t)\n      const tickerDisposals = this.disposals.filter(d => d.ticker === t)\n      const openLots = tickerLots.filter(l => l.remainingQty > 0)\n\n      const totalCostBasis = tickerDisposals.reduce((s, d) => s + d.costBasis, 0)\n      const totalProceeds = tickerDisposals.reduce((s, d) => s + d.totalProceeds, 0)\n      const realizedGL = tickerDisposals.reduce((s, d) => s + d.adjustedGainLoss, 0)\n      const shortTermGL = tickerDisposals.filter(d => d.holdingPeriod === 'short').reduce((s, d) => s + d.adjustedGainLoss, 0)\n      const longTermGL = tickerDisposals.filter(d => d.holdingPeriod === 'long').reduce((s, d) => s + d.adjustedGainLoss, 0)\n      const washDisallowed = tickerDisposals.reduce((s, d) => s + d.washSaleDisallowed, 0)\n\n      // Unrealized G/L\n      const currentPrice = currentPrices?.[t] || 0\n      const openCost = openLots.reduce((s, l) => s + l.remainingQty * (l.costPerUnit + l.disallowedAmount / Math.max(l.quantity, 1)), 0)\n      const openValue = openLots.reduce((s, l) => s + l.remainingQty * currentPrice, 0)\n      const unrealizedGL = currentPrice > 0 ? openValue - openCost : 0\n\n      // Form 8949 lines\n      const form8949Lines: Form8949Line[] = tickerDisposals.map(d => ({\n        description: `${d.quantity} ${d.ticker}`,\n        dateAcquired: tickerLots.find(l => l.id === d.lotId)?.acquiredDate || 'Various',\n        dateSold: d.disposalDate,\n        proceeds: d.totalProceeds,\n        costBasis: d.costBasis,\n        adjustmentCode: d.isWashSale ? 'W' : '',\n        adjustmentAmount: d.washSaleDisallowed,\n        gainLoss: d.adjustedGainLoss,\n        box: d.form8949Box,\n      }))\n\n      return {\n        ticker: t,\n        method: this.method,\n        totalLots: tickerLots.length,\n        openLots: openLots.length,\n        closedLots: tickerDisposals.length,\n        totalCostBasis,\n        totalProceeds,\n        realizedGainLoss: realizedGL,\n        shortTermGL,\n        longTermGL,\n        washSaleDisallowed: washDisallowed,\n        unrealizedGL,\n        form8949Lines,\n      }\n    })\n  }\n\n  // ─── Tax-Loss Harvesting Scanner ──────────────────────────────────\n\n  findHarvestingOpportunities(currentPrices: Record<string, number>): {\n    ticker: string; lotId: string; unrealizedLoss: number;\n    quantity: number; costBasis: number; currentValue: number;\n    holdingPeriod: 'short' | 'long'; daysHeld: number;\n    potentialTaxSavings: number; // at 32% marginal rate\n  }[] {\n    const opportunities: any[] = []\n    const now = new Date()\n\n    for (const lot of this.lots) {\n      if (lot.remainingQty <= 0) continue\n      const price = currentPrices[lot.ticker]\n      if (!price || price <= 0) continue\n\n      const currentValue = lot.remainingQty * price\n      const effectiveCost = lot.remainingQty * (lot.costPerUnit + lot.disallowedAmount / Math.max(lot.quantity, 1))\n      const unrealizedLoss = currentValue - effectiveCost\n\n      if (unrealizedLoss >= 0) continue // only losses\n\n      const acqDate = new Date(lot.acquiredDate)\n      const daysHeld = Math.floor((now.getTime() - acqDate.getTime()) / (1000 * 60 * 60 * 24))\n      const holdingPeriod = daysHeld > 365 ? 'long' : 'short'\n\n      opportunities.push({\n        ticker: lot.ticker,\n        lotId: lot.id,\n        unrealizedLoss,\n        quantity: lot.remainingQty,\n        costBasis: effectiveCost,\n        currentValue,\n        holdingPeriod,\n        daysHeld,\n        potentialTaxSavings: Math.abs(unrealizedLoss) * 0.32,\n      })\n    }\n\n    return opportunities.sort((a, b) => a.unrealizedLoss - b.unrealizedLoss)\n  }\n\n  // ─── Import from CSV Import Engine results ────────────────────────\n\n  importFromCSV(positions: { ticker: string; quantity: number; costBasis: number; acquiredDate?: string; wallet?: string; source?: string }[]) {\n    for (const pos of positions) {\n      if (pos.quantity > 0 && pos.ticker) {\n        this.addLot({\n          ticker: pos.ticker,\n          quantity: pos.quantity,\n          costPerUnit: pos.costBasis / Math.max(pos.quantity, 0.001),\n          acquiredDate: pos.acquiredDate || new Date().toISOString().split('T')[0],\n          wallet: pos.wallet,\n          source: pos.source || 'csv-import',\n        })\n      }\n    }\n  }\n\n  // ─── Serialization ────────────────────────────────────────────────\n\n  serialize(): string {\n    return JSON.stringify({ method: this.method, lots: this.lots, disposals: this.disposals })\n  }\n\n  static deserialize(json: string): CostBasisTracker {\n    const data = JSON.parse(json)\n    const tracker = new CostBasisTracker(data.method || 'fifo')\n    tracker.lots = data.lots || []\n    tracker.disposals = data.disposals || []\n    return tracker\n  }\n\n  // Entity-aware filtering\n  getLotsForEntity(entityId: string): TaxLot[] {\n    return this.lots.filter(l => (l.entityId || 'personal') === entityId)\n  }\n\n  getDisposalsForEntity(entityId: string): DisposalRecord[] {\n    return this.disposals.filter(d => (d.entityId || 'personal') === entityId)\n  }\n\n  getSummaryByEntity(entityId: string, currentPrices?: Record<string, number>): CostBasisSummary[] {\n    const entityLots = this.getLotsForEntity(entityId)\n    const entityDisposals = this.getDisposalsForEntity(entityId)\n    const tickers = [...new Set(entityLots.map(l => l.ticker))]\n\n    return tickers.map(t => {\n      const tickerLots = entityLots.filter(l => l.ticker === t)\n      const tickerDisposals = entityDisposals.filter(d => d.ticker === t)\n      const openLots = tickerLots.filter(l => l.remainingQty > 0)\n\n      const totalCostBasis = tickerDisposals.reduce((s, d) => s + d.costBasis, 0)\n      const totalProceeds = tickerDisposals.reduce((s, d) => s + d.totalProceeds, 0)\n      const realizedGL = tickerDisposals.reduce((s, d) => s + d.adjustedGainLoss, 0)\n      const shortTermGL = tickerDisposals.filter(d => d.holdingPeriod === 'short').reduce((s, d) => s + d.adjustedGainLoss, 0)\n      const longTermGL = tickerDisposals.filter(d => d.holdingPeriod === 'long').reduce((s, d) => s + d.adjustedGainLoss, 0)\n      const washDisallowed = tickerDisposals.reduce((s, d) => s + d.washSaleDisallowed, 0)\n\n      const currentPrice = currentPrices?.[t] || 0\n      const openCost = openLots.reduce((s, l) => s + l.remainingQty * (l.costPerUnit + l.disallowedAmount / Math.max(l.quantity, 1)), 0)\n      const openValue = openLots.reduce((s, l) => s + l.remainingQty * currentPrice, 0)\n      const unrealizedGL = currentPrice > 0 ? openValue - openCost : 0\n\n      return {\n        ticker: t, method: this.method,\n        totalLots: tickerLots.length, openLots: openLots.length, closedLots: tickerDisposals.length,\n        totalCostBasis, totalProceeds, realizedGainLoss: realizedGL,\n        shortTermGL, longTermGL, washSaleDisallowed: washDisallowed, unrealizedGL,\n        form8949Lines: tickerDisposals.map(d => ({\n          description: `${d.quantity} ${d.ticker}`,\n          dateAcquired: tickerLots.find(l => l.id === d.lotId)?.acquiredDate || 'Various',\n          dateSold: d.disposalDate, proceeds: d.totalProceeds, costBasis: d.costBasis,\n          adjustmentCode: d.isWashSale ? 'W' : '', adjustmentAmount: d.washSaleDisallowed,\n          gainLoss: d.adjustedGainLoss, box: d.form8949Box,\n        })),\n      }\n    })\n  }\n\n  getEntityIds(): string[] {\n    const ids = new Set<string>()\n    this.lots.forEach(l => ids.add(l.entityId || 'personal'))\n    this.disposals.forEach(d => ids.add(d.entityId || 'personal'))\n    return [...ids]\n  }\n}\n\n// ─── Cross-Entity Wash Sale Scanner ─────────────────────────────────────────\n// IRS wash sale rules apply across ALL accounts/entities owned by the taxpayer\n// (including spouse's accounts in MFJ), not just within a single account.\n\nexport interface CrossEntityWashSaleAlert {\n  disposalEntityId: string\n  disposalTicker: string\n  disposalDate: string\n  disposalLoss: number\n  replacementEntityId: string\n  replacementDate: string\n  replacementQuantity: number\n  disallowedAmount: number\n  recommendation: string\n}\n\n/** Scan for wash sales across entity boundaries (IRS applies across all taxpayer accounts) */\nexport function detectCrossEntityWashSales(tracker: CostBasisTracker): CrossEntityWashSaleAlert[] {\n  const alerts: CrossEntityWashSaleAlert[] = []\n  const allLots = tracker.getLots()\n  const allDisposals = tracker.getDisposals()\n\n  // Only check disposals with losses\n  const lossDisposals = allDisposals.filter(d => d.gainLoss < 0)\n\n  for (const disposal of lossDisposals) {\n    const dispDate = new Date(disposal.disposalDate)\n    const windowStart = new Date(dispDate.getTime() - 30 * 24 * 60 * 60 * 1000)\n    const windowEnd = new Date(dispDate.getTime() + 30 * 24 * 60 * 60 * 1000)\n    const disposalEntity = disposal.entityId || 'personal'\n\n    // Look for replacement purchases in DIFFERENT entities within 30-day window\n    const crossEntityReplacements = allLots.filter(lot => {\n      if (lot.ticker !== disposal.ticker) return false\n      const lotEntity = lot.entityId || 'personal'\n      if (lotEntity === disposalEntity) return false // same entity already handled\n      const acqDate = new Date(lot.acquiredDate)\n      return acqDate >= windowStart && acqDate <= windowEnd\n    })\n\n    for (const replacement of crossEntityReplacements) {\n      const disallowedAmount = Math.min(Math.abs(disposal.gainLoss), replacement.quantity * replacement.costPerUnit)\n      alerts.push({\n        disposalEntityId: disposalEntity,\n        disposalTicker: disposal.ticker,\n        disposalDate: disposal.disposalDate,\n        disposalLoss: disposal.gainLoss,\n        replacementEntityId: replacement.entityId || 'personal',\n        replacementDate: replacement.acquiredDate,\n        replacementQuantity: replacement.quantity,\n        disallowedAmount,\n        recommendation: `Loss of $${Math.abs(disposal.gainLoss).toLocaleString()} on ${disposal.ticker} sold from entity \"${disposalEntity}\" may be disallowed — replacement purchased in entity \"${replacement.entityId || 'personal'}\" within 30-day window. IRS wash sale rules apply across all accounts you control.`,\n      })\n    }\n  }\n\n  return alerts\n}\n\n// ─── Comparison Tool: Which method is best? ─────────────────────────────────\n\nexport function compareCostBasisMethods(\n  lots: { ticker: string; quantity: number; costPerUnit: number; acquiredDate: string }[],\n  disposals: { ticker: string; quantity: number; proceedsPerUnit: number; disposalDate: string }[],\n): Record<CostBasisMethod, { realizedGL: number; shortTermGL: number; longTermGL: number; washSaleDisallowed: number }> {\n  const methods: CostBasisMethod[] = ['fifo', 'lifo', 'hifo']\n  const results: any = {}\n\n  for (const method of methods) {\n    const tracker = new CostBasisTracker(method)\n    for (const lot of lots) tracker.addLot(lot)\n    for (const disp of disposals) tracker.dispose(disp)\n    const summaries = tracker.getSummary()\n    results[method] = {\n      realizedGL: summaries.reduce((s, sm) => s + sm.realizedGainLoss, 0),\n      shortTermGL: summaries.reduce((s, sm) => s + sm.shortTermGL, 0),\n      longTermGL: summaries.reduce((s, sm) => s + sm.longTermGL, 0),\n      washSaleDisallowed: summaries.reduce((s, sm) => s + sm.washSaleDisallowed, 0),\n    }\n  }\n\n  results['specific_id'] = results['hifo'] // same as HIFO when optimally selected\n  return results\n}\n\n// ─── Phase F: Type Adapters ─────────────────────────────────────────────────\n\nimport type { InvestmentPosition } from './storage'\n\n/** Convert TaxLot → InvestmentPosition (for storage sync) */\nexport function taxLotToPosition(lot: TaxLot, currentPrice: number = 0): InvestmentPosition {\n  return {\n    id: lot.id,\n    symbol: lot.ticker,\n    name: lot.ticker,\n    type: 'stock',\n    quantity: lot.remainingQty,\n    costBasis: lot.remainingQty * (lot.costPerUnit + lot.disallowedAmount / Math.max(lot.quantity, 1)),\n    currentValue: lot.remainingQty * currentPrice,\n    acquisitionDate: lot.acquiredDate,\n    isLongTerm: isLongTermHolding(lot.acquiredDate),\n    entityId: lot.entityId || 'personal',\n    memberId: 'primary',\n    taxYear: new Date().getFullYear(),\n    tags: [],\n  }\n}\n\n/** Convert InvestmentPosition → TaxLot (for cost-basis import) */\nexport function positionToTaxLot(pos: InvestmentPosition): TaxLot {\n  return {\n    id: pos.id,\n    ticker: pos.symbol,\n    quantity: pos.quantity,\n    costPerUnit: pos.quantity > 0 ? pos.costBasis / pos.quantity : 0,\n    totalCost: pos.costBasis,\n    acquiredDate: pos.acquisitionDate,\n    source: 'import',\n    remainingQty: pos.quantity,\n    isWashSaleDisallowed: false,\n    disallowedAmount: 0,\n    entityId: pos.entityId || 'personal',\n  }\n}\n\nfunction isLongTermHolding(acquiredDate: string): boolean {\n  const acquired = new Date(acquiredDate)\n  const oneYearAgo = new Date()\n  oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1)\n  return acquired <= oneYearAgo\n}\n\n/** Sync cost-basis lots → InvestmentPosition[] for storage */\nexport function syncLotsToPositions(tracker: CostBasisTracker, currentPrices: Record<string, number> = {}): InvestmentPosition[] {\n  return tracker.getLots()\n    .filter(l => l.remainingQty > 0)\n    .map(l => taxLotToPosition(l, currentPrices[l.ticker] || 0))\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\cpa-export.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\csv-import.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'genImportId' is defined but never used.","line":144,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":144,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'iBalance' is assigned a value but never used.","line":429,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":429,"endColumn":17}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE — CSV Import Engine v1\n * \n * Intelligent CSV parser that transforms transaction exports from major\n * exchanges, brokerages, and banks into Fortuna PortfolioPosition and\n * TaxEvent records. Supports:\n *   - Coinbase (standard transaction history export)\n *   - Kraken (ledger export)\n *   - Binance (trade history export)\n *   - Robinhood (1099 / transaction CSV)\n *   - Schwab / Fidelity (brokerage transaction export)\n *   - Generic bank CSV (Chase, Wells Fargo, etc.)\n *   - Custom CSV with intelligent column auto-mapping\n */\n\n// ─── Types ──────────────────────────────────────────────────────────────────\n\ntype AssetClass = 'crypto' | 'defi' | 'nft' | 'equity' | 'commodity' | 'real_estate' | 'speculative' | 'other'\ntype TaxTreatment = 'ordinary_income' | 'short_term_cg' | 'long_term_cg' | 'mining_income' | 'airdrop' | 'staking_reward' | 'unknown'\n\nexport interface ImportedPosition {\n  name: string\n  ticker?: string\n  assetClass: AssetClass\n  quantity: number\n  costBasis: number\n  currentValue: number\n  acquiredDate?: string\n  taxTreatment: TaxTreatment\n  tags: string[]\n  riskScore: number\n  chain?: string\n  wallet?: string\n  notes: string\n}\n\nexport interface ImportedTaxEvent {\n  type: 'airdrop' | 'tge' | 'vest' | 'sale' | 'conversion' | 'staking_reward' | 'mining' | 'income' | 'loss'\n  description: string\n  estimatedAmount: number\n  taxTreatment: TaxTreatment\n  expectedDate?: string\n  realized: boolean\n  notes: string\n}\n\nexport interface ImportResult {\n  source: string\n  format: string\n  positions: ImportedPosition[]\n  taxEvents: ImportedTaxEvent[]\n  warnings: string[]\n  skippedRows: number\n  totalRows: number\n  rawHeaders: string[]\n}\n\nexport interface ColumnMapping {\n  date?: number\n  asset?: number\n  type?: number\n  quantity?: number\n  price?: number\n  total?: number\n  fee?: number\n  notes?: number\n}\n\nexport type SupportedFormat = \n  | 'coinbase'\n  | 'kraken'\n  | 'binance'\n  | 'robinhood'\n  | 'schwab'\n  | 'fidelity'\n  | 'generic_bank'\n  | 'custom'\n\n// ─── CSV Parsing Core ───────────────────────────────────────────────────────\n\nfunction parseCSVLine(line: string): string[] {\n  const result: string[] = []\n  let current = ''\n  let inQuotes = false\n  for (let i = 0; i < line.length; i++) {\n    const ch = line[i]\n    if (ch === '\"') {\n      if (inQuotes && i + 1 < line.length && line[i + 1] === '\"') {\n        current += '\"'\n        i++\n      } else {\n        inQuotes = !inQuotes\n      }\n    } else if (ch === ',' && !inQuotes) {\n      result.push(current.trim())\n      current = ''\n    } else {\n      current += ch\n    }\n  }\n  result.push(current.trim())\n  return result\n}\n\nfunction parseCSV(text: string): { headers: string[]; rows: string[][] } {\n  const lines = text.split(/\\r?\\n/).filter(l => l.trim().length > 0)\n  if (lines.length === 0) return { headers: [], rows: [] }\n\n  // Skip metadata rows (Coinbase puts notes before headers)\n  let headerIdx = 0\n  for (let i = 0; i < Math.min(10, lines.length); i++) {\n    const fields = parseCSVLine(lines[i])\n    // Heuristic: header row has 4+ fields and mostly non-numeric content\n    const nonNumeric = fields.filter(f => f && isNaN(Number(f.replace(/[$,]/g, '')))).length\n    if (fields.length >= 4 && nonNumeric >= fields.length * 0.5) {\n      headerIdx = i\n      break\n    }\n  }\n\n  const headers = parseCSVLine(lines[headerIdx]).map(h => h.toLowerCase().replace(/[^a-z0-9_\\s]/g, '').trim())\n  const rows = lines.slice(headerIdx + 1).map(parseCSVLine).filter(r => r.length >= headers.length * 0.5)\n  return { headers, rows }\n}\n\n// ─── Format Detection ───────────────────────────────────────────────────────\n\nexport function detectFormat(headers: string[]): SupportedFormat {\n  const h = headers.join(' ').toLowerCase()\n  \n  if (h.includes('timestamp') && h.includes('transaction type') && h.includes('asset')) return 'coinbase'\n  if (h.includes('txid') && h.includes('refid') && h.includes('aclass')) return 'kraken'\n  if (h.includes('date(utc)') || (h.includes('pair') && h.includes('executed qty'))) return 'binance'\n  if (h.includes('activity date') && h.includes('instrument')) return 'robinhood'\n  if (h.includes('action') && h.includes('symbol') && h.includes('description') && h.includes('schwab')) return 'schwab'\n  if (h.includes('run date') && h.includes('symbol') && h.includes('security description')) return 'fidelity'\n  if ((h.includes('posting date') || h.includes('transaction date')) && h.includes('description') && h.includes('amount')) return 'generic_bank'\n  \n  return 'custom'\n}\n\n// ─── Utility ────────────────────────────────────────────────────────────────\n\nfunction genImportId(): string {\n  return 'imp_' + Date.now().toString(36) + Math.random().toString(36).substring(2, 6)\n}\n\nfunction parseDate(val: string): string | undefined {\n  if (!val) return undefined\n  // Handle common date formats\n  const cleaned = val.replace(/\"/g, '').trim()\n  const d = new Date(cleaned)\n  if (!isNaN(d.getTime())) return d.toISOString().split('T')[0]\n  // Try MM/DD/YYYY\n  const mdy = cleaned.match(/^(\\d{1,2})\\/(\\d{1,2})\\/(\\d{2,4})$/)\n  if (mdy) {\n    const year = mdy[3].length === 2 ? '20' + mdy[3] : mdy[3]\n    return `${year}-${mdy[1].padStart(2, '0')}-${mdy[2].padStart(2, '0')}`\n  }\n  return undefined\n}\n\nfunction parseNumber(val: string): number {\n  if (!val) return 0\n  return parseFloat(val.replace(/[$,\"\\s]/g, '')) || 0\n}\n\nfunction isHoldingPeriodLong(acquiredDate: string | undefined): boolean {\n  if (!acquiredDate) return false\n  const acq = new Date(acquiredDate)\n  const now = new Date()\n  const diffMs = now.getTime() - acq.getTime()\n  return diffMs >= 365.25 * 24 * 60 * 60 * 1000\n}\n\nfunction inferAssetClass(ticker: string, name: string): AssetClass {\n  const t = (ticker || '').toUpperCase()\n  const n = (name || '').toLowerCase()\n  \n  const majors = ['BTC', 'ETH', 'SOL', 'ADA', 'DOT', 'AVAX', 'MATIC', 'LINK', 'XRP', 'BNB', 'DOGE', 'SHIB', 'LTC', 'UNI', 'AAVE', 'ATOM', 'NEAR', 'FTM', 'ALGO', 'XLM', 'VET', 'HBAR', 'ICP', 'FIL', 'GRT', 'SAND', 'MANA', 'APE', 'CRV', 'MKR', 'SNX', 'COMP', 'SUSHI', 'YFI', 'BAL', 'REN', '1INCH', 'CAKE', 'LUNA', 'UST', 'USDT', 'USDC', 'DAI', 'BUSD', 'FRAX']\n  const defi = ['UNI', 'AAVE', 'COMP', 'SUSHI', 'YFI', 'CRV', 'BAL', 'MKR', 'SNX', '1INCH', 'CAKE', 'DYDX', 'GMX', 'PENDLE']\n  const nfts = ['APE', 'MANA', 'SAND', 'AXS', 'ENJ', 'GALA', 'ILV']\n  \n  if (n.includes('nft') || nfts.includes(t)) return 'nft'\n  if (n.includes('defi') || n.includes('liquidity') || n.includes('lp') || defi.includes(t)) return 'defi'\n  if (majors.includes(t) || n.includes('bitcoin') || n.includes('ethereum') || n.includes('crypto')) return 'crypto'\n  if (n.includes('gold') || n.includes('silver') || n.includes('oil') || n.includes('commodity')) return 'commodity'\n  if (n.includes('reit') || n.includes('real estate')) return 'real_estate'\n  \n  // Check for stock-like tickers (1-5 uppercase letters)\n  if (/^[A-Z]{1,5}$/.test(t) && !majors.includes(t)) return 'equity'\n  \n  return 'crypto' // default for unknown exchange assets\n}\n\nfunction inferRiskScore(assetClass: AssetClass, ticker: string): number {\n  const t = (ticker || '').toUpperCase()\n  const stablecoins = ['USDT', 'USDC', 'DAI', 'BUSD', 'FRAX', 'TUSD', 'USDP']\n  if (stablecoins.includes(t)) return 1\n  \n  const bluechipCrypto = ['BTC', 'ETH']\n  if (bluechipCrypto.includes(t)) return 5\n  \n  const largeCapCrypto = ['SOL', 'ADA', 'DOT', 'AVAX', 'MATIC', 'LINK', 'XRP', 'BNB']\n  if (largeCapCrypto.includes(t)) return 6\n  \n  switch (assetClass) {\n    case 'equity': return 4\n    case 'commodity': return 5\n    case 'crypto': return 7\n    case 'defi': return 8\n    case 'nft': return 9\n    case 'speculative': return 9\n    default: return 6\n  }\n}\n\n// ─── Position Aggregator ────────────────────────────────────────────────────\n\ninterface RawTransaction {\n  date?: string\n  asset: string\n  ticker: string\n  type: 'buy' | 'sell' | 'receive' | 'send' | 'staking_reward' | 'airdrop' | 'mining' | 'trade' | 'conversion' | 'deposit' | 'withdrawal' | 'dividend' | 'interest' | 'fee' | 'unknown'\n  quantity: number\n  pricePerUnit: number\n  totalValue: number\n  fee: number\n  notes: string\n}\n\nfunction aggregateToPositions(transactions: RawTransaction[], source: string): { positions: ImportedPosition[], taxEvents: ImportedTaxEvent[] } {\n  const positionMap = new Map<string, { buys: RawTransaction[], sells: RawTransaction[], rewards: RawTransaction[] }>()\n  const taxEvents: ImportedTaxEvent[] = []\n\n  for (const tx of transactions) {\n    if (!tx.asset || tx.asset === 'USD' || tx.asset === 'EUR' || tx.asset === 'GBP') continue\n\n    const key = tx.ticker || tx.asset\n    if (!positionMap.has(key)) {\n      positionMap.set(key, { buys: [], sells: [], rewards: [] })\n    }\n    const bucket = positionMap.get(key)!\n\n    switch (tx.type) {\n      case 'buy':\n      case 'receive':\n      case 'deposit':\n      case 'trade':\n        bucket.buys.push(tx)\n        break\n      case 'sell':\n      case 'send':\n      case 'withdrawal':\n        bucket.sells.push(tx)\n        // Generate tax event for sells\n        taxEvents.push({\n          type: 'sale',\n          description: `Sold ${Math.abs(tx.quantity)} ${tx.ticker || tx.asset} via ${source}`,\n          estimatedAmount: Math.abs(tx.totalValue),\n          taxTreatment: isHoldingPeriodLong(tx.date) ? 'long_term_cg' : 'short_term_cg',\n          expectedDate: tx.date,\n          realized: true,\n          notes: `Price: $${tx.pricePerUnit.toFixed(4)}, Fee: $${tx.fee.toFixed(2)}`\n        })\n        break\n      case 'staking_reward':\n        bucket.rewards.push(tx)\n        taxEvents.push({\n          type: 'staking_reward',\n          description: `Staking reward: ${tx.quantity} ${tx.ticker || tx.asset}`,\n          estimatedAmount: tx.totalValue,\n          taxTreatment: 'staking_reward',\n          expectedDate: tx.date,\n          realized: true,\n          notes: `FMV at receipt: $${tx.pricePerUnit.toFixed(4)} per unit`\n        })\n        break\n      case 'airdrop':\n        bucket.rewards.push(tx)\n        taxEvents.push({\n          type: 'airdrop',\n          description: `Airdrop received: ${tx.quantity} ${tx.ticker || tx.asset}`,\n          estimatedAmount: tx.totalValue,\n          taxTreatment: 'airdrop',\n          expectedDate: tx.date,\n          realized: true,\n          notes: `FMV at receipt: $${tx.pricePerUnit.toFixed(4)} per unit`\n        })\n        break\n      case 'mining':\n        bucket.rewards.push(tx)\n        taxEvents.push({\n          type: 'mining',\n          description: `Mining reward: ${tx.quantity} ${tx.ticker || tx.asset}`,\n          estimatedAmount: tx.totalValue,\n          taxTreatment: 'mining_income',\n          expectedDate: tx.date,\n          realized: true,\n          notes: `FMV at receipt: $${tx.pricePerUnit.toFixed(4)} per unit`\n        })\n        break\n      case 'conversion':\n        bucket.buys.push(tx)\n        taxEvents.push({\n          type: 'conversion',\n          description: `Converted to ${tx.quantity} ${tx.ticker || tx.asset}`,\n          estimatedAmount: tx.totalValue,\n          taxTreatment: 'short_term_cg',\n          expectedDate: tx.date,\n          realized: true,\n          notes: tx.notes\n        })\n        break\n      case 'dividend':\n      case 'interest':\n        taxEvents.push({\n          type: 'income',\n          description: `${tx.type === 'dividend' ? 'Dividend' : 'Interest'}: ${tx.asset}`,\n          estimatedAmount: tx.totalValue,\n          taxTreatment: 'ordinary_income',\n          expectedDate: tx.date,\n          realized: true,\n          notes: tx.notes\n        })\n        break\n      default:\n        break\n    }\n  }\n\n  const positions: ImportedPosition[] = []\n\n  for (const [ticker, data] of positionMap.entries()) {\n    const totalBought = data.buys.reduce((s, t) => s + Math.abs(t.quantity), 0) + data.rewards.reduce((s, t) => s + Math.abs(t.quantity), 0)\n    const totalSold = data.sells.reduce((s, t) => s + Math.abs(t.quantity), 0)\n    const netQuantity = totalBought - totalSold\n\n    if (netQuantity <= 0.000001) continue // Position fully exited\n\n    const totalCostBasis = data.buys.reduce((s, t) => s + Math.abs(t.totalValue) + t.fee, 0) + data.rewards.reduce((s, t) => s + Math.abs(t.totalValue), 0)\n    const soldCostBasisEstimate = totalSold > 0 ? (totalCostBasis / totalBought) * totalSold : 0\n    const remainingCostBasis = totalCostBasis - soldCostBasisEstimate\n\n    // Estimate current value using last known price\n    const allTxs = [...data.buys, ...data.sells, ...data.rewards].filter(t => t.pricePerUnit > 0)\n    const lastPrice = allTxs.length > 0 ? allTxs[allTxs.length - 1].pricePerUnit : (remainingCostBasis / Math.max(netQuantity, 0.001))\n    const currentValue = netQuantity * lastPrice\n\n    const earliestBuy = data.buys[0]\n    const name = data.buys[0]?.asset || ticker\n    const assetClass = inferAssetClass(ticker, name)\n\n    const hasRewards = data.rewards.some(r => r.type === 'staking_reward')\n    const hasAirdrops = data.rewards.some(r => r.type === 'airdrop')\n\n    let taxTreatment: TaxTreatment = 'unknown'\n    if (hasRewards) taxTreatment = 'staking_reward'\n    else if (hasAirdrops) taxTreatment = 'airdrop'\n    else if (earliestBuy?.date && isHoldingPeriodLong(earliestBuy.date)) taxTreatment = 'long_term_cg'\n    else taxTreatment = 'short_term_cg'\n\n    positions.push({\n      name,\n      ticker,\n      assetClass,\n      quantity: netQuantity,\n      costBasis: Math.max(0, remainingCostBasis),\n      currentValue: Math.max(0, currentValue),\n      acquiredDate: earliestBuy?.date,\n      taxTreatment,\n      tags: [`imported:${source}`, assetClass],\n      riskScore: inferRiskScore(assetClass, ticker),\n      notes: `Imported from ${source}. ${data.buys.length} buy(s), ${data.sells.length} sell(s), ${data.rewards.length} reward(s).`,\n    })\n  }\n\n  return { positions, taxEvents }\n}\n\n// ─── Exchange-Specific Parsers ──────────────────────────────────────────────\n\nfunction parseCoinbase(headers: string[], rows: string[][]): RawTransaction[] {\n  const idx = (name: string) => headers.findIndex(h => h.includes(name))\n  const iTimestamp = idx('timestamp')\n  const iType = idx('transaction type')\n  const iAsset = idx('asset')\n  const iQty = idx('quantity transacted')\n  const iPrice = idx('spot price at transaction') !== -1 ? idx('spot price at transaction') : idx('spot price')\n  const iTotal = idx('total') !== -1 ? idx('total') : idx('subtotal')\n  const iFee = idx('fees and/or spread') !== -1 ? idx('fees and/or spread') : idx('fees')\n  const iNotes = idx('notes')\n\n  return rows.map(row => {\n    const rawType = (row[iType] || '').toLowerCase()\n    let type: RawTransaction['type'] = 'unknown'\n    if (rawType === 'buy' || rawType === 'advanced trade buy') type = 'buy'\n    else if (rawType === 'sell' || rawType === 'advanced trade sell') type = 'sell'\n    else if (rawType === 'receive') type = 'receive'\n    else if (rawType === 'send') type = 'send'\n    else if (rawType.includes('staking') || rawType.includes('reward')) type = 'staking_reward'\n    else if (rawType === 'airdrop') type = 'airdrop'\n    else if (rawType.includes('convert') || rawType.includes('swap')) type = 'conversion'\n    else if (rawType.includes('earn') || rawType === 'learning reward') type = 'airdrop'\n    else type = 'unknown'\n\n    const asset = (row[iAsset] || '').trim()\n    return {\n      date: parseDate(row[iTimestamp] || ''),\n      asset,\n      ticker: asset.toUpperCase(),\n      type,\n      quantity: parseNumber(row[iQty] || ''),\n      pricePerUnit: parseNumber(row[iPrice] || ''),\n      totalValue: Math.abs(parseNumber(row[iTotal] || '')),\n      fee: parseNumber(row[iFee] || ''),\n      notes: row[iNotes] || '',\n    }\n  }).filter(tx => tx.asset && tx.type !== 'unknown')\n}\n\nfunction parseKraken(headers: string[], rows: string[][]): RawTransaction[] {\n  const idx = (name: string) => headers.findIndex(h => h.includes(name))\n  const iTime = idx('time')\n  const iType = idx('type')\n  const iAsset = idx('asset')\n  const iAmount = idx('amount')\n  const iFee = idx('fee')\n  const iBalance = idx('balance')\n\n  return rows.map(row => {\n    const rawType = (row[iType] || '').toLowerCase()\n    let type: RawTransaction['type'] = 'unknown'\n    if (rawType === 'trade' || rawType === 'buy') type = 'buy'\n    else if (rawType === 'sell') type = 'sell'\n    else if (rawType === 'deposit') type = 'deposit'\n    else if (rawType === 'withdrawal') type = 'withdrawal'\n    else if (rawType === 'staking') type = 'staking_reward'\n    else if (rawType === 'transfer') type = 'receive'\n    else if (rawType === 'margin') type = 'trade'\n    else type = 'unknown'\n\n    let asset = (row[iAsset] || '').trim().toUpperCase()\n    // Kraken uses prefixes like XXBT for Bitcoin, XETH for Ethereum, ZUSD for USD\n    if (asset.startsWith('X') && asset.length === 4) asset = asset.substring(1)\n    if (asset.startsWith('Z') && asset.length === 4) asset = asset.substring(1)\n    if (asset === 'XBT') asset = 'BTC'\n\n    const amount = parseNumber(row[iAmount] || '')\n    if (amount < 0 && type === 'buy') type = 'sell'\n    if (amount > 0 && type === 'sell') type = 'buy'\n\n    return {\n      date: parseDate(row[iTime] || ''),\n      asset,\n      ticker: asset,\n      type,\n      quantity: Math.abs(amount),\n      pricePerUnit: 0, // Kraken ledger doesn't include price directly\n      totalValue: Math.abs(amount), // Will need price lookup\n      fee: parseNumber(row[iFee] || ''),\n      notes: `Kraken ${rawType}`,\n    }\n  }).filter(tx => tx.asset && !['USD', 'EUR', 'GBP', 'CAD', 'AUD', 'JPY'].includes(tx.asset) && tx.type !== 'unknown')\n}\n\nfunction parseBinance(headers: string[], rows: string[][]): RawTransaction[] {\n  const idx = (name: string) => headers.findIndex(h => h.includes(name))\n  const iDate = idx('dateutc') !== -1 ? idx('dateutc') : idx('date')\n  const iPair = idx('pair') !== -1 ? idx('pair') : idx('market')\n  const iType = idx('type') !== -1 ? idx('type') : idx('side')\n  const iPrice = idx('price')\n  const iQty = idx('executed qty') !== -1 ? idx('executed qty') : (idx('amount') !== -1 ? idx('amount') : idx('qty'))\n  const iTotal = idx('total') !== -1 ? idx('total') : idx('total quota')\n  const iFee = idx('fee')\n\n  return rows.map(row => {\n    const rawType = (row[iType] || '').toLowerCase()\n    const pair = (row[iPair] || '').toUpperCase()\n    // Extract base asset from pair (e.g., \"BTCUSDT\" -> \"BTC\")\n    const stables = ['USDT', 'USDC', 'BUSD', 'USD', 'EUR', 'BTC', 'ETH', 'BNB']\n    let asset = pair\n    for (const s of stables) {\n      if (pair.endsWith(s) && pair.length > s.length) {\n        asset = pair.substring(0, pair.length - s.length)\n        break\n      }\n    }\n\n    return {\n      date: parseDate(row[iDate] || ''),\n      asset,\n      ticker: asset,\n      type: rawType === 'buy' ? 'buy' as const : rawType === 'sell' ? 'sell' as const : 'trade' as const,\n      quantity: parseNumber(row[iQty] || ''),\n      pricePerUnit: parseNumber(row[iPrice] || ''),\n      totalValue: parseNumber(row[iTotal] || ''),\n      fee: parseNumber(row[iFee] || ''),\n      notes: `Binance ${pair} ${rawType}`,\n    }\n  }).filter(tx => tx.asset && tx.quantity > 0)\n}\n\nfunction parseRobinhood(headers: string[], rows: string[][]): RawTransaction[] {\n  const idx = (name: string) => headers.findIndex(h => h.includes(name))\n  const iDate = idx('activity date') !== -1 ? idx('activity date') : idx('date')\n  const iInstrument = idx('instrument') !== -1 ? idx('instrument') : idx('description')\n  const iType = idx('trans code') !== -1 ? idx('trans code') : idx('activity type')\n  const iQty = idx('quantity')\n  const iPrice = idx('price')\n  const iAmount = idx('amount')\n\n  return rows.map(row => {\n    const rawType = (row[iType] || '').toLowerCase()\n    let type: RawTransaction['type'] = 'unknown'\n    if (rawType === 'buy' || rawType === 'ach' || rawType.includes('buy')) type = 'buy'\n    else if (rawType === 'sell' || rawType.includes('sell')) type = 'sell'\n    else if (rawType === 'div' || rawType.includes('dividend')) type = 'dividend'\n    else if (rawType.includes('interest')) type = 'interest'\n    else type = 'unknown'\n\n    const instrument = (row[iInstrument] || '').trim()\n    const ticker = instrument.split(' ')[0].toUpperCase()\n\n    return {\n      date: parseDate(row[iDate] || ''),\n      asset: instrument || ticker,\n      ticker,\n      type,\n      quantity: Math.abs(parseNumber(row[iQty] || '')),\n      pricePerUnit: parseNumber(row[iPrice] || ''),\n      totalValue: Math.abs(parseNumber(row[iAmount] || '')),\n      fee: 0,\n      notes: `Robinhood ${rawType}`,\n    }\n  }).filter(tx => tx.asset && tx.type !== 'unknown' && tx.quantity > 0)\n}\n\nfunction parseSchwab(headers: string[], rows: string[][]): RawTransaction[] {\n  const idx = (name: string) => headers.findIndex(h => h.includes(name))\n  const iDate = idx('date')\n  const iAction = idx('action')\n  const iSymbol = idx('symbol')\n  const iDesc = idx('description')\n  const iQty = idx('quantity')\n  const iPrice = idx('price')\n  const iAmount = idx('amount')\n  const iFee = idx('fees  commissions') !== -1 ? idx('fees  commissions') : idx('fees')\n\n  return rows.map(row => {\n    const action = (row[iAction] || '').toLowerCase()\n    let type: RawTransaction['type'] = 'unknown'\n    if (action.includes('buy')) type = 'buy'\n    else if (action.includes('sell')) type = 'sell'\n    else if (action.includes('dividend') || action.includes('div')) type = 'dividend'\n    else if (action.includes('interest')) type = 'interest'\n    else if (action.includes('reinvest')) type = 'buy'\n    else type = 'unknown'\n\n    const ticker = (row[iSymbol] || '').trim().toUpperCase()\n    const desc = (row[iDesc] || '').trim()\n\n    return {\n      date: parseDate(row[iDate] || ''),\n      asset: desc || ticker,\n      ticker,\n      type,\n      quantity: Math.abs(parseNumber(row[iQty] || '')),\n      pricePerUnit: parseNumber(row[iPrice] || ''),\n      totalValue: Math.abs(parseNumber(row[iAmount] || '')),\n      fee: parseNumber(row[iFee] || ''),\n      notes: `Schwab ${action}: ${desc}`,\n    }\n  }).filter(tx => tx.ticker && tx.type !== 'unknown')\n}\n\nfunction parseFidelity(headers: string[], rows: string[][]): RawTransaction[] {\n  const idx = (name: string) => headers.findIndex(h => h.includes(name))\n  const iDate = idx('run date') !== -1 ? idx('run date') : idx('date')\n  const iAction = idx('action')\n  const iSymbol = idx('symbol')\n  const iDesc = idx('security description') !== -1 ? idx('security description') : idx('description')\n  const iQty = idx('quantity')\n  const iPrice = idx('price')\n  const iAmount = idx('amount')\n  const iComm = idx('commission')\n  const iFee = idx('fees')\n\n  return rows.map(row => {\n    const action = (row[iAction] || '').toLowerCase()\n    let type: RawTransaction['type'] = 'unknown'\n    if (action.includes('bought') || action.includes('buy') || action.includes('reinvestment')) type = 'buy'\n    else if (action.includes('sold') || action.includes('sell')) type = 'sell'\n    else if (action.includes('dividend')) type = 'dividend'\n    else if (action.includes('interest')) type = 'interest'\n    else type = 'unknown'\n\n    const ticker = (row[iSymbol] || '').trim().toUpperCase()\n    const desc = (row[iDesc] || '').trim()\n\n    return {\n      date: parseDate(row[iDate] || ''),\n      asset: desc || ticker,\n      ticker,\n      type,\n      quantity: Math.abs(parseNumber(row[iQty] || '')),\n      pricePerUnit: parseNumber(row[iPrice] || ''),\n      totalValue: Math.abs(parseNumber(row[iAmount] || '')),\n      fee: parseNumber(row[iComm] || '') + parseNumber(row[iFee] || ''),\n      notes: `Fidelity ${action}: ${desc}`,\n    }\n  }).filter(tx => tx.ticker && tx.type !== 'unknown')\n}\n\nfunction parseGenericBank(headers: string[], rows: string[][]): RawTransaction[] {\n  const idx = (name: string) => headers.findIndex(h => h.includes(name))\n  const iDate = idx('posting date') !== -1 ? idx('posting date') : (idx('transaction date') !== -1 ? idx('transaction date') : idx('date'))\n  const iDesc = idx('description') !== -1 ? idx('description') : idx('memo')\n  const iAmount = idx('amount')\n  const iDebit = idx('debit')\n  const iCredit = idx('credit')\n\n  return rows.map(row => {\n    let amount: number\n    if (iDebit !== -1 && iCredit !== -1) {\n      const debit = parseNumber(row[iDebit] || '')\n      const credit = parseNumber(row[iCredit] || '')\n      amount = credit > 0 ? credit : -debit\n    } else {\n      amount = parseNumber(row[iAmount] || '')\n    }\n\n    const desc = (row[iDesc] || '').trim()\n    const type: RawTransaction['type'] = amount >= 0 ? 'deposit' : 'withdrawal'\n\n    return {\n      date: parseDate(row[iDate] || ''),\n      asset: desc,\n      ticker: '',\n      type,\n      quantity: 1,\n      pricePerUnit: Math.abs(amount),\n      totalValue: Math.abs(amount),\n      fee: 0,\n      notes: desc,\n    }\n  }).filter(tx => tx.totalValue > 0)\n}\n\n// ─── Custom CSV with Column Mapping ─────────────────────────────────────────\n\nfunction parseCustom(headers: string[], rows: string[][], mapping: ColumnMapping): RawTransaction[] {\n  return rows.map(row => {\n    const typeStr = mapping.type !== undefined ? (row[mapping.type] || '').toLowerCase() : ''\n    let type: RawTransaction['type'] = 'unknown'\n    if (typeStr.includes('buy') || typeStr.includes('purchase')) type = 'buy'\n    else if (typeStr.includes('sell') || typeStr.includes('sale')) type = 'sell'\n    else if (typeStr.includes('stake') || typeStr.includes('reward')) type = 'staking_reward'\n    else if (typeStr.includes('airdrop')) type = 'airdrop'\n    else if (typeStr.includes('convert') || typeStr.includes('swap')) type = 'conversion'\n    else if (typeStr.includes('send') || typeStr.includes('transfer out')) type = 'send'\n    else if (typeStr.includes('receive') || typeStr.includes('transfer in')) type = 'receive'\n    else type = 'buy' // default to buy\n\n    const asset = mapping.asset !== undefined ? (row[mapping.asset] || '').trim() : 'UNKNOWN'\n    const qty = mapping.quantity !== undefined ? parseNumber(row[mapping.quantity] || '') : 0\n    const price = mapping.price !== undefined ? parseNumber(row[mapping.price] || '') : 0\n    const total = mapping.total !== undefined ? parseNumber(row[mapping.total] || '') : (qty * price)\n\n    return {\n      date: mapping.date !== undefined ? parseDate(row[mapping.date] || '') : undefined,\n      asset,\n      ticker: asset.toUpperCase().split(' ')[0],\n      type,\n      quantity: qty || (total > 0 && price > 0 ? total / price : 1),\n      pricePerUnit: price || (total > 0 && qty > 0 ? total / qty : 0),\n      totalValue: total || (qty * price),\n      fee: mapping.fee !== undefined ? parseNumber(row[mapping.fee] || '') : 0,\n      notes: mapping.notes !== undefined ? (row[mapping.notes] || '') : '',\n    }\n  }).filter(tx => tx.asset && tx.asset !== 'UNKNOWN')\n}\n\n// ─── Auto Column Mapping ────────────────────────────────────────────────────\n\nexport function autoMapColumns(headers: string[]): ColumnMapping {\n  const mapping: ColumnMapping = {}\n  \n  for (let i = 0; i < headers.length; i++) {\n    const h = headers[i].toLowerCase()\n    if (!mapping.date && (h.includes('date') || h.includes('time') || h.includes('timestamp'))) mapping.date = i\n    if (!mapping.asset && (h.includes('asset') || h.includes('currency') || h.includes('symbol') || h.includes('coin') || h.includes('token') || h.includes('ticker') || h.includes('instrument'))) mapping.asset = i\n    if (!mapping.type && (h.includes('type') || h.includes('action') || h.includes('side') || h.includes('trans'))) mapping.type = i\n    if (!mapping.quantity && (h.includes('quantity') || h.includes('amount') || h.includes('qty') || h.includes('size') || h.includes('volume'))) mapping.quantity = i\n    if (!mapping.price && (h.includes('price') || h.includes('rate') || h.includes('spot'))) mapping.price = i\n    if (!mapping.total && (h.includes('total') || h.includes('value') || h.includes('cost') || h.includes('proceeds'))) mapping.total = i\n    if (!mapping.fee && (h.includes('fee') || h.includes('commission') || h.includes('spread'))) mapping.fee = i\n    if (!mapping.notes && (h.includes('note') || h.includes('memo') || h.includes('description') || h.includes('comment'))) mapping.notes = i\n  }\n\n  return mapping\n}\n\n// ─── Main Import Function ───────────────────────────────────────────────────\n\nexport function importCSV(csvText: string, overrideFormat?: SupportedFormat, customMapping?: ColumnMapping): ImportResult {\n  const { headers, rows } = parseCSV(csvText)\n  const warnings: string[] = []\n  let skippedRows = 0\n\n  if (headers.length === 0) {\n    return { source: 'Unknown', format: 'unknown', positions: [], taxEvents: [], warnings: ['Could not detect any CSV headers. Please ensure the file is a valid CSV.'], skippedRows: 0, totalRows: 0, rawHeaders: [] }\n  }\n\n  const format = overrideFormat || detectFormat(headers)\n  let transactions: RawTransaction[] = []\n\n  try {\n    switch (format) {\n      case 'coinbase':\n        transactions = parseCoinbase(headers, rows)\n        break\n      case 'kraken':\n        transactions = parseKraken(headers, rows)\n        break\n      case 'binance':\n        transactions = parseBinance(headers, rows)\n        break\n      case 'robinhood':\n        transactions = parseRobinhood(headers, rows)\n        break\n      case 'schwab':\n        transactions = parseSchwab(headers, rows)\n        break\n      case 'fidelity':\n        transactions = parseFidelity(headers, rows)\n        break\n      case 'generic_bank':\n        transactions = parseGenericBank(headers, rows)\n        break\n      case 'custom':\n        transactions = parseCustom(headers, rows, customMapping || autoMapColumns(headers))\n        break\n    }\n  } catch (err) {\n    warnings.push(`Parser error: ${err instanceof Error ? err.message : String(err)}`)\n  }\n\n  skippedRows = rows.length - transactions.length\n  if (skippedRows > 0) {\n    warnings.push(`${skippedRows} rows skipped (unrecognized transaction types, fiat-only, or missing data)`)\n  }\n\n  // Sort by date\n  transactions.sort((a, b) => {\n    if (!a.date) return 1\n    if (!b.date) return -1\n    return a.date.localeCompare(b.date)\n  })\n\n  const sourceNames: Record<SupportedFormat, string> = {\n    coinbase: 'Coinbase',\n    kraken: 'Kraken',\n    binance: 'Binance',\n    robinhood: 'Robinhood',\n    schwab: 'Charles Schwab',\n    fidelity: 'Fidelity',\n    generic_bank: 'Bank Statement',\n    custom: 'Custom CSV',\n  }\n\n  const { positions, taxEvents } = aggregateToPositions(transactions, sourceNames[format])\n\n  if (positions.length === 0 && taxEvents.length === 0) {\n    warnings.push('No positions or tax events could be extracted. The file format may not be recognized or contains only fiat transactions.')\n  }\n\n  return {\n    source: sourceNames[format],\n    format,\n    positions,\n    taxEvents,\n    warnings,\n    skippedRows,\n    totalRows: rows.length,\n    rawHeaders: headers,\n  }\n}\n\n// ─── Format Info for UI ─────────────────────────────────────────────────────\n\nexport const SUPPORTED_FORMATS: { id: SupportedFormat; label: string; description: string; icon: string }[] = [\n  { id: 'coinbase', label: 'Coinbase', description: 'Transaction History export (CSV)', icon: '🔵' },\n  { id: 'kraken', label: 'Kraken', description: 'Ledger export (CSV)', icon: '🐙' },\n  { id: 'binance', label: 'Binance', description: 'Trade History export (CSV)', icon: '🟡' },\n  { id: 'robinhood', label: 'Robinhood', description: 'Account Statements / 1099 (CSV)', icon: '🪶' },\n  { id: 'schwab', label: 'Charles Schwab', description: 'Transaction History export (CSV)', icon: '🏦' },\n  { id: 'fidelity', label: 'Fidelity', description: 'Activity & Orders export (CSV)', icon: '🏛️' },\n  { id: 'generic_bank', label: 'Bank Statement', description: 'Chase, Wells Fargo, etc. (CSV)', icon: '🏧' },\n  { id: 'custom', label: 'Custom CSV', description: 'Map your own columns', icon: '📄' },\n]\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\data-import.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'header' is assigned a value but never used.","line":56,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":56,"endColumn":15},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":141,"column":17,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":141,"endColumn":18,"suggestions":[{"messageId":"removeEscape","fix":{"range":[4606,4607],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[4606,4606],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\-.","line":141,"column":19,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":141,"endColumn":20,"suggestions":[{"messageId":"removeEscape","fix":{"range":[4608,4609],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[4608,4608],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":141,"column":32,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":141,"endColumn":33,"suggestions":[{"messageId":"removeEscape","fix":{"range":[4621,4622],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[4621,4621],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\-.","line":141,"column":34,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":141,"endColumn":35,"suggestions":[{"messageId":"removeEscape","fix":{"range":[4623,4624],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[4623,4623],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":142,"column":15,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":142,"endColumn":16,"suggestions":[{"messageId":"removeEscape","fix":{"range":[4665,4666],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[4665,4665],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\-.","line":142,"column":17,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":142,"endColumn":18,"suggestions":[{"messageId":"removeEscape","fix":{"range":[4667,4668],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[4667,4667],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":142,"column":30,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":142,"endColumn":31,"suggestions":[{"messageId":"removeEscape","fix":{"range":[4680,4681],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[4680,4680],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\-.","line":142,"column":32,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":142,"endColumn":33,"suggestions":[{"messageId":"removeEscape","fix":{"range":[4682,4683],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[4682,4682],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":143,"column":17,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":143,"endColumn":18,"suggestions":[{"messageId":"removeEscape","fix":{"range":[4728,4729],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[4728,4728],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\-.","line":143,"column":19,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":143,"endColumn":20,"suggestions":[{"messageId":"removeEscape","fix":{"range":[4730,4731],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[4730,4730],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":143,"column":32,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":143,"endColumn":33,"suggestions":[{"messageId":"removeEscape","fix":{"range":[4743,4744],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[4743,4743],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\-.","line":143,"column":34,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":143,"endColumn":35,"suggestions":[{"messageId":"removeEscape","fix":{"range":[4745,4746],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[4745,4745],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_' is defined but never used.","line":411,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":411,"endColumn":16}],"suppressedMessages":[],"errorCount":14,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine v5 - Data Import Pipeline\n * CSV/OFX bank statement parsing with intelligent auto-categorization.\n * Bridges the gap between manual entry and real financial data.\n */\n\nimport { genId, type IncomeStream, type BusinessExpense } from './storage'\n\n// ==================== Types ====================\n\nexport interface RawTransaction {\n  date: string\n  description: string\n  amount: number // positive = credit/income, negative = debit/expense\n  category?: string\n  memo?: string\n  checkNumber?: string\n  fitId?: string\n}\n\nexport interface CategorizedTransaction extends RawTransaction {\n  autoCategory: TransactionCategory\n  confidence: number // 0-1\n  isIncome: boolean\n  suggestedType?: IncomeStream['type'] | 'expense'\n  suggestedExpenseCategory?: string\n}\n\nexport type TransactionCategory =\n  | 'business_income' | 'freelance_income' | 'salary' | 'investment_income' | 'rental_income' | 'other_income'\n  | 'office_supplies' | 'software_subscriptions' | 'advertising' | 'travel' | 'meals' | 'vehicle' | 'insurance'\n  | 'professional_services' | 'utilities' | 'rent_lease' | 'equipment' | 'education' | 'charitable'\n  | 'health_medical' | 'bank_fees' | 'taxes_paid' | 'personal' | 'transfer' | 'unknown'\n\nexport interface ImportResult {\n  transactions: CategorizedTransaction[]\n  summary: {\n    totalTransactions: number\n    totalIncome: number\n    totalExpenses: number\n    dateRange: { start: string; end: string }\n    topCategories: { category: string; amount: number; count: number }[]\n    unclassified: number\n  }\n  suggestedIncomeStreams: Partial<IncomeStream>[]\n  suggestedExpenses: Partial<BusinessExpense>[]\n}\n\n// ==================== CSV Parser ====================\n\nexport function parseCSV(csvContent: string): RawTransaction[] {\n  const lines = csvContent.trim().split('\\n')\n  if (lines.length < 2) return []\n  \n  // Detect header format\n  const header = lines[0].toLowerCase()\n  const transactions: RawTransaction[] = []\n  \n  // Common CSV formats from banks\n  let dateCol = -1, descCol = -1, amountCol = -1, debitCol = -1, creditCol = -1, memoCol = -1, categoryCol = -1\n  \n  const headers = parseCSVLine(lines[0]).map(h => h.toLowerCase().trim())\n  \n  headers.forEach((h, i) => {\n    if (/^(date|posted|trans.*date|posting.*date)$/.test(h)) dateCol = i\n    else if (/^(description|desc|payee|merchant|name|transaction)$/.test(h)) descCol = i\n    else if (/^(amount|total|net)$/.test(h)) amountCol = i\n    else if (/^(debit|withdrawal|charge)$/.test(h)) debitCol = i\n    else if (/^(credit|deposit|payment)$/.test(h)) creditCol = i\n    else if (/^(memo|note|reference)$/.test(h)) memoCol = i\n    else if (/^(category|type|class)$/.test(h)) categoryCol = i\n  })\n  \n  // Fallback: assume Date, Description, Amount\n  if (dateCol === -1 && headers.length >= 3) { dateCol = 0; descCol = 1; amountCol = 2 }\n  if (dateCol === -1 || descCol === -1) return []\n  \n  for (let i = 1; i < lines.length; i++) {\n    const cols = parseCSVLine(lines[i])\n    if (cols.length < 2) continue\n    \n    const dateStr = cols[dateCol]?.trim()\n    const desc = cols[descCol]?.trim()\n    if (!dateStr || !desc) continue\n    \n    let amount = 0\n    if (amountCol >= 0 && cols[amountCol]) {\n      amount = parseAmount(cols[amountCol])\n    } else if (debitCol >= 0 || creditCol >= 0) {\n      const debit = debitCol >= 0 && cols[debitCol] ? parseAmount(cols[debitCol]) : 0\n      const credit = creditCol >= 0 && cols[creditCol] ? parseAmount(cols[creditCol]) : 0\n      amount = credit - Math.abs(debit)\n    }\n    \n    transactions.push({\n      date: normalizeDate(dateStr),\n      description: desc,\n      amount,\n      category: categoryCol >= 0 ? cols[categoryCol]?.trim() : undefined,\n      memo: memoCol >= 0 ? cols[memoCol]?.trim() : undefined,\n    })\n  }\n  \n  return transactions\n}\n\nfunction parseCSVLine(line: string): string[] {\n  const result: string[] = []\n  let current = ''\n  let inQuotes = false\n  \n  for (let i = 0; i < line.length; i++) {\n    const ch = line[i]\n    if (ch === '\"') {\n      if (inQuotes && line[i + 1] === '\"') {\n        current += '\"'\n        i++\n      } else {\n        inQuotes = !inQuotes\n      }\n    } else if (ch === ',' && !inQuotes) {\n      result.push(current)\n      current = ''\n    } else {\n      current += ch\n    }\n  }\n  result.push(current)\n  return result\n}\n\nfunction parseAmount(str: string): number {\n  const cleaned = str.replace(/[$,\\s\"]/g, '').replace(/\\((.+)\\)/, '-$1')\n  const num = parseFloat(cleaned)\n  return isNaN(num) ? 0 : num\n}\n\nexport function normalizeDate(dateStr: string): string {\n  // Try common formats\n  const formats = [\n    /^(\\d{1,2})[\\/\\-](\\d{1,2})[\\/\\-](\\d{4})$/, // MM/DD/YYYY\n    /^(\\d{4})[\\/\\-](\\d{1,2})[\\/\\-](\\d{1,2})$/, // YYYY-MM-DD\n    /^(\\d{1,2})[\\/\\-](\\d{1,2})[\\/\\-](\\d{2})$/,  // MM/DD/YY\n  ]\n  \n  let match = dateStr.match(formats[0])\n  if (match) return `${match[3]}-${match[1].padStart(2, '0')}-${match[2].padStart(2, '0')}`\n  \n  match = dateStr.match(formats[1])\n  if (match) return `${match[1]}-${match[2].padStart(2, '0')}-${match[3].padStart(2, '0')}`\n  \n  match = dateStr.match(formats[2])\n  if (match) {\n    const year = parseInt(match[3]) + (parseInt(match[3]) > 50 ? 1900 : 2000)\n    return `${year}-${match[1].padStart(2, '0')}-${match[2].padStart(2, '0')}`\n  }\n  \n  // Try Date.parse as last resort\n  const parsed = new Date(dateStr)\n  if (!isNaN(parsed.getTime())) {\n    return parsed.toISOString().split('T')[0]\n  }\n  \n  return dateStr\n}\n\n// ==================== OFX/QFX Parser ====================\n\nexport function parseOFX(content: string): RawTransaction[] {\n  const transactions: RawTransaction[] = []\n  \n  // OFX uses SGML-like tags\n  const stmtTrnRegex = /<STMTTRN>([\\s\\S]*?)<\\/STMTTRN>/gi\n  let match\n  \n  while ((match = stmtTrnRegex.exec(content)) !== null) {\n    const block = match[1]\n    \n    const date = extractOFXField(block, 'DTPOSTED')\n    const amount = extractOFXField(block, 'TRNAMT')\n    const name = extractOFXField(block, 'NAME') || extractOFXField(block, 'MEMO')\n    const memo = extractOFXField(block, 'MEMO')\n    const fitId = extractOFXField(block, 'FITID')\n    const checkNum = extractOFXField(block, 'CHECKNUM')\n    \n    if (date && amount && name) {\n      transactions.push({\n        date: formatOFXDate(date),\n        description: name.trim(),\n        amount: parseFloat(amount),\n        memo: memo?.trim(),\n        fitId,\n        checkNumber: checkNum,\n      })\n    }\n  }\n  \n  return transactions\n}\n\nfunction extractOFXField(block: string, field: string): string | null {\n  // OFX can use either <TAG>value or <TAG>value</TAG>\n  const regex1 = new RegExp(`<${field}>([^<\\\\n]+)`, 'i')\n  const regex2 = new RegExp(`<${field}>([\\\\s\\\\S]*?)<\\\\/${field}>`, 'i')\n  const match = block.match(regex2) || block.match(regex1)\n  return match ? match[1].trim() : null\n}\n\nfunction formatOFXDate(dateStr: string): string {\n  // OFX dates: YYYYMMDD or YYYYMMDDHHMMSS\n  if (dateStr.length >= 8) {\n    return `${dateStr.substring(0, 4)}-${dateStr.substring(4, 6)}-${dateStr.substring(6, 8)}`\n  }\n  return dateStr\n}\n\n// ==================== Intelligent Auto-Categorization ====================\n\nconst CATEGORY_PATTERNS: { pattern: RegExp; category: TransactionCategory; type: string }[] = [\n  // Income patterns\n  { pattern: /\\b(payroll|salary|direct deposit|ach credit|employer)\\b/i, category: 'salary', type: 'w2' },\n  { pattern: /\\b(stripe|paypal|square|venmo.*business|invoice)\\b/i, category: 'business_income', type: 'business' },\n  { pattern: /\\b(upwork|fiverr|freelanc|contract.*pay|1099)\\b/i, category: 'freelance_income', type: 'freelance' },\n  { pattern: /\\b(dividend|interest.*earned|capital.*gain|etrade|schwab|vanguard|fidelity)\\b/i, category: 'investment_income', type: 'investment' },\n  { pattern: /\\b(rent.*received|tenant|airbnb.*host|rental.*income)\\b/i, category: 'rental_income', type: 'rental' },\n  \n  // Expense patterns - Software/Tech\n  { pattern: /\\b(github|aws|azure|google cloud|digitalocean|heroku|vercel|netlify|cloudflare)\\b/i, category: 'software_subscriptions', type: 'expense' },\n  { pattern: /\\b(adobe|figma|canva|slack|zoom|microsoft 365|notion|asana|trello)\\b/i, category: 'software_subscriptions', type: 'expense' },\n  { pattern: /\\b(openai|anthropic|copilot|chatgpt)\\b/i, category: 'software_subscriptions', type: 'expense' },\n  \n  // Expense patterns - Office/Supplies\n  { pattern: /\\b(office depot|staples|amazon.*office|newegg|b&h photo)\\b/i, category: 'office_supplies', type: 'expense' },\n  { pattern: /\\b(apple\\.com|dell|lenovo|hp store)\\b/i, category: 'equipment', type: 'expense' },\n  \n  // Expense patterns - Advertising/Marketing\n  { pattern: /\\b(google ads|facebook ads|meta ads|linkedin ads|twitter ads|mailchimp|sendinblue|constant contact)\\b/i, category: 'advertising', type: 'expense' },\n  \n  // Expense patterns - Travel\n  { pattern: /\\b(airline|united|delta|american air|southwest|jetblue|hotel|marriott|hilton|airbnb|booking\\.com|expedia)\\b/i, category: 'travel', type: 'expense' },\n  { pattern: /\\b(uber|lyft|taxi|car rental|hertz|enterprise|national)\\b/i, category: 'travel', type: 'expense' },\n  \n  // Expense patterns - Meals\n  { pattern: /\\b(restaurant|doordash|grubhub|ubereats|cafe|coffee|starbucks|dunkin)\\b/i, category: 'meals', type: 'expense' },\n  \n  // Expense patterns - Vehicle\n  { pattern: /\\b(gas station|shell|exxon|chevron|bp|auto repair|jiffy lube|oil change|car wash)\\b/i, category: 'vehicle', type: 'expense' },\n  \n  // Expense patterns - Insurance\n  { pattern: /\\b(insurance|geico|state farm|allstate|progressive|aetna|cigna|blue cross|united health)\\b/i, category: 'insurance', type: 'expense' },\n  \n  // Expense patterns - Professional services\n  { pattern: /\\b(attorney|lawyer|legal|accountant|cpa|bookkeep|tax prep|consulting fee)\\b/i, category: 'professional_services', type: 'expense' },\n  \n  // Expense patterns - Utilities\n  { pattern: /\\b(electric|power|gas.*utility|water.*utility|internet|comcast|verizon|at&t|t-mobile|spectrum)\\b/i, category: 'utilities', type: 'expense' },\n  \n  // Expense patterns - Education\n  { pattern: /\\b(udemy|coursera|linkedin learning|pluralsight|o'reilly|book|tuition|seminar|conference|workshop)\\b/i, category: 'education', type: 'expense' },\n  \n  // Expense patterns - Charitable\n  { pattern: /\\b(donation|charity|nonprofit|red cross|salvation army|church|tithe|offering)\\b/i, category: 'charitable', type: 'expense' },\n  \n  // Expense patterns - Health\n  { pattern: /\\b(pharmacy|cvs|walgreens|doctor|hospital|medical|dental|vision|copay)\\b/i, category: 'health_medical', type: 'expense' },\n  \n  // Expense patterns - Bank\n  { pattern: /\\b(bank fee|service charge|overdraft|wire fee|atm fee|monthly maintenance)\\b/i, category: 'bank_fees', type: 'expense' },\n  \n  // Expense patterns - Taxes\n  { pattern: /\\b(irs|tax payment|estimated tax|state tax|1040-es|eftps)\\b/i, category: 'taxes_paid', type: 'expense' },\n  \n  // Transfers (not income or expense)\n  { pattern: /\\b(transfer|xfer|zelle|venmo(?!.*business)|cash app(?!.*business))\\b/i, category: 'transfer', type: 'transfer' },\n]\n\nexport function categorizeTransactions(transactions: RawTransaction[]): CategorizedTransaction[] {\n  return transactions.map(tx => {\n    const isIncome = tx.amount > 0\n    let bestMatch: { category: TransactionCategory; type: string; confidence: number } = {\n      category: isIncome ? 'other_income' : 'unknown',\n      type: isIncome ? 'other' : 'expense',\n      confidence: 0.2,\n    }\n    \n    // Try existing category if present\n    if (tx.category) {\n      const catLower = tx.category.toLowerCase()\n      const mappedCat = mapBankCategory(catLower)\n      if (mappedCat) {\n        bestMatch = { category: mappedCat.category, type: mappedCat.type, confidence: 0.7 }\n      }\n    }\n    \n    // Try pattern matching on description\n    for (const pattern of CATEGORY_PATTERNS) {\n      if (pattern.pattern.test(tx.description)) {\n        const confidence = 0.85\n        if (confidence > bestMatch.confidence) {\n          bestMatch = { category: pattern.category, type: pattern.type, confidence }\n        }\n        break\n      }\n    }\n    \n    // Also check memo\n    if (tx.memo && bestMatch.confidence < 0.7) {\n      for (const pattern of CATEGORY_PATTERNS) {\n        if (pattern.pattern.test(tx.memo)) {\n          bestMatch = { category: pattern.category, type: pattern.type, confidence: 0.65 }\n          break\n        }\n      }\n    }\n    \n    return {\n      ...tx,\n      autoCategory: bestMatch.category,\n      confidence: bestMatch.confidence,\n      isIncome: isIncome && bestMatch.type !== 'transfer',\n      suggestedType: bestMatch.type === 'expense' ? 'expense' : bestMatch.type as IncomeStream['type'],\n      suggestedExpenseCategory: !isIncome ? categoryToExpenseCategory(bestMatch.category) : undefined,\n    }\n  })\n}\n\nfunction mapBankCategory(cat: string): { category: TransactionCategory; type: string } | null {\n  const mappings: Record<string, { category: TransactionCategory; type: string }> = {\n    'income': { category: 'business_income', type: 'business' },\n    'payroll': { category: 'salary', type: 'w2' },\n    'food': { category: 'meals', type: 'expense' },\n    'dining': { category: 'meals', type: 'expense' },\n    'travel': { category: 'travel', type: 'expense' },\n    'transportation': { category: 'vehicle', type: 'expense' },\n    'shopping': { category: 'office_supplies', type: 'expense' },\n    'entertainment': { category: 'personal', type: 'expense' },\n    'health': { category: 'health_medical', type: 'expense' },\n    'education': { category: 'education', type: 'expense' },\n    'bills': { category: 'utilities', type: 'expense' },\n    'transfer': { category: 'transfer', type: 'transfer' },\n    'fee': { category: 'bank_fees', type: 'expense' },\n  }\n  \n  for (const [key, val] of Object.entries(mappings)) {\n    if (cat.includes(key)) return val\n  }\n  return null\n}\n\nfunction categoryToExpenseCategory(cat: TransactionCategory): string {\n  const map: Record<string, string> = {\n    office_supplies: 'Office Supplies',\n    software_subscriptions: 'Software & Subscriptions',\n    advertising: 'Advertising & Marketing',\n    travel: 'Travel',\n    meals: 'Meals & Entertainment',\n    vehicle: 'Vehicle & Transportation',\n    insurance: 'Insurance',\n    professional_services: 'Professional Services',\n    utilities: 'Utilities',\n    rent_lease: 'Rent & Lease',\n    equipment: 'Equipment',\n    education: 'Education & Training',\n    charitable: 'Charitable Contributions',\n    health_medical: 'Health & Medical',\n    bank_fees: 'Bank Fees',\n    taxes_paid: 'Taxes Paid',\n    personal: 'Personal (Non-Deductible)',\n    transfer: 'Transfer (Non-Deductible)',\n  }\n  return map[cat] || 'Uncategorized'\n}\n\n// ==================== Import Result Builder ====================\n\nexport function processImport(transactions: RawTransaction[]): ImportResult {\n  const categorized = categorizeTransactions(transactions)\n  \n  // Summary stats\n  const incomeTransactions = categorized.filter(t => t.isIncome)\n  const expenseTransactions = categorized.filter(t => !t.isIncome && t.autoCategory !== 'transfer')\n  \n  const totalIncome = incomeTransactions.reduce((sum, t) => sum + t.amount, 0)\n  const totalExpenses = Math.abs(expenseTransactions.reduce((sum, t) => sum + t.amount, 0))\n  \n  const dates = categorized.map(t => t.date).filter(Boolean).sort()\n  \n  // Category summary\n  const categoryTotals = new Map<string, { amount: number; count: number }>()\n  for (const tx of categorized) {\n    if (tx.autoCategory === 'transfer') continue\n    const existing = categoryTotals.get(tx.autoCategory) || { amount: 0, count: 0 }\n    existing.amount += Math.abs(tx.amount)\n    existing.count++\n    categoryTotals.set(tx.autoCategory, existing)\n  }\n  \n  const topCategories = Array.from(categoryTotals.entries())\n    .map(([category, data]) => ({ category, ...data }))\n    .sort((a, b) => b.amount - a.amount)\n    .slice(0, 10)\n  \n  // Suggest income streams (aggregate by category)\n  const incomeByType = new Map<string, number>()\n  for (const tx of incomeTransactions) {\n    const type = tx.suggestedType || 'other'\n    incomeByType.set(type, (incomeByType.get(type) || 0) + tx.amount)\n  }\n  \n  const suggestedIncomeStreams: Partial<IncomeStream>[] = Array.from(incomeByType.entries())\n    .filter(([_, amount]) => amount > 500)\n    .map(([type, amount]) => ({\n      id: genId(),\n      name: `Imported ${type.charAt(0).toUpperCase() + type.slice(1)} Income`,\n      type: type as IncomeStream['type'],\n      annualAmount: Math.round(amount * (12 / Math.max(1, getMonthSpan(dates)))),\n      isActive: true,\n    }))\n  \n  // Suggest expenses (aggregate by category)\n  const expenseByCategory = new Map<string, number>()\n  for (const tx of expenseTransactions) {\n    const cat = tx.suggestedExpenseCategory || 'Uncategorized'\n    expenseByCategory.set(cat, (expenseByCategory.get(cat) || 0) + Math.abs(tx.amount))\n  }\n  \n  const suggestedExpenses: Partial<BusinessExpense>[] = Array.from(expenseByCategory.entries())\n    .filter(([cat, amount]) => amount > 100 && cat !== 'Personal (Non-Deductible)' && cat !== 'Transfer (Non-Deductible)')\n    .map(([category, amount]) => ({\n      id: genId(),\n      category,\n      description: `Imported: ${category}`,\n      annualAmount: Math.round(amount * (12 / Math.max(1, getMonthSpan(dates)))),\n      isDeductible: !category.includes('Non-Deductible'),\n      deductionPct: category.includes('Meals') ? 50 : category.includes('Non-Deductible') ? 0 : 100,\n    }))\n  \n  return {\n    transactions: categorized,\n    summary: {\n      totalTransactions: categorized.length,\n      totalIncome,\n      totalExpenses,\n      dateRange: { start: dates[0] || '', end: dates[dates.length - 1] || '' },\n      topCategories,\n      unclassified: categorized.filter(t => t.autoCategory === 'unknown' || t.confidence < 0.5).length,\n    },\n    suggestedIncomeStreams,\n    suggestedExpenses,\n  }\n}\n\nfunction getMonthSpan(sortedDates: string[]): number {\n  if (sortedDates.length < 2) return 1\n  const start = new Date(sortedDates[0])\n  const end = new Date(sortedDates[sortedDates.length - 1])\n  return Math.max(1, Math.round((end.getTime() - start.getTime()) / (30.44 * 86400000)))\n}\n\n// ==================== File Detection ====================\n\nexport function detectFileFormat(content: string): 'csv' | 'ofx' | 'unknown' {\n  const trimmed = content.trim()\n  if (trimmed.includes('<OFX>') || trimmed.includes('OFXHEADER:') || trimmed.includes('<STMTTRN>')) {\n    return 'ofx'\n  }\n  // Check for CSV-like structure\n  const firstLine = trimmed.split('\\n')[0]\n  if (firstLine.includes(',') && trimmed.split('\\n').length > 1) {\n    return 'csv'\n  }\n  return 'unknown'\n}\n\nexport function importFromFile(content: string): ImportResult | { error: string } {\n  const format = detectFileFormat(content)\n  \n  if (format === 'unknown') {\n    return { error: 'Unrecognized file format. Please upload a CSV or OFX/QFX file.' }\n  }\n  \n  const rawTransactions = format === 'csv' ? parseCSV(content) : parseOFX(content)\n  \n  if (rawTransactions.length === 0) {\n    return { error: 'No transactions found in file. Check the file format and try again.' }\n  }\n  \n  return processImport(rawTransactions)\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\data-safety.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'repaired' is never reassigned. Use 'const' instead.","line":40,"column":7,"nodeType":"Identifier","messageId":"useConst","endLine":40,"endColumn":15,"fix":{"range":[1244,1264],"text":"const repaired = false"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'saved' is assigned a value but never used.","line":483,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":483,"endColumn":12}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — Data Safety Layer\n *\n * Protects user data with:\n *   1. Backup rotation — keeps last 3 clean saves, auto-rotates\n *   2. Corruption detection — validates state structure before save\n *   3. Recovery — falls back through backup chain on load failure\n *   4. Storage quota monitoring — warns before localStorage fills up\n *   5. Emergency export — one-click JSON dump even in error state\n *\n * @module data-safety\n */\n\nimport type { FortunaState } from './storage'\nimport { createDefaultState } from './storage'\n\n// ─── Configuration ────────────────────────────────────────────────────────\n\nconst BACKUP_PREFIX = 'fortuna_backup_'\nconst MAX_BACKUPS = 3\nconst CORRUPTION_LOG_KEY = 'fortuna_corruption_log'\nconst QUOTA_WARN_MB = 4.5  // localStorage is typically 5MB; warn at 4.5\n\n// ─── State Validation ─────────────────────────────────────────────────────\n\nexport interface ValidationResult {\n  valid: boolean\n  errors: string[]\n  warnings: string[]\n  repaired: boolean\n}\n\n/**\n * Deep structural validation of FortunaState.\n * Checks required fields, types, and referential integrity.\n */\nexport function validateState(state: unknown): ValidationResult {\n  const errors: string[] = []\n  const warnings: string[] = []\n  let repaired = false\n\n  if (!state || typeof state !== 'object') {\n    return { valid: false, errors: ['State is not an object'], warnings: [], repaired: false }\n  }\n\n  const s = state as Record<string, unknown>\n\n  // Required top-level fields\n  if (!s.profile || typeof s.profile !== 'object') {\n    errors.push('Missing or invalid profile object')\n  } else {\n    const p = s.profile as Record<string, unknown>\n    if (!p.filingStatus || typeof p.filingStatus !== 'string') {\n      errors.push('Missing profile.filingStatus')\n    } else if (!['single', 'married_joint', 'married_separate', 'head_of_household'].includes(p.filingStatus as string)) {\n      errors.push(`Invalid filingStatus: \"${p.filingStatus}\"`)\n    }\n  }\n\n  // Top-level field validation\n  if (typeof s.taxYear !== 'number' || (s.taxYear as number) < 2020 || (s.taxYear as number) > 2030) {\n    warnings.push(`Unusual taxYear: ${s.taxYear}`)\n  }\n\n  // Arrays that must exist\n  const requiredArrays = [\n    'incomeStreams', 'expenses', 'entities', 'deductions',\n    'depreciationAssets', 'investmentPortfolio', 'retirementAccounts',\n    'goals', 'documents', 'estimatedPayments', 'receipts',\n    'intakeBatches', 'auditHistory',\n  ]\n  for (const key of requiredArrays) {\n    if (s[key] === undefined || s[key] === null) {\n      warnings.push(`Missing array: ${key} (will default to [])`)\n    } else if (!Array.isArray(s[key])) {\n      errors.push(`${key} is not an array`)\n    }\n  }\n\n  // Validate income streams\n  if (Array.isArray(s.incomeStreams)) {\n    for (let i = 0; i < (s.incomeStreams as unknown[]).length; i++) {\n      const inc = (s.incomeStreams as Record<string, unknown>[])[i]\n      if (!inc.id) warnings.push(`incomeStreams[${i}] missing id`)\n      if (typeof inc.annualAmount !== 'number') errors.push(`incomeStreams[${i}] annualAmount is not a number`)\n      if (typeof inc.annualAmount === 'number' && inc.annualAmount < 0) {\n        warnings.push(`incomeStreams[${i}] has negative annualAmount: ${inc.annualAmount}`)\n      }\n      if (typeof inc.annualAmount === 'number' && inc.annualAmount > 100_000_000) {\n        warnings.push(`incomeStreams[${i}] has unusually high annualAmount: $${(inc.annualAmount as number).toLocaleString()}`)\n      }\n    }\n  }\n\n  // Validate expenses\n  if (Array.isArray(s.expenses)) {\n    for (let i = 0; i < (s.expenses as unknown[]).length; i++) {\n      const exp = (s.expenses as Record<string, unknown>[])[i]\n      if (!exp.id) warnings.push(`expenses[${i}] missing id`)\n      if (typeof exp.annualAmount !== 'number') errors.push(`expenses[${i}] annualAmount is not a number`)\n      if (typeof exp.annualAmount === 'number' && exp.annualAmount < 0) {\n        warnings.push(`expenses[${i}] has negative annualAmount`)\n      }\n    }\n  }\n\n  // Validate entities\n  if (Array.isArray(s.entities)) {\n    for (let i = 0; i < (s.entities as unknown[]).length; i++) {\n      const ent = (s.entities as Record<string, unknown>[])[i]\n      if (!ent.id) warnings.push(`entities[${i}] missing id`)\n      if (!ent.name) warnings.push(`entities[${i}] missing name`)\n      if (!ent.type) errors.push(`entities[${i}] missing type`)\n    }\n  }\n\n  // Validate retirement accounts\n  if (Array.isArray(s.retirementAccounts)) {\n    for (let i = 0; i < (s.retirementAccounts as unknown[]).length; i++) {\n      const ret = (s.retirementAccounts as Record<string, unknown>[])[i]\n      if (typeof ret.balance === 'number' && ret.balance < 0) {\n        warnings.push(`retirementAccounts[${i}] has negative balance`)\n      }\n      if (typeof ret.annualContribution === 'number' && ret.annualContribution < 0) {\n        warnings.push(`retirementAccounts[${i}] has negative contribution`)\n      }\n    }\n  }\n\n  // Check for orphaned entity references\n  if (Array.isArray(s.entities) && Array.isArray(s.incomeStreams)) {\n    const entityIds = new Set((s.entities as Record<string, unknown>[]).map(e => e.id))\n    for (const inc of (s.incomeStreams as Record<string, unknown>[])) {\n      if (inc.entityId && !entityIds.has(inc.entityId)) {\n        warnings.push(`Income \"${inc.name}\" references non-existent entity \"${inc.entityId}\"`)\n      }\n    }\n  }\n\n  // Referential integrity: expenses → entities\n  if (Array.isArray(s.entities) && Array.isArray(s.expenses)) {\n    const entityIds = new Set((s.entities as Record<string, unknown>[]).map(e => e.id))\n    for (const exp of (s.expenses as Record<string, unknown>[])) {\n      if (exp.entityId && !entityIds.has(exp.entityId)) {\n        warnings.push(`Expense \"${exp.description}\" references non-existent entity \"${exp.entityId}\"`)\n      }\n    }\n  }\n\n  return {\n    valid: errors.length === 0,\n    errors,\n    warnings,\n    repaired,\n  }\n}\n\n/**\n * Attempt to repair common state issues.\n * Returns a cleaned copy (does NOT mutate input).\n */\nexport function repairState(state: unknown): { state: FortunaState; repairs: string[] } {\n  const repairs: string[] = []\n  const defaults = createDefaultState()\n\n  if (!state || typeof state !== 'object') {\n    repairs.push('State was null/undefined — created fresh default state')\n    return { state: defaults, repairs }\n  }\n\n  const s = { ...state } as Record<string, unknown>\n\n  // Ensure profile exists\n  // Ensure profile and filingStatus exists\n  if (!s.profile || typeof s.profile !== 'object') {\n    s.profile = defaults.profile\n    repairs.push('Restored missing profile')\n  } else {\n    const p = s.profile as Record<string, unknown>\n    if (!p.filingStatus || typeof p.filingStatus !== 'string') {\n      p.filingStatus = defaults.profile.filingStatus\n      repairs.push('Restored missing profile.filingStatus')\n    }\n  }\n\n  // Ensure taxYear exists\n  if (typeof s.taxYear !== 'number') {\n    s.taxYear = defaults.taxYear\n    repairs.push(`Restored taxYear to ${defaults.taxYear}`)\n  }\n\n  // Ensure all arrays exist\n  const arrayFields = [\n    'incomeStreams', 'expenses', 'entities', 'deductions',\n    'depreciationAssets', 'investmentPortfolio', 'retirementAccounts',\n    'goals', 'documents', 'estimatedPayments', 'receipts',\n    'intakeBatches', 'auditHistory',\n  ]\n  for (const key of arrayFields) {\n    if (!Array.isArray(s[key])) {\n      s[key] = []\n      repairs.push(`Initialized missing array: ${key}`)\n    }\n  }\n\n  // Add missing IDs\n  for (const key of arrayFields) {\n    const arr = s[key] as Record<string, unknown>[]\n    for (let i = 0; i < arr.length; i++) {\n      if (!arr[i].id) {\n        arr[i] = { ...arr[i], id: `repair_${key}_${i}_${Date.now().toString(36)}` }\n        repairs.push(`Generated missing id for ${key}[${i}]`)\n      }\n    }\n  }\n\n  // Ensure onboardingComplete is boolean\n  if (typeof s.onboardingComplete !== 'boolean') {\n    s.onboardingComplete = false\n    repairs.push('Reset onboardingComplete to false')\n  }\n\n  return { state: s as unknown as FortunaState, repairs }\n}\n\n// ─── Backup Rotation ──────────────────────────────────────────────────────\n\n/**\n * Save a backup before overwriting main state.\n * Keeps up to MAX_BACKUPS rotated copies.\n */\nexport function saveBackup(state: FortunaState): boolean {\n  try {\n    // Validate before backing up — don't backup corruption\n    const v = validateState(state)\n    if (!v.valid) return false\n\n    const key = `${BACKUP_PREFIX}${Date.now()}`\n    const payload = JSON.stringify({\n      _backupAt: new Date().toISOString(),\n      _stateHash: simpleHash(JSON.stringify(state)),\n      state,\n    })\n\n    localStorage.setItem(key, payload)\n\n    // Rotate: remove oldest backups beyond MAX_BACKUPS\n    const backupKeys = Object.keys(localStorage)\n      .filter(k => k.startsWith(BACKUP_PREFIX))\n      .sort()\n\n    while (backupKeys.length > MAX_BACKUPS) {\n      const oldest = backupKeys.shift()\n      if (oldest) localStorage.removeItem(oldest)\n    }\n\n    return true\n  } catch {\n    return false\n  }\n}\n\n/**\n * List available backups, newest first.\n */\nexport function listBackups(): { key: string; timestamp: string; sizeKB: number }[] {\n  try {\n    return Object.keys(localStorage)\n      .filter(k => k.startsWith(BACKUP_PREFIX))\n      .sort()\n      .reverse()\n      .map(key => {\n        const raw = localStorage.getItem(key)\n        let timestamp = ''\n        try {\n          const parsed = JSON.parse(raw || '{}')\n          timestamp = parsed._backupAt || ''\n        } catch { /* */ }\n        return {\n          key,\n          timestamp,\n          sizeKB: Math.round((raw?.length || 0) / 1024),\n        }\n      })\n  } catch {\n    return []\n  }\n}\n\n/**\n * Restore state from a specific backup.\n */\nexport function restoreBackup(backupKey: string): { state: FortunaState; timestamp: string } | null {\n  try {\n    const raw = localStorage.getItem(backupKey)\n    if (!raw) return null\n    const parsed = JSON.parse(raw)\n    if (!parsed.state) return null\n    return { state: parsed.state, timestamp: parsed._backupAt || '' }\n  } catch {\n    return null\n  }\n}\n\n/**\n * Try to recover state by walking the backup chain.\n * Returns the newest valid backup, or null if all corrupt.\n */\nexport function recoverFromBackups(): { state: FortunaState; source: string; repairs: string[] } | null {\n  const backups = listBackups()\n  for (const backup of backups) {\n    const restored = restoreBackup(backup.key)\n    if (!restored) continue\n\n    const validation = validateState(restored.state)\n    if (validation.valid) {\n      return {\n        state: restored.state,\n        source: `Backup from ${restored.timestamp}`,\n        repairs: [],\n      }\n    }\n\n    // Try repairing\n    const { state, repairs } = repairState(restored.state)\n    const recheck = validateState(state)\n    if (recheck.valid) {\n      return {\n        state,\n        source: `Repaired backup from ${restored.timestamp}`,\n        repairs,\n      }\n    }\n  }\n\n  return null\n}\n\n// ─── Storage Quota Monitoring ─────────────────────────────────────────────\n\nexport interface StorageQuota {\n  usedBytes: number\n  usedMB: string\n  estimatedLimitMB: number\n  usagePct: number\n  isWarning: boolean\n  isCritical: boolean\n  breakdown: { key: string; sizeKB: number }[]\n}\n\nexport function checkStorageQuota(): StorageQuota {\n  let usedBytes = 0\n  const breakdown: { key: string; sizeKB: number }[] = []\n\n  try {\n    for (let i = 0; i < localStorage.length; i++) {\n      const key = localStorage.key(i)\n      if (!key) continue\n      const val = localStorage.getItem(key)\n      const size = (key.length + (val?.length || 0)) * 2 // UTF-16\n      usedBytes += size\n      if (key.startsWith('fortuna')) {\n        breakdown.push({ key, sizeKB: Math.round(size / 1024) })\n      }\n    }\n  } catch { /* */ }\n\n  breakdown.sort((a, b) => b.sizeKB - a.sizeKB)\n\n  const estimatedLimitMB = 5\n  const usedMBNum = usedBytes / (1024 * 1024)\n\n  return {\n    usedBytes,\n    usedMB: `${usedMBNum.toFixed(2)} MB`,\n    estimatedLimitMB,\n    usagePct: Math.round((usedMBNum / estimatedLimitMB) * 100),\n    isWarning: usedMBNum >= QUOTA_WARN_MB,\n    isCritical: usedMBNum >= estimatedLimitMB * 0.95,\n    breakdown,\n  }\n}\n\n// ─── Corruption Logging ───────────────────────────────────────────────────\n\ninterface CorruptionEvent {\n  timestamp: string\n  error: string\n  source: 'load' | 'save' | 'validate'\n  recovered: boolean\n  method?: string\n}\n\nexport function logCorruption(event: Omit<CorruptionEvent, 'timestamp'>): void {\n  try {\n    const log = JSON.parse(localStorage.getItem(CORRUPTION_LOG_KEY) || '[]') as CorruptionEvent[]\n    log.push({ ...event, timestamp: new Date().toISOString() })\n    // Keep last 20 events\n    localStorage.setItem(CORRUPTION_LOG_KEY, JSON.stringify(log.slice(-20)))\n  } catch { /* */ }\n}\n\nexport function getCorruptionLog(): CorruptionEvent[] {\n  try {\n    return JSON.parse(localStorage.getItem(CORRUPTION_LOG_KEY) || '[]')\n  } catch {\n    return []\n  }\n}\n\n// ─── Emergency Export ─────────────────────────────────────────────────────\n\n/**\n * Emergency: dump all Fortuna-related localStorage to a JSON file.\n * Works even when the app is in an error state.\n */\nexport function emergencyExport(): string {\n  const dump: Record<string, unknown> = {\n    _type: 'fortuna-emergency-export',\n    _exportedAt: new Date().toISOString(),\n    _backups: listBackups().length,\n    _quota: checkStorageQuota(),\n    _corruptionLog: getCorruptionLog(),\n  }\n\n  try {\n    for (let i = 0; i < localStorage.length; i++) {\n      const key = localStorage.key(i)\n      if (!key || !key.startsWith('fortuna')) continue\n      try {\n        dump[key] = JSON.parse(localStorage.getItem(key) || 'null')\n      } catch {\n        dump[key] = localStorage.getItem(key)\n      }\n    }\n  } catch { /* */ }\n\n  return JSON.stringify(dump, null, 2)\n}\n\n/**\n * Trigger a browser download of the emergency export.\n */\nexport function downloadEmergencyExport(): void {\n  const json = emergencyExport()\n  const blob = new Blob([json], { type: 'application/json' })\n  const url = URL.createObjectURL(blob)\n  const a = document.createElement('a')\n  a.href = url\n  a.download = `fortuna-emergency-${new Date().toISOString().slice(0, 10)}.json`\n  a.click()\n  URL.revokeObjectURL(url)\n}\n\n// ─── Safe Save Wrapper ────────────────────────────────────────────────────\n\n/**\n * Safe save: validates state, creates backup, then saves.\n * Returns validation result + backup status.\n */\nexport function safeSaveWithBackup(\n  state: FortunaState,\n  saveFn: (s: FortunaState) => Promise<boolean>,\n): { validation: ValidationResult; backupCreated: boolean; saved: boolean } {\n  const validation = validateState(state)\n\n  if (!validation.valid) {\n    logCorruption({ error: validation.errors.join('; '), source: 'save', recovered: false })\n    // Attempt repair\n    const { state: repaired, repairs } = repairState(state)\n    const recheck = validateState(repaired)\n    if (recheck.valid) {\n      validation.repaired = true\n      validation.warnings.push(`Auto-repaired: ${repairs.join('; ')}`)\n      state = repaired\n    }\n  }\n\n  // Create backup before save\n  const backupCreated = saveBackup(state)\n\n  // Save (fire and forget since this is sync wrapper)\n  let saved = false\n  saveFn(state).then(ok => { saved = ok }).catch(() => { saved = false })\n\n  return { validation, backupCreated, saved: true /* optimistic */ }\n}\n\n// ─── Utility ──────────────────────────────────────────────────────────────\n\nfunction simpleHash(str: string): string {\n  let hash = 0\n  for (let i = 0; i < str.length; i++) {\n    const chr = str.charCodeAt(i)\n    hash = ((hash << 5) - hash) + chr\n    hash |= 0\n  }\n  return hash.toString(36)\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\debt-optimizer.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\deduction-discovery.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'w2Income' is assigned a value but never used.","line":47,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":47,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'hasEntity' is assigned a value but never used.","line":52,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":52,"endColumn":18}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine - Deduction Discovery\n * Proactively identifies unclaimed deductions and credits based on user profile.\n */\n\nimport type { FortunaState } from './storage'\nimport { generateTaxReport } from './tax-calculator'\n\nexport interface DiscoveredDeduction {\n  id: string\n  name: string\n  category: string\n  estimatedAmount: number\n  taxSavings: number\n  confidence: 'high' | 'medium' | 'low'\n  eligibility: string\n  howToClaim: string\n  requirements: string[]\n  applies: boolean\n  alreadyClaimed: boolean\n  deductionSignals?: string[]\n}\n\nexport function discoverDeductions(state: FortunaState): DiscoveredDeduction[] {\n  const { profile, incomeStreams, deductions, entities, expenses, documents } = state\n  const report = generateTaxReport(state)\n  const discoveries: DiscoveredDeduction[] = []\n\n  // Extract all intelligence signals from scanned documents\n  const signalsByCategory: Record<string, string[]> = {}\n\n  if (documents) {\n    documents.forEach(doc => {\n      if (doc.metadata.deductionSignals) {\n        const cat = doc.metadata.expenseCategory || doc.documentType\n        if (cat) {\n          if (!signalsByCategory[cat]) signalsByCategory[cat] = []\n          signalsByCategory[cat].push(...doc.metadata.deductionSignals)\n        }\n      }\n    })\n  }\n\n  const hasSEIncome = incomeStreams.some(s => ['business', 'freelance'].includes(s.type) && s.isActive && s.annualAmount > 0)\n  const seIncome = incomeStreams.filter(s => ['business', 'freelance'].includes(s.type) && s.isActive).reduce((s, i) => s + i.annualAmount, 0)\n  const hasW2 = incomeStreams.some(s => s.type === 'w2' && s.isActive)\n  const w2Income = incomeStreams.filter(s => s.type === 'w2' && s.isActive).reduce((s, i) => s + i.annualAmount, 0)\n  const totalIncome = report.grossIncome\n  const hasRental = incomeStreams.some(s => s.type === 'rental' && s.isActive)\n  const claimedCategories = new Set(deductions.map(d => d.categoryId))\n  const claimedDescriptions = new Set(deductions.map(d => d.description.toLowerCase()))\n  const hasEntity = entities.some(e => e.isActive)\n  const marginalRate = report.marginalRate\n\n  // ─── SE Health Insurance Deduction ─────────────────────────────────\n  if (hasSEIncome && !profile.hasHealthInsurance) {\n    discoveries.push({\n      id: 'se-health-insurance', name: 'Self-Employed Health Insurance Deduction',\n      category: 'health', estimatedAmount: 7200, taxSavings: Math.round(7200 * marginalRate),\n      confidence: 'high',\n      eligibility: 'Self-employed individuals who pay their own health insurance premiums',\n      howToClaim: 'Deduct premiums on Form 1040 Line 17 (above-the-line)',\n      requirements: ['Must have SE net income', 'Cannot be eligible for employer-sponsored plan', 'Premiums ≤ net SE income'],\n      applies: true, alreadyClaimed: claimedDescriptions.has('health insurance') || claimedCategories.has('health'),\n      deductionSignals: signalsByCategory['health']\n    })\n  }\n\n  // ─── Home Office Deduction ─────────────────────────────────────────\n  if (hasSEIncome) {\n    const hasHomeOffice = expenses.some(e => e.description.toLowerCase().includes('home office')) || claimedCategories.has('home_office')\n    const simplified = Math.min(1500, 5 * 300) // $5/sqft up to 300 sqft\n    discoveries.push({\n      id: 'home-office', name: 'Home Office Deduction',\n      category: 'home_office', estimatedAmount: simplified, taxSavings: Math.round(simplified * (marginalRate + 0.153)),\n      confidence: 'medium',\n      eligibility: 'Self-employed individuals who use part of home exclusively for business',\n      howToClaim: 'Simplified method: $5/sqft up to 300 sqft ($1,500). Or actual expenses method (Form 8829).',\n      requirements: ['Exclusive and regular business use', 'Principal place of business', 'Not available for W-2 employees'],\n      applies: hasSEIncome, alreadyClaimed: hasHomeOffice,\n      deductionSignals: signalsByCategory['home_office']\n    })\n  }\n\n  // ─── Vehicle / Mileage Deduction ───────────────────────────────────\n  if (hasSEIncome) {\n    const hasMileage = expenses.some(e => e.description.toLowerCase().includes('vehicle') || e.description.toLowerCase().includes('mileage'))\n    const estMiles = 8000 // conservative estimate\n    const mileageRate = 0.70 // 2025 rate\n    const estDeduction = Math.round(estMiles * mileageRate)\n    discoveries.push({\n      id: 'vehicle-mileage', name: 'Vehicle / Mileage Deduction',\n      category: 'vehicle', estimatedAmount: estDeduction, taxSavings: Math.round(estDeduction * (marginalRate + 0.153)),\n      confidence: 'low',\n      eligibility: 'Self-employed individuals who use vehicle for business',\n      howToClaim: 'Standard mileage rate ($0.70/mile for 2025) or actual expenses. Track mileage log.',\n      requirements: ['Business-use miles documented', 'Mileage log maintained', 'Cannot use both methods for same vehicle'],\n      applies: hasSEIncome, alreadyClaimed: hasMileage,\n      deductionSignals: signalsByCategory['vehicle']\n    })\n  }\n\n  // ─── SEP-IRA / Solo 401(k) ────────────────────────────────────────\n  if (hasSEIncome && seIncome > 10000) {\n    const hasRetirement = claimedCategories.has('retirement')\n    const currentRetirement = deductions.filter(d => d.categoryId === 'retirement').reduce((s, d) => s + d.amount, 0)\n    const maxSEP = Math.min(69000, Math.round(seIncome * 0.25))\n    const gap = Math.max(0, maxSEP - currentRetirement)\n    if (gap > 2000) {\n      discoveries.push({\n        id: 'sep-ira', name: 'SEP-IRA / Solo 401(k) Contribution',\n        category: 'retirement', estimatedAmount: gap, taxSavings: Math.round(gap * marginalRate),\n        confidence: 'high',\n        eligibility: 'Self-employed individuals with net SE income',\n        howToClaim: 'Contribute to SEP-IRA (up to 25% of net SE income, max $69,000) or Solo 401(k) with employee + employer contributions.',\n        requirements: ['Must have net SE income', 'SEP-IRA: contribute by tax filing deadline', 'Solo 401(k): establish by Dec 31'],\n        applies: true, alreadyClaimed: hasRetirement && gap < 2000,\n        deductionSignals: signalsByCategory['retirement']\n      })\n    }\n  }\n\n  // ─── W-2 401(k) Gap ───────────────────────────────────────────────\n  if (hasW2) {\n    const w2Streams = incomeStreams.filter(s => s.type === 'w2' && s.isActive)\n    const total401k = w2Streams.reduce((s, w) => s + (w.w2?.pretax401k || 0), 0)\n    const limit = profile.age >= 50 ? 31000 : 23500\n    const gap = limit - total401k\n    if (gap > 2000) {\n      discoveries.push({\n        id: 'w2-401k-gap', name: `401(k) Contribution Gap`,\n        category: 'retirement', estimatedAmount: gap, taxSavings: Math.round(gap * marginalRate),\n        confidence: 'high',\n        eligibility: `You're contributing $${total401k.toLocaleString()} — limit is $${limit.toLocaleString()}${profile.age >= 50 ? ' (catch-up)' : ''}`,\n        howToClaim: 'Increase 401(k) contribution rate through employer payroll. Reduces taxable income dollar-for-dollar.',\n        requirements: ['Employer offers 401(k) plan', 'Increase contribution through HR/payroll'],\n        applies: true, alreadyClaimed: gap < 1000,\n        deductionSignals: signalsByCategory['retirement']\n      })\n    }\n  }\n\n  // ─── HSA Contribution ──────────────────────────────────────────────\n  {\n    const w2Streams = incomeStreams.filter(s => s.type === 'w2' && s.isActive)\n    const currentHSA = w2Streams.reduce((s, w) => s + (w.w2?.pretaxHSA || 0), 0)\n    const hsaLimit = profile.filingStatus === 'single' || profile.filingStatus === 'married_separate' ? 4300 : 8550\n    const catchUp = profile.age >= 55 ? 1000 : 0\n    const maxHSA = hsaLimit + catchUp\n    const gap = maxHSA - currentHSA\n    if (gap > 500) {\n      discoveries.push({\n        id: 'hsa-gap', name: 'HSA Contribution Gap',\n        category: 'health', estimatedAmount: gap, taxSavings: Math.round(gap * (marginalRate + 0.0765)),\n        confidence: 'medium',\n        eligibility: `HSA limit: $${maxHSA.toLocaleString()} — current: $${currentHSA.toLocaleString()}. Triple tax advantage.`,\n        howToClaim: 'Contribute through payroll (avoids FICA) or directly to HSA account (deduct on 1040).',\n        requirements: ['Enrolled in high-deductible health plan (HDHP)', 'Not enrolled in Medicare', 'Cannot be claimed as dependent'],\n        applies: profile.hasHealthInsurance, alreadyClaimed: gap < 500,\n        deductionSignals: signalsByCategory['health']\n      })\n    }\n  }\n\n  // ─── QBI Deduction ────────────────────────────────────────────────\n  if (hasSEIncome && report.qbiDeduction === 0 && seIncome > 5000) {\n    const potential = Math.round(seIncome * 0.20)\n    discoveries.push({\n      id: 'qbi', name: 'Qualified Business Income Deduction (199A)',\n      category: 'business', estimatedAmount: potential, taxSavings: Math.round(potential * marginalRate),\n      confidence: 'medium',\n      eligibility: 'Pass-through business owners may deduct up to 20% of qualified business income',\n      howToClaim: 'Claimed automatically on Form 8995. Ensure business income qualifies.',\n      requirements: ['Pass-through entity or sole prop', 'Below income thresholds or in qualified trade', 'Not specified service business above threshold'],\n      applies: true, alreadyClaimed: report.qbiDeduction > 0,\n      deductionSignals: signalsByCategory['business']\n    })\n  }\n\n  // ─── Child Tax Credit ─────────────────────────────────────────────\n  if (profile.dependents > 0) {\n    const ctcAmount = profile.dependents * 2000\n    const hasCTC = claimedNames.has('child tax credit') || claimedNames.has('ctc')\n    discoveries.push({\n      id: 'child-tax-credit', name: 'Child Tax Credit',\n      category: 'other', estimatedAmount: ctcAmount, taxSavings: ctcAmount, // direct credit\n      confidence: 'high',\n      eligibility: `${profile.dependents} dependent${profile.dependents > 1 ? 's' : ''} × $2,000 = $${ctcAmount.toLocaleString()} credit`,\n      howToClaim: 'Claimed on Form 1040. Partially refundable. Phase-out begins at $200k single / $400k joint.',\n      requirements: ['Qualifying child under 17', 'SSN for child', 'Income below phase-out threshold'],\n      applies: true, alreadyClaimed: hasCTC,\n    })\n  }\n\n  // ─── Earned Income Tax Credit ──────────────────────────────────────\n  if (totalIncome < 63398 && profile.filingStatus !== 'married_separate') {\n    const eitcMax = profile.dependents >= 3 ? 7830 : profile.dependents === 2 ? 6960 : profile.dependents === 1 ? 3995 : 632\n    discoveries.push({\n      id: 'eitc', name: 'Earned Income Tax Credit',\n      category: 'other', estimatedAmount: eitcMax, taxSavings: eitcMax,\n      confidence: totalIncome < 50000 ? 'medium' : 'low',\n      eligibility: `Income $${totalIncome.toLocaleString()} may qualify. Max EITC: $${eitcMax.toLocaleString()} with ${profile.dependents} dependent(s).`,\n      howToClaim: 'Claimed on Form 1040 Schedule EIC. Fully refundable credit.',\n      requirements: ['Earned income required', 'Investment income < $11,600', 'Valid SSN', 'Filing status not MFS'],\n      applies: true, alreadyClaimed: false,\n    })\n  }\n\n  // ─── Student Loan Interest ─────────────────────────────────────────\n  if (totalIncome < 90000 || (profile.filingStatus === 'married_joint' && totalIncome < 185000)) {\n    const hasStudentLoan = claimedDescriptions.has('student loan interest') || claimedDescriptions.has('student loan')\n    if (!hasStudentLoan) {\n      discoveries.push({\n        id: 'student-loan', name: 'Student Loan Interest Deduction',\n        category: 'education', estimatedAmount: 2500, taxSavings: Math.round(2500 * marginalRate),\n        confidence: 'low',\n        eligibility: 'Deduct up to $2,500 in student loan interest paid (above-the-line)',\n        howToClaim: 'Report on Form 1040 Schedule 1 Line 21. Lender sends 1098-E.',\n        requirements: ['Legally obligated to pay interest', 'Loan for qualified education expenses', 'Income below phase-out'],\n        applies: true, alreadyClaimed: hasStudentLoan,\n        deductionSignals: signalsByCategory['education']\n      })\n    }\n  }\n\n  // ─── Charitable Contributions ──────────────────────────────────────\n  {\n    const hasCharitable = claimedCategories.has('charitable')\n    if (!hasCharitable && totalIncome > 40000) {\n      const estCharitable = Math.round(totalIncome * 0.03) // conservative 3%\n      discoveries.push({\n        id: 'charitable', name: 'Charitable Contribution Deduction',\n        category: 'charitable', estimatedAmount: estCharitable, taxSavings: Math.round(estCharitable * marginalRate),\n        confidence: 'low',\n        eligibility: 'Itemize charitable donations if total itemized deductions exceed standard deduction',\n        howToClaim: 'Schedule A (itemized deductions). Cash donations: up to 60% of AGI. Non-cash: up to 30%.',\n        requirements: ['Donations to qualified 501(c)(3) organizations', 'Written acknowledgment for donations > $250', 'Non-cash items at fair market value'],\n        applies: true, alreadyClaimed: hasCharitable,\n        deductionSignals: signalsByCategory['charitable']\n      })\n    }\n  }\n\n  // ─── SE Tax Deduction (half of SE tax) ─────────────────────────────\n  if (hasSEIncome && report.seDeduction > 0) {\n    discoveries.push({\n      id: 'se-tax-deduction', name: 'Self-Employment Tax Deduction',\n      category: 'business', estimatedAmount: report.seDeduction, taxSavings: Math.round(report.seDeduction * marginalRate),\n      confidence: 'high',\n      eligibility: 'Automatically deduct 50% of SE tax from income (above-the-line)',\n      howToClaim: 'Calculated on Schedule SE, deducted on Form 1040 Schedule 1.',\n      requirements: ['Must have SE income', 'Automatically calculated'],\n      applies: true, alreadyClaimed: true, // always auto-claimed\n    })\n  }\n\n  // ─── Depreciation (for rental / business assets) ───────────────────\n  if (hasRental || hasSEIncome) {\n    const hasDepreciation = expenses.some(e => e.description.toLowerCase().includes('depreci'))\n    if (!hasDepreciation) {\n      discoveries.push({\n        id: 'depreciation', name: 'Section 179 / Bonus Depreciation',\n        category: 'business', estimatedAmount: 5000, taxSavings: Math.round(5000 * (marginalRate + (hasSEIncome ? 0.153 : 0))),\n        confidence: 'low',\n        eligibility: 'Deduct cost of business equipment, vehicles, and assets in the year purchased',\n        howToClaim: 'Section 179: up to $1,220,000 (2025). Bonus depreciation: 40% in 2025 (phasing down).',\n        requirements: ['Asset used > 50% for business', 'Placed in service during tax year', 'Must have business income for Sec 179'],\n        applies: true, alreadyClaimed: hasDepreciation,\n        deductionSignals: signalsByCategory['business']\n      })\n    }\n  }\n\n  // Sort: unclaimed first, then by tax savings\n  return discoveries.sort((a, b) => {\n    if (a.alreadyClaimed !== b.alreadyClaimed) return a.alreadyClaimed ? 1 : -1\n    return b.taxSavings - a.taxSavings\n  })\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\defi-tracker.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":448,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":448,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18476,18479],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18476,18479],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE — DeFi Protocol Tracker v1\n * \n * Unique competitive advantage — no tax tool tracks DeFi deeply:\n *   - Liquidity pool position tracking (Uniswap, Curve, Balancer, etc.)\n *   - Impermanent loss calculation + tax treatment\n *   - Yield farming reward tracking (compounding, harvested, pending)\n *   - Governance token tracking (proposals, delegations)\n *   - Staking position monitoring (single-asset + LP staking)\n *   - Protocol fee earnings tracking\n *   - Bridge/chain tracking (cross-chain positions)\n *   - Tax event generation for each DeFi action\n */\n\n// ─── Types ──────────────────────────────────────────────────────────────────\n\nexport interface LPPosition {\n  id: string\n  protocol: DeFiProtocol\n  chain: Chain\n  poolName: string             // \"ETH/USDC 0.3%\"\n  tokenA: { symbol: string; amount: number; entryPrice: number }\n  tokenB: { symbol: string; amount: number; entryPrice: number }\n  lpTokens: number\n  entryDate: string\n  entryValueUSD: number\n  currentValueUSD?: number\n  feesEarned: number           // trading fees earned\n  rewardsEarned: number        // farming rewards (tokens)\n  rewardTokenSymbol?: string\n  impermanentLoss?: number     // in USD\n  status: 'active' | 'withdrawn' | 'migrated'\n  entityId?: string            // Entity that holds this position\n  withdrawDate?: string\n  withdrawValueUSD?: number\n  notes: string\n  entityId?: string            // Entity this position belongs to\n}\n\nexport interface StakingPosition {\n  id: string\n  protocol: DeFiProtocol\n  chain: Chain\n  tokenSymbol: string\n  amountStaked: number\n  stakedDate: string\n  stakingType: 'single_asset' | 'lp_token' | 'validator' | 'liquid_staking'\n  apy: number\n  rewardsEarned: number\n  rewardTokenSymbol: string\n  autoCompound: boolean\n  lockPeriod?: number          // days\n  unlockDate?: string\n  currentValueUSD?: number\n  status: 'active' | 'unstaking' | 'withdrawn'\n  notes: string\n  entityId?: string            // Entity this position belongs to\n}\n\nexport interface YieldFarmPosition {\n  id: string\n  protocol: DeFiProtocol\n  chain: Chain\n  farmName: string\n  depositedToken: string\n  depositedAmount: number\n  depositDate: string\n  depositValueUSD: number\n  harvestedRewards: HarvestEvent[]\n  pendingRewards: number\n  pendingRewardToken: string\n  apy: number\n  currentValueUSD?: number\n  status: 'active' | 'withdrawn'\n  notes: string\n}\n\nexport interface HarvestEvent {\n  date: string\n  rewardToken: string\n  amount: number\n  valueUSD: number             // FMV at harvest\n  claimedOrCompounded: 'claimed' | 'compounded'\n}\n\nexport interface BridgeTransaction {\n  id: string\n  fromChain: Chain\n  toChain: Chain\n  token: string\n  amount: number\n  bridgeProtocol: string       // \"Wormhole\", \"LayerZero\", \"Arbitrum Bridge\"\n  date: string\n  fee: number\n  valueUSD: number\n  status: 'completed' | 'pending' | 'failed'\n}\n\nexport type DeFiProtocol =\n  | 'uniswap_v2' | 'uniswap_v3' | 'sushiswap' | 'curve' | 'balancer'\n  | 'aave_v3' | 'compound_v3' | 'maker' | 'lido' | 'rocket_pool'\n  | 'convex' | 'yearn' | 'pendle' | 'gmx' | 'dydx'\n  | 'pancakeswap' | 'raydium' | 'orca' | 'jupiter'\n  | 'helium' | 'render' | 'akash' | 'custom'\n\nexport type Chain =\n  | 'ethereum' | 'polygon' | 'arbitrum' | 'optimism' | 'base'\n  | 'solana' | 'avalanche' | 'bsc' | 'fantom' | 'other'\n\n// ─── Protocol Metadata ──────────────────────────────────────────────────────\n\nexport const PROTOCOL_INFO: Record<DeFiProtocol, { name: string; icon: string; chains: Chain[]; type: string }> = {\n  uniswap_v2:   { name: 'Uniswap V2',    icon: '🦄', chains: ['ethereum', 'polygon', 'arbitrum', 'optimism', 'base'], type: 'DEX' },\n  uniswap_v3:   { name: 'Uniswap V3',    icon: '🦄', chains: ['ethereum', 'polygon', 'arbitrum', 'optimism', 'base'], type: 'DEX' },\n  sushiswap:    { name: 'SushiSwap',      icon: '🍣', chains: ['ethereum', 'polygon', 'arbitrum'], type: 'DEX' },\n  curve:        { name: 'Curve Finance',   icon: '🔵', chains: ['ethereum', 'polygon', 'arbitrum', 'optimism'], type: 'DEX' },\n  balancer:     { name: 'Balancer',        icon: '⚖️', chains: ['ethereum', 'polygon', 'arbitrum', 'optimism', 'base'], type: 'DEX' },\n  aave_v3:      { name: 'Aave V3',        icon: '👻', chains: ['ethereum', 'polygon', 'arbitrum', 'optimism', 'avalanche', 'base'], type: 'Lending' },\n  compound_v3:  { name: 'Compound V3',    icon: '🏛️', chains: ['ethereum', 'polygon', 'arbitrum', 'base'], type: 'Lending' },\n  maker:        { name: 'MakerDAO',        icon: '🏗️', chains: ['ethereum'], type: 'Lending' },\n  lido:         { name: 'Lido',            icon: '🌊', chains: ['ethereum', 'polygon', 'solana'], type: 'Liquid Staking' },\n  rocket_pool:  { name: 'Rocket Pool',     icon: '🚀', chains: ['ethereum'], type: 'Liquid Staking' },\n  convex:       { name: 'Convex Finance',  icon: '🔺', chains: ['ethereum'], type: 'Yield' },\n  yearn:        { name: 'Yearn Finance',   icon: '🔵', chains: ['ethereum'], type: 'Yield' },\n  pendle:       { name: 'Pendle',          icon: '⏳', chains: ['ethereum', 'arbitrum'], type: 'Yield' },\n  gmx:          { name: 'GMX',             icon: '📊', chains: ['arbitrum', 'avalanche'], type: 'Perps DEX' },\n  dydx:         { name: 'dYdX',            icon: '📈', chains: ['ethereum'], type: 'Perps DEX' },\n  pancakeswap:  { name: 'PancakeSwap',     icon: '🥞', chains: ['bsc', 'ethereum', 'arbitrum', 'base'], type: 'DEX' },\n  raydium:      { name: 'Raydium',         icon: '☀️', chains: ['solana'], type: 'DEX' },\n  orca:         { name: 'Orca',            icon: '🐋', chains: ['solana'], type: 'DEX' },\n  jupiter:      { name: 'Jupiter',         icon: '🪐', chains: ['solana'], type: 'DEX Aggregator' },\n  helium:       { name: 'Helium',          icon: '📡', chains: ['solana'], type: 'DePIN' },\n  render:       { name: 'Render Network',  icon: '🖼️', chains: ['solana', 'ethereum'], type: 'DePIN' },\n  akash:        { name: 'Akash Network',   icon: '☁️', chains: ['other'], type: 'DePIN' },\n  custom:       { name: 'Custom Protocol', icon: '⚙️', chains: ['ethereum', 'solana', 'polygon', 'arbitrum', 'optimism', 'base', 'bsc', 'avalanche', 'fantom', 'other'], type: 'Custom' },\n}\n\n// ─── Impermanent Loss Calculator ────────────────────────────────────────────\n\nexport function calculateImpermanentLoss(\n  entryPriceA: number,\n  entryPriceB: number,\n  currentPriceA: number,\n  currentPriceB: number,\n  entryValueUSD: number,\n): {\n  impermanentLoss: number        // in USD\n  impermanentLossPercent: number // as percentage\n  holdValue: number              // if you just held the tokens\n  lpValue: number                // current LP value\n  feesNeeded: number             // fees needed to offset IL\n} {\n  // Price ratio change\n  const ratioA = currentPriceA / entryPriceA\n  const ratioB = currentPriceB / entryPriceB\n\n  // For constant product AMM (x*y=k):\n  // IL = 2*sqrt(priceRatio) / (1+priceRatio) - 1\n  // Where priceRatio = relative change of token A vs token B\n  const priceRatio = ratioA / ratioB\n  const ilPercent = (2 * Math.sqrt(priceRatio)) / (1 + priceRatio) - 1\n\n  // Hold value (what tokens would be worth if you just held them)\n  const halfEntry = entryValueUSD / 2\n  const holdValueA = halfEntry * ratioA\n  const holdValueB = halfEntry * ratioB\n  const holdValue = holdValueA + holdValueB\n\n  // LP value accounting for IL\n  const lpValue = holdValue * (1 + ilPercent)\n  const impermanentLoss = holdValue - lpValue\n\n  return {\n    impermanentLoss: Math.round(impermanentLoss * 100) / 100,\n    impermanentLossPercent: Math.round(ilPercent * 10000) / 100,\n    holdValue: Math.round(holdValue * 100) / 100,\n    lpValue: Math.round(lpValue * 100) / 100,\n    feesNeeded: Math.round(impermanentLoss * 100) / 100,\n  }\n}\n\n// ─── Tax Event Generation ───────────────────────────────────────────────────\n\nexport interface DeFiTaxEvent {\n  date: string\n  type: 'lp_entry' | 'lp_exit' | 'harvest' | 'stake' | 'unstake' | 'bridge' | 'swap' | 'airdrop' | 'lending_interest'\n  description: string\n  protocol: string\n  chain: Chain\n  taxTreatment: 'ordinary_income' | 'short_term_cg' | 'long_term_cg' | 'not_taxable' | 'cost_basis_only'\n  amount: number               // in USD\n  costBasis?: number\n  gainLoss?: number\n  tokens: { symbol: string; amount: number; priceUSD: number }[]\n  notes: string\n  irsGuidance: string\n}\n\nexport function generateLPTaxEvents(position: LPPosition): DeFiTaxEvent[] {\n  const events: DeFiTaxEvent[] = []\n\n  // Entry: potential taxable event if adding tokens to pool\n  // IRS has not definitively ruled, but most conservative: treat as disposal\n  events.push({\n    date: position.entryDate,\n    type: 'lp_entry',\n    description: `Added liquidity to ${position.poolName} on ${PROTOCOL_INFO[position.protocol].name}`,\n    protocol: PROTOCOL_INFO[position.protocol].name,\n    chain: position.chain,\n    taxTreatment: 'cost_basis_only', // conservative: not taxable until exit\n    amount: position.entryValueUSD,\n    costBasis: position.entryValueUSD,\n    tokens: [\n      { symbol: position.tokenA.symbol, amount: position.tokenA.amount, priceUSD: position.tokenA.entryPrice },\n      { symbol: position.tokenB.symbol, amount: position.tokenB.amount, priceUSD: position.tokenB.entryPrice },\n    ],\n    notes: 'LP entry. IRS treatment unclear — tracking cost basis conservatively.',\n    irsGuidance: 'No specific guidance. Rev. Rul. 2023-14 covers staking but not LP. Conservative approach: track cost basis, recognize on exit.',\n  })\n\n  // Fees earned: likely ordinary income as earned\n  if (position.feesEarned > 0) {\n    events.push({\n      date: position.withdrawDate || new Date().toISOString().split('T')[0],\n      type: 'harvest',\n      description: `Trading fees earned from ${position.poolName}`,\n      protocol: PROTOCOL_INFO[position.protocol].name,\n      chain: position.chain,\n      taxTreatment: 'ordinary_income',\n      amount: position.feesEarned,\n      tokens: [],\n      notes: 'LP trading fees — likely ordinary income per general tax principles.',\n      irsGuidance: 'IRC §61 (gross income); analogous to interest income.',\n    })\n  }\n\n  // Farming rewards\n  if (position.rewardsEarned > 0) {\n    events.push({\n      date: position.withdrawDate || new Date().toISOString().split('T')[0],\n      type: 'harvest',\n      description: `Farming rewards: ${position.rewardsEarned} ${position.rewardTokenSymbol || 'tokens'}`,\n      protocol: PROTOCOL_INFO[position.protocol].name,\n      chain: position.chain,\n      taxTreatment: 'ordinary_income',\n      amount: position.rewardsEarned, // should be FMV at receipt\n      tokens: position.rewardTokenSymbol\n        ? [{ symbol: position.rewardTokenSymbol, amount: position.rewardsEarned, priceUSD: 0 }]\n        : [],\n      notes: 'Farming rewards are ordinary income at FMV when dominion and control obtained.',\n      irsGuidance: 'Rev. Rul. 2023-14 (staking rewards = income when received); extends to farming by analogy.',\n    })\n  }\n\n  // Exit\n  if (position.status === 'withdrawn' && position.withdrawValueUSD !== undefined) {\n    const gainLoss = position.withdrawValueUSD - position.entryValueUSD\n    const holdingDays = daysBetween(position.entryDate, position.withdrawDate || '')\n\n    events.push({\n      date: position.withdrawDate!,\n      type: 'lp_exit',\n      description: `Removed liquidity from ${position.poolName}`,\n      protocol: PROTOCOL_INFO[position.protocol].name,\n      chain: position.chain,\n      taxTreatment: holdingDays > 365 ? 'long_term_cg' : 'short_term_cg',\n      amount: position.withdrawValueUSD,\n      costBasis: position.entryValueUSD,\n      gainLoss,\n      tokens: [],\n      notes: `${holdingDays > 365 ? 'Long-term' : 'Short-term'} gain/loss of $${gainLoss.toFixed(2)}. Impermanent loss reflected in exit value.`,\n      irsGuidance: 'Treat LP exit as disposal of LP tokens. Gain/loss = exit value - cost basis.',\n    })\n  }\n\n  return events\n}\n\nexport function generateStakingTaxEvents(position: StakingPosition): DeFiTaxEvent[] {\n  const events: DeFiTaxEvent[] = []\n\n  if (position.rewardsEarned > 0) {\n    events.push({\n      date: new Date().toISOString().split('T')[0],\n      type: 'harvest',\n      description: `Staking rewards: ${position.rewardsEarned} ${position.rewardTokenSymbol}`,\n      protocol: PROTOCOL_INFO[position.protocol].name,\n      chain: position.chain,\n      taxTreatment: 'ordinary_income',\n      amount: position.rewardsEarned, // should be multiplied by FMV\n      tokens: [{ symbol: position.rewardTokenSymbol, amount: position.rewardsEarned, priceUSD: 0 }],\n      notes: 'Staking rewards are ordinary income at FMV when received. New cost basis = FMV at receipt.',\n      irsGuidance: 'Rev. Rul. 2023-14: Staking rewards are includible in gross income when taxpayer gains dominion and control.',\n    })\n  }\n\n  return events\n}\n\n// ─── Portfolio Summary ──────────────────────────────────────────────────────\n\nexport interface DeFiPortfolioSummary {\n  totalValueUSD: number\n  totalCostBasis: number\n  unrealizedGL: number\n  totalFeesEarned: number\n  totalRewardsEarned: number\n  totalImpermanentLoss: number\n  lpPositions: number\n  stakingPositions: number\n  farmPositions: number\n  chains: Chain[]\n  protocols: DeFiProtocol[]\n  taxEventsGenerated: number\n  estimatedTaxLiability: number\n}\n\nexport function summarizeDeFiPortfolio(\n  lps: LPPosition[],\n  stakes: StakingPosition[],\n  farms: YieldFarmPosition[],\n  marginalRate: number = 0.32,\n): DeFiPortfolioSummary {\n  const activeLPs = lps.filter(l => l.status === 'active')\n  const activeStakes = stakes.filter(s => s.status === 'active')\n  const activeFarms = farms.filter(f => f.status === 'active')\n\n  const totalValue = activeLPs.reduce((s, l) => s + (l.currentValueUSD || l.entryValueUSD), 0) +\n    activeStakes.reduce((s, st) => s + (st.currentValueUSD || st.amountStaked), 0) +\n    activeFarms.reduce((s, f) => s + (f.currentValueUSD || f.depositValueUSD), 0)\n\n  const totalCostBasis = lps.reduce((s, l) => s + l.entryValueUSD, 0) +\n    farms.reduce((s, f) => s + f.depositValueUSD, 0)\n\n  const totalFees = lps.reduce((s, l) => s + l.feesEarned, 0)\n  const totalRewards = lps.reduce((s, l) => s + l.rewardsEarned, 0) +\n    stakes.reduce((s, st) => s + st.rewardsEarned, 0) +\n    farms.reduce((s, f) => s + f.harvestedRewards.reduce((rs, h) => rs + h.valueUSD, 0), 0)\n\n  const totalIL = activeLPs.reduce((s, l) => s + (l.impermanentLoss || 0), 0)\n\n  const allChains = [...new Set([...lps.map(l => l.chain), ...stakes.map(s => s.chain), ...farms.map(f => f.chain)])]\n  const allProtocols = [...new Set([...lps.map(l => l.protocol), ...stakes.map(s => s.protocol), ...farms.map(f => f.protocol)])]\n\n  // Generate tax events count\n  let taxEventCount = 0\n  for (const lp of lps) taxEventCount += generateLPTaxEvents(lp).length\n  for (const st of stakes) taxEventCount += generateStakingTaxEvents(st).length\n\n  const estimatedTax = (totalFees + totalRewards) * marginalRate\n\n  return {\n    totalValueUSD: Math.round(totalValue),\n    totalCostBasis: Math.round(totalCostBasis),\n    unrealizedGL: Math.round(totalValue - totalCostBasis),\n    totalFeesEarned: Math.round(totalFees),\n    totalRewardsEarned: Math.round(totalRewards),\n    totalImpermanentLoss: Math.round(totalIL),\n    lpPositions: activeLPs.length,\n    stakingPositions: activeStakes.length,\n    farmPositions: activeFarms.length,\n    chains: allChains,\n    protocols: allProtocols,\n    taxEventsGenerated: taxEventCount,\n    estimatedTaxLiability: Math.round(estimatedTax),\n  }\n}\n\n// ─── Helpers ────────────────────────────────────────────────────────────────\n\nfunction daysBetween(start: string, end: string): number {\n  const d1 = new Date(start)\n  const d2 = new Date(end)\n  return Math.abs(Math.ceil((d2.getTime() - d1.getTime()) / (1000 * 60 * 60 * 24)))\n}\n\n// ─── Phase H: Entity Awareness ──────────────────────────────────────────────\n\nexport interface DeFiTaxEventWithEntity extends DeFiTaxEvent {\n  entityId?: string\n}\n\n/** Tag DeFi tax events with entity ownership */\nexport function tagEventsWithEntity(\n  events: DeFiTaxEvent[],\n  defaultEntityId: string = 'personal',\n): DeFiTaxEventWithEntity[] {\n  return events.map(e => ({ ...e, entityId: defaultEntityId }))\n}\n\n/** Filter DeFi positions and events by entity */\nexport function filterDeFiByEntity<T extends { entityId?: string }>(items: T[], entityId: string): T[] {\n  return items.filter(i => (i.entityId || 'personal') === entityId)\n}\n\n// ─── Phase G: DeFi → Cost Basis Bridge ──────────────────────────────────────\n\nimport type { TaxLot, DisposalRecord } from './cost-basis'\n\n/** Convert DeFi tax events into cost-basis TaxLots and DisposalRecords */\nexport function defiEventsToCostBasis(events: (DeFiTaxEvent | DeFiTaxEventWithEntity)[]): {\n  lots: Omit<TaxLot, 'id'>[]\n  disposals: Omit<DisposalRecord, 'id' | 'lotId'>[]\n} {\n  const lots: Omit<TaxLot, 'id'>[] = []\n  const disposals: Omit<DisposalRecord, 'id' | 'lotId'>[] = []\n\n  for (const event of events) {\n    if (event.taxTreatment === 'not_taxable') continue\n    const entityId = 'entityId' in event ? event.entityId : undefined\n\n    // Entries create tax lots\n    if (['lp_entry', 'stake', 'bridge'].includes(event.type) || event.taxTreatment === 'cost_basis_only') {\n      for (const token of event.tokens) {\n        lots.push({\n          ticker: token.symbol,\n          quantity: token.amount,\n          costPerUnit: token.priceUSD,\n          totalCost: token.amount * token.priceUSD,\n          acquiredDate: event.date,\n          source: `${event.protocol} (${event.chain})`,\n          remainingQty: token.amount,\n          isWashSaleDisallowed: false,\n          disallowedAmount: 0,\n          entityId,\n        })\n      }\n    }\n\n    // Exits create disposals\n    if (['lp_exit', 'unstake', 'swap'].includes(event.type) && event.gainLoss !== undefined) {\n      for (const token of event.tokens) {\n        const proceeds = token.amount * token.priceUSD\n        const basis = event.costBasis || 0\n        const holdingDays = 365\n        disposals.push({\n          ticker: token.symbol,\n          quantity: token.amount,\n          proceedsPerUnit: token.priceUSD,\n          totalProceeds: proceeds,\n          disposalDate: event.date,\n          costBasis: basis / Math.max(event.tokens.length, 1),\n          gainLoss: event.gainLoss! / Math.max(event.tokens.length, 1),\n          holdingPeriod: holdingDays > 365 ? 'long' : 'short',\n          isWashSale: false,\n          washSaleDisallowed: 0,\n          adjustedGainLoss: event.gainLoss! / Math.max(event.tokens.length, 1),\n          form8949Box: holdingDays > 365 ? 'D' : 'A' as any,\n          entityId,\n        })\n      }\n    }\n\n    // Ordinary income events (staking rewards, airdrops, interest)\n    if (['harvest', 'airdrop', 'lending_interest'].includes(event.type) && event.taxTreatment === 'ordinary_income') {\n      for (const token of event.tokens) {\n        lots.push({\n          ticker: token.symbol,\n          quantity: token.amount,\n          costPerUnit: token.priceUSD,\n          totalCost: token.amount * token.priceUSD,\n          acquiredDate: event.date,\n          source: `${event.protocol} ${event.type} (${event.chain})`,\n          remainingQty: token.amount,\n          isWashSaleDisallowed: false,\n          disallowedAmount: 0,\n          entityId,\n        })\n      }\n    }\n  }\n\n  return { lots, disposals }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\depreciation-engine.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'depreciableBasis' is never reassigned. Use 'const' instead.","line":180,"column":7,"nodeType":"Identifier","messageId":"useConst","endLine":180,"endColumn":23,"fix":{"range":[6197,6254],"text":"const depreciableBasis = businessBasis - asset.salvageValue"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'currentYear' is assigned a value but never used.","line":184,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":184,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'marginalRate' is defined but never used.","line":276,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":276,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'marginalRate' is defined but never used.","line":333,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":333,"endColumn":15}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — Depreciation & Asset Strategy v9\n *\n * Complete business asset depreciation modeling:\n *  - Section 179 immediate expensing with phase-out\n *  - Bonus Depreciation (80% for 2024, phasing down)\n *  - MACRS standard depreciation schedules (3/5/7/15/27.5/39 yr)\n *  - Vehicle deduction optimizer (standard mileage vs actual)\n *  - Home office depreciation\n *  - Year-by-year depreciation schedule with tax impact\n *  - Asset purchase timing optimization\n */\n\nimport type { FortunaState } from './storage'\nimport { generateTaxReport } from './tax-calculator'\n\n// ===================================================================\n//  2024-2026 DEPRECIATION CONSTANTS\n// ===================================================================\n\nconst SECTION_179_LIMIT_2024 = 1220000\nconst SECTION_179_PHASEOUT_START = 3050000\nconst BONUS_DEPRECIATION_RATES: Record<number, number> = {\n  2024: 0.60,  // 60% bonus depreciation\n  2025: 0.40,  // 40%\n  2026: 0.20,  // 20%\n  2027: 0.00,  // fully phased out\n}\n\n// Vehicle limits (first-year, luxury auto limits)\nconst VEHICLE_LIMITS_2024 = {\n  firstYear_withBonus: 20400,\n  firstYear_noBonus: 12400,\n  secondYear: 19800,\n  thirdYear: 11900,\n  subsequent: 7160,\n  suvOver6000: 28900, // SUV Section 179 limit\n}\n\nconst STANDARD_MILEAGE_RATE_2024 = 0.67 // 67 cents per mile\n\n// MACRS recovery periods and depreciation percentages\nconst MACRS_TABLES: Record<number, number[]> = {\n  3: [0.3333, 0.4445, 0.1481, 0.0741],\n  5: [0.2000, 0.3200, 0.1920, 0.1152, 0.1152, 0.0576],\n  7: [0.1429, 0.2449, 0.1749, 0.1249, 0.0893, 0.0892, 0.0893, 0.0446],\n  15: [0.0500, 0.0950, 0.0855, 0.0770, 0.0693, 0.0623, 0.0590, 0.0590, 0.0591, 0.0590, 0.0591, 0.0590, 0.0591, 0.0590, 0.0591, 0.0295],\n}\n\n// Common asset classes and their MACRS life\nconst ASSET_CLASSES: AssetClass[] = [\n  { id: 'computer', name: 'Computers & Peripherals', macrsLife: 5, section179: true, examples: 'Laptops, desktops, servers, monitors' },\n  { id: 'software', name: 'Off-the-Shelf Software', macrsLife: 3, section179: true, examples: 'Commercial software licenses' },\n  { id: 'furniture', name: 'Office Furniture', macrsLife: 7, section179: true, examples: 'Desks, chairs, shelving, filing cabinets' },\n  { id: 'equipment', name: 'Business Equipment', macrsLife: 7, section179: true, examples: 'Printers, manufacturing equipment, tools' },\n  { id: 'vehicle_light', name: 'Vehicle (under 6,000 lbs)', macrsLife: 5, section179: true, examples: 'Cars, small trucks, sedans' },\n  { id: 'vehicle_heavy', name: 'Vehicle/SUV (over 6,000 lbs)', macrsLife: 5, section179: true, examples: 'Heavy SUVs, trucks, vans' },\n  { id: 'land_improvement', name: 'Land Improvements', macrsLife: 15, section179: false, examples: 'Parking lots, fencing, landscaping' },\n  { id: 'residential_rental', name: 'Residential Rental Property', macrsLife: 27, section179: false, examples: 'Rental buildings (residential)' },\n  { id: 'commercial', name: 'Commercial Property', macrsLife: 39, section179: false, examples: 'Office buildings, warehouses' },\n  { id: 'phone', name: 'Phones & Tablets', macrsLife: 5, section179: true, examples: 'Smartphones, iPads, mobile devices' },\n]\n\n// ===================================================================\n//  TYPES\n// ===================================================================\n\nexport interface AssetClass {\n  id: string\n  name: string\n  macrsLife: number\n  section179: boolean\n  examples: string\n}\n\nexport interface BusinessAsset {\n  id: string\n  name: string\n  classId: string\n  purchaseDate: string\n  cost: number\n  businessUsePercent: number // 0-100\n  section179Elected: boolean\n  bonusDepreciation: boolean\n  salvageValue: number\n  entityId?: string          // Entity this asset belongs to\n}\n\nexport interface DepreciationScheduleYear {\n  year: number\n  section179: number\n  bonusDepreciation: number\n  macrsDepreciation: number\n  totalDepreciation: number\n  remainingBasis: number\n  taxSavings: number\n}\n\nexport interface AssetDepreciationResult {\n  asset: BusinessAsset\n  assetClass: AssetClass\n  depreciableBasis: number\n  schedule: DepreciationScheduleYear[]\n  totalDeductions: number\n  firstYearDeduction: number\n  taxSavingsFirstYear: number\n  taxSavingsTotal: number\n  method: string\n}\n\nexport interface VehicleDeductionAnalysis {\n  standardMileage: {\n    annualDeduction: number\n    effective: boolean\n    calculation: string\n  }\n  actualExpense: {\n    annualDeduction: number\n    effective: boolean\n    calculation: string\n    depreciationComponent: number\n    operatingComponent: number\n  }\n  recommendation: 'standard_mileage' | 'actual_expense'\n  difference: number\n  notes: string[]\n}\n\nexport interface HomeOfficeDeduction {\n  simplified: {\n    deduction: number\n    calculation: string\n  }\n  regular: {\n    deduction: number\n    directExpenses: number\n    indirectExpenses: number\n    depreciation: number\n    calculation: string\n  }\n  recommendation: 'simplified' | 'regular'\n  difference: number\n}\n\nexport interface DepreciationSummary {\n  totalAssets: number\n  totalCost: number\n  totalDepreciatedToDate: number\n  remainingBasis: number\n  currentYearDeduction: number\n  section179Used: number\n  section179Remaining: number\n  bonusDepreciationRate: number\n  assetResults: AssetDepreciationResult[]\n  vehicleAnalysis: VehicleDeductionAnalysis | null\n  homeOffice: HomeOfficeDeduction | null\n  purchaseTimingInsights: PurchaseTimingInsight[]\n  totalTaxSavingsThisYear: number\n  entityBreakdown?: { entityId: string; assetCount: number; totalCost: number; currentYearDeduction: number; section179Used: number }[]\n}\n\nexport interface PurchaseTimingInsight {\n  type: 'opportunity' | 'warning' | 'info'\n  title: string\n  detail: string\n  impact?: number\n}\n\n// ===================================================================\n//  DEPRECIATION CALCULATOR\n// ===================================================================\n\nfunction calculateAssetDepreciation(\n  asset: BusinessAsset,\n  marginalRate: number,\n  section179Used: number,\n): AssetDepreciationResult {\n  const assetClass = ASSET_CLASSES.find(c => c.id === asset.classId) || ASSET_CLASSES[4]\n  const businessBasis = asset.cost * (asset.businessUsePercent / 100)\n  let depreciableBasis = businessBasis - asset.salvageValue\n  let remaining = depreciableBasis\n\n  const purchaseYear = new Date(asset.purchaseDate || new Date().toISOString()).getFullYear()\n  const currentYear = new Date().getFullYear()\n  const schedule: DepreciationScheduleYear[] = []\n  const methodParts: string[] = []\n\n  // ── Section 179 ──\n  let s179 = 0\n  if (asset.section179Elected && assetClass.section179) {\n    const available = Math.max(0, SECTION_179_LIMIT_2024 - section179Used)\n    // Vehicle heavy cap\n    const vehicleCap = asset.classId === 'vehicle_heavy' ? VEHICLE_LIMITS_2024.suvOver6000 : Infinity\n    s179 = Math.min(remaining, available, vehicleCap)\n    remaining -= s179\n    methodParts.push(`§179: $${s179.toLocaleString()}`)\n  }\n\n  // ── Bonus Depreciation ──\n  let bonus = 0\n  if (asset.bonusDepreciation && remaining > 0) {\n    const bonusRate = BONUS_DEPRECIATION_RATES[purchaseYear] ?? 0\n    // Vehicle limits\n    if (asset.classId === 'vehicle_light') {\n      const maxFirst = bonusRate > 0\n        ? VEHICLE_LIMITS_2024.firstYear_withBonus\n        : VEHICLE_LIMITS_2024.firstYear_noBonus\n      bonus = Math.min(remaining, Math.max(0, maxFirst - s179))\n    } else {\n      bonus = Math.round(remaining * bonusRate)\n    }\n    remaining -= bonus\n    if (bonus > 0) methodParts.push(`Bonus ${(BONUS_DEPRECIATION_RATES[purchaseYear] ?? 0) * 100}%: $${bonus.toLocaleString()}`)\n  }\n\n  // ── MACRS Schedule ──\n  const macrsRates = MACRS_TABLES[assetClass.macrsLife] || MACRS_TABLES[7]\n  const macrsYears = macrsRates.length\n  let macrsRemaining = remaining\n\n  for (let i = 0; i < macrsYears; i++) {\n    const year = purchaseYear + i\n    const macrsDepr = Math.min(\n      Math.round(remaining * macrsRates[i]),\n      macrsRemaining\n    )\n    macrsRemaining -= macrsDepr\n\n    const yearS179 = i === 0 ? s179 : 0\n    const yearBonus = i === 0 ? bonus : 0\n    const totalDepr = yearS179 + yearBonus + macrsDepr\n\n    schedule.push({\n      year,\n      section179: yearS179,\n      bonusDepreciation: yearBonus,\n      macrsDepreciation: macrsDepr,\n      totalDepreciation: totalDepr,\n      remainingBasis: macrsRemaining,\n      taxSavings: Math.round(totalDepr * marginalRate),\n    })\n  }\n\n  if (macrsRates.length > 0) {\n    methodParts.push(`MACRS ${assetClass.macrsLife}-yr`)\n  }\n\n  const totalDeductions = schedule.reduce((s, y) => s + y.totalDepreciation, 0)\n  const firstYearDeduction = schedule[0]?.totalDepreciation || 0\n\n  return {\n    asset,\n    assetClass,\n    depreciableBasis,\n    schedule,\n    totalDeductions,\n    firstYearDeduction,\n    taxSavingsFirstYear: Math.round(firstYearDeduction * marginalRate),\n    taxSavingsTotal: Math.round(totalDeductions * marginalRate),\n    method: methodParts.join(' + ') || `MACRS ${assetClass.macrsLife}-yr`,\n  }\n}\n\n// ===================================================================\n//  VEHICLE DEDUCTION OPTIMIZER\n// ===================================================================\n\nexport function analyzeVehicleDeduction(\n  annualMiles: number,\n  businessMiles: number,\n  vehicleCost: number,\n  annualFuel: number,\n  annualInsurance: number,\n  annualMaintenance: number,\n  annualParking: number,\n  marginalRate: number,\n): VehicleDeductionAnalysis {\n  const businessPct = annualMiles > 0 ? businessMiles / annualMiles : 0\n\n  // Standard mileage\n  const stdDeduction = Math.round(businessMiles * STANDARD_MILEAGE_RATE_2024)\n\n  // Actual expense\n  const totalOperating = annualFuel + annualInsurance + annualMaintenance + annualParking\n  const operatingDeduction = Math.round(totalOperating * businessPct)\n\n  // Depreciation component (simplified 5-yr MACRS)\n  const macrsRate = MACRS_TABLES[5]?.[0] || 0.20\n  const deprComponent = Math.round(vehicleCost * macrsRate * businessPct)\n  const actualTotal = operatingDeduction + deprComponent\n\n  const recommendation = stdDeduction >= actualTotal ? 'standard_mileage' : 'actual_expense'\n  const diff = Math.abs(stdDeduction - actualTotal)\n\n  const notes: string[] = []\n  if (businessPct > 0.5) notes.push('High business use qualifies for either method')\n  if (businessPct < 0.5) notes.push('Business use under 50% — Section 179 not available')\n  if (vehicleCost > 60000) notes.push('Luxury vehicle limits may apply — consider heavy SUV exception')\n  if (businessMiles > 20000) notes.push('High mileage favors standard mileage rate')\n  notes.push(`Standard mileage rate for 2024: $${STANDARD_MILEAGE_RATE_2024}/mile`)\n\n  return {\n    standardMileage: {\n      annualDeduction: stdDeduction,\n      effective: recommendation === 'standard_mileage',\n      calculation: `${businessMiles.toLocaleString()} miles × $${STANDARD_MILEAGE_RATE_2024} = $${stdDeduction.toLocaleString()}`,\n    },\n    actualExpense: {\n      annualDeduction: actualTotal,\n      effective: recommendation === 'actual_expense',\n      calculation: `($${totalOperating.toLocaleString()} operating × ${(businessPct * 100).toFixed(0)}%) + $${deprComponent.toLocaleString()} depreciation`,\n      depreciationComponent: deprComponent,\n      operatingComponent: operatingDeduction,\n    },\n    recommendation,\n    difference: diff,\n    notes,\n  }\n}\n\n// ===================================================================\n//  HOME OFFICE DEDUCTION\n// ===================================================================\n\nexport function analyzeHomeOffice(\n  homeSquareFt: number,\n  officeSquareFt: number,\n  annualRentOrMortgage: number,\n  annualUtilities: number,\n  annualInsurance: number,\n  homeValue: number, // for depreciation if owned\n  isOwner: boolean,\n  marginalRate: number,\n): HomeOfficeDeduction {\n  const businessPct = homeSquareFt > 0 ? officeSquareFt / homeSquareFt : 0\n\n  // Simplified method: $5/sqft, max 300 sqft\n  const simplifiedSqft = Math.min(officeSquareFt, 300)\n  const simplified = simplifiedSqft * 5\n\n  // Regular method\n  const indirectExpenses = Math.round(\n    (annualRentOrMortgage + annualUtilities + annualInsurance) * businessPct\n  )\n  const depreciation = isOwner ? Math.round(homeValue * businessPct / 39) : 0 // 39-yr straight-line\n  const regular = indirectExpenses + depreciation\n\n  return {\n    simplified: {\n      deduction: simplified,\n      calculation: `${simplifiedSqft} sq ft × $5 = $${simplified.toLocaleString()} (max 300 sq ft)`,\n    },\n    regular: {\n      deduction: regular,\n      directExpenses: 0,\n      indirectExpenses,\n      depreciation,\n      calculation: `${(businessPct * 100).toFixed(1)}% of ($${(annualRentOrMortgage + annualUtilities + annualInsurance).toLocaleString()}) + $${depreciation.toLocaleString()} depreciation`,\n    },\n    recommendation: simplified >= regular ? 'simplified' : 'regular',\n    difference: Math.abs(simplified - regular),\n  }\n}\n\n// ===================================================================\n//  PURCHASE TIMING OPTIMIZER\n// ===================================================================\n\nfunction analyzePurchaseTiming(\n  state: FortunaState,\n  marginalRate: number,\n): PurchaseTimingInsight[] {\n  const insights: PurchaseTimingInsight[] = []\n  const currentYear = new Date().getFullYear()\n  const currentMonth = new Date().getMonth() // 0-indexed\n\n  // Bonus depreciation phase-down alert\n  const currentBonus = BONUS_DEPRECIATION_RATES[currentYear] ?? 0\n  const nextBonus = BONUS_DEPRECIATION_RATES[currentYear + 1] ?? 0\n  if (currentBonus > nextBonus) {\n    insights.push({\n      type: 'warning',\n      title: `Bonus Depreciation Drops to ${nextBonus * 100}% in ${currentYear + 1}`,\n      detail: `Current rate is ${currentBonus * 100}%. For a $50,000 asset, waiting costs $${Math.round(50000 * (currentBonus - nextBonus) * marginalRate).toLocaleString()} in first-year tax savings.`,\n      impact: Math.round(50000 * (currentBonus - nextBonus) * marginalRate),\n    })\n  }\n\n  // Year-end purchasing opportunity\n  if (currentMonth >= 9) { // Oct-Dec\n    insights.push({\n      type: 'opportunity',\n      title: 'Year-End Asset Purchases',\n      detail: `Assets placed in service before Dec 31 qualify for full-year Section 179 and bonus depreciation. Even a December purchase gets the same first-year deduction as a January purchase.`,\n    })\n  }\n\n  // Section 179 capacity\n  const section179Remaining = SECTION_179_LIMIT_2024\n  insights.push({\n    type: 'info',\n    title: `$${section179Remaining.toLocaleString()} Section 179 Capacity Available`,\n    detail: `Immediate expensing up to $${SECTION_179_LIMIT_2024.toLocaleString()} for qualifying equipment. Phase-out begins at $${SECTION_179_PHASEOUT_START.toLocaleString()} total assets placed in service.`,\n  })\n\n  // Marginal rate opportunity\n  if (marginalRate >= 0.32) {\n    insights.push({\n      type: 'opportunity',\n      title: `High Bracket = Maximum Deduction Value`,\n      detail: `At ${(marginalRate * 100).toFixed(0)}% marginal rate, every $1 of depreciation saves $${marginalRate.toFixed(2)} in tax. This is the optimal time for capital expenditures.`,\n    })\n  }\n\n  // Heavy vehicle exception\n  insights.push({\n    type: 'info',\n    title: 'Heavy Vehicle Exception (Over 6,000 lbs GVWR)',\n    detail: `Vehicles over 6,000 lbs bypass luxury auto limits. Up to $${VEHICLE_LIMITS_2024.suvOver6000.toLocaleString()} Section 179 for SUVs, unlimited for trucks/vans. Popular qualifying vehicles: Ford F-150, Chevy Tahoe, Tesla Model X, BMW X5.`,\n  })\n\n  return insights\n}\n\n// ===================================================================\n//  MAIN ANALYSIS\n// ===================================================================\n\nexport function generateDepreciationSummary(\n  state: FortunaState,\n  assets: BusinessAsset[] = [],\n  entityFilter?: string,\n): DepreciationSummary {\n  const report = generateTaxReport(state)\n  const marginalRate = report.marginalRate\n\n  // Apply entity filter if specified\n  const filtered = entityFilter\n    ? assets.filter(a => (a.entityId || 'personal') === entityFilter)\n    : assets\n\n  let section179Used = 0\n  const assetResults: AssetDepreciationResult[] = []\n\n  for (const asset of filtered) {\n    const result = calculateAssetDepreciation(asset, marginalRate, section179Used)\n    section179Used += result.schedule[0]?.section179 || 0\n    assetResults.push(result)\n  }\n\n  const timingInsights = analyzePurchaseTiming(state, marginalRate)\n\n  const currentYear = new Date().getFullYear()\n  const currentYearDeduction = assetResults.reduce((sum, r) => {\n    const thisYear = r.schedule.find(s => s.year === currentYear)\n    return sum + (thisYear?.totalDepreciation || 0)\n  }, 0)\n\n  // Per-entity breakdown\n  const entityIds = new Set(assets.map(a => a.entityId || 'personal'))\n  const entityBreakdown: { entityId: string; assetCount: number; totalCost: number; currentYearDeduction: number; section179Used: number }[] = []\n  for (const eid of entityIds) {\n    const entityAssets = assets.filter(a => (a.entityId || 'personal') === eid)\n    let eid179 = 0\n    let eidDeduction = 0\n    for (const asset of entityAssets) {\n      const r = calculateAssetDepreciation(asset, marginalRate, eid179)\n      eid179 += r.schedule[0]?.section179 || 0\n      const thisYear = r.schedule.find(s => s.year === currentYear)\n      eidDeduction += thisYear?.totalDepreciation || 0\n    }\n    entityBreakdown.push({ entityId: eid, assetCount: entityAssets.length, totalCost: entityAssets.reduce((s, a) => s + a.cost, 0), currentYearDeduction: eidDeduction, section179Used: eid179 })\n  }\n\n  return {\n    totalAssets: filtered.length,\n    totalCost: filtered.reduce((s, a) => s + a.cost, 0),\n    totalDepreciatedToDate: assetResults.reduce((s, r) => s + r.totalDeductions, 0),\n    remainingBasis: assetResults.reduce((s, r) => {\n      const last = r.schedule[r.schedule.length - 1]\n      return s + (last?.remainingBasis || 0)\n    }, 0),\n    currentYearDeduction,\n    section179Used,\n    section179Remaining: Math.max(0, SECTION_179_LIMIT_2024 - section179Used),\n    bonusDepreciationRate: BONUS_DEPRECIATION_RATES[new Date().getFullYear()] ?? 0,\n    assetResults,\n    vehicleAnalysis: null,\n    homeOffice: null,\n    purchaseTimingInsights: timingInsights,\n    totalTaxSavingsThisYear: Math.round(currentYearDeduction * marginalRate),\n    entityBreakdown,\n  }\n}\n\nexport { ASSET_CLASSES, VEHICLE_LIMITS_2024, SECTION_179_LIMIT_2024, STANDARD_MILEAGE_RATE_2024, BONUS_DEPRECIATION_RATES }\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\document-generator.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TaxReport' is defined but never used.","line":8,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":43,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TaxReport"},"fix":{"range":[265,281],"text":""},"desc":"Remove unused variable \"TaxReport\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'calculateMaxSEPIRA' is defined but never used.","line":8,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":63,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"calculateMaxSEPIRA"},"fix":{"range":[281,301],"text":""},"desc":"Remove unused variable \"calculateMaxSEPIRA\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'calculateMaxSolo401k' is defined but never used.","line":8,"column":65,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":85,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"calculateMaxSolo401k"},"fix":{"range":[301,323],"text":""},"desc":"Remove unused variable \"calculateMaxSolo401k\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'calculateSCorpSavings' is defined but never used.","line":8,"column":87,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":108,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"calculateSCorpSavings"},"fix":{"range":[323,346],"text":""},"desc":"Remove unused variable \"calculateSCorpSavings\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'expenses' is assigned a value but never used.","line":106,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":106,"endColumn":46},{"ruleId":"prefer-const","severity":2,"message":"'sections' is never reassigned. Use 'const' instead.","line":114,"column":7,"nodeType":"Identifier","messageId":"useConst","endLine":114,"endColumn":82,"fix":{"range":[6653,6737],"text":"const sections: { title: string; items: { text: string; critical: boolean }[] }[] = []"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'risks' is assigned a value but never used.","line":277,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":277,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'alerts' is assigned a value but never used.","line":279,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":279,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'expenses' is assigned a value but never used.","line":282,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":282,"endColumn":43},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'deductions' is assigned a value but never used.","line":282,"column":55,"nodeType":"Identifier","messageId":"unusedVar","endLine":282,"endColumn":65}],"suppressedMessages":[],"errorCount":10,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine v5 - Document Generator\n * Generates ready-to-use tax documents, checklists, and CPA handoff packages.\n * The \"last mile\" — turns insights into actionable paperwork.\n */\n\nimport type { FortunaState } from './storage'\nimport { generateTaxReport, type TaxReport, calculateMaxSEPIRA, calculateMaxSolo401k, calculateSCorpSavings } from './tax-calculator'\nimport { generateProactiveAlerts } from './proactive-intelligence'\nimport { detectStrategies, analyzeRisks, calculateHealthScore } from './strategy-detector'\n\n// ==================== Types ====================\n\nexport interface GeneratedDocument {\n  id: string\n  title: string\n  type: 'voucher' | 'checklist' | 'worksheet' | 'report' | 'letter'\n  category: 'tax' | 'entity' | 'audit' | 'planning' | 'cpa'\n  content: string // HTML or markdown content\n  generatedAt: string\n  applicableYear: number\n}\n\n// ==================== 1040-ES Estimated Tax Voucher ====================\n\nexport function generate1040ES(state: FortunaState, quarter: 1 | 2 | 3 | 4): GeneratedDocument {\n  const report = generateTaxReport(state)\n  const year = new Date().getFullYear()\n  const quarterlyAmount = Math.round(report.totalFederalTax / 4)\n  \n  const dueDates: Record<number, string> = {\n    1: `April 15, ${year}`,\n    2: `June 15, ${year}`,\n    3: `September 15, ${year}`,\n    4: `January 15, ${year + 1}`,\n  }\n  \n  const content = `\n<div style=\"font-family: 'Courier New', monospace; max-width: 720px; padding: 32px; background: #fff; color: #111;\">\n  <div style=\"text-align: center; border-bottom: 3px double #333; padding-bottom: 16px; margin-bottom: 24px;\">\n    <div style=\"font-size: 11px; letter-spacing: 2px;\">DEPARTMENT OF THE TREASURY</div>\n    <div style=\"font-size: 11px; letter-spacing: 2px;\">INTERNAL REVENUE SERVICE</div>\n    <div style=\"font-size: 18px; font-weight: bold; margin-top: 8px;\">Form 1040-ES — Estimated Tax Payment Voucher</div>\n    <div style=\"font-size: 14px; margin-top: 4px;\">Quarter ${quarter} — Tax Year ${year}</div>\n  </div>\n  \n  <div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;\">\n    <div>\n      <div style=\"font-size: 11px; color: #666; text-transform: uppercase;\">Taxpayer Name</div>\n      <div style=\"font-size: 16px; font-weight: bold; border-bottom: 1px solid #ccc; padding: 4px 0;\">${state.profile.name || '[YOUR NAME]'}</div>\n    </div>\n    <div>\n      <div style=\"font-size: 11px; color: #666; text-transform: uppercase;\">Filing Status</div>\n      <div style=\"font-size: 16px; border-bottom: 1px solid #ccc; padding: 4px 0;\">${formatFilingStatus(state.profile.filingStatus)}</div>\n    </div>\n    <div>\n      <div style=\"font-size: 11px; color: #666; text-transform: uppercase;\">State</div>\n      <div style=\"font-size: 16px; border-bottom: 1px solid #ccc; padding: 4px 0;\">${state.profile.state}</div>\n    </div>\n    <div>\n      <div style=\"font-size: 11px; color: #666; text-transform: uppercase;\">Due Date</div>\n      <div style=\"font-size: 16px; font-weight: bold; border-bottom: 1px solid #ccc; padding: 4px 0; color: #c00;\">${dueDates[quarter]}</div>\n    </div>\n  </div>\n  \n  <div style=\"background: #f8f8f8; border: 1px solid #ddd; padding: 20px; margin-bottom: 24px;\">\n    <div style=\"font-size: 14px; font-weight: bold; margin-bottom: 16px;\">CALCULATION WORKSHEET</div>\n    <table style=\"width: 100%; border-collapse: collapse; font-size: 13px;\">\n      <tr><td style=\"padding: 6px 0;\">1. Estimated adjusted gross income</td><td style=\"text-align: right; font-family: monospace;\">$${Math.round(report.agi).toLocaleString()}</td></tr>\n      <tr><td style=\"padding: 6px 0;\">2. Estimated deductions</td><td style=\"text-align: right; font-family: monospace;\">$${Math.round(report.totalDeductions).toLocaleString()}</td></tr>\n      <tr><td style=\"padding: 6px 0;\">3. Estimated taxable income (1 - 2)</td><td style=\"text-align: right; font-family: monospace;\">$${Math.round(report.taxableIncome).toLocaleString()}</td></tr>\n      <tr><td style=\"padding: 6px 0;\">4. Estimated income tax</td><td style=\"text-align: right; font-family: monospace;\">$${Math.round(report.incomeTax).toLocaleString()}</td></tr>\n      <tr><td style=\"padding: 6px 0;\">5. Self-employment tax</td><td style=\"text-align: right; font-family: monospace;\">$${Math.round(report.selfEmploymentTax).toLocaleString()}</td></tr>\n      <tr style=\"border-top: 2px solid #333;\"><td style=\"padding: 6px 0; font-weight: bold;\">6. Total estimated tax (4 + 5)</td><td style=\"text-align: right; font-weight: bold; font-family: monospace;\">$${Math.round(report.totalFederalTax).toLocaleString()}</td></tr>\n      <tr style=\"background: #e8f5e9;\"><td style=\"padding: 8px 0; font-weight: bold; font-size: 15px;\">7. Quarterly payment (6 ÷ 4)</td><td style=\"text-align: right; font-weight: bold; font-size: 15px; font-family: monospace;\">$${quarterlyAmount.toLocaleString()}</td></tr>\n    </table>\n  </div>\n  \n  <div style=\"border: 2px dashed #999; padding: 16px; margin-bottom: 24px; text-align: center;\">\n    <div style=\"font-size: 22px; font-weight: bold;\">AMOUNT ENCLOSED: $${quarterlyAmount.toLocaleString()}</div>\n    <div style=\"font-size: 12px; color: #666; margin-top: 8px;\">Make check payable to \"United States Treasury\"</div>\n    <div style=\"font-size: 12px; color: #666;\">Write your SSN and \"${year} Form 1040-ES\" on check</div>\n  </div>\n  \n  <div style=\"font-size: 11px; color: #888; border-top: 1px solid #ddd; padding-top: 12px;\">\n    <strong>Payment Options:</strong> IRS Direct Pay (irs.gov/payments) • EFTPS.gov • Mail to IRS with this voucher<br>\n    <strong>Note:</strong> This is a Fortuna Engine calculation worksheet, not an official IRS form. Consult a tax professional for filing.\n    <br><strong>Generated:</strong> ${new Date().toLocaleDateString()} by Fortuna Engine v5\n  </div>\n</div>`\n\n  return {\n    id: `1040es-q${quarter}-${year}`,\n    title: `1040-ES Estimated Tax Voucher — Q${quarter} ${year}`,\n    type: 'voucher',\n    category: 'tax',\n    content,\n    generatedAt: new Date().toISOString(),\n    applicableYear: year,\n  }\n}\n\n// ==================== Audit Preparedness Checklist ====================\n\nexport function generateAuditChecklist(state: FortunaState): GeneratedDocument {\n  const { deductions, incomeStreams, expenses, entities } = state\n  const year = new Date().getFullYear()\n  \n  const hasSelfEmployment = incomeStreams.some(s => ['business', 'freelance'].includes(s.type) && s.isActive)\n  const hasHomeOffice = deductions.some(d => d.category === 'home_office')\n  const hasVehicle = deductions.some(d => d.category === 'vehicle')\n  const hasCharitable = deductions.some(d => d.category === 'charitable')\n  \n  let sections: { title: string; items: { text: string; critical: boolean }[] }[] = []\n  \n  // Universal records\n  sections.push({\n    title: 'Universal Documentation',\n    items: [\n      { text: 'All W-2 forms from employers', critical: true },\n      { text: 'All 1099 forms (1099-NEC, 1099-MISC, 1099-K, 1099-INT, 1099-DIV)', critical: true },\n      { text: 'Copy of prior year tax return', critical: true },\n      { text: 'Government-issued photo ID', critical: false },\n      { text: 'Social Security cards for all household members', critical: false },\n      { text: 'Bank statements for all accounts (12 months)', critical: true },\n      { text: 'Credit card statements (12 months)', critical: false },\n    ],\n  })\n  \n  // Self-employment specific\n  if (hasSelfEmployment) {\n    sections.push({\n      title: 'Self-Employment / Business Records',\n      items: [\n        { text: 'Profit & loss statement / income summary', critical: true },\n        { text: 'Business bank account statements (12 months)', critical: true },\n        { text: 'All business expense receipts organized by category', critical: true },\n        { text: 'Contracts and invoices for all clients', critical: true },\n        { text: 'Business license and EIN documentation', critical: false },\n        { text: '1099-K from payment processors (Stripe, PayPal, Square)', critical: true },\n        { text: 'Estimated tax payment records (1040-ES confirmations)', critical: true },\n        { text: 'Business use documentation for any shared assets', critical: false },\n      ],\n    })\n  }\n  \n  // Home office\n  if (hasHomeOffice) {\n    sections.push({\n      title: 'Home Office Documentation',\n      items: [\n        { text: 'Floor plan or measurements showing office area vs total home', critical: true },\n        { text: 'Photos of dedicated office space', critical: true },\n        { text: 'Mortgage interest statement (Form 1098) or lease agreement', critical: true },\n        { text: 'Property tax records', critical: false },\n        { text: 'Utility bills (gas, electric, internet) for 12 months', critical: true },\n        { text: 'Home insurance documentation', critical: false },\n        { text: 'Repair/maintenance receipts for office area', critical: false },\n      ],\n    })\n  }\n  \n  // Vehicle\n  if (hasVehicle) {\n    sections.push({\n      title: 'Vehicle Expense Documentation',\n      items: [\n        { text: 'Mileage log with date, destination, purpose, and miles for each trip', critical: true },\n        { text: 'Total miles driven during the year', critical: true },\n        { text: 'Business miles vs personal miles breakdown', critical: true },\n        { text: 'Gas receipts (if using actual expense method)', critical: false },\n        { text: 'Vehicle repair and maintenance receipts', critical: false },\n        { text: 'Vehicle insurance documentation', critical: false },\n        { text: 'Lease agreement or loan documentation', critical: false },\n      ],\n    })\n  }\n  \n  // Charitable\n  if (hasCharitable) {\n    sections.push({\n      title: 'Charitable Contribution Documentation',\n      items: [\n        { text: 'Written acknowledgment from charity for donations over $250', critical: true },\n        { text: 'Receipts for all cash contributions', critical: true },\n        { text: 'Form 8283 for non-cash donations over $500', critical: true },\n        { text: 'Qualified appraisal for non-cash items over $5,000', critical: true },\n        { text: 'Bank statements or canceled checks showing donations', critical: false },\n        { text: 'Verification of 501(c)(3) status for each organization', critical: false },\n      ],\n    })\n  }\n  \n  // Entity-specific\n  if (entities.filter(e => e.isActive).length > 0) {\n    sections.push({\n      title: 'Entity & Structure Documentation',\n      items: [\n        { text: 'Articles of organization/incorporation for each entity', critical: true },\n        { text: 'Operating agreement / bylaws', critical: true },\n        { text: 'EIN assignment letters', critical: true },\n        { text: 'K-1 forms from any partnerships or S-Corps', critical: true },\n        { text: 'Reasonable compensation documentation (S-Corp)', critical: entities.some(e => e.type === 'llc_scorp' || e.type === 'scorp') },\n        { text: 'Board meeting minutes (if applicable)', critical: false },\n        { text: 'Annual state filing receipts', critical: false },\n      ],\n    })\n  }\n  \n  // Deductions\n  sections.push({\n    title: 'Deduction & Credit Documentation',\n    items: [\n      { text: 'Health insurance premium statements (Form 1095-A/B/C)', critical: true },\n      { text: 'Retirement contribution statements (401k, IRA, SEP)', critical: true },\n      { text: 'Student loan interest statement (Form 1098-E)', critical: false },\n      { text: 'Mortgage interest statement (Form 1098)', critical: false },\n      { text: 'State and local tax payment records', critical: false },\n      { text: 'Education expense records (Form 1098-T)', critical: false },\n      { text: 'Childcare expense records and provider information', critical: state.profile.dependents > 0 },\n    ],\n  })\n  \n  const content = `\n<div style=\"font-family: -apple-system, sans-serif; max-width: 720px; padding: 32px; background: #fff; color: #111;\">\n  <div style=\"border-bottom: 3px solid #1a365d; padding-bottom: 16px; margin-bottom: 24px;\">\n    <div style=\"font-size: 24px; font-weight: bold; color: #1a365d;\">Audit Preparedness Checklist</div>\n    <div style=\"font-size: 14px; color: #666; margin-top: 4px;\">Tax Year ${year - 1} • Generated ${new Date().toLocaleDateString()}</div>\n    <div style=\"font-size: 13px; color: #888; margin-top: 2px;\">Prepared for: ${state.profile.name || '[Taxpayer]'} • ${state.profile.state}</div>\n  </div>\n  \n  ${sections.map(section => `\n    <div style=\"margin-bottom: 24px;\">\n      <div style=\"font-size: 16px; font-weight: 600; color: #1a365d; margin-bottom: 12px; padding-bottom: 6px; border-bottom: 1px solid #e2e8f0;\">\n        ${section.title}\n      </div>\n      ${section.items.map(item => `\n        <div style=\"display: flex; align-items: flex-start; gap: 10px; padding: 6px 0; font-size: 13px;\">\n          <span style=\"width: 18px; height: 18px; border: 2px solid ${item.critical ? '#c53030' : '#a0aec0'}; border-radius: 3px; flex-shrink: 0; margin-top: 1px;\"></span>\n          <span style=\"${item.critical ? 'font-weight: 500;' : 'color: #4a5568;'}\">${item.text}${item.critical ? ' <span style=\"color: #c53030; font-size: 11px;\">CRITICAL</span>' : ''}</span>\n        </div>\n      `).join('')}\n    </div>\n  `).join('')}\n  \n  <div style=\"background: #fffbeb; border: 1px solid #f6e05e; padding: 16px; border-radius: 8px; margin-top: 24px;\">\n    <div style=\"font-weight: 600; color: #744210; margin-bottom: 8px;\">⚠ Important Notes</div>\n    <ul style=\"margin: 0; padding-left: 20px; font-size: 13px; color: #744210;\">\n      <li>Keep all records for at least 3 years from filing date (6 years for underreported income >25%)</li>\n      <li>Digital copies of receipts are acceptable if legible</li>\n      <li>Contemporaneous records (created at time of transaction) carry more weight than reconstructed ones</li>\n      <li>CRITICAL items are most frequently requested in IRS examinations</li>\n    </ul>\n  </div>\n  \n  <div style=\"font-size: 11px; color: #a0aec0; margin-top: 24px; padding-top: 12px; border-top: 1px solid #e2e8f0;\">\n    Generated by Fortuna Engine v5 • This checklist is for preparation purposes and does not constitute tax or legal advice\n  </div>\n</div>`\n\n  return {\n    id: `audit-checklist-${year}`,\n    title: `Audit Preparedness Checklist — ${year - 1} Tax Year`,\n    type: 'checklist',\n    category: 'audit',\n    content,\n    generatedAt: new Date().toISOString(),\n    applicableYear: year - 1,\n  }\n}\n\n// ==================== CPA Handoff Package ====================\n\nexport function generateCPAPackage(state: FortunaState): GeneratedDocument {\n  const report = generateTaxReport(state)\n  const strategies = detectStrategies(state)\n  const risks = analyzeRisks(state)\n  const health = calculateHealthScore(state)\n  const alerts = generateProactiveAlerts(state)\n  const year = new Date().getFullYear()\n  \n  const { profile, incomeStreams, expenses, entities, deductions } = state\n  const activeIncome = incomeStreams.filter(s => s.isActive)\n  const activeEntities = entities.filter(e => e.isActive)\n  \n  const content = `\n<div style=\"font-family: -apple-system, sans-serif; max-width: 800px; padding: 32px; background: #fff; color: #111;\">\n  <div style=\"display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #1a365d; padding-bottom: 16px; margin-bottom: 24px;\">\n    <div>\n      <div style=\"font-size: 24px; font-weight: bold; color: #1a365d;\">CPA Strategy Handoff Package</div>\n      <div style=\"font-size: 14px; color: #666; margin-top: 4px;\">Comprehensive Financial Analysis • Tax Year ${year}</div>\n    </div>\n    <div style=\"text-align: right;\">\n      <div style=\"font-size: 13px; color: #888;\">Prepared: ${new Date().toLocaleDateString()}</div>\n      <div style=\"font-size: 13px; color: #888;\">Fortuna Engine v5</div>\n    </div>\n  </div>\n  \n  <!-- Client Profile -->\n  <div style=\"background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 24px;\">\n    <div style=\"font-size: 16px; font-weight: 600; color: #1a365d; margin-bottom: 12px;\">Client Profile</div>\n    <div style=\"display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; font-size: 13px;\">\n      <div><span style=\"color: #718096;\">Name:</span> <strong>${profile.name || '[Not Set]'}</strong></div>\n      <div><span style=\"color: #718096;\">State:</span> <strong>${profile.state}</strong></div>\n      <div><span style=\"color: #718096;\">Filing Status:</span> <strong>${formatFilingStatus(profile.filingStatus)}</strong></div>\n      <div><span style=\"color: #718096;\">Dependents:</span> <strong>${profile.dependents}</strong></div>\n      <div><span style=\"color: #718096;\">Age:</span> <strong>${profile.age}</strong></div>\n      <div><span style=\"color: #718096;\">Health Insurance:</span> <strong>${profile.hasHealthInsurance ? 'Yes' : 'No'}</strong></div>\n    </div>\n  </div>\n  \n  <!-- Financial Summary -->\n  <div style=\"margin-bottom: 24px;\">\n    <div style=\"font-size: 16px; font-weight: 600; color: #1a365d; margin-bottom: 12px;\">Financial Summary</div>\n    <table style=\"width: 100%; border-collapse: collapse; font-size: 13px;\">\n      <tr style=\"background: #edf2f7;\"><td style=\"padding: 8px; font-weight: 500;\">Total Gross Income</td><td style=\"text-align: right; padding: 8px; font-family: monospace;\">$${Math.round(activeIncome.reduce((s, i) => s + i.annualAmount, 0)).toLocaleString()}</td></tr>\n      <tr><td style=\"padding: 8px;\">Adjusted Gross Income (AGI)</td><td style=\"text-align: right; padding: 8px; font-family: monospace;\">$${Math.round(report.agi).toLocaleString()}</td></tr>\n      <tr style=\"background: #edf2f7;\"><td style=\"padding: 8px;\">Total Deductions</td><td style=\"text-align: right; padding: 8px; font-family: monospace;\">$${Math.round(report.totalDeductions).toLocaleString()}</td></tr>\n      <tr><td style=\"padding: 8px;\">Taxable Income</td><td style=\"text-align: right; padding: 8px; font-family: monospace;\">$${Math.round(report.taxableIncome).toLocaleString()}</td></tr>\n      <tr style=\"background: #edf2f7;\"><td style=\"padding: 8px;\">Federal Income Tax</td><td style=\"text-align: right; padding: 8px; font-family: monospace;\">$${Math.round(report.incomeTax).toLocaleString()}</td></tr>\n      <tr><td style=\"padding: 8px;\">Self-Employment Tax</td><td style=\"text-align: right; padding: 8px; font-family: monospace;\">$${Math.round(report.selfEmploymentTax).toLocaleString()}</td></tr>\n      <tr style=\"background: #fff3cd; font-weight: bold;\"><td style=\"padding: 10px;\">Total Federal Tax Liability</td><td style=\"text-align: right; padding: 10px; font-family: monospace; font-size: 15px;\">$${Math.round(report.totalFederalTax).toLocaleString()}</td></tr>\n      <tr><td style=\"padding: 8px;\">Effective Tax Rate</td><td style=\"text-align: right; padding: 8px; font-family: monospace;\">${report.effectiveRate.toFixed(1)}%</td></tr>\n      <tr style=\"background: #edf2f7;\"><td style=\"padding: 8px;\">Marginal Tax Rate</td><td style=\"text-align: right; padding: 8px; font-family: monospace;\">${report.marginalRate}%</td></tr>\n    </table>\n  </div>\n  \n  <!-- Income Streams -->\n  <div style=\"margin-bottom: 24px;\">\n    <div style=\"font-size: 16px; font-weight: 600; color: #1a365d; margin-bottom: 12px;\">Income Streams (${activeIncome.length})</div>\n    <table style=\"width: 100%; border-collapse: collapse; font-size: 13px;\">\n      <tr style=\"background: #1a365d; color: white;\"><th style=\"padding: 8px; text-align: left;\">Source</th><th style=\"text-align: left; padding: 8px;\">Type</th><th style=\"text-align: left; padding: 8px;\">Entity</th><th style=\"text-align: right; padding: 8px;\">Annual Amount</th></tr>\n      ${activeIncome.map((s, i) => `\n        <tr style=\"background: ${i % 2 ? '#f7fafc' : '#fff'};\">\n          <td style=\"padding: 8px;\">${s.name}</td>\n          <td style=\"padding: 8px;\">${s.type.replace('_', ' ').toUpperCase()}</td>\n          <td style=\"padding: 8px;\">${s.entityId ? (entities.find(e => e.id === s.entityId)?.name || '—') : '—'}</td>\n          <td style=\"text-align: right; padding: 8px; font-family: monospace;\">$${s.annualAmount.toLocaleString()}</td>\n        </tr>\n      `).join('')}\n    </table>\n  </div>\n  \n  <!-- Entity Structure -->\n  ${activeEntities.length > 0 ? `\n  <div style=\"margin-bottom: 24px;\">\n    <div style=\"font-size: 16px; font-weight: 600; color: #1a365d; margin-bottom: 12px;\">Entity Structure (${activeEntities.length})</div>\n    <table style=\"width: 100%; border-collapse: collapse; font-size: 13px;\">\n      <tr style=\"background: #1a365d; color: white;\"><th style=\"padding: 8px; text-align: left;\">Entity</th><th style=\"text-align: left; padding: 8px;\">Type</th><th style=\"text-align: left; padding: 8px;\">State</th><th style=\"text-align: right; padding: 8px;\">Annual Cost</th></tr>\n      ${activeEntities.map((e, i) => `\n        <tr style=\"background: ${i % 2 ? '#f7fafc' : '#fff'};\">\n          <td style=\"padding: 8px; font-weight: 500;\">${e.name}</td>\n          <td style=\"padding: 8px;\">${e.type.replace('_', ' ').toUpperCase()}</td>\n          <td style=\"padding: 8px;\">${e.state}</td>\n          <td style=\"text-align: right; padding: 8px; font-family: monospace;\">$${e.annualCost.toLocaleString()}</td>\n        </tr>\n      `).join('')}\n    </table>\n  </div>` : ''}\n  \n  <!-- Entity P&L Breakdown -->\n  ${(report.entityBreakdown || []).filter(e => e.revenue > 0 || e.expenses > 0).length > 0 ? `\n  <div style=\"margin-bottom: 24px;\">\n    <div style=\"font-size: 16px; font-weight: 600; color: #1a365d; margin-bottom: 12px;\">Entity-Level P&L</div>\n    <table style=\"width: 100%; border-collapse: collapse; font-size: 13px;\">\n      <tr style=\"background: #1a365d; color: white;\">\n        <th style=\"padding: 8px; text-align: left;\">Entity</th>\n        <th style=\"text-align: left; padding: 8px;\">Flow</th>\n        <th style=\"text-align: right; padding: 8px;\">Revenue</th>\n        <th style=\"text-align: right; padding: 8px;\">Expenses</th>\n        <th style=\"text-align: right; padding: 8px;\">Net Income</th>\n        <th style=\"text-align: right; padding: 8px;\">SE Taxable</th>\n      </tr>\n      ${(report.entityBreakdown || []).filter(e => e.revenue > 0 || e.expenses > 0).map((e, i) => `\n        <tr style=\"background: ${i % 2 ? '#f7fafc' : '#fff'};\">\n          <td style=\"padding: 8px; font-weight: 500;\">${e.entityName}</td>\n          <td style=\"padding: 8px;\">${e.flowThrough === 'schedule_c' ? 'Sched C' : e.flowThrough === 'k1' ? 'K-1' : e.flowThrough === 'corporate' ? 'Corp' : 'Personal'}</td>\n          <td style=\"text-align: right; padding: 8px; font-family: monospace;\">$${e.revenue.toLocaleString()}</td>\n          <td style=\"text-align: right; padding: 8px; font-family: monospace;\">$${e.expenses.toLocaleString()}</td>\n          <td style=\"text-align: right; padding: 8px; font-family: monospace; color: ${e.netIncome >= 0 ? '#38a169' : '#c53030'};\">$${e.netIncome.toLocaleString()}</td>\n          <td style=\"text-align: right; padding: 8px; font-family: monospace;\">$${e.seTaxableAmount.toLocaleString()}</td>\n        </tr>\n      `).join('')}\n    </table>\n  </div>` : ''}\n  \n  <!-- Strategy Recommendations -->\n  <div style=\"margin-bottom: 24px;\">\n    <div style=\"font-size: 16px; font-weight: 600; color: #1a365d; margin-bottom: 12px;\">Optimization Opportunities (${strategies.length})</div>\n    ${strategies.slice(0, 8).map(s => `\n      <div style=\"border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px; border-left: 4px solid ${s.priority === 'critical' ? '#c53030' : s.priority === 'high' ? '#dd6b20' : '#38a169'};\">\n        <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n          <div style=\"font-weight: 600; font-size: 14px;\">${s.title}</div>\n          <div style=\"font-family: monospace; font-weight: bold; color: #38a169;\">${s.impactLabel}</div>\n        </div>\n        <div style=\"font-size: 13px; color: #4a5568; margin-top: 6px;\">${s.description}</div>\n        <div style=\"font-size: 12px; color: #718096; margin-top: 4px; font-style: italic;\">Risk: ${s.risk} • Timeline: ${s.timeline}</div>\n      </div>\n    `).join('')}\n  </div>\n  \n  <!-- Financial Health Score -->\n  <div style=\"background: #f0fff4; border: 1px solid #c6f6d5; border-radius: 8px; padding: 20px; margin-bottom: 24px;\">\n    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n      <div style=\"font-size: 16px; font-weight: 600; color: #22543d;\">Financial Health Score</div>\n      <div style=\"font-size: 36px; font-weight: bold; color: ${health.overall >= 70 ? '#38a169' : health.overall >= 50 ? '#dd6b20' : '#c53030'};\">${health.overall}<span style=\"font-size: 16px; color: #718096;\">/100</span></div>\n    </div>\n    <div style=\"display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 12px; font-size: 12px;\">\n      <div>Tax Efficiency: <strong>${health.components.taxEfficiency}</strong></div>\n      <div>Entity Optimization: <strong>${health.components.entityOptimization}</strong></div>\n      <div>Income Growth: <strong>${health.components.incomeGrowth}</strong></div>\n      <div>Risk Protection: <strong>${health.components.riskProtection}</strong></div>\n      <div>Retirement: <strong>${health.components.retirementReadiness}</strong></div>\n      <div>Diversification: <strong>${health.components.diversification}</strong></div>\n    </div>\n  </div>\n  \n  <div style=\"font-size: 11px; color: #a0aec0; padding-top: 12px; border-top: 1px solid #e2e8f0;\">\n    This analysis was generated by Fortuna Engine v5 and is intended as a strategic planning document for discussion with your tax professional. It does not constitute tax advice. All calculations should be verified by a qualified CPA.\n  </div>\n</div>`\n\n  return {\n    id: `cpa-package-${year}`,\n    title: `CPA Strategy Handoff — ${year}`,\n    type: 'report',\n    category: 'cpa',\n    content,\n    generatedAt: new Date().toISOString(),\n    applicableYear: year,\n  }\n}\n\n// ==================== Entity Formation Checklist ====================\n\nexport function generateEntityFormationChecklist(entityType: string, stateName: string): GeneratedDocument {\n  const year = new Date().getFullYear()\n  \n  const entitySteps: Record<string, { title: string; steps: { text: string; detail: string }[] }[]> = {\n    'llc': [\n      { title: 'Pre-Formation', steps: [\n        { text: 'Choose a business name', detail: 'Must include \"LLC\" or \"Limited Liability Company\". Check availability with your state\\'s Secretary of State.' },\n        { text: 'Designate a registered agent', detail: 'Must have a physical address in the state of formation. Can be yourself or a registered agent service ($50-300/yr).' },\n        { text: 'Determine member structure', detail: 'Single-member or multi-member. This affects default tax treatment (disregarded entity vs partnership).' },\n      ]},\n      { title: 'State Filing', steps: [\n        { text: 'File Articles of Organization', detail: `File with ${stateName} Secretary of State. Typical cost: $50-500 depending on state. Processing: 1-4 weeks standard, 1-3 days expedited.` },\n        { text: 'Draft Operating Agreement', detail: 'Not required in all states but strongly recommended. Defines member responsibilities, profit sharing, and dissolution procedures.' },\n        { text: 'Publish formation notice (if required)', detail: 'Some states (NY, AZ, NE) require newspaper publication. Cost varies.' },\n      ]},\n      { title: 'Federal Setup', steps: [\n        { text: 'Apply for EIN (Form SS-4)', detail: 'Free from IRS. Apply online at irs.gov — takes minutes. Required for bank accounts and tax filing.' },\n        { text: 'Determine tax classification', detail: 'Default: disregarded (single-member) or partnership (multi-member). Can elect S-Corp (Form 2553) or C-Corp (Form 8832).' },\n        { text: 'Set up accounting method', detail: 'Choose cash or accrual basis. Cash is simpler for most small businesses.' },\n      ]},\n      { title: 'Compliance Setup', steps: [\n        { text: 'Open business bank account', detail: 'Mandatory for liability protection. Never commingle personal and business funds.' },\n        { text: 'Obtain business licenses/permits', detail: 'Check state and local requirements. May need professional licenses depending on industry.' },\n        { text: 'Set up estimated tax payments', detail: 'If expecting to owe $1,000+ in taxes, begin quarterly estimated payments (1040-ES).' },\n        { text: 'Mark annual report deadline', detail: 'Most states require annual or biennial reports. Missing this can result in dissolution.' },\n      ]},\n    ],\n    'llc_scorp': [\n      { title: 'Step 1: Form the LLC', steps: [\n        { text: 'Complete all LLC formation steps first', detail: 'File Articles of Organization, get EIN, open bank account — follow LLC checklist above.' },\n      ]},\n      { title: 'Step 2: S-Corp Election', steps: [\n        { text: 'File Form 2553 with IRS', detail: 'Must be filed within 75 days of formation OR by March 15 for current-year election. All members must consent.' },\n        { text: 'Determine reasonable compensation', detail: 'IRS requires S-Corp owner-employees to pay themselves a \"reasonable salary\" before taking distributions. Research comparable positions.' },\n        { text: 'Set up payroll system', detail: 'Required for paying yourself salary. Options: Gusto, ADP, or accountant-managed payroll. Budget $50-200/month.' },\n      ]},\n      { title: 'Step 3: Ongoing Compliance', steps: [\n        { text: 'Run payroll regularly (monthly or semi-monthly)', detail: 'Must withhold federal/state income tax, Social Security, Medicare. File payroll tax returns (941 quarterly, W-2/W-3 annually).' },\n        { text: 'File Form 1120-S annually (due March 15)', detail: 'S-Corp return with K-1 generation. Extension available via Form 7004.' },\n        { text: 'Maintain corporate formalities', detail: 'Meeting minutes, documented officer decisions, separation of business and personal expenses.' },\n        { text: 'Track distributions separately from salary', detail: 'Distributions from profits after reasonable salary are not subject to SE tax — this is the key savings mechanism.' },\n      ]},\n    ],\n  }\n  \n  const steps = entitySteps[entityType] || entitySteps['llc']\n  \n  const content = `\n<div style=\"font-family: -apple-system, sans-serif; max-width: 720px; padding: 32px; background: #fff; color: #111;\">\n  <div style=\"border-bottom: 3px solid #2b6cb0; padding-bottom: 16px; margin-bottom: 24px;\">\n    <div style=\"font-size: 24px; font-weight: bold; color: #2b6cb0;\">${entityType.replace('_', ' ').toUpperCase()} Formation Checklist</div>\n    <div style=\"font-size: 14px; color: #666; margin-top: 4px;\">State: ${stateName} • ${year}</div>\n  </div>\n  \n  ${steps.map((section, si) => `\n    <div style=\"margin-bottom: 28px;\">\n      <div style=\"font-size: 16px; font-weight: 600; color: #2b6cb0; margin-bottom: 14px; display: flex; align-items: center; gap: 10px;\">\n        <span style=\"background: #2b6cb0; color: white; width: 28px; height: 28px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 13px; flex-shrink: 0;\">${si + 1}</span>\n        ${section.title}\n      </div>\n      ${section.steps.map(step => `\n        <div style=\"margin-left: 38px; margin-bottom: 14px; padding: 12px; background: #f7fafc; border-radius: 8px; border-left: 3px solid #bee3f8;\">\n          <div style=\"display: flex; align-items: center; gap: 8px; margin-bottom: 4px;\">\n            <span style=\"width: 16px; height: 16px; border: 2px solid #4299e1; border-radius: 3px; flex-shrink: 0;\"></span>\n            <span style=\"font-weight: 600; font-size: 14px;\">${step.text}</span>\n          </div>\n          <div style=\"margin-left: 24px; font-size: 12px; color: #4a5568; line-height: 1.5;\">${step.detail}</div>\n        </div>\n      `).join('')}\n    </div>\n  `).join('')}\n  \n  <div style=\"font-size: 11px; color: #a0aec0; padding-top: 12px; border-top: 1px solid #e2e8f0;\">\n    Generated by Fortuna Engine v5 • State requirements vary — verify with your state's Secretary of State and a qualified attorney.\n  </div>\n</div>`\n\n  return {\n    id: `entity-formation-${entityType}-${year}`,\n    title: `${entityType.replace('_', ' ').toUpperCase()} Formation Checklist — ${stateName}`,\n    type: 'checklist',\n    category: 'entity',\n    content,\n    generatedAt: new Date().toISOString(),\n    applicableYear: year,\n  }\n}\n\n// ==================== All Available Documents ====================\n\nexport interface DocumentTemplate {\n  id: string\n  title: string\n  description: string\n  type: GeneratedDocument['type']\n  category: GeneratedDocument['category']\n  generator: (state: FortunaState) => GeneratedDocument\n}\n\nexport function getAvailableDocuments(state: FortunaState): DocumentTemplate[] {\n  const docs: DocumentTemplate[] = []\n  const year = new Date().getFullYear()\n  \n  // 1040-ES for each quarter\n  for (let q = 1; q <= 4; q++) {\n    docs.push({\n      id: `1040es-q${q}`,\n      title: `1040-ES Voucher — Q${q} ${year}`,\n      description: `Estimated tax payment worksheet for Quarter ${q}`,\n      type: 'voucher',\n      category: 'tax',\n      generator: (s) => generate1040ES(s, q as 1 | 2 | 3 | 4),\n    })\n  }\n  \n  // Audit checklist\n  docs.push({\n    id: 'audit-checklist',\n    title: 'Audit Preparedness Checklist',\n    description: 'Complete documentation checklist based on your deductions and entity structure',\n    type: 'checklist',\n    category: 'audit',\n    generator: generateAuditChecklist,\n  })\n  \n  // CPA package\n  docs.push({\n    id: 'cpa-package',\n    title: 'CPA Strategy Handoff',\n    description: 'Comprehensive financial analysis package for your tax professional',\n    type: 'report',\n    category: 'cpa',\n    generator: generateCPAPackage,\n  })\n  \n  // Entity formation checklists\n  const entityTypes = ['llc', 'llc_scorp'] as const\n  for (const type of entityTypes) {\n    docs.push({\n      id: `formation-${type}`,\n      title: `${type.replace('_', ' ').toUpperCase()} Formation Checklist`,\n      description: `Step-by-step guide for forming a ${type.replace('_', ' ').toUpperCase()} in ${state.profile.state}`,\n      type: 'checklist',\n      category: 'entity',\n      generator: (s) => generateEntityFormationChecklist(type, s.profile.state),\n    })\n  }\n  \n  return docs\n}\n\n// ==================== Utilities ====================\n\nfunction formatFilingStatus(status: string): string {\n  const map: Record<string, string> = {\n    single: 'Single',\n    married_joint: 'Married Filing Jointly',\n    married_separate: 'Married Filing Separately',\n    head_of_household: 'Head of Household',\n  }\n  return map[status] || status\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\document-vault.ts","messages":[{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":175,"column":16,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":175,"endColumn":17,"suggestions":[{"messageId":"removeEscape","fix":{"range":[7013,7014],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[7013,7013],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\-.","line":175,"column":18,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":175,"endColumn":19,"suggestions":[{"messageId":"removeEscape","fix":{"range":[7015,7016],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[7015,7015],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":175,"column":31,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":175,"endColumn":32,"suggestions":[{"messageId":"removeEscape","fix":{"range":[7028,7029],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[7028,7028],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\-.","line":175,"column":33,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":175,"endColumn":34,"suggestions":[{"messageId":"removeEscape","fix":{"range":[7030,7031],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[7030,7030],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":176,"column":14,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":176,"endColumn":15,"suggestions":[{"messageId":"removeEscape","fix":{"range":[7083,7084],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[7083,7083],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\-.","line":176,"column":16,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":176,"endColumn":17,"suggestions":[{"messageId":"removeEscape","fix":{"range":[7085,7086],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[7085,7085],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":176,"column":29,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":176,"endColumn":30,"suggestions":[{"messageId":"removeEscape","fix":{"range":[7098,7099],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[7098,7098],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\-.","line":176,"column":31,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":176,"endColumn":32,"suggestions":[{"messageId":"removeEscape","fix":{"range":[7100,7101],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[7100,7100],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":458,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":458,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":497,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":497,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18342,18345],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18342,18345],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":10,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE — Document Vault v1\n * \n * Secure document storage and organization:\n *   - Receipt/invoice upload with preview\n *   - Automatic categorization by type\n *   - Tax-relevant metadata extraction\n *   - Schedule C expense line mapping\n *   - Audit-ready folder structure\n *   - Search across all documents\n *   - Retention policy management\n *   - Export for CPA handoff\n */\n\n// ─── Types ──────────────────────────────────────────────────────────────────\n\nexport interface VaultDocument {\n  id: string\n  filename: string\n  mimeType: string\n  sizeBytes: number\n  thumbnailDataUrl?: string   // base64 preview\n  fullDataUrl?: string        // base64 full (for small files)\n  category: DocumentCategory\n  subcategory: string\n  taxYear: number\n  amount?: number\n  vendor?: string\n  date?: string               // transaction date\n  uploadDate: string\n  description: string\n  tags: string[]\n  scheduleCLine?: string      // e.g., \"18\" for office expense\n  isDeductible: boolean\n  deductionType?: 'business' | 'medical' | 'charitable' | 'education' | 'other'\n  ocrText?: string            // extracted text\n  notes: string\n  archived: boolean\n}\n\nexport type DocumentCategory =\n  | 'receipt'\n  | 'invoice'\n  | 'tax_form'\n  | 'bank_statement'\n  | 'contract'\n  | 'insurance'\n  | 'medical'\n  | 'property'\n  | 'vehicle'\n  | 'home_office'\n  | 'education'\n  | 'charitable'\n  | 'retirement'\n  | 'crypto'\n  | 'other'\n\nexport interface VaultFolder {\n  name: string\n  category: DocumentCategory\n  icon: string\n  count: number\n  totalAmount: number\n}\n\nexport interface VaultStats {\n  totalDocuments: number\n  totalSize: number\n  byCategory: Record<DocumentCategory, number>\n  byYear: Record<number, number>\n  totalDeductibleAmount: number\n  untaggedCount: number\n}\n\nexport interface VaultSearchResult {\n  document: VaultDocument\n  matchScore: number\n  matchedFields: string[]\n}\n\n// ─── Category Metadata ──────────────────────────────────────────────────────\n\nexport const CATEGORY_META: Record<DocumentCategory, { label: string; icon: string; scheduleCLines: string[]; retentionYears: number }> = {\n  receipt:        { label: 'Receipts',          icon: '🧾', scheduleCLines: ['8','9','10','17','18','21','22','25','27a'], retentionYears: 7 },\n  invoice:        { label: 'Invoices',          icon: '📄', scheduleCLines: ['1'],           retentionYears: 7 },\n  tax_form:       { label: 'Tax Forms',         icon: '📋', scheduleCLines: [],              retentionYears: 7 },\n  bank_statement: { label: 'Bank Statements',   icon: '🏦', scheduleCLines: [],              retentionYears: 7 },\n  contract:       { label: 'Contracts',         icon: '📝', scheduleCLines: ['11','17'],     retentionYears: 10 },\n  insurance:      { label: 'Insurance',         icon: '🛡️', scheduleCLines: ['15'],          retentionYears: 7 },\n  medical:        { label: 'Medical',           icon: '🏥', scheduleCLines: [],              retentionYears: 7 },\n  property:       { label: 'Property',          icon: '🏠', scheduleCLines: ['20b','13'],    retentionYears: 10 },\n  vehicle:        { label: 'Vehicle',           icon: '🚗', scheduleCLines: ['9'],           retentionYears: 7 },\n  home_office:    { label: 'Home Office',       icon: '🖥️', scheduleCLines: ['30'],          retentionYears: 7 },\n  education:      { label: 'Education',         icon: '🎓', scheduleCLines: [],              retentionYears: 7 },\n  charitable:     { label: 'Charitable',        icon: '💝', scheduleCLines: [],              retentionYears: 7 },\n  retirement:     { label: 'Retirement',        icon: '🏦', scheduleCLines: ['19'],          retentionYears: 10 },\n  crypto:         { label: 'Crypto Records',    icon: '₿', scheduleCLines: [],              retentionYears: 7 },\n  other:          { label: 'Other',             icon: '📁', scheduleCLines: [],              retentionYears: 7 },\n}\n\n// ─── Auto-Categorization ────────────────────────────────────────────────────\n\nconst CATEGORY_KEYWORDS: [DocumentCategory, RegExp][] = [\n  ['tax_form', /\\b(W-?2|1099|1040|Schedule\\s*[A-Z]|K-?1|8949|5498|1095)\\b/i],\n  ['receipt', /\\b(receipt|purchase|order|transaction|paid|amount due)\\b/i],\n  ['invoice', /\\b(invoice|bill|statement.*due|amount owed|pay by)\\b/i],\n  ['bank_statement', /\\b(bank statement|account summary|beginning balance|ending balance)\\b/i],\n  ['insurance', /\\b(insurance|policy|premium|coverage|deductible|claim)\\b/i],\n  ['medical', /\\b(medical|health|doctor|hospital|pharmacy|prescription|copay|diagnosis)\\b/i],\n  ['vehicle', /\\b(auto|vehicle|car|mileage|gas|fuel|oil change|repair.*vehicle)\\b/i],\n  ['home_office', /\\b(home office|internet bill|utility|electric|water bill)\\b/i],\n  ['property', /\\b(property tax|mortgage|deed|lease|rent.*office|real estate)\\b/i],\n  ['charitable', /\\b(donation|charitable|501\\(c\\)|tax.?deductible.*contribution|nonprofit)\\b/i],\n  ['education', /\\b(tuition|course|certification|training|conference|seminar|1098-T)\\b/i],\n  ['retirement', /\\b(401k|IRA|pension|retirement|contribution.*retirement|5500)\\b/i],\n  ['crypto', /\\b(bitcoin|ethereum|crypto|blockchain|wallet|exchange|staking|airdrop|token)\\b/i],\n  ['contract', /\\b(agreement|contract|terms|engagement letter|scope of work|NDA)\\b/i],\n]\n\nexport function autoCategorizeDcoument(filename: string, ocrText?: string): { category: DocumentCategory; confidence: number } {\n  const text = `${filename} ${ocrText || ''}`.toLowerCase()\n  \n  for (const [category, pattern] of CATEGORY_KEYWORDS) {\n    if (pattern.test(text)) {\n      return { category, confidence: 75 }\n    }\n  }\n\n  // File extension hints\n  if (filename.match(/\\.(pdf|PDF)$/)) return { category: 'other', confidence: 30 }\n  if (filename.match(/\\.(jpg|jpeg|png|webp|heic)/i)) return { category: 'receipt', confidence: 40 }\n\n  return { category: 'other', confidence: 10 }\n}\n\n// ─── Amount Extraction ──────────────────────────────────────────────────────\n\nexport function extractAmount(text: string): number | null {\n  // Look for total/amount patterns\n  const patterns = [\n    /(?:total|amount|due|paid|charge|grand total|balance)[\\s:]*\\$?\\s*([\\d,]+\\.?\\d{0,2})/i,\n    /\\$\\s*([\\d,]+\\.\\d{2})/,\n  ]\n  \n  for (const pattern of patterns) {\n    const match = text.match(pattern)\n    if (match) {\n      const num = parseFloat(match[1].replace(/,/g, ''))\n      if (!isNaN(num) && num > 0 && num < 10000000) return num\n    }\n  }\n  return null\n}\n\n// ─── Vendor Extraction ──────────────────────────────────────────────────────\n\nexport function extractVendor(text: string): string | null {\n  // Look for common vendor patterns\n  const patterns = [\n    /(?:from|merchant|vendor|payee|company)[\\s:]*([A-Z][\\w\\s&.,'-]{2,40})/i,\n    /^([A-Z][\\w\\s&.,'-]{2,30})\\s*(?:\\n|receipt|invoice|statement)/im,\n  ]\n  \n  for (const pattern of patterns) {\n    const match = text.match(pattern)\n    if (match) return match[1].trim()\n  }\n  return null\n}\n\n// ─── Date Extraction ────────────────────────────────────────────────────────\n\nexport function extractDate(text: string): string | null {\n  const patterns = [\n    /(\\d{1,2})[\\/\\-](\\d{1,2})[\\/\\-](\\d{4})/,              // MM/DD/YYYY\n    /(\\d{4})[\\/\\-](\\d{1,2})[\\/\\-](\\d{1,2})/,              // YYYY-MM-DD\n    /(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\\w*\\s+(\\d{1,2}),?\\s+(\\d{4})/i,\n  ]\n\n  for (const pattern of patterns) {\n    const match = text.match(pattern)\n    if (match) {\n      try {\n        const d = new Date(match[0])\n        if (!isNaN(d.getTime())) return d.toISOString().split('T')[0]\n      } catch { /* continue */ }\n    }\n  }\n  return null\n}\n\n// ─── Document Vault Manager ─────────────────────────────────────────────────\n\nconst VAULT_STORAGE_KEY = 'fortuna:document-vault'\n\nexport class DocumentVault {\n  private documents: VaultDocument[] = []\n\n  constructor() {\n    this.load()\n  }\n\n  // ─── CRUD ─────────────────────────────────────────────────────────\n\n  async addDocument(file: File, overrides?: Partial<VaultDocument>): Promise<VaultDocument> {\n    const dataUrl = await this.fileToDataUrl(file)\n    const thumbnail = file.type.startsWith('image/') ? await this.generateThumbnail(dataUrl) : undefined\n\n    // Extract text for categorization (images would need OCR - placeholder)\n    const ocrText = overrides?.ocrText || ''\n    const { category, confidence } = autoCategorizeDcoument(file.name, ocrText)\n    const amount = extractAmount(ocrText)\n    const vendor = extractVendor(ocrText)\n    const date = extractDate(ocrText)\n\n    const doc: VaultDocument = {\n      id: 'doc_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5),\n      filename: file.name,\n      mimeType: file.type,\n      sizeBytes: file.size,\n      thumbnailDataUrl: thumbnail,\n      fullDataUrl: file.size < 5 * 1024 * 1024 ? dataUrl : undefined, // store < 5MB inline\n      category: overrides?.category || category,\n      subcategory: overrides?.subcategory || '',\n      taxYear: overrides?.taxYear || new Date().getFullYear(),\n      amount: overrides?.amount ?? amount ?? undefined,\n      vendor: overrides?.vendor ?? vendor ?? undefined,\n      date: overrides?.date ?? date ?? undefined,\n      uploadDate: new Date().toISOString(),\n      description: overrides?.description || file.name,\n      tags: overrides?.tags || [],\n      scheduleCLine: overrides?.scheduleCLine,\n      isDeductible: overrides?.isDeductible ?? (confidence > 50),\n      deductionType: overrides?.deductionType,\n      ocrText,\n      notes: overrides?.notes || '',\n      archived: false,\n    }\n\n    this.documents.push(doc)\n    this.save()\n    return doc\n  }\n\n  updateDocument(id: string, updates: Partial<VaultDocument>) {\n    const idx = this.documents.findIndex(d => d.id === id)\n    if (idx >= 0) {\n      this.documents[idx] = { ...this.documents[idx], ...updates }\n      this.save()\n    }\n  }\n\n  deleteDocument(id: string) {\n    this.documents = this.documents.filter(d => d.id !== id)\n    this.save()\n  }\n\n  getDocument(id: string): VaultDocument | undefined {\n    return this.documents.find(d => d.id === id)\n  }\n\n  getAllDocuments(): VaultDocument[] {\n    return [...this.documents].sort((a, b) => b.uploadDate.localeCompare(a.uploadDate))\n  }\n\n  // ─── Search ───────────────────────────────────────────────────────\n\n  search(query: string): VaultSearchResult[] {\n    const terms = query.toLowerCase().split(/\\s+/)\n    \n    return this.documents\n      .map(doc => {\n        let matchScore = 0\n        const matchedFields: string[] = []\n        const searchable = [\n          doc.filename, doc.description, doc.vendor || '', doc.notes,\n          doc.ocrText || '', doc.tags.join(' '), doc.category,\n        ].join(' ').toLowerCase()\n\n        for (const term of terms) {\n          if (searchable.includes(term)) {\n            matchScore += 10\n            if (doc.filename.toLowerCase().includes(term)) matchedFields.push('filename')\n            if (doc.vendor?.toLowerCase().includes(term)) matchedFields.push('vendor')\n            if (doc.description.toLowerCase().includes(term)) matchedFields.push('description')\n            if (doc.ocrText?.toLowerCase().includes(term)) matchedFields.push('content')\n          }\n        }\n\n        return { document: doc, matchScore, matchedFields }\n      })\n      .filter(r => r.matchScore > 0)\n      .sort((a, b) => b.matchScore - a.matchScore)\n  }\n\n  // ─── Filtering ────────────────────────────────────────────────────\n\n  getByCategory(category: DocumentCategory): VaultDocument[] {\n    return this.documents.filter(d => d.category === category && !d.archived)\n  }\n\n  getByYear(year: number): VaultDocument[] {\n    return this.documents.filter(d => d.taxYear === year && !d.archived)\n  }\n\n  getDeductibleDocuments(year: number): VaultDocument[] {\n    return this.documents.filter(d => d.isDeductible && d.taxYear === year && !d.archived)\n  }\n\n  getByScheduleCLine(line: string): VaultDocument[] {\n    return this.documents.filter(d => d.scheduleCLine === line && !d.archived)\n  }\n\n  // ─── Stats ────────────────────────────────────────────────────────\n\n  getStats(): VaultStats {\n    const active = this.documents.filter(d => !d.archived)\n    const byCategory: Record<string, number> = {}\n    const byYear: Record<number, number> = {}\n    let totalDeductible = 0\n    let untagged = 0\n\n    for (const doc of active) {\n      byCategory[doc.category] = (byCategory[doc.category] || 0) + 1\n      byYear[doc.taxYear] = (byYear[doc.taxYear] || 0) + 1\n      if (doc.isDeductible && doc.amount) totalDeductible += doc.amount\n      if (doc.tags.length === 0 && doc.category === 'other') untagged++\n    }\n\n    return {\n      totalDocuments: active.length,\n      totalSize: active.reduce((s, d) => s + d.sizeBytes, 0),\n      byCategory: byCategory as Record<DocumentCategory, number>,\n      byYear,\n      totalDeductibleAmount: totalDeductible,\n      untaggedCount: untagged,\n    }\n  }\n\n  // ─── Folders View ─────────────────────────────────────────────────\n\n  getFolders(year?: number): VaultFolder[] {\n    const docs = year ? this.getByYear(year) : this.documents.filter(d => !d.archived)\n    const folders: Record<string, VaultFolder> = {}\n\n    for (const [cat, meta] of Object.entries(CATEGORY_META)) {\n      const catDocs = docs.filter(d => d.category === cat)\n      if (catDocs.length > 0 || ['receipt', 'tax_form', 'invoice'].includes(cat)) {\n        folders[cat] = {\n          name: meta.label,\n          category: cat as DocumentCategory,\n          icon: meta.icon,\n          count: catDocs.length,\n          totalAmount: catDocs.reduce((s, d) => s + (d.amount || 0), 0),\n        }\n      }\n    }\n\n    return Object.values(folders).sort((a, b) => b.count - a.count)\n  }\n\n  // ─── Audit Export ─────────────────────────────────────────────────\n\n  generateAuditReport(year: number): string {\n    const docs = this.getByYear(year)\n    const lines: string[] = [\n      `FORTUNA ENGINE — DOCUMENT VAULT AUDIT REPORT`,\n      `Tax Year: ${year}`,\n      `Generated: ${new Date().toISOString()}`,\n      `Total Documents: ${docs.length}`,\n      ``,\n    ]\n\n    // Group by category\n    for (const [cat, meta] of Object.entries(CATEGORY_META)) {\n      const catDocs = docs.filter(d => d.category === cat)\n      if (catDocs.length === 0) continue\n\n      lines.push(`═══ ${meta.icon} ${meta.label} (${catDocs.length} documents) ═══`)\n      const total = catDocs.reduce((s, d) => s + (d.amount || 0), 0)\n      if (total > 0) lines.push(`    Total Amount: $${total.toLocaleString()}`)\n\n      for (const doc of catDocs.sort((a, b) => (a.date || '').localeCompare(b.date || ''))) {\n        lines.push(`  • ${doc.filename}`)\n        if (doc.date) lines.push(`    Date: ${doc.date}`)\n        if (doc.vendor) lines.push(`    Vendor: ${doc.vendor}`)\n        if (doc.amount) lines.push(`    Amount: $${doc.amount.toLocaleString()}`)\n        if (doc.scheduleCLine) lines.push(`    Schedule C Line: ${doc.scheduleCLine}`)\n        if (doc.notes) lines.push(`    Notes: ${doc.notes}`)\n        lines.push('')\n      }\n    }\n\n    // Schedule C summary\n    const schedCDocs = docs.filter(d => d.scheduleCLine && d.isDeductible)\n    if (schedCDocs.length > 0) {\n      lines.push(`═══ SCHEDULE C EXPENSE DOCUMENTATION ═══`)\n      const byLine: Record<string, VaultDocument[]> = {}\n      for (const d of schedCDocs) {\n        const line = d.scheduleCLine!\n        if (!byLine[line]) byLine[line] = []\n        byLine[line].push(d)\n      }\n      for (const [line, lineDocs] of Object.entries(byLine).sort()) {\n        const total = lineDocs.reduce((s, d) => s + (d.amount || 0), 0)\n        lines.push(`  Line ${line}: ${lineDocs.length} documents, $${total.toLocaleString()}`)\n      }\n    }\n\n    return lines.join('\\n')\n  }\n\n  // ─── Retention Check ──────────────────────────────────────────────\n\n  getExpiredDocuments(): VaultDocument[] {\n    const now = new Date()\n    return this.documents.filter(d => {\n      const retention = CATEGORY_META[d.category]?.retentionYears || 7\n      const expiry = new Date(d.uploadDate)\n      expiry.setFullYear(expiry.getFullYear() + retention)\n      return now > expiry\n    })\n  }\n\n  // ─── Helpers ──────────────────────────────────────────────────────\n\n  private async fileToDataUrl(file: File): Promise<string> {\n    return new Promise((resolve, reject) => {\n      const reader = new FileReader()\n      reader.onload = () => resolve(reader.result as string)\n      reader.onerror = () => reject(new Error('File read failed'))\n      reader.readAsDataURL(file)\n    })\n  }\n\n  private async generateThumbnail(dataUrl: string, maxSize: number = 200): Promise<string> {\n    return new Promise((resolve) => {\n      const img = new Image()\n      img.onload = () => {\n        const canvas = document.createElement('canvas')\n        const scale = Math.min(maxSize / img.width, maxSize / img.height, 1)\n        canvas.width = img.width * scale\n        canvas.height = img.height * scale\n        const ctx = canvas.getContext('2d')!\n        ctx.drawImage(img, 0, 0, canvas.width, canvas.height)\n        resolve(canvas.toDataURL('image/jpeg', 0.7))\n      }\n      img.onerror = () => resolve('')\n      img.src = dataUrl\n    })\n  }\n\n  private save() {\n    try {\n      // Don't store fullDataUrl in localStorage (too large)\n      const forStorage = this.documents.map(d => ({ ...d, fullDataUrl: undefined }))\n      localStorage.setItem(VAULT_STORAGE_KEY, JSON.stringify(forStorage))\n    } catch (e) {\n      console.warn('[Vault] Storage quota exceeded — consider archiving old documents')\n    }\n  }\n\n  private load() {\n    try {\n      const raw = localStorage.getItem(VAULT_STORAGE_KEY)\n      if (raw) this.documents = JSON.parse(raw)\n    } catch { this.documents = [] }\n  }\n}\n\n// ─── Type Adapters: VaultDocument ↔ DocumentRecord ──────────────────────────\n\nimport type { DocumentRecord } from './storage'\n\nconst CATEGORY_TO_DOC_TYPE: Record<string, DocumentRecord['type']> = {\n  income: '1099',\n  w2: 'w2',\n  receipt: 'receipt',\n  contract: 'contract',\n  tax_return: 'tax_return',\n  bank: 'bank_statement',\n  invoice: 'invoice',\n}\n\n/** Convert VaultDocument → storable DocumentRecord */\nexport function vaultDocToRecord(doc: VaultDocument): DocumentRecord {\n  return {\n    id: doc.id,\n    name: doc.filename,\n    type: CATEGORY_TO_DOC_TYPE[doc.category] || 'other',\n    category: doc.subcategory || doc.category,\n    uploadDate: doc.uploadDate,\n    fileSize: doc.sizeBytes,\n    mimeType: doc.mimeType,\n    storageKey: doc.id,\n    notes: doc.description,\n    entityId: (doc as any).entityId || 'personal',\n    memberId: 'primary',\n    taxYear: doc.taxYear,\n    tags: doc.tags,\n  }\n}\n\n/** Convert DocumentRecord → VaultDocument (for vault operations) */\nexport function recordToVaultDoc(record: DocumentRecord): Partial<VaultDocument> {\n  const reverseMap: Record<string, DocumentCategory> = {\n    '1099': 'income',\n    w2: 'income',\n    receipt: 'expense',\n    contract: 'legal',\n    tax_return: 'tax',\n    bank_statement: 'bank',\n    invoice: 'expense',\n    other: 'other',\n  }\n  return {\n    id: record.id,\n    filename: record.name,\n    mimeType: record.mimeType || 'application/octet-stream',\n    sizeBytes: record.fileSize || 0,\n    category: reverseMap[record.type] || 'other' as DocumentCategory,\n    subcategory: record.category || '',\n    taxYear: record.taxYear || new Date().getFullYear(),\n    uploadDate: record.uploadDate,\n    description: record.notes || '',\n    tags: record.tags || [],\n  }\n}\n\n/** Sync vault documents → FortunaState.documents[] */\nexport function syncVaultToState(vault: DocumentVault): DocumentRecord[] {\n  return vault.getAllDocuments().map(vaultDocToRecord)\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\entity-optimizer.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Entity' is defined but never used.","line":14,"column":43,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":49,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Entity"},"fix":{"range":[477,485],"text":""},"desc":"Remove unused variable \"Entity\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'generateTaxReport' is defined but never used.","line":15,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":27,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"generateTaxReport"},"fix":{"range":[514,532],"text":""},"desc":"Remove unused variable \"generateTaxReport\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'calculateSCorpSavings' is defined but never used.","line":15,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":50,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"calculateSCorpSavings"},"fix":{"range":[531,554],"text":""},"desc":"Remove unused variable \"calculateSCorpSavings\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ssWageBase2024' is assigned a value but never used.","line":108,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":108,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'wageBase' is assigned a value but never used.","line":110,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":110,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'status' is defined but never used.","line":426,"column":51,"nodeType":"Identifier","messageId":"unusedVar","endLine":426,"endColumn":57}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE v6 — Multi-Entity Optimizer\n * \n * Automatically models the optimal number and type of business entities\n * for any given income mix. Handles:\n * - S-Corp reasonable salary determination\n * - Entity arbitrage (splitting income across entities)\n * - Compliance cost-benefit breakeven analysis\n * - Pass-through tax calculations\n * - Self-employment tax optimization\n * - State-specific formation considerations\n */\n\nimport type { FortunaState, IncomeStream, Entity } from './storage'\nimport { generateTaxReport, calculateSCorpSavings, calculateSelfEmploymentTax } from './tax-calculator'\n\n// ─── Types ───────────────────────────────────────────────────────────────\n\nexport type EntityType = 'sole_prop' | 'llc_disregarded' | 'llc_scorp' | 'scorp' | 'ccorp'\n\nexport interface EntityConfig {\n  type: EntityType\n  name: string\n  allocatedIncome: number\n  reasonableSalary?: number\n  distributions?: number\n  annualComplianceCost: number\n  setupCost: number\n}\n\nexport interface EntityScenario {\n  id: string\n  label: string\n  description: string\n  entities: EntityConfig[]\n  totalIncome: number\n  totalSETax: number\n  totalIncomeTax: number\n  totalComplianceCost: number\n  totalTaxBurden: number\n  netSavings: number\n  breakEvenMonths: number\n  isRecommended: boolean\n  reasoning: string\n  pros: string[]\n  cons: string[]\n}\n\nexport interface ReasonableSalaryAnalysis {\n  income: number\n  recommendedSalary: number\n  salaryRange: { min: number; max: number }\n  distributions: number\n  seTaxOnSalary: number\n  seTaxSavings: number\n  methodology: string\n  riskLevel: 'low' | 'moderate' | 'high'\n  riskNotes: string\n}\n\nexport interface EntityOptimizerResult {\n  scenarios: EntityScenario[]\n  recommended: EntityScenario\n  currentScenario: EntityScenario\n  salaryAnalysis: ReasonableSalaryAnalysis | null\n  breakEvenIncome: number\n  maxSavings: number\n  summary: string\n}\n\n// ─── Reasonable Salary Calculator ───────────────────────────────────────\n\nconst INDUSTRY_SALARY_MULTIPLIERS: Record<string, { min: number; max: number }> = {\n  consulting: { min: 0.40, max: 0.65 },\n  freelance: { min: 0.35, max: 0.55 },\n  ecommerce: { min: 0.30, max: 0.50 },\n  saas: { min: 0.35, max: 0.55 },\n  creative: { min: 0.35, max: 0.55 },\n  professional: { min: 0.45, max: 0.70 },\n  default: { min: 0.40, max: 0.60 },\n}\n\nexport function calculateReasonableSalary(\n  netIncome: number,\n  industryType: string = 'default',\n  hoursPerWeek: number = 40,\n): ReasonableSalaryAnalysis {\n  const multipliers = INDUSTRY_SALARY_MULTIPLIERS[industryType] || INDUSTRY_SALARY_MULTIPLIERS.default\n\n  // IRS guidance: salary must be \"reasonable\" — comparable to what you'd pay someone else\n  // Factor in: income level, industry, hours worked, complexity\n  const minSalary = Math.max(\n    netIncome * multipliers.min,\n    Math.min(40000, netIncome * 0.8) // Absolute floor unless income is very low\n  )\n  const maxSalary = Math.min(\n    netIncome * multipliers.max,\n    netIncome * 0.85 // Never above 85% — must have some distribution benefit\n  )\n\n  // Hours-adjusted: part-time reduces the reasonable salary\n  const hoursFactor = Math.min(hoursPerWeek / 40, 1.2)\n  let recommendedSalary = Math.round(((minSalary + maxSalary) / 2) * hoursFactor)\n  recommendedSalary = Math.max(recommendedSalary, Math.min(30000, netIncome * 0.5))\n  recommendedSalary = Math.min(recommendedSalary, netIncome)\n\n  // Social Security wage base caps the employer FICA benefit\n  const ssWageBase2024 = 168600\n  const ssWageBase2025 = 176100\n  const wageBase = ssWageBase2025\n\n  const distributions = Math.max(0, netIncome - recommendedSalary)\n  const seTaxOnSalary = recommendedSalary * 0.153 // Both halves of FICA\n  const fullSETax = calculateSelfEmploymentTax(netIncome).total\n  const seTaxSavings = fullSETax - seTaxOnSalary\n\n  // Risk assessment\n  const salaryRatio = recommendedSalary / netIncome\n  let riskLevel: 'low' | 'moderate' | 'high' = 'low'\n  let riskNotes = ''\n  if (salaryRatio < 0.35) {\n    riskLevel = 'high'\n    riskNotes = `Salary is only ${Math.round(salaryRatio * 100)}% of net income — IRS may challenge as unreasonably low.`\n  } else if (salaryRatio < 0.45) {\n    riskLevel = 'moderate'\n    riskNotes = `Salary at ${Math.round(salaryRatio * 100)}% is defensible but may attract scrutiny on audit.`\n  } else {\n    riskNotes = `Salary at ${Math.round(salaryRatio * 100)}% of income is well within safe harbor range.`\n  }\n\n  return {\n    income: netIncome,\n    recommendedSalary,\n    salaryRange: { min: Math.round(minSalary), max: Math.round(maxSalary) },\n    distributions,\n    seTaxOnSalary: Math.round(seTaxOnSalary),\n    seTaxSavings: Math.round(seTaxSavings),\n    methodology: `Based on ${industryType} industry benchmarks, ${hoursPerWeek}hrs/wk commitment, and IRS reasonable compensation standards. Range: $${Math.round(minSalary).toLocaleString()} – $${Math.round(maxSalary).toLocaleString()}.`,\n    riskLevel,\n    riskNotes,\n  }\n}\n\n// ─── Compliance Cost Estimator ──────────────────────────────────────────\n\ninterface ComplianceCosts {\n  formation: number\n  annualStateFiling: number\n  payrollService: number\n  taxPreparation: number\n  registeredAgent: number\n  annualTotal: number\n  description: string\n}\n\nfunction estimateComplianceCosts(entityType: EntityType, state: string): ComplianceCosts {\n  const stateFilingCosts: Record<string, number> = {\n    'CA': 800, 'NY': 200, 'TX': 300, 'FL': 150, 'IL': 75,\n    'MA': 500, 'NJ': 125, 'PA': 70, 'OH': 99, 'WA': 60,\n    'DEFAULT': 100,\n  }\n\n  const stateFee = stateFilingCosts[state] || stateFilingCosts.DEFAULT\n\n  switch (entityType) {\n    case 'sole_prop':\n      return {\n        formation: 0, annualStateFiling: 0, payrollService: 0,\n        taxPreparation: 200, registeredAgent: 0,\n        annualTotal: 200,\n        description: 'Minimal compliance — Schedule C on personal return',\n      }\n    case 'llc_disregarded':\n      return {\n        formation: 150, annualStateFiling: stateFee, payrollService: 0,\n        taxPreparation: 400, registeredAgent: 125,\n        annualTotal: stateFee + 525,\n        description: `LLC formation + annual ${state} filing + registered agent`,\n      }\n    case 'llc_scorp':\n    case 'scorp':\n      return {\n        formation: 300, annualStateFiling: stateFee, payrollService: 1200,\n        taxPreparation: 1500, registeredAgent: 125,\n        annualTotal: stateFee + 2825,\n        description: `S-Corp election requires payroll ($100/mo), separate tax return (Form 1120-S), ${state} annual filing`,\n      }\n    case 'ccorp':\n      return {\n        formation: 400, annualStateFiling: stateFee, payrollService: 1200,\n        taxPreparation: 2000, registeredAgent: 125,\n        annualTotal: stateFee + 3325,\n        description: `C-Corp double taxation structure — payroll, corporate return (Form 1120), state filing`,\n      }\n    default:\n      return { formation: 0, annualStateFiling: 0, payrollService: 0, taxPreparation: 200, registeredAgent: 0, annualTotal: 200, description: '' }\n  }\n}\n\n// ─── Scenario Builder ───────────────────────────────────────────────────\n\nfunction buildSolePropScenario(\n  netIncome: number,\n  state: string,\n): EntityScenario {\n  const seTax = calculateSelfEmploymentTax(netIncome).total\n  const compliance = estimateComplianceCosts('sole_prop', state)\n  const incomeTax = estimateIncomeTax(netIncome, 'single') // simplified\n\n  return {\n    id: 'sole_prop',\n    label: 'Sole Proprietorship',\n    description: 'Default structure — no entity formation required',\n    entities: [{\n      type: 'sole_prop',\n      name: 'Personal (Schedule C)',\n      allocatedIncome: netIncome,\n      annualComplianceCost: compliance.annualTotal,\n      setupCost: 0,\n    }],\n    totalIncome: netIncome,\n    totalSETax: Math.round(seTax),\n    totalIncomeTax: Math.round(incomeTax),\n    totalComplianceCost: compliance.annualTotal,\n    totalTaxBurden: Math.round(seTax + incomeTax + compliance.annualTotal),\n    netSavings: 0,\n    breakEvenMonths: 0,\n    isRecommended: false,\n    reasoning: 'Simplest structure with no formation costs. All income subject to SE tax.',\n    pros: [\n      'Zero formation cost or complexity',\n      'Minimal record-keeping requirements',\n      'Easy to start and stop',\n      'All business losses deductible on personal return',\n    ],\n    cons: [\n      'Full self-employment tax on all net income',\n      'No asset protection',\n      'Limited credibility with some clients',\n      'No income-splitting opportunity',\n    ],\n  }\n}\n\nfunction buildLLCScenario(\n  netIncome: number,\n  state: string,\n): EntityScenario {\n  const seTax = calculateSelfEmploymentTax(netIncome).total\n  const compliance = estimateComplianceCosts('llc_disregarded', state)\n  const incomeTax = estimateIncomeTax(netIncome, 'single')\n\n  return {\n    id: 'llc_disregarded',\n    label: 'LLC (Disregarded Entity)',\n    description: 'Asset protection without tax benefit — same tax treatment as sole prop',\n    entities: [{\n      type: 'llc_disregarded',\n      name: 'LLC',\n      allocatedIncome: netIncome,\n      annualComplianceCost: compliance.annualTotal,\n      setupCost: compliance.formation,\n    }],\n    totalIncome: netIncome,\n    totalSETax: Math.round(seTax),\n    totalIncomeTax: Math.round(incomeTax),\n    totalComplianceCost: compliance.annualTotal,\n    totalTaxBurden: Math.round(seTax + incomeTax + compliance.annualTotal),\n    netSavings: 0,\n    breakEvenMonths: 0,\n    isRecommended: false,\n    reasoning: 'Provides liability protection but identical tax treatment to sole proprietorship. Same SE tax applies.',\n    pros: [\n      'Personal asset protection',\n      'Professional credibility',\n      'Flexible management structure',\n      'Can elect S-Corp status later',\n    ],\n    cons: [\n      'Annual state filing fees',\n      'No SE tax savings',\n      'Additional record-keeping',\n      `$${compliance.annualTotal}/yr in compliance costs`,\n    ],\n  }\n}\n\nfunction buildSCorpScenario(\n  netIncome: number,\n  state: string,\n  salary?: number,\n): EntityScenario {\n  const salaryAnalysis = calculateReasonableSalary(netIncome)\n  const actualSalary = salary || salaryAnalysis.recommendedSalary\n  const distributions = netIncome - actualSalary\n  const compliance = estimateComplianceCosts('llc_scorp', state)\n\n  // S-Corp: FICA only on salary, not distributions\n  const ficaOnSalary = actualSalary * 0.153\n  const fullSETax = calculateSelfEmploymentTax(netIncome).total\n  const seTaxSavings = fullSETax - ficaOnSalary\n\n  const incomeTax = estimateIncomeTax(netIncome, 'single')\n\n  // Net savings after compliance costs\n  const netAnnualSavings = seTaxSavings - compliance.annualTotal\n  const breakEvenMonths = netAnnualSavings > 0\n    ? Math.ceil(compliance.formation / (netAnnualSavings / 12))\n    : Infinity\n\n  return {\n    id: 'scorp',\n    label: 'S-Corp (LLC + S Election)',\n    description: `Split income: $${actualSalary.toLocaleString()} salary + $${distributions.toLocaleString()} distributions`,\n    entities: [{\n      type: 'llc_scorp',\n      name: 'S-Corporation',\n      allocatedIncome: netIncome,\n      reasonableSalary: actualSalary,\n      distributions,\n      annualComplianceCost: compliance.annualTotal,\n      setupCost: compliance.formation,\n    }],\n    totalIncome: netIncome,\n    totalSETax: Math.round(ficaOnSalary),\n    totalIncomeTax: Math.round(incomeTax),\n    totalComplianceCost: compliance.annualTotal,\n    totalTaxBurden: Math.round(ficaOnSalary + incomeTax + compliance.annualTotal),\n    netSavings: Math.round(Math.max(0, netAnnualSavings)),\n    breakEvenMonths: isFinite(breakEvenMonths) ? breakEvenMonths : 999,\n    isRecommended: false,\n    reasoning: `S-Corp election saves $${Math.round(seTaxSavings).toLocaleString()}/yr in SE tax by splitting income. After $${compliance.annualTotal.toLocaleString()}/yr compliance costs, net savings are $${Math.round(netAnnualSavings).toLocaleString()}/yr. ${netAnnualSavings > 0 ? `Pays for itself in ${breakEvenMonths} months.` : 'Compliance costs exceed tax savings at this income level.'}`,\n    pros: [\n      `$${Math.round(Math.max(0, seTaxSavings)).toLocaleString()}/yr SE tax reduction`,\n      'Asset protection via LLC',\n      'Salary enables W-2, improving mortgage/credit applications',\n      'Retirement plan contributions based on salary',\n      netAnnualSavings > 0 ? `Net $${Math.round(netAnnualSavings).toLocaleString()}/yr after compliance` : '',\n    ].filter(Boolean),\n    cons: [\n      `$${compliance.annualTotal.toLocaleString()}/yr ongoing compliance cost`,\n      'Must run payroll (monthly or bi-weekly)',\n      'Separate corporate tax return (Form 1120-S)',\n      'IRS scrutiny on salary reasonableness',\n      distributions < 5000 ? 'Low distribution amount may not justify complexity' : '',\n    ].filter(Boolean),\n  }\n}\n\nfunction buildDualEntityScenario(\n  streams: IncomeStream[],\n  state: string,\n): EntityScenario | null {\n  // Only makes sense with 2+ income types\n  const businessStreams = streams.filter(s => ['business', 'freelance'].includes(s.type) && s.isActive)\n  if (businessStreams.length < 2) return null\n\n  const totalIncome = businessStreams.reduce((s, i) => s + i.annualAmount, 0)\n  if (totalIncome < 80000) return null\n\n  // Largest stream → S-Corp, remaining → Sole Prop\n  const sorted = [...businessStreams].sort((a, b) => b.annualAmount - a.annualAmount)\n  const scorpStream = sorted[0]\n  const solePropStreams = sorted.slice(1)\n  const scorpIncome = scorpStream.annualAmount\n  const solePropIncome = solePropStreams.reduce((s, i) => s + i.annualAmount, 0)\n\n  const salary = calculateReasonableSalary(scorpIncome).recommendedSalary\n  const distributions = scorpIncome - salary\n\n  const scorpCompliance = estimateComplianceCosts('llc_scorp', state)\n  const solePropCompliance = estimateComplianceCosts('sole_prop', state)\n\n  const ficaOnSalary = salary * 0.153\n  const solePropSETax = calculateSelfEmploymentTax(solePropIncome).total\n  const fullSETax = calculateSelfEmploymentTax(totalIncome).total\n  const totalSETax = ficaOnSalary + solePropSETax\n\n  const seTaxSavings = fullSETax - totalSETax\n  const totalCompliance = scorpCompliance.annualTotal + solePropCompliance.annualTotal\n  const netSavings = seTaxSavings - totalCompliance\n  const incomeTax = estimateIncomeTax(totalIncome, 'single')\n\n  return {\n    id: 'dual_entity',\n    label: 'Dual Structure (S-Corp + Sole Prop)',\n    description: `Primary income ($${scorpIncome.toLocaleString()}) through S-Corp, secondary ($${solePropIncome.toLocaleString()}) as sole prop`,\n    entities: [\n      {\n        type: 'llc_scorp', name: `S-Corp (${scorpStream.name})`,\n        allocatedIncome: scorpIncome, reasonableSalary: salary, distributions,\n        annualComplianceCost: scorpCompliance.annualTotal, setupCost: scorpCompliance.formation,\n      },\n      {\n        type: 'sole_prop', name: `Sole Prop (${solePropStreams.map(s => s.name).join(', ')})`,\n        allocatedIncome: solePropIncome,\n        annualComplianceCost: solePropCompliance.annualTotal, setupCost: 0,\n      },\n    ],\n    totalIncome: totalIncome,\n    totalSETax: Math.round(totalSETax),\n    totalIncomeTax: Math.round(incomeTax),\n    totalComplianceCost: totalCompliance,\n    totalTaxBurden: Math.round(totalSETax + incomeTax + totalCompliance),\n    netSavings: Math.round(Math.max(0, netSavings)),\n    breakEvenMonths: netSavings > 0 ? Math.ceil(scorpCompliance.formation / (netSavings / 12)) : 999,\n    isRecommended: false,\n    reasoning: `Isolates primary income stream in S-Corp for SE tax savings while keeping smaller streams simple. Saves $${Math.round(seTaxSavings).toLocaleString()}/yr in SE tax, netting $${Math.round(Math.max(0, netSavings)).toLocaleString()}/yr after compliance.`,\n    pros: [\n      'Optimizes highest-income stream for tax savings',\n      'Keeps smaller income simple',\n      'Liability separation between business activities',\n      `$${Math.round(Math.max(0, netSavings)).toLocaleString()}/yr net savings`,\n    ],\n    cons: [\n      'Two sets of records to maintain',\n      'More complex tax filing',\n      `$${totalCompliance.toLocaleString()}/yr total compliance`,\n      'Must track income allocation carefully',\n    ],\n  }\n}\n\n// ─── Simplified income tax estimate ─────────────────────────────────────\n\nfunction estimateIncomeTax(taxableIncome: number, status: string): number {\n  const brackets2025 = [\n    { min: 0, max: 11925, rate: 0.10 },\n    { min: 11925, max: 48475, rate: 0.12 },\n    { min: 48475, max: 103350, rate: 0.22 },\n    { min: 103350, max: 197300, rate: 0.24 },\n    { min: 197300, max: 250525, rate: 0.32 },\n    { min: 250525, max: 626350, rate: 0.35 },\n    { min: 626350, max: Infinity, rate: 0.37 },\n  ]\n  let tax = 0\n  for (const b of brackets2025) {\n    if (taxableIncome <= b.min) break\n    const taxable = Math.min(taxableIncome, b.max) - b.min\n    tax += taxable * b.rate\n  }\n  return tax\n}\n\n// ─── Main Optimizer ─────────────────────────────────────────────────────\n\nexport function optimizeEntities(state: FortunaState): EntityOptimizerResult {\n  const { profile, incomeStreams, expenses } = state\n  const stateCode = profile.state || 'IL'\n\n  const activeStreams = incomeStreams.filter(s => s.isActive)\n  const selfEmploymentIncome = activeStreams\n    .filter(s => ['business', 'freelance'].includes(s.type))\n    .reduce((sum, s) => sum + s.annualAmount, 0)\n  const deductibleExpenses = expenses.filter(e => e.isDeductible)\n    .reduce((sum, e) => sum + (e.annualAmount * e.deductionPct / 100), 0)\n  const netSEIncome = Math.max(0, selfEmploymentIncome - deductibleExpenses)\n\n  if (netSEIncome < 1000) {\n    const baseline = buildSolePropScenario(0, stateCode)\n    return {\n      scenarios: [baseline],\n      recommended: baseline,\n      currentScenario: baseline,\n      salaryAnalysis: null,\n      breakEvenIncome: 50000,\n      maxSavings: 0,\n      summary: 'No significant self-employment income to optimize entity structure for.',\n    }\n  }\n\n  // Build all scenarios\n  const scenarios: EntityScenario[] = []\n\n  const soleProp = buildSolePropScenario(netSEIncome, stateCode)\n  scenarios.push(soleProp)\n\n  const llc = buildLLCScenario(netSEIncome, stateCode)\n  llc.netSavings = soleProp.totalTaxBurden - llc.totalTaxBurden\n  scenarios.push(llc)\n\n  if (netSEIncome >= 30000) {\n    const scorp = buildSCorpScenario(netSEIncome, stateCode)\n    scorp.netSavings = soleProp.totalTaxBurden - scorp.totalTaxBurden\n    scenarios.push(scorp)\n  }\n\n  const dual = buildDualEntityScenario(activeStreams, stateCode)\n  if (dual) {\n    dual.netSavings = soleProp.totalTaxBurden - dual.totalTaxBurden\n    scenarios.push(dual)\n  }\n\n  // Determine recommended\n  const sorted = [...scenarios].sort((a, b) => b.netSavings - a.netSavings)\n  const best = sorted[0]\n  best.isRecommended = true\n\n  // Salary analysis for S-Corp scenarios\n  const salaryAnalysis = netSEIncome >= 30000\n    ? calculateReasonableSalary(netSEIncome)\n    : null\n\n  // Calculate breakeven income for S-Corp\n  const scorpCompliance = estimateComplianceCosts('llc_scorp', stateCode)\n  // Breakeven when SE tax savings > compliance cost\n  // SE savings ≈ distributions * 0.153\n  // distributions = income - salary ≈ income * 0.5\n  // So savings ≈ income * 0.5 * 0.153 = income * 0.0765\n  const breakEvenIncome = Math.round(scorpCompliance.annualTotal / 0.0765)\n\n  const maxSavings = best.netSavings\n\n  let summary = ''\n  if (best.id === 'sole_prop') {\n    summary = `At $${netSEIncome.toLocaleString()} net SE income, entity structuring doesn't yet offset compliance costs. S-Corp becomes beneficial around $${breakEvenIncome.toLocaleString()}.`\n  } else if (best.id === 'scorp') {\n    summary = `S-Corp election would save approximately $${maxSavings.toLocaleString()}/yr after compliance costs. Recommended salary: $${salaryAnalysis?.recommendedSalary.toLocaleString()}.`\n  } else if (best.id === 'dual_entity') {\n    summary = `Dual entity structure (S-Corp + Sole Prop) optimizes your multiple income streams, saving $${maxSavings.toLocaleString()}/yr.`\n  }\n\n  // Determine current scenario\n  const hasEntity = state.entities.some(e => e.isActive && (e.type === 'llc_scorp' || e.type === 'scorp'))\n  const currentScenario = hasEntity\n    ? scenarios.find(s => s.id === 'scorp') || soleProp\n    : soleProp\n\n  return {\n    scenarios,\n    recommended: best,\n    currentScenario,\n    salaryAnalysis,\n    breakEvenIncome,\n    maxSavings,\n    summary,\n  }\n}\n\n// ─── Income threshold analysis ──────────────────────────────────────────\n\nexport interface ThresholdAnalysis {\n  currentIncome: number\n  thresholds: {\n    label: string\n    income: number\n    savings: number\n    description: string\n    reached: boolean\n  }[]\n}\n\nexport function analyzeIncomeThresholds(netSEIncome: number, state: string): ThresholdAnalysis {\n  const thresholds = [\n    { label: 'LLC Worthwhile', income: 25000, description: 'Asset protection justifies formation costs' },\n    { label: 'S-Corp Breakeven', income: 40000, description: 'S-Corp tax savings begin to exceed compliance costs' },\n    { label: 'S-Corp Sweet Spot', income: 75000, description: 'Strong savings with manageable audit risk' },\n    { label: 'Max SE Savings', income: 168600, description: 'Social Security wage base cap — maximum FICA benefit' },\n    { label: 'Dual Entity', income: 150000, description: 'Multiple entities may optimize different income streams' },\n    { label: 'C-Corp Consideration', income: 400000, description: 'C-Corp qualified dividends may beat pass-through rates' },\n  ]\n\n  return {\n    currentIncome: netSEIncome,\n    thresholds: thresholds.map(t => {\n      const solePropTax = calculateSelfEmploymentTax(t.income).total + estimateIncomeTax(t.income, 'single')\n      const salary = calculateReasonableSalary(t.income).recommendedSalary\n      const scorpTax = salary * 0.153 + estimateIncomeTax(t.income, 'single')\n      const compliance = estimateComplianceCosts('llc_scorp', state).annualTotal\n      const savings = Math.max(0, solePropTax - scorpTax - compliance)\n\n      return {\n        ...t,\n        savings: Math.round(savings),\n        reached: netSEIncome >= t.income,\n      }\n    }),\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\equity-compensation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\estate-planning.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'missingBeneficiaries' is never reassigned. Use 'const' instead.","line":70,"column":7,"nodeType":"Identifier","messageId":"useConst","endLine":70,"endColumn":37,"fix":{"range":[2536,2575],"text":"const missingBeneficiaries: string[] = []"}},{"ruleId":"prefer-const","severity":2,"message":"'taxableEstate' is never reassigned. Use 'const' instead.","line":83,"column":7,"nodeType":"Identifier","messageId":"useConst","endLine":83,"endColumn":20,"fix":{"range":[2992,3058],"text":"const taxableEstate = Math.max(0, netEstateValue - federalExemption)"}},{"ruleId":"prefer-const","severity":2,"message":"'estimatedEstateTaxLiability' is never reassigned. Use 'const' instead.","line":86,"column":7,"nodeType":"Identifier","messageId":"useConst","endLine":86,"endColumn":34,"fix":{"range":[3128,3206],"text":"const estimatedEstateTaxLiability = taxableEstate > 0 ? taxableEstate * 0.40 : 0"}}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":3,"fixableWarningCount":0,"source":"import type { FortunaState, EstatePlan } from './storage'\r\n\r\nexport interface EstateSummary {\r\n  totalEstimatedEstateValue: number\r\n  estimatedEstateTaxLiability: number\r\n  lifetimeExemptionUsed: number\r\n  lifetimeExemptionRemaining: number\r\n  hasWill: boolean\r\n  hasHealthcareProxy: boolean\r\n  hasPowerOfAttorney: boolean\r\n  totalLifeInsuranceBenefit: number\r\n  missingBeneficiaries: string[] // IDs of accounts/policies missing beneficiaries\r\n  trustFundingStatus: Record<string, 'funded' | 'unfunded' | 'partially_funded'>\r\n  recommendations: EstateRecommendation[]\r\n}\r\n\r\nexport interface EstateRecommendation {\r\n  id: string\r\n  title: string\r\n  description: string\r\n  priority: 'critical' | 'high' | 'medium' | 'low'\r\n  impact?: number\r\n}\r\n\r\n// 2024 Federal Estate Tax Exemption amounts\r\nconst FEDERAL_EXEMPTION_2024_SINGLE = 13_610_000\r\nconst FEDERAL_EXEMPTION_2024_MARRIED = 27_220_000\r\n\r\nexport function calculateEstateSummary(state: FortunaState): EstateSummary {\r\n  const profile = state.profile || {}\r\n  const estatePlan: EstatePlan = state.estatePlan || { trusts: [], directives: [], lifeInsurance: [] }\r\n  const isMarried = profile.filingStatus === 'married_joint' || profile.filingStatus === 'married_separate'\r\n\r\n  const federalExemption = isMarried ? FEDERAL_EXEMPTION_2024_MARRIED : FEDERAL_EXEMPTION_2024_SINGLE\r\n\r\n  // 1. Calculate Total Estate Value\r\n  let totalGrossAssets = 0\r\n\r\n  // Real Estate\r\n  if (state.realEstate) {\r\n    totalGrossAssets += state.realEstate.reduce((sum, prop) => sum + prop.currentValue, 0)\r\n  }\r\n\r\n  // Investments\r\n  if (state.investments) {\r\n    totalGrossAssets += state.investments.reduce((sum, inv) => sum + (inv.currentValue || inv.costBasis), 0)\r\n  }\r\n\r\n  // Retirement\r\n  if (state.retirementAccounts) {\r\n    totalGrossAssets += state.retirementAccounts.reduce((sum, acc) => sum + acc.balance, 0)\r\n  }\r\n\r\n  // Business Entities (rough approximation from officersalary/etc if we had valuation, but let's assume 0 for basic unless specified)\r\n  // Cash/Bank\r\n  if (state.bankTransactions) {\r\n    // In a real app we'd sum up current bank balances, assuming here we just look at accounts if they existed\r\n  }\r\n\r\n  // Deduct liabilities\r\n  let totalLiabilities = 0\r\n  if (state.realEstate) {\r\n    totalLiabilities += state.realEstate.reduce((sum, prop) => sum + (prop.outstandingMortgage || 0), 0)\r\n  }\r\n\r\n  let netEstateValue = totalGrossAssets - totalLiabilities\r\n\r\n  // Add Life Insurance Death Benefits (if owned by the decedent/not in ILIT)\r\n  let totalLifeInsuranceBenefit = 0\r\n  let missingBeneficiaries: string[] = []\r\n\r\n  estatePlan.lifeInsurance.forEach(policy => {\r\n    // If it's not in an ILIT, the death benefit is generally included in the gross estate\r\n    totalLifeInsuranceBenefit += policy.deathBenefit\r\n    netEstateValue += policy.deathBenefit\r\n\r\n    if (!policy.beneficiaries || policy.beneficiaries.length === 0) {\r\n      missingBeneficiaries.push(`policy_${policy.id}`)\r\n    }\r\n  })\r\n\r\n  // 2. Estate Tax Liability\r\n  let taxableEstate = Math.max(0, netEstateValue - federalExemption)\r\n\r\n  // Simplified flat 40% for the highest bracket on the excess\r\n  let estimatedEstateTaxLiability = taxableEstate > 0 ? taxableEstate * 0.40 : 0\r\n\r\n  // 3. Directives Check\r\n  const hasWill = estatePlan.directives.some(d => d.type === 'will')\r\n  const hasHealthcareProxy = estatePlan.directives.some(d => d.type === 'healthcare_proxy' || d.type === 'living_will')\r\n  const hasPowerOfAttorney = estatePlan.directives.some(d => d.type === 'power_of_attorney')\r\n\r\n  // 4. Trust Funding Status\r\n  const trustFundingStatus: Record<string, 'funded' | 'unfunded' | 'partially_funded'> = {}\r\n  estatePlan.trusts.forEach(trust => {\r\n    if (trust.estimatedValue > 0) {\r\n      trustFundingStatus[trust.id] = 'funded'\r\n    } else {\r\n      trustFundingStatus[trust.id] = 'unfunded'\r\n    }\r\n  })\r\n\r\n  // 5. Generate Recommendations\r\n  const recommendations: EstateRecommendation[] = []\r\n\r\n  if (!hasWill) {\r\n    recommendations.push({\r\n      id: 'missing-will',\r\n      title: 'Draft a Last Will and Testament',\r\n      description: 'Without a will, state intestacy laws determine how your assets are distributed, which may not align with your wishes.',\r\n      priority: 'critical'\r\n    })\r\n  }\r\n\r\n  if (!hasHealthcareProxy || !hasPowerOfAttorney) {\r\n    recommendations.push({\r\n      id: 'missing-directives',\r\n      title: 'Complete Advance Directives',\r\n      description: 'You are missing a Healthcare Proxy or Durable Power of Attorney. These are critical if you become incapacitated.',\r\n      priority: 'high'\r\n    })\r\n  }\r\n\r\n  if (estimatedEstateTaxLiability > 0) {\r\n    recommendations.push({\r\n      id: 'estate-tax-liability',\r\n      title: 'High Estate Tax Exposure',\r\n      description: `Your estimated net estate ($${(netEstateValue / 1_000_000).toFixed(1)}M) exceeds the federal exemption ($${(federalExemption / 1_000_000).toFixed(1)}M). Consider irrevocable trusts (e.g., ILIT, SLAT) to shield assets.`,\r\n      priority: 'high',\r\n      impact: estimatedEstateTaxLiability\r\n    })\r\n  }\r\n\r\n  if (missingBeneficiaries.length > 0) {\r\n    recommendations.push({\r\n      id: 'missing-beneficiaries',\r\n      title: 'Update Policy Beneficiaries',\r\n      description: `You have ${missingBeneficiaries.length} life insurance policy/policies missing named beneficiaries. This could subject the payout to probate.`,\r\n      priority: 'medium'\r\n    })\r\n  }\r\n\r\n  estatePlan.trusts.filter(t => trustFundingStatus[t.id] === 'unfunded').forEach(t => {\r\n    recommendations.push({\r\n      id: `unfunded-trust-${t.id}`,\r\n      title: `Fund Trust: ${t.name}`,\r\n      description: 'You have established a trust but it appears unfunded (0 estimated value). An unfunded trust provides no probate or tax protection.',\r\n      priority: 'high'\r\n    })\r\n  })\r\n\r\n  return {\r\n    totalEstimatedEstateValue: netEstateValue,\r\n    estimatedEstateTaxLiability,\r\n    lifetimeExemptionUsed: 0, // Simplified for now\r\n    lifetimeExemptionRemaining: federalExemption,\r\n    hasWill,\r\n    hasHealthcareProxy,\r\n    hasPowerOfAttorney,\r\n    totalLifeInsuranceBenefit,\r\n    missingBeneficiaries,\r\n    trustFundingStatus,\r\n    recommendations\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\event-bus.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\exchange-rates.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\execution-timeline.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DetectedStrategy' is defined but never used.","line":7,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":49,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DetectedStrategy"},"fix":{"range":[176,199],"text":""},"desc":"Remove unused variable \"DetectedStrategy\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine - Execution Timeline\n * Generates time-aware action plans with real deadlines\n */\n\nimport type { FortunaState } from './storage'\nimport { detectStrategies, type DetectedStrategy } from './strategy-detector'\nimport { generateTaxReport } from './tax-calculator'\n\nexport interface TimelineAction {\n  id: string\n  strategyId: string\n  title: string\n  description: string\n  deadline: string // ISO date\n  deadlineLabel: string\n  quarter: string // Q1 2025, Q2 2025, etc.\n  category: 'tax' | 'entity' | 'revenue' | 'risk' | 'compliance' | 'retirement' | 'deduction'\n  priority: 'critical' | 'high' | 'medium' | 'low'\n  status: 'upcoming' | 'urgent' | 'overdue' | 'completed'\n  estimatedImpact: number\n  impactLabel: string\n  steps: string[]\n  daysUntilDeadline: number\n  irsForm?: string\n}\n\nexport interface QuarterBlock {\n  quarter: string\n  label: string\n  actions: TimelineAction[]\n  totalImpact: number\n}\n\nconst CURRENT_YEAR = new Date().getFullYear()\n\n// Key tax deadlines\nconst TAX_DEADLINES = {\n  q1_estimated: `${CURRENT_YEAR}-04-15`,\n  q2_estimated: `${CURRENT_YEAR}-06-15`,\n  q3_estimated: `${CURRENT_YEAR}-09-15`,\n  q4_estimated: `${CURRENT_YEAR + 1}-01-15`,\n  scorp_election: `${CURRENT_YEAR}-03-15`,\n  tax_filing: `${CURRENT_YEAR}-04-15`,\n  tax_extension: `${CURRENT_YEAR}-10-15`,\n  sep_ira_deadline: `${CURRENT_YEAR}-04-15`, // Or extension deadline\n  sep_ira_extended: `${CURRENT_YEAR}-10-15`,\n  solo401k_setup: `${CURRENT_YEAR}-12-31`,\n  solo401k_employee: `${CURRENT_YEAR}-12-31`,\n  solo401k_employer: `${CURRENT_YEAR}-04-15`,\n}\n\nfunction daysUntil(dateStr: string): number {\n  const target = new Date(dateStr)\n  const now = new Date()\n  return Math.ceil((target.getTime() - now.getTime()) / (1000 * 60 * 60 * 24))\n}\n\nfunction getStatus(days: number): TimelineAction['status'] {\n  if (days < 0) return 'overdue'\n  if (days <= 14) return 'urgent'\n  return 'upcoming'\n}\n\nfunction getQuarter(dateStr: string): string {\n  const d = new Date(dateStr)\n  const q = Math.ceil((d.getMonth() + 1) / 3)\n  return `Q${q} ${d.getFullYear()}`\n}\n\nexport function generateTimeline(state: FortunaState): TimelineAction[] {\n  const actions: TimelineAction[] = []\n  const strategies = detectStrategies(state)\n  const report = generateTaxReport(state)\n  const hasScorp = state.entities.some(e => (e.type === 'llc_scorp' || e.type === 'scorp') && e.isActive)\n\n  // S-Corp election deadline\n  const scorpStrategy = strategies.find(s => s.id === 'scorp-election')\n  if (scorpStrategy) {\n    actions.push({\n      id: 'action-scorp',\n      strategyId: 'scorp-election',\n      title: 'File S-Corp Election (Form 2553)',\n      description: `File Form 2553 to elect S-Corp status. Saves ${scorpStrategy.impactLabel} annually. Must be filed by March 15 for current tax year (or within 75 days of formation).`,\n      deadline: TAX_DEADLINES.scorp_election,\n      deadlineLabel: 'March 15',\n      quarter: getQuarter(TAX_DEADLINES.scorp_election),\n      category: 'entity',\n      priority: 'critical',\n      status: getStatus(daysUntil(TAX_DEADLINES.scorp_election)),\n      estimatedImpact: scorpStrategy.estimatedImpact,\n      impactLabel: scorpStrategy.impactLabel,\n      daysUntilDeadline: daysUntil(TAX_DEADLINES.scorp_election),\n      irsForm: 'Form 2553',\n      steps: [\n        'Ensure LLC is formed in your state',\n        'Complete Form 2553 (Election by a Small Business Corporation)',\n        'All shareholders must consent and sign',\n        'File with the IRS service center for your state',\n        'Set up payroll for reasonable salary',\n      ],\n    })\n  }\n\n  // LLC formation (if recommended)\n  const llcStrategy = strategies.find(s => s.id === 'llc-formation')\n  if (llcStrategy) {\n    actions.push({\n      id: 'action-llc',\n      strategyId: 'llc-formation',\n      title: 'Form LLC for Liability Protection',\n      description: 'File Articles of Organization, obtain EIN, open business bank account. Foundation for all other entity strategies.',\n      deadline: `${CURRENT_YEAR}-03-01`,\n      deadlineLabel: 'ASAP (before S-Corp deadline)',\n      quarter: `Q1 ${CURRENT_YEAR}`,\n      category: 'entity',\n      priority: 'critical',\n      status: 'urgent',\n      estimatedImpact: 0,\n      impactLabel: 'Asset protection',\n      daysUntilDeadline: daysUntil(`${CURRENT_YEAR}-03-01`),\n      steps: [\n        'File Articles of Organization with Secretary of State',\n        'Apply for EIN on IRS.gov (instant, free)',\n        'Draft Operating Agreement',\n        'Open business checking account',\n        'Begin separating business/personal finances',\n      ],\n    })\n  }\n\n  // Quarterly estimated tax payments\n  if (report.totalTax > 1000) {\n    const quarterlyAmount = Math.round(report.totalTax / 4)\n    const estimatedDeadlines = [\n      { deadline: TAX_DEADLINES.q1_estimated, label: 'Q1 Estimated Tax', qLabel: 'April 15' },\n      { deadline: TAX_DEADLINES.q2_estimated, label: 'Q2 Estimated Tax', qLabel: 'June 15' },\n      { deadline: TAX_DEADLINES.q3_estimated, label: 'Q3 Estimated Tax', qLabel: 'September 15' },\n      { deadline: TAX_DEADLINES.q4_estimated, label: 'Q4 Estimated Tax', qLabel: 'January 15' },\n    ]\n\n    estimatedDeadlines.forEach((ed, i) => {\n      const days = daysUntil(ed.deadline)\n      if (days > -30) { // Show if not more than 30 days past\n        actions.push({\n          id: `action-est-${i + 1}`,\n          strategyId: 'estimated-tax',\n          title: ed.label,\n          description: `Pay ~$${quarterlyAmount.toLocaleString()} (Form 1040-ES). Based on projected annual tax of $${report.totalTax.toLocaleString()}.`,\n          deadline: ed.deadline,\n          deadlineLabel: ed.qLabel,\n          quarter: getQuarter(ed.deadline),\n          category: 'compliance',\n          priority: days <= 30 ? 'high' : 'medium',\n          status: getStatus(days),\n          estimatedImpact: 0,\n          impactLabel: `$${quarterlyAmount.toLocaleString()} payment`,\n          daysUntilDeadline: days,\n          irsForm: 'Form 1040-ES',\n          steps: [\n            `Calculate payment: ~$${quarterlyAmount.toLocaleString()}`,\n            'Pay via IRS Direct Pay (irs.gov/directpay)',\n            'Or use EFTPS (Electronic Federal Tax Payment System)',\n            'Keep confirmation number for records',\n          ],\n        })\n      }\n    })\n  }\n\n  // Retirement contribution deadline\n  const retirementStrategy = strategies.find(s => s.id === 'retirement-max')\n  if (retirementStrategy) {\n    actions.push({\n      id: 'action-retirement',\n      strategyId: 'retirement-max',\n      title: 'Maximize Retirement Contributions',\n      description: retirementStrategy.description,\n      deadline: TAX_DEADLINES.sep_ira_extended,\n      deadlineLabel: 'Tax filing deadline (or extension)',\n      quarter: getQuarter(TAX_DEADLINES.sep_ira_deadline),\n      category: 'retirement',\n      priority: 'high',\n      status: getStatus(daysUntil(TAX_DEADLINES.sep_ira_deadline)),\n      estimatedImpact: retirementStrategy.estimatedImpact,\n      impactLabel: retirementStrategy.impactLabel,\n      daysUntilDeadline: daysUntil(TAX_DEADLINES.sep_ira_deadline),\n      steps: retirementStrategy.steps,\n    })\n  }\n\n  // Home office setup\n  const homeOffice = strategies.find(s => s.id === 'home-office')\n  if (homeOffice) {\n    actions.push({\n      id: 'action-home-office',\n      strategyId: 'home-office',\n      title: 'Document Home Office Deduction',\n      description: 'Measure, photograph, and calculate home office deduction before year-end.',\n      deadline: `${CURRENT_YEAR}-12-31`,\n      deadlineLabel: 'Year-end',\n      quarter: `Q4 ${CURRENT_YEAR}`,\n      category: 'deduction',\n      priority: 'medium',\n      status: 'upcoming',\n      estimatedImpact: homeOffice.estimatedImpact,\n      impactLabel: homeOffice.impactLabel,\n      daysUntilDeadline: daysUntil(`${CURRENT_YEAR}-12-31`),\n      steps: homeOffice.steps,\n    })\n  }\n\n  // Vehicle mileage tracking\n  const vehicle = strategies.find(s => s.id === 'vehicle-deduction')\n  if (vehicle) {\n    actions.push({\n      id: 'action-vehicle',\n      strategyId: 'vehicle-deduction',\n      title: 'Start Mileage Tracking',\n      description: 'Begin tracking business miles immediately. Retroactive logs are not accepted by the IRS.',\n      deadline: `${CURRENT_YEAR}-02-28`,\n      deadlineLabel: 'Start immediately',\n      quarter: `Q1 ${CURRENT_YEAR}`,\n      category: 'deduction',\n      priority: 'medium',\n      status: 'urgent',\n      estimatedImpact: vehicle.estimatedImpact,\n      impactLabel: vehicle.impactLabel,\n      daysUntilDeadline: 0,\n      steps: vehicle.steps,\n    })\n  }\n\n  // Annual tax filing\n  actions.push({\n    id: 'action-tax-filing',\n    strategyId: 'compliance',\n    title: 'Annual Tax Filing',\n    description: `File federal and state income tax returns. Projected tax: $${report.totalTax.toLocaleString()}.`,\n    deadline: TAX_DEADLINES.tax_filing,\n    deadlineLabel: 'April 15 (or Oct 15 with extension)',\n    quarter: getQuarter(TAX_DEADLINES.tax_filing),\n    category: 'compliance',\n    priority: 'high',\n    status: getStatus(daysUntil(TAX_DEADLINES.tax_filing)),\n    estimatedImpact: 0,\n    impactLabel: 'Required',\n    daysUntilDeadline: daysUntil(TAX_DEADLINES.tax_filing),\n    irsForm: 'Form 1040 + Schedule C/SE',\n    steps: [\n      'Gather all income documents (1099s, W-2s)',\n      'Compile business expense records',\n      'Calculate all deductions and credits',\n      hasScorp ? 'File Form 1120-S (S-Corp return) by March 15' : 'File Schedule C with Form 1040',\n      'File state return for your state',\n      'Consider filing for extension (Form 4868) if needed',\n    ],\n  })\n\n  // Sort by deadline\n  actions.sort((a, b) => new Date(a.deadline).getTime() - new Date(b.deadline).getTime())\n\n  return actions\n}\n\n/**\n * Group actions into quarters\n */\nexport function groupByQuarter(actions: TimelineAction[]): QuarterBlock[] {\n  const quarterMap = new Map<string, TimelineAction[]>()\n\n  actions.forEach(action => {\n    const q = action.quarter\n    if (!quarterMap.has(q)) quarterMap.set(q, [])\n    quarterMap.get(q)!.push(action)\n  })\n\n  const quarters: QuarterBlock[] = []\n  quarterMap.forEach((actions, quarter) => {\n    quarters.push({\n      quarter,\n      label: quarter,\n      actions: actions.sort((a, b) => new Date(a.deadline).getTime() - new Date(b.deadline).getTime()),\n      totalImpact: actions.reduce((s, a) => s + a.estimatedImpact, 0),\n    })\n  })\n\n  return quarters.sort((a, b) => {\n    const aDate = new Date(a.actions[0]?.deadline || '2099-01-01')\n    const bDate = new Date(b.actions[0]?.deadline || '2099-01-01')\n    return aDate.getTime() - bDate.getTime()\n  })\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\filing-export.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\fintech-adapters.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'KYBBusinessIdentity' is defined but never used.","line":21,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":52,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"KYBBusinessIdentity"},"fix":{"range":[823,844],"text":""},"desc":"Remove unused variable \"KYBBusinessIdentity\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'WebhookEvent' is defined but never used.","line":23,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":23,"endColumn":45,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"WebhookEvent"},"fix":{"range":[967,981],"text":""},"desc":"Remove unused variable \"WebhookEvent\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TransactionType' is defined but never used.","line":24,"column":32,"nodeType":"Identifier","messageId":"unusedVar","endLine":24,"endColumn":47,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TransactionType"},"fix":{"range":[1031,1048],"text":""},"desc":"Remove unused variable \"TransactionType\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TransactionTaxRelevance' is defined but never used.","line":25,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":26,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TransactionTaxRelevance"},"fix":{"range":[1069,1096],"text":""},"desc":"Remove unused variable \"TransactionTaxRelevance\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'PostalAddress' is defined but never used.","line":25,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":41,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"PostalAddress"},"fix":{"range":[1096,1111],"text":""},"desc":"Remove unused variable \"PostalAddress\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AccountBalances' is defined but never used.","line":25,"column":43,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":58,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AccountBalances"},"fix":{"range":[1111,1128],"text":""},"desc":"Remove unused variable \"AccountBalances\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_products' is defined but never used.","line":542,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":542,"endColumn":50},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_publicToken' is defined but never used.","line":551,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":551,"endColumn":41},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_connectionId' is defined but never used.","line":555,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":555,"endColumn":39},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'accountIds' is defined but never used.","line":590,"column":48,"nodeType":"Identifier","messageId":"unusedVar","endLine":590,"endColumn":58},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_connectionId' is defined but never used.","line":612,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":612,"endColumn":39},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_cursor' is defined but never used.","line":612,"column":49,"nodeType":"Identifier","messageId":"unusedVar","endLine":612,"endColumn":56},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_products' is defined but never used.","line":674,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":674,"endColumn":50},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_pt' is defined but never used.","line":677,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":677,"endColumn":32},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_id' is defined but never used.","line":678,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":678,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_id' is defined but never used.","line":679,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":679,"endColumn":32},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_id' is defined but never used.","line":680,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":680,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_id' is defined but never used.","line":681,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":681,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_id' is defined but never used.","line":682,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":682,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_p' is defined but never used.","line":682,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":682,"endColumn":40},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_id' is defined but never used.","line":683,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":683,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_id' is defined but never used.","line":684,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":684,"endColumn":24},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":908,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":908,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38843,38846],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38843,38846],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":910,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":910,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38919,38922],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38919,38922],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":911,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":911,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38962,38965],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38962,38965],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":912,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":912,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[39009,39012],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[39009,39012],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":913,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":913,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[39058,39061],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[39058,39061],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":914,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":914,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[39089,39092],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[39089,39092],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":28,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — FinTech Provider Adapters\n *\n * Abstract adapter interface + concrete implementations for major providers.\n * Each adapter normalizes provider-native data into canonical FinTech models.\n *\n * Architecture:\n *   ┌──────────────┐     ┌──────────────────┐     ┌──────────────────┐\n *   │   Fortuna     │ ──► │  FinTechAdapter   │ ──► │  Provider API    │\n *   │   Bridge      │ ◄── │  (normalize)      │ ◄── │  (Plaid/Unit/MX) │\n *   └──────────────┘     └──────────────────┘     └──────────────────┘\n *\n * All adapters implement FinTechAdapter and return FinTechResponse<T>.\n * The bridge layer (fintech-bridge.ts) further maps into FortunaState.\n *\n * @module fintech-adapters\n */\n\nimport type {\n  FinTechProvider, FinTechConnection, FinTechAccount, FinTechTransaction,\n  FinTechResponse, KYCIdentity, KYBBusinessIdentity, InvestmentHolding,\n  Security, InvestmentTransaction, LiabilityDetail, IncomeVerification,\n  RecurringStream, AssetReport, WebhookEvent, FinTechCapability,\n  AccountType, AccountSubtype, TransactionType, AccountTaxRelevance,\n  TransactionTaxRelevance, PostalAddress, AccountBalances,\n} from './fintech-models'\n\n// ─── Abstract Adapter Interface ───────────────────────────────────────────\n\nexport interface FinTechAdapter {\n  readonly provider: FinTechProvider\n\n  // Connection lifecycle\n  createLinkToken(userId: string, products: FinTechCapability[]): Promise<FinTechResponse<{ linkToken: string; expiration: string }>>\n  exchangePublicToken(publicToken: string): Promise<FinTechResponse<{ connectionId: string; accessToken: string }>>\n  removeConnection(connectionId: string): Promise<FinTechResponse<void>>\n  getConnectionStatus(connectionId: string): Promise<FinTechResponse<FinTechConnection>>\n\n  // Accounts\n  getAccounts(connectionId: string): Promise<FinTechResponse<FinTechAccount[]>>\n  getAccountBalances(connectionId: string, accountIds?: string[]): Promise<FinTechResponse<FinTechAccount[]>>\n\n  // Transactions\n  getTransactions(connectionId: string, params: TransactionParams): Promise<FinTechResponse<FinTechTransaction[]>>\n  syncTransactions(connectionId: string, cursor?: string): Promise<FinTechResponse<TransactionSyncResult>>\n\n  // Identity\n  getIdentity(connectionId: string): Promise<FinTechResponse<KYCIdentity>>\n\n  // Investments (optional)\n  getInvestmentHoldings?(connectionId: string): Promise<FinTechResponse<{ holdings: InvestmentHolding[]; securities: Security[] }>>\n  getInvestmentTransactions?(connectionId: string, params: TransactionParams): Promise<FinTechResponse<InvestmentTransaction[]>>\n\n  // Liabilities (optional)\n  getLiabilities?(connectionId: string): Promise<FinTechResponse<LiabilityDetail[]>>\n\n  // Income (optional)\n  getIncomeVerification?(connectionId: string): Promise<FinTechResponse<IncomeVerification>>\n\n  // Recurring (optional)\n  getRecurringTransactions?(connectionId: string): Promise<FinTechResponse<RecurringStream[]>>\n\n  // Assets (optional)\n  createAssetReport?(connectionId: string, daysRequested: number): Promise<FinTechResponse<{ reportId: string }>>\n  getAssetReport?(reportId: string): Promise<FinTechResponse<AssetReport>>\n\n  // Webhook verification\n  verifyWebhook?(headers: Record<string, string>, body: string): Promise<boolean>\n}\n\nexport interface TransactionParams {\n  startDate: string            // ISO date\n  endDate: string              // ISO date\n  accountIds?: string[]\n  count?: number               // Max transactions per request\n  offset?: number              // Pagination offset\n}\n\nexport interface TransactionSyncResult {\n  added: FinTechTransaction[]\n  modified: FinTechTransaction[]\n  removed: string[]            // Transaction IDs\n  hasMore: boolean\n  nextCursor: string\n}\n\n// ─── Provider Configuration ───────────────────────────────────────────────\n\nexport interface ProviderConfig {\n  provider: FinTechProvider\n  clientId: string\n  secret: string\n  environment: 'sandbox' | 'development' | 'production'\n  baseUrl: string\n  webhookUrl?: string\n  version?: string             // API version header\n}\n\n// ─── Helper: Generate request ID ──────────────────────────────────────────\n\nfunction requestId(): string {\n  return `ftk_${Date.now()}_${Math.random().toString(36).substring(2, 10)}`\n}\n\nfunction envelope<T>(provider: FinTechProvider, data: T): FinTechResponse<T> {\n  return { success: true, data, provider, requestId: requestId(), timestamp: new Date().toISOString() }\n}\n\nfunction errorEnvelope<T>(provider: FinTechProvider, code: string, message: string, type: 'auth' | 'rate_limit' | 'api_error' | 'connection_error' | 'validation' = 'api_error'): FinTechResponse<T> {\n  return { success: false, data: null, error: { code, message, type, retryable: type === 'rate_limit' }, provider, requestId: requestId(), timestamp: new Date().toISOString() }\n}\n\n// ═══════════════════════════════════════════════════════════════════════════\n//  PLAID ADAPTER\n// ═══════════════════════════════════════════════════════════════════════════\n\n/**\n * Plaid API adapter.\n * Maps Plaid's /accounts, /transactions, /identity, /investments,\n * /liabilities, /income, /assets endpoints to canonical models.\n *\n * API Reference: https://plaid.com/docs/api/\n */\nexport class PlaidAdapter implements FinTechAdapter {\n  readonly provider: FinTechProvider = 'plaid'\n  private config: ProviderConfig\n\n  constructor(config: Omit<ProviderConfig, 'provider'>) {\n    this.config = { ...config, provider: 'plaid' }\n    if (!this.config.baseUrl) {\n      this.config.baseUrl = config.environment === 'production'\n        ? 'https://production.plaid.com'\n        : config.environment === 'development'\n          ? 'https://development.plaid.com'\n          : 'https://sandbox.plaid.com'\n    }\n  }\n\n  private async plaidRequest<T>(endpoint: string, body: Record<string, unknown>): Promise<T> {\n    const resp = await fetch(`${this.config.baseUrl}${endpoint}`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'PLAID-CLIENT-ID': this.config.clientId,\n        'PLAID-SECRET': this.config.secret,\n        ...(this.config.version ? { 'Plaid-Version': this.config.version } : {}),\n      },\n      body: JSON.stringify(body),\n    })\n    if (!resp.ok) {\n      const err = await resp.json().catch(() => ({ error_code: 'UNKNOWN', error_message: resp.statusText }))\n      throw new PlaidError(err.error_code, err.error_message, err.error_type)\n    }\n    return resp.json()\n  }\n\n  // ── Connection Lifecycle ──────────────────────────────────────────────\n\n  async createLinkToken(userId: string, products: FinTechCapability[]) {\n    try {\n      const plaidProducts = products.map(p => PLAID_PRODUCT_MAP[p]).filter(Boolean)\n      const data = await this.plaidRequest<{ link_token: string; expiration: string }>('/link/token/create', {\n        client_id: this.config.clientId,\n        secret: this.config.secret,\n        user: { client_user_id: userId },\n        client_name: 'Fortuna Engine',\n        products: plaidProducts.length > 0 ? plaidProducts : ['transactions'],\n        country_codes: ['US'],\n        language: 'en',\n        webhook: this.config.webhookUrl,\n      })\n      return envelope(this.provider, { linkToken: data.link_token, expiration: data.expiration })\n    } catch (err) {\n      return this.handleError(err)\n    }\n  }\n\n  async exchangePublicToken(publicToken: string) {\n    try {\n      const data = await this.plaidRequest<{ access_token: string; item_id: string }>('/item/public_token/exchange', {\n        public_token: publicToken,\n      })\n      return envelope(this.provider, { connectionId: data.item_id, accessToken: data.access_token })\n    } catch (err) {\n      return this.handleError(err)\n    }\n  }\n\n  async removeConnection(accessToken: string) {\n    try {\n      await this.plaidRequest('/item/remove', { access_token: accessToken })\n      return envelope<void>(this.provider, undefined as unknown as void)\n    } catch (err) {\n      return this.handleError(err)\n    }\n  }\n\n  async getConnectionStatus(accessToken: string) {\n    try {\n      const data = await this.plaidRequest<{\n        item: { item_id: string; institution_id: string; webhook: string; error: unknown; consent_expiration_time: string }\n        status: { transactions: { last_successful_update: string } }\n      }>('/item/get', { access_token: accessToken })\n\n      const conn: FinTechConnection = {\n        id: data.item.item_id,\n        provider: 'plaid',\n        institutionId: data.item.institution_id || '',\n        institutionName: '', // Resolved via /institutions/get_by_id\n        status: data.item.error ? 'error' : 'active',\n        consentExpiresAt: data.item.consent_expiration_time,\n        lastSuccessfulSync: data.status?.transactions?.last_successful_update,\n        accountIds: [],\n        capabilities: ['accounts', 'transactions'],\n        createdAt: new Date().toISOString(),\n        updatedAt: new Date().toISOString(),\n      }\n      return envelope(this.provider, conn)\n    } catch (err) {\n      return this.handleError(err)\n    }\n  }\n\n  // ── Accounts ──────────────────────────────────────────────────────────\n\n  async getAccounts(accessToken: string) {\n    try {\n      const data = await this.plaidRequest<{ accounts: PlaidAccount[] }>('/accounts/get', {\n        access_token: accessToken,\n      })\n      return envelope(this.provider, data.accounts.map(a => normalizePlaidAccount(a, '')))\n    } catch (err) {\n      return this.handleError(err)\n    }\n  }\n\n  async getAccountBalances(accessToken: string, accountIds?: string[]) {\n    try {\n      const body: Record<string, unknown> = { access_token: accessToken }\n      if (accountIds?.length) body.options = { account_ids: accountIds }\n      const data = await this.plaidRequest<{ accounts: PlaidAccount[] }>('/accounts/balance/get', body)\n      return envelope(this.provider, data.accounts.map(a => normalizePlaidAccount(a, '')))\n    } catch (err) {\n      return this.handleError(err)\n    }\n  }\n\n  // ── Transactions ──────────────────────────────────────────────────────\n\n  async getTransactions(accessToken: string, params: TransactionParams) {\n    try {\n      const data = await this.plaidRequest<{ transactions: PlaidTransaction[]; total_transactions: number }>('/transactions/get', {\n        access_token: accessToken,\n        start_date: params.startDate,\n        end_date: params.endDate,\n        options: {\n          count: params.count || 500,\n          offset: params.offset || 0,\n          ...(params.accountIds?.length ? { account_ids: params.accountIds } : {}),\n        },\n      })\n      const txns = data.transactions.map(t => normalizePlaidTransaction(t))\n      const result: FinTechResponse<FinTechTransaction[]> = {\n        ...envelope(this.provider, txns),\n        pagination: {\n          total: data.total_transactions,\n          offset: params.offset || 0,\n          limit: params.count || 500,\n          hasMore: (params.offset || 0) + txns.length < data.total_transactions,\n        },\n      }\n      return result\n    } catch (err) {\n      return this.handleError(err)\n    }\n  }\n\n  async syncTransactions(accessToken: string, cursor?: string) {\n    try {\n      const data = await this.plaidRequest<{\n        added: PlaidTransaction[]; modified: PlaidTransaction[]\n        removed: { transaction_id: string }[]; has_more: boolean; next_cursor: string\n      }>('/transactions/sync', {\n        access_token: accessToken,\n        ...(cursor ? { cursor } : {}),\n      })\n      return envelope(this.provider, {\n        added: data.added.map(normalizePlaidTransaction),\n        modified: data.modified.map(normalizePlaidTransaction),\n        removed: data.removed.map(r => r.transaction_id),\n        hasMore: data.has_more,\n        nextCursor: data.next_cursor,\n      })\n    } catch (err) {\n      return this.handleError(err)\n    }\n  }\n\n  // ── Identity ──────────────────────────────────────────────────────────\n\n  async getIdentity(accessToken: string) {\n    try {\n      const data = await this.plaidRequest<{ accounts: { owners: PlaidOwner[] }[] }>('/identity/get', {\n        access_token: accessToken,\n      })\n      const owner = data.accounts?.[0]?.owners?.[0]\n      if (!owner) return errorEnvelope<KYCIdentity>(this.provider, 'NO_IDENTITY', 'No identity data available')\n\n      const identity: KYCIdentity = {\n        id: `plaid_id_${Date.now()}`,\n        provider: 'plaid',\n        verificationStatus: 'verified',\n        verifiedAt: new Date().toISOString(),\n        legalFirstName: owner.names?.[0]?.split(' ')[0] || '',\n        legalLastName: owner.names?.[0]?.split(' ').slice(-1)[0] || '',\n        dateOfBirth: '',\n        email: owner.emails?.[0]?.data || '',\n        emailVerified: false,\n        phone: owner.phone_numbers?.[0]?.data || '',\n        phoneVerified: false,\n        address: {\n          street1: owner.addresses?.[0]?.data?.street || '',\n          city: owner.addresses?.[0]?.data?.city || '',\n          region: owner.addresses?.[0]?.data?.region || '',\n          postalCode: owner.addresses?.[0]?.data?.postal_code || '',\n          country: owner.addresses?.[0]?.data?.country || 'US',\n        },\n        checksPerformed: ['identity_verification'],\n      }\n      return envelope(this.provider, identity)\n    } catch (err) {\n      return this.handleError(err)\n    }\n  }\n\n  // ── Investments ───────────────────────────────────────────────────────\n\n  async getInvestmentHoldings(accessToken: string) {\n    try {\n      const data = await this.plaidRequest<{\n        holdings: PlaidHolding[]; securities: PlaidSecurity[]; accounts: PlaidAccount[]\n      }>('/investments/holdings/get', { access_token: accessToken })\n\n      const securities: Security[] = data.securities.map(s => ({\n        id: s.security_id,\n        name: s.name || '',\n        tickerSymbol: s.ticker_symbol || undefined,\n        cusip: s.cusip || undefined,\n        isin: s.isin || undefined,\n        sedol: s.sedol || undefined,\n        type: mapPlaidSecurityType(s.type),\n        isoCurrencyCode: s.iso_currency_code || 'USD',\n        closePrice: s.close_price || undefined,\n        closePriceAsOf: s.close_price_as_of || undefined,\n        isCashEquivalent: s.is_cash_equivalent || false,\n      }))\n\n      const holdings: InvestmentHolding[] = data.holdings.map(h => ({\n        id: `${h.account_id}_${h.security_id}`,\n        accountId: h.account_id,\n        securityId: h.security_id,\n        quantity: h.quantity,\n        costBasis: h.cost_basis || 0,\n        marketValue: h.institution_value || (h.quantity * (h.institution_price || 0)),\n        price: h.institution_price || 0,\n        priceAsOf: h.institution_price_as_of || new Date().toISOString(),\n        unrealizedGainLoss: (h.institution_value || 0) - (h.cost_basis || 0),\n        unrealizedGainLossPct: h.cost_basis ? (((h.institution_value || 0) - h.cost_basis) / h.cost_basis) * 100 : 0,\n        isLongTerm: false,\n        isoCurrencyCode: h.iso_currency_code || 'USD',\n      }))\n\n      return envelope(this.provider, { holdings, securities })\n    } catch (err) {\n      return this.handleError(err)\n    }\n  }\n\n  // ── Liabilities ───────────────────────────────────────────────────────\n\n  async getLiabilities(accessToken: string) {\n    try {\n      const data = await this.plaidRequest<{\n        liabilities: {\n          credit?: PlaidCreditLiability[]\n          mortgage?: PlaidMortgageLiability[]\n          student?: PlaidStudentLiability[]\n        }\n      }>('/liabilities/get', { access_token: accessToken })\n\n      const liabilities: LiabilityDetail[] = []\n\n      // Credit cards\n      for (const cc of (data.liabilities.credit || [])) {\n        liabilities.push({\n          id: cc.account_id,\n          accountId: cc.account_id,\n          type: 'credit_card',\n          currentBalance: cc.last_statement_balance || 0,\n          minimumPayment: cc.minimum_payment_amount || 0,\n          lastPaymentAmount: cc.last_payment_amount || undefined,\n          lastPaymentDate: cc.last_payment_date || undefined,\n          nextPaymentDueDate: cc.next_payment_due_date || undefined,\n          interestRateType: 'variable',\n          interestRatePct: cc.aprs?.[0]?.apr_percentage || 0,\n          taxDeductibleInterest: false,\n        })\n      }\n\n      // Mortgages\n      for (const m of (data.liabilities.mortgage || [])) {\n        liabilities.push({\n          id: m.account_id,\n          accountId: m.account_id,\n          type: 'mortgage',\n          currentBalance: m.current_balance || 0,\n          minimumPayment: m.last_payment_amount || 0,\n          lastPaymentAmount: m.last_payment_amount || undefined,\n          lastPaymentDate: m.last_payment_date || undefined,\n          nextPaymentDueDate: m.next_payment_due_date || undefined,\n          interestRateType: m.interest_rate?.type === 'fixed' ? 'fixed' : 'variable',\n          interestRatePct: m.interest_rate?.percentage || 0,\n          originalLoanAmount: m.original_balance || undefined,\n          originationDate: m.origination_date || undefined,\n          maturityDate: m.maturity_date || undefined,\n          termMonths: m.term ? parseInt(m.term) : undefined,\n          mortgage: {\n            escrowBalance: m.escrow_balance || undefined,\n            loanType: mapMortgageType(m.loan_type_description),\n            interestPaidYTD: m.ytd_interest_paid || undefined,\n          },\n          taxDeductibleInterest: true,\n          scheduleRef: 'Schedule A Line 8a / Form 1098',\n        })\n      }\n\n      // Student loans\n      for (const s of (data.liabilities.student || [])) {\n        liabilities.push({\n          id: s.account_id,\n          accountId: s.account_id,\n          type: 'student',\n          currentBalance: s.outstanding_interest_amount + (s.last_statement_balance || 0),\n          minimumPayment: s.minimum_payment_amount || 0,\n          lastPaymentAmount: s.last_payment_amount || undefined,\n          lastPaymentDate: s.last_payment_date || undefined,\n          nextPaymentDueDate: s.next_payment_due_date || undefined,\n          interestRateType: s.interest_rate_percentage ? 'fixed' : 'variable',\n          interestRatePct: s.interest_rate_percentage || 0,\n          originalLoanAmount: s.origination_principal_amount || undefined,\n          originationDate: s.origination_date || undefined,\n          maturityDate: s.expected_payoff_date || undefined,\n          studentLoan: {\n            guarantor: s.guarantor || undefined,\n            interestPaidYTD: s.ytd_interest_paid || undefined,\n            servicerName: s.servicer_address?.name || undefined,\n            repaymentPlan: mapRepaymentPlan(s.repayment_plan?.type),\n            pslf: s.pslf_status ? {\n              isEligible: s.pslf_status.estimated_eligibility_date != null,\n              qualifyingPayments: s.pslf_status.payments_made || 0,\n            } : undefined,\n          },\n          taxDeductibleInterest: true,\n          interestDeductionLimit: 2500,\n          scheduleRef: '1040 Line 21 / Form 1098-E',\n        })\n      }\n\n      return envelope(this.provider, liabilities)\n    } catch (err) {\n      return this.handleError(err)\n    }\n  }\n\n  // ── Error Handler ─────────────────────────────────────────────────────\n\n  private handleError<T>(err: unknown): FinTechResponse<T> {\n    if (err instanceof PlaidError) {\n      const type = err.errorType === 'INVALID_REQUEST' ? 'validation' as const\n        : err.errorType === 'INVALID_INPUT' ? 'validation' as const\n          : err.errorType === 'RATE_LIMIT_EXCEEDED' ? 'rate_limit' as const\n            : err.errorType === 'ITEM_ERROR' ? 'connection_error' as const\n              : 'api_error' as const\n      return errorEnvelope(this.provider, err.code, err.message, type)\n    }\n    return errorEnvelope(this.provider, 'UNKNOWN', (err as Error).message)\n  }\n}\n\nclass PlaidError extends Error {\n  constructor(\n    public code: string,\n    message: string,\n    public errorType: string,\n  ) {\n    super(message)\n  }\n}\n\n// ═══════════════════════════════════════════════════════════════════════════\n//  UNIT ADAPTER\n// ═══════════════════════════════════════════════════════════════════════════\n\n/**\n * Unit API adapter.\n * Banking-as-a-Service: deposit accounts, debit cards, ACH, wires,\n * check deposits, KYC/KYB verification.\n *\n * API Reference: https://docs.unit.co/\n */\nexport class UnitAdapter implements FinTechAdapter {\n  readonly provider: FinTechProvider = 'unit'\n  private config: ProviderConfig\n\n  constructor(config: Omit<ProviderConfig, 'provider'>) {\n    this.config = { ...config, provider: 'unit' }\n    if (!this.config.baseUrl) {\n      this.config.baseUrl = config.environment === 'production'\n        ? 'https://api.s.unit.sh'\n        : 'https://api.s.unit.sh' // Sandbox uses same base with sandbox token\n    }\n  }\n\n  private async unitRequest<T>(method: string, endpoint: string, body?: Record<string, unknown>): Promise<T> {\n    const resp = await fetch(`${this.config.baseUrl}${endpoint}`, {\n      method,\n      headers: {\n        'Content-Type': 'application/vnd.api+json',\n        'Authorization': `Bearer ${this.config.secret}`,\n      },\n      ...(body ? { body: JSON.stringify(body) } : {}),\n    })\n    if (!resp.ok) {\n      const err = await resp.json().catch(() => ({ errors: [{ title: resp.statusText }] }))\n      throw new Error(err.errors?.[0]?.title || resp.statusText)\n    }\n    return resp.json()\n  }\n\n  // ── Connection (Unit: Application) ────────────────────────────────────\n\n  async createLinkToken(userId: string, _products: FinTechCapability[]) {\n    // Unit uses Applications for onboarding, not link tokens\n    // Return a placeholder — actual flow uses Unit's SDK\n    return envelope(this.provider, {\n      linkToken: `unit_app_${userId}_${Date.now()}`,\n      expiration: new Date(Date.now() + 3600_000).toISOString(),\n    })\n  }\n\n  async exchangePublicToken(_publicToken: string) {\n    return envelope(this.provider, { connectionId: `unit_${Date.now()}`, accessToken: '' })\n  }\n\n  async removeConnection(_connectionId: string) {\n    return envelope<void>(this.provider, undefined as unknown as void)\n  }\n\n  async getConnectionStatus(customerId: string) {\n    try {\n      const data = await this.unitRequest<{ data: UnitCustomer }>('GET', `/customers/${customerId}`)\n      const conn: FinTechConnection = {\n        id: data.data.id,\n        provider: 'unit',\n        institutionId: 'unit',\n        institutionName: 'Unit Banking',\n        status: data.data.attributes.status === 'Active' ? 'active' : 'pending_reauth',\n        accountIds: [],\n        capabilities: ['accounts', 'transactions', 'identity', 'payment_initiation', 'transfer'],\n        createdAt: data.data.attributes.createdAt,\n        updatedAt: data.data.attributes.createdAt,\n      }\n      return envelope(this.provider, conn)\n    } catch (err) {\n      return errorEnvelope<FinTechConnection>(this.provider, 'API_ERROR', (err as Error).message)\n    }\n  }\n\n  // ── Accounts ──────────────────────────────────────────────────────────\n\n  async getAccounts(customerId: string) {\n    try {\n      const data = await this.unitRequest<{ data: UnitAccount[] }>('GET', `/accounts?filter[customerId]=${customerId}`)\n      return envelope(this.provider, data.data.map(normalizeUnitAccount))\n    } catch (err) {\n      return errorEnvelope<FinTechAccount[]>(this.provider, 'API_ERROR', (err as Error).message)\n    }\n  }\n\n  async getAccountBalances(customerId: string, accountIds?: string[]) {\n    return this.getAccounts(customerId) // Unit returns balances with accounts\n  }\n\n  // ── Transactions ──────────────────────────────────────────────────────\n\n  async getTransactions(accountId: string, params: TransactionParams) {\n    try {\n      const query = new URLSearchParams({\n        'filter[accountId]': accountId,\n        'filter[since]': params.startDate,\n        'filter[until]': params.endDate,\n        'page[limit]': String(params.count || 100),\n        'page[offset]': String(params.offset || 0),\n      })\n      const data = await this.unitRequest<{ data: UnitTransaction[] }>('GET', `/transactions?${query}`)\n      return envelope(this.provider, data.data.map(normalizeUnitTransaction))\n    } catch (err) {\n      return errorEnvelope<FinTechTransaction[]>(this.provider, 'API_ERROR', (err as Error).message)\n    }\n  }\n\n  async syncTransactions(_connectionId: string, _cursor?: string): Promise<FinTechResponse<TransactionSyncResult>> {\n    return envelope(this.provider, { added: [], modified: [], removed: [], hasMore: false, nextCursor: '' })\n  }\n\n  // ── Identity (KYC) ───────────────────────────────────────────────────\n\n  async getIdentity(customerId: string) {\n    try {\n      const data = await this.unitRequest<{ data: UnitCustomer }>('GET', `/customers/${customerId}`)\n      const attrs = data.data.attributes\n      const identity: KYCIdentity = {\n        id: data.data.id,\n        provider: 'unit',\n        verificationStatus: attrs.status === 'Active' ? 'verified' : attrs.status === 'Denied' ? 'denied' : 'pending',\n        verifiedAt: attrs.status === 'Active' ? new Date().toISOString() : undefined,\n        legalFirstName: attrs.fullName?.first || '',\n        legalLastName: attrs.fullName?.last || '',\n        dateOfBirth: attrs.dateOfBirth || '',\n        ssnLast4: attrs.ssn ? `***-**-${attrs.ssn.slice(-4)}` : undefined,\n        email: attrs.email || '',\n        emailVerified: true,\n        phone: attrs.phone?.number || '',\n        phoneVerified: true,\n        address: {\n          street1: attrs.address?.street || '',\n          street2: attrs.address?.street2 || undefined,\n          city: attrs.address?.city || '',\n          region: attrs.address?.state || '',\n          postalCode: attrs.address?.postalCode || '',\n          country: attrs.address?.country || 'US',\n        },\n        checksPerformed: ['identity_verification', 'ssn_verification', 'address_verification', 'ofac_screening'],\n      }\n      return envelope(this.provider, identity)\n    } catch (err) {\n      return errorEnvelope<KYCIdentity>(this.provider, 'API_ERROR', (err as Error).message)\n    }\n  }\n}\n\n// ═══════════════════════════════════════════════════════════════════════════\n//  MX ADAPTER (Stub — same interface, different provider)\n// ═══════════════════════════════════════════════════════════════════════════\n\n/**\n * MX API adapter (stub).\n * Enhanced account aggregation with merchant-level enrichment.\n * Full implementation follows same pattern as Plaid/Unit above.\n */\nexport class MXAdapter implements FinTechAdapter {\n  readonly provider: FinTechProvider = 'mx'\n  private config: ProviderConfig\n\n  constructor(config: Omit<ProviderConfig, 'provider'>) {\n    this.config = { ...config, provider: 'mx' }\n    if (!this.config.baseUrl) {\n      this.config.baseUrl = config.environment === 'production'\n        ? 'https://api.mx.com'\n        : 'https://int-api.mx.com'\n    }\n  }\n\n  async createLinkToken(userId: string, _products: FinTechCapability[]) {\n    return envelope(this.provider, { linkToken: `mx_widget_${userId}`, expiration: new Date(Date.now() + 3600_000).toISOString() })\n  }\n  async exchangePublicToken(_pt: string) { return envelope(this.provider, { connectionId: '', accessToken: '' }) }\n  async removeConnection(_id: string) { return envelope<void>(this.provider, undefined as unknown as void) }\n  async getConnectionStatus(_id: string) { return errorEnvelope<FinTechConnection>(this.provider, 'NOT_IMPL', 'MX: implement with API key') }\n  async getAccounts(_id: string) { return errorEnvelope<FinTechAccount[]>(this.provider, 'NOT_IMPL', 'MX: implement with API key') }\n  async getAccountBalances(_id: string) { return errorEnvelope<FinTechAccount[]>(this.provider, 'NOT_IMPL', 'MX: implement with API key') }\n  async getTransactions(_id: string, _p: TransactionParams) { return errorEnvelope<FinTechTransaction[]>(this.provider, 'NOT_IMPL', 'MX: implement with API key') }\n  async syncTransactions(_id: string) { return envelope(this.provider, { added: [], modified: [], removed: [] as string[], hasMore: false, nextCursor: '' } as TransactionSyncResult) }\n  async getIdentity(_id: string) { return errorEnvelope<KYCIdentity>(this.provider, 'NOT_IMPL', 'MX: implement with API key') }\n}\n\n// ─── Plaid Normalization Helpers ──────────────────────────────────────────\n\n// Raw Plaid response types (minimal — only fields we use)\ninterface PlaidAccount {\n  account_id: string; name: string; official_name?: string\n  type: string; subtype: string; mask?: string\n  balances: { current: number | null; available: number | null; limit: number | null; iso_currency_code: string }\n}\ninterface PlaidTransaction {\n  transaction_id: string; account_id: string; amount: number; date: string\n  datetime?: string; authorized_date?: string; pending: boolean\n  name: string; merchant_name?: string; original_description?: string\n  category?: string[]; personal_finance_category?: { primary: string; detailed: string; confidence_level: string }\n  payment_channel: string; payment_meta?: Record<string, string>\n  location?: { address?: string; city?: string; region?: string; postal_code?: string; country?: string; lat?: number; lon?: number; store_number?: string }\n  iso_currency_code: string\n}\ninterface PlaidOwner {\n  names?: string[]; emails?: { data: string }[]; phone_numbers?: { data: string }[]\n  addresses?: { data: { street?: string; city?: string; region?: string; postal_code?: string; country?: string } }[]\n}\ninterface PlaidHolding {\n  account_id: string; security_id: string; quantity: number; cost_basis?: number\n  institution_value?: number; institution_price?: number; institution_price_as_of?: string\n  iso_currency_code?: string\n}\ninterface PlaidSecurity {\n  security_id: string; name?: string; ticker_symbol?: string; cusip?: string\n  isin?: string; sedol?: string; type?: string; is_cash_equivalent?: boolean\n  iso_currency_code?: string; close_price?: number; close_price_as_of?: string\n}\ninterface PlaidCreditLiability {\n  account_id: string; last_statement_balance?: number; minimum_payment_amount?: number\n  last_payment_amount?: number; last_payment_date?: string; next_payment_due_date?: string\n  aprs?: { apr_percentage: number }[]\n}\ninterface PlaidMortgageLiability {\n  account_id: string; current_balance?: number; last_payment_amount?: number\n  last_payment_date?: string; next_payment_due_date?: string; interest_rate?: { type: string; percentage: number }\n  original_balance?: number; origination_date?: string; maturity_date?: string; term?: string\n  escrow_balance?: number; loan_type_description?: string; ytd_interest_paid?: number\n}\ninterface PlaidStudentLiability {\n  account_id: string; outstanding_interest_amount: number; last_statement_balance?: number\n  minimum_payment_amount?: number; last_payment_amount?: number; last_payment_date?: string\n  next_payment_due_date?: string; interest_rate_percentage?: number; origination_principal_amount?: number\n  origination_date?: string; expected_payoff_date?: string; guarantor?: string; ytd_interest_paid?: number\n  servicer_address?: { name?: string }; repayment_plan?: { type?: string }\n  pslf_status?: { estimated_eligibility_date?: string; payments_made?: number }\n}\n\n// Unit response types\ninterface UnitCustomer {\n  id: string\n  attributes: {\n    status: string; createdAt: string; fullName?: { first: string; last: string }\n    dateOfBirth?: string; ssn?: string; email?: string; phone?: { number: string }\n    address?: { street: string; street2?: string; city: string; state: string; postalCode: string; country: string }\n  }\n}\ninterface UnitAccount {\n  id: string\n  type: string\n  attributes: {\n    name: string; createdAt: string; balance: number; available: number\n    routingNumber?: string; accountNumber?: string; currency: string; status: string\n  }\n}\ninterface UnitTransaction {\n  id: string\n  type: string\n  attributes: {\n    amount: number; direction: string; description: string; createdAt: string\n    summary?: string; balance?: number\n  }\n  relationships?: { account?: { data?: { id: string } } }\n}\n\nfunction normalizePlaidAccount(a: PlaidAccount, connId: string): FinTechAccount {\n  return {\n    id: a.account_id, connectionId: connId, provider: 'plaid', institutionName: '',\n    name: a.name, officialName: a.official_name || undefined,\n    type: mapPlaidAccountType(a.type), subtype: mapPlaidSubtype(a.subtype),\n    mask: a.mask || undefined,\n    balances: {\n      current: a.balances.current, available: a.balances.available,\n      limit: a.balances.limit, lastUpdated: new Date().toISOString(),\n    },\n    isoCurrencyCode: a.balances.iso_currency_code || 'USD',\n    taxRelevance: inferTaxRelevance(a.type, a.subtype),\n    providerAccountId: a.account_id,\n    isActive: true, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(),\n  }\n}\n\nfunction normalizePlaidTransaction(t: PlaidTransaction): FinTechTransaction {\n  const isDebit = t.amount > 0 // Plaid: positive = money leaving account\n  return {\n    id: t.transaction_id, accountId: t.account_id, connectionId: '', provider: 'plaid',\n    amount: Math.abs(t.amount), type: isDebit ? 'debit' : 'credit',\n    date: t.date, datetime: t.datetime || undefined, authorizedDate: t.authorized_date || undefined,\n    pending: t.pending,\n    name: t.name, merchantName: t.merchant_name || undefined, originalDescription: t.original_description || undefined,\n    category: {\n      primary: t.personal_finance_category?.primary || t.category?.[0] || 'Other',\n      detailed: t.personal_finance_category?.detailed || t.category?.[1] || undefined,\n      confidenceLevel: t.personal_finance_category?.confidence_level === 'VERY_HIGH' ? 0.95\n        : t.personal_finance_category?.confidence_level === 'HIGH' ? 0.85\n          : t.personal_finance_category?.confidence_level === 'LOW' ? 0.5 : 0.7,\n    },\n    paymentChannel: (t.payment_channel || 'other') as FinTechTransaction['paymentChannel'],\n    location: t.location ? {\n      address: t.location.address || undefined, city: t.location.city || undefined,\n      region: t.location.region || undefined, postalCode: t.location.postal_code || undefined,\n      country: t.location.country || undefined, lat: t.location.lat || undefined,\n      lon: t.location.lon || undefined, storeNumber: t.location.store_number || undefined,\n    } : undefined,\n    taxRelevance: { isDeductible: false, deductionPct: 0, isTaxPayment: false, is1099Reportable: false },\n    isoCurrencyCode: t.iso_currency_code || 'USD',\n    providerTransactionId: t.transaction_id,\n  }\n}\n\nfunction normalizeUnitAccount(a: UnitAccount): FinTechAccount {\n  const isChecking = a.type === 'depositAccount'\n  return {\n    id: a.id, connectionId: '', provider: 'unit', institutionName: 'Unit Banking',\n    name: a.attributes.name || (isChecking ? 'Checking' : 'Account'),\n    type: 'depository', subtype: isChecking ? 'checking' : 'savings',\n    balances: {\n      current: a.attributes.balance / 100, available: a.attributes.available / 100,\n      limit: null, lastUpdated: new Date().toISOString(),\n    },\n    routingNumber: a.attributes.routingNumber,\n    accountNumber: a.attributes.accountNumber,\n    isoCurrencyCode: a.attributes.currency || 'USD',\n    taxRelevance: { isTaxAdvantaged: false, taxType: 'taxable', fortunaMapping: 'bank' },\n    providerAccountId: a.id,\n    isActive: a.attributes.status === 'Open', createdAt: a.attributes.createdAt, updatedAt: a.attributes.createdAt,\n  }\n}\n\nfunction normalizeUnitTransaction(t: UnitTransaction): FinTechTransaction {\n  return {\n    id: t.id, accountId: t.relationships?.account?.data?.id || '', connectionId: '', provider: 'unit',\n    amount: Math.abs(t.attributes.amount) / 100,\n    type: t.attributes.direction === 'Debit' ? 'debit' : 'credit',\n    date: t.attributes.createdAt.split('T')[0], datetime: t.attributes.createdAt,\n    pending: false,\n    name: t.attributes.description || t.attributes.summary || '',\n    category: { primary: 'Other' },\n    paymentChannel: 'other',\n    taxRelevance: { isDeductible: false, deductionPct: 0, isTaxPayment: false, is1099Reportable: false },\n    isoCurrencyCode: 'USD',\n    providerTransactionId: t.id,\n  }\n}\n\n// ─── Type Mapping Helpers ─────────────────────────────────────────────────\n\nconst PLAID_PRODUCT_MAP: Record<string, string> = {\n  accounts: 'transactions', transactions: 'transactions', balance: 'transactions',\n  identity: 'identity', investments: 'investments', liabilities: 'liabilities',\n  income: 'income_verification', assets: 'assets', recurring: 'transactions',\n  payment_initiation: 'payment_initiation', transfer: 'transfer',\n}\n\nfunction mapPlaidAccountType(type: string): AccountType {\n  switch (type) {\n    case 'depository': return 'depository'\n    case 'credit': return 'credit'\n    case 'investment': return 'investment'\n    case 'loan': return 'loan'\n    default: return 'other'\n  }\n}\n\nfunction mapPlaidSubtype(subtype: string): AccountSubtype {\n  const map: Record<string, AccountSubtype> = {\n    checking: 'checking', savings: 'savings', 'money market': 'money_market', cd: 'cd',\n    hsa: 'hsa', 'cash management': 'cash_management',\n    'credit card': 'credit_card', 'line of credit': 'line_of_credit', paypal: 'paypal',\n    '401k': '401k', '401a': '401a', '403b': '403b', '457b': '457b', ira: 'ira',\n    'roth ira': 'roth_ira', 'roth 401k': 'roth_401k', 'sep ira': 'sep_ira',\n    'simple ira': 'simple_ira', brokerage: 'brokerage', pension: 'pension',\n    '529': '529', trust: 'trust', ugma: 'ugma', utma: 'utma',\n    'stock plan': 'stock_plan', 'profit sharing': 'profit_sharing',\n    mortgage: 'mortgage', student: 'student', auto: 'auto', personal: 'personal',\n    'home equity': 'home_equity', commercial: 'commercial',\n    payroll: 'payroll', prepaid: 'prepaid', rewards: 'rewards',\n  }\n  return map[subtype] || 'other'\n}\n\nfunction mapPlaidSecurityType(type?: string): Security['type'] {\n  const map: Record<string, Security['type']> = {\n    equity: 'equity', etf: 'etf', 'mutual fund': 'mutual_fund', bond: 'bond',\n    'fixed income': 'fixed_income', option: 'option', cryptocurrency: 'cryptocurrency',\n    cash: 'cash', derivative: 'derivative',\n  }\n  return (type && map[type]) || 'other'\n}\n\nfunction inferTaxRelevance(type: string, subtype: string): AccountTaxRelevance {\n  const taxAdvantaged = ['401k', '401a', '403b', '457b', 'ira', 'roth ira', 'roth 401k',\n    'sep ira', 'simple ira', 'hsa', '529', 'pension', 'profit sharing'].includes(subtype)\n\n  const taxType = subtype.includes('roth') ? 'roth' as const\n    : subtype === 'hsa' ? 'tax_free' as const\n      : taxAdvantaged ? 'pre_tax' as const : 'taxable' as const\n\n  const fortunaMapping = taxAdvantaged ? 'retirement' as const\n    : type === 'investment' ? 'investment' as const\n      : type === 'loan' ? 'liability' as const\n        : subtype === 'hsa' ? 'hsa' as const\n          : subtype === '529' ? 'education' as const : 'bank' as const\n\n  return { isTaxAdvantaged: taxAdvantaged, taxType, fortunaMapping }\n}\n\nfunction mapMortgageType(desc?: string): LiabilityDetail['mortgage'] extends { loanType: infer T } ? T : never {\n  if (!desc) return 'other' as any\n  const d = desc.toLowerCase()\n  if (d.includes('fha')) return 'fha' as any\n  if (d.includes('va')) return 'va' as any\n  if (d.includes('usda')) return 'usda' as any\n  if (d.includes('jumbo')) return 'jumbo' as any\n  return 'conventional' as any\n}\n\nfunction mapRepaymentPlan(type?: string): 'standard' | 'graduated' | 'income_driven' | 'extended' | 'other' {\n  if (!type) return 'other'\n  const t = type.toLowerCase()\n  if (t.includes('income')) return 'income_driven'\n  if (t.includes('graduated')) return 'graduated'\n  if (t.includes('extended')) return 'extended'\n  if (t.includes('standard')) return 'standard'\n  return 'other'\n}\n\n// ─── Provider Factory ─────────────────────────────────────────────────────\n\n/**\n * Create a FinTech adapter for the specified provider.\n */\nexport function createAdapter(config: ProviderConfig): FinTechAdapter {\n  switch (config.provider) {\n    case 'plaid': return new PlaidAdapter(config)\n    case 'unit': return new UnitAdapter(config)\n    case 'mx': return new MXAdapter(config)\n    default: throw new Error(`Unsupported provider: ${config.provider}`)\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\fintech-bridge.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'InvestmentTransaction' is defined but never used.","line":26,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":26,"endColumn":24,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"InvestmentTransaction"},"fix":{"range":[951,976],"text":""},"desc":"Remove unused variable \"InvestmentTransaction\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AccountType' is defined but never used.","line":27,"column":40,"nodeType":"Identifier","messageId":"unusedVar","endLine":27,"endColumn":51,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AccountType"},"fix":{"range":[1066,1079],"text":""},"desc":"Remove unused variable \"AccountType\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DepreciationAsset' is defined but never used.","line":31,"column":39,"nodeType":"Identifier","messageId":"unusedVar","endLine":31,"endColumn":56,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DepreciationAsset"},"fix":{"range":[1233,1252],"text":""},"desc":"Remove unused variable \"DepreciationAsset\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'EnrichedTransaction' is defined but never used.","line":33,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":33,"endColumn":53,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"EnrichedTransaction"},"fix":{"range":[1299,1325],"text":""},"desc":"Remove unused variable \"EnrichedTransaction\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_' is defined but never used.","line":220,"column":87,"nodeType":"Identifier","messageId":"unusedVar","endLine":220,"endColumn":88},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'identity' is defined but never used.","line":403,"column":36,"nodeType":"Identifier","messageId":"unusedVar","endLine":403,"endColumn":44},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":537,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":537,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19576,19579],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19576,19579],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — FinTech Bridge\n *\n * Maps canonical FinTech data (accounts, transactions, investments,\n * liabilities, identity, income) into FortunaState fields.\n *\n * This is the integration heart:\n *\n *   External Provider → Canonical Model → FinTech Bridge → FortunaState\n *        (Plaid)         (fintech-models)    (this file)     (storage)\n *\n * The bridge performs:\n *   1. Account → Fortuna bank accounts, retirement accounts, investment positions\n *   2. Transactions → BankTransactions with tax categorization\n *   3. Investments → Portfolio positions with cost basis + tax lots\n *   4. Liabilities → Deductible interest tracking (mortgage, student loan)\n *   5. Identity → KYC data for entity / filing profile\n *   6. Income → W-2 / income stream mapping\n *   7. Recurring → Automated expense/income stream detection\n *\n * @module fintech-bridge\n */\n\nimport type {\n  FinTechAccount, FinTechTransaction, InvestmentHolding, Security,\n  InvestmentTransaction, LiabilityDetail, KYCIdentity, KYBBusinessIdentity,\n  IncomeVerification, RecurringStream, AccountType, AccountSubtype,\n} from './fintech-models'\nimport type {\n  FortunaState, IncomeStream, BusinessExpense, LegalEntity,\n  BankTransaction, RetirementAccount, DepreciationAsset,\n} from './storage'\nimport { enrichTransaction, type EnrichedTransaction } from './fintech-enrichment'\n\n// ─── Bridge Result ────────────────────────────────────────────────────────\n\nexport interface BridgeResult {\n  patch: Partial<FortunaState>\n  summary: BridgeSummary\n}\n\nexport interface BridgeSummary {\n  accountsImported: number\n  transactionsImported: number\n  incomeStreamsDetected: number\n  expensesDetected: number\n  investmentPositions: number\n  retirementAccountsDetected: number\n  liabilitiesDetected: number\n  deductibleInterestFound: number\n  taxPaymentsFound: number\n  recurring1099Vendors: number\n  warnings: string[]\n}\n\n// ─── Account Bridge ───────────────────────────────────────────────────────\n\n/**\n * Map FinTech accounts into Fortuna structures.\n * - Depository → bank account tracking\n * - Investment (tax-advantaged) → RetirementAccount\n * - Investment (taxable) → portfolio position grouping\n * - Loan → liability with deductible interest\n * - Credit → liability tracking\n */\nexport function bridgeAccounts(accounts: FinTechAccount[]): {\n  retirementAccounts: Partial<RetirementAccount>[]\n  bankSummary: { name: string; type: string; balance: number; mask?: string }[]\n  creditCards: { name: string; balance: number; limit: number | null; apr?: number }[]\n} {\n  const retirementAccounts: Partial<RetirementAccount>[] = []\n  const bankSummary: { name: string; type: string; balance: number; mask?: string }[] = []\n  const creditCards: { name: string; balance: number; limit: number | null; apr?: number }[] = []\n\n  for (const acct of accounts) {\n    // Tax-advantaged investment accounts → RetirementAccount\n    if (acct.taxRelevance.isTaxAdvantaged && acct.taxRelevance.fortunaMapping === 'retirement') {\n      retirementAccounts.push({\n        id: `fintech_${acct.id}`,\n        type: mapSubtypeToRetirementType(acct.subtype),\n        provider: acct.institutionName || acct.name,\n        currentBalance: acct.balances.current || 0,\n        // Annual contribution tracked separately\n        annualContribution: 0,\n        employerMatch: 0,\n        notes: `Linked via ${acct.provider} (${acct.mask ? '···' + acct.mask : acct.name})`,\n      })\n    }\n\n    // Depository accounts → bank summary\n    if (acct.type === 'depository') {\n      bankSummary.push({\n        name: acct.officialName || acct.name,\n        type: acct.subtype,\n        balance: acct.balances.current || 0,\n        mask: acct.mask,\n      })\n    }\n\n    // Credit accounts → credit card tracking\n    if (acct.type === 'credit') {\n      creditCards.push({\n        name: acct.officialName || acct.name,\n        balance: acct.balances.current || 0,\n        limit: acct.balances.limit,\n      })\n    }\n  }\n\n  return { retirementAccounts, bankSummary, creditCards }\n}\n\nfunction mapSubtypeToRetirementType(subtype: AccountSubtype): string {\n  const map: Record<string, string> = {\n    '401k': '401k', '401a': '401k', '403b': '403b', '457b': '457b',\n    'ira': 'traditional_ira', 'roth_ira': 'roth_ira', 'roth_401k': 'roth_401k',\n    'sep_ira': 'sep_ira', 'simple_ira': 'simple_ira',\n    'pension': 'pension', 'profit_sharing': '401k',\n  }\n  return map[subtype] || 'other'\n}\n\n// ─── Transaction Bridge ──────────────────────────────────────────────────\n\n/**\n * Map FinTech transactions into Fortuna BankTransactions with tax enrichment.\n * Each transaction runs through the enrichment engine to assign:\n *   - Tax category (Schedule C/E/A/B/D references)\n *   - Deductibility and percentage\n *   - Income vs expense classification\n *   - 1099 reportability\n */\nexport function bridgeTransactions(\n  transactions: FinTechTransaction[],\n): {\n  bankTransactions: BankTransaction[]\n  incomeStreams: Partial<IncomeStream>[]\n  expenses: Partial<BusinessExpense>[]\n  taxPayments: { date: string; amount: number; type: string; description: string }[]\n  stats: {\n    total: number; income: number; expense: number; transfer: number\n    deductible: number; taxPayments: number; recurring1099: number\n  }\n} {\n  const bankTransactions: BankTransaction[] = []\n  const incomeAgg: Map<string, { total: number; count: number; name: string; type: string }> = new Map()\n  const expenseAgg: Map<string, { total: number; count: number; category: string; description: string; deductible: boolean; pct: number; schedule?: string }> = new Map()\n  const taxPayments: { date: string; amount: number; type: string; description: string }[] = []\n  let incomeCount = 0, expenseCount = 0, transferCount = 0, deductibleCount = 0, taxPaymentCount = 0\n\n  for (const txn of transactions) {\n    // Enrich with tax intelligence\n    const enriched = enrichTransaction(txn)\n\n    // Create BankTransaction\n    const bt: BankTransaction = {\n      id: `ft_${txn.id}`,\n      date: txn.date,\n      description: txn.merchantName || txn.name,\n      amount: txn.type === 'credit' ? txn.amount : -txn.amount,\n      category: enriched.fortunaCategory || txn.category.primary,\n      isReconciled: !txn.pending,\n      accountName: txn.accountId,\n    }\n    bankTransactions.push(bt)\n\n    // Aggregate income\n    if (txn.type === 'credit' && !isTransfer(txn)) {\n      incomeCount++\n      const key = enriched.fortunaCategory || 'other_income'\n      const existing = incomeAgg.get(key) || { total: 0, count: 0, name: txn.merchantName || txn.name, type: 'other' }\n      existing.total += txn.amount\n      existing.count++\n      if (enriched.incomeType) existing.type = enriched.incomeType\n      incomeAgg.set(key, existing)\n    }\n\n    // Aggregate expenses\n    if (txn.type === 'debit' && !isTransfer(txn)) {\n      expenseCount++\n      if (enriched.isDeductible) deductibleCount++\n\n      const key = enriched.fortunaCategory || txn.category.primary || 'uncategorized'\n      const existing = expenseAgg.get(key) || {\n        total: 0, count: 0, category: key,\n        description: enriched.fortunaCategory || txn.category.primary || 'Other',\n        deductible: enriched.isDeductible, pct: enriched.deductionPct,\n        schedule: enriched.scheduleRef,\n      }\n      existing.total += txn.amount\n      existing.count++\n      expenseAgg.set(key, existing)\n    }\n\n    // Transfer tracking\n    if (isTransfer(txn)) transferCount++\n\n    // Tax payments\n    if (enriched.isTaxPayment) {\n      taxPaymentCount++\n      taxPayments.push({\n        date: txn.date,\n        amount: txn.amount,\n        type: enriched.taxPaymentType || 'estimated',\n        description: txn.merchantName || txn.name,\n      })\n    }\n  }\n\n  // Convert aggregated income to IncomeStreams\n  const incomeStreams: Partial<IncomeStream>[] = Array.from(incomeAgg.entries()).map(([key, data]) => ({\n    name: data.name || key,\n    type: mapIncomeType(data.type),\n    annualAmount: Math.round(data.total * 100) / 100,\n    isActive: true,\n    notes: `FinTech import: ${data.count} transactions`,\n  }))\n\n  // Convert aggregated expenses to BusinessExpenses\n  const expenses: Partial<BusinessExpense>[] = Array.from(expenseAgg.entries()).map(([_, data]) => ({\n    category: data.category,\n    description: `${data.description} (${data.count} transactions)`,\n    annualAmount: Math.round(data.total * 100) / 100,\n    isDeductible: data.deductible,\n    deductionPct: data.pct,\n  }))\n\n  return {\n    bankTransactions,\n    incomeStreams,\n    expenses,\n    taxPayments,\n    stats: {\n      total: transactions.length,\n      income: incomeCount,\n      expense: expenseCount,\n      transfer: transferCount,\n      deductible: deductibleCount,\n      taxPayments: taxPaymentCount,\n      recurring1099: 0, // Computed in recurring bridge\n    },\n  }\n}\n\nfunction isTransfer(txn: FinTechTransaction): boolean {\n  const cat = (txn.category.primary || '').toLowerCase()\n  return txn.type === 'transfer' || cat.includes('transfer') || cat === 'payment'\n}\n\nfunction mapIncomeType(type: string): IncomeStream['type'] {\n  const map: Record<string, IncomeStream['type']> = {\n    employment: 'w2', self_employment: 'freelance', business: 'business',\n    investment: 'investment', rental: 'rental', passive: 'passive',\n  }\n  return map[type] || 'other'\n}\n\n// ─── Investment Bridge ───────────────────────────────────────────────────\n\nexport interface BridgedPortfolio {\n  positions: {\n    id: string\n    symbol?: string\n    name: string\n    securityType: string\n    quantity: number\n    costBasis: number\n    marketValue: number\n    unrealizedGainLoss: number\n    isLongTerm: boolean\n    accountId: string\n    accountSubtype?: string\n  }[]\n  totalMarketValue: number\n  totalCostBasis: number\n  totalUnrealizedGL: number\n  shortTermGL: number\n  longTermGL: number\n  taxLossHarvestingCandidates: { symbol: string; loss: number; isLongTerm: boolean }[]\n}\n\nexport function bridgeInvestments(\n  holdings: InvestmentHolding[],\n  securities: Security[],\n  accounts: FinTechAccount[],\n): BridgedPortfolio {\n  const secMap = new Map(securities.map(s => [s.id, s]))\n  const acctMap = new Map(accounts.map(a => [a.id, a]))\n\n  const positions = holdings.map(h => {\n    const sec = secMap.get(h.securityId)\n    const acct = acctMap.get(h.accountId)\n    return {\n      id: h.id,\n      symbol: sec?.tickerSymbol || undefined,\n      name: sec?.name || 'Unknown Security',\n      securityType: sec?.type || 'other',\n      quantity: h.quantity,\n      costBasis: h.costBasis,\n      marketValue: h.marketValue,\n      unrealizedGainLoss: h.unrealizedGainLoss,\n      isLongTerm: h.isLongTerm,\n      accountId: h.accountId,\n      accountSubtype: acct?.subtype,\n    }\n  })\n\n  const totalMarketValue = positions.reduce((s, p) => s + p.marketValue, 0)\n  const totalCostBasis = positions.reduce((s, p) => s + p.costBasis, 0)\n  const totalUnrealizedGL = positions.reduce((s, p) => s + p.unrealizedGainLoss, 0)\n  const shortTermGL = positions.filter(p => !p.isLongTerm).reduce((s, p) => s + p.unrealizedGainLoss, 0)\n  const longTermGL = positions.filter(p => p.isLongTerm).reduce((s, p) => s + p.unrealizedGainLoss, 0)\n\n  // Tax-loss harvesting candidates: taxable accounts with unrealized losses\n  const taxLossHarvestingCandidates = positions\n    .filter(p => p.unrealizedGainLoss < -50 && !isTaxAdvantaged(p.accountSubtype))\n    .map(p => ({ symbol: p.symbol || p.name, loss: Math.abs(p.unrealizedGainLoss), isLongTerm: p.isLongTerm }))\n    .sort((a, b) => b.loss - a.loss)\n\n  return { positions, totalMarketValue, totalCostBasis, totalUnrealizedGL, shortTermGL, longTermGL, taxLossHarvestingCandidates }\n}\n\nfunction isTaxAdvantaged(subtype?: string): boolean {\n  return ['401k', '401a', '403b', '457b', 'ira', 'roth_ira', 'roth_401k', 'sep_ira', 'simple_ira', 'pension', 'profit_sharing', '529'].includes(subtype || '')\n}\n\n// ─── Liability Bridge ────────────────────────────────────────────────────\n\nexport interface BridgedLiabilities {\n  deductibleInterest: {\n    type: string\n    annualInterest: number\n    scheduleRef: string\n    description: string\n  }[]\n  totalDeductibleInterest: number\n  mortgages: { balance: number; rate: number; interestYTD: number; address?: string }[]\n  studentLoans: { balance: number; rate: number; interestYTD: number; servicer?: string }[]\n  totalDebt: number\n}\n\nexport function bridgeLiabilities(liabilities: LiabilityDetail[]): BridgedLiabilities {\n  const deductibleInterest: BridgedLiabilities['deductibleInterest'] = []\n  const mortgages: BridgedLiabilities['mortgages'] = []\n  const studentLoans: BridgedLiabilities['studentLoans'] = []\n\n  for (const l of liabilities) {\n    // Mortgage interest deduction (Schedule A / Form 1098)\n    if (l.type === 'mortgage' && l.taxDeductibleInterest) {\n      const ytdInterest = l.mortgage?.interestPaidYTD || estimateAnnualInterest(l.currentBalance, l.interestRatePct)\n      deductibleInterest.push({\n        type: 'mortgage_interest',\n        annualInterest: ytdInterest,\n        scheduleRef: l.scheduleRef || 'Schedule A Line 8a',\n        description: `Mortgage (${l.mortgage?.loanType || 'conventional'}) — ${(l.interestRatePct).toFixed(2)}% APR`,\n      })\n      mortgages.push({\n        balance: l.currentBalance,\n        rate: l.interestRatePct,\n        interestYTD: ytdInterest,\n        address: l.mortgage?.propertyAddress ? formatAddress(l.mortgage.propertyAddress) : undefined,\n      })\n    }\n\n    // Student loan interest deduction (Form 1098-E / 1040 adjustment)\n    if (l.type === 'student' && l.taxDeductibleInterest) {\n      const ytdInterest = l.studentLoan?.interestPaidYTD || estimateAnnualInterest(l.currentBalance, l.interestRatePct)\n      const capped = Math.min(ytdInterest, l.interestDeductionLimit || 2500)\n      deductibleInterest.push({\n        type: 'student_loan_interest',\n        annualInterest: capped,\n        scheduleRef: l.scheduleRef || '1040 Schedule 1 Line 21',\n        description: `Student Loan — ${l.studentLoan?.servicer || 'Unknown servicer'} @ ${l.interestRatePct.toFixed(2)}%`,\n      })\n      studentLoans.push({\n        balance: l.currentBalance,\n        rate: l.interestRatePct,\n        interestYTD: ytdInterest,\n        servicer: l.studentLoan?.servicerName,\n      })\n    }\n  }\n\n  return {\n    deductibleInterest,\n    totalDeductibleInterest: deductibleInterest.reduce((s, d) => s + d.annualInterest, 0),\n    mortgages,\n    studentLoans,\n    totalDebt: liabilities.reduce((s, l) => s + l.currentBalance, 0),\n  }\n}\n\nfunction estimateAnnualInterest(balance: number, ratePct: number): number {\n  return Math.round(balance * (ratePct / 100) * 100) / 100\n}\n\nfunction formatAddress(addr: { street1?: string; city?: string; region?: string; postalCode?: string }): string {\n  return [addr.street1, addr.city, addr.region, addr.postalCode].filter(Boolean).join(', ')\n}\n\n// ─── Identity Bridge (KYC → Filing Profile) ─────────────────────────────\n\nexport function bridgeKYCToProfile(identity: KYCIdentity): Partial<FortunaState> {\n  return {\n    // These map to the user profile / household section\n    // The actual field mapping depends on FortunaState structure\n  }\n}\n\n// ─── Business Identity Bridge (KYB → Entity) ────────────────────────────\n\nexport function bridgeKYBToEntity(kyb: KYBBusinessIdentity): Partial<LegalEntity> {\n  const entityTypeMap: Record<string, string> = {\n    sole_proprietorship: 'sole_prop', single_member_llc: 'llc',\n    multi_member_llc: 'llc', partnership: 'partnership',\n    limited_partnership: 'partnership', s_corporation: 's_corp',\n    c_corporation: 'c_corp', nonprofit: 'nonprofit', trust: 'trust',\n  }\n  return {\n    name: kyb.dbaName || kyb.legalName,\n    type: (entityTypeMap[kyb.entityType] || 'llc') as LegalEntity['type'],\n    state: kyb.formationState,\n    einNumber: kyb.ein || undefined,\n    formationDate: kyb.formationDate || undefined,\n    isActive: kyb.verificationStatus === 'verified',\n    notes: `KYB verified via ${kyb.provider} — ${kyb.legalName} (${kyb.entityType})`,\n  }\n}\n\n// ─── Income Verification Bridge ──────────────────────────────────────────\n\nexport function bridgeIncomeVerification(iv: IncomeVerification): Partial<IncomeStream>[] {\n  const streams: Partial<IncomeStream>[] = []\n\n  for (const s of iv.streams) {\n    streams.push({\n      name: s.name,\n      type: s.type === 'employment' ? 'w2' : s.type === 'self_employment' ? 'freelance' : 'other',\n      annualAmount: s.annualizedAmount,\n      isActive: s.isActive,\n      notes: `Verified income (${(s.confidence * 100).toFixed(0)}% confidence, ${s.frequency})`,\n    })\n  }\n\n  // W-2 data\n  for (const w2 of (iv.w2s || [])) {\n    streams.push({\n      name: w2.employerName,\n      type: 'w2',\n      annualAmount: w2.wages,\n      isActive: true,\n      w2: {\n        employerName: w2.employerName,\n        grossSalary: w2.wages,\n        federalWithholding: w2.federalWithholding,\n        stateWithholding: w2.stateTaxInfo?.[0]?.stateTax || 0,\n        ficaWithheld: w2.socialSecurityTax + w2.medicareTax,\n        pretax401k: w2.box12Codes?.find(c => c.code === 'D')?.amount || 0,\n        pretaxHealthInsurance: w2.box12Codes?.find(c => c.code === 'DD')?.amount || 0,\n        pretaxHSA: w2.box12Codes?.find(c => c.code === 'W')?.amount || 0,\n      },\n      notes: `W-2 from ${w2.employerName} (EIN: ${w2.employerEin}) — Tax Year ${w2.taxYear}`,\n    })\n  }\n\n  return streams\n}\n\n// ─── Recurring Stream Bridge ─────────────────────────────────────────────\n\nexport function bridgeRecurringStreams(streams: RecurringStream[]): {\n  incomeStreams: Partial<IncomeStream>[]\n  expenses: Partial<BusinessExpense>[]\n} {\n  const incomeStreams: Partial<IncomeStream>[] = []\n  const expenses: Partial<BusinessExpense>[] = []\n\n  for (const s of streams) {\n    if (!s.isActive) continue\n\n    const annualized = annualizeAmount(s.averageAmount, s.frequency)\n\n    if (s.streamType === 'income') {\n      incomeStreams.push({\n        name: s.merchantName || s.description,\n        type: 'other',\n        annualAmount: annualized,\n        isActive: true,\n        notes: `Recurring ${s.frequency} income (${s.confidence >= 0.8 ? 'high' : 'medium'} confidence)`,\n      })\n    } else {\n      expenses.push({\n        category: s.category || 'recurring',\n        description: `${s.merchantName || s.description} (${s.frequency})`,\n        annualAmount: annualized,\n        isDeductible: false, // Needs manual review\n        deductionPct: 0,\n      })\n    }\n  }\n\n  return { incomeStreams, expenses }\n}\n\nfunction annualizeAmount(amount: number, freq: string): number {\n  const multipliers: Record<string, number> = {\n    weekly: 52, biweekly: 26, semimonthly: 24, monthly: 12,\n    quarterly: 4, annual: 1, irregular: 12,\n  }\n  return Math.round(amount * (multipliers[freq] || 12) * 100) / 100\n}\n\n// ─── Full Bridge Pipeline ────────────────────────────────────────────────\n\n/**\n * Run the complete bridge pipeline: accounts + transactions + investments +\n * liabilities + income → FortunaState patch with comprehensive summary.\n */\nexport function runFullBridge(data: {\n  accounts?: FinTechAccount[]\n  transactions?: FinTechTransaction[]\n  holdings?: InvestmentHolding[]\n  securities?: Security[]\n  liabilities?: LiabilityDetail[]\n  incomeVerification?: IncomeVerification\n  recurringStreams?: RecurringStream[]\n  kybIdentity?: KYBBusinessIdentity\n}): BridgeResult {\n  const warnings: string[] = []\n  const patch: Partial<FortunaState> = {}\n\n  // 1. Accounts\n  let retirementCount = 0\n  if (data.accounts?.length) {\n    const acctBridge = bridgeAccounts(data.accounts)\n    if (acctBridge.retirementAccounts.length) {\n      patch.retirementAccounts = acctBridge.retirementAccounts as any[]\n      retirementCount = acctBridge.retirementAccounts.length\n    }\n    if (acctBridge.creditCards.length) {\n      warnings.push(`${acctBridge.creditCards.length} credit card(s) detected — review for business expense deductions`)\n    }\n  }\n\n  // 2. Transactions\n  let txnStats = { total: 0, income: 0, expense: 0, transfer: 0, deductible: 0, taxPayments: 0, recurring1099: 0 }\n  if (data.transactions?.length) {\n    const txnBridge = bridgeTransactions(data.transactions)\n    patch.bankTransactions = txnBridge.bankTransactions\n    if (txnBridge.incomeStreams.length) {\n      patch.incomeStreams = txnBridge.incomeStreams as IncomeStream[]\n    }\n    if (txnBridge.expenses.length) {\n      patch.expenses = txnBridge.expenses as BusinessExpense[]\n    }\n    txnStats = txnBridge.stats\n    if (txnBridge.taxPayments.length) {\n      warnings.push(`${txnBridge.taxPayments.length} estimated tax payment(s) detected — $${txnBridge.taxPayments.reduce((s, t) => s + t.amount, 0).toLocaleString()} total`)\n    }\n  }\n\n  // 3. Investments\n  let investmentCount = 0\n  let tlhCount = 0\n  if (data.holdings?.length && data.securities?.length) {\n    const portfolio = bridgeInvestments(data.holdings, data.securities, data.accounts || [])\n    investmentCount = portfolio.positions.length\n    tlhCount = portfolio.taxLossHarvestingCandidates.length\n    if (tlhCount > 0) {\n      const totalLoss = portfolio.taxLossHarvestingCandidates.reduce((s, c) => s + c.loss, 0)\n      warnings.push(`${tlhCount} tax-loss harvesting candidate(s) found — potential $${totalLoss.toLocaleString()} in harvestable losses`)\n    }\n  }\n\n  // 4. Liabilities\n  let deductibleInterestTotal = 0\n  if (data.liabilities?.length) {\n    const liabBridge = bridgeLiabilities(data.liabilities)\n    deductibleInterestTotal = liabBridge.totalDeductibleInterest\n    if (deductibleInterestTotal > 0) {\n      warnings.push(`$${deductibleInterestTotal.toLocaleString()} in deductible interest detected (mortgage + student loan)`)\n    }\n  }\n\n  // 5. Income verification → W-2 streams\n  if (data.incomeVerification) {\n    const incStreams = bridgeIncomeVerification(data.incomeVerification)\n    patch.incomeStreams = [...(patch.incomeStreams || []), ...incStreams as IncomeStream[]]\n  }\n\n  // 6. Recurring streams\n  if (data.recurringStreams?.length) {\n    const recurring = bridgeRecurringStreams(data.recurringStreams)\n    patch.incomeStreams = [...(patch.incomeStreams || []), ...recurring.incomeStreams as IncomeStream[]]\n    patch.expenses = [...(patch.expenses || []), ...recurring.expenses as BusinessExpense[]]\n  }\n\n  // 7. KYB → Entity\n  if (data.kybIdentity) {\n    const entity = bridgeKYBToEntity(data.kybIdentity)\n    patch.entities = [entity as LegalEntity]\n  }\n\n  return {\n    patch,\n    summary: {\n      accountsImported: data.accounts?.length || 0,\n      transactionsImported: txnStats.total,\n      incomeStreamsDetected: (patch.incomeStreams?.length || 0),\n      expensesDetected: (patch.expenses?.length || 0),\n      investmentPositions: investmentCount,\n      retirementAccountsDetected: retirementCount,\n      liabilitiesDetected: data.liabilities?.length || 0,\n      deductibleInterestFound: deductibleInterestTotal,\n      taxPaymentsFound: txnStats.taxPayments,\n      recurring1099Vendors: txnStats.recurring1099,\n      warnings,\n    },\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\fintech-connections.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TransactionSyncResult' is defined but never used.","line":22,"column":47,"nodeType":"Identifier","messageId":"unusedVar","endLine":22,"endColumn":68,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TransactionSyncResult"},"fix":{"range":[732,755],"text":""},"desc":"Remove unused variable \"TransactionSyncResult\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":159,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":159,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4988,4991],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4988,4991],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":161,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":161,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5108,5111],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5108,5111],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":224,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":224,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6931,6934],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6931,6934],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":228,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":228,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7130,7133],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7130,7133],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — FinTech Connection Manager\n *\n * Orchestrates connections to financial data providers, manages sync\n * state, handles multi-provider data aggregation, and coordinates\n * the full data pipeline:\n *\n *   Connect → Sync → Normalize → Enrich → Bridge → FortunaState\n *\n * Supports multiple simultaneous providers (e.g., Plaid for bank\n * aggregation + Unit for BaaS + Stripe for payments).\n *\n * @module fintech-connections\n */\n\nimport type {\n  FinTechProvider, FinTechConnection, FinTechAccount,\n  FinTechTransaction, FinTechCapability, FinTechResponse,\n  InvestmentHolding, Security, LiabilityDetail,\n  IncomeVerification, RecurringStream,\n} from './fintech-models'\nimport type { FinTechAdapter, ProviderConfig, TransactionSyncResult } from './fintech-adapters'\nimport { createAdapter } from './fintech-adapters'\nimport { runFullBridge, type BridgeResult } from './fintech-bridge'\nimport { enrichBatch } from './fintech-enrichment'\n\n// ─── Connection Store ─────────────────────────────────────────────────────\n\nexport interface ConnectionState {\n  connections: FinTechConnection[]\n  accounts: FinTechAccount[]\n  syncCursors: Record<string, string>       // connectionId → cursor\n  lastSyncAt: Record<string, string>         // connectionId → ISO date\n  providerConfigs: Record<string, ProviderConfig>\n}\n\nconst DEFAULT_STATE: ConnectionState = {\n  connections: [],\n  accounts: [],\n  syncCursors: {},\n  lastSyncAt: {},\n  providerConfigs: {},\n}\n\nlet state: ConnectionState = { ...DEFAULT_STATE }\nconst adapters: Map<string, FinTechAdapter> = new Map()\n\n// ─── Initialization ───────────────────────────────────────────────────────\n\n/**\n * Initialize the connection manager with saved state.\n */\nexport function initConnectionManager(saved?: Partial<ConnectionState>) {\n  state = { ...DEFAULT_STATE, ...saved }\n  // Recreate adapters from saved configs\n  for (const [key, config] of Object.entries(state.providerConfigs)) {\n    try {\n      adapters.set(key, createAdapter(config))\n    } catch {\n      console.warn(`Failed to create adapter for ${key}`)\n    }\n  }\n}\n\n/**\n * Get current connection state (for persistence).\n */\nexport function getConnectionState(): ConnectionState {\n  return { ...state }\n}\n\n// ─── Provider Registration ────────────────────────────────────────────────\n\n/**\n * Register a new provider with API credentials.\n * Must be called before connecting to any provider.\n */\nexport function registerProvider(config: ProviderConfig): void {\n  const adapter = createAdapter(config)\n  const key = `${config.provider}_${config.clientId.slice(0, 8)}`\n  adapters.set(key, adapter)\n  state.providerConfigs[key] = config\n}\n\n/**\n * Get all registered providers.\n */\nexport function getRegisteredProviders(): { key: string; provider: FinTechProvider; environment: string }[] {\n  return Object.entries(state.providerConfigs).map(([key, config]) => ({\n    key,\n    provider: config.provider,\n    environment: config.environment,\n  }))\n}\n\n/**\n * Remove a provider registration.\n */\nexport function unregisterProvider(key: string): void {\n  adapters.delete(key)\n  delete state.providerConfigs[key]\n}\n\n// ─── Connection Lifecycle ─────────────────────────────────────────────────\n\n/**\n * Create a link token for the Plaid/MX Link widget.\n * Returns a token the frontend passes to the Link component.\n */\nexport async function createLinkToken(\n  adapterKey: string,\n  userId: string,\n  products: FinTechCapability[] = ['accounts', 'transactions'],\n): Promise<FinTechResponse<{ linkToken: string; expiration: string }>> {\n  const adapter = adapters.get(adapterKey)\n  if (!adapter) throw new Error(`No adapter registered for key: ${adapterKey}`)\n  return adapter.createLinkToken(userId, products)\n}\n\n/**\n * Exchange a public token (from Link widget) for an access token.\n * Creates a new connection entry.\n */\nexport async function exchangeToken(\n  adapterKey: string,\n  publicToken: string,\n  institutionName: string = '',\n): Promise<FinTechConnection> {\n  const adapter = adapters.get(adapterKey)\n  if (!adapter) throw new Error(`No adapter registered for key: ${adapterKey}`)\n\n  const result = await adapter.exchangePublicToken(publicToken)\n  if (!result.success || !result.data) throw new Error(result.error?.message || 'Token exchange failed')\n\n  const connection: FinTechConnection = {\n    id: result.data.connectionId,\n    provider: adapter.provider,\n    institutionId: '',\n    institutionName,\n    status: 'active',\n    accountIds: [],\n    capabilities: ['accounts', 'transactions'],\n    createdAt: new Date().toISOString(),\n    updatedAt: new Date().toISOString(),\n    metadata: { adapterKey, accessToken: result.data.accessToken },\n  }\n\n  state.connections.push(connection)\n  return connection\n}\n\n/**\n * Remove a connection and all associated data.\n */\nexport async function removeConnection(connectionId: string): Promise<void> {\n  const conn = state.connections.find(c => c.id === connectionId)\n  if (!conn) return\n\n  const adapterKey = (conn.metadata as any)?.adapterKey\n  const adapter = adapterKey ? adapters.get(adapterKey) : null\n  const accessToken = (conn.metadata as any)?.accessToken\n\n  if (adapter && accessToken) {\n    await adapter.removeConnection(accessToken)\n  }\n\n  state.connections = state.connections.filter(c => c.id !== connectionId)\n  state.accounts = state.accounts.filter(a => a.connectionId !== connectionId)\n  delete state.syncCursors[connectionId]\n  delete state.lastSyncAt[connectionId]\n}\n\n/**\n * Get all connections.\n */\nexport function getConnections(): FinTechConnection[] {\n  return [...state.connections]\n}\n\n/**\n * Get connection by ID.\n */\nexport function getConnection(connectionId: string): FinTechConnection | undefined {\n  return state.connections.find(c => c.id === connectionId)\n}\n\n// ─── Data Sync ────────────────────────────────────────────────────────────\n\nexport interface SyncResult {\n  connectionId: string\n  accounts: FinTechAccount[]\n  transactions: FinTechTransaction[]\n  investments?: { holdings: InvestmentHolding[]; securities: Security[] }\n  liabilities?: LiabilityDetail[]\n  incomeVerification?: IncomeVerification\n  recurringStreams?: RecurringStream[]\n  bridge: BridgeResult\n  enrichmentStats: {\n    totalDeductible: number\n    totalNonDeductible: number\n    totalTaxPayments: number\n    categoryBreakdown: Record<string, { count: number; total: number; deductible: boolean }>\n  }\n  syncedAt: string\n  errors: string[]\n}\n\n/**\n * Full sync for a connection: accounts + transactions + optional data.\n */\nexport async function syncConnection(\n  connectionId: string,\n  options: {\n    includeInvestments?: boolean\n    includeLiabilities?: boolean\n    includeIncome?: boolean\n    includeRecurring?: boolean\n    transactionDays?: number\n  } = {},\n): Promise<SyncResult> {\n  const conn = state.connections.find(c => c.id === connectionId)\n  if (!conn) throw new Error(`Connection not found: ${connectionId}`)\n\n  const adapterKey = (conn.metadata as any)?.adapterKey\n  const adapter = adapterKey ? adapters.get(adapterKey) : null\n  if (!adapter) throw new Error(`No adapter for connection: ${connectionId}`)\n\n  const accessToken = (conn.metadata as any)?.accessToken || connectionId\n  const errors: string[] = []\n  const now = new Date()\n\n  // 1. Fetch accounts\n  let accounts: FinTechAccount[] = []\n  try {\n    const acctResult = await adapter.getAccounts(accessToken)\n    if (acctResult.success && acctResult.data) {\n      accounts = acctResult.data.map(a => ({ ...a, connectionId }))\n      // Update connection's account IDs\n      conn.accountIds = accounts.map(a => a.id)\n      // Merge into state\n      state.accounts = [\n        ...state.accounts.filter(a => a.connectionId !== connectionId),\n        ...accounts,\n      ]\n    }\n  } catch (err) {\n    errors.push(`Accounts: ${(err as Error).message}`)\n  }\n\n  // 2. Sync transactions (incremental if cursor exists)\n  let transactions: FinTechTransaction[] = []\n  try {\n    const cursor = state.syncCursors[connectionId]\n    if (adapter.syncTransactions) {\n      // Incremental sync\n      let hasMore = true\n      let syncCursor = cursor\n      while (hasMore) {\n        const syncResult = await adapter.syncTransactions(accessToken, syncCursor)\n        if (syncResult.success && syncResult.data) {\n          transactions.push(...syncResult.data.added)\n          hasMore = syncResult.data.hasMore\n          syncCursor = syncResult.data.nextCursor\n        } else {\n          hasMore = false\n        }\n      }\n      if (syncCursor) state.syncCursors[connectionId] = syncCursor\n    } else {\n      // Full fetch fallback\n      const days = options.transactionDays || 90\n      const startDate = new Date(now.getTime() - days * 86400_000).toISOString().split('T')[0]\n      const endDate = now.toISOString().split('T')[0]\n      const txnResult = await adapter.getTransactions(accessToken, { startDate, endDate })\n      if (txnResult.success && txnResult.data) {\n        transactions = txnResult.data\n      }\n    }\n  } catch (err) {\n    errors.push(`Transactions: ${(err as Error).message}`)\n  }\n\n  // 3. Optional: Investments\n  let investments: { holdings: InvestmentHolding[]; securities: Security[] } | undefined\n  if (options.includeInvestments && adapter.getInvestmentHoldings) {\n    try {\n      const invResult = await adapter.getInvestmentHoldings(accessToken)\n      if (invResult.success && invResult.data) investments = invResult.data\n    } catch (err) {\n      errors.push(`Investments: ${(err as Error).message}`)\n    }\n  }\n\n  // 4. Optional: Liabilities\n  let liabilities: LiabilityDetail[] | undefined\n  if (options.includeLiabilities && adapter.getLiabilities) {\n    try {\n      const liabResult = await adapter.getLiabilities(accessToken)\n      if (liabResult.success && liabResult.data) liabilities = liabResult.data\n    } catch (err) {\n      errors.push(`Liabilities: ${(err as Error).message}`)\n    }\n  }\n\n  // 5. Optional: Income\n  let incomeVerification: IncomeVerification | undefined\n  if (options.includeIncome && adapter.getIncomeVerification) {\n    try {\n      const incResult = await adapter.getIncomeVerification(accessToken)\n      if (incResult.success && incResult.data) incomeVerification = incResult.data\n    } catch (err) {\n      errors.push(`Income: ${(err as Error).message}`)\n    }\n  }\n\n  // 6. Optional: Recurring\n  let recurringStreams: RecurringStream[] | undefined\n  if (options.includeRecurring && adapter.getRecurringTransactions) {\n    try {\n      const recResult = await adapter.getRecurringTransactions(accessToken)\n      if (recResult.success && recResult.data) recurringStreams = recResult.data\n    } catch (err) {\n      errors.push(`Recurring: ${(err as Error).message}`)\n    }\n  }\n\n  // 7. Enrich transactions\n  const enrichResult = enrichBatch(transactions)\n\n  // 8. Bridge to FortunaState\n  const bridge = runFullBridge({\n    accounts,\n    transactions,\n    holdings: investments?.holdings,\n    securities: investments?.securities,\n    liabilities,\n    incomeVerification,\n    recurringStreams,\n  })\n\n  // Update sync timestamp\n  state.lastSyncAt[connectionId] = now.toISOString()\n  conn.lastSuccessfulSync = now.toISOString()\n  conn.lastAttemptedSync = now.toISOString()\n  conn.status = errors.length > 0 ? 'degraded' : 'active'\n  conn.updatedAt = now.toISOString()\n\n  return {\n    connectionId,\n    accounts,\n    transactions,\n    investments,\n    liabilities,\n    incomeVerification,\n    recurringStreams,\n    bridge,\n    enrichmentStats: {\n      totalDeductible: enrichResult.stats.totalDeductible,\n      totalNonDeductible: enrichResult.stats.totalNonDeductible,\n      totalTaxPayments: enrichResult.stats.totalTaxPayments,\n      categoryBreakdown: enrichResult.stats.categoryBreakdown,\n    },\n    syncedAt: now.toISOString(),\n    errors,\n  }\n}\n\n/**\n * Sync all active connections.\n */\nexport async function syncAllConnections(options?: {\n  includeInvestments?: boolean\n  includeLiabilities?: boolean\n}): Promise<SyncResult[]> {\n  const results: SyncResult[] = []\n  for (const conn of state.connections) {\n    if (conn.status === 'active' || conn.status === 'degraded') {\n      try {\n        const result = await syncConnection(conn.id, options)\n        results.push(result)\n      } catch (err) {\n        console.error(`Sync failed for ${conn.id}:`, err)\n      }\n    }\n  }\n  return results\n}\n\n// ─── Account Queries ──────────────────────────────────────────────────────\n\n/**\n * Get all accounts across all connections.\n */\nexport function getAllAccounts(): FinTechAccount[] {\n  return [...state.accounts]\n}\n\n/**\n * Get accounts by type.\n */\nexport function getAccountsByType(type: string): FinTechAccount[] {\n  return state.accounts.filter(a => a.type === type)\n}\n\n/**\n * Get total balances across all accounts.\n */\nexport function getAggregateBalances(): {\n  totalAssets: number\n  totalLiabilities: number\n  netWorth: number\n  byType: Record<string, { count: number; balance: number }>\n} {\n  let totalAssets = 0, totalLiabilities = 0\n  const byType: Record<string, { count: number; balance: number }> = {}\n\n  for (const acct of state.accounts) {\n    const balance = acct.balances.current || 0\n    const type = acct.type\n\n    if (!byType[type]) byType[type] = { count: 0, balance: 0 }\n    byType[type].count++\n    byType[type].balance += balance\n\n    if (type === 'credit' || type === 'loan') {\n      totalLiabilities += Math.abs(balance)\n    } else {\n      totalAssets += balance\n    }\n  }\n\n  return { totalAssets, totalLiabilities, netWorth: totalAssets - totalLiabilities, byType }\n}\n\n// ─── Health Check ─────────────────────────────────────────────────────────\n\nexport interface ConnectionHealth {\n  id: string\n  provider: FinTechProvider\n  institution: string\n  status: FinTechConnection['status']\n  lastSync: string | undefined\n  accountCount: number\n  needsReauth: boolean\n  staleDays: number\n}\n\nexport function getConnectionHealth(): ConnectionHealth[] {\n  const now = Date.now()\n  return state.connections.map(conn => {\n    const lastSync = state.lastSyncAt[conn.id]\n    const staleDays = lastSync ? Math.floor((now - new Date(lastSync).getTime()) / 86400_000) : 999\n    return {\n      id: conn.id,\n      provider: conn.provider,\n      institution: conn.institutionName,\n      status: conn.status,\n      lastSync,\n      accountCount: conn.accountIds.length,\n      needsReauth: conn.status === 'pending_reauth' || conn.status === 'error',\n      staleDays,\n    }\n  })\n}\n\n// ─── Supported Providers Reference ────────────────────────────────────────\n\nexport const SUPPORTED_PROVIDERS: {\n  provider: FinTechProvider\n  name: string\n  type: 'aggregation' | 'baas' | 'payments' | 'identity' | 'verification'\n  capabilities: FinTechCapability[]\n  description: string\n  website: string\n  sandboxAvailable: boolean\n}[] = [\n  {\n    provider: 'plaid',\n    name: 'Plaid',\n    type: 'aggregation',\n    capabilities: ['accounts', 'transactions', 'identity', 'investments', 'liabilities', 'income', 'balance', 'recurring', 'transfer'],\n    description: 'Account aggregation — connect bank accounts, credit cards, investments, loans. Transaction enrichment with merchant data.',\n    website: 'https://plaid.com',\n    sandboxAvailable: true,\n  },\n  {\n    provider: 'unit',\n    name: 'Unit',\n    type: 'baas',\n    capabilities: ['accounts', 'transactions', 'identity', 'payment_initiation', 'transfer'],\n    description: 'Banking-as-a-Service — deposit accounts, debit cards, ACH transfers, wires, check deposits. Full KYC/KYB.',\n    website: 'https://unit.co',\n    sandboxAvailable: true,\n  },\n  {\n    provider: 'mx',\n    name: 'MX',\n    type: 'aggregation',\n    capabilities: ['accounts', 'transactions', 'identity', 'balance'],\n    description: 'Account aggregation with enhanced merchant-level enrichment and data cleansing.',\n    website: 'https://mx.com',\n    sandboxAvailable: true,\n  },\n  {\n    provider: 'stripe',\n    name: 'Stripe',\n    type: 'payments',\n    capabilities: ['accounts', 'transactions', 'payment_initiation', 'transfer'],\n    description: 'Payment processing — charges, subscriptions, payouts, treasury, issuing.',\n    website: 'https://stripe.com',\n    sandboxAvailable: true,\n  },\n  {\n    provider: 'yodlee',\n    name: 'Yodlee (Envestnet)',\n    type: 'aggregation',\n    capabilities: ['accounts', 'transactions', 'identity', 'investments', 'balance'],\n    description: 'Enterprise account aggregation with investment data and document retrieval.',\n    website: 'https://yodlee.com',\n    sandboxAvailable: true,\n  },\n  {\n    provider: 'moov',\n    name: 'Moov',\n    type: 'baas',\n    capabilities: ['accounts', 'transactions', 'payment_initiation', 'transfer'],\n    description: 'Money movement — wallets, ACH, card payments, disbursements.',\n    website: 'https://moov.io',\n    sandboxAvailable: true,\n  },\n  {\n    provider: 'alloy',\n    name: 'Alloy',\n    type: 'identity',\n    capabilities: ['identity'],\n    description: 'Identity verification and KYC/KYB decisioning with 200+ data sources.',\n    website: 'https://alloy.com',\n    sandboxAvailable: true,\n  },\n  {\n    provider: 'middesk',\n    name: 'Middesk',\n    type: 'verification',\n    capabilities: ['identity'],\n    description: 'Business verification (KYB) — Secretary of State filings, TIN matching, beneficial ownership.',\n    website: 'https://middesk.com',\n    sandboxAvailable: true,\n  },\n]\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\fintech-enrichment.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'type' is defined but never used.","line":250,"column":58,"nodeType":"Identifier","messageId":"unusedVar","endLine":250,"endColumn":62},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'type' is defined but never used.","line":304,"column":60,"nodeType":"Identifier","messageId":"unusedVar","endLine":304,"endColumn":64}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — FinTech Transaction Enrichment\n *\n * Tax-aware transaction categorization engine. Applies 100+ rules\n * to assign deductibility, schedule references, and Fortuna tax\n * categories to raw bank transactions.\n *\n * Rule precedence:\n *   1. MCC code (most specific)\n *   2. Merchant name pattern (high confidence)\n *   3. Category mapping (moderate confidence)\n *   4. Amount heuristics (low confidence)\n *\n * Every rule produces:\n *   - fortunaCategory: Maps to Fortuna's 25 tax categories\n *   - isDeductible: Boolean\n *   - deductionPct: 0-100 (meals = 50, mileage = 100, entertainment = 0)\n *   - scheduleRef: Tax form line reference\n *   - isTaxPayment: For estimated/quarterly tax payments\n *   - is1099Reportable: For contractor payments ≥ $600\n *\n * @module fintech-enrichment\n */\n\nimport type { FinTechTransaction } from './fintech-models'\n\n// ─── Enrichment Result ────────────────────────────────────────────────────\n\nexport interface EnrichedTransaction {\n  fortunaCategory: string\n  isDeductible: boolean\n  deductionPct: number\n  scheduleRef?: string\n  isTaxPayment: boolean\n  taxPaymentType?: 'estimated_federal' | 'estimated_state' | 'property_tax' | 'sales_tax' | 'payroll_tax'\n  is1099Reportable: boolean\n  incomeType?: string\n  confidence: number           // 0-1\n  ruleMatched?: string         // Which rule triggered\n}\n\n// ─── Enrichment Engine ────────────────────────────────────────────────────\n\nexport function enrichTransaction(txn: FinTechTransaction): EnrichedTransaction {\n  const name = (txn.merchantName || txn.name || '').toLowerCase()\n  const category = (txn.category.primary || '').toLowerCase()\n  const detailed = (txn.category.detailed || '').toLowerCase()\n  const mcc = txn.merchant?.mcc || ''\n\n  // 1. MCC-based rules (highest confidence)\n  const mccResult = matchMCC(mcc)\n  if (mccResult) return { ...mccResult, confidence: 0.95, ruleMatched: `mcc:${mcc}` }\n\n  // 2. Merchant name patterns (high confidence)\n  const nameResult = matchMerchantName(name, txn.amount, txn.type)\n  if (nameResult) return { ...nameResult, confidence: 0.85, ruleMatched: `name:${nameResult.ruleMatched}` }\n\n  // 3. Category-based rules (moderate confidence)\n  const catResult = matchCategory(category, detailed, txn.type)\n  if (catResult) return { ...catResult, confidence: 0.70, ruleMatched: `cat:${category}` }\n\n  // 4. Default — uncategorized\n  return {\n    fortunaCategory: txn.type === 'credit' ? 'other_income' : 'uncategorized',\n    isDeductible: false,\n    deductionPct: 0,\n    isTaxPayment: false,\n    is1099Reportable: false,\n    confidence: 0.3,\n    ruleMatched: 'default',\n  }\n}\n\n// ─── MCC Rules ────────────────────────────────────────────────────────────\n\nconst MCC_RULES: Record<string, Partial<EnrichedTransaction>> = {\n  // Travel\n  '3000-3299': { fortunaCategory: 'travel', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 24a' },\n  '4511': { fortunaCategory: 'travel', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 24a' }, // Airlines\n  '4411': { fortunaCategory: 'travel', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 24a' }, // Cruise\n  '7011': { fortunaCategory: 'travel', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 24a' }, // Hotels\n  '7512': { fortunaCategory: 'vehicle_expense', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 9' }, // Car rental\n\n  // Meals\n  '5812': { fortunaCategory: 'meals', isDeductible: true, deductionPct: 50, scheduleRef: 'Schedule C Line 24b' }, // Restaurants\n  '5813': { fortunaCategory: 'meals', isDeductible: true, deductionPct: 50, scheduleRef: 'Schedule C Line 24b' }, // Bars\n  '5814': { fortunaCategory: 'meals', isDeductible: true, deductionPct: 50, scheduleRef: 'Schedule C Line 24b' }, // Fast food\n\n  // Office supplies\n  '5111': { fortunaCategory: 'office_supplies', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 18' }, // Stationery\n  '5943': { fortunaCategory: 'office_supplies', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 18' }, // Office supplies\n  '5044': { fortunaCategory: 'office_supplies', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 18' }, // Office equipment\n\n  // Software / Tech\n  '5734': { fortunaCategory: 'software', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 27a' }, // Computer software\n  '5045': { fortunaCategory: 'software', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 27a' }, // Computers\n\n  // Auto / Gas\n  '5541': { fortunaCategory: 'vehicle_expense', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 9' }, // Gas stations\n  '5542': { fortunaCategory: 'vehicle_expense', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 9' }, // Automated fuel\n  '7538': { fortunaCategory: 'vehicle_expense', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 9' }, // Auto repair\n  '5571': { fortunaCategory: 'vehicle_expense', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 9' }, // Motorcycle\n\n  // Professional services\n  '8111': { fortunaCategory: 'legal', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 17' }, // Legal\n  '8931': { fortunaCategory: 'professional_fees', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 17' }, // Accounting\n  '7392': { fortunaCategory: 'professional_fees', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 17' }, // Consulting\n\n  // Insurance\n  '6300': { fortunaCategory: 'insurance', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 15' }, // Insurance\n  '6399': { fortunaCategory: 'insurance', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 15' },\n\n  // Education\n  '8220': { fortunaCategory: 'education', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 27a' }, // Colleges\n  '8299': { fortunaCategory: 'education', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 27a' }, // Schools\n\n  // Medical\n  '8011': { fortunaCategory: 'medical', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule A Line 1' }, // Doctors\n  '8021': { fortunaCategory: 'medical', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule A Line 1' }, // Dentists\n  '8099': { fortunaCategory: 'medical', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule A Line 1' }, // Medical services\n  '5912': { fortunaCategory: 'medical', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule A Line 1' }, // Pharmacy\n\n  // Charity\n  '8398': { fortunaCategory: 'charitable', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule A Line 12' }, // Charitable orgs\n  '8661': { fortunaCategory: 'charitable', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule A Line 12' }, // Religious orgs\n\n  // Utilities\n  '4900': { fortunaCategory: 'utilities', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 25' }, // Utilities\n  '4814': { fortunaCategory: 'utilities', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 25' }, // Telecom\n  '4816': { fortunaCategory: 'utilities', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 25' }, // Internet\n\n  // Advertising\n  '7311': { fortunaCategory: 'advertising', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 8' }, // Advertising services\n  '7312': { fortunaCategory: 'advertising', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 8' }, // Billboards\n\n  // Entertainment (non-deductible post-TCJA)\n  '7832': { fortunaCategory: 'entertainment', isDeductible: false, deductionPct: 0 }, // Movie theaters\n  '7941': { fortunaCategory: 'entertainment', isDeductible: false, deductionPct: 0 }, // Sports\n  '7922': { fortunaCategory: 'entertainment', isDeductible: false, deductionPct: 0 }, // Theaters\n\n  // Government — tax payments\n  '9311': { fortunaCategory: 'tax_payment', isDeductible: false, deductionPct: 0, isTaxPayment: true },\n  '9222': { fortunaCategory: 'tax_payment', isDeductible: false, deductionPct: 0, isTaxPayment: true },\n  '9399': { fortunaCategory: 'tax_payment', isDeductible: false, deductionPct: 0, isTaxPayment: true },\n}\n\nfunction matchMCC(mcc: string): Partial<EnrichedTransaction> | null {\n  if (!mcc) return null\n\n  // Direct match\n  if (MCC_RULES[mcc]) return { ...MCC_RULES[mcc], isTaxPayment: MCC_RULES[mcc].isTaxPayment || false, is1099Reportable: false }\n\n  // Range match (e.g., 3000-3299 for airlines)\n  const mccNum = parseInt(mcc)\n  for (const [key, rule] of Object.entries(MCC_RULES)) {\n    if (key.includes('-')) {\n      const [lo, hi] = key.split('-').map(Number)\n      if (mccNum >= lo && mccNum <= hi) return { ...rule, isTaxPayment: rule.isTaxPayment || false, is1099Reportable: false }\n    }\n  }\n\n  return null\n}\n\n// ─── Merchant Name Rules ──────────────────────────────────────────────────\n\ninterface NameRule {\n  pattern: RegExp\n  result: Partial<EnrichedTransaction>\n  name: string\n}\n\nconst MERCHANT_RULES: NameRule[] = [\n  // ── Tax Payments ──────────────────────────────────────────────────────\n  { name: 'irs_payment', pattern: /\\birs\\b|internal revenue|eftps|us treasury.*tax/i, result: { fortunaCategory: 'tax_payment', isDeductible: false, deductionPct: 0, isTaxPayment: true, taxPaymentType: 'estimated_federal' } },\n  { name: 'state_tax', pattern: /state.*tax|franchise tax|dept.*revenue|comptroller/i, result: { fortunaCategory: 'tax_payment', isDeductible: true, deductionPct: 100, isTaxPayment: true, taxPaymentType: 'estimated_state', scheduleRef: 'Schedule A Line 5a' } },\n  { name: 'property_tax', pattern: /property.*tax|county.*tax|real estate.*tax/i, result: { fortunaCategory: 'tax_payment', isDeductible: true, deductionPct: 100, isTaxPayment: true, taxPaymentType: 'property_tax', scheduleRef: 'Schedule A Line 5b' } },\n\n  // ── Software / SaaS ──────────────────────────────────────────────────\n  { name: 'saas', pattern: /\\b(aws|amazon web services|azure|google cloud|gcp|digitalocean|heroku|vercel|netlify|cloudflare|github|gitlab|bitbucket|jira|confluence|slack|notion|figma|canva|adobe|dropbox|google workspace|microsoft 365|zoom|hubspot|salesforce|quickbooks|xero|freshbooks|stripe|twilio|sendgrid|mailchimp|shopify|squarespace|wix)\\b/i, result: { fortunaCategory: 'software', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 27a' } },\n\n  // ── Advertising ──────────────────────────────────────────────────────\n  { name: 'ads', pattern: /\\b(google ads|facebook ads|meta ads|instagram ads|tiktok ads|linkedin ads|bing ads|twitter ads|pinterest ads|amazon ads)\\b|facebk|fb\\.com|goog.*ads/i, result: { fortunaCategory: 'advertising', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 8' } },\n\n  // ── Legal & Professional ─────────────────────────────────────────────\n  { name: 'legal', pattern: /\\b(law office|attorney|legal|law firm|esquire)\\b/i, result: { fortunaCategory: 'legal', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 17', is1099Reportable: true } },\n  { name: 'accounting', pattern: /\\b(cpa|accountant|accounting|tax prep|h&r block|turbotax|jackson hewitt|bookkeeper)\\b/i, result: { fortunaCategory: 'professional_fees', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 17' } },\n\n  // ── Insurance ────────────────────────────────────────────────────────\n  { name: 'health_insurance', pattern: /\\b(blue cross|aetna|cigna|united health|humana|kaiser|anthem|bcbs|health insurance)\\b/i, result: { fortunaCategory: 'health_insurance', isDeductible: true, deductionPct: 100, scheduleRef: '1040 Schedule 1 Line 17' } },\n  { name: 'business_insurance', pattern: /\\b(general liability|business insurance|e&o insurance|professional liability|workers comp)\\b/i, result: { fortunaCategory: 'insurance', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 15' } },\n\n  // ── Meals / Dining ───────────────────────────────────────────────────\n  { name: 'restaurants', pattern: /\\b(restaurant|cafe|coffee|starbucks|mcdonald|burger|pizza|chipotle|panera|subway|taco bell|wendy|chick-fil-a|dunkin|grubhub|doordash|uber eats|postmates|caviar|seamless)\\b/i, result: { fortunaCategory: 'meals', isDeductible: true, deductionPct: 50, scheduleRef: 'Schedule C Line 24b' } },\n\n  // ── Travel ───────────────────────────────────────────────────────────\n  { name: 'airlines', pattern: /\\b(airline|united air|delta air|american air|southwest|jetblue|spirit|frontier|alaska air|hawaiian air)\\b/i, result: { fortunaCategory: 'travel', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 24a' } },\n  { name: 'hotels', pattern: /\\b(marriott|hilton|hyatt|ihg|best western|holiday inn|hampton|courtyard|sheraton|westin|airbnb|vrbo|hotel|motel|resort)\\b/i, result: { fortunaCategory: 'travel', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 24a' } },\n  { name: 'rideshare', pattern: /\\b(uber|lyft|taxi|cab)\\b/i, result: { fortunaCategory: 'travel', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 24a' } },\n\n  // ── Vehicle ──────────────────────────────────────────────────────────\n  { name: 'gas', pattern: /\\b(shell|exxon|mobil|chevron|bp|texaco|sunoco|marathon|speedway|wawa|gas|fuel|petro)\\b/i, result: { fortunaCategory: 'vehicle_expense', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 9' } },\n  { name: 'auto_repair', pattern: /\\b(jiffy lube|midas|firestone|goodyear|autozone|advance auto|o'reilly|napa|pep boys|oil change|auto repair|tire|mechanic)\\b/i, result: { fortunaCategory: 'vehicle_expense', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 9' } },\n  { name: 'parking', pattern: /\\b(parking|parkme|spothero|parkwhiz)\\b/i, result: { fortunaCategory: 'vehicle_expense', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 9' } },\n  { name: 'tolls', pattern: /\\b(toll|ez.?pass|sunpass|fastrak|i-pass)\\b/i, result: { fortunaCategory: 'vehicle_expense', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 9' } },\n\n  // ── Office / Supplies ────────────────────────────────────────────────\n  { name: 'office', pattern: /\\b(office depot|staples|officemax|amazon.*office|paper|toner|printer|ink)\\b/i, result: { fortunaCategory: 'office_supplies', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 18' } },\n\n  // ── Shipping ─────────────────────────────────────────────────────────\n  { name: 'shipping', pattern: /\\b(usps|ups|fedex|dhl|postage|shipping|stamps\\.com)\\b/i, result: { fortunaCategory: 'shipping', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 27a' } },\n\n  // ── Rent ─────────────────────────────────────────────────────────────\n  { name: 'rent', pattern: /\\b(rent|lease payment|commercial lease|office space|coworking|wework|regus)\\b/i, result: { fortunaCategory: 'rent', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 20b' } },\n\n  // ── Utilities ────────────────────────────────────────────────────────\n  { name: 'internet', pattern: /\\b(comcast|xfinity|spectrum|at&t.*internet|verizon.*fios|cox|centurylink|frontier|tmobile.*home|starlink)\\b/i, result: { fortunaCategory: 'utilities', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 25' } },\n  { name: 'phone', pattern: /\\b(verizon|at&t|t-mobile|sprint|us cellular|mint mobile|google fi|visible)\\b(?!.*fios)/i, result: { fortunaCategory: 'utilities', isDeductible: true, deductionPct: 50, scheduleRef: 'Schedule C Line 25' } },\n\n  // ── Education / Training ─────────────────────────────────────────────\n  { name: 'education', pattern: /\\b(udemy|coursera|skillshare|masterclass|linkedin learning|pluralsight|o'reilly|safari|conference|seminar|workshop|training)\\b/i, result: { fortunaCategory: 'education', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 27a' } },\n\n  // ── Subscriptions ────────────────────────────────────────────────────\n  { name: 'subscriptions', pattern: /\\b(netflix|hulu|disney\\+|hbo|spotify|apple music|youtube premium|amazon prime)\\b/i, result: { fortunaCategory: 'entertainment', isDeductible: false, deductionPct: 0 } },\n\n  // ── Charitable ───────────────────────────────────────────────────────\n  { name: 'charity', pattern: /\\b(charity|donation|donat|non.?profit|united way|red cross|salvation army|gofundme|church|synagogue|mosque|temple)\\b/i, result: { fortunaCategory: 'charitable', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule A Line 12' } },\n\n  // ── Banking / Fees ───────────────────────────────────────────────────\n  { name: 'bank_fees', pattern: /\\b(bank fee|service charge|monthly fee|wire fee|overdraft|nsf fee|atm fee|maintenance fee)\\b/i, result: { fortunaCategory: 'bank_fees', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 27a' } },\n\n  // ── Payroll ──────────────────────────────────────────────────────────\n  { name: 'payroll', pattern: /\\b(adp|paychex|gusto|justworks|payroll|quickbooks payroll|square payroll|rippling)\\b/i, result: { fortunaCategory: 'payroll', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 26' } },\n\n  // ── Contractor / 1099 ────────────────────────────────────────────────\n  { name: 'contractor', pattern: /\\b(upwork|fiverr|toptal|freelancer|99designs|contract labor)\\b/i, result: { fortunaCategory: 'contract_labor', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 11', is1099Reportable: true } },\n\n  // ── Retirement ───────────────────────────────────────────────────────\n  { name: 'retirement', pattern: /\\b(fidelity|vanguard|schwab|ameritrade|etrade|merrill|edward jones|retirement|401k|ira|roth)\\b.*\\b(contrib|transfer|deposit)\\b/i, result: { fortunaCategory: 'retirement_contribution', isDeductible: true, deductionPct: 100, scheduleRef: '1040 Schedule 1 Line 20' } },\n\n  // ── Income patterns (credit transactions) ────────────────────────────\n  { name: 'paycheck', pattern: /\\b(payroll|direct deposit|salary|wages|paycheck)\\b/i, result: { fortunaCategory: 'employment_income', isDeductible: false, deductionPct: 0, incomeType: 'employment' } },\n  { name: 'interest_income', pattern: /\\b(interest|dividend|capital gain|distribution)\\b/i, result: { fortunaCategory: 'investment_income', isDeductible: false, deductionPct: 0, incomeType: 'investment' } },\n  { name: 'rental_income', pattern: /\\b(rent received|tenant|rental income|property income)\\b/i, result: { fortunaCategory: 'rental_income', isDeductible: false, deductionPct: 0, incomeType: 'rental' } },\n\n  // ── Transfers (non-taxable) ──────────────────────────────────────────\n  { name: 'transfer', pattern: /\\b(transfer|xfer|ach transfer|wire transfer|internal transfer|zelle|venmo|paypal|cash app)\\b/i, result: { fortunaCategory: 'transfer', isDeductible: false, deductionPct: 0 } },\n]\n\nfunction matchMerchantName(name: string, amount: number, type: string): (Partial<EnrichedTransaction> & { ruleMatched: string }) | null {\n  for (const rule of MERCHANT_RULES) {\n    if (rule.pattern.test(name)) {\n      return {\n        ...rule.result,\n        isTaxPayment: rule.result.isTaxPayment || false,\n        is1099Reportable: rule.result.is1099Reportable && amount >= 600 ? true : false,\n        ruleMatched: rule.name,\n      }\n    }\n  }\n  return null\n}\n\n// ─── Category Rules ───────────────────────────────────────────────────────\n\nconst CATEGORY_RULES: Record<string, Partial<EnrichedTransaction>> = {\n  'food and drink': { fortunaCategory: 'meals', isDeductible: true, deductionPct: 50, scheduleRef: 'Schedule C Line 24b' },\n  'restaurants': { fortunaCategory: 'meals', isDeductible: true, deductionPct: 50, scheduleRef: 'Schedule C Line 24b' },\n  'travel': { fortunaCategory: 'travel', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 24a' },\n  'airlines': { fortunaCategory: 'travel', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 24a' },\n  'lodging': { fortunaCategory: 'travel', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 24a' },\n  'car rental': { fortunaCategory: 'vehicle_expense', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 9' },\n  'gas': { fortunaCategory: 'vehicle_expense', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 9' },\n  'transportation': { fortunaCategory: 'travel', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 24a' },\n  'entertainment': { fortunaCategory: 'entertainment', isDeductible: false, deductionPct: 0 },\n  'recreation': { fortunaCategory: 'entertainment', isDeductible: false, deductionPct: 0 },\n  'medical': { fortunaCategory: 'medical', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule A Line 1' },\n  'healthcare': { fortunaCategory: 'medical', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule A Line 1' },\n  'pharmacy': { fortunaCategory: 'medical', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule A Line 1' },\n  'rent': { fortunaCategory: 'rent', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 20b' },\n  'utilities': { fortunaCategory: 'utilities', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 25' },\n  'internet': { fortunaCategory: 'utilities', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 25' },\n  'phone': { fortunaCategory: 'utilities', isDeductible: true, deductionPct: 50, scheduleRef: 'Schedule C Line 25' },\n  'insurance': { fortunaCategory: 'insurance', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 15' },\n  'office supplies': { fortunaCategory: 'office_supplies', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 18' },\n  'shipping': { fortunaCategory: 'shipping', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 27a' },\n  'education': { fortunaCategory: 'education', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 27a' },\n  'charitable': { fortunaCategory: 'charitable', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule A Line 12' },\n  'government': { fortunaCategory: 'tax_payment', isDeductible: false, deductionPct: 0, isTaxPayment: true },\n  'tax': { fortunaCategory: 'tax_payment', isDeductible: false, deductionPct: 0, isTaxPayment: true },\n  'bank fees': { fortunaCategory: 'bank_fees', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 27a' },\n  'service': { fortunaCategory: 'professional_fees', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 17' },\n  'income': { fortunaCategory: 'business_income', isDeductible: false, deductionPct: 0, incomeType: 'business' },\n  'payroll': { fortunaCategory: 'employment_income', isDeductible: false, deductionPct: 0, incomeType: 'employment' },\n  'transfer': { fortunaCategory: 'transfer', isDeductible: false, deductionPct: 0 },\n  'payment': { fortunaCategory: 'transfer', isDeductible: false, deductionPct: 0 },\n  'general merchandise': { fortunaCategory: 'supplies', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 22' },\n  'home improvement': { fortunaCategory: 'repairs', isDeductible: true, deductionPct: 100, scheduleRef: 'Schedule C Line 21' },\n  'personal care': { fortunaCategory: 'non_deductible', isDeductible: false, deductionPct: 0 },\n  'groceries': { fortunaCategory: 'non_deductible', isDeductible: false, deductionPct: 0 },\n  'clothing': { fortunaCategory: 'non_deductible', isDeductible: false, deductionPct: 0 },\n}\n\nfunction matchCategory(category: string, detailed: string, type: string): Partial<EnrichedTransaction> | null {\n  // Try detailed first\n  if (detailed && CATEGORY_RULES[detailed]) {\n    return { ...CATEGORY_RULES[detailed], isTaxPayment: CATEGORY_RULES[detailed].isTaxPayment || false, is1099Reportable: false }\n  }\n  // Then primary\n  if (category && CATEGORY_RULES[category]) {\n    return { ...CATEGORY_RULES[category], isTaxPayment: CATEGORY_RULES[category].isTaxPayment || false, is1099Reportable: false }\n  }\n  // Partial match\n  for (const [key, rule] of Object.entries(CATEGORY_RULES)) {\n    if (category.includes(key) || detailed.includes(key)) {\n      return { ...rule, isTaxPayment: rule.isTaxPayment || false, is1099Reportable: false }\n    }\n  }\n  return null\n}\n\n// ─── Batch Enrichment ─────────────────────────────────────────────────────\n\n/**\n * Enrich a batch of transactions and return aggregate tax stats.\n */\nexport function enrichBatch(transactions: FinTechTransaction[]): {\n  enriched: (FinTechTransaction & { enrichment: EnrichedTransaction })[]\n  stats: {\n    totalDeductible: number\n    totalNonDeductible: number\n    totalTaxPayments: number\n    totalIncome: number\n    categoryBreakdown: Record<string, { count: number; total: number; deductible: boolean }>\n    confidence: { high: number; medium: number; low: number }\n  }\n} {\n  let totalDeductible = 0, totalNonDeductible = 0, totalTaxPayments = 0, totalIncome = 0\n  const categoryBreakdown: Record<string, { count: number; total: number; deductible: boolean }> = {}\n  let highConf = 0, medConf = 0, lowConf = 0\n\n  const enriched = transactions.map(txn => {\n    const e = enrichTransaction(txn)\n\n    // Stats\n    if (e.isDeductible) totalDeductible += txn.amount\n    else totalNonDeductible += txn.amount\n    if (e.isTaxPayment) totalTaxPayments += txn.amount\n    if (txn.type === 'credit') totalIncome += txn.amount\n\n    // Category breakdown\n    const cat = e.fortunaCategory || 'uncategorized'\n    if (!categoryBreakdown[cat]) categoryBreakdown[cat] = { count: 0, total: 0, deductible: e.isDeductible }\n    categoryBreakdown[cat].count++\n    categoryBreakdown[cat].total += txn.amount\n\n    // Confidence\n    if (e.confidence >= 0.8) highConf++\n    else if (e.confidence >= 0.6) medConf++\n    else lowConf++\n\n    return { ...txn, enrichment: e }\n  })\n\n  return {\n    enriched,\n    stats: {\n      totalDeductible: Math.round(totalDeductible * 100) / 100,\n      totalNonDeductible: Math.round(totalNonDeductible * 100) / 100,\n      totalTaxPayments: Math.round(totalTaxPayments * 100) / 100,\n      totalIncome: Math.round(totalIncome * 100) / 100,\n      categoryBreakdown,\n      confidence: { high: highConf, medium: medConf, low: lowConf },\n    },\n  }\n}\n\n// ─── Custom Rule Management ───────────────────────────────────────────────\n\n/**\n * Users can add custom enrichment rules that take priority over defaults.\n * Stored in FortunaState and loaded at enrichment time.\n */\nexport interface CustomEnrichmentRule {\n  id: string\n  matchType: 'merchant_contains' | 'merchant_regex' | 'category_equals' | 'mcc_equals'\n  matchValue: string\n  fortunaCategory: string\n  isDeductible: boolean\n  deductionPct: number\n  scheduleRef?: string\n  is1099Reportable: boolean\n  priority: number\n  createdAt: string\n}\n\nlet customRules: CustomEnrichmentRule[] = []\n\nexport function setCustomRules(rules: CustomEnrichmentRule[]) {\n  customRules = rules.sort((a, b) => b.priority - a.priority)\n}\n\nexport function getCustomRules(): CustomEnrichmentRule[] {\n  return [...customRules]\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\fintech-manager.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'FinTechTransaction' is defined but never used.","line":19,"column":55,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":73,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"FinTechTransaction"},"fix":{"range":[692,712],"text":""},"desc":"Remove unused variable \"FinTechTransaction\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'EnrichedTransaction' is defined but never used.","line":24,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":24,"endColumn":47,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"EnrichedTransaction"},"fix":{"range":[942,968],"text":""},"desc":"Remove unused variable \"EnrichedTransaction\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":36,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1475,1478],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1475,1478],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"prefer-const","severity":2,"message":"'txnResult' is never reassigned. Use 'const' instead.","line":236,"column":11,"nodeType":"Identifier","messageId":"useConst","endLine":236,"endColumn":43,"fix":{"range":[8035,8146],"text":"const txnResult: TransactionSyncResult = { added: [], modified: [], removed: [], hasMore: false, nextCursor: '' }"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":271,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":271,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9549,9552],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9549,9552],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":280,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":280,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9864,9867],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9864,9867],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'enriched' is assigned a value but never used.","line":290,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":290,"endColumn":21},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":423,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":423,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14512,14515],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14512,14515],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":424,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":424,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14585,14588],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14585,14588],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":9,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — FinTech Connection Manager\n *\n * Orchestrates the full lifecycle of financial data connections:\n *\n *   1. CONNECT: Create link → user authenticates → exchange token → store\n *   2. SYNC:    Initial pull → enrich → bridge to FortunaState → merge\n *   3. REFRESH: Incremental sync via cursor → merge delta\n *   4. HEALTH:  Monitor status, handle re-auth, track errors\n *   5. WEBHOOK: Process provider notifications → trigger sync\n *\n * Supports multiple simultaneous connections across providers.\n * All connection state persisted in FortunaState.fintechConnections.\n *\n * @module fintech-manager\n */\n\nimport type {\n  FinTechProvider, FinTechConnection, FinTechAccount, FinTechTransaction,\n  FinTechCapability, WebhookEvent,\n} from './fintech-models'\nimport type { FinTechAdapter, TransactionSyncResult, ProviderConfig } from './fintech-adapters'\nimport { createAdapter } from './fintech-adapters'\nimport { enrichBatch, type EnrichedTransaction } from './fintech-enrichment'\nimport { runFullBridge, type BridgeResult } from './fintech-bridge'\nimport type { FortunaState } from './storage'\n\n// ─── Connection Store ─────────────────────────────────────────────────────\n\nexport interface ConnectionRecord {\n  connection: FinTechConnection\n  accessToken: string           // Encrypted — never exposed to UI\n  syncCursor?: string           // For incremental transaction sync\n  lastSyncResult?: SyncResult\n  accounts: FinTechAccount[]\n  enrichmentRules?: any[]       // Custom per-connection rules\n}\n\nexport interface SyncResult {\n  timestamp: string\n  transactionsAdded: number\n  transactionsModified: number\n  transactionsRemoved: number\n  bridgeResult?: BridgeResult\n  errors: string[]\n  durationMs: number\n}\n\nexport interface ConnectionManagerState {\n  connections: ConnectionRecord[]\n  providerConfigs: Partial<Record<FinTechProvider, ProviderConfig>>\n  globalSyncEnabled: boolean\n  lastGlobalSync?: string\n  syncIntervalMinutes: number\n}\n\n// ─── Default State ────────────────────────────────────────────────────────\n\nexport const DEFAULT_MANAGER_STATE: ConnectionManagerState = {\n  connections: [],\n  providerConfigs: {},\n  globalSyncEnabled: true,\n  syncIntervalMinutes: 60,\n}\n\n// ─── Connection Manager ───────────────────────────────────────────────────\n\nexport class FinTechConnectionManager {\n  private state: ConnectionManagerState\n  private adapters: Map<string, FinTechAdapter> = new Map()\n  private syncTimers: Map<string, NodeJS.Timeout> = new Map()\n  private onStateChange?: (state: ConnectionManagerState) => void\n  private onFortunaUpdate?: (patch: Partial<FortunaState>) => void\n\n  constructor(\n    initialState?: Partial<ConnectionManagerState>,\n    callbacks?: {\n      onStateChange?: (state: ConnectionManagerState) => void\n      onFortunaUpdate?: (patch: Partial<FortunaState>) => void\n    },\n  ) {\n    this.state = { ...DEFAULT_MANAGER_STATE, ...initialState }\n    this.onStateChange = callbacks?.onStateChange\n    this.onFortunaUpdate = callbacks?.onFortunaUpdate\n\n    // Initialize adapters for configured providers\n    for (const [provider, config] of Object.entries(this.state.providerConfigs)) {\n      if (config) {\n        try {\n          this.adapters.set(provider, createAdapter(config))\n        } catch { /* skip unconfigured */ }\n      }\n    }\n  }\n\n  // ── Provider Configuration ────────────────────────────────────────────\n\n  configureProvider(config: ProviderConfig): void {\n    this.state.providerConfigs[config.provider] = config\n    this.adapters.set(config.provider, createAdapter(config))\n    this.emitStateChange()\n  }\n\n  getConfiguredProviders(): FinTechProvider[] {\n    return Object.keys(this.state.providerConfigs) as FinTechProvider[]\n  }\n\n  private getAdapter(provider: FinTechProvider): FinTechAdapter {\n    const adapter = this.adapters.get(provider)\n    if (!adapter) throw new Error(`Provider ${provider} not configured. Call configureProvider() first.`)\n    return adapter\n  }\n\n  // ── Connection Lifecycle ──────────────────────────────────────────────\n\n  /**\n   * Step 1: Create a link token for the frontend SDK (e.g., Plaid Link).\n   */\n  async createLink(\n    provider: FinTechProvider,\n    userId: string,\n    products: FinTechCapability[] = ['accounts', 'transactions'],\n  ): Promise<{ linkToken: string; expiration: string } | { error: string }> {\n    try {\n      const adapter = this.getAdapter(provider)\n      const result = await adapter.createLinkToken(userId, products)\n      if (!result.success) return { error: result.error?.message || 'Failed to create link' }\n      return result.data!\n    } catch (err) {\n      return { error: (err as Error).message }\n    }\n  }\n\n  /**\n   * Step 2: Exchange the public token from frontend SDK for an access token.\n   * Creates the connection record and triggers initial sync.\n   */\n  async completeLink(\n    provider: FinTechProvider,\n    publicToken: string,\n    institutionName: string,\n    institutionId: string = '',\n  ): Promise<{ connectionId: string } | { error: string }> {\n    try {\n      const adapter = this.getAdapter(provider)\n      const result = await adapter.exchangePublicToken(publicToken)\n      if (!result.success) return { error: result.error?.message || 'Token exchange failed' }\n\n      const { connectionId, accessToken } = result.data!\n\n      // Create connection record\n      const connection: FinTechConnection = {\n        id: connectionId,\n        provider,\n        institutionId,\n        institutionName,\n        status: 'active',\n        accountIds: [],\n        capabilities: ['accounts', 'transactions'],\n        createdAt: new Date().toISOString(),\n        updatedAt: new Date().toISOString(),\n      }\n\n      const record: ConnectionRecord = {\n        connection,\n        accessToken,\n        accounts: [],\n      }\n\n      this.state.connections.push(record)\n      this.emitStateChange()\n\n      // Trigger initial sync (non-blocking)\n      this.syncConnection(connectionId).catch(err => {\n        console.error(`Initial sync failed for ${connectionId}:`, err)\n      })\n\n      return { connectionId }\n    } catch (err) {\n      return { error: (err as Error).message }\n    }\n  }\n\n  /**\n   * Remove a connection and clean up.\n   */\n  async removeConnection(connectionId: string): Promise<void> {\n    const idx = this.state.connections.findIndex(c => c.connection.id === connectionId)\n    if (idx === -1) return\n\n    const record = this.state.connections[idx]\n    try {\n      const adapter = this.getAdapter(record.connection.provider)\n      await adapter.removeConnection(record.accessToken)\n    } catch { /* best-effort cleanup */ }\n\n    // Cancel any sync timer\n    const timer = this.syncTimers.get(connectionId)\n    if (timer) {\n      clearTimeout(timer)\n      this.syncTimers.delete(connectionId)\n    }\n\n    this.state.connections.splice(idx, 1)\n    this.emitStateChange()\n  }\n\n  // ── Sync Operations ───────────────────────────────────────────────────\n\n  /**\n   * Sync a single connection: pull accounts, transactions, enrich, bridge.\n   */\n  async syncConnection(connectionId: string): Promise<SyncResult> {\n    const start = Date.now()\n    const record = this.findConnection(connectionId)\n    if (!record) return { timestamp: new Date().toISOString(), transactionsAdded: 0, transactionsModified: 0, transactionsRemoved: 0, errors: ['Connection not found'], durationMs: 0 }\n\n    const errors: string[] = []\n    const adapter = this.getAdapter(record.connection.provider)\n\n    // Update status\n    record.connection.status = 'active'\n    record.connection.lastAttemptedSync = new Date().toISOString()\n\n    try {\n      // 1. Pull accounts\n      const accountsResult = await adapter.getAccounts(record.accessToken)\n      if (accountsResult.success && accountsResult.data) {\n        record.accounts = accountsResult.data\n        record.connection.accountIds = accountsResult.data.map(a => a.id)\n      } else if (accountsResult.error) {\n        errors.push(`Accounts: ${accountsResult.error.message}`)\n      }\n\n      // 2. Sync transactions (incremental if cursor exists)\n      let txnResult: TransactionSyncResult = { added: [], modified: [], removed: [], hasMore: false, nextCursor: '' }\n\n      if (adapter.syncTransactions) {\n        // Use cursor-based sync for incremental updates\n        let hasMore = true\n        let cursor = record.syncCursor\n\n        while (hasMore) {\n          const syncResp = await adapter.syncTransactions(record.accessToken, cursor)\n          if (syncResp.success && syncResp.data) {\n            txnResult.added.push(...syncResp.data.added)\n            txnResult.modified.push(...syncResp.data.modified)\n            txnResult.removed.push(...syncResp.data.removed)\n            hasMore = syncResp.data.hasMore\n            cursor = syncResp.data.nextCursor\n          } else {\n            errors.push(`Transactions sync: ${syncResp.error?.message || 'Unknown error'}`)\n            hasMore = false\n          }\n        }\n\n        record.syncCursor = cursor\n      } else {\n        // Fall back to date-range fetch (last 90 days)\n        const endDate = new Date().toISOString().split('T')[0]\n        const startDate = new Date(Date.now() - 90 * 86400_000).toISOString().split('T')[0]\n        const txnResp = await adapter.getTransactions(record.accessToken, { startDate, endDate, count: 500 })\n        if (txnResp.success && txnResp.data) {\n          txnResult.added = txnResp.data\n        } else if (txnResp.error) {\n          errors.push(`Transactions: ${txnResp.error.message}`)\n        }\n      }\n\n      // 3. Pull investments if supported\n      let investments: any = undefined\n      if (adapter.getInvestmentHoldings) {\n        const invResult = await adapter.getInvestmentHoldings(record.accessToken)\n        if (invResult.success && invResult.data) {\n          investments = invResult.data\n        }\n      }\n\n      // 4. Pull liabilities if supported\n      let liabilities: any = undefined\n      if (adapter.getLiabilities) {\n        const liabResult = await adapter.getLiabilities(record.accessToken)\n        if (liabResult.success && liabResult.data) {\n          liabilities = liabResult.data\n        }\n      }\n\n      // 5. Enrich transactions\n      const allTxns = [...txnResult.added, ...txnResult.modified]\n      const enriched = allTxns.length > 0 ? enrichBatch(allTxns) : { enrichedTransactions: [], stats: null }\n\n      // 6. Bridge to FortunaState\n      const bridgeResult = runFullBridge({\n        accounts: record.accounts,\n        transactions: allTxns,\n        investments: investments ? {\n          holdings: investments.holdings,\n          securities: investments.securities,\n        } : undefined,\n        liabilities,\n      })\n\n      // 7. Emit FortunaState update\n      if (this.onFortunaUpdate && bridgeResult.patch) {\n        this.onFortunaUpdate(bridgeResult.patch)\n      }\n\n      record.connection.lastSuccessfulSync = new Date().toISOString()\n      record.connection.status = 'active'\n\n      const syncResult: SyncResult = {\n        timestamp: new Date().toISOString(),\n        transactionsAdded: txnResult.added.length,\n        transactionsModified: txnResult.modified.length,\n        transactionsRemoved: txnResult.removed.length,\n        bridgeResult,\n        errors,\n        durationMs: Date.now() - start,\n      }\n\n      record.lastSyncResult = syncResult\n      this.emitStateChange()\n      return syncResult\n\n    } catch (err) {\n      record.connection.status = 'error'\n      record.connection.errorCode = (err as Error).message\n      this.emitStateChange()\n\n      return {\n        timestamp: new Date().toISOString(),\n        transactionsAdded: 0,\n        transactionsModified: 0,\n        transactionsRemoved: 0,\n        errors: [(err as Error).message],\n        durationMs: Date.now() - start,\n      }\n    }\n  }\n\n  /**\n   * Sync all active connections.\n   */\n  async syncAll(): Promise<Map<string, SyncResult>> {\n    const results = new Map<string, SyncResult>()\n    const active = this.state.connections.filter(c => c.connection.status === 'active')\n\n    // Sync in parallel with concurrency limit of 3\n    const chunks: ConnectionRecord[][] = []\n    for (let i = 0; i < active.length; i += 3) {\n      chunks.push(active.slice(i, i + 3))\n    }\n\n    for (const chunk of chunks) {\n      const chunkResults = await Promise.allSettled(\n        chunk.map(c => this.syncConnection(c.connection.id)),\n      )\n      chunk.forEach((c, i) => {\n        const result = chunkResults[i]\n        results.set(c.connection.id, result.status === 'fulfilled' ? result.value : {\n          timestamp: new Date().toISOString(),\n          transactionsAdded: 0, transactionsModified: 0, transactionsRemoved: 0,\n          errors: [(result as PromiseRejectedResult).reason?.message || 'Sync failed'],\n          durationMs: 0,\n        })\n      })\n    }\n\n    this.state.lastGlobalSync = new Date().toISOString()\n    this.emitStateChange()\n    return results\n  }\n\n  /**\n   * Start automatic sync interval.\n   */\n  startAutoSync(intervalMinutes?: number): void {\n    const interval = (intervalMinutes || this.state.syncIntervalMinutes) * 60_000\n    this.state.globalSyncEnabled = true\n    this.state.syncIntervalMinutes = intervalMinutes || this.state.syncIntervalMinutes\n\n    // Clear any existing timer\n    const existing = this.syncTimers.get('global')\n    if (existing) clearInterval(existing)\n\n    const timer = setInterval(() => {\n      this.syncAll().catch(console.error)\n    }, interval)\n\n    this.syncTimers.set('global', timer as unknown as NodeJS.Timeout)\n    this.emitStateChange()\n  }\n\n  stopAutoSync(): void {\n    this.state.globalSyncEnabled = false\n    const timer = this.syncTimers.get('global')\n    if (timer) {\n      clearInterval(timer)\n      this.syncTimers.delete('global')\n    }\n    this.emitStateChange()\n  }\n\n  // ── Webhook Processing ────────────────────────────────────────────────\n\n  /**\n   * Process an inbound webhook event from a provider.\n   * Returns the action taken.\n   */\n  async processWebhook(event: WebhookEvent): Promise<{ action: string }> {\n    const record = this.state.connections.find(c => c.connection.id === event.connectionId)\n    if (!record) return { action: 'ignored_unknown_connection' }\n\n    switch (event.type) {\n      case 'transactions.sync':\n      case 'transactions.initial_update':\n      case 'transactions.historical_update':\n        await this.syncConnection(record.connection.id)\n        return { action: 'synced_transactions' }\n\n      case 'connection.error':\n        record.connection.status = 'error'\n        record.connection.errorCode = (event.data as any)?.error_code\n        record.connection.statusDetail = (event.data as any)?.error_message\n        this.emitStateChange()\n        return { action: 'marked_error' }\n\n      case 'connection.updated':\n        record.connection.status = 'active'\n        record.connection.updatedAt = new Date().toISOString()\n        this.emitStateChange()\n        return { action: 'updated_connection' }\n\n      case 'connection.removed':\n        await this.removeConnection(record.connection.id)\n        return { action: 'removed_connection' }\n\n      case 'investments.update':\n        await this.syncConnection(record.connection.id)\n        return { action: 'synced_investments' }\n\n      case 'income.verification_complete':\n        return { action: 'income_verified' }\n\n      default:\n        return { action: `unhandled_${event.type}` }\n    }\n  }\n\n  // ── Connection Health ─────────────────────────────────────────────────\n\n  /**\n   * Get health summary for all connections.\n   */\n  getHealthSummary(): {\n    total: number\n    active: number\n    degraded: number\n    error: number\n    pendingReauth: number\n    needsAttention: ConnectionRecord[]\n  } {\n    const conns = this.state.connections\n    const needsAttention = conns.filter(c =>\n      c.connection.status === 'error' ||\n      c.connection.status === 'pending_reauth' ||\n      c.connection.status === 'degraded',\n    )\n\n    return {\n      total: conns.length,\n      active: conns.filter(c => c.connection.status === 'active').length,\n      degraded: conns.filter(c => c.connection.status === 'degraded').length,\n      error: conns.filter(c => c.connection.status === 'error').length,\n      pendingReauth: conns.filter(c => c.connection.status === 'pending_reauth').length,\n      needsAttention,\n    }\n  }\n\n  /**\n   * Check if a connection needs re-authentication.\n   */\n  async checkConnectionHealth(connectionId: string): Promise<'healthy' | 'needs_reauth' | 'error'> {\n    const record = this.findConnection(connectionId)\n    if (!record) return 'error'\n\n    try {\n      const adapter = this.getAdapter(record.connection.provider)\n      const status = await adapter.getConnectionStatus(record.accessToken)\n      if (!status.success) return 'error'\n      if (status.data?.status === 'pending_reauth') return 'needs_reauth'\n      return 'healthy'\n    } catch {\n      return 'error'\n    }\n  }\n\n  // ── Getters ───────────────────────────────────────────────────────────\n\n  getConnections(): ConnectionRecord[] {\n    return this.state.connections\n  }\n\n  getConnection(connectionId: string): ConnectionRecord | undefined {\n    return this.findConnection(connectionId)\n  }\n\n  getAccounts(): FinTechAccount[] {\n    return this.state.connections.flatMap(c => c.accounts)\n  }\n\n  getAccountsByType(type: string): FinTechAccount[] {\n    return this.getAccounts().filter(a => a.type === type)\n  }\n\n  getState(): ConnectionManagerState {\n    return { ...this.state }\n  }\n\n  // ── Aggregate Stats ───────────────────────────────────────────────────\n\n  getAggregateStats(): {\n    totalAccounts: number\n    totalBalance: number\n    totalDebt: number\n    netWorth: number\n    byType: Record<string, { count: number; balance: number }>\n    lastSync: string | undefined\n  } {\n    const accounts = this.getAccounts()\n    const byType: Record<string, { count: number; balance: number }> = {}\n    let totalBalance = 0\n    let totalDebt = 0\n\n    for (const acct of accounts) {\n      const type = acct.type\n      if (!byType[type]) byType[type] = { count: 0, balance: 0 }\n      byType[type].count++\n      const bal = acct.balances.current || 0\n      byType[type].balance += bal\n\n      if (type === 'loan' || type === 'credit') {\n        totalDebt += Math.abs(bal)\n      } else {\n        totalBalance += bal\n      }\n    }\n\n    return {\n      totalAccounts: accounts.length,\n      totalBalance: Math.round(totalBalance * 100) / 100,\n      totalDebt: Math.round(totalDebt * 100) / 100,\n      netWorth: Math.round((totalBalance - totalDebt) * 100) / 100,\n      byType,\n      lastSync: this.state.lastGlobalSync,\n    }\n  }\n\n  // ── Internals ─────────────────────────────────────────────────────────\n\n  private findConnection(id: string): ConnectionRecord | undefined {\n    return this.state.connections.find(c => c.connection.id === id)\n  }\n\n  private emitStateChange(): void {\n    this.onStateChange?.(this.state)\n  }\n\n  /**\n   * Clean up all timers and resources.\n   */\n  destroy(): void {\n    for (const timer of this.syncTimers.values()) {\n      clearInterval(timer)\n    }\n    this.syncTimers.clear()\n  }\n}\n\n// ─── Supported Institutions (Static List) ─────────────────────────────────\n\nexport interface InstitutionInfo {\n  id: string\n  name: string\n  logo?: string\n  primaryColor?: string\n  url?: string\n  providers: FinTechProvider[]\n  popular: boolean\n}\n\nexport const POPULAR_INSTITUTIONS: InstitutionInfo[] = [\n  { id: 'ins_1', name: 'Chase', primaryColor: '#117ACA', url: 'https://chase.com', providers: ['plaid', 'mx', 'yodlee'], popular: true },\n  { id: 'ins_2', name: 'Bank of America', primaryColor: '#012169', url: 'https://bankofamerica.com', providers: ['plaid', 'mx', 'yodlee'], popular: true },\n  { id: 'ins_3', name: 'Wells Fargo', primaryColor: '#D71E28', url: 'https://wellsfargo.com', providers: ['plaid', 'mx', 'yodlee'], popular: true },\n  { id: 'ins_4', name: 'Citi', primaryColor: '#003B70', url: 'https://citi.com', providers: ['plaid', 'mx', 'yodlee'], popular: true },\n  { id: 'ins_5', name: 'Capital One', primaryColor: '#004879', url: 'https://capitalone.com', providers: ['plaid', 'mx', 'yodlee'], popular: true },\n  { id: 'ins_6', name: 'US Bank', primaryColor: '#D32F2F', url: 'https://usbank.com', providers: ['plaid', 'mx'], popular: true },\n  { id: 'ins_7', name: 'PNC', primaryColor: '#F58025', url: 'https://pnc.com', providers: ['plaid', 'mx'], popular: true },\n  { id: 'ins_8', name: 'TD Bank', primaryColor: '#34A853', url: 'https://td.com', providers: ['plaid', 'mx'], popular: true },\n  { id: 'ins_9', name: 'Schwab', primaryColor: '#00A0DF', url: 'https://schwab.com', providers: ['plaid', 'mx'], popular: true },\n  { id: 'ins_10', name: 'Fidelity', primaryColor: '#4E8542', url: 'https://fidelity.com', providers: ['plaid', 'mx'], popular: true },\n  { id: 'ins_11', name: 'Vanguard', primaryColor: '#C41E25', url: 'https://vanguard.com', providers: ['plaid', 'mx'], popular: true },\n  { id: 'ins_12', name: 'American Express', primaryColor: '#006FCF', url: 'https://americanexpress.com', providers: ['plaid', 'mx'], popular: true },\n  { id: 'ins_13', name: 'USAA', primaryColor: '#00529B', url: 'https://usaa.com', providers: ['plaid', 'mx'], popular: true },\n  { id: 'ins_14', name: 'Navy Federal', primaryColor: '#003366', url: 'https://navyfederal.org', providers: ['plaid', 'mx'], popular: true },\n  { id: 'ins_15', name: 'Discover', primaryColor: '#FF6600', url: 'https://discover.com', providers: ['plaid', 'mx'], popular: true },\n  { id: 'ins_16', name: 'Ally Bank', primaryColor: '#4E2A84', url: 'https://ally.com', providers: ['plaid', 'mx'], popular: true },\n  { id: 'ins_17', name: 'Marcus by Goldman Sachs', primaryColor: '#000000', url: 'https://marcus.com', providers: ['plaid'], popular: false },\n  { id: 'ins_18', name: 'SoFi', primaryColor: '#00B4D8', url: 'https://sofi.com', providers: ['plaid'], popular: false },\n  { id: 'ins_19', name: 'Robinhood', primaryColor: '#00C805', url: 'https://robinhood.com', providers: ['plaid'], popular: false },\n  { id: 'ins_20', name: 'Coinbase', primaryColor: '#0052FF', url: 'https://coinbase.com', providers: ['plaid'], popular: false },\n]\n\n/**\n * Search institutions by name.\n */\nexport function searchInstitutions(query: string, limit: number = 10): InstitutionInfo[] {\n  if (!query.trim()) return POPULAR_INSTITUTIONS.filter(i => i.popular).slice(0, limit)\n  const q = query.toLowerCase()\n  return POPULAR_INSTITUTIONS\n    .filter(i => i.name.toLowerCase().includes(q))\n    .slice(0, limit)\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\fintech-models.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\goal-planner.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'generateCashFlow' is defined but never used.","line":9,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":26,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"generateCashFlow"},"fix":{"range":[319,336],"text":""},"desc":"Remove unused variable \"generateCashFlow\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'CashFlowConfig' is defined but never used.","line":9,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":47,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"CashFlowConfig"},"fix":{"range":[310,378],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine - Goal-Based Reverse Planner\n * Works backward from financial targets to calculate required income,\n * savings rates, and optimal structure to hit goals.\n */\n\nimport type { FortunaState, FinancialGoal as StorageGoal } from './storage'\nimport { generateTaxReport } from './tax-calculator'\nimport { generateCashFlow, type CashFlowConfig } from './cash-flow'\n\nexport type GoalType = 'after_tax_income' | 'savings_target' | 'retirement_balance' | 'tax_bill_limit' | 'monthly_net'\n\nexport interface FinancialGoal {\n  id: string\n  type: GoalType\n  name: string\n  targetAmount: number\n  deadline?: string // ISO date\n  deadlineMonths?: number\n  priority: 'critical' | 'high' | 'medium'\n}\n\nexport interface GoalPlan {\n  goal: FinancialGoal\n  feasible: boolean\n  \n  // Required metrics\n  requiredGrossIncome: number\n  currentGrossIncome: number\n  incomeGap: number\n  \n  // Tax-optimized path\n  requiredMonthlyGross: number\n  requiredMonthlySavings: number\n  effectiveTaxRate: number\n  \n  // Structure recommendations\n  optimalEntityType: string\n  estimatedTaxSavings: number\n  \n  // Timeline\n  monthsToGoal: number\n  progressPercent: number\n  onTrack: boolean\n  \n  // Monthly breakdown\n  monthlyPlan: MonthlyMilestone[]\n  \n  // Sensitivity\n  ifYouEarnMore: { extraMonthly: number; monthsSaved: number }[]\n}\n\nexport interface MonthlyMilestone {\n  month: number\n  label: string\n  cumulativeSaved: number\n  targetAtMonth: number\n  surplus: number\n  onTrack: boolean\n}\n\nconst GOAL_LABELS: Record<GoalType, string> = {\n  after_tax_income: 'After-Tax Income Target',\n  savings_target: 'Savings Goal',\n  retirement_balance: 'Retirement Target',\n  tax_bill_limit: 'Tax Bill Ceiling',\n  monthly_net: 'Monthly Take-Home Target',\n}\n\nexport { GOAL_LABELS }\n\nexport function calculateGoalPlan(goal: FinancialGoal, state: FortunaState): GoalPlan {\n  const report = generateTaxReport(state)\n  const currentGross = report.grossIncome\n  const currentAfterTax = report.afterTaxIncome\n  const currentEffRate = report.effectiveRate\n  const monthsToDeadline = goal.deadlineMonths || 12\n\n  let requiredGross = 0\n  let incomeGap = 0\n  let feasible = true\n  let progressPercent = 0\n  let requiredMonthlySavings = 0\n\n  switch (goal.type) {\n    case 'after_tax_income': {\n      // Need gross income that yields target after-tax\n      // Iterative solve: gross * (1 - effectiveRate) ≈ target\n      const estRate = currentEffRate > 0 ? currentEffRate : 0.25\n      requiredGross = Math.round(goal.targetAmount / (1 - estRate))\n      // Refine with bracket awareness\n      for (let i = 0; i < 5; i++) {\n        const estTax = requiredGross * estRate\n        const afterTax = requiredGross - estTax\n        const error = goal.targetAmount - afterTax\n        requiredGross += Math.round(error / (1 - estRate))\n      }\n      incomeGap = Math.max(0, requiredGross - currentGross)\n      progressPercent = Math.min(100, (currentAfterTax / goal.targetAmount) * 100)\n      break\n    }\n\n    case 'savings_target': {\n      // How much monthly savings needed to hit target by deadline\n      const currentMonthlySurplus = (currentAfterTax / 12) - (state.expenses.reduce((s, e) => s + e.annualAmount, 0) / 12)\n      requiredMonthlySavings = Math.round(goal.targetAmount / monthsToDeadline)\n      const currentMonthlyCapacity = Math.max(0, currentMonthlySurplus)\n      requiredGross = currentMonthlySavings > currentMonthlyCapacity\n        ? currentGross + Math.round((requiredMonthlySavings - currentMonthlyCapacity) * 12 / (1 - currentEffRate))\n        : currentGross\n      incomeGap = Math.max(0, requiredGross - currentGross)\n      progressPercent = currentMonthlyCapacity > 0 ? Math.min(100, (currentMonthlyCapacity / requiredMonthlySavings) * 100) : 0\n      break\n    }\n\n    case 'retirement_balance': {\n      // Annual contribution needed to reach target (simplified without investment returns)\n      const currentRetirement = state.deductions.filter(d => d.category === 'retirement').reduce((s, d) => s + d.amount, 0)\n      const w2Retirement = state.incomeStreams.filter(s => s.type === 'w2' && s.isActive).reduce((s, i) => s + (i.w2?.pretax401k || 0) + (i.w2?.employerMatch401k || 0), 0)\n      const totalRetirement = currentRetirement + w2Retirement\n      const yearsToGoal = Math.max(1, monthsToDeadline / 12)\n      const assumedReturn = 0.07 // 7% annual return\n      // Future value of annuity: FV = PMT × ((1+r)^n - 1) / r\n      // Solve for PMT: PMT = FV × r / ((1+r)^n - 1)\n      const fvFactor = (Math.pow(1 + assumedReturn, yearsToGoal) - 1) / assumedReturn\n      const requiredAnnualContribution = Math.round(goal.targetAmount / fvFactor)\n      const contributionGap = Math.max(0, requiredAnnualContribution - totalRetirement)\n      requiredGross = currentGross + Math.round(contributionGap / (1 - currentEffRate))\n      incomeGap = Math.max(0, requiredGross - currentGross)\n      requiredMonthlySavings = Math.round(requiredAnnualContribution / 12)\n      progressPercent = Math.min(100, (totalRetirement / requiredAnnualContribution) * 100)\n      break\n    }\n\n    case 'tax_bill_limit': {\n      // Maximum gross income to keep taxes under target\n      // Binary search for the right income level\n      let lo = 0, hi = currentGross * 3\n      for (let i = 0; i < 20; i++) {\n        const mid = Math.round((lo + hi) / 2)\n        const estTax = mid * currentEffRate\n        if (estTax < goal.targetAmount) lo = mid\n        else hi = mid\n      }\n      requiredGross = lo\n      incomeGap = currentGross > requiredGross ? -(currentGross - requiredGross) : 0\n      progressPercent = report.totalTax <= goal.targetAmount ? 100 : Math.round((goal.targetAmount / report.totalTax) * 100)\n      feasible = report.totalTax <= goal.targetAmount || incomeGap <= 0\n      break\n    }\n\n    case 'monthly_net': {\n      // Annual after-tax income needed = monthly target × 12\n      const annualTarget = goal.targetAmount * 12\n      const estRate = currentEffRate > 0 ? currentEffRate : 0.25\n      requiredGross = Math.round(annualTarget / (1 - estRate))\n      incomeGap = Math.max(0, requiredGross - currentGross)\n      progressPercent = Math.min(100, ((currentAfterTax / 12) / goal.targetAmount) * 100)\n      break\n    }\n  }\n\n  const onTrack = progressPercent >= 80\n\n  // Monthly milestone projection\n  const monthlyPlan: MonthlyMilestone[] = []\n  const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']\n  const now = new Date()\n  \n  if (goal.type === 'savings_target' || goal.type === 'retirement_balance') {\n    const monthlySavings = requiredMonthlySavings > 0 ? requiredMonthlySavings : Math.round(goal.targetAmount / monthsToDeadline)\n    for (let i = 1; i <= Math.min(monthsToDeadline, 24); i++) {\n      const monthIdx = (now.getMonth() + i) % 12\n      const year = now.getFullYear() + Math.floor((now.getMonth() + i) / 12)\n      const targetAtMonth = Math.round((goal.targetAmount / monthsToDeadline) * i)\n      const cumulativeSaved = monthlySavings * i\n      monthlyPlan.push({\n        month: i,\n        label: `${monthNames[monthIdx]} '${String(year).slice(2)}`,\n        cumulativeSaved,\n        targetAtMonth,\n        surplus: cumulativeSaved - targetAtMonth,\n        onTrack: cumulativeSaved >= targetAtMonth * 0.9,\n      })\n    }\n  }\n\n  // Entity optimization estimate\n  const hasSE = state.incomeStreams.some(s => ['business', 'freelance'].includes(s.type) && s.isActive)\n  const hasScorp = state.entities.some(e => (e.type === 'llc_scorp' || e.type === 'scorp') && e.isActive)\n  let optimalEntity = 'Current structure'\n  let estTaxSavings = 0\n  if (hasSE && !hasScorp && report.selfEmploymentTax > 3000) {\n    optimalEntity = 'S-Corp election'\n    estTaxSavings = report.sCorpSavings || Math.round(report.selfEmploymentTax * 0.3)\n  }\n\n  // Sensitivity: what if you earn X more per month\n  const sensitivities = [500, 1000, 2000, 5000].map(extra => {\n    if (goal.type === 'savings_target' && requiredMonthlySavings > 0) {\n      const adjustedMonths = Math.max(1, Math.ceil(goal.targetAmount / (requiredMonthlySavings + extra * (1 - currentEffRate))))\n      return { extraMonthly: extra, monthsSaved: Math.max(0, monthsToDeadline - adjustedMonths) }\n    }\n    return { extraMonthly: extra, monthsSaved: 0 }\n  })\n\n  return {\n    goal,\n    feasible,\n    requiredGrossIncome: requiredGross,\n    currentGrossIncome: currentGross,\n    incomeGap,\n    requiredMonthlyGross: Math.round(requiredGross / 12),\n    requiredMonthlySavings,\n    effectiveTaxRate: currentEffRate,\n    optimalEntityType: optimalEntity,\n    estimatedTaxSavings: estTaxSavings,\n    monthsToGoal: monthsToDeadline,\n    progressPercent: Math.round(progressPercent),\n    onTrack,\n    monthlyPlan,\n    ifYouEarnMore: sensitivities,\n  }\n}\n\nexport function getPresetGoals(state: FortunaState): FinancialGoal[] {\n  const report = generateTaxReport(state)\n  const goals: FinancialGoal[] = []\n\n  // Preset: Double after-tax income\n  if (report.afterTaxIncome > 0) {\n    goals.push({\n      id: 'double-income', type: 'after_tax_income', name: 'Double After-Tax Income',\n      targetAmount: report.afterTaxIncome * 2, priority: 'high',\n    })\n  }\n\n  // Preset: $100k after-tax\n  goals.push({\n    id: '100k-target', type: 'after_tax_income', name: '$100k After-Tax Income',\n    targetAmount: 100000, priority: 'high',\n  })\n\n  // Preset: House down payment\n  goals.push({\n    id: 'house-down', type: 'savings_target', name: 'House Down Payment ($50k)',\n    targetAmount: 50000, deadlineMonths: 24, priority: 'high',\n  })\n\n  // Preset: Emergency fund\n  goals.push({\n    id: 'emergency', type: 'savings_target', name: '6-Month Emergency Fund',\n    targetAmount: Math.round((state.expenses.reduce((s, e) => s + e.annualAmount, 0) / 12 + 3000) * 6),\n    deadlineMonths: 12, priority: 'critical',\n  })\n\n  // Preset: Retirement\n  goals.push({\n    id: 'retirement-1m', type: 'retirement_balance', name: '$1M Retirement',\n    targetAmount: 1000000, deadlineMonths: 240, priority: 'medium',\n  })\n\n  // Preset: Keep taxes under current level\n  if (report.totalTax > 0) {\n    goals.push({\n      id: 'tax-ceiling', type: 'tax_bill_limit', name: 'Keep Taxes Under Current',\n      targetAmount: report.totalTax, priority: 'medium',\n    })\n  }\n\n  // Preset: $8k/month take-home\n  goals.push({\n    id: 'monthly-8k', type: 'monthly_net', name: '$8,000/Month Take-Home',\n    targetAmount: 8000, priority: 'high',\n  })\n\n  return goals\n}\n\n// ─── Phase F: Type Adapters ─────────────────────────────────────────────────\n\nconst GOAL_TYPE_MAP: Record<GoalType, StorageGoal['type']> = {\n  after_tax_income: 'income_growth',\n  savings_target: 'savings',\n  retirement_balance: 'retirement',\n  tax_bill_limit: 'tax_reduction',\n  monthly_net: 'income_growth',\n}\n\nconst STORAGE_TO_GOAL_TYPE: Record<string, GoalType> = {\n  savings: 'savings_target',\n  tax_reduction: 'tax_bill_limit',\n  retirement: 'retirement_balance',\n  debt_payoff: 'savings_target',\n  investment: 'savings_target',\n  income_growth: 'after_tax_income',\n  entity_setup: 'savings_target',\n  other: 'savings_target',\n}\n\n/** Convert planner FinancialGoal → storage FinancialGoal */\nexport function goalToStorage(goal: FinancialGoal, plan?: GoalPlan): StorageGoal {\n  return {\n    id: goal.id,\n    title: goal.name,\n    type: GOAL_TYPE_MAP[goal.type] || 'other',\n    targetAmount: goal.targetAmount,\n    currentAmount: plan?.monthlyTarget ? Math.round(plan.monthlyTarget * (plan.totalMonths - (plan.feasible ? 0 : plan.totalMonths))) : 0,\n    targetDate: goal.deadline,\n    priority: goal.priority === 'critical' ? 'high' : goal.priority,\n    status: 'active',\n    entityId: 'personal',\n    memberId: 'primary',\n    taxYear: new Date().getFullYear(),\n    tags: [],\n  }\n}\n\n/** Convert storage FinancialGoal → planner FinancialGoal */\nexport function storageToGoal(sg: StorageGoal): FinancialGoal {\n  return {\n    id: sg.id,\n    type: STORAGE_TO_GOAL_TYPE[sg.type] || 'investment',\n    name: sg.title,\n    targetAmount: sg.targetAmount || 0,\n    deadline: sg.targetDate,\n    priority: sg.priority === 'low' ? 'medium' : sg.priority as 'critical' | 'high' | 'medium',\n  }\n}\n\n/** Merge planner recommendations into existing StorageGoal[] */\nexport function mergePlannerGoals(existingGoals: StorageGoal[], plannerGoals: FinancialGoal[], plans: GoalPlan[]): StorageGoal[] {\n  const result = [...existingGoals]\n\n  for (const goal of plannerGoals) {\n    const existing = result.find(g => g.id === goal.id || g.type === GOAL_TYPE_MAP[goal.type])\n    const plan = plans.find(p => p.goal.id === goal.id)\n    if (existing) {\n      existing.targetAmount = goal.targetAmount\n      if (goal.deadline) existing.targetDate = goal.deadline\n    } else {\n      result.push(goalToStorage(goal, plan))\n    }\n  }\n\n  return result\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\hardening.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'afterEach' is defined but never used.","line":11,"column":44,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":53,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"afterEach"},"fix":{"range":[374,385],"text":""},"desc":"Remove unused variable \"afterEach\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ValidationResult' is defined but never used.","line":16,"column":43,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":59,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ValidationResult"},"fix":{"range":[583,606],"text":""},"desc":"Remove unused variable \"ValidationResult\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'validateEntity' is defined but never used.","line":141,"column":42,"nodeType":"Identifier","messageId":"unusedVar","endLine":141,"endColumn":56,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"validateEntity"},"fix":{"range":[5134,5150],"text":""},"desc":"Remove unused variable \"validateEntity\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'IIFParseResult' is defined but never used.","line":313,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":313,"endColumn":52,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"IIFParseResult"},"fix":{"range":[11667,11688],"text":""},"desc":"Remove unused variable \"IIFParseResult\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'OFXParseResult' is defined but never used.","line":314,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":314,"endColumn":49,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"OFXParseResult"},"fix":{"range":[11741,11762],"text":""},"desc":"Remove unused variable \"OFXParseResult\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AccountMapping' is defined but never used.","line":315,"column":43,"nodeType":"Identifier","messageId":"unusedVar","endLine":315,"endColumn":57,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AccountMapping"},"fix":{"range":[11823,11844],"text":""},"desc":"Remove unused variable \"AccountMapping\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":485,"column":81,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":485,"endColumn":84,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17649,17652],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17649,17652],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":491,"column":83,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":491,"endColumn":86,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17907,17910],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17907,17910],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":497,"column":87,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":497,"endColumn":90,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18160,18163],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18160,18163],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":502,"column":80,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":502,"endColumn":83,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18364,18367],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18364,18367],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":508,"column":88,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":508,"endColumn":91,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18638,18641],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18638,18641],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":514,"column":88,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":514,"endColumn":91,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18908,18911],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18908,18911],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":519,"column":94,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":519,"endColumn":97,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19113,19116],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19113,19116],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":525,"column":92,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":525,"endColumn":95,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19380,19383],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19380,19383],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":530,"column":81,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":530,"endColumn":84,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19594,19597],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19594,19597],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":540,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":540,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19987,19990],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19987,19990],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":16,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — Hardening Test Suite\n *\n * Covers:\n *   1. Data Safety: validation, repair, backup rotation, corruption recovery\n *   2. Input Validation: IRS limits, domain rules, field validators\n *   3. QuickBooks Parsers: IIF, OFX/QBO, COA mapping\n *   4. State Integrity: referential integrity, migration, defaults\n */\n\nimport { describe, it, expect, beforeEach, afterEach } from 'vitest'\nimport { createDefaultState, type FortunaState } from './storage'\n\n// ─── Data Safety Tests ────────────────────────────────────────────────────\n\nimport { validateState, repairState, type ValidationResult } from './data-safety'\n\ndescribe('data safety: state validation', () => {\n  let state: FortunaState\n\n  beforeEach(() => {\n    state = createDefaultState()\n  })\n\n  it('should validate a clean default state', () => {\n    const result = validateState(state)\n    expect(result.valid).toBe(true)\n    expect(result.errors).toHaveLength(0)\n  })\n\n  it('should reject null/undefined state', () => {\n    expect(validateState(null).valid).toBe(false)\n    expect(validateState(undefined).valid).toBe(false)\n    expect(validateState(42).valid).toBe(false)\n  })\n\n  it('should error on missing profile', () => {\n    const bad = { ...state, profile: undefined } as unknown\n    const result = validateState(bad)\n    expect(result.valid).toBe(false)\n    expect(result.errors.some(e => e.includes('profile'))).toBe(true)\n  })\n\n  it('should error on invalid filingStatus', () => {\n    const bad = { ...state, profile: { ...state.profile, filingStatus: 'invalid' } }\n    const result = validateState(bad)\n    expect(result.errors.some(e => e.includes('filingStatus'))).toBe(true)\n  })\n\n  it('should warn on missing arrays', () => {\n    const partial = { profile: state.profile } as unknown\n    const result = validateState(partial)\n    expect(result.warnings.some(w => w.includes('Missing array'))).toBe(true)\n  })\n\n  it('should warn on negative income', () => {\n    const bad = {\n      ...state,\n      incomeStreams: [{ id: '1', name: 'Test', type: 'w2', annualAmount: -50000, isActive: true }],\n    }\n    const result = validateState(bad)\n    expect(result.warnings.some(w => w.includes('negative'))).toBe(true)\n  })\n\n  it('should warn on extremely high income', () => {\n    const high = {\n      ...state,\n      incomeStreams: [{ id: '1', name: 'Test', type: 'w2', annualAmount: 200_000_000, isActive: true }],\n    }\n    const result = validateState(high)\n    expect(result.warnings.some(w => w.includes('unusually high'))).toBe(true)\n  })\n\n  it('should error on non-array incomeStreams', () => {\n    const bad = { ...state, incomeStreams: 'not an array' } as unknown\n    const result = validateState(bad)\n    expect(result.errors.some(e => e.includes('not an array'))).toBe(true)\n  })\n\n  it('should warn on orphaned entity references', () => {\n    const bad = {\n      ...state,\n      incomeStreams: [{ id: '1', name: 'Biz', type: 'business', annualAmount: 100000, isActive: true, entityId: 'ghost_entity' }],\n      entities: [],\n    }\n    const result = validateState(bad)\n    expect(result.warnings.some(w => w.includes('non-existent entity'))).toBe(true)\n  })\n\n  it('should detect missing entity type', () => {\n    const bad = {\n      ...state,\n      entities: [{ id: '1', name: 'LLC', state: 'IL', annualCost: 0, isActive: true }],\n    }\n    const result = validateState(bad)\n    expect(result.errors.some(e => e.includes('missing type'))).toBe(true)\n  })\n})\n\ndescribe('data safety: state repair', () => {\n  it('should create default state from null', () => {\n    const { state, repairs } = repairState(null)\n    expect(state.profile).toBeDefined()\n    expect(repairs.length).toBeGreaterThan(0)\n  })\n\n  it('should restore missing arrays', () => {\n    const partial = { profile: createDefaultState().profile }\n    const { state, repairs } = repairState(partial)\n    expect(Array.isArray(state.incomeStreams)).toBe(true)\n    expect(Array.isArray(state.expenses)).toBe(true)\n    expect(Array.isArray(state.entities)).toBe(true)\n    expect(repairs.some(r => r.includes('Initialized missing array'))).toBe(true)\n  })\n\n  it('should add missing IDs to array items', () => {\n    const noId = {\n      profile: createDefaultState().profile,\n      incomeStreams: [{ name: 'Job', type: 'w2', annualAmount: 50000, isActive: true }],\n      expenses: [], entities: [], deductions: [], depreciationAssets: [],\n      investmentPortfolio: [], retirementAccounts: [], goals: [], documents: [],\n      estimatedPayments: [], auditHistory: [],\n    }\n    const { state, repairs } = repairState(noId)\n    expect(state.incomeStreams[0].id).toBeTruthy()\n    expect(repairs.some(r => r.includes('Generated missing id'))).toBe(true)\n  })\n\n  it('repaired state should pass validation', () => {\n    const corrupt = { profile: null, incomeStreams: 'broken' }\n    const { state } = repairState(corrupt)\n    const v = validateState(state)\n    expect(v.valid).toBe(true)\n  })\n})\n\n// ─── Input Validation Tests ───────────────────────────────────────────────\n\nimport {\n  validateAmount, validatePercentage, validateTaxYear, validateDate,\n  validateIncomeStream, validateExpense, validateEntity,\n  validateRetirementAccount, validateDepreciationAsset,\n  validateFullState, isFieldValid, formatCurrencyInput,\n  IRS_LIMITS_2025,\n} from './input-validation'\n\ndescribe('input validation: field validators', () => {\n  it('validateAmount: rejects NaN', () => {\n    const r = validateAmount('abc', 'test')\n    expect(r.valid).toBe(false)\n    expect(r.issues[0].severity).toBe('error')\n  })\n\n  it('validateAmount: rejects negative when not allowed', () => {\n    const r = validateAmount(-100, 'test')\n    expect(r.issues.some(i => i.message.includes('negative'))).toBe(true)\n  })\n\n  it('validateAmount: allows negative when explicitly permitted', () => {\n    const r = validateAmount(-100, 'test', { allowNegative: true })\n    expect(r.valid).toBe(true)\n  })\n\n  it('validateAmount: warns on high values', () => {\n    const r = validateAmount(50_000_000, 'test')\n    expect(r.issues.some(i => i.severity === 'warning')).toBe(true)\n  })\n\n  it('validateAmount: strips currency formatting', () => {\n    const r = validateAmount('$1,234.56', 'test')\n    expect(r.valid).toBe(true)\n  })\n\n  it('validateAmount: rejects empty', () => {\n    expect(validateAmount('', 'test').valid).toBe(false)\n    expect(validateAmount(null, 'test').valid).toBe(false)\n    expect(validateAmount(undefined, 'test').valid).toBe(false)\n  })\n\n  it('validatePercentage: rejects out of range', () => {\n    expect(validatePercentage(-5, 'test').valid).toBe(false)\n    expect(validatePercentage(101, 'test').valid).toBe(false)\n    expect(validatePercentage(50, 'test').valid).toBe(true)\n  })\n\n  it('validateTaxYear: accepts current and recent years', () => {\n    expect(validateTaxYear(2025, 'test').valid).toBe(true)\n    expect(validateTaxYear(2024, 'test').valid).toBe(true)\n  })\n\n  it('validateTaxYear: warns on old/future years', () => {\n    const r = validateTaxYear(2010, 'test')\n    expect(r.issues.some(i => i.severity === 'warning')).toBe(true)\n  })\n\n  it('validateDate: rejects invalid dates', () => {\n    expect(validateDate('not-a-date', 'test').valid).toBe(false)\n    expect(validateDate('', 'test').valid).toBe(false)\n  })\n\n  it('validateDate: accepts ISO dates', () => {\n    expect(validateDate('2025-01-15', 'test').valid).toBe(true)\n    expect(validateDate('2025-12-31', 'test').valid).toBe(true)\n  })\n})\n\ndescribe('input validation: domain rules', () => {\n  it('warns on 401k contribution over limit', () => {\n    const income = {\n      name: 'Job', type: 'w2' as const, annualAmount: 150000, isActive: true,\n      w2: { pretax401k: 40000, grossSalary: 150000 },\n    }\n    const issues = validateIncomeStream(income, 0)\n    expect(issues.some(i => i.message.includes('401(k)') && i.message.includes('limit'))).toBe(true)\n  })\n\n  it('warns on low S-Corp officer salary', () => {\n    const income = {\n      name: 'S-Corp', type: 'business' as const, annualAmount: 200000, isActive: true,\n      scorp: { officerSalary: 20000, distributions: 180000 },\n    }\n    const issues = validateIncomeStream(income, 0)\n    expect(issues.some(i => i.message.includes('officer salary') && i.message.includes('too low'))).toBe(true)\n  })\n\n  it('warns on 100% meals deduction (post-TCJA)', () => {\n    const expense = {\n      category: 'Meals & Entertainment', annualAmount: 5000,\n      isDeductible: true, deductionPct: 100,\n    }\n    const issues = validateExpense(expense, 0)\n    expect(issues.some(i => i.message.includes('50% deductible'))).toBe(true)\n  })\n\n  it('warns on entertainment deduction (post-TCJA)', () => {\n    const expense = {\n      category: 'entertainment', annualAmount: 3000,\n      isDeductible: true, deductionPct: 100,\n    }\n    const issues = validateExpense(expense, 0)\n    expect(issues.some(i => i.message.includes('NOT deductible'))).toBe(true)\n  })\n\n  it('warns on HoH without dependents', () => {\n    const state = {\n      ...createDefaultState(),\n      profile: { ...createDefaultState().profile, filingStatus: 'head_of_household' as const },\n      incomeStreams: [{ id: '1', name: 'Job', type: 'w2' as const, annualAmount: 50000, isActive: true }],\n    }\n    const result = validateFullState(state as FortunaState)\n    expect(result.issues.some(i => i.message.includes('qualifying dependent'))).toBe(true)\n  })\n\n  it('warns on expenses > 2x income', () => {\n    const state = {\n      ...createDefaultState(),\n      incomeStreams: [{ id: '1', name: 'Job', type: 'w2' as const, annualAmount: 50000, isActive: true }],\n      expenses: [{ id: '1', category: 'office', description: 'Big expense', annualAmount: 150000, isDeductible: true, deductionPct: 100 }],\n    }\n    const result = validateFullState(state as FortunaState)\n    expect(result.issues.some(i => i.message.includes('2×'))).toBe(true)\n  })\n\n  it('warns on IRA contribution over limit', () => {\n    const account = {\n      type: 'traditional_ira' as const, balance: 50000,\n      annualContribution: 15000,\n    }\n    const issues = validateRetirementAccount(account, 0)\n    expect(issues.some(i => i.message.includes('limit'))).toBe(true)\n  })\n\n  it('warns on Section 179 over limit', () => {\n    const asset = {\n      name: 'Equipment', purchasePrice: 2_000_000,\n      method: 'section_179' as const, usefulLifeYears: 7,\n    }\n    const issues = validateDepreciationAsset(asset, 0)\n    expect(issues.some(i => i.message.includes('Section 179'))).toBe(true)\n  })\n})\n\ndescribe('input validation: helpers', () => {\n  it('isFieldValid checks amounts correctly', () => {\n    expect(isFieldValid(100, 'amount')).toBe(true)\n    expect(isFieldValid(-1, 'amount')).toBe(false)\n    expect(isFieldValid(NaN, 'amount')).toBe(false)\n  })\n\n  it('isFieldValid checks percentages correctly', () => {\n    expect(isFieldValid(50, 'percentage')).toBe(true)\n    expect(isFieldValid(101, 'percentage')).toBe(false)\n    expect(isFieldValid(-1, 'percentage')).toBe(false)\n  })\n\n  it('formatCurrencyInput strips non-numeric', () => {\n    expect(formatCurrencyInput('$1,234.56').numeric).toBe(1234.56)\n    expect(formatCurrencyInput('abc').numeric).toBe(0)\n    expect(formatCurrencyInput('10000').numeric).toBe(10000)\n  })\n\n  it('IRS limits are populated for 2025', () => {\n    expect(IRS_LIMITS_2025['401k_elective']).toBe(23500)\n    expect(IRS_LIMITS_2025.ira_contribution).toBe(7000)\n    expect(IRS_LIMITS_2025.salt_cap).toBe(10000)\n    expect(IRS_LIMITS_2025.section_179_limit).toBe(1_250_000)\n    expect(IRS_LIMITS_2025.social_security_wage_base).toBe(176_100)\n  })\n})\n\n// ─── QuickBooks Parser Tests ──────────────────────────────────────────────\n\nimport { parseIIF, generateIIF, type IIFParseResult } from './qb-iif-parser'\nimport { parseOFX, parseQIF, type OFXParseResult } from './qb-ofx-parser'\nimport { mapAccount, mapAllAccounts, type AccountMapping } from './qb-coa-mapper'\n\ndescribe('QuickBooks IIF parser', () => {\n  const SAMPLE_IIF = `!TRNS\\tTRNSTYPE\\tDATE\\tACCNT\\tNAME\\tAMOUNT\\tMEMO\n!SPL\\tTRNSTYPE\\tDATE\\tACCNT\\tNAME\\tAMOUNT\\tMEMO\n!ENDTRNS\nTRNS\\tCHECK\\t01/15/2025\\tChecking\\tOffice Depot\\t-150.00\\tOffice supplies\nSPL\\tCHECK\\t01/15/2025\\tOffice Supplies\\t\\t150.00\\t\nENDTRNS\nTRNS\\tDEPOSIT\\t01/20/2025\\tChecking\\tClient ABC\\t5000.00\\tProject payment\nSPL\\tDEPOSIT\\t01/20/2025\\tConsulting Income\\t\\t-5000.00\\t\nENDTRNS`\n\n  it('should parse transactions from IIF text', () => {\n    const result = parseIIF(SAMPLE_IIF)\n    expect(result.transactions).toHaveLength(2)\n    expect(result.errors).toHaveLength(0)\n  })\n\n  it('should extract transaction types correctly', () => {\n    const result = parseIIF(SAMPLE_IIF)\n    expect(result.transactions[0].header.trnsType).toBe('CHECK')\n    expect(result.transactions[1].header.trnsType).toBe('DEPOSIT')\n  })\n\n  it('should parse amounts correctly', () => {\n    const result = parseIIF(SAMPLE_IIF)\n    expect(result.transactions[0].header.amount).toBe(-150)\n    expect(result.transactions[1].header.amount).toBe(5000)\n  })\n\n  it('should verify transaction balance (TRNS + SPL = 0)', () => {\n    const result = parseIIF(SAMPLE_IIF)\n    for (const txn of result.transactions) {\n      const total = txn.header.amount + txn.splits.reduce((s, sp) => s + sp.amount, 0)\n      expect(Math.abs(total)).toBeLessThan(0.01) // Penny tolerance\n    }\n  })\n\n  it('should parse account records', () => {\n    const iifWithAccounts = `!ACCNT\\tNAME\\tACCNTTYPE\\tDESC\nACCNT\\tChecking\\tBANK\\tMain checking\nACCNT\\tConsulting Income\\tINC\\tService revenue\nACCNT\\tOffice Supplies\\tEXP\\tOffice materials`\n\n    const result = parseIIF(iifWithAccounts)\n    expect(result.accounts).toHaveLength(3)\n    expect(result.accounts[0].name).toBe('Checking')\n    expect(result.accounts[0].accountType).toBe('BANK')\n    expect(result.accounts[1].accountType).toBe('INC')\n  })\n\n  it('should handle empty input gracefully', () => {\n    const result = parseIIF('')\n    expect(result.transactions).toHaveLength(0)\n    expect(result.accounts).toHaveLength(0)\n  })\n\n  it('should round-trip via generateIIF', () => {\n    const result = parseIIF(SAMPLE_IIF)\n    const regenerated = generateIIF({ accounts: result.accounts, transactions: result.transactions })\n    expect(regenerated).toContain('CHECK')\n    expect(regenerated).toContain('DEPOSIT')\n    expect(regenerated).toContain('ENDTRNS')\n  })\n})\n\n\ndescribe('QuickBooks OFX parser', () => {\n  const SAMPLE_OFX = `OFXHEADER:100\nDATA:OFXSGML\n<OFX>\n<SIGNONMSGSRSV1><SONRS><STATUS><CODE>0<SEVERITY>INFO</STATUS><DTSERVER>20250115<LANGUAGE>ENG</SONRS></SIGNONMSGSRSV1>\n<BANKMSGSRSV1><STMTTRNRS><STMTRS>\n<CURDEF>USD\n<BANKACCTFROM><BANKID>021000021<ACCTID>123456789<ACCTTYPE>CHECKING</BANKACCTFROM>\n<BANKTRANLIST><DTSTART>20250101<DTEND>20250131\n<STMTTRN><TRNTYPE>DEBIT<DTPOSTED>20250105<TRNAMT>-42.50<FITID>TXN001<NAME>AMAZON.COM</STMTTRN>\n<STMTTRN><TRNTYPE>CREDIT<DTPOSTED>20250115<TRNAMT>3500.00<FITID>TXN002<NAME>PAYROLL DIRECT DEPOSIT</STMTTRN>\n</BANKTRANLIST>\n<LEDGERBAL><BALAMT>8234.56<DTASOF>20250131</LEDGERBAL>\n</STMTRS></STMTTRNRS></BANKMSGSRSV1>\n</OFX>`\n\n  it('should parse OFX bank statements', () => {\n    const result = parseOFX(SAMPLE_OFX)\n    expect(result.statements.length).toBeGreaterThan(0)\n    expect(result.stats.transactionCount).toBe(2)\n  })\n\n  it('should extract amounts correctly', () => {\n    const result = parseOFX(SAMPLE_OFX)\n    const txns = result.statements[0].transactions\n    expect(txns[0].amount).toBe(-42.50)\n    expect(txns[1].amount).toBe(3500)\n  })\n\n  it('should extract payee names', () => {\n    const result = parseOFX(SAMPLE_OFX)\n    const txns = result.statements[0].transactions\n    expect(txns[0].name).toBe('AMAZON.COM')\n    expect(txns[1].name).toBe('PAYROLL DIRECT DEPOSIT')\n  })\n\n  it('should extract unique FITIDs', () => {\n    const result = parseOFX(SAMPLE_OFX)\n    const fitids = result.statements[0].transactions.map(t => t.fitId)\n    expect(new Set(fitids).size).toBe(fitids.length)\n  })\n\n  it('should extract bank account info', () => {\n    const result = parseOFX(SAMPLE_OFX)\n    const stmt = result.statements[0]\n    expect(stmt.bankAccount?.bankId).toBe('021000021')\n    expect(stmt.bankAccount?.accountId).toBe('123456789')\n    expect(stmt.bankAccount?.accountType).toBe('CHECKING')\n  })\n\n  it('should extract ledger balance', () => {\n    const result = parseOFX(SAMPLE_OFX)\n    expect(result.statements[0].ledgerBalance?.amount).toBe(8234.56)\n  })\n\n  it('should handle empty OFX gracefully', () => {\n    const result = parseOFX('<OFX></OFX>')\n    expect(result.stats.transactionCount).toBe(0)\n  })\n})\n\ndescribe('QuickBooks QIF parser', () => {\n  const SAMPLE_QIF = `!Type:Bank\nD01/05/2025\nT-42.50\nPAMAZON.COM\nMOnline purchase\nLOffice Supplies\n^\nD01/15/2025\nT3500.00\nPPAYROLL\nMJanuary salary\nLIncome:Salary\n^`\n\n  it('should parse QIF transactions', () => {\n    const result = parseQIF(SAMPLE_QIF)\n    expect(result.transactions).toHaveLength(2)\n  })\n\n  it('should extract amounts', () => {\n    const result = parseQIF(SAMPLE_QIF)\n    expect(result.transactions[0].amount).toBe(-42.50)\n    expect(result.transactions[1].amount).toBe(3500)\n  })\n\n  it('should extract payees', () => {\n    const result = parseQIF(SAMPLE_QIF)\n    expect(result.transactions[0].payee).toBe('AMAZON.COM')\n    expect(result.transactions[1].payee).toBe('PAYROLL')\n  })\n\n  it('should extract categories', () => {\n    const result = parseQIF(SAMPLE_QIF)\n    expect(result.transactions[0].category).toBe('Office Supplies')\n    expect(result.transactions[1].category).toBe('Income:Salary')\n  })\n})\n\ndescribe('QuickBooks COA mapper', () => {\n  it('should map INC accounts to business_income', () => {\n    const mapping = mapAccount({ name: 'Sales Revenue', accountType: 'INC' } as any)\n    expect(mapping.fortunaCategory).toBe('business_income')\n    expect(mapping.isDeductible).toBe(false)\n  })\n\n  it('should map EXP accounts to business_expense', () => {\n    const mapping = mapAccount({ name: 'Office Supplies', accountType: 'EXP' } as any)\n    expect(mapping.fortunaCategory).toBe('business_expense')\n    expect(mapping.isDeductible).toBe(true)\n  })\n\n  it('should map COGS accounts correctly', () => {\n    const mapping = mapAccount({ name: 'Cost of Goods Sold', accountType: 'COGS' } as any)\n    expect(mapping.fortunaCategory).toBe('cogs')\n  })\n\n  it('should detect vehicle expenses from account name', () => {\n    const mapping = mapAccount({ name: 'Auto Expense', accountType: 'EXP' } as any)\n    expect(mapping.fortunaCategory).toBe('vehicle_expense')\n    expect(mapping.scheduleRef).toContain('Schedule C')\n  })\n\n  it('should detect home office from account name', () => {\n    const mapping = mapAccount({ name: 'Business Use of Home', accountType: 'EXP' } as any)\n    expect(mapping.fortunaCategory).toBe('home_office')\n    expect(mapping.scheduleRef).toContain('Form 8829')\n  })\n\n  it('should detect depreciation from account name', () => {\n    const mapping = mapAccount({ name: 'Depreciation Expense', accountType: 'EXP' } as any)\n    expect(mapping.fortunaCategory).toBe('depreciation')\n  })\n\n  it('should detect rental income', () => {\n    const mapping = mapAccount({ name: 'Rental Income - Property A', accountType: 'INC' } as any)\n    expect(mapping.fortunaCategory).toBe('rental_income')\n    expect(mapping.scheduleRef).toContain('Schedule E')\n  })\n\n  it('should detect charitable donations', () => {\n    const mapping = mapAccount({ name: 'Charitable Contributions', accountType: 'EXP' } as any)\n    expect(mapping.fortunaCategory).toBe('itemized_deduction')\n  })\n\n  it('should mark entertainment as non-deductible', () => {\n    const mapping = mapAccount({ name: 'Entertainment', accountType: 'EXP' } as any)\n    expect(mapping.fortunaCategory).toBe('non_deductible')\n  })\n\n  it('should batch-map multiple accounts', () => {\n    const accounts = [\n      { name: 'Checking', accountType: 'BANK', description: '' },\n      { name: 'Sales', accountType: 'INC', description: '' },\n      { name: 'Rent Expense', accountType: 'EXP', description: '' },\n    ]\n    const result = mapAllAccounts(accounts as any)\n    expect(result.size).toBe(3)\n    expect(result.get('Sales')?.fortunaCategory).toBe('business_income')\n    expect(result.get('Rent Expense')?.fortunaCategory).toBe('business_expense')\n  })\n})\n\n// ─── State Integrity Tests ────────────────────────────────────────────────\n\ndescribe('state integrity', () => {\n  it('createDefaultState should pass validation', () => {\n    const state = createDefaultState()\n    const result = validateState(state)\n    expect(result.valid).toBe(true)\n  })\n\n  it('default state should have all required arrays', () => {\n    const state = createDefaultState()\n    expect(Array.isArray(state.incomeStreams)).toBe(true)\n    expect(Array.isArray(state.expenses)).toBe(true)\n    expect(Array.isArray(state.entities)).toBe(true)\n    expect(Array.isArray(state.deductions)).toBe(true)\n    expect(Array.isArray(state.depreciationAssets)).toBe(true)\n    expect(Array.isArray(state.investmentPortfolio)).toBe(true)\n    expect(Array.isArray(state.retirementAccounts)).toBe(true)\n    expect(Array.isArray(state.goals)).toBe(true)\n    expect(Array.isArray(state.documents)).toBe(true)\n    expect(Array.isArray(state.estimatedPayments)).toBe(true)\n  })\n\n  it('default state should have valid profile', () => {\n    const state = createDefaultState()\n    expect(state.profile.filingStatus).toBe('single')\n    expect(state.taxYear).toBeGreaterThanOrEqual(2024)\n  })\n\n  it('full state validation should categorize issues', () => {\n    const state = {\n      ...createDefaultState(),\n      profile: { ...createDefaultState().profile, filingStatus: 'head_of_household' as const },\n      incomeStreams: [{ id: '1', name: 'Job', type: 'w2' as const, annualAmount: 50000, isActive: true }],\n      expenses: [{ id: '1', category: 'Meals', description: 'Meals', annualAmount: 200000, isDeductible: true, deductionPct: 100 }],\n    }\n    const result = validateFullState(state as FortunaState)\n    expect(result.sections.length).toBeGreaterThan(0)\n    expect(result.warningCount + result.infoCount + result.errorCount).toBe(result.issues.length)\n  })\n})\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\health-score.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'calculateSCorpSavings' is defined but never used.","line":10,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":50,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"calculateSCorpSavings"},"fix":{"range":[306,329],"text":""},"desc":"Remove unused variable \"calculateSCorpSavings\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'computePortfolioSummary' is defined but never used.","line":12,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":51,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"computePortfolioSummary"},"fix":{"range":[429,454],"text":""},"desc":"Remove unused variable \"computePortfolioSummary\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'profile' is assigned a value but never used.","line":68,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":68,"endColumn":18}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE v6 — Financial Health Score\n * \n * Composite scoring system that evaluates financial health across\n * multiple dimensions with letter grades, trend indicators,\n * and actionable improvement recommendations.\n */\n\nimport type { FortunaState } from './storage'\nimport { generateTaxReport, calculateSCorpSavings } from './tax-calculator'\nimport { analyzeAuditRisk } from './audit-risk'\nimport { hasPortfolioData, computePortfolioSummary, scorePortfolioHealth } from './portfolio-bridge'\n\n// ─── Types ───────────────────────────────────────────────────────────────\n\nexport type HealthGrade = 'A+' | 'A' | 'A-' | 'B+' | 'B' | 'B-' | 'C+' | 'C' | 'C-' | 'D' | 'F'\n\nexport interface HealthDimension {\n  id: string\n  name: string\n  score: number       // 0-100\n  grade: HealthGrade\n  weight: number      // 0-1\n  color: string\n  icon: string\n  status: string\n  detail: string\n  recommendations: string[]\n}\n\nexport interface FinancialHealthReport {\n  overallScore: number\n  overallGrade: HealthGrade\n  dimensions: HealthDimension[]\n  topPriority: string\n  quickWins: string[]\n  riskFlags: string[]\n  strengthsSummary: string\n}\n\n// ─── Grading ─────────────────────────────────────────────────────────────\n\nfunction scoreToGrade(score: number): HealthGrade {\n  if (score >= 97) return 'A+'\n  if (score >= 93) return 'A'\n  if (score >= 90) return 'A-'\n  if (score >= 87) return 'B+'\n  if (score >= 83) return 'B'\n  if (score >= 80) return 'B-'\n  if (score >= 77) return 'C+'\n  if (score >= 73) return 'C'\n  if (score >= 70) return 'C-'\n  if (score >= 60) return 'D'\n  return 'F'\n}\n\nfunction gradeColor(grade: HealthGrade): string {\n  if (grade.startsWith('A')) return '#10b981'\n  if (grade.startsWith('B')) return '#3b82f6'\n  if (grade.startsWith('C')) return '#f59e0b'\n  if (grade.startsWith('D')) return '#ef4444'\n  return '#dc2626'\n}\n\n// ─── Dimension Scorers ──────────────────────────────────────────────────\n\nfunction scoreTaxEfficiency(state: FortunaState): HealthDimension {\n  const { profile, incomeStreams, expenses, deductions } = state\n  const totalIncome = incomeStreams.filter(s => s.isActive).reduce((sum, s) => sum + s.annualAmount, 0)\n  if (totalIncome === 0) {\n    return {\n      id: 'tax_efficiency', name: 'Tax Efficiency', score: 50, grade: 'C-',\n      weight: 0.25, color: '#f59e0b', icon: '📊',\n      status: 'No income data', detail: 'Add income streams to calculate tax efficiency.',\n      recommendations: ['Add your income sources in the profile setup'],\n    }\n  }\n\n  const report = generateTaxReport(state)\n  const effectiveRate = report.effectiveRate\n  let score = 100\n\n  // Penalize high effective rates relative to income\n  if (totalIncome < 50000) {\n    if (effectiveRate > 20) score -= 20\n    else if (effectiveRate > 15) score -= 10\n  } else if (totalIncome < 100000) {\n    if (effectiveRate > 28) score -= 25\n    else if (effectiveRate > 22) score -= 15\n    else if (effectiveRate > 18) score -= 5\n  } else {\n    if (effectiveRate > 35) score -= 30\n    else if (effectiveRate > 28) score -= 15\n    else if (effectiveRate > 24) score -= 5\n  }\n\n  // Reward deduction optimization\n  const deductionCount = deductions.length + expenses.filter(e => e.isDeductible).length\n  if (deductionCount < 3) score -= 15\n  else if (deductionCount < 5) score -= 5\n  else if (deductionCount >= 8) score += 5\n\n  // Check for retirement contributions\n  const hasRetirement = deductions.some(d => d.category === 'retirement' && d.amount > 0)\n  if (!hasRetirement) score -= 10\n\n  // Check if they should have S-Corp but don't\n  const selfEmploymentIncome = incomeStreams\n    .filter(s => ['business', 'freelance'].includes(s.type) && s.isActive)\n    .reduce((sum, s) => sum + s.annualAmount, 0)\n  const hasScorp = state.entities.some(e => (e.type === 'llc_scorp' || e.type === 'scorp') && e.isActive)\n  if (selfEmploymentIncome > 60000 && !hasScorp) score -= 15\n\n  score = Math.max(0, Math.min(100, score))\n  const grade = scoreToGrade(score)\n  const recommendations: string[] = []\n  if (!hasRetirement) recommendations.push('Add retirement contributions (Solo 401k, SEP-IRA, or Traditional IRA)')\n  if (selfEmploymentIncome > 60000 && !hasScorp) recommendations.push('Evaluate S-Corp election for SE tax savings')\n  if (deductionCount < 5) recommendations.push('Review commonly missed deductions: home office, vehicle, health insurance')\n  if (effectiveRate > 25) recommendations.push('Consider income timing strategies to manage bracket exposure')\n\n  return {\n    id: 'tax_efficiency', name: 'Tax Efficiency', score, grade,\n    weight: 0.25, color: gradeColor(grade), icon: '📊',\n    status: `${effectiveRate.toFixed(1)}% effective rate`,\n    detail: `Federal effective tax rate on $${totalIncome.toLocaleString()} total income. ${deductionCount} deductions claimed.`,\n    recommendations,\n  }\n}\n\nfunction scoreEntityStructure(state: FortunaState): HealthDimension {\n  const { incomeStreams, entities } = state\n  const selfEmploymentIncome = incomeStreams\n    .filter(s => ['business', 'freelance'].includes(s.type) && s.isActive)\n    .reduce((sum, s) => sum + s.annualAmount, 0)\n\n  if (selfEmploymentIncome === 0) {\n    return {\n      id: 'entity_structure', name: 'Entity Structure', score: 80, grade: 'B-',\n      weight: 0.20, color: '#3b82f6', icon: '🏛️',\n      status: 'N/A — no SE income', detail: 'No self-employment income to optimize entity structure for.',\n      recommendations: [],\n    }\n  }\n\n  let score = 70\n  const hasEntity = entities.some(e => e.isActive)\n  const hasScorp = entities.some(e => (e.type === 'llc_scorp' || e.type === 'scorp') && e.isActive)\n  const recommendations: string[] = []\n\n  if (selfEmploymentIncome < 40000) {\n    // Low income — sole prop is fine\n    score = hasEntity ? 85 : 80\n  } else if (selfEmploymentIncome < 75000) {\n    // Mid income — LLC or S-Corp beneficial\n    if (hasScorp) score = 95\n    else if (hasEntity) score = 75\n    else {\n      score = 55\n      recommendations.push('Evaluate LLC with S-Corp election at this income level')\n    }\n  } else {\n    // High income — S-Corp strongly recommended\n    if (hasScorp) score = 95\n    else if (hasEntity) score = 60\n    else {\n      score = 40\n      recommendations.push('S-Corp election could save significant SE tax at this income level')\n    }\n  }\n\n  // Multi-stream optimization\n  const bizStreams = incomeStreams.filter(s => ['business', 'freelance'].includes(s.type) && s.isActive)\n  if (bizStreams.length >= 2 && selfEmploymentIncome > 100000 && entities.length < 2) {\n    score -= 10\n    recommendations.push('Consider separate entities for different income streams')\n  }\n\n  score = Math.max(0, Math.min(100, score))\n  const grade = scoreToGrade(score)\n\n  return {\n    id: 'entity_structure', name: 'Entity Structure', score, grade,\n    weight: 0.20, color: gradeColor(grade), icon: '🏛️',\n    status: hasScorp ? 'S-Corp active' : hasEntity ? 'LLC active' : 'Sole proprietorship',\n    detail: `$${selfEmploymentIncome.toLocaleString()} SE income. ${entities.filter(e => e.isActive).length} active entit${entities.filter(e => e.isActive).length === 1 ? 'y' : 'ies'}.`,\n    recommendations,\n  }\n}\n\nfunction scoreAuditReadiness(state: FortunaState): HealthDimension {\n  const totalIncome = state.incomeStreams.filter(s => s.isActive).reduce((sum, s) => sum + s.annualAmount, 0)\n  if (totalIncome === 0) {\n    return {\n      id: 'audit_readiness', name: 'Audit Readiness', score: 70, grade: 'C-',\n      weight: 0.15, color: '#f59e0b', icon: '🛡️',\n      status: 'No data', detail: 'Add income data to assess audit risk.',\n      recommendations: ['Complete your financial profile'],\n    }\n  }\n\n  const auditResult = analyzeAuditRisk(state)\n  // Convert audit risk score (0-100, higher = more risk) to health score (0-100, higher = better)\n  const riskScore = auditResult.overallScore\n  let score = 100 - riskScore\n\n  // Bonus for having documentation\n  const hasBusinessExpenses = state.expenses.some(e => e.isDeductible)\n  if (hasBusinessExpenses) score += 5\n\n  score = Math.max(0, Math.min(100, score))\n  const grade = scoreToGrade(score)\n  const recommendations: string[] = []\n\n  if (riskScore > 50) recommendations.push('Review audit risk factors in the Audit Profiler')\n  if (riskScore > 30) recommendations.push('Ensure all deductions have supporting documentation')\n\n  const highRiskFactors = auditResult.triggers.filter(f => f.riskScore > 60)\n  highRiskFactors.slice(0, 2).forEach(f => {\n    recommendations.push(`Address: ${f.name} (${f.severity} risk)`)\n  })\n\n  return {\n    id: 'audit_readiness', name: 'Audit Readiness', score, grade,\n    weight: 0.15, color: gradeColor(grade), icon: '🛡️',\n    status: riskScore < 30 ? 'Low risk' : riskScore < 60 ? 'Moderate risk' : 'Elevated risk',\n    detail: `Audit risk score: ${riskScore}/100. ${auditResult.triggers.filter(f => f.riskScore > 50).length} elevated risk factors.`,\n    recommendations,\n  }\n}\n\nfunction scoreIncomeDiversification(state: FortunaState): HealthDimension {\n  const activeStreams = state.incomeStreams.filter(s => s.isActive)\n  const totalIncome = activeStreams.reduce((sum, s) => sum + s.annualAmount, 0)\n\n  if (totalIncome === 0) {\n    return {\n      id: 'diversification', name: 'Income Diversification', score: 0, grade: 'F',\n      weight: 0.15, color: '#dc2626', icon: '🌐',\n      status: 'No income', detail: 'No income streams configured.',\n      recommendations: ['Add your income sources'],\n    }\n  }\n\n  let score = 50\n  const recommendations: string[] = []\n\n  // Number of streams\n  if (activeStreams.length === 1) score = 40\n  else if (activeStreams.length === 2) score = 65\n  else if (activeStreams.length === 3) score = 80\n  else score = 90\n\n  // Concentration — Herfindahl index\n  const shares = activeStreams.map(s => s.annualAmount / totalIncome)\n  const hhi = shares.reduce((sum, s) => sum + s * s, 0)\n  if (hhi > 0.8) score -= 20\n  else if (hhi > 0.5) score -= 10\n  else if (hhi < 0.4) score += 10\n\n  // Type diversity\n  const types = new Set(activeStreams.map(s => s.type))\n  if (types.size >= 3) score += 10\n  else if (types.size === 1) score -= 10\n\n  // Passive income\n  const hasPassive = activeStreams.some(s => ['investment', 'rental', 'royalty'].includes(s.type))\n  if (hasPassive) score += 10\n\n  score = Math.max(0, Math.min(100, score))\n  const grade = scoreToGrade(score)\n\n  if (activeStreams.length === 1) recommendations.push('Explore additional income streams for resilience')\n  if (hhi > 0.7) recommendations.push('Income is highly concentrated — consider diversifying')\n  if (!hasPassive) recommendations.push('Consider adding passive income (investments, rental, etc.)')\n\n  return {\n    id: 'diversification', name: 'Income Diversification', score, grade,\n    weight: 0.15, color: gradeColor(grade), icon: '🌐',\n    status: `${activeStreams.length} stream${activeStreams.length !== 1 ? 's' : ''}, ${Math.round(hhi * 100)}% concentration`,\n    detail: `${activeStreams.length} active income streams across ${types.size} type${types.size !== 1 ? 's' : ''}. ${hasPassive ? 'Includes passive income.' : 'No passive income streams.'}`,\n    recommendations,\n  }\n}\n\nfunction scoreRetirementReadiness(state: FortunaState): HealthDimension {\n  const { deductions, incomeStreams, profile } = state\n  const totalIncome = incomeStreams.filter(s => s.isActive).reduce((sum, s) => sum + s.annualAmount, 0)\n  const retirementContributions = deductions\n    .filter(d => d.category === 'retirement')\n    .reduce((sum, d) => sum + d.amount, 0)\n\n  // Also check actual retirement accounts from metamodel\n  const accounts = state.retirementAccounts || []\n  const accountContributions = accounts.reduce((sum, a) => sum + (a.annualContribution || 0), 0)\n  const totalRetirementActivity = Math.max(retirementContributions, accountContributions)\n  const totalBalance = accounts.reduce((sum, a) => sum + (a.balance || 0), 0)\n  const hasRoth = accounts.some(a => a.type === 'roth_ira' || a.type === 'roth_401k')\n  const hasHSA = accounts.some(a => a.type === 'hsa')\n  const accountCount = accounts.length\n\n  if (totalIncome === 0) {\n    return {\n      id: 'retirement', name: 'Retirement Readiness', score: 50, grade: 'C-',\n      weight: 0.15, color: '#f59e0b', icon: '🏦',\n      status: 'No data', detail: 'Add income to assess retirement readiness.',\n      recommendations: ['Complete your financial profile'],\n    }\n  }\n\n  let score = 50\n  const recommendations: string[] = []\n  const savingsRate = totalIncome > 0 ? (totalRetirementActivity / totalIncome) * 100 : 0\n\n  if (savingsRate >= 20) score = 95\n  else if (savingsRate >= 15) score = 90\n  else if (savingsRate >= 10) score = 80\n  else if (savingsRate >= 5) score = 65\n  else if (savingsRate > 0) score = 50\n  else score = 25\n\n  // Account diversification bonus\n  if (accountCount >= 3) score += 5\n  if (hasRoth && totalRetirementActivity > 0) score += 5\n  if (hasHSA) score += 3\n\n  // Balance check (rough target: age * income * 0.1)\n  const age = profile.age || 35\n  const roughTarget = age * totalIncome * 0.1\n  if (totalBalance > 0 && totalBalance >= roughTarget) score += 5\n  else if (totalBalance > 0 && totalBalance < roughTarget * 0.5) score -= 5\n\n  if (age > 50 && savingsRate < 15) {\n    score -= 10\n    recommendations.push('Consider catch-up contributions (additional $7,500 for 401k if 50+)')\n  }\n  if (age < 30 && savingsRate >= 10) score += 5\n\n  const selfEmploymentIncome = incomeStreams\n    .filter(s => ['business', 'freelance'].includes(s.type) && s.isActive)\n    .reduce((sum, s) => sum + s.annualAmount, 0)\n  if (selfEmploymentIncome > 50000 && totalRetirementActivity < 20000) {\n    score -= 10\n    recommendations.push('Self-employed with high income \\u2014 Solo 401(k) could shelter more income')\n  }\n\n  if (totalRetirementActivity === 0) recommendations.push('Start retirement contributions \\u2014 even small amounts compound significantly')\n  if (savingsRate < 15 && savingsRate > 0) recommendations.push(`Current savings rate: ${savingsRate.toFixed(1)}% \\u2014 target 15-20%`)\n  if (!hasRoth && totalRetirementActivity > 0) recommendations.push('Consider Roth accounts for tax-free growth and withdrawal flexibility')\n  if (!hasHSA && selfEmploymentIncome > 0) recommendations.push('HSA offers triple tax advantage \\u2014 deductible, tax-free growth, tax-free medical withdrawals')\n\n  score = Math.max(0, Math.min(100, score))\n  const grade = scoreToGrade(score)\n  const balanceStr = totalBalance > 0 ? ` Balance: $${totalBalance.toLocaleString()}.` : ''\n\n  return {\n    id: 'retirement', name: 'Retirement Readiness', score, grade,\n    weight: 0.15, color: gradeColor(grade), icon: '🏦',\n    status: totalRetirementActivity > 0 ? `${savingsRate.toFixed(1)}% savings rate` : 'No contributions',\n    detail: `$${totalRetirementActivity.toLocaleString()}/yr in retirement contributions (${savingsRate.toFixed(1)}% of income).${balanceStr} ${accountCount} account${accountCount !== 1 ? 's' : ''}.`,\n    recommendations,\n  }\n}\n\nfunction scoreCashFlowManagement(state: FortunaState): HealthDimension {\n  const totalIncome = state.incomeStreams.filter(s => s.isActive).reduce((sum, s) => sum + s.annualAmount, 0)\n  const totalExpenses = state.expenses.reduce((sum, e) => sum + e.annualAmount, 0)\n  const netCashFlow = totalIncome - totalExpenses\n\n  if (totalIncome === 0) {\n    return {\n      id: 'cashflow', name: 'Cash Flow', score: 50, grade: 'C-',\n      weight: 0.10, color: '#f59e0b', icon: '💰',\n      status: 'No data', detail: 'Add income and expenses.',\n      recommendations: ['Complete your financial profile'],\n    }\n  }\n\n  let score = 70\n  const recommendations: string[] = []\n  const margin = (netCashFlow / totalIncome) * 100\n\n  if (margin >= 40) score = 95\n  else if (margin >= 30) score = 88\n  else if (margin >= 20) score = 78\n  else if (margin >= 10) score = 65\n  else if (margin >= 0) score = 50\n  else score = 25\n\n  // Track if expenses are well-categorized\n  const categorizedExpenses = state.expenses.filter(e => e.category && e.category !== 'other')\n  if (categorizedExpenses.length < state.expenses.length * 0.5) score -= 5\n\n  score = Math.max(0, Math.min(100, score))\n  const grade = scoreToGrade(score)\n\n  if (margin < 20) recommendations.push('Target 20%+ cash flow margin for financial resilience')\n  if (margin < 10) recommendations.push('Cash flow is tight — review expenses for optimization opportunities')\n  if (state.expenses.length === 0) recommendations.push('Add expense tracking for accurate cash flow analysis')\n\n  return {\n    id: 'cashflow', name: 'Cash Flow', score, grade,\n    weight: 0.10, color: gradeColor(grade), icon: '💰',\n    status: `${margin.toFixed(0)}% margin`,\n    detail: `$${Math.round(netCashFlow).toLocaleString()}/yr net cash flow (${margin.toFixed(1)}% margin). ${state.expenses.length} expenses tracked.`,\n    recommendations,\n  }\n}\n\n// ─── Main Health Score Generator ────────────────────────────────────────\n\nexport function generateHealthReport(state: FortunaState): FinancialHealthReport {\n  const dimensions: HealthDimension[] = [\n    scoreTaxEfficiency(state),\n    scoreEntityStructure(state),\n    scoreAuditReadiness(state),\n    scoreIncomeDiversification(state),\n    scoreRetirementReadiness(state),\n    scoreCashFlowManagement(state),\n  ]\n\n  // Conditionally add portfolio health dimension\n  if (hasPortfolioData()) {\n    const ph = scorePortfolioHealth()\n    if (ph.score >= 0) {\n      const recommendations: string[] = []\n      for (const f of ph.factors) {\n        if (f.score < f.maxScore * 0.7) {\n          recommendations.push(`Improve ${f.name.toLowerCase()}: ${f.detail}`)\n        }\n      }\n      if (recommendations.length === 0) recommendations.push('Portfolio health is strong \\u2014 maintain current strategy')\n\n      dimensions.push({\n        id: 'portfolio',\n        name: 'Portfolio Health',\n        score: ph.score,\n        grade: scoreToGrade(ph.score),\n        weight: 0.15,\n        color: '#8b5cf6',\n        icon: '\\uD83D\\uDCBC',\n        status: ph.factors.map(f => `${f.name}: ${f.score}/${f.maxScore}`).join(' \\u00B7 '),\n        detail: `Portfolio score: ${ph.score}/100 (${ph.grade}). ${ph.factors.length} factors evaluated.`,\n        recommendations,\n      })\n    }\n  }\n\n  // ── Depreciation Strategy dimension (from depreciationAssets) ──────\n  const depAssets = state.depreciationAssets || []\n  if (depAssets.length > 0) {\n    let depScore = 70\n    const depRecs: string[] = []\n    const activeAssets = depAssets.filter(a => a.isActive)\n    const has179 = activeAssets.some(a => a.method === 'section_179')\n    const hasBonus = activeAssets.some(a => a.method === 'bonus')\n    const totalValue = activeAssets.reduce((s, a) => s + a.purchasePrice, 0)\n    const avgBizUse = activeAssets.length > 0 ? activeAssets.reduce((s, a) => s + a.businessUsePct, 0) / activeAssets.length : 0\n\n    if (has179 || hasBonus) depScore += 10\n    if (avgBizUse >= 80) depScore += 5\n    else if (avgBizUse < 50) depScore -= 10\n    if (activeAssets.length >= 3) depScore += 5\n\n    // Check for fully depreciated assets still marked active\n    const fullyDep = activeAssets.filter(a => {\n      const age = (new Date().getFullYear()) - new Date(a.purchaseDate).getFullYear()\n      return age >= (a.usefulLifeYears || 5)\n    })\n    if (fullyDep.length > 0) {\n      depScore -= 5\n      depRecs.push(`${fullyDep.length} asset(s) may be fully depreciated \\u2014 review for replacement or removal`)\n    }\n    if (!has179 && totalValue > 10000) depRecs.push('\\u00A7179 election could accelerate deductions on qualifying assets')\n    if (avgBizUse < 80) depRecs.push('Increase business use percentage where possible to maximize deductions')\n\n    depScore = Math.max(0, Math.min(100, depScore))\n    dimensions.push({\n      id: 'depreciation', name: 'Asset Strategy', score: depScore, grade: scoreToGrade(depScore),\n      weight: 0.08, color: gradeColor(scoreToGrade(depScore)), icon: '\\uD83C\\uDFED',\n      status: `${activeAssets.length} assets, $${totalValue.toLocaleString()} basis`,\n      detail: `${activeAssets.length} depreciable assets worth $${totalValue.toLocaleString()}. ${has179 ? '\\u00A7179 active.' : ''} ${hasBonus ? 'Bonus depreciation active.' : ''} Avg business use: ${avgBizUse.toFixed(0)}%.`,\n      recommendations: depRecs.length > 0 ? depRecs : ['Depreciation strategy is well-optimized'],\n    })\n  }\n\n  // ── Estimated Payment Compliance dimension ──────────────────────────\n  const estPayments = state.estimatedPayments || []\n  if (estPayments.length > 0) {\n    let payScore = 80\n    const payRecs: string[] = []\n    const paid = estPayments.filter(p => p.paidAmount && p.paidAmount > 0)\n    const missed = estPayments.filter(p => {\n      const due = new Date(p.dueDate)\n      return due < new Date() && (!p.paidAmount || p.paidAmount === 0)\n    })\n    const underpaid = estPayments.filter(p => p.paidAmount && p.paidAmount > 0 && p.paidAmount < p.amount * 0.9)\n\n    if (missed.length > 0) { payScore -= missed.length * 15; payRecs.push(`${missed.length} estimated payment(s) missed \\u2014 may trigger underpayment penalty`) }\n    if (underpaid.length > 0) { payScore -= underpaid.length * 5; payRecs.push(`${underpaid.length} payment(s) underpaid \\u2014 review safe harbor requirements`) }\n    if (paid.length === estPayments.length && missed.length === 0) payScore = 95\n\n    payScore = Math.max(0, Math.min(100, payScore))\n    dimensions.push({\n      id: 'payments', name: 'Payment Compliance', score: payScore, grade: scoreToGrade(payScore),\n      weight: 0.08, color: gradeColor(scoreToGrade(payScore)), icon: '\\uD83D\\uDCC5',\n      status: `${paid.length}/${estPayments.length} payments made`,\n      detail: `${paid.length} of ${estPayments.length} estimated payments made. ${missed.length} missed. ${underpaid.length} underpaid.`,\n      recommendations: payRecs.length > 0 ? payRecs : ['Estimated payments are on track'],\n    })\n  }\n\n  // ── Goal Progress dimension ─────────────────────────────────────────\n  const goals = state.goals || []\n  if (goals.length > 0) {\n    let goalScore = 60\n    const goalRecs: string[] = []\n    const active = goals.filter(g => g.status === 'active')\n    const completed = goals.filter(g => g.status === 'completed')\n    const withProgress = active.filter(g => g.currentAmount && g.targetAmount && g.currentAmount > 0)\n    const avgProgress = withProgress.length > 0\n      ? withProgress.reduce((s, g) => s + ((g.currentAmount || 0) / (g.targetAmount || 1)), 0) / withProgress.length * 100\n      : 0\n\n    if (completed.length > 0) goalScore += completed.length * 5\n    if (avgProgress >= 75) goalScore += 15\n    else if (avgProgress >= 50) goalScore += 10\n    else if (avgProgress >= 25) goalScore += 5\n    if (active.length === 0 && completed.length === 0) goalScore = 40\n\n    if (active.length > 0 && avgProgress < 25) goalRecs.push('Goals are behind pace \\u2014 review strategy alignment')\n    if (active.length === 0) goalRecs.push('Set financial goals to track your progress and prioritize strategies')\n\n    goalScore = Math.max(0, Math.min(100, goalScore))\n    dimensions.push({\n      id: 'goals', name: 'Goal Progress', score: goalScore, grade: scoreToGrade(goalScore),\n      weight: 0.08, color: gradeColor(scoreToGrade(goalScore)), icon: '\\uD83C\\uDFAF',\n      status: `${active.length} active, ${completed.length} completed`,\n      detail: `${active.length} active goals, ${completed.length} completed. ${avgProgress > 0 ? `Average progress: ${avgProgress.toFixed(0)}%.` : ''}`,\n      recommendations: goalRecs.length > 0 ? goalRecs : ['Goal tracking is on target'],\n    })\n  }\n\n  // ── Entity Diversification (reads entityBreakdown from tax report) ──\n  const entityBreakdown = report.entityBreakdown || []\n  const activeEntities = entityBreakdown.filter(e => e.revenue > 0 || e.netIncome > 0)\n  if (activeEntities.length > 0) {\n    let entityScore = 50\n    const entityRecs: string[] = []\n\n    // Multiple entities = diversification bonus\n    if (activeEntities.length >= 3) entityScore += 20\n    else if (activeEntities.length >= 2) entityScore += 10\n\n    // Check profitability\n    const profitable = activeEntities.filter(e => e.netIncome > 0)\n    if (profitable.length === activeEntities.length) entityScore += 15\n    else if (profitable.length > 0) entityScore += 5\n    else { entityScore -= 15; entityRecs.push('No entities are currently profitable — review expense structure') }\n\n    // Revenue concentration risk\n    const totalRevenue = activeEntities.reduce((s, e) => s + e.revenue, 0)\n    const maxEntityRevenue = Math.max(...activeEntities.map(e => e.revenue))\n    const concentration = totalRevenue > 0 ? maxEntityRevenue / totalRevenue : 1\n    if (concentration > 0.9 && activeEntities.length > 1) {\n      entityScore -= 10\n      entityRecs.push('90%+ revenue concentrated in one entity — diversify income streams')\n    } else if (concentration < 0.6) entityScore += 10\n\n    // S-Corp officer salary check\n    const scorpEntities = activeEntities.filter(e => e.entityType === 'llc_scorp' || e.entityType === 'scorp')\n    for (const se of scorpEntities) {\n      if (se.officerSalary > 0 && se.netIncome > 0 && se.officerSalary / se.netIncome < 0.3) {\n        entityScore -= 10\n        entityRecs.push(`${se.entityName}: officer salary is ${Math.round(se.officerSalary / se.netIncome * 100)}% of net income — IRS scrutinizes below 30-40%`)\n      }\n    }\n\n    entityScore = Math.max(0, Math.min(100, entityScore))\n    if (entityRecs.length === 0) entityRecs.push('Entity structure appears well-optimized')\n\n    dimensions.push({\n      id: 'entity_health', name: 'Entity Diversification', score: entityScore, grade: scoreToGrade(entityScore),\n      weight: 0.08, color: gradeColor(scoreToGrade(entityScore)), icon: '\\uD83C\\uDFE2',\n      status: `${activeEntities.length} active entities, ${profitable.length} profitable`,\n      detail: `${activeEntities.length} entities generating $${totalRevenue.toLocaleString()} total revenue. Concentration: ${Math.round(concentration * 100)}%.`,\n      recommendations: entityRecs,\n    })\n  }\n\n  // Weighted average\n  const totalWeight = dimensions.reduce((sum, d) => sum + d.weight, 0)\n  const overallScore = Math.round(\n    dimensions.reduce((sum, d) => sum + d.score * d.weight, 0) / totalWeight\n  )\n  const overallGrade = scoreToGrade(overallScore)\n\n  // Find top priority (lowest-scoring dimension with high weight)\n  const prioritySorted = [...dimensions].sort((a, b) => (a.score * a.weight) - (b.score * b.weight))\n  const topPriority = prioritySorted[0]?.recommendations[0] || 'Your financial health looks good — maintain current strategies'\n\n  // Quick wins (recommendations from high-weight dimensions with <80 score)\n  const quickWins = dimensions\n    .filter(d => d.score < 80)\n    .flatMap(d => d.recommendations.slice(0, 1))\n    .slice(0, 3)\n\n  // Risk flags\n  const riskFlags = dimensions\n    .filter(d => d.grade.startsWith('D') || d.grade === 'F')\n    .map(d => `${d.name}: ${d.status}`)\n\n  // Strengths\n  const strengths = dimensions.filter(d => d.score >= 85)\n  const strengthsSummary = strengths.length > 0\n    ? `Strong in: ${strengths.map(d => d.name).join(', ')}`\n    : 'Work on fundamentals to build financial strength'\n\n  return {\n    overallScore,\n    overallGrade,\n    dimensions,\n    topPriority,\n    quickWins,\n    riskFlags,\n    strengthsSummary,\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\history-engine.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TaxReport' is defined but never used.","line":10,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":43,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TaxReport"},"fix":{"range":[357,373],"text":""},"desc":"Remove unused variable \"TaxReport\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — Financial History Engine v8\n *\n * Records periodic financial snapshots, computes trends, diffs,\n * strategy effectiveness, seasonal patterns, and trajectory projections.\n * Transforms Fortuna from a point-in-time tool to a time-series intelligence system.\n */\n\nimport type { FortunaState } from './storage'\nimport { generateTaxReport, type TaxReport } from './tax-calculator'\nimport { analyzeAuditRisk } from './audit-risk'\nimport { calculateHealthScore } from './strategy-detector'\n\n// ===================================================================\n//  SNAPSHOT DATA MODEL\n// ===================================================================\n\nexport interface SnapshotMetrics {\n  // Income\n  totalIncome: number\n  selfEmploymentIncome: number\n  w2Income: number\n  investmentIncome: number\n  incomeStreamCount: number\n\n  // Expenses & Deductions\n  totalExpenses: number\n  totalDeductions: number\n  netIncome: number\n\n  // Tax\n  totalTaxBurden: number\n  effectiveTaxRate: number\n  marginalRate: number\n  selfEmploymentTax: number\n  quarterlyEstimated: number\n\n  // Risk & Health\n  healthScore: number\n  auditRiskScore: number\n\n  // Structure\n  entityCount: number\n  activeEntityTypes: string[]\n\n  // Retirement\n  retirementContributions: number\n\n  // Strategies\n  strategiesDetected: number\n  strategiesImplemented: number\n  estimatedSavingsTotal: number\n}\n\nexport interface FinancialSnapshot {\n  id: string\n  timestamp: string\n  trigger: 'auto' | 'manual' | 'monthly' | 'event'\n  eventDescription?: string\n  metrics: SnapshotMetrics\n  // Compact copy of key state for diff\n  stateDigest: {\n    profileHash: string\n    streamIds: string[]\n    entityIds: string[]\n    expenseCount: number\n    deductionCount: number\n  }\n}\n\nexport interface HistoryStore {\n  snapshots: FinancialSnapshot[]\n  lastAutoSnapshot: string | null\n  lastMonthlySnapshot: string | null\n}\n\n// ===================================================================\n//  SNAPSHOT CREATION\n// ===================================================================\n\nfunction hashProfile(state: FortunaState): string {\n  const p = state.profile\n  return `${p.name}|${p.state}|${p.filingStatus}|${p.dependents}|${p.age}`\n}\n\nexport function captureSnapshot(\n  state: FortunaState,\n  trigger: FinancialSnapshot['trigger'],\n  eventDescription?: string,\n): FinancialSnapshot {\n  const taxReport = generateTaxReport(state)\n  const auditRisk = analyzeAuditRisk(state)\n  const health = calculateHealthScore(state)\n\n  const totalExpenses = state.expenses\n    .filter(e => e.isDeductible)\n    .reduce((s, e) => s + (e.annualAmount * e.deductionPct / 100), 0)\n\n  const totalDeductions = state.deductions.reduce((s, d) => s + d.amount, 0)\n\n  const retirementContribs = state.deductions\n    .filter(d => d.category === 'retirement')\n    .reduce((s, d) => s + d.amount, 0)\n\n  const implemented = state.strategies.filter(s => s.status === 'implemented')\n  const estimatedSavings = implemented.reduce((s, st) => s + st.estimatedImpact, 0)\n\n  const metrics: SnapshotMetrics = {\n    totalIncome: taxReport.grossIncome,\n    selfEmploymentIncome: taxReport.selfEmploymentIncome,\n    w2Income: taxReport.w2Income,\n    investmentIncome: taxReport.investmentIncome,\n    incomeStreamCount: state.incomeStreams.filter(s => s.isActive).length,\n    totalExpenses,\n    totalDeductions: totalExpenses + totalDeductions,\n    netIncome: taxReport.grossIncome - taxReport.totalFederalTax - totalExpenses,\n    totalTaxBurden: taxReport.totalFederalTax,\n    effectiveTaxRate: taxReport.effectiveRate,\n    marginalRate: taxReport.marginalRate,\n    selfEmploymentTax: taxReport.selfEmploymentTax,\n    quarterlyEstimated: taxReport.quarterlyEstimated,\n    healthScore: health.overall,\n    auditRiskScore: auditRisk.overallScore,\n    entityCount: state.entities.filter(e => e.isActive).length,\n    activeEntityTypes: [...new Set(state.entities.filter(e => e.isActive).map(e => e.type))],\n    retirementContributions: retirementContribs,\n    strategiesDetected: state.strategies.length,\n    strategiesImplemented: implemented.length,\n    estimatedSavingsTotal: estimatedSavings,\n  }\n\n  return {\n    id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),\n    timestamp: new Date().toISOString(),\n    trigger,\n    eventDescription,\n    metrics,\n    stateDigest: {\n      profileHash: hashProfile(state),\n      streamIds: state.incomeStreams.map(s => s.id).sort(),\n      entityIds: state.entities.map(e => e.id).sort(),\n      expenseCount: state.expenses.length,\n      deductionCount: state.deductions.length,\n    },\n  }\n}\n\n// ===================================================================\n//  AUTO-SNAPSHOT LOGIC\n// ===================================================================\n\n/**\n * Determines if a new auto-snapshot should be taken.\n * Triggers on:\n *  - First time (no history)\n *  - Monthly cadence (at least 30 days since last monthly)\n *  - Significant structural change (streams/entities added/removed)\n */\nexport function shouldAutoSnapshot(\n  state: FortunaState,\n  history: HistoryStore,\n): { should: boolean; trigger: FinancialSnapshot['trigger']; reason?: string } {\n  if (!state.onboardingComplete) return { should: false, trigger: 'auto' }\n\n  // No snapshots yet — take the first one\n  if (history.snapshots.length === 0) {\n    return { should: true, trigger: 'auto', reason: 'Initial snapshot' }\n  }\n\n  const now = new Date()\n  const last = history.snapshots[history.snapshots.length - 1]\n\n  // Monthly cadence\n  if (history.lastMonthlySnapshot) {\n    const lastMonthly = new Date(history.lastMonthlySnapshot)\n    const daysSince = (now.getTime() - lastMonthly.getTime()) / (1000 * 60 * 60 * 24)\n    if (daysSince >= 30) {\n      return { should: true, trigger: 'monthly', reason: `Monthly snapshot (${Math.floor(daysSince)} days since last)` }\n    }\n  } else {\n    // Never done a monthly — do one now\n    return { should: true, trigger: 'monthly', reason: 'First monthly snapshot' }\n  }\n\n  // Structural change detection\n  const currentDigest = {\n    profileHash: hashProfile(state),\n    streamIds: state.incomeStreams.map(s => s.id).sort(),\n    entityIds: state.entities.map(e => e.id).sort(),\n    expenseCount: state.expenses.length,\n    deductionCount: state.deductions.length,\n  }\n\n  const prev = last.stateDigest\n  if (currentDigest.streamIds.join() !== prev.streamIds.join()) {\n    return { should: true, trigger: 'event', reason: 'Income streams changed' }\n  }\n  if (currentDigest.entityIds.join() !== prev.entityIds.join()) {\n    return { should: true, trigger: 'event', reason: 'Entity structure changed' }\n  }\n  if (currentDigest.profileHash !== prev.profileHash) {\n    return { should: true, trigger: 'event', reason: 'Profile updated' }\n  }\n\n  // Significant income change (>10% shift)\n  const currentIncome = state.incomeStreams.filter(s => s.isActive).reduce((s, i) => s + i.annualAmount, 0)\n  if (last.metrics.totalIncome > 0) {\n    const pctChange = Math.abs(currentIncome - last.metrics.totalIncome) / last.metrics.totalIncome\n    if (pctChange > 0.10) {\n      return { should: true, trigger: 'event', reason: `Income shifted ${(pctChange * 100).toFixed(0)}%` }\n    }\n  }\n\n  return { should: false, trigger: 'auto' }\n}\n\n// ===================================================================\n//  TREND ANALYSIS\n// ===================================================================\n\nexport interface TrendPoint {\n  timestamp: string\n  value: number\n  label?: string\n}\n\nexport interface TrendLine {\n  metric: string\n  label: string\n  unit: string\n  points: TrendPoint[]\n  current: number\n  change: number // absolute change from first to last\n  changePct: number // percentage change\n  direction: 'up' | 'down' | 'flat'\n  isPositive: boolean // is the direction good?\n}\n\nexport function computeTrends(history: HistoryStore): TrendLine[] {\n  const snaps = history.snapshots\n  if (snaps.length < 2) return []\n\n  const first = snaps[0].metrics\n  const last = snaps[snaps.length - 1].metrics\n\n  function buildTrend(\n    metric: string,\n    label: string,\n    unit: string,\n    extract: (m: SnapshotMetrics) => number,\n    positiveDirection: 'up' | 'down',\n  ): TrendLine {\n    const points = snaps.map(s => ({\n      timestamp: s.timestamp,\n      value: extract(s.metrics),\n      label: s.eventDescription,\n    }))\n    const current = extract(last)\n    const firstVal = extract(first)\n    const change = current - firstVal\n    const changePct = firstVal !== 0 ? (change / Math.abs(firstVal)) * 100 : 0\n    const direction: 'up' | 'down' | 'flat' = Math.abs(changePct) < 1 ? 'flat' : change > 0 ? 'up' : 'down'\n    const isPositive = direction === 'flat' || direction === positiveDirection\n\n    return { metric, label, unit, points, current, change, changePct, direction, isPositive }\n  }\n\n  return [\n    buildTrend('totalIncome', 'Total Income', '$', m => m.totalIncome, 'up'),\n    buildTrend('netIncome', 'Net Income (After Tax)', '$', m => m.netIncome, 'up'),\n    buildTrend('effectiveTaxRate', 'Effective Tax Rate', '%', m => m.effectiveTaxRate * 100, 'down'),\n    buildTrend('totalTaxBurden', 'Total Tax Burden', '$', m => m.totalTaxBurden, 'down'),\n    buildTrend('healthScore', 'Financial Health', 'pts', m => m.healthScore, 'up'),\n    buildTrend('auditRiskScore', 'Audit Risk', 'pts', m => m.auditRiskScore, 'down'),\n    buildTrend('selfEmploymentTax', 'Self-Employment Tax', '$', m => m.selfEmploymentTax, 'down'),\n    buildTrend('retirementContributions', 'Retirement Contributions', '$', m => m.retirementContributions, 'up'),\n    buildTrend('incomeStreamCount', 'Income Streams', '#', m => m.incomeStreamCount, 'up'),\n    buildTrend('estimatedSavingsTotal', 'Implemented Savings', '$', m => m.estimatedSavingsTotal, 'up'),\n  ]\n}\n\n// ===================================================================\n//  SNAPSHOT DIFFING\n// ===================================================================\n\nexport interface MetricDiff {\n  metric: string\n  label: string\n  before: number\n  after: number\n  change: number\n  changePct: number\n  unit: string\n  isPositive: boolean\n}\n\nexport function diffSnapshots(a: FinancialSnapshot, b: FinancialSnapshot): MetricDiff[] {\n  const defs: { key: keyof SnapshotMetrics; label: string; unit: string; positiveDir: 'up' | 'down' }[] = [\n    { key: 'totalIncome', label: 'Total Income', unit: '$', positiveDir: 'up' },\n    { key: 'netIncome', label: 'Net Income', unit: '$', positiveDir: 'up' },\n    { key: 'totalTaxBurden', label: 'Tax Burden', unit: '$', positiveDir: 'down' },\n    { key: 'effectiveTaxRate', label: 'Effective Rate', unit: '%', positiveDir: 'down' },\n    { key: 'selfEmploymentTax', label: 'SE Tax', unit: '$', positiveDir: 'down' },\n    { key: 'healthScore', label: 'Health Score', unit: 'pts', positiveDir: 'up' },\n    { key: 'auditRiskScore', label: 'Audit Risk', unit: 'pts', positiveDir: 'down' },\n    { key: 'retirementContributions', label: 'Retirement', unit: '$', positiveDir: 'up' },\n    { key: 'incomeStreamCount', label: 'Income Streams', unit: '#', positiveDir: 'up' },\n    { key: 'entityCount', label: 'Entities', unit: '#', positiveDir: 'up' },\n  ]\n\n  return defs.map(d => {\n    const before = a.metrics[d.key] as number\n    const after = b.metrics[d.key] as number\n    const change = after - before\n    const changePct = before !== 0 ? (change / Math.abs(before)) * 100 : 0\n    const dir = change > 0 ? 'up' : change < 0 ? 'down' : 'flat'\n    const isPositive = dir === 'flat' || (dir === 'up' && d.positiveDir === 'up') || (dir === 'down' && d.positiveDir === 'down')\n    // For effectiveTaxRate, scale to %\n    const scaledBefore = d.key === 'effectiveTaxRate' ? before * 100 : before\n    const scaledAfter = d.key === 'effectiveTaxRate' ? after * 100 : after\n    const scaledChange = d.key === 'effectiveTaxRate' ? change * 100 : change\n\n    return {\n      metric: d.key,\n      label: d.label,\n      before: scaledBefore,\n      after: scaledAfter,\n      change: scaledChange,\n      changePct,\n      unit: d.unit,\n      isPositive,\n    }\n  })\n}\n\n// ===================================================================\n//  STRATEGY EFFECTIVENESS\n// ===================================================================\n\nexport interface StrategyEffect {\n  strategyTitle: string\n  implementedDate: string\n  snapshotBefore: FinancialSnapshot | null\n  snapshotAfter: FinancialSnapshot | null\n  taxBurdenChange: number\n  healthScoreChange: number\n  effectiveRateChange: number\n  verdict: 'positive' | 'neutral' | 'negative' | 'insufficient_data'\n  summary: string\n}\n\nexport function analyzeStrategyEffectiveness(\n  state: FortunaState,\n  history: HistoryStore,\n): StrategyEffect[] {\n  const implemented = state.strategies.filter(s => s.status === 'implemented' && s.implementedDate)\n  if (implemented.length === 0 || history.snapshots.length < 2) return []\n\n  return implemented.map(strategy => {\n    const implDate = new Date(strategy.implementedDate!)\n    const snaps = history.snapshots.sort((a, b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime())\n\n    // Find closest snapshot before and after implementation\n    let before: FinancialSnapshot | null = null\n    let after: FinancialSnapshot | null = null\n\n    for (const snap of snaps) {\n      const snapDate = new Date(snap.timestamp)\n      if (snapDate <= implDate) before = snap\n      if (snapDate > implDate && !after) after = snap\n    }\n\n    if (!before || !after) {\n      return {\n        strategyTitle: strategy.title,\n        implementedDate: strategy.implementedDate!,\n        snapshotBefore: before,\n        snapshotAfter: after,\n        taxBurdenChange: 0,\n        healthScoreChange: 0,\n        effectiveRateChange: 0,\n        verdict: 'insufficient_data' as const,\n        summary: 'Not enough snapshot data to measure impact yet. Impact will be measurable after the next snapshot.',\n      }\n    }\n\n    const taxChange = after.metrics.totalTaxBurden - before.metrics.totalTaxBurden\n    const healthChange = after.metrics.healthScore - before.metrics.healthScore\n    const rateChange = (after.metrics.effectiveTaxRate - before.metrics.effectiveTaxRate) * 100\n\n    let verdict: StrategyEffect['verdict'] = 'neutral'\n    if (taxChange < -500 || healthChange > 5) verdict = 'positive'\n    else if (taxChange > 500 || healthChange < -5) verdict = 'negative'\n\n    const summary = verdict === 'positive'\n      ? `Reduced tax burden by $${Math.abs(taxChange).toLocaleString()} and improved health score by ${healthChange.toFixed(0)} points.`\n      : verdict === 'negative'\n        ? `Tax burden increased $${Math.abs(taxChange).toLocaleString()} since implementation. May need review.`\n        : `Minimal measurable change so far. May need more time to show impact.`\n\n    return {\n      strategyTitle: strategy.title,\n      implementedDate: strategy.implementedDate!,\n      snapshotBefore: before,\n      snapshotAfter: after,\n      taxBurdenChange: taxChange,\n      healthScoreChange: healthChange,\n      effectiveRateChange: rateChange,\n      verdict,\n      summary,\n    }\n  })\n}\n\n// ===================================================================\n//  TRAJECTORY PROJECTION\n// ===================================================================\n\nexport interface Projection {\n  metric: string\n  label: string\n  current: number\n  projected3Month: number\n  projected6Month: number\n  projected12Month: number\n  confidence: 'high' | 'medium' | 'low'\n  unit: string\n}\n\nexport function projectTrajectory(history: HistoryStore): Projection[] {\n  const snaps = history.snapshots\n  if (snaps.length < 3) return [] // Need 3+ points for meaningful projection\n\n  // Simple linear regression on recent snapshots\n  function linearProject(extract: (m: SnapshotMetrics) => number): { slope: number; current: number } {\n    const points = snaps.map((s, i) => ({\n      x: i,\n      y: extract(s.metrics),\n    }))\n    const n = points.length\n    const sumX = points.reduce((s, p) => s + p.x, 0)\n    const sumY = points.reduce((s, p) => s + p.y, 0)\n    const sumXY = points.reduce((s, p) => s + p.x * p.y, 0)\n    const sumX2 = points.reduce((s, p) => s + p.x * p.x, 0)\n    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX)\n    const current = points[points.length - 1].y\n    return { slope: isFinite(slope) ? slope : 0, current }\n  }\n\n  // Estimate intervals per month (based on snapshot cadence)\n  const firstTime = new Date(snaps[0].timestamp).getTime()\n  const lastTime = new Date(snaps[snaps.length - 1].timestamp).getTime()\n  const totalMonths = Math.max(1, (lastTime - firstTime) / (1000 * 60 * 60 * 24 * 30))\n  const intervalsPerMonth = (snaps.length - 1) / totalMonths\n\n  const confidence: Projection['confidence'] = snaps.length >= 6 ? 'high' : snaps.length >= 4 ? 'medium' : 'low'\n\n  function buildProjection(\n    metric: string,\n    label: string,\n    unit: string,\n    extract: (m: SnapshotMetrics) => number,\n    scale: number = 1,\n  ): Projection {\n    const { slope, current } = linearProject(extract)\n    const monthlyDelta = slope * intervalsPerMonth * scale\n    return {\n      metric, label, unit, current: current * scale, confidence,\n      projected3Month: Math.max(0, (current * scale) + monthlyDelta * 3),\n      projected6Month: Math.max(0, (current * scale) + monthlyDelta * 6),\n      projected12Month: Math.max(0, (current * scale) + monthlyDelta * 12),\n    }\n  }\n\n  return [\n    buildProjection('totalIncome', 'Total Income', '$', m => m.totalIncome),\n    buildProjection('effectiveTaxRate', 'Effective Tax Rate', '%', m => m.effectiveTaxRate, 100),\n    buildProjection('healthScore', 'Health Score', 'pts', m => m.healthScore),\n    buildProjection('totalTaxBurden', 'Tax Burden', '$', m => m.totalTaxBurden),\n    buildProjection('netIncome', 'Net Income', '$', m => m.netIncome),\n  ]\n}\n\n// ===================================================================\n//  MILESTONES & EVENTS\n// ===================================================================\n\nexport interface Milestone {\n  timestamp: string\n  type: 'snapshot' | 'strategy' | 'entity' | 'income' | 'achievement'\n  title: string\n  description: string\n  icon: string\n  color: string\n}\n\nexport function buildTimeline(state: FortunaState, history: HistoryStore): Milestone[] {\n  const milestones: Milestone[] = []\n\n  // Snapshot milestones\n  history.snapshots.forEach(snap => {\n    milestones.push({\n      timestamp: snap.timestamp,\n      type: 'snapshot',\n      title: snap.trigger === 'monthly' ? 'Monthly Snapshot' : snap.trigger === 'event' ? 'Event Snapshot' : 'Auto Snapshot',\n      description: snap.eventDescription || `Health: ${snap.metrics.healthScore} | Income: $${snap.metrics.totalIncome.toLocaleString()} | Tax: $${snap.metrics.totalTaxBurden.toLocaleString()}`,\n      icon: '📊',\n      color: 'var(--accent-blue)',\n    })\n  })\n\n  // Strategy milestones\n  state.strategies.filter(s => s.implementedDate).forEach(strategy => {\n    milestones.push({\n      timestamp: strategy.implementedDate!,\n      type: 'strategy',\n      title: `Strategy Implemented: ${strategy.title}`,\n      description: `Est. impact: $${strategy.estimatedImpact.toLocaleString()}/yr`,\n      icon: '⚡',\n      color: 'var(--accent-gold)',\n    })\n  })\n\n  // Entity milestones\n  state.entities.filter(e => e.formationDate).forEach(entity => {\n    milestones.push({\n      timestamp: entity.formationDate!,\n      type: 'entity',\n      title: `Entity Formed: ${entity.name}`,\n      description: `${entity.type.toUpperCase()} in ${entity.state}`,\n      icon: '🏛',\n      color: 'var(--accent-purple)',\n    })\n  })\n\n  // Achievement milestones (from snapshots)\n  if (history.snapshots.length >= 2) {\n    const first = history.snapshots[0]\n    const last = history.snapshots[history.snapshots.length - 1]\n    if (last.metrics.healthScore >= 80 && first.metrics.healthScore < 80) {\n      milestones.push({\n        timestamp: last.timestamp,\n        type: 'achievement',\n        title: 'Achievement: Health Score A-',\n        description: 'Financial health score reached 80+',\n        icon: '🏆',\n        color: 'var(--accent-emerald)',\n      })\n    }\n    if (last.metrics.effectiveTaxRate < first.metrics.effectiveTaxRate * 0.9) {\n      milestones.push({\n        timestamp: last.timestamp,\n        type: 'achievement',\n        title: 'Achievement: Tax Rate Reduced 10%+',\n        description: `Effective rate dropped from ${(first.metrics.effectiveTaxRate * 100).toFixed(1)}% to ${(last.metrics.effectiveTaxRate * 100).toFixed(1)}%`,\n        icon: '🎯',\n        color: 'var(--accent-emerald)',\n      })\n    }\n  }\n\n  return milestones.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime())\n}\n\n// ===================================================================\n//  HISTORY MANAGEMENT\n// ===================================================================\n\nexport function createEmptyHistory(): HistoryStore {\n  return {\n    snapshots: [],\n    lastAutoSnapshot: null,\n    lastMonthlySnapshot: null,\n  }\n}\n\nexport function addSnapshot(history: HistoryStore, snapshot: FinancialSnapshot): HistoryStore {\n  const updated = {\n    ...history,\n    snapshots: [...history.snapshots, snapshot],\n    lastAutoSnapshot: snapshot.timestamp,\n  }\n  if (snapshot.trigger === 'monthly') {\n    updated.lastMonthlySnapshot = snapshot.timestamp\n  }\n  // Keep max 120 snapshots (~10 years monthly)\n  if (updated.snapshots.length > 120) {\n    updated.snapshots = updated.snapshots.slice(-120)\n  }\n  return updated\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\import-wiring.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\income-forecast.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'currentYear' is never reassigned. Use 'const' instead.","line":142,"column":7,"nodeType":"Identifier","messageId":"useConst","endLine":142,"endColumn":18,"fix":{"range":[4931,4966],"text":"const currentYear = now.getFullYear()"}},{"ruleId":"prefer-const","severity":2,"message":"'currentMonth' is never reassigned. Use 'const' instead.","line":143,"column":7,"nodeType":"Identifier","messageId":"useConst","endLine":143,"endColumn":19,"fix":{"range":[4969,4998],"text":"const currentMonth = startMonth"}}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":2,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE — Income Forecasting Engine v1\n * \n * Predictive modeling for self-employed income:\n *   - Historical pattern analysis from bank transactions\n *   - Seasonal adjustment detection\n *   - Growth trend calculation (linear + exponential)\n *   - Quarterly estimated tax projection\n *   - Cash reserve recommendations\n *   - Scenario planning (best/expected/worst)\n *   - Safe harbor payment calculator\n *   - Year-end tax position forecast\n */\n\nexport interface ForecastResult {\n  period: string              // \"2025-Q3\", \"2025\", etc.\n  projectedIncome: number\n  projectedExpenses: number\n  projectedNetIncome: number\n  estimatedTaxLiability: number\n  estimatedPaymentNeeded: number\n  confidence: 'high' | 'medium' | 'low'\n  scenarios: {\n    optimistic: { income: number; tax: number }\n    expected: { income: number; tax: number }\n    conservative: { income: number; tax: number }\n  }\n}\n\nexport interface IncomePattern {\n  monthlyAverages: number[]     // index 0 = Jan\n  seasonalFactors: number[]     // 1.0 = average, 1.2 = 20% above average\n  growthRate: number            // annual growth rate\n  volatility: number            // standard deviation as % of mean\n  trend: 'growing' | 'stable' | 'declining'\n  peakMonths: number[]          // best months (0-indexed)\n  troughMonths: number[]        // worst months\n}\n\nexport interface SafeHarborCalc {\n  priorYearTax: number\n  currentYearEstimate: number\n  method: '100_prior' | '110_prior' | '90_current'  // which safe harbor to use\n  quarterlyPayment: number\n  totalRequired: number\n  alreadyPaid: number\n  remaining: number\n  nextPaymentDate: string\n  nextPaymentAmount: number\n  onTrack: boolean\n}\n\nexport interface CashReserve {\n  monthsOfExpenses: number\n  recommendedReserve: number\n  currentReserve: number\n  taxReserve: number            // set aside for quarterly payments\n  emergencyReserve: number\n  totalRecommended: number\n  gap: number\n}\n\n// ─── Pattern Analysis ───────────────────────────────────────────────────────\n\nexport function analyzeIncomePattern(\n  monthlyIncome: { month: string; amount: number }[],  // \"2024-01\", etc.\n): IncomePattern {\n  if (monthlyIncome.length < 3) {\n    return {\n      monthlyAverages: Array(12).fill(0),\n      seasonalFactors: Array(12).fill(1),\n      growthRate: 0,\n      volatility: 0,\n      trend: 'stable',\n      peakMonths: [],\n      troughMonths: [],\n    }\n  }\n\n  // Group by month-of-year\n  const byMonth: Record<number, number[]> = {}\n  for (let m = 0; m < 12; m++) byMonth[m] = []\n\n  for (const entry of monthlyIncome) {\n    const monthIdx = parseInt(entry.month.split('-')[1]) - 1\n    byMonth[monthIdx].push(entry.amount)\n  }\n\n  // Monthly averages\n  const monthlyAverages = Array(12).fill(0).map((_, m) =>\n    byMonth[m].length > 0 ? byMonth[m].reduce((s, n) => s + n, 0) / byMonth[m].length : 0\n  )\n\n  const overallAvg = monthlyAverages.reduce((s, n) => s + n, 0) / Math.max(1, monthlyAverages.filter(n => n > 0).length)\n\n  // Seasonal factors\n  const seasonalFactors = monthlyAverages.map(avg =>\n    overallAvg > 0 ? Math.round((avg / overallAvg) * 100) / 100 : 1\n  )\n\n  // Growth rate (compare first half to second half of data)\n  const sorted = [...monthlyIncome].sort((a, b) => a.month.localeCompare(b.month))\n  const half = Math.floor(sorted.length / 2)\n  const firstHalfAvg = sorted.slice(0, half).reduce((s, e) => s + e.amount, 0) / Math.max(1, half)\n  const secondHalfAvg = sorted.slice(half).reduce((s, e) => s + e.amount, 0) / Math.max(1, sorted.length - half)\n  const monthsSpan = sorted.length\n  const growthRate = firstHalfAvg > 0\n    ? Math.pow(secondHalfAvg / firstHalfAvg, 12 / Math.max(1, monthsSpan)) - 1\n    : 0\n\n  // Volatility\n  const amounts = monthlyIncome.map(e => e.amount)\n  const mean = amounts.reduce((s, n) => s + n, 0) / amounts.length\n  const variance = amounts.reduce((s, n) => s + Math.pow(n - mean, 2), 0) / amounts.length\n  const volatility = mean > 0 ? Math.sqrt(variance) / mean : 0\n\n  // Trend\n  const trend: IncomePattern['trend'] = growthRate > 0.05 ? 'growing' : growthRate < -0.05 ? 'declining' : 'stable'\n\n  // Peak/trough months\n  const avgForRanking = monthlyAverages.map((avg, i) => ({ month: i, avg })).filter(m => m.avg > 0)\n  avgForRanking.sort((a, b) => b.avg - a.avg)\n  const peakMonths = avgForRanking.slice(0, 3).map(m => m.month)\n  const troughMonths = avgForRanking.slice(-3).map(m => m.month)\n\n  return { monthlyAverages, seasonalFactors, growthRate, volatility, trend, peakMonths, troughMonths }\n}\n\n// ─── Forecasting ────────────────────────────────────────────────────────────\n\nexport function forecastIncome(\n  pattern: IncomePattern,\n  baselineAnnualIncome: number,\n  baselineAnnualExpenses: number,\n  forecastMonths: number = 12,\n  startMonth: number = new Date().getMonth(),  // 0-indexed\n  marginalRate: number = 0.32,\n  seRate: number = 0.153,\n): ForecastResult[] {\n  const results: ForecastResult[] = []\n  const now = new Date()\n  let currentYear = now.getFullYear()\n  let currentMonth = startMonth\n\n  // Generate monthly forecasts\n  const monthlyForecasts: { month: string; income: number; expenses: number }[] = []\n  const monthlyBase = baselineAnnualIncome / 12\n  const monthlyExpBase = baselineAnnualExpenses / 12\n\n  for (let i = 0; i < forecastMonths; i++) {\n    const monthIdx = (currentMonth + i) % 12\n    const yearOffset = Math.floor((currentMonth + i) / 12)\n    const year = currentYear + yearOffset\n    const monthStr = `${year}-${String(monthIdx + 1).padStart(2, '0')}`\n\n    const growthFactor = Math.pow(1 + pattern.growthRate, (i + 1) / 12)\n    const seasonalFactor = pattern.seasonalFactors[monthIdx] || 1\n    const projected = monthlyBase * growthFactor * seasonalFactor\n\n    monthlyForecasts.push({\n      month: monthStr,\n      income: Math.round(projected),\n      expenses: Math.round(monthlyExpBase * growthFactor * 0.9), // expenses grow slower\n    })\n  }\n\n  // Aggregate into quarterly forecasts\n  let qIncome = 0, qExpenses = 0, qMonths = 0\n  let qStart = ''\n\n  for (let i = 0; i < monthlyForecasts.length; i++) {\n    const mf = monthlyForecasts[i]\n    if (qMonths === 0) qStart = mf.month\n\n    qIncome += mf.income\n    qExpenses += mf.expenses\n    qMonths++\n\n    if (qMonths === 3 || i === monthlyForecasts.length - 1) {\n      const year = qStart.split('-')[0]\n      const startMo = parseInt(qStart.split('-')[1])\n      const quarter = Math.ceil(startMo / 3)\n      const period = `${year}-Q${quarter}`\n\n      const netIncome = qIncome - qExpenses\n      const taxLiability = Math.round(netIncome * (marginalRate + seRate * 0.5))\n      const paymentNeeded = Math.round(taxLiability)\n\n      const volatilityFactor = pattern.volatility\n\n      results.push({\n        period,\n        projectedIncome: Math.round(qIncome),\n        projectedExpenses: Math.round(qExpenses),\n        projectedNetIncome: Math.round(netIncome),\n        estimatedTaxLiability: Math.max(0, taxLiability),\n        estimatedPaymentNeeded: Math.max(0, paymentNeeded),\n        confidence: volatilityFactor < 0.2 ? 'high' : volatilityFactor < 0.4 ? 'medium' : 'low',\n        scenarios: {\n          optimistic: {\n            income: Math.round(qIncome * (1 + volatilityFactor * 0.5)),\n            tax: Math.round(qIncome * (1 + volatilityFactor * 0.5) * (marginalRate + seRate * 0.5)),\n          },\n          expected: {\n            income: Math.round(qIncome),\n            tax: Math.max(0, taxLiability),\n          },\n          conservative: {\n            income: Math.round(qIncome * (1 - volatilityFactor * 0.5)),\n            tax: Math.round(Math.max(0, qIncome * (1 - volatilityFactor * 0.5)) * (marginalRate + seRate * 0.5)),\n          },\n        },\n      })\n\n      qIncome = 0\n      qExpenses = 0\n      qMonths = 0\n    }\n  }\n\n  return results\n}\n\n// ─── Safe Harbor Calculator ─────────────────────────────────────────────────\n\nexport function calculateSafeHarbor(params: {\n  priorYearTax: number\n  priorYearAGI: number\n  currentYearEstimatedTax: number\n  alreadyPaid: number\n  currentQuarter: number         // 1-4\n}): SafeHarborCalc {\n  const { priorYearTax, priorYearAGI, currentYearEstimatedTax, alreadyPaid, currentQuarter } = params\n\n  // Three safe harbor methods:\n  // 1. Pay 100% of prior year tax (110% if AGI > $150K)\n  // 2. Pay 90% of current year tax\n  const priorYearFactor = priorYearAGI > 150000 ? 1.10 : 1.00\n  const method100 = priorYearTax * priorYearFactor\n  const method90 = currentYearEstimatedTax * 0.90\n\n  // Use whichever is lower (more favorable to taxpayer)\n  const useMethod = method100 < method90 ? (priorYearFactor > 1 ? '110_prior' : '100_prior') : '90_current'\n  const totalRequired = Math.min(method100, method90)\n  const quarterlyPayment = Math.round(totalRequired / 4)\n\n  // Payment schedule\n  const year = new Date().getFullYear()\n  const deadlines = [\n    `${year}-04-15`, `${year}-06-16`, `${year}-09-15`, `${year + 1}-01-15`,\n  ]\n\n  const requiredByNow = quarterlyPayment * currentQuarter\n  const remaining = Math.max(0, totalRequired - alreadyPaid)\n  const onTrack = alreadyPaid >= requiredByNow * 0.95\n\n  const nextQ = Math.min(currentQuarter, 3) // 0-indexed for deadlines\n  const nextPaymentDate = deadlines[nextQ] || deadlines[3]\n  const nextPaymentAmount = Math.round(remaining / Math.max(1, 4 - currentQuarter + 1))\n\n  return {\n    priorYearTax,\n    currentYearEstimate: currentYearEstimatedTax,\n    method: useMethod,\n    quarterlyPayment,\n    totalRequired: Math.round(totalRequired),\n    alreadyPaid,\n    remaining: Math.round(remaining),\n    nextPaymentDate,\n    nextPaymentAmount,\n    onTrack,\n  }\n}\n\n// ─── Cash Reserve Calculator ────────────────────────────────────────────────\n\nexport function calculateCashReserve(params: {\n  monthlyExpenses: number\n  annualTaxLiability: number\n  currentCash: number\n  irregularIncome: boolean\n}): CashReserve {\n  const { monthlyExpenses, annualTaxLiability, currentCash, irregularIncome } = params\n\n  // Self-employed need more reserves than W-2\n  const monthsRecommended = irregularIncome ? 6 : 4\n  const emergencyReserve = monthlyExpenses * monthsRecommended\n  const taxReserve = annualTaxLiability * 0.3 // keep 30% of annual tax as buffer\n  const totalRecommended = emergencyReserve + taxReserve\n\n  return {\n    monthsOfExpenses: currentCash > 0 ? Math.round((currentCash / monthlyExpenses) * 10) / 10 : 0,\n    recommendedReserve: Math.round(emergencyReserve),\n    currentReserve: Math.round(currentCash),\n    taxReserve: Math.round(taxReserve),\n    emergencyReserve: Math.round(emergencyReserve),\n    totalRecommended: Math.round(totalRecommended),\n    gap: Math.round(Math.max(0, totalRecommended - currentCash)),\n  }\n}\n\n// ─── Year-End Tax Position Forecast ─────────────────────────────────────────\n\nexport function forecastYearEnd(params: {\n  ytdIncome: number\n  ytdExpenses: number\n  ytdTaxPaid: number           // estimated payments + withholding\n  monthsRemaining: number\n  pattern: IncomePattern\n  filingStatus: 'single' | 'mfj'\n  stateCode: string\n  retirementContributions: number\n}): {\n  projectedAnnualIncome: number\n  projectedAnnualTax: number\n  projectedRefundOrOwed: number\n  recommendation: string\n  actions: string[]\n} {\n  const { ytdIncome, ytdExpenses, ytdTaxPaid, monthsRemaining, pattern, retirementContributions } = params\n\n  // Project remaining months\n  const monthlyAvgIncome = ytdIncome / Math.max(1, 12 - monthsRemaining)\n  let remainingIncome = 0\n  const currentMonth = 12 - monthsRemaining\n\n  for (let m = currentMonth; m < 12; m++) {\n    const seasonal = pattern.seasonalFactors[m] || 1\n    remainingIncome += monthlyAvgIncome * seasonal\n  }\n\n  const projectedAnnual = ytdIncome + remainingIncome\n  const projectedExpenses = ytdExpenses * (12 / Math.max(1, 12 - monthsRemaining))\n  const projectedNet = projectedAnnual - projectedExpenses - retirementContributions\n\n  // Rough tax estimate\n  const seTax = projectedNet * 0.9235 * 0.153\n  const taxableIncome = Math.max(0, projectedNet - seTax / 2 - 15000)\n\n  let fedTax = 0\n  const brackets: [number, number][] = [\n    [11925, 0.10], [48475, 0.12], [103350, 0.22], [197300, 0.24],\n    [250525, 0.32], [626350, 0.35], [Infinity, 0.37],\n  ]\n  let rem = taxableIncome, prev = 0\n  for (const [max, rate] of brackets) {\n    const t = Math.min(rem, max - prev)\n    if (t <= 0) break\n    fedTax += t * rate\n    rem -= t\n    prev = max\n  }\n\n  const projectedTax = Math.round(fedTax + seTax)\n  const refundOrOwed = ytdTaxPaid - projectedTax\n\n  const actions: string[] = []\n  let recommendation = ''\n\n  if (refundOrOwed < -5000) {\n    recommendation = `You may owe approximately $${Math.abs(Math.round(refundOrOwed)).toLocaleString()} at year-end. Increase estimated payments.`\n    actions.push(`Increase Q${Math.ceil((12 - monthsRemaining + 1) / 3)} estimated payment`)\n    if (retirementContributions < 69000) actions.push('Maximize retirement contributions to reduce taxable income')\n  } else if (refundOrOwed > 5000) {\n    recommendation = `You're overpaying — projected refund of $${Math.round(refundOrOwed).toLocaleString()}. Consider reducing estimated payments and investing the difference.`\n    actions.push('Consider reducing next estimated payment')\n    actions.push('Review if Roth conversion makes sense to use up low brackets')\n  } else {\n    recommendation = 'On track — estimated payments are well-aligned with projected liability.'\n  }\n\n  if (monthsRemaining <= 3) {\n    actions.push('Review tax-loss harvesting opportunities before Dec 31')\n    actions.push('Confirm Solo 401(k) employee deferrals by Dec 31')\n    actions.push('Consider year-end equipment purchases for §179 deduction')\n  }\n\n  return {\n    projectedAnnualIncome: Math.round(projectedAnnual),\n    projectedAnnualTax: projectedTax,\n    projectedRefundOrOwed: Math.round(refundOrOwed),\n    recommendation,\n    actions,\n  }\n}\n\n// ─── Phase H: Entity-Aware Income Forecast ─────────────────────────────────\n\nimport type { IncomeStream, EstimatedPayment } from './storage'\n\nexport interface EntityForecast {\n  entityId: string\n  entityName: string\n  projectedIncome: number\n  projectedExpenses: number\n  projectedNetIncome: number\n  growthTrend: 'growing' | 'stable' | 'declining'\n}\n\nexport function forecastByEntity(\n  incomeStreams: IncomeStream[],\n  expenses: { entityId?: string; annualAmount: number; isDeductible: boolean; deductionPct: number }[],\n  entities: { id: string; name: string }[],\n): EntityForecast[] {\n  const entityIds = new Set<string>()\n  incomeStreams.filter(s => s.isActive).forEach(s => entityIds.add(s.entityId || 'personal'))\n  expenses.forEach(e => entityIds.add(e.entityId || 'personal'))\n\n  return [...entityIds].map(eid => {\n    const entityIncome = incomeStreams\n      .filter(s => s.isActive && (s.entityId || 'personal') === eid)\n      .reduce((s, i) => s + i.annualAmount, 0)\n    const entityExpenses = expenses\n      .filter(e => (e.entityId || 'personal') === eid && e.isDeductible)\n      .reduce((s, e) => s + e.annualAmount * e.deductionPct / 100, 0)\n    const entity = entities.find(e => e.id === eid)\n\n    return {\n      entityId: eid,\n      entityName: entity?.name || (eid === 'personal' ? 'Personal' : eid),\n      projectedIncome: entityIncome,\n      projectedExpenses: entityExpenses,\n      projectedNetIncome: entityIncome - entityExpenses,\n      growthTrend: 'stable' as const, // could enhance with historical data\n    }\n  })\n}\n\n// ─── Phase G: Income Forecast → Estimated Payment Generation ────────────────\n\nexport interface ComputedEstimatedPayments {\n  year: number\n  annualLiability: number\n  safeHarborAmount: number\n  quarterlyAmount: number\n  payments: EstimatedPayment[]\n}\n\nexport function computeEstimatedPayments(\n  projectedAnnualIncome: number,\n  projectedAnnualTax: number,\n  withholdingTotal: number,\n  priorYearTax: number,\n  taxYear: number = new Date().getFullYear(),\n): ComputedEstimatedPayments {\n  // Safe harbor: lesser of 100% of prior year tax or 90% of current year\n  // (110% of prior year if AGI > $150k)\n  const safeHarborPrior = projectedAnnualIncome > 150000\n    ? Math.round(priorYearTax * 1.10)\n    : priorYearTax\n  const safeHarbor90 = Math.round(projectedAnnualTax * 0.90)\n  const safeHarborAmount = Math.min(safeHarborPrior, safeHarbor90)\n\n  const remainingLiability = Math.max(0, safeHarborAmount - withholdingTotal)\n  const quarterlyAmount = Math.round(remainingLiability / 4)\n\n  const quarters = [\n    { quarter: 1, dueDate: `${taxYear}-04-15` },\n    { quarter: 2, dueDate: `${taxYear}-06-15` },\n    { quarter: 3, dueDate: `${taxYear}-09-15` },\n    { quarter: 4, dueDate: `${taxYear + 1}-01-15` },\n  ]\n\n  const payments: EstimatedPayment[] = quarters.map(q => ({\n    id: `est-${taxYear}-q${q.quarter}`,\n    taxYear,\n    quarter: q.quarter as 1 | 2 | 3 | 4,\n    dueDate: q.dueDate,\n    amount: quarterlyAmount,\n    paidAmount: 0,\n    paidDate: undefined,\n    jurisdiction: 'federal' as const,\n    entityId: 'personal',\n    memberId: 'primary',\n    tags: ['auto-computed'],\n  }))\n\n  return {\n    year: taxYear,\n    annualLiability: projectedAnnualTax,\n    safeHarborAmount,\n    quarterlyAmount,\n    payments,\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\input-validation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\integration.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\live-prices.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":94,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":94,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3569,3572],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3569,3572],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE — Live Price Feed v1\n * \n * Real-time price lookups for portfolio positions:\n *   - CoinGecko API (free tier) for crypto/DeFi tokens\n *   - Ticker-to-CoinGecko-ID mapping for common assets\n *   - Batch price fetching (reduces API calls)\n *   - Cache layer (5-min TTL) to respect rate limits\n *   - Fallback estimates for unknown/illiquid tokens\n */\n\n// ─── Types ──────────────────────────────────────────────────────────────────\n\nexport interface PriceData {\n  ticker: string\n  priceUSD: number\n  change24h: number | null\n  change7d: number | null\n  marketCap: number | null\n  volume24h: number | null\n  lastUpdated: string\n  source: 'coingecko' | 'cache' | 'manual' | 'unknown'\n}\n\nexport interface PriceFeedResult {\n  prices: Record<string, PriceData>\n  errors: string[]\n  fromCache: number\n  fromAPI: number\n  timestamp: string\n}\n\n// ─── Ticker → CoinGecko ID Map ─────────────────────────────────────────────\n\nconst TICKER_TO_COINGECKO: Record<string, string> = {\n  BTC: 'bitcoin', ETH: 'ethereum', SOL: 'solana', ADA: 'cardano',\n  DOT: 'polkadot', AVAX: 'avalanche-2', MATIC: 'matic-network',\n  LINK: 'chainlink', XRP: 'ripple', BNB: 'binancecoin',\n  DOGE: 'dogecoin', SHIB: 'shiba-inu', LTC: 'litecoin',\n  UNI: 'uniswap', AAVE: 'aave', ATOM: 'cosmos',\n  NEAR: 'near', FTM: 'fantom', ALGO: 'algorand',\n  XLM: 'stellar', VET: 'vechain', HBAR: 'hedera-hashgraph',\n  ICP: 'internet-computer', FIL: 'filecoin', GRT: 'the-graph',\n  SAND: 'the-sandbox', MANA: 'decentraland', APE: 'apecoin',\n  CRV: 'curve-dao-token', MKR: 'maker', SNX: 'havven',\n  COMP: 'compound-governance-token', SUSHI: 'sushi',\n  YFI: 'yearn-finance', BAL: 'balancer',\n  REN: 'republic-protocol', CAKE: 'pancakeswap-token',\n  USDT: 'tether', USDC: 'usd-coin', DAI: 'dai',\n  BUSD: 'binance-usd', FRAX: 'frax',\n  OP: 'optimism', ARB: 'arbitrum', SUI: 'sui',\n  SEI: 'sei-network', TIA: 'celestia', INJ: 'injective-protocol',\n  DYDX: 'dydx-chain', GMX: 'gmx', PENDLE: 'pendle',\n  WLD: 'worldcoin-wld', RNDR: 'render-token', FET: 'fetch-ai',\n  TAO: 'bittensor', BONK: 'bonk', WIF: 'dogwifcoin',\n  PEPE: 'pepe', FLOKI: 'floki',\n  STX: 'blockstack', RUNE: 'thorchain', OSMO: 'osmosis',\n  PYTH: 'pyth-network', JUP: 'jupiter-exchange-solana',\n  TRX: 'tron', TON: 'the-open-network', KAS: 'kaspa',\n  APT: 'aptos', EGLD: 'elrond-erd-2',\n  // DePIN / Travis-relevant\n  HNT: 'helium', MOBILE: 'helium-mobile', IOT: 'helium-iot',\n  IOTX: 'iotex', DIMO: 'dimo', HONEY: 'hivemapper',\n  RENDER: 'render-token', AKT: 'akash-network',\n  AR: 'arweave', GRASS: 'grass',\n}\n\n// ─── Cache ──────────────────────────────────────────────────────────────────\n\nconst CACHE_TTL = 5 * 60 * 1000 // 5 minutes\nconst priceCache = new Map<string, { data: PriceData; expires: number }>()\n\nfunction getCached(ticker: string): PriceData | null {\n  const entry = priceCache.get(ticker.toUpperCase())\n  if (entry && Date.now() < entry.expires) return { ...entry.data, source: 'cache' }\n  return null\n}\n\nfunction setCache(ticker: string, data: PriceData) {\n  priceCache.set(ticker.toUpperCase(), { data, expires: Date.now() + CACHE_TTL })\n}\n\nexport function clearPriceCache() {\n  priceCache.clear()\n}\n\n// ─── CoinGecko Fetch ────────────────────────────────────────────────────────\n\nasync function fetchCoinGeckoPrices(coinIds: string[]): Promise<Record<string, { usd: number; usd_24h_change?: number; usd_market_cap?: number; usd_24h_vol?: number }>> {\n  if (coinIds.length === 0) return {}\n  \n  // CoinGecko free API: max ~250 IDs per call, 10-30 calls/min\n  const batchSize = 100\n  const results: Record<string, any> = {}\n  \n  for (let i = 0; i < coinIds.length; i += batchSize) {\n    const batch = coinIds.slice(i, i + batchSize)\n    const idsParam = batch.join(',')\n    \n    try {\n      const url = `https://api.coingecko.com/api/v3/simple/price?ids=${idsParam}&vs_currencies=usd&include_24hr_change=true&include_market_cap=true&include_24hr_vol=true`\n      const response = await fetch(url)\n      \n      if (response.status === 429) {\n        // Rate limited — wait and retry once\n        await new Promise(r => setTimeout(r, 2000))\n        const retry = await fetch(url)\n        if (retry.ok) {\n          const data = await retry.json()\n          Object.assign(results, data)\n        }\n      } else if (response.ok) {\n        const data = await response.json()\n        Object.assign(results, data)\n      }\n    } catch (err) {\n      console.warn(`CoinGecko fetch error for batch ${i}:`, err)\n    }\n    \n    // Rate limit spacing\n    if (i + batchSize < coinIds.length) {\n      await new Promise(r => setTimeout(r, 1500))\n    }\n  }\n  \n  return results\n}\n\n// ─── Main Price Fetch ───────────────────────────────────────────────────────\n\nexport async function fetchPrices(tickers: string[]): Promise<PriceFeedResult> {\n  const uniqueTickers = [...new Set(tickers.map(t => t.toUpperCase()))]\n  const prices: Record<string, PriceData> = {}\n  const errors: string[] = []\n  let fromCache = 0\n  let fromAPI = 0\n  \n  // Step 1: Check cache\n  const needsFetch: string[] = []\n  for (const ticker of uniqueTickers) {\n    const cached = getCached(ticker)\n    if (cached) {\n      prices[ticker] = cached\n      fromCache++\n    } else {\n      needsFetch.push(ticker)\n    }\n  }\n  \n  if (needsFetch.length === 0) {\n    return { prices, errors, fromCache, fromAPI, timestamp: new Date().toISOString() }\n  }\n  \n  // Step 2: Map tickers to CoinGecko IDs\n  const tickerToId: Record<string, string> = {}\n  const idToTicker: Record<string, string> = {}\n  const unknownTickers: string[] = []\n  \n  for (const ticker of needsFetch) {\n    const geckoId = TICKER_TO_COINGECKO[ticker]\n    if (geckoId) {\n      tickerToId[ticker] = geckoId\n      idToTicker[geckoId] = ticker\n    } else {\n      unknownTickers.push(ticker)\n    }\n  }\n  \n  // Step 3: Fetch from CoinGecko\n  const geckoIds = Object.values(tickerToId)\n  if (geckoIds.length > 0) {\n    try {\n      const geckoData = await fetchCoinGeckoPrices(geckoIds)\n      \n      for (const [geckoId, data] of Object.entries(geckoData)) {\n        const ticker = idToTicker[geckoId]\n        if (ticker && data.usd) {\n          const priceData: PriceData = {\n            ticker,\n            priceUSD: data.usd,\n            change24h: data.usd_24h_change ?? null,\n            change7d: null,\n            marketCap: data.usd_market_cap ?? null,\n            volume24h: data.usd_24h_vol ?? null,\n            lastUpdated: new Date().toISOString(),\n            source: 'coingecko',\n          }\n          prices[ticker] = priceData\n          setCache(ticker, priceData)\n          fromAPI++\n        }\n      }\n    } catch (err) {\n      errors.push(`CoinGecko API error: ${err instanceof Error ? err.message : String(err)}`)\n    }\n  }\n  \n  // Step 4: Handle unknown tickers\n  for (const ticker of unknownTickers) {\n    // Try CoinGecko search as fallback\n    try {\n      const searchUrl = `https://api.coingecko.com/api/v3/search?query=${ticker.toLowerCase()}`\n      const searchResp = await fetch(searchUrl)\n      if (searchResp.ok) {\n        const searchData = await searchResp.json()\n        const coin = searchData.coins?.[0]\n        if (coin) {\n          // Cache the mapping for next time\n          TICKER_TO_COINGECKO[ticker] = coin.id\n          const priceResp = await fetchCoinGeckoPrices([coin.id])\n          const data = priceResp[coin.id]\n          if (data?.usd) {\n            const priceData: PriceData = {\n              ticker,\n              priceUSD: data.usd,\n              change24h: data.usd_24h_change ?? null,\n              change7d: null,\n              marketCap: data.usd_market_cap ?? null,\n              volume24h: data.usd_24h_vol ?? null,\n              lastUpdated: new Date().toISOString(),\n              source: 'coingecko',\n            }\n            prices[ticker] = priceData\n            setCache(ticker, priceData)\n            fromAPI++\n            continue\n          }\n        }\n      }\n    } catch {\n      // Search failed, mark unknown\n    }\n    \n    prices[ticker] = {\n      ticker,\n      priceUSD: 0,\n      change24h: null,\n      change7d: null,\n      marketCap: null,\n      volume24h: null,\n      lastUpdated: new Date().toISOString(),\n      source: 'unknown',\n    }\n    errors.push(`No price data found for ${ticker}`)\n  }\n  \n  // Stablecoins — hardcode to $1\n  for (const stable of ['USDT', 'USDC', 'DAI', 'BUSD', 'FRAX', 'TUSD', 'USDP']) {\n    if (prices[stable] && Math.abs(prices[stable].priceUSD - 1) < 0.05) continue\n    if (uniqueTickers.includes(stable) && !prices[stable]) {\n      prices[stable] = {\n        ticker: stable, priceUSD: 1.00, change24h: 0, change7d: 0,\n        marketCap: null, volume24h: null,\n        lastUpdated: new Date().toISOString(), source: 'manual',\n      }\n    }\n  }\n  \n  return { prices, errors, fromCache, fromAPI, timestamp: new Date().toISOString() }\n}\n\n// ─── Single Price Lookup ────────────────────────────────────────────────────\n\nexport async function fetchPrice(ticker: string): Promise<PriceData | null> {\n  const result = await fetchPrices([ticker])\n  return result.prices[ticker.toUpperCase()] || null\n}\n\n// ─── Portfolio Value Update ─────────────────────────────────────────────────\n\nexport interface PortfolioValuation {\n  totalCurrentValue: number\n  totalCostBasis: number\n  totalGainLoss: number\n  totalGainLossPct: number\n  positionValues: { ticker: string; quantity: number; price: number; value: number; gainLoss: number; gainLossPct: number }[]\n  pricesUpdated: number\n  priceErrors: string[]\n  timestamp: string\n}\n\nexport async function updatePortfolioValues(\n  positions: { ticker?: string; quantity: number; costBasis: number; currentValue: number }[]\n): Promise<PortfolioValuation> {\n  const tickers = positions.map(p => p.ticker).filter((t): t is string => !!t && t.length > 0)\n  const feedResult = await fetchPrices(tickers)\n  \n  let totalCurrentValue = 0\n  let totalCostBasis = 0\n  const positionValues: PortfolioValuation['positionValues'] = []\n  \n  for (const pos of positions) {\n    const ticker = (pos.ticker || '').toUpperCase()\n    const priceData = feedResult.prices[ticker]\n    const price = priceData?.priceUSD || 0\n    const value = price > 0 ? pos.quantity * price : pos.currentValue\n    const gainLoss = value - pos.costBasis\n    const gainLossPct = pos.costBasis > 0 ? (gainLoss / pos.costBasis) * 100 : 0\n    \n    totalCurrentValue += value\n    totalCostBasis += pos.costBasis\n    \n    positionValues.push({ ticker, quantity: pos.quantity, price, value, gainLoss, gainLossPct })\n  }\n  \n  return {\n    totalCurrentValue,\n    totalCostBasis,\n    totalGainLoss: totalCurrentValue - totalCostBasis,\n    totalGainLossPct: totalCostBasis > 0 ? ((totalCurrentValue - totalCostBasis) / totalCostBasis) * 100 : 0,\n    positionValues,\n    pricesUpdated: feedResult.fromAPI,\n    priceErrors: feedResult.errors,\n    timestamp: feedResult.timestamp,\n  }\n}\n\n// ─── Format Helpers ─────────────────────────────────────────────────────────\n\nexport function formatPrice(price: number): string {\n  if (price >= 1) return `$${price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`\n  if (price >= 0.01) return `$${price.toFixed(4)}`\n  if (price >= 0.0001) return `$${price.toFixed(6)}`\n  return `$${price.toFixed(8)}`\n}\n\nexport function formatChange(change: number | null): { text: string; color: string } {\n  if (change === null) return { text: '—', color: '#888' }\n  const sign = change >= 0 ? '+' : ''\n  return {\n    text: `${sign}${change.toFixed(2)}%`,\n    color: change >= 0 ? '#10b981' : '#ef4444',\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\marginal-rate.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'seRateBase' is assigned a value but never used.","line":49,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":49,"endColumn":19}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine - Marginal Rate Stack\n * Calculates the effective marginal rate at each income level,\n * decomposed into federal, state, SE, NIIT, and phase-out components.\n */\n\nimport type { FortunaState } from './storage'\nimport { FEDERAL_BRACKETS_2024, STANDARD_DEDUCTION_2024, generateTaxReport } from './tax-calculator'\n\nexport interface MarginalPoint {\n  income: number\n  federalRate: number\n  stateRate: number\n  seRate: number      // SE tax (15.3% on self-employment)\n  ficaRate: number    // W-2 FICA (7.65% employee share)\n  niitRate: number    // Net Investment Income Tax (3.8%)\n  totalRate: number\n  keepRate: number    // 1 - totalRate\n  label: string       // bracket label\n  isCliff: boolean    // true if rate jumps significantly\n}\n\nexport interface MarginalAnalysis {\n  points: MarginalPoint[]\n  currentIncome: number\n  currentPoint: MarginalPoint\n  nextBracketAt: number\n  nextBracketRate: number\n  dangerZones: { start: number; end: number; rate: number; reason: string }[]\n  sweetSpots: { income: number; keepRate: number; reason: string }[]\n}\n\nexport function analyzeMarginalRates(state: FortunaState): MarginalAnalysis {\n  const report = generateTaxReport(state)\n  const currentIncome = report.grossIncome\n  const hasSE = state.incomeStreams.some(s => ['business', 'freelance'].includes(s.type) && s.isActive && s.annualAmount > 0)\n  const seIncome = state.incomeStreams.filter(s => ['business', 'freelance'].includes(s.type) && s.isActive).reduce((s, i) => s + i.annualAmount, 0)\n  const hasW2 = state.incomeStreams.some(s => s.type === 'w2' && s.isActive && s.annualAmount > 0)\n  const hasInvestment = state.incomeStreams.some(s => s.type === 'investment' && s.isActive && s.annualAmount > 0)\n\n  const filingStatus = state.profile.filingStatus as keyof typeof FEDERAL_BRACKETS_2024\n  const brackets = FEDERAL_BRACKETS_2024[filingStatus] || FEDERAL_BRACKETS_2024.single\n  const stdDed = STANDARD_DEDUCTION_2024[state.profile.filingStatus] || 14600\n\n  // State rate\n  const stateRate = report.stateTax / Math.max(1, report.taxableIncome)\n\n  // SE tax rate (if applicable)\n  const seRateBase = hasSE ? 0.153 * 0.9235 : 0 // 15.3% on 92.35%\n  const SS_WAGE_BASE = 176100\n\n  // NIIT threshold\n  const niitThreshold = filingStatus === 'married_joint' ? 250000 :\n    filingStatus === 'married_separate' ? 125000 : 200000\n\n  // Generate points at key income levels\n  const incomePoints: number[] = []\n  for (let i = 0; i <= 500000; i += 5000) incomePoints.push(i)\n  // Add bracket boundaries\n  for (const b of brackets) {\n    if (b.min > 0) incomePoints.push(b.min + stdDed)\n    if (b.max < Infinity) incomePoints.push(b.max + stdDed)\n  }\n  // Add SS wage base, NIIT threshold, current income\n  incomePoints.push(SS_WAGE_BASE, niitThreshold, currentIncome)\n  const sorted = [...new Set(incomePoints)].sort((a, b) => a - b).filter(x => x >= 0 && x <= 600000)\n\n  const points: MarginalPoint[] = sorted.map(income => {\n    const taxable = Math.max(0, income - stdDed)\n\n    // Federal marginal rate\n    let fedRate = 0\n    for (const bracket of brackets) {\n      if (taxable > bracket.min) fedRate = bracket.rate\n    }\n\n    // SE rate (phases down after SS wage base for SS portion)\n    let seRate = 0\n    if (hasSE) {\n      const seIncomeAtLevel = Math.min(income, seIncome + (income - currentIncome))\n      if (seIncomeAtLevel > 0) {\n        const ssPartIncome = seIncomeAtLevel * 0.9235\n        if (ssPartIncome <= SS_WAGE_BASE) {\n          seRate = 0.153 * 0.9235 // full SE rate\n        } else {\n          seRate = 0.029 * 0.9235 // only Medicare portion above SS base\n        }\n      }\n    }\n\n    // W-2 FICA\n    let ficaRate = 0\n    if (hasW2) {\n      if (income <= SS_WAGE_BASE) {\n        ficaRate = 0.0765 // 6.2% SS + 1.45% Medicare\n      } else if (income <= 200000) {\n        ficaRate = 0.0145 // only Medicare above SS base\n      } else {\n        ficaRate = 0.0235 // Medicare + additional Medicare\n      }\n    }\n\n    // NIIT\n    let niitRate = 0\n    if (hasInvestment && income > niitThreshold) {\n      niitRate = 0.038\n    }\n\n    const totalRate = Math.min(0.75, fedRate + stateRate + seRate + ficaRate + niitRate)\n    const keepRate = 1 - totalRate\n\n    // Label\n    let label = `${(fedRate * 100).toFixed(0)}% bracket`\n    if (income <= stdDed) label = 'Standard deduction zone'\n\n    return {\n      income, federalRate: fedRate, stateRate, seRate, ficaRate, niitRate,\n      totalRate, keepRate, label, isCliff: false,\n    }\n  })\n\n  // Mark cliffs (rate jumps > 5%)\n  for (let i = 1; i < points.length; i++) {\n    if (points[i].totalRate - points[i - 1].totalRate > 0.05) {\n      points[i].isCliff = true\n    }\n  }\n\n  // Find current point\n  const currentPoint = points.reduce((closest, p) =>\n    Math.abs(p.income - currentIncome) < Math.abs(closest.income - currentIncome) ? p : closest\n  , points[0])\n\n  // Next bracket\n  let nextBracketAt = currentIncome\n  let nextBracketRate = currentPoint.totalRate\n  for (const p of points) {\n    if (p.income > currentIncome && p.totalRate > currentPoint.totalRate + 0.01) {\n      nextBracketAt = p.income\n      nextBracketRate = p.totalRate\n      break\n    }\n  }\n\n  // Danger zones: where effective rate > 45%\n  const dangerZones: MarginalAnalysis['dangerZones'] = []\n  let inDanger = false\n  let dangerStart = 0\n  for (const p of points) {\n    if (p.totalRate > 0.45 && !inDanger) {\n      inDanger = true\n      dangerStart = p.income\n    } else if (p.totalRate <= 0.45 && inDanger) {\n      inDanger = false\n      dangerZones.push({ start: dangerStart, end: p.income, rate: p.totalRate,\n        reason: `Combined rate > 45%${hasSE ? ' (includes 15.3% SE tax)' : ''}` })\n    }\n  }\n  if (inDanger) {\n    dangerZones.push({ start: dangerStart, end: 600000, rate: points[points.length - 1].totalRate,\n      reason: 'High combined marginal rate' })\n  }\n\n  // Sweet spots: best keep rates\n  const sweetSpots: MarginalAnalysis['sweetSpots'] = []\n  if (stdDed > 0) sweetSpots.push({ income: stdDed, keepRate: 1, reason: 'Standard deduction covers all income — 0% effective rate' })\n  if (hasSE && seIncome > 0 && seIncome < SS_WAGE_BASE) {\n    sweetSpots.push({ income: SS_WAGE_BASE, keepRate: points.find(p => p.income >= SS_WAGE_BASE)?.keepRate || 0.65,\n      reason: 'Social Security wage base — SE tax drops from 15.3% to 2.9% above this' })\n  }\n\n  return {\n    points, currentIncome, currentPoint, nextBracketAt, nextBracketRate, dangerZones, sweetSpots,\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\market-data.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\microcopy.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\multi-entity.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'SE_RATE' is assigned a value but never used.","line":104,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":104,"endColumn":14},{"ruleId":"prefer-const","severity":2,"message":"'totalPassThru' is never reassigned. Use 'const' instead.","line":288,"column":7,"nodeType":"Identifier","messageId":"useConst","endLine":288,"endColumn":20,"fix":{"range":[10481,10556],"text":"const totalPassThru = entityResults.reduce((s, r) => s + r.passThruIncome, 0)"}},{"ruleId":"prefer-const","severity":2,"message":"'totalSETax' is never reassigned. Use 'const' instead.","line":290,"column":7,"nodeType":"Identifier","messageId":"useConst","endLine":290,"endColumn":17,"fix":{"range":[10592,10655],"text":"const totalSETax = entityResults.reduce((s, r) => s + r.seTax, 0)"}},{"ruleId":"prefer-const","severity":2,"message":"'totalFICATax' is never reassigned. Use 'const' instead.","line":291,"column":7,"nodeType":"Identifier","messageId":"useConst","endLine":291,"endColumn":19,"fix":{"range":[10658,10725],"text":"const totalFICATax = entityResults.reduce((s, r) => s + r.ficaTax, 0)"}},{"ruleId":"prefer-const","severity":2,"message":"'totalQBI' is never reassigned. Use 'const' instead.","line":292,"column":7,"nodeType":"Identifier","messageId":"useConst","endLine":292,"endColumn":15,"fix":{"range":[10728,10796],"text":"const totalQBI = entityResults.reduce((s, r) => s + r.qbiDeduction, 0)"}}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":4,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE — Multi-Entity Cascade Engine v2\n * \n * Models tax implications across multiple business entities:\n *   - Entity hierarchy with parent/child relationships\n *   - Pass-through cascade (K-1 flow from partnerships/S-Corps)\n *   - Salary + distribution optimization across entities\n *   - Intercompany management fee strategies\n *   - Consolidated tax projection\n *   - Entity comparison: sole prop vs S-Corp vs C-Corp\n *   - QSBS (§1202) tracking for C-Corp qualified small business stock\n *\n * v2: Uses canonical EntityType from storage.ts\n */\n\nimport { type EntityType, type LegalEntity } from './storage'\nexport type { EntityType }\n\n// Alias map for any legacy 'single_llc' / 's_corp' / 'c_corp' references\nexport function normalizeEntityType(t: string): EntityType {\n  const map: Record<string, EntityType> = {\n    single_llc: 'llc', s_corp: 'scorp', c_corp: 'ccorp',\n  }\n  return (map[t] || t) as EntityType\n}\n\nexport interface BusinessEntity {\n  id: string\n  name: string\n  type: EntityType\n  ein?: string\n  stateOfFormation: string\n  ownershipPct: number\n  parentEntityId?: string\n  annualRevenue: number\n  annualExpenses: number\n  officerSalary: number\n  retirementContrib: number\n  healthInsurancePremium: number\n  otherDeductions: number\n  estimatedTaxPayments: number\n  notes: string\n}\n\n/** Convert a LegalEntity + its attributed income/expenses into a BusinessEntity for cascade */\nexport function legalToBusinessEntity(\n  entity: LegalEntity,\n  revenue: number,\n  expenses: number,\n): BusinessEntity {\n  return {\n    id: entity.id,\n    name: entity.name,\n    type: entity.type,\n    ein: entity.einNumber,\n    stateOfFormation: entity.state,\n    ownershipPct: entity.ownershipPct ?? 100,\n    parentEntityId: entity.parentEntityId,\n    annualRevenue: revenue,\n    annualExpenses: expenses,\n    officerSalary: entity.officerSalary ?? 0,\n    retirementContrib: entity.retirementContrib ?? 0,\n    healthInsurancePremium: entity.healthInsurancePremium ?? 0,\n    otherDeductions: 0,\n    estimatedTaxPayments: 0,\n    notes: entity.notes || '',\n  }\n}\n\nexport interface EntityTaxResult {\n  entity: BusinessEntity\n  grossProfit: number\n  taxableIncome: number\n  entityLevelTax: number         // C-Corp: corporate tax; others: 0\n  passThruIncome: number         // income flowing to personal return\n  selfEmploymentIncome: number   // subject to SE tax\n  seTax: number\n  ficaTax: number                // on W-2 salary (employer + employee share)\n  qbiDeduction: number           // §199A for pass-throughs\n  effectiveEntityRate: number\n  totalEntityBurden: number      // all taxes attributable to this entity\n  notes: string[]\n}\n\nexport interface CascadeResult {\n  entities: EntityTaxResult[]\n  consolidatedPersonal: {\n    totalPassThruIncome: number\n    totalW2Income: number\n    totalSETax: number\n    totalFICATax: number\n    totalQBI: number\n    estimatedFederalTax: number\n    estimatedStateTax: number\n    totalTaxBurden: number\n    effectiveRate: number\n  }\n  optimizationNotes: string[]\n}\n\n// ─── Tax Rate Constants ─────────────────────────────────────────────────────\n\nconst CORP_TAX_RATE = 0.21\nconst SE_RATE = 0.9235 * 0.153\nconst SS_WAGE_BASE = 168600\nconst FICA_RATE = 0.0765  // employee share\nconst FICA_EMPLOYER = 0.0765\nconst QBI_RATE = 0.20\n\n// Federal brackets (2025 single, simplified)\nconst FED_BRACKETS = [\n  { max: 11925, rate: 0.10 },\n  { max: 48475, rate: 0.12 },\n  { max: 103350, rate: 0.22 },\n  { max: 197300, rate: 0.24 },\n  { max: 250525, rate: 0.32 },\n  { max: 626350, rate: 0.35 },\n  { max: Infinity, rate: 0.37 },\n]\n\nfunction calcFederalTax(taxable: number): number {\n  let tax = 0, prev = 0\n  for (const b of FED_BRACKETS) {\n    const amt = Math.min(taxable - prev, b.max - prev)\n    if (amt <= 0) break\n    tax += amt * b.rate\n    prev = b.max\n  }\n  return tax\n}\n\nfunction calcSETax(netSE: number): { total: number; deductibleHalf: number } {\n  const base = netSE * 0.9235\n  const ss = Math.min(base, SS_WAGE_BASE) * 0.124\n  const med = base * 0.029\n  const total = ss + med\n  return { total: Math.round(total), deductibleHalf: Math.round(total / 2) }\n}\n\n// ─── Single Entity Tax Calculator ───────────────────────────────────────────\n\nfunction calculateEntityTax(entity: BusinessEntity): EntityTaxResult {\n  const grossProfit = entity.annualRevenue - entity.annualExpenses\n  const notes: string[] = []\n  let entityLevelTax = 0\n  let passThruIncome = 0\n  let selfEmploymentIncome = 0\n  let seTax = 0\n  let ficaTax = 0\n  let qbiDeduction = 0\n  let taxableIncome = grossProfit\n\n  switch (entity.type) {\n    case 'sole_prop':\n    case 'llc': {\n      // All income is pass-through + subject to SE tax\n      const deductions = entity.retirementContrib + entity.healthInsurancePremium + entity.otherDeductions\n      taxableIncome = Math.max(0, grossProfit - deductions)\n      passThruIncome = taxableIncome\n      selfEmploymentIncome = grossProfit // SE tax on gross before retirement\n      const se = calcSETax(selfEmploymentIncome)\n      seTax = se.total\n      passThruIncome -= se.deductibleHalf // deduct half SE tax\n      qbiDeduction = Math.min(passThruIncome * QBI_RATE, passThruIncome) // simplified QBI\n      notes.push(`Full SE tax applies: $${seTax.toLocaleString()}`)\n      notes.push(`QBI deduction (§199A): $${Math.round(qbiDeduction).toLocaleString()}`)\n      break\n    }\n\n    case 'scorp': {\n      // Salary subject to FICA; distributions avoid SE tax\n      const salary = entity.officerSalary\n      const distribution = Math.max(0, grossProfit - salary - entity.retirementContrib - entity.healthInsurancePremium - entity.otherDeductions)\n      \n      // FICA on salary (both shares)\n      const employeeFICA = Math.min(salary, SS_WAGE_BASE) * FICA_RATE + salary * 0.0145 // SS cap + Medicare\n      const employerFICA = Math.min(salary, SS_WAGE_BASE) * FICA_EMPLOYER + salary * 0.0145\n      ficaTax = Math.round(employeeFICA + employerFICA)\n      \n      // Pass-through: salary + distribution to personal return\n      passThruIncome = distribution // distribution flows through K-1\n      selfEmploymentIncome = 0 // no SE tax on S-Corp income\n      \n      qbiDeduction = Math.min(distribution * QBI_RATE, distribution)\n      \n      const seTaxSaved = calcSETax(grossProfit).total - ficaTax\n      notes.push(`Salary: $${salary.toLocaleString()} | Distribution: $${Math.round(distribution).toLocaleString()}`)\n      notes.push(`FICA (both shares): $${ficaTax.toLocaleString()}`)\n      notes.push(`SE tax savings vs sole prop: ~$${Math.max(0, Math.round(seTaxSaved)).toLocaleString()}`)\n      \n      // W-2 income goes to personal return separately\n      taxableIncome = salary + distribution\n      break\n    }\n\n    case 'ccorp': {\n      // Double taxation: corporate tax on profits, then dividend tax on distributions\n      const deductions = entity.officerSalary + entity.retirementContrib + entity.healthInsurancePremium + entity.otherDeductions\n      const corpTaxable = Math.max(0, grossProfit - deductions)\n      entityLevelTax = Math.round(corpTaxable * CORP_TAX_RATE)\n      \n      const afterTaxProfit = corpTaxable - entityLevelTax\n      passThruIncome = 0 // C-Corp doesn't pass through (unless distributed as dividends)\n      \n      // FICA on salary\n      const empFICA = Math.min(entity.officerSalary, SS_WAGE_BASE) * FICA_RATE + entity.officerSalary * 0.0145\n      const erFICA = Math.min(entity.officerSalary, SS_WAGE_BASE) * FICA_EMPLOYER + entity.officerSalary * 0.0145\n      ficaTax = Math.round(empFICA + erFICA)\n      \n      taxableIncome = corpTaxable\n      notes.push(`Corporate tax (21%): $${entityLevelTax.toLocaleString()}`)\n      notes.push(`After-tax retained: $${Math.round(afterTaxProfit).toLocaleString()}`)\n      notes.push(`QSBS (§1202): If held 5+ years, up to $10M or 10x basis gain exclusion`)\n      if (afterTaxProfit > 0) {\n        const divTax = Math.round(afterTaxProfit * 0.15) // qualified dividend rate\n        notes.push(`If distributed as dividend: additional $${divTax.toLocaleString()} tax (15% LTCG rate)`)\n      }\n      break\n    }\n\n    case 'partnership': {\n      // Pass-through based on ownership %\n      const deductions = entity.retirementContrib + entity.otherDeductions\n      taxableIncome = Math.max(0, grossProfit - deductions)\n      passThruIncome = taxableIncome * (entity.ownershipPct / 100)\n      selfEmploymentIncome = passThruIncome // general partners pay SE tax\n      const se = calcSETax(selfEmploymentIncome)\n      seTax = se.total\n      passThruIncome -= se.deductibleHalf\n      qbiDeduction = Math.min(passThruIncome * QBI_RATE, passThruIncome)\n      notes.push(`Your share (${entity.ownershipPct}%): $${Math.round(passThruIncome).toLocaleString()}`)\n      notes.push(`SE tax on partnership income: $${seTax.toLocaleString()}`)\n      break\n    }\n\n    case 'trust': {\n      // Trust income taxed at compressed brackets (highest rate at ~$14,450)\n      const deductions = entity.otherDeductions\n      taxableIncome = Math.max(0, grossProfit - deductions)\n      // Trust brackets reach 37% at just $14,450\n      let trustTax = 0\n      if (taxableIncome <= 3100) trustTax = taxableIncome * 0.10\n      else if (taxableIncome <= 11150) trustTax = 310 + (taxableIncome - 3100) * 0.24\n      else if (taxableIncome <= 15200) trustTax = 2242 + (taxableIncome - 11150) * 0.35\n      else trustTax = 3660 + (taxableIncome - 15200) * 0.37\n      \n      entityLevelTax = Math.round(trustTax)\n      notes.push(`Trust tax (compressed brackets): $${entityLevelTax.toLocaleString()}`)\n      notes.push(`Consider distributing income to beneficiaries to avoid compressed brackets`)\n      break\n    }\n\n    default:\n      passThruIncome = taxableIncome\n  }\n\n  const totalBurden = entityLevelTax + seTax + ficaTax\n  const effectiveRate = grossProfit > 0 ? totalBurden / grossProfit : 0\n\n  return {\n    entity,\n    grossProfit,\n    taxableIncome,\n    entityLevelTax,\n    passThruIncome,\n    selfEmploymentIncome,\n    seTax,\n    ficaTax,\n    qbiDeduction,\n    effectiveEntityRate: Math.round(effectiveRate * 10000) / 10000,\n    totalEntityBurden: totalBurden,\n    notes,\n  }\n}\n\n// ─── Multi-Entity Cascade ───────────────────────────────────────────────────\n\nexport function calculateEntityCascade(\n  entities: BusinessEntity[],\n  personalW2Income: number = 0,\n  stateCode: string = 'IL',\n  filingStatus: string = 'single',\n): CascadeResult {\n  // Calculate each entity\n  const entityResults = entities.map(e => calculateEntityTax(e))\n\n  // Consolidate to personal return\n  let totalPassThru = entityResults.reduce((s, r) => s + r.passThruIncome, 0)\n  let totalW2 = personalW2Income\n  let totalSETax = entityResults.reduce((s, r) => s + r.seTax, 0)\n  let totalFICATax = entityResults.reduce((s, r) => s + r.ficaTax, 0)\n  let totalQBI = entityResults.reduce((s, r) => s + r.qbiDeduction, 0)\n\n  // Add S-Corp/C-Corp salaries to W-2 income\n  for (const r of entityResults) {\n    if (r.entity.type === 'scorp' || r.entity.type === 'ccorp') {\n      totalW2 += r.entity.officerSalary\n    }\n  }\n\n  // Calculate personal federal tax\n  const totalIncome = totalW2 + totalPassThru\n  const halfSE = entityResults.reduce((s, r) => {\n    if (r.entity.type === 'sole_prop' || r.entity.type === 'llc' || r.entity.type === 'partnership') {\n      return s + calcSETax(r.selfEmploymentIncome).deductibleHalf\n    }\n    return s\n  }, 0)\n  \n  const standardDeduction = filingStatus === 'mfj' ? 30000 : 15000\n  const personalTaxable = Math.max(0, totalIncome - halfSE - standardDeduction - totalQBI)\n  const federalTax = Math.round(calcFederalTax(personalTaxable))\n\n  // Estimate state tax (simplified)\n  const stateRate = getSimpleStateRate(stateCode)\n  const stateTax = Math.round(personalTaxable * stateRate)\n\n  const totalBurden = federalTax + stateTax + totalSETax + totalFICATax +\n    entityResults.reduce((s, r) => s + r.entityLevelTax, 0)\n\n  const effectiveRate = totalIncome > 0 ? totalBurden / totalIncome : 0\n\n  // Generate optimization notes\n  const optimizationNotes: string[] = []\n\n  // Check if sole prop should be S-Corp\n  for (const r of entityResults) {\n    if ((r.entity.type === 'sole_prop' || r.entity.type === 'llc') && r.grossProfit > 50000) {\n      const potentialSCorpSavings = r.seTax - Math.round(r.grossProfit * 0.45 * (FICA_RATE + FICA_EMPLOYER) + r.grossProfit * 0.45 * 0.029) - 3000\n      if (potentialSCorpSavings > 3000) {\n        optimizationNotes.push(`💡 \"${r.entity.name}\" could save ~$${Math.round(potentialSCorpSavings).toLocaleString()}/yr by electing S-Corp status. Net profit $${Math.round(r.grossProfit).toLocaleString()} exceeds threshold.`)\n      }\n    }\n  }\n\n  // Check intercompany management fee opportunity\n  const sCorps = entityResults.filter(r => r.entity.type === 'scorp')\n  const cCorps = entityResults.filter(r => r.entity.type === 'ccorp')\n  if (sCorps.length > 0 && cCorps.length > 0) {\n    optimizationNotes.push(`💡 Consider intercompany management fees from C-Corp to S-Corp to reduce double taxation on C-Corp earnings.`)\n  }\n\n  // QBI deduction sunset warning\n  if (totalQBI > 0) {\n    optimizationNotes.push(`⚠️ §199A QBI deduction ($${Math.round(totalQBI).toLocaleString()}) is set to expire after 2025 unless Congress extends. Plan for potential loss.`)\n  }\n\n  // Retirement contribution optimization\n  const totalRetirement = entities.reduce((s, e) => s + e.retirementContrib, 0)\n  const maxRetirement = 69000 // Solo 401(k) max\n  if (totalRetirement < maxRetirement * 0.5 && totalIncome > 100000) {\n    optimizationNotes.push(`💡 Retirement contributions ($${totalRetirement.toLocaleString()}) are well below maximum ($${maxRetirement.toLocaleString()}). Increasing contributions could save $${Math.round((maxRetirement - totalRetirement) * 0.30).toLocaleString()} in taxes.`)\n  }\n\n  return {\n    entities: entityResults,\n    consolidatedPersonal: {\n      totalPassThruIncome: Math.round(totalPassThru),\n      totalW2Income: Math.round(totalW2),\n      totalSETax,\n      totalFICATax,\n      totalQBI: Math.round(totalQBI),\n      estimatedFederalTax: federalTax,\n      estimatedStateTax: stateTax,\n      totalTaxBurden: totalBurden,\n      effectiveRate: Math.round(effectiveRate * 10000) / 10000,\n    },\n    optimizationNotes,\n  }\n}\n\n// ─── Entity Comparison Tool ─────────────────────────────────────────────────\n\nexport function compareEntityStructures(\n  annualRevenue: number,\n  annualExpenses: number,\n  stateCode: string = 'IL',\n): { type: EntityType; totalTax: number; effectiveRate: number; notes: string[] }[] {\n  const profit = annualRevenue - annualExpenses\n  const reasonableSalary = Math.max(40000, profit * 0.45)\n\n  const structures: { type: EntityType; salary: number }[] = [\n    { type: 'sole_prop', salary: 0 },\n    { type: 'scorp', salary: Math.round(reasonableSalary) },\n    { type: 'ccorp', salary: Math.round(reasonableSalary) },\n  ]\n\n  return structures.map(s => {\n    const entity: BusinessEntity = {\n      id: s.type, name: s.type, type: s.type, stateOfFormation: stateCode,\n      ownershipPct: 100, annualRevenue, annualExpenses,\n      officerSalary: s.salary, retirementContrib: 0,\n      healthInsurancePremium: 0, otherDeductions: 0,\n      estimatedTaxPayments: 0, notes: '',\n    }\n    const result = calculateEntityCascade([entity], 0, stateCode)\n    return {\n      type: s.type,\n      totalTax: result.consolidatedPersonal.totalTaxBurden,\n      effectiveRate: result.consolidatedPersonal.effectiveRate,\n      notes: result.entities[0]?.notes || [],\n    }\n  }).sort((a, b) => a.totalTax - b.totalTax)\n}\n\n// ─── Helpers ────────────────────────────────────────────────────────────────\n\nfunction getSimpleStateRate(code: string): number {\n  const rates: Record<string, number> = {\n    AL: 0.05, AK: 0, AZ: 0.025, AR: 0.044, CA: 0.093, CO: 0.044,\n    CT: 0.05, DE: 0.066, FL: 0, GA: 0.055, HI: 0.075, ID: 0.058,\n    IL: 0.0495, IN: 0.0305, IA: 0.038, KS: 0.057, KY: 0.04,\n    LA: 0.0425, ME: 0.0715, MD: 0.0575, MA: 0.05, MI: 0.0425,\n    MN: 0.0785, MS: 0.05, MO: 0.048, MT: 0.059, NE: 0.0564,\n    NV: 0, NH: 0, NJ: 0.0675, NM: 0.059, NY: 0.0685, NC: 0.045,\n    ND: 0.0195, OH: 0.035, OK: 0.0475, OR: 0.099, PA: 0.0307,\n    RI: 0.0599, SC: 0.064, SD: 0, TN: 0, TX: 0, UT: 0.0465,\n    VT: 0.0875, VA: 0.0575, WA: 0, WV: 0.0512, WI: 0.0765,\n    WY: 0, DC: 0.085,\n  }\n  return rates[code] || 0.05\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\multi-year-tax.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TaxReport' is defined but never used.","line":14,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":43,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TaxReport"},"fix":{"range":[505,521],"text":""},"desc":"Remove unused variable \"TaxReport\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'currentYear' is assigned a value but never used.","line":321,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":321,"endColumn":20}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — Multi-Year Tax Projection & Income Shifting v9\n *\n * Models tax burden across 3-5 year horizons with:\n *  - Bracket-aware income timing optimization\n *  - Revenue growth projection with confidence intervals\n *  - Year-over-year strategy impact compounding\n *  - Income deferral vs acceleration recommendations\n *  - TCJA sunset modeling (2026 bracket changes)\n *  - Effective vs marginal rate trajectory\n */\n\nimport type { FortunaState } from './storage'\nimport { generateTaxReport, type TaxReport } from './tax-calculator'\n\n// ===================================================================\n//  TCJA SUNSET — 2026 brackets revert to pre-TCJA (inflation-adjusted)\n// ===================================================================\n\nconst TCJA_SUNSET_YEAR = 2026\n\nconst PRE_TCJA_BRACKETS_PROJECTED = {\n  single: [\n    { min: 0, max: 11000, rate: 0.10 },\n    { min: 11000, max: 44725, rate: 0.15 },\n    { min: 44725, max: 95375, rate: 0.25 },\n    { min: 95375, max: 171050, rate: 0.28 },\n    { min: 171050, max: 372950, rate: 0.33 },\n    { min: 372950, max: 418850, rate: 0.35 },\n    { min: 418850, max: Infinity, rate: 0.396 },\n  ],\n  married_joint: [\n    { min: 0, max: 22000, rate: 0.10 },\n    { min: 22000, max: 89450, rate: 0.15 },\n    { min: 89450, max: 190750, rate: 0.25 },\n    { min: 190750, max: 342050, rate: 0.28 },\n    { min: 342050, max: 418850, rate: 0.33 },\n    { min: 418850, max: 628300, rate: 0.35 },\n    { min: 628300, max: Infinity, rate: 0.396 },\n  ],\n}\n\nconst PRE_TCJA_STANDARD_DEDUCTION: Record<string, number> = {\n  single: 8300,\n  married_joint: 16600,\n  married_separate: 8300,\n  head_of_household: 12200,\n}\n\n// Current brackets for comparison\nconst CURRENT_BRACKETS = {\n  single: [\n    { min: 0, max: 11600, rate: 0.10 },\n    { min: 11600, max: 47150, rate: 0.12 },\n    { min: 47150, max: 100525, rate: 0.22 },\n    { min: 100525, max: 191950, rate: 0.24 },\n    { min: 191950, max: 243725, rate: 0.32 },\n    { min: 243725, max: 609350, rate: 0.35 },\n    { min: 609350, max: Infinity, rate: 0.37 },\n  ],\n  married_joint: [\n    { min: 0, max: 23200, rate: 0.10 },\n    { min: 23200, max: 94300, rate: 0.12 },\n    { min: 94300, max: 201050, rate: 0.22 },\n    { min: 201050, max: 383900, rate: 0.24 },\n    { min: 383900, max: 487450, rate: 0.32 },\n    { min: 487450, max: 731200, rate: 0.35 },\n    { min: 731200, max: Infinity, rate: 0.37 },\n  ],\n}\n\nconst CURRENT_STANDARD_DEDUCTION: Record<string, number> = {\n  single: 14600,\n  married_joint: 29200,\n  married_separate: 14600,\n  head_of_household: 21900,\n}\n\n// ===================================================================\n//  TYPES\n// ===================================================================\n\nexport interface YearProjection {\n  year: number\n  grossIncome: number\n  growthRate: number\n  taxableIncome: number\n  federalTax: number\n  stateTax: number\n  seTax: number\n  totalTax: number\n  effectiveRate: number\n  marginalRate: number\n  afterTax: number\n  bracketRegime: 'tcja' | 'pre_tcja'\n  strategySavings: number\n  cumulativeSavings: number\n  bracketUtilization: BracketSlice[]\n  lowEstimate: number\n  highEstimate: number\n  // Carryforward tracking\n  capitalLossUsed?: number\n  capitalLossRemaining?: number\n  nolUsed?: number\n  nolRemaining?: number\n  charitableCarryUsed?: number\n  charitableCarryRemaining?: number\n}\n\nexport interface BracketSlice {\n  rate: number\n  filled: number\n  capacity: number\n  utilization: number // 0-1\n}\n\nexport interface IncomeShiftScenario {\n  id: string\n  name: string\n  description: string\n  shifts: YearShift[]\n  totalTaxSavings: number\n  yearByYear: YearProjection[]\n  recommendation: 'strong' | 'moderate' | 'neutral' | 'avoid'\n  reasoning: string\n}\n\ninterface YearShift {\n  year: number\n  shiftAmount: number // positive = defer into this year, negative = accelerate out\n  shiftType: 'defer_revenue' | 'accelerate_expense' | 'prepay_expense' | 'delay_billing'\n}\n\nexport interface MultiYearAnalysis {\n  baseline: YearProjection[]\n  scenarios: IncomeShiftScenario[]\n  tcjaSunsetImpact: number // additional tax burden if TCJA expires\n  optimalScenario: string // id of best scenario\n  bracketHeadroom: number // room in current bracket before next rate jump\n  insights: MultiYearInsight[]\n}\n\nexport interface MultiYearInsight {\n  type: 'warning' | 'opportunity' | 'info'\n  title: string\n  detail: string\n  impact?: number\n  actionView?: string\n}\n\n// ===================================================================\n//  BRACKET CALCULATOR\n// ===================================================================\n\nfunction calcFederalTax(\n  taxableIncome: number,\n  filingStatus: string,\n  year: number,\n): { tax: number; marginal: number; slices: BracketSlice[] } {\n  const useTCJA = year < TCJA_SUNSET_YEAR\n  const statusKey = filingStatus === 'head_of_household' ? 'single' : filingStatus\n  const key = (statusKey === 'married_joint' || statusKey === 'married_separate')\n    ? 'married_joint' : 'single'\n\n  const brackets = useTCJA\n    ? CURRENT_BRACKETS[key]\n    : (PRE_TCJA_BRACKETS_PROJECTED[key] || CURRENT_BRACKETS[key])\n\n  let tax = 0\n  let marginal = 0.10\n  const slices: BracketSlice[] = []\n\n  for (const b of brackets) {\n    const capacity = b.max === Infinity ? b.min + 500000 : b.max - b.min\n    const inBracket = Math.min(Math.max(0, taxableIncome - b.min), b.max - b.min)\n    tax += inBracket * b.rate\n    if (inBracket > 0) marginal = b.rate\n\n    slices.push({\n      rate: b.rate,\n      filled: inBracket,\n      capacity,\n      utilization: capacity > 0 ? inBracket / capacity : 0,\n    })\n  }\n\n  return { tax: Math.round(tax), marginal, slices }\n}\n\nfunction getStandardDeduction(filingStatus: string, year: number): number {\n  const useTCJA = year < TCJA_SUNSET_YEAR\n  const deductions = useTCJA ? CURRENT_STANDARD_DEDUCTION : PRE_TCJA_STANDARD_DEDUCTION\n  return deductions[filingStatus] || deductions.single\n}\n\n// ===================================================================\n//  GROWTH MODEL\n// ===================================================================\n\nfunction projectGrowthRate(state: FortunaState, yearsOut: number): number {\n  // Base growth from income diversity and trajectory\n  const activeStreams = state.incomeStreams.filter(s => s.isActive)\n  const totalIncome = activeStreams.reduce((s, i) => s + i.annualAmount, 0)\n\n  const businessIncome = activeStreams\n    .filter(s => ['business', 'freelance'].includes(s.type))\n    .reduce((s, i) => s + i.annualAmount, 0)\n\n  const businessRatio = totalIncome > 0 ? businessIncome / totalIncome : 0\n\n  // Business-heavy portfolios have higher growth potential but more variance\n  const baseGrowth = 0.03 + businessRatio * 0.07 // 3-10% base\n  // Growth moderates over time\n  const decayFactor = Math.pow(0.92, yearsOut)\n  return baseGrowth * decayFactor\n}\n\nfunction projectIncome(currentIncome: number, growthRate: number): {\n  projected: number\n  low: number\n  high: number\n} {\n  const projected = Math.round(currentIncome * (1 + growthRate))\n  const variance = 0.15 // ±15% confidence band\n  return {\n    projected,\n    low: Math.round(projected * (1 - variance)),\n    high: Math.round(projected * (1 + variance)),\n  }\n}\n\n// ===================================================================\n//  YEAR PROJECTION\n// ===================================================================\n\nfunction projectYear(\n  state: FortunaState,\n  year: number,\n  grossIncome: number,\n  growthRate: number,\n  cumulativeSavingsBase: number,\n  lowIncome: number,\n  highIncome: number,\n  carryforwards?: { capitalLoss: number; nol: number; charitable: number },\n): YearProjection {\n  const { profile } = state\n  const stdDeduction = getStandardDeduction(profile.filingStatus, year)\n\n  const currentReport = generateTaxReport(state)\n  const seRatio = currentReport.grossIncome > 0\n    ? currentReport.selfEmploymentIncome / currentReport.grossIncome : 0.5\n  const seIncome = grossIncome * seRatio\n\n  const itemized = state.deductions\n    .filter(d => d.isItemized)\n    .reduce((s, d) => s + d.amount, 0)\n  const deduction = Math.max(stdDeduction, itemized)\n\n  const qbi = seIncome > 0 ? Math.round(seIncome * 0.20) : 0\n\n  // Apply carryforwards\n  const cf = carryforwards || { capitalLoss: 0, nol: 0, charitable: 0 }\n  const capitalLossUsed = Math.min(cf.capitalLoss, 3000) // $3k annual limit\n  const nolUsed = cf.nol > 0 ? Math.min(cf.nol, Math.round(grossIncome * 0.80)) : 0 // 80% of income limit post-2017\n  const charitableCarryUsed = Math.min(cf.charitable, Math.round(grossIncome * 0.60)) // 60% AGI limit\n\n  const taxableIncome = Math.max(0, grossIncome - deduction - qbi - capitalLossUsed - nolUsed - charitableCarryUsed)\n\n  const { tax: federalTax, marginal, slices } = calcFederalTax(taxableIncome, profile.filingStatus, year)\n\n  const seBase = seIncome * 0.9235\n  const seTax = Math.round(seBase * 0.153)\n\n  const stateRate = currentReport.stateTax / (currentReport.grossIncome || 1)\n  const stateTax = Math.round(grossIncome * stateRate)\n\n  const totalTax = federalTax + seTax + stateTax\n  const effectiveRate = grossIncome > 0 ? totalTax / grossIncome : 0\n\n  const yearIndex = year - new Date().getFullYear()\n  const strategySavings = Math.round(\n    (currentReport.identifiedSavings || 0) * Math.pow(1.05, yearIndex)\n  )\n\n  return {\n    year,\n    grossIncome,\n    growthRate,\n    taxableIncome,\n    federalTax,\n    stateTax,\n    seTax,\n    totalTax,\n    effectiveRate,\n    marginalRate: marginal,\n    afterTax: grossIncome - totalTax,\n    bracketRegime: year < TCJA_SUNSET_YEAR ? 'tcja' : 'pre_tcja',\n    strategySavings,\n    cumulativeSavings: cumulativeSavingsBase + strategySavings,\n    bracketUtilization: slices,\n    lowEstimate: Math.round(lowIncome - lowIncome * effectiveRate),\n    highEstimate: Math.round(highIncome - highIncome * effectiveRate),\n    capitalLossUsed,\n    capitalLossRemaining: cf.capitalLoss - capitalLossUsed,\n    nolUsed,\n    nolRemaining: cf.nol - nolUsed,\n    charitableCarryUsed,\n    charitableCarryRemaining: cf.charitable - charitableCarryUsed,\n  }\n}\n\n// ===================================================================\n//  INCOME SHIFTING SCENARIOS\n// ===================================================================\n\nfunction generateShiftScenarios(\n  state: FortunaState,\n  baseline: YearProjection[],\n): IncomeShiftScenario[] {\n  const scenarios: IncomeShiftScenario[] = []\n  const currentYear = new Date().getFullYear()\n  const report = generateTaxReport(state)\n\n  if (baseline.length < 2) return scenarios\n\n  // ── Scenario 1: Accelerate income before TCJA sunset ──\n  const tcjaYears = baseline.filter(y => y.bracketRegime === 'tcja')\n  const postTcjaYears = baseline.filter(y => y.bracketRegime === 'pre_tcja')\n\n  if (tcjaYears.length > 0 && postTcjaYears.length > 0) {\n    const shiftAmount = Math.round(report.grossIncome * 0.10) // shift 10%\n    const shifts: YearShift[] = [\n      { year: TCJA_SUNSET_YEAR - 1, shiftAmount: shiftAmount, shiftType: 'accelerate_expense' as const },\n      { year: TCJA_SUNSET_YEAR, shiftAmount: -shiftAmount, shiftType: 'defer_revenue' as const },\n    ]\n\n    // Calculate savings\n    const lastTcjaYear = tcjaYears[tcjaYears.length - 1]\n    const firstPostYear = postTcjaYears[0]\n    const rateGap = (firstPostYear.marginalRate - lastTcjaYear.marginalRate)\n    const savings = Math.round(shiftAmount * Math.max(0, rateGap))\n\n    scenarios.push({\n      id: 'accelerate-pre-sunset',\n      name: 'Accelerate Income Before TCJA Sunset',\n      description: `Recognize $${shiftAmount.toLocaleString()} additional income in ${TCJA_SUNSET_YEAR - 1} to lock in current lower rates before brackets revert.`,\n      shifts,\n      totalTaxSavings: savings,\n      yearByYear: baseline, // simplified\n      recommendation: savings > 2000 ? 'strong' : savings > 500 ? 'moderate' : 'neutral',\n      reasoning: `Current top rate of ${(lastTcjaYear.marginalRate * 100).toFixed(0)}% jumps to ${(firstPostYear.marginalRate * 100).toFixed(0)}% after sunset. Accelerating income saves the rate differential on shifted amount.`,\n    })\n  }\n\n  // ── Scenario 2: Bracket smoothing — even out lumpy income ──\n  const avgIncome = baseline.reduce((s, y) => s + y.grossIncome, 0) / baseline.length\n  const maxDeviation = Math.max(...baseline.map(y => Math.abs(y.grossIncome - avgIncome)))\n\n  if (maxDeviation > avgIncome * 0.15) {\n    const peakYear = baseline.reduce((a, b) => a.grossIncome > b.grossIncome ? a : b)\n    const valleyYear = baseline.reduce((a, b) => a.grossIncome < b.grossIncome ? a : b)\n    const shiftAmount = Math.round((peakYear.grossIncome - valleyYear.grossIncome) * 0.25)\n\n    const rateDiff = peakYear.marginalRate - valleyYear.marginalRate\n    const savings = Math.round(shiftAmount * Math.max(0, rateDiff))\n\n    scenarios.push({\n      id: 'bracket-smoothing',\n      name: 'Bracket Smoothing',\n      description: `Shift $${shiftAmount.toLocaleString()} from peak year (${peakYear.year}) to lower year (${valleyYear.year}) to reduce marginal rate exposure.`,\n      shifts: [\n        { year: peakYear.year, shiftAmount: -shiftAmount, shiftType: 'defer_revenue' },\n        { year: valleyYear.year, shiftAmount: shiftAmount, shiftType: 'delay_billing' },\n      ],\n      totalTaxSavings: savings,\n      yearByYear: baseline,\n      recommendation: savings > 3000 ? 'strong' : savings > 1000 ? 'moderate' : 'neutral',\n      reasoning: `Income variance of $${maxDeviation.toLocaleString()} pushes peak years into higher brackets. Smoothing keeps more income at ${(valleyYear.marginalRate * 100).toFixed(0)}% instead of ${(peakYear.marginalRate * 100).toFixed(0)}%.`,\n    })\n  }\n\n  // ── Scenario 3: Defer into lower-rate year ──\n  if (baseline.length >= 2) {\n    const thisYear = baseline[0]\n    const nextYear = baseline[1]\n\n    if (thisYear.marginalRate > nextYear.marginalRate) {\n      const shiftAmount = Math.round(report.grossIncome * 0.08)\n      const savings = Math.round(shiftAmount * (thisYear.marginalRate - nextYear.marginalRate))\n\n      scenarios.push({\n        id: 'defer-next-year',\n        name: 'Defer Revenue to Next Year',\n        description: `Push $${shiftAmount.toLocaleString()} in revenue recognition to ${nextYear.year} where your projected marginal rate is lower.`,\n        shifts: [\n          { year: thisYear.year, shiftAmount: -shiftAmount, shiftType: 'defer_revenue' },\n          { year: nextYear.year, shiftAmount: shiftAmount, shiftType: 'delay_billing' },\n        ],\n        totalTaxSavings: savings,\n        yearByYear: baseline,\n        recommendation: savings > 2000 ? 'strong' : 'moderate',\n        reasoning: `Your ${thisYear.year} marginal rate (${(thisYear.marginalRate * 100).toFixed(0)}%) exceeds ${nextYear.year} (${(nextYear.marginalRate * 100).toFixed(0)}%). Timing flexibility can capture the rate differential.`,\n      })\n    }\n  }\n\n  // ── Scenario 4: Maximize retirement contributions pre-sunset ──\n  if (report.retirementGap > 5000 && tcjaYears.length > 0) {\n    const maxDefer = Math.min(report.retirementGap, 69000)\n    const savings = Math.round(maxDefer * baseline[0].marginalRate)\n\n    scenarios.push({\n      id: 'max-retirement-pre-sunset',\n      name: 'Max Retirement Contributions Before Sunset',\n      description: `Deploy full $${maxDefer.toLocaleString()} retirement contribution capacity while TCJA deductions are at their most valuable.`,\n      shifts: tcjaYears.map(y => ({\n        year: y.year,\n        shiftAmount: -maxDefer,\n        shiftType: 'accelerate_expense' as const,\n      })),\n      totalTaxSavings: savings * tcjaYears.length,\n      yearByYear: baseline,\n      recommendation: 'strong',\n      reasoning: `Every $1 deducted now saves ${(baseline[0].marginalRate * 100).toFixed(0)}¢. After sunset, the same deduction may only save ${Math.round(baseline[0].marginalRate * 0.85 * 100)}¢. Front-loading is optimal.`,\n    })\n  }\n\n  // ── Scenario 5: Prepay expenses in high-income year ──\n  const highYears = baseline.filter(y => y.marginalRate >= 0.32)\n  if (highYears.length > 0) {\n    const prepayAmount = Math.round(\n      state.expenses.reduce((s, e) => s + (e.isDeductible ? e.annualAmount * e.deductionPct / 100 : 0), 0) * 0.5\n    )\n    if (prepayAmount > 2000) {\n      const savings = Math.round(prepayAmount * highYears[0].marginalRate)\n      scenarios.push({\n        id: 'prepay-high-year',\n        name: 'Prepay Deductible Expenses',\n        description: `Accelerate $${prepayAmount.toLocaleString()} in deductible expenses into ${highYears[0].year} (${(highYears[0].marginalRate * 100).toFixed(0)}% bracket) for maximum deduction value.`,\n        shifts: [\n          { year: highYears[0].year, shiftAmount: -prepayAmount, shiftType: 'prepay_expense' },\n        ],\n        totalTaxSavings: savings,\n        yearByYear: baseline,\n        recommendation: savings > 1500 ? 'moderate' : 'neutral',\n        reasoning: `Deductions are worth more in higher brackets. Prepaying shifts deduction value from a potential ${((highYears[0].marginalRate - 0.02) * 100).toFixed(0)}% year to the ${(highYears[0].marginalRate * 100).toFixed(0)}% year.`,\n      })\n    }\n  }\n\n  return scenarios.sort((a, b) => b.totalTaxSavings - a.totalTaxSavings)\n}\n\n// ===================================================================\n//  INSIGHTS GENERATOR\n// ===================================================================\n\nfunction generateInsights(\n  baseline: YearProjection[],\n  scenarios: IncomeShiftScenario[],\n  state: FortunaState,\n): MultiYearInsight[] {\n  const insights: MultiYearInsight[] = []\n\n  // TCJA sunset warning\n  const tcjaTransition = baseline.find(y => y.bracketRegime === 'pre_tcja')\n  if (tcjaTransition) {\n    const lastTcja = baseline.filter(y => y.bracketRegime === 'tcja').pop()\n    if (lastTcja && tcjaTransition) {\n      const impact = tcjaTransition.totalTax - Math.round(\n        tcjaTransition.grossIncome * lastTcja.effectiveRate\n      )\n      insights.push({\n        type: 'warning',\n        title: `TCJA Sunset in ${TCJA_SUNSET_YEAR}`,\n        detail: `Tax brackets revert to pre-2017 rates. Your projected tax increase: $${Math.max(0, impact).toLocaleString()}/year. Standard deduction drops from $${CURRENT_STANDARD_DEDUCTION[state.profile.filingStatus]?.toLocaleString()} to ~$${PRE_TCJA_STANDARD_DEDUCTION[state.profile.filingStatus]?.toLocaleString()}.`,\n        impact: Math.max(0, impact),\n      })\n    }\n  }\n\n  // Bracket jump warning\n  const currentBracket = baseline[0]?.marginalRate || 0\n  for (const yr of baseline.slice(1)) {\n    if (yr.marginalRate > currentBracket + 0.05) {\n      insights.push({\n        type: 'warning',\n        title: `Bracket Jump in ${yr.year}`,\n        detail: `Projected income growth pushes marginal rate from ${(currentBracket * 100).toFixed(0)}% to ${(yr.marginalRate * 100).toFixed(0)}%. Consider deferral or retirement contributions to stay in current bracket.`,\n        impact: yr.totalTax - baseline[0].totalTax,\n        actionView: 'retirement',\n      })\n      break\n    }\n  }\n\n  // Bracket headroom opportunity\n  if (baseline.length > 0) {\n    const current = baseline[0]\n    const underutilized = current.bracketUtilization.find(s => s.utilization > 0 && s.utilization < 0.85)\n    if (underutilized) {\n      const headroom = underutilized.capacity - underutilized.filled\n      if (headroom > 10000) {\n        insights.push({\n          type: 'opportunity',\n          title: 'Bracket Headroom Available',\n          detail: `$${headroom.toLocaleString()} room at ${(underutilized.rate * 100).toFixed(0)}% before jumping to next bracket. Consider Roth conversions or income recognition to fill this space at the lower rate.`,\n          impact: headroom,\n          actionView: 'retirement',\n        })\n      }\n    }\n  }\n\n  // Effective rate trend\n  if (baseline.length >= 3) {\n    const rateChange = baseline[baseline.length - 1].effectiveRate - baseline[0].effectiveRate\n    if (Math.abs(rateChange) > 0.02) {\n      insights.push({\n        type: rateChange > 0 ? 'warning' : 'opportunity',\n        title: rateChange > 0 ? 'Rising Effective Rate' : 'Declining Effective Rate',\n        detail: `Your effective rate ${rateChange > 0 ? 'increases' : 'decreases'} from ${(baseline[0].effectiveRate * 100).toFixed(1)}% to ${(baseline[baseline.length - 1].effectiveRate * 100).toFixed(1)}% over the projection period.`,\n      })\n    }\n  }\n\n  // Total scenario savings\n  const bestScenario = scenarios[0]\n  if (bestScenario && bestScenario.totalTaxSavings > 1000) {\n    insights.push({\n      type: 'opportunity',\n      title: `Income Shifting Could Save $${bestScenario.totalTaxSavings.toLocaleString()}`,\n      detail: `The \"${bestScenario.name}\" strategy is the highest-impact timing optimization available. ${bestScenario.reasoning}`,\n      impact: bestScenario.totalTaxSavings,\n    })\n  }\n\n  // 5-year cumulative tax projection\n  const totalTax5yr = baseline.reduce((s, y) => s + y.totalTax, 0)\n  const totalIncome5yr = baseline.reduce((s, y) => s + y.grossIncome, 0)\n  insights.push({\n    type: 'info',\n    title: `${baseline.length}-Year Tax Projection: $${totalTax5yr.toLocaleString()}`,\n    detail: `On $${totalIncome5yr.toLocaleString()} projected gross income, blended effective rate of ${(totalTax5yr / totalIncome5yr * 100).toFixed(1)}%.`,\n  })\n\n  return insights\n}\n\n// ===================================================================\n//  MAIN ANALYSIS\n// ===================================================================\n\nexport function runMultiYearAnalysis(\n  state: FortunaState,\n  years: number = 5,\n): MultiYearAnalysis {\n  const currentYear = new Date().getFullYear()\n  const report = generateTaxReport(state)\n  const baseline: YearProjection[] = []\n\n  let income = report.grossIncome\n  let cumulativeSavings = 0\n\n  // Initialize carryforwards from metamodel\n  const cf = state.carryforwards || {}\n  let carryforwards = {\n    capitalLoss: cf.capitalLoss || 0,\n    nol: cf.netOperatingLoss || 0,\n    charitable: cf.charitableContributions || 0,\n  }\n\n  for (let i = 0; i < years; i++) {\n    const year = currentYear + i\n    const growthRate = i === 0 ? 0 : projectGrowthRate(state, i)\n    const { projected, low, high } = i === 0\n      ? { projected: income, low: income, high: income }\n      : projectIncome(income, growthRate)\n\n    const yp = projectYear(state, year, projected, growthRate, cumulativeSavings, low, high, carryforwards)\n    baseline.push(yp)\n\n    // Propagate remaining carryforwards to next year\n    carryforwards = {\n      capitalLoss: yp.capitalLossRemaining || 0,\n      nol: yp.nolRemaining || 0,\n      charitable: yp.charitableCarryRemaining || 0,\n    }\n\n    cumulativeSavings = yp.cumulativeSavings\n    income = projected\n  }\n\n  const scenarios = generateShiftScenarios(state, baseline)\n  const insights = generateInsights(baseline, scenarios, state)\n\n  // TCJA sunset impact\n  const preSunset = baseline.filter(y => y.bracketRegime === 'tcja')\n  const postSunset = baseline.filter(y => y.bracketRegime === 'pre_tcja')\n  let tcjaSunsetImpact = 0\n  if (preSunset.length > 0 && postSunset.length > 0) {\n    const lastPre = preSunset[preSunset.length - 1]\n    const firstPost = postSunset[0]\n    tcjaSunsetImpact = Math.max(0, firstPost.totalTax - Math.round(firstPost.grossIncome * lastPre.effectiveRate))\n  }\n\n  // Bracket headroom\n  let bracketHeadroom = 0\n  if (baseline.length > 0) {\n    const current = baseline[0]\n    const activeBracket = current.bracketUtilization.find(s => s.utilization > 0 && s.utilization < 1)\n    if (activeBracket) {\n      bracketHeadroom = activeBracket.capacity - activeBracket.filled\n    }\n  }\n\n  return {\n    baseline,\n    scenarios,\n    tcjaSunsetImpact,\n    optimalScenario: scenarios[0]?.id || '',\n    bracketHeadroom: Math.round(bracketHeadroom),\n    insights,\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\paycheck-simulator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\pnl-engine.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\portfolio-bridge.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'thirtyDaysAgo' is assigned a value but never used.","line":226,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":226,"endColumn":22}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — Portfolio Bridge\n *\n * Central integration layer between Portfolio Intelligence (localStorage)\n * and all engine modules (tax calculator, strategy detector, proactive alerts,\n * AI context, health score, CPA export, scenario modeler, unified intelligence).\n *\n * UIF L3 (Shared Services): Asset valuation, tax classification, risk scoring\n * UIF L4 (Events): Position changes, tax event triggers\n */\n\nimport { STATE_TAX_RATES } from './tax-calculator'\n\n// ─── Types (mirror PortfolioIntelligence.tsx but importable by engines) ──────\n\nexport type AssetClass = 'crypto' | 'defi' | 'nft' | 'equity' | 'commodity' | 'real_estate' | 'speculative' | 'other'\nexport type PositionStatus = 'active' | 'pending' | 'exited' | 'locked' | 'staking'\nexport type TaxTreatment = 'ordinary_income' | 'short_term_cg' | 'long_term_cg' | 'mining_income' | 'airdrop' | 'staking_reward' | 'unknown'\n\nexport interface PortfolioPosition {\n  id: string\n  name: string\n  ticker?: string\n  assetClass: AssetClass\n  status: PositionStatus\n  quantity: number\n  costBasis: number\n  currentValue: number\n  acquiredDate?: string\n  notes: string\n  taxTreatment: TaxTreatment\n  tags: string[]\n  riskScore: number\n  chain?: string\n  wallet?: string\n  isLocked?: boolean\n  unlockDate?: string\n  sourceEnvelope?: string\n}\n\nexport interface OpportunityAnalysis {\n  id: string\n  title: string\n  summary: string\n  status: 'watching' | 'researching' | 'ready' | 'active' | 'exited' | 'passed'\n  estimatedValue: number\n  confidence: number\n  timeHorizon: string\n  taxImplications: string\n  actionItems: string[]\n  sourceRef?: string\n  created: string\n  tags: string[]\n}\n\nexport interface TaxEvent {\n  id: string\n  type: 'airdrop' | 'tge' | 'vest' | 'sale' | 'conversion' | 'staking_reward' | 'mining' | 'income' | 'loss'\n  description: string\n  estimatedAmount: number\n  taxTreatment: TaxTreatment\n  expectedDate?: string\n  realized: boolean\n  positionId?: string\n  notes: string\n}\n\nexport interface PortfolioData {\n  positions: PortfolioPosition[]\n  opportunities: OpportunityAnalysis[]\n  taxEvents: TaxEvent[]\n  envelopeHistory: { imported: string; source: string; positionCount: number; date: string }[]\n}\n\n// ─── Storage Access ─────────────────────────────────────────────────────────\n\nconst STORAGE_KEY = 'fortuna:portfolio-intelligence'\n\nexport function getPortfolioData(): PortfolioData {\n  try {\n    const raw = localStorage.getItem(STORAGE_KEY)\n    if (raw) return JSON.parse(raw)\n  } catch { /* */ }\n  return { positions: [], opportunities: [], taxEvents: [], envelopeHistory: [] }\n}\n\nexport function hasPortfolioData(): boolean {\n  const data = getPortfolioData()\n  return data.positions.length > 0 || data.taxEvents.length > 0 || data.opportunities.length > 0\n}\n\n// ─── Computed Aggregates (UIF L3 — Shared Services) ─────────────────────────\n\nexport interface PortfolioSummary {\n  // Position totals\n  activePositionCount: number\n  totalValue: number\n  totalCostBasis: number\n  unrealizedGainLoss: number\n  unrealizedGainLossPct: number\n\n  // By asset class\n  allocationByClass: Record<AssetClass, { count: number; value: number; pct: number }>\n\n  // Capital gains breakdown\n  shortTermGains: number   // positions held < 1 year with gains\n  longTermGains: number    // positions held >= 1 year with gains\n  shortTermLosses: number\n  longTermLosses: number\n  netCapitalGains: number\n\n  // Income from portfolio (ordinary income items)\n  ordinaryIncomeFromPortfolio: number  // airdrops, mining, staking\n  stakingRewards: number\n  airdropIncome: number\n  miningIncome: number\n\n  // Tax events\n  pendingTaxEvents: number\n  estimatedTaxableFromEvents: number\n\n  // Opportunities\n  activeOpportunities: number\n  watchingOpportunities: number\n  totalPipelineValue: number\n\n  // Risk\n  avgRiskScore: number\n  highRiskPositionCount: number\n  highRiskExposure: number\n  concentrationRisk: number  // largest position as % of total\n\n  // Holding periods\n  positionsNearLTCGThreshold: PortfolioPosition[]  // 10-12 months held\n  positionsAtLTCGRate: number\n\n  // Tax-loss harvesting candidates\n  harvestCandidates: { position: PortfolioPosition; loss: number; treatment: 'short_term' | 'long_term' }[]\n\n  // Wash sale warnings\n  recentExits: PortfolioPosition[]  // exited in last 30 days\n}\n\nexport function computePortfolioSummary(data?: PortfolioData): PortfolioSummary {\n  const portfolio = data || getPortfolioData()\n  const active = portfolio.positions.filter(p => p.status !== 'exited')\n  const totalValue = active.reduce((s, p) => s + p.currentValue, 0)\n  const totalCostBasis = active.reduce((s, p) => s + p.costBasis, 0)\n\n  // Allocation by class\n  const allocationByClass = {} as Record<AssetClass, { count: number; value: number; pct: number }>\n  const classes: AssetClass[] = ['crypto', 'defi', 'nft', 'equity', 'commodity', 'real_estate', 'speculative', 'other']\n  for (const cls of classes) {\n    const positions = active.filter(p => p.assetClass === cls)\n    const value = positions.reduce((s, p) => s + p.currentValue, 0)\n    allocationByClass[cls] = { count: positions.length, value, pct: totalValue > 0 ? (value / totalValue) * 100 : 0 }\n  }\n\n  // Capital gains analysis by holding period\n  const now = new Date()\n  let shortTermGains = 0, longTermGains = 0, shortTermLosses = 0, longTermLosses = 0\n\n  const harvestCandidates: PortfolioSummary['harvestCandidates'] = []\n  const positionsNearLTCGThreshold: PortfolioPosition[] = []\n  let positionsAtLTCGRate = 0\n\n  for (const pos of active) {\n    const gl = pos.currentValue - pos.costBasis\n    const monthsHeld = pos.acquiredDate\n      ? (now.getTime() - new Date(pos.acquiredDate).getTime()) / (1000 * 60 * 60 * 24 * 30)\n      : (pos.taxTreatment === 'long_term_cg' ? 13 : 6) // default assumption\n\n    const isLongTerm = monthsHeld >= 12 || pos.taxTreatment === 'long_term_cg'\n\n    if (isLongTerm) {\n      positionsAtLTCGRate++\n      if (gl >= 0) longTermGains += gl\n      else longTermLosses += Math.abs(gl)\n    } else {\n      if (gl >= 0) shortTermGains += gl\n      else shortTermLosses += Math.abs(gl)\n    }\n\n    // Near LTCG threshold (10-12 months)\n    if (monthsHeld >= 10 && monthsHeld < 12) {\n      positionsNearLTCGThreshold.push(pos)\n    }\n\n    // Tax-loss harvesting candidates (unrealized losses > $100)\n    if (gl < -100 && pos.status === 'active') {\n      harvestCandidates.push({\n        position: pos,\n        loss: Math.abs(gl),\n        treatment: isLongTerm ? 'long_term' : 'short_term',\n      })\n    }\n  }\n\n  // Ordinary income from portfolio\n  let stakingRewards = 0, airdropIncome = 0, miningIncome = 0\n  for (const pos of active) {\n    if (pos.taxTreatment === 'staking_reward') stakingRewards += pos.currentValue\n    else if (pos.taxTreatment === 'airdrop') airdropIncome += pos.currentValue\n    else if (pos.taxTreatment === 'mining_income') miningIncome += pos.currentValue\n  }\n  const ordinaryIncomeFromPortfolio = stakingRewards + airdropIncome + miningIncome\n\n  // Tax events\n  const pendingEvents = portfolio.taxEvents.filter(e => !e.realized)\n  const estimatedTaxableFromEvents = pendingEvents.reduce((s, e) => s + e.estimatedAmount, 0)\n\n  // Opportunities\n  const activeOpps = portfolio.opportunities.filter(o => o.status === 'active')\n  const watchingOpps = portfolio.opportunities.filter(o => o.status === 'watching' || o.status === 'researching')\n  const totalPipelineValue = portfolio.opportunities\n    .filter(o => !['exited', 'passed'].includes(o.status))\n    .reduce((s, o) => s + o.estimatedValue * (o.confidence / 100), 0)\n\n  // Risk\n  const avgRiskScore = active.length > 0 ? active.reduce((s, p) => s + p.riskScore, 0) / active.length : 0\n  const highRisk = active.filter(p => p.riskScore >= 7)\n  const largestPosition = active.reduce((max, p) => p.currentValue > max ? p.currentValue : max, 0)\n  const concentrationRisk = totalValue > 0 ? (largestPosition / totalValue) * 100 : 0\n\n  // Wash sale: recently exited positions\n  const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000)\n  const recentExits = portfolio.positions.filter(p => p.status === 'exited')\n    // In a full implementation, we'd check the exit date. For now flag all exited positions.\n\n  // Sort harvest candidates by loss (largest first)\n  harvestCandidates.sort((a, b) => b.loss - a.loss)\n\n  return {\n    activePositionCount: active.length,\n    totalValue,\n    totalCostBasis,\n    unrealizedGainLoss: totalValue - totalCostBasis,\n    unrealizedGainLossPct: totalCostBasis > 0 ? ((totalValue - totalCostBasis) / totalCostBasis) * 100 : 0,\n    allocationByClass,\n    shortTermGains, longTermGains, shortTermLosses, longTermLosses,\n    netCapitalGains: (shortTermGains + longTermGains) - (shortTermLosses + longTermLosses),\n    ordinaryIncomeFromPortfolio, stakingRewards, airdropIncome, miningIncome,\n    pendingTaxEvents: pendingEvents.length,\n    estimatedTaxableFromEvents,\n    activeOpportunities: activeOpps.length,\n    watchingOpportunities: watchingOpps.length,\n    totalPipelineValue,\n    avgRiskScore,\n    highRiskPositionCount: highRisk.length,\n    highRiskExposure: highRisk.reduce((s, p) => s + p.currentValue, 0),\n    concentrationRisk,\n    positionsNearLTCGThreshold,\n    positionsAtLTCGRate,\n    harvestCandidates,\n    recentExits,\n  }\n}\n\n// ─── Tax Integration Helpers (feed into tax-calculator) ─────────────────────\n\n/** Returns additional income that should be added to tax calculations from portfolio */\nexport function getPortfolioTaxIncome(stateCode: string): {\n  additionalOrdinaryIncome: number   // airdrops, staking, mining\n  shortTermCapGains: number\n  longTermCapGains: number\n  capitalLosses: number\n  netInvestmentIncome: number        // for NIIT calculation\n  estimatedCapGainsTax: number\n  estimatedOrdinaryTax: number\n} {\n  const summary = computePortfolioSummary()\n  const stateRate = STATE_TAX_RATES[stateCode]?.rate || 0\n\n  // Ordinary income additions (taxed at marginal rate)\n  const additionalOrdinaryIncome = summary.ordinaryIncomeFromPortfolio\n\n  // Capital gains (net)\n  const shortTermCapGains = Math.max(0, summary.shortTermGains - summary.shortTermLosses)\n  const longTermCapGains = Math.max(0, summary.longTermGains - summary.longTermLosses)\n\n  // Capital loss deduction (max $3,000/yr, carry forward)\n  const totalLosses = summary.shortTermLosses + summary.longTermLosses\n  const totalGains = summary.shortTermGains + summary.longTermGains\n  const capitalLosses = Math.min(3000, Math.max(0, totalLosses - totalGains))\n\n  // Net investment income (for NIIT — 3.8% on investment income over $200k)\n  const netInvestmentIncome = shortTermCapGains + longTermCapGains + additionalOrdinaryIncome\n\n  // Estimated taxes\n  const estimatedCapGainsTax = (shortTermCapGains * (0.24 + stateRate)) + (longTermCapGains * (0.15 + stateRate))\n  const estimatedOrdinaryTax = additionalOrdinaryIncome * (0.24 + stateRate)\n\n  return {\n    additionalOrdinaryIncome,\n    shortTermCapGains,\n    longTermCapGains,\n    capitalLosses,\n    netInvestmentIncome,\n    estimatedCapGainsTax,\n    estimatedOrdinaryTax,\n  }\n}\n\n// ─── Strategy Helpers ───────────────────────────────────────────────────────\n\n/** Returns portfolio-based strategy opportunities */\nexport function getPortfolioStrategies(marginalRate: number): {\n  id: string\n  title: string\n  impact: number\n  priority: 'critical' | 'high' | 'medium' | 'low'\n  description: string\n  steps: string[]\n  category: string\n}[] {\n  const summary = computePortfolioSummary()\n  const strategies: ReturnType<typeof getPortfolioStrategies> = []\n\n  // Tax-loss harvesting\n  if (summary.harvestCandidates.length > 0) {\n    const totalHarvestable = summary.harvestCandidates.reduce((s, c) => s + c.loss, 0)\n    const taxSavings = Math.min(totalHarvestable, summary.shortTermGains + summary.longTermGains + 3000) * marginalRate\n    strategies.push({\n      id: 'portfolio-tlh',\n      title: 'Tax-Loss Harvesting Opportunity',\n      impact: Math.round(taxSavings),\n      priority: taxSavings > 2000 ? 'critical' : taxSavings > 500 ? 'high' : 'medium',\n      description: `${summary.harvestCandidates.length} position(s) with $${Math.round(totalHarvestable).toLocaleString()} in unrealized losses. Selling these offsets capital gains and up to $3,000 in ordinary income.`,\n      steps: [\n        `Identify ${summary.harvestCandidates.length} positions with unrealized losses`,\n        'Sell losing positions before year-end to realize losses',\n        'Use losses to offset capital gains, then up to $3,000 ordinary income',\n        'Wait 31+ days before repurchasing same asset (wash sale rule)',\n        'Carry forward excess losses to future years',\n      ],\n      category: 'investment',\n    })\n  }\n\n  // Holding period optimization\n  if (summary.positionsNearLTCGThreshold.length > 0) {\n    const positions = summary.positionsNearLTCGThreshold\n    const totalGains = positions.reduce((s, p) => s + Math.max(0, p.currentValue - p.costBasis), 0)\n    const rateDiff = marginalRate - 0.15 // difference between ordinary and LTCG rate\n    const savings = Math.round(totalGains * rateDiff)\n\n    if (savings > 100) {\n      strategies.push({\n        id: 'portfolio-ltcg-wait',\n        title: 'Hold for Long-Term Capital Gains Rate',\n        impact: savings,\n        priority: savings > 3000 ? 'critical' : savings > 1000 ? 'high' : 'medium',\n        description: `${positions.length} position(s) approaching 1-year holding period. Waiting saves ${Math.round(rateDiff * 100)}% on $${Math.round(totalGains).toLocaleString()} in gains.`,\n        steps: positions.map(p => {\n          const daysToLTCG = p.acquiredDate\n            ? Math.max(0, 365 - Math.floor((Date.now() - new Date(p.acquiredDate).getTime()) / (1000 * 60 * 60 * 24)))\n            : 60\n          return `${p.name}: Hold ${daysToLTCG} more days to qualify for 15% LTCG rate`\n        }),\n        category: 'investment',\n      })\n    }\n  }\n\n  // Concentration risk\n  if (summary.concentrationRisk > 50 && summary.totalValue > 10000) {\n    strategies.push({\n      id: 'portfolio-concentration',\n      title: 'Portfolio Concentration Risk',\n      impact: 0,\n      priority: summary.concentrationRisk > 80 ? 'high' : 'medium',\n      description: `Single position represents ${summary.concentrationRisk.toFixed(0)}% of portfolio. Consider diversifying to reduce risk.`,\n      steps: [\n        'Identify tax-efficient exit strategy for concentrated position',\n        'Consider incremental sales spread across tax years',\n        'Evaluate covered calls or protective puts for hedging',\n        'Reinvest into diversified positions',\n      ],\n      category: 'risk',\n    })\n  }\n\n  // Staking/mining income not structured through entity\n  if (summary.stakingRewards + summary.miningIncome > 5000) {\n    const seAmount = summary.stakingRewards + summary.miningIncome\n    const seTax = Math.round(seAmount * 0.153)\n    strategies.push({\n      id: 'portfolio-staking-entity',\n      title: 'Structure Staking/Mining Through Entity',\n      impact: Math.round(seTax * 0.4),\n      priority: seAmount > 20000 ? 'high' : 'medium',\n      description: `$${seAmount.toLocaleString()} in staking/mining income may be subject to SE tax. Structuring through an LLC with S-Corp election could save on self-employment taxes.`,\n      steps: [\n        'Determine if staking income is treated as SE income in your jurisdiction',\n        'If SE-taxable, consider LLC formation for liability protection',\n        'At $50k+ annual staking income, evaluate S-Corp election for SE tax savings',\n        'Track all staking rewards at FMV on date received',\n      ],\n      category: 'entity',\n    })\n  }\n\n  // Large unrealized gains — year-end planning\n  const now = new Date()\n  if (now.getMonth() >= 9 && summary.unrealizedGainLoss > 10000) {\n    strategies.push({\n      id: 'portfolio-yearend',\n      title: 'Year-End Gain/Loss Planning',\n      impact: Math.round(summary.unrealizedGainLoss * 0.05),\n      priority: 'high',\n      description: `$${Math.round(summary.unrealizedGainLoss).toLocaleString()} in unrealized gains. Q4 is the window to strategically realize gains/losses to optimize your tax bracket.`,\n      steps: [\n        'Review all positions for gain/loss harvesting opportunities',\n        'Offset gains with losses to reduce tax liability',\n        'Consider realizing gains that fall within lower tax brackets',\n        'Defer large gains to next year if expecting lower income',\n        'Complete all trades by Dec 31 for current year treatment',\n      ],\n      category: 'tax',\n    })\n  }\n\n  // Pending TGE/airdrop events — estimated tax impact\n  const portfolio = getPortfolioData()\n  const pendingTGEs = portfolio.taxEvents.filter(e => !e.realized && (e.type === 'tge' || e.type === 'airdrop') && e.estimatedAmount > 0)\n  if (pendingTGEs.length > 0) {\n    const totalTGEValue = pendingTGEs.reduce((s, e) => s + e.estimatedAmount, 0)\n    const taxOnTGE = Math.round(totalTGEValue * marginalRate)\n    strategies.push({\n      id: 'portfolio-tge-prep',\n      title: 'Prepare for TGE/Airdrop Tax Events',\n      impact: taxOnTGE,\n      priority: taxOnTGE > 5000 ? 'critical' : 'high',\n      description: `${pendingTGEs.length} pending TGE/airdrop event(s) worth ~$${totalTGEValue.toLocaleString()}. These are taxed as ordinary income at FMV on receipt (~$${taxOnTGE.toLocaleString()} tax liability).`,\n      steps: [\n        'Set aside estimated tax: ' + pendingTGEs.map(e => `${e.description}: ~$${Math.round(e.estimatedAmount * marginalRate).toLocaleString()}`).join(', '),\n        'Document FMV at exact time of receipt (screenshot exchange price)',\n        'Track as ordinary income for the tax year received',\n        'Consider selling portion immediately to cover tax liability',\n        'File estimated quarterly taxes if liability exceeds $1,000',\n      ],\n      category: 'tax',\n    })\n  }\n\n  // High overall risk score\n  if (summary.avgRiskScore > 7 && summary.activePositionCount > 2) {\n    strategies.push({\n      id: 'portfolio-risk-rebalance',\n      title: 'Rebalance High-Risk Portfolio',\n      impact: 0,\n      priority: 'medium',\n      description: `Average risk score is ${summary.avgRiskScore.toFixed(1)}/10 across ${summary.activePositionCount} positions. Consider balancing with lower-risk assets.`,\n      steps: [\n        'Audit highest-risk positions for continued conviction',\n        'Set stop-loss levels for speculative positions',\n        'Allocate portion to stable yield or index positions',\n        'Document investment thesis for each high-risk position',\n      ],\n      category: 'risk',\n    })\n  }\n\n  return strategies\n}\n\n// ─── Proactive Alert Helpers ────────────────────────────────────────────────\n\nexport interface PortfolioAlert {\n  id: string\n  title: string\n  message: string\n  severity: 'urgent' | 'warning' | 'opportunity' | 'info'\n  category: string\n  impact?: number\n  actionView: string\n}\n\nexport function getPortfolioAlerts(): PortfolioAlert[] {\n  const summary = computePortfolioSummary()\n  const portfolio = getPortfolioData()\n  const alerts: PortfolioAlert[] = []\n\n  // LTCG threshold approaching\n  for (const pos of summary.positionsNearLTCGThreshold) {\n    const daysTo = pos.acquiredDate\n      ? Math.max(0, 365 - Math.floor((Date.now() - new Date(pos.acquiredDate).getTime()) / (1000 * 60 * 60 * 24)))\n      : 30\n    const gain = pos.currentValue - pos.costBasis\n    if (gain > 0) {\n      alerts.push({\n        id: `ltcg-${pos.id}`,\n        title: `${pos.name}: ${daysTo} days to LTCG rate`,\n        message: `Hold ${daysTo} more days to save ~${Math.round(gain * 0.09)}% on $${Math.round(gain).toLocaleString()} gain by qualifying for long-term capital gains rate.`,\n        severity: daysTo <= 14 ? 'urgent' : 'warning',\n        category: 'tax',\n        impact: Math.round(gain * 0.09),\n        actionView: 'portfolio',\n      })\n    }\n  }\n\n  // Large unrealized losses (harvesting opportunity)\n  if (summary.harvestCandidates.length > 0) {\n    const total = summary.harvestCandidates.reduce((s, c) => s + c.loss, 0)\n    alerts.push({\n      id: 'tlh-opportunity',\n      title: `Tax-loss harvesting: $${Math.round(total).toLocaleString()} available`,\n      message: `${summary.harvestCandidates.length} position(s) with unrealized losses. Harvest before year-end to offset gains.`,\n      severity: 'opportunity',\n      category: 'tax',\n      impact: Math.round(total * 0.24),\n      actionView: 'portfolio',\n    })\n  }\n\n  // Pending TGE events approaching\n  for (const evt of portfolio.taxEvents.filter(e => !e.realized && e.expectedDate)) {\n    const daysUntil = Math.floor((new Date(evt.expectedDate!).getTime() - Date.now()) / (1000 * 60 * 60 * 24))\n    if (daysUntil >= 0 && daysUntil <= 30) {\n      alerts.push({\n        id: `event-${evt.id}`,\n        title: `${evt.description}: ${daysUntil} days away`,\n        message: `Estimated ${evt.estimatedAmount > 0 ? '$' + evt.estimatedAmount.toLocaleString() : 'TBD'} taxable event. Prepare by setting aside estimated taxes and documenting FMV.`,\n        severity: daysUntil <= 7 ? 'urgent' : 'warning',\n        category: 'tax',\n        impact: evt.estimatedAmount,\n        actionView: 'portfolio',\n      })\n    }\n  }\n\n  // Concentration risk\n  if (summary.concentrationRisk > 60 && summary.totalValue > 5000) {\n    alerts.push({\n      id: 'concentration-risk',\n      title: `Portfolio concentration: ${summary.concentrationRisk.toFixed(0)}% in single position`,\n      message: 'High concentration risk. Consider diversifying to protect against significant loss in any single asset.',\n      severity: summary.concentrationRisk > 80 ? 'warning' : 'info',\n      category: 'risk',\n      actionView: 'portfolio',\n    })\n  }\n\n  // Quarterly estimated tax reminder for portfolio income\n  const qTaxIncome = summary.ordinaryIncomeFromPortfolio + summary.shortTermGains\n  if (qTaxIncome > 4000) {\n    const now = new Date()\n    const quarterDeadlines = [\n      { q: 'Q1', month: 3, day: 15 },\n      { q: 'Q2', month: 5, day: 15 },\n      { q: 'Q3', month: 8, day: 15 },\n      { q: 'Q4', month: 0, day: 15 },\n    ]\n    for (const dl of quarterDeadlines) {\n      const deadline = new Date(now.getFullYear() + (dl.month === 0 ? 1 : 0), dl.month, dl.day)\n      const daysUntil = Math.floor((deadline.getTime() - now.getTime()) / (1000 * 60 * 60 * 24))\n      if (daysUntil > 0 && daysUntil <= 21) {\n        alerts.push({\n          id: `portfolio-est-tax-${dl.q}`,\n          title: `${dl.q} estimated tax due in ${daysUntil} days`,\n          message: `Portfolio income of ~$${Math.round(qTaxIncome).toLocaleString()} may require estimated quarterly payment to avoid underpayment penalty.`,\n          severity: daysUntil <= 7 ? 'urgent' : 'warning',\n          category: 'deadline',\n          actionView: 'portfolio',\n        })\n        break // only show nearest deadline\n      }\n    }\n  }\n\n  return alerts\n}\n\n// ─── AI Context Builder ─────────────────────────────────────────────────────\n\nexport function buildPortfolioAIContext(): string {\n  const summary = computePortfolioSummary()\n  const portfolio = getPortfolioData()\n\n  if (summary.activePositionCount === 0 && portfolio.opportunities.length === 0) {\n    return ''\n  }\n\n  const lines: string[] = [\n    '\\n════════════════════════════════════════════════════════',\n    'PORTFOLIO INTELLIGENCE',\n    '════════════════════════════════════════════════════════',\n    `Active Positions: ${summary.activePositionCount}`,\n    `Total Portfolio Value: $${Math.round(summary.totalValue).toLocaleString()}`,\n    `Total Cost Basis: $${Math.round(summary.totalCostBasis).toLocaleString()}`,\n    `Unrealized Gain/Loss: ${summary.unrealizedGainLoss >= 0 ? '+' : ''}$${Math.round(summary.unrealizedGainLoss).toLocaleString()} (${summary.unrealizedGainLossPct.toFixed(1)}%)`,\n    '',\n    'CAPITAL GAINS EXPOSURE:',\n    `  Short-term gains: $${Math.round(summary.shortTermGains).toLocaleString()} (taxed at ordinary rates)`,\n    `  Long-term gains: $${Math.round(summary.longTermGains).toLocaleString()} (taxed at 0/15/20%)`,\n    `  Unrealized losses: $${Math.round(summary.shortTermLosses + summary.longTermLosses).toLocaleString()} (harvestable)`,\n    `  Net capital gains: $${Math.round(summary.netCapitalGains).toLocaleString()}`,\n    '',\n    'PORTFOLIO INCOME (Ordinary):',\n    `  Staking rewards: $${Math.round(summary.stakingRewards).toLocaleString()}`,\n    `  Airdrop income: $${Math.round(summary.airdropIncome).toLocaleString()}`,\n    `  Mining income: $${Math.round(summary.miningIncome).toLocaleString()}`,\n    `  Total: $${Math.round(summary.ordinaryIncomeFromPortfolio).toLocaleString()}/year`,\n  ]\n\n  // Positions detail\n  if (portfolio.positions.length > 0) {\n    lines.push('', 'POSITIONS:')\n    for (const pos of portfolio.positions.filter(p => p.status !== 'exited').slice(0, 15)) {\n      const gl = pos.currentValue - pos.costBasis\n      lines.push(`  - ${pos.name}${pos.ticker ? ' (' + pos.ticker + ')' : ''}: $${Math.round(pos.currentValue).toLocaleString()} | ${gl >= 0 ? '+' : ''}$${Math.round(gl).toLocaleString()} | ${pos.assetClass} | Risk: ${pos.riskScore}/10 | Tax: ${pos.taxTreatment.replace(/_/g, ' ')}`)\n    }\n  }\n\n  // Tax events\n  const pendingEvents = portfolio.taxEvents.filter(e => !e.realized)\n  if (pendingEvents.length > 0) {\n    lines.push('', 'PENDING TAX EVENTS:')\n    for (const evt of pendingEvents) {\n      lines.push(`  - ${evt.description}: ~$${Math.round(evt.estimatedAmount).toLocaleString()} (${evt.taxTreatment.replace(/_/g, ' ')})${evt.expectedDate ? ' — expected ' + evt.expectedDate : ''}`)\n    }\n  }\n\n  // Opportunities\n  const activeOpps = portfolio.opportunities.filter(o => !['exited', 'passed'].includes(o.status))\n  if (activeOpps.length > 0) {\n    lines.push('', 'OPPORTUNITY PIPELINE:')\n    for (const opp of activeOpps.slice(0, 8)) {\n      lines.push(`  - ${opp.title}: ${opp.status} | ~$${Math.round(opp.estimatedValue).toLocaleString()} at ${opp.confidence}% confidence | Tax: ${opp.taxImplications || 'TBD'}`)\n    }\n  }\n\n  // Key risk indicators\n  lines.push('', 'RISK PROFILE:')\n  lines.push(`  Avg risk score: ${summary.avgRiskScore.toFixed(1)}/10`)\n  lines.push(`  High-risk positions: ${summary.highRiskPositionCount} ($${Math.round(summary.highRiskExposure).toLocaleString()})`)\n  lines.push(`  Concentration: ${summary.concentrationRisk.toFixed(0)}% in largest position`)\n\n  // Harvesting\n  if (summary.harvestCandidates.length > 0) {\n    lines.push('', 'TAX-LOSS HARVESTING CANDIDATES:')\n    for (const c of summary.harvestCandidates.slice(0, 5)) {\n      lines.push(`  - ${c.position.name}: -$${Math.round(c.loss).toLocaleString()} (${c.treatment.replace('_', '-')})`)\n    }\n  }\n\n  // Holding period alerts\n  if (summary.positionsNearLTCGThreshold.length > 0) {\n    lines.push('', 'APPROACHING LTCG THRESHOLD:')\n    for (const p of summary.positionsNearLTCGThreshold) {\n      const daysTo = p.acquiredDate\n        ? Math.max(0, 365 - Math.floor((Date.now() - new Date(p.acquiredDate).getTime()) / (1000 * 60 * 60 * 24)))\n        : 30\n      lines.push(`  - ${p.name}: ${daysTo} days until long-term rate`)\n    }\n  }\n\n  return lines.join('\\n')\n}\n\n// ─── Health Score Dimension ─────────────────────────────────────────────────\n\nexport function scorePortfolioHealth(): {\n  score: number\n  grade: string\n  factors: { name: string; score: number; maxScore: number; detail: string }[]\n} {\n  const summary = computePortfolioSummary()\n\n  if (summary.activePositionCount === 0) {\n    return { score: -1, grade: 'N/A', factors: [] } // -1 = not applicable\n  }\n\n  const factors: { name: string; score: number; maxScore: number; detail: string }[] = []\n\n  // Diversification (25 pts)\n  const classesUsed = Object.values(summary.allocationByClass).filter(a => a.count > 0).length\n  const diversScore = Math.min(25, classesUsed * 5 + (summary.concentrationRisk < 40 ? 10 : summary.concentrationRisk < 60 ? 5 : 0))\n  factors.push({ name: 'Diversification', score: diversScore, maxScore: 25, detail: `${classesUsed} asset classes, ${summary.concentrationRisk.toFixed(0)}% concentration` })\n\n  // Risk management (25 pts)\n  const riskScore = summary.avgRiskScore <= 4 ? 25 : summary.avgRiskScore <= 6 ? 18 : summary.avgRiskScore <= 8 ? 10 : 5\n  factors.push({ name: 'Risk Management', score: riskScore, maxScore: 25, detail: `Avg risk ${summary.avgRiskScore.toFixed(1)}/10, ${summary.highRiskPositionCount} high-risk` })\n\n  // Tax efficiency (25 pts)\n  const ltcgPct = summary.activePositionCount > 0 ? (summary.positionsAtLTCGRate / summary.activePositionCount) * 100 : 0\n  const harvestUsed = summary.harvestCandidates.length === 0 ? 10 : 0\n  const taxEffScore = Math.min(25, Math.round(ltcgPct / 4) + harvestUsed + (summary.pendingTaxEvents <= 2 ? 5 : 0))\n  factors.push({ name: 'Tax Efficiency', score: taxEffScore, maxScore: 25, detail: `${ltcgPct.toFixed(0)}% at LTCG rate, ${summary.harvestCandidates.length} harvest candidates` })\n\n  // Documentation / tracking (25 pts)\n  const posWithBasis = summary.activePositionCount > 0\n    ? portfolio().positions.filter(p => p.status !== 'exited' && p.costBasis > 0).length / summary.activePositionCount\n    : 0\n  const posWithDates = summary.activePositionCount > 0\n    ? portfolio().positions.filter(p => p.status !== 'exited' && p.acquiredDate).length / summary.activePositionCount\n    : 0\n  const docScore = Math.round((posWithBasis * 12 + posWithDates * 13))\n  factors.push({ name: 'Documentation', score: Math.min(25, docScore), maxScore: 25, detail: `${Math.round(posWithBasis * 100)}% with cost basis, ${Math.round(posWithDates * 100)}% with dates` })\n\n  const total = factors.reduce((s, f) => s + f.score, 0)\n  const grade = total >= 85 ? 'A' : total >= 70 ? 'B' : total >= 55 ? 'C' : total >= 40 ? 'D' : 'F'\n\n  return { score: total, grade, factors }\n}\n\nfunction portfolio() { return getPortfolioData() }\n\n// ─── CPA Export Helpers ─────────────────────────────────────────────────────\n\nexport interface Form8949Line {\n  description: string\n  dateAcquired: string\n  dateSold: string\n  proceeds: number\n  costBasis: number\n  gainLoss: number\n  holdingPeriod: 'short' | 'long'\n}\n\nexport function generateForm8949Data(): {\n  lines: Form8949Line[]\n  shortTermTotal: { proceeds: number; basis: number; gainLoss: number }\n  longTermTotal: { proceeds: number; basis: number; gainLoss: number }\n  netCapitalGainLoss: number\n} {\n  const data = getPortfolioData()\n  const exited = data.positions.filter(p => p.status === 'exited')\n  const lines: Form8949Line[] = []\n\n  let stProceeds = 0, stBasis = 0, stGL = 0\n  let ltProceeds = 0, ltBasis = 0, ltGL = 0\n\n  for (const pos of exited) {\n    const gl = pos.currentValue - pos.costBasis\n    const isLT = pos.taxTreatment === 'long_term_cg' || (pos.acquiredDate && (Date.now() - new Date(pos.acquiredDate).getTime()) > 365 * 24 * 60 * 60 * 1000)\n\n    const line: Form8949Line = {\n      description: `${pos.name}${pos.ticker ? ' (' + pos.ticker + ')' : ''} — ${pos.quantity} units`,\n      dateAcquired: pos.acquiredDate || 'Various',\n      dateSold: 'Various',\n      proceeds: pos.currentValue,\n      costBasis: pos.costBasis,\n      gainLoss: gl,\n      holdingPeriod: isLT ? 'long' : 'short',\n    }\n    lines.push(line)\n\n    if (isLT) { ltProceeds += pos.currentValue; ltBasis += pos.costBasis; ltGL += gl }\n    else { stProceeds += pos.currentValue; stBasis += pos.costBasis; stGL += gl }\n  }\n\n  return {\n    lines,\n    shortTermTotal: { proceeds: stProceeds, basis: stBasis, gainLoss: stGL },\n    longTermTotal: { proceeds: ltProceeds, basis: ltBasis, gainLoss: ltGL },\n    netCapitalGainLoss: stGL + ltGL,\n  }\n}\n\n// ─── Scenario Modeler Helpers ───────────────────────────────────────────────\n\n/** Generate smart scenarios from portfolio positions */\nexport function getPortfolioScenarios(): {\n  name: string\n  description: string\n  icon: string\n  additionalIncome: number\n  additionalDeduction: number\n  capitalGains: { shortTerm: number; longTerm: number }\n}[] {\n  const summary = computePortfolioSummary()\n  const data = getPortfolioData()\n  const scenarios: ReturnType<typeof getPortfolioScenarios> = []\n\n  // \"Sell all positions\" scenario\n  if (summary.totalValue > 1000) {\n    scenarios.push({\n      name: 'Liquidate Portfolio',\n      description: `Sell all ${summary.activePositionCount} positions for $${Math.round(summary.totalValue).toLocaleString()}`,\n      icon: '💰',\n      additionalIncome: summary.ordinaryIncomeFromPortfolio,\n      additionalDeduction: 0,\n      capitalGains: { shortTerm: summary.shortTermGains - summary.shortTermLosses, longTerm: summary.longTermGains - summary.longTermLosses },\n    })\n  }\n\n  // \"TGE happens\" scenario\n  const tgeEvents = data.taxEvents.filter(e => !e.realized && (e.type === 'tge' || e.type === 'airdrop') && e.estimatedAmount > 0)\n  if (tgeEvents.length > 0) {\n    const totalTGE = tgeEvents.reduce((s, e) => s + e.estimatedAmount, 0)\n    scenarios.push({\n      name: 'All TGEs Realized',\n      description: `All ${tgeEvents.length} pending TGE/airdrop events trigger (~$${Math.round(totalTGE).toLocaleString()})`,\n      icon: '🚀',\n      additionalIncome: totalTGE,\n      additionalDeduction: 0,\n      capitalGains: { shortTerm: 0, longTerm: 0 },\n    })\n  }\n\n  // \"Harvest all losses\" scenario\n  if (summary.harvestCandidates.length > 0) {\n    const totalLoss = summary.harvestCandidates.reduce((s, c) => s + c.loss, 0)\n    scenarios.push({\n      name: 'Harvest All Losses',\n      description: `Realize $${Math.round(totalLoss).toLocaleString()} in losses across ${summary.harvestCandidates.length} positions`,\n      icon: '🌾',\n      additionalIncome: 0,\n      additionalDeduction: Math.min(totalLoss, summary.shortTermGains + summary.longTermGains + 3000),\n      capitalGains: { shortTerm: -summary.shortTermLosses, longTerm: -summary.longTermLosses },\n    })\n  }\n\n  return scenarios\n}\n\n// ─── Dashboard Widget Data ──────────────────────────────────────────────────\n\nexport interface PortfolioDashboardWidget {\n  totalValue: number\n  gainLoss: number\n  gainLossPct: number\n  positionCount: number\n  topPositions: { name: string; value: number; pct: number; riskScore: number }[]\n  pendingEvents: number\n  alertCount: number\n  healthScore: number\n}\n\nexport function getPortfolioDashboardData(): PortfolioDashboardWidget | null {\n  const summary = computePortfolioSummary()\n  if (summary.activePositionCount === 0) return null\n\n  const data = getPortfolioData()\n  const active = data.positions.filter(p => p.status !== 'exited')\n    .sort((a, b) => b.currentValue - a.currentValue)\n\n  const topPositions = active.slice(0, 4).map(p => ({\n    name: p.name,\n    value: p.currentValue,\n    pct: summary.totalValue > 0 ? (p.currentValue / summary.totalValue) * 100 : 0,\n    riskScore: p.riskScore,\n  }))\n\n  const healthResult = scorePortfolioHealth()\n  const alerts = getPortfolioAlerts()\n\n  return {\n    totalValue: summary.totalValue,\n    gainLoss: summary.unrealizedGainLoss,\n    gainLossPct: summary.unrealizedGainLossPct,\n    positionCount: summary.activePositionCount,\n    topPositions,\n    pendingEvents: summary.pendingTaxEvents,\n    alertCount: alerts.filter(a => a.severity === 'urgent' || a.severity === 'warning').length,\n    healthScore: healthResult.score,\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\proactive-intelligence.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'profile' is assigned a value but never used.","line":96,"column":36,"nodeType":"Identifier","messageId":"unusedVar","endLine":96,"endColumn":43},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'deadlines' is assigned a value but never used.","line":312,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":312,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'vehicleDeduction' is assigned a value but never used.","line":476,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":476,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'potentialSavings' is assigned a value but never used.","line":527,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":527,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'totalPotential' is assigned a value but never used.","line":584,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":584,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'annualizedIncome' is assigned a value but never used.","line":621,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":621,"endColumn":27}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine v5 - Proactive Intelligence System\n * Monitors financial state and generates time-sensitive, context-aware alerts.\n * This is the core differentiator — transforms Fortuna from a tool you consult\n * into a system that watches your back.\n */\n\nimport type { FortunaState } from './storage'\nimport { generateTaxReport, calculateSCorpSavings, calculateMaxSEPIRA, calculateMaxSolo401k, STATE_TAX_RATES } from './tax-calculator'\nimport { hasPortfolioData, getPortfolioAlerts } from './portfolio-bridge'\n\n// ==================== Types ====================\n\nexport type AlertSeverity = 'urgent' | 'warning' | 'opportunity' | 'info'\nexport type AlertCategory = 'tax' | 'entity' | 'audit' | 'cashflow' | 'retirement' | 'deadline' | 'strategy'\n\nexport interface ProactiveAlert {\n  id: string\n  title: string\n  message: string\n  severity: AlertSeverity\n  category: AlertCategory\n  impact?: number\n  impactLabel?: string\n  action?: string\n  actionView?: string // which view to navigate to\n  deadline?: string // ISO date string\n  daysUntilDeadline?: number\n  reasoning: string\n  dismissed?: boolean\n  createdAt: string\n  expiresAt?: string\n}\n\nexport interface TaxDeadline {\n  id: string\n  name: string\n  date: string\n  description: string\n  category: 'filing' | 'payment' | 'election' | 'extension' | 'contribution'\n  appliesTo: string[] // entity types or 'all'\n  recurring: boolean\n  priority: AlertSeverity\n  actionItems: string[]\n}\n\nexport interface QuarterContext {\n  quarter: 1 | 2 | 3 | 4\n  month: number\n  dayOfMonth: number\n  daysLeftInQuarter: number\n  daysLeftInYear: number\n  yearProgress: number // 0-1\n  isQ4Rush: boolean\n  isYearEnd: boolean\n}\n\n// ==================== Quarter Context ====================\n\nexport function getQuarterContext(now: Date = new Date()): QuarterContext {\n  const month = now.getMonth() + 1\n  const dayOfMonth = now.getDate()\n  const year = now.getFullYear()\n  \n  const quarter = (Math.ceil(month / 3)) as 1 | 2 | 3 | 4\n  \n  const quarterEndDates = [\n    new Date(year, 2, 31),  // Q1: Mar 31\n    new Date(year, 5, 30),  // Q2: Jun 30\n    new Date(year, 8, 30),  // Q3: Sep 30\n    new Date(year, 11, 31), // Q4: Dec 31\n  ]\n  \n  const yearEnd = new Date(year, 11, 31)\n  const dayOfYear = Math.floor((now.getTime() - new Date(year, 0, 1).getTime()) / 86400000) + 1\n  \n  const daysLeftInQuarter = Math.max(0, Math.ceil((quarterEndDates[quarter - 1].getTime() - now.getTime()) / 86400000))\n  const daysLeftInYear = Math.max(0, Math.ceil((yearEnd.getTime() - now.getTime()) / 86400000))\n  \n  return {\n    quarter,\n    month,\n    dayOfMonth,\n    daysLeftInQuarter,\n    daysLeftInYear,\n    yearProgress: dayOfYear / 365,\n    isQ4Rush: quarter === 4 && month >= 11,\n    isYearEnd: month === 12 && dayOfMonth >= 15,\n  }\n}\n\n// ==================== Tax Calendar ====================\n\nexport function getTaxDeadlines(state: FortunaState, year: number = new Date().getFullYear()): TaxDeadline[] {\n  const deadlines: TaxDeadline[] = []\n  const { entities, incomeStreams, profile } = state\n  \n  const hasSelfEmployment = incomeStreams.some(s => ['business', 'freelance'].includes(s.type) && s.isActive)\n  const hasScorp = entities.some(e => (e.type === 'llc_scorp' || e.type === 'scorp') && e.isActive)\n  const hasCcorp = entities.some(e => e.type === 'ccorp' && e.isActive)\n  const hasPartnership = entities.some(e => e.type === 'partnership' && e.isActive)\n  \n  // Q1 Estimated Tax Payment\n  deadlines.push({\n    id: 'est-q1',\n    name: 'Q1 Estimated Tax Payment',\n    date: `${year}-04-15`,\n    description: 'First quarterly estimated tax payment due for current tax year',\n    category: 'payment',\n    appliesTo: ['all'],\n    recurring: true,\n    priority: 'urgent',\n    actionItems: ['Calculate estimated quarterly payment', 'File Form 1040-ES', 'Pay via IRS Direct Pay or EFTPS'],\n  })\n  \n  // Personal Tax Filing\n  deadlines.push({\n    id: 'filing-1040',\n    name: 'Personal Tax Return (1040)',\n    date: `${year}-04-15`,\n    description: 'Federal individual income tax return due',\n    category: 'filing',\n    appliesTo: ['all'],\n    recurring: true,\n    priority: 'urgent',\n    actionItems: ['Gather all W-2s, 1099s, and K-1s', 'Compile deduction documentation', 'File Form 1040 or request extension (Form 4868)'],\n  })\n  \n  // Q2 Estimated Tax\n  deadlines.push({\n    id: 'est-q2',\n    name: 'Q2 Estimated Tax Payment',\n    date: `${year}-06-15`,\n    description: 'Second quarterly estimated tax payment',\n    category: 'payment',\n    appliesTo: ['all'],\n    recurring: true,\n    priority: 'urgent',\n    actionItems: ['Review Q1 actual vs estimated income', 'Adjust payment if income changed', 'Pay via IRS Direct Pay or EFTPS'],\n  })\n  \n  // Q3 Estimated Tax\n  deadlines.push({\n    id: 'est-q3',\n    name: 'Q3 Estimated Tax Payment',\n    date: `${year}-09-15`,\n    description: 'Third quarterly estimated tax payment',\n    category: 'payment',\n    appliesTo: ['all'],\n    recurring: true,\n    priority: 'urgent',\n    actionItems: ['Review YTD income trends', 'Calculate adjusted payment amount', 'Pay via IRS Direct Pay or EFTPS'],\n  })\n  \n  // Extension deadline\n  deadlines.push({\n    id: 'extension-1040',\n    name: 'Extended 1040 Filing Deadline',\n    date: `${year}-10-15`,\n    description: 'Deadline for filing if extension was requested',\n    category: 'extension',\n    appliesTo: ['all'],\n    recurring: true,\n    priority: 'urgent',\n    actionItems: ['Finalize and file Form 1040', 'Note: taxes were still due April 15'],\n  })\n  \n  // Q4 Estimated Tax\n  deadlines.push({\n    id: 'est-q4',\n    name: 'Q4 Estimated Tax Payment',\n    date: `${year + 1}-01-15`,\n    description: 'Fourth quarterly estimated tax payment for prior year',\n    category: 'payment',\n    appliesTo: ['all'],\n    recurring: true,\n    priority: 'urgent',\n    actionItems: ['Calculate final quarterly payment', 'Consider paying entire balance to avoid underpayment penalty', 'Pay via IRS Direct Pay or EFTPS'],\n  })\n  \n  // S-Corp specific\n  if (hasScorp) {\n    deadlines.push({\n      id: 'filing-1120s',\n      name: 'S-Corp Tax Return (1120-S)',\n      date: `${year}-03-15`,\n      description: 'S-Corporation tax return and K-1 generation deadline',\n      category: 'filing',\n      appliesTo: ['scorp', 'llc_scorp'],\n      recurring: true,\n      priority: 'urgent',\n      actionItems: ['Prepare Form 1120-S', 'Generate K-1 for shareholders', 'File or extend (Form 7004)'],\n    })\n    \n    // S-Corp election deadline (for new entities)\n    deadlines.push({\n      id: 'election-scorp',\n      name: 'S-Corp Election Deadline (2553)',\n      date: `${year}-03-15`,\n      description: 'Deadline for S-Corp election to be effective for current tax year',\n      category: 'election',\n      appliesTo: ['scorp', 'llc_scorp'],\n      recurring: true,\n      priority: 'warning',\n      actionItems: ['File Form 2553 with IRS', 'All shareholders must consent', 'Must be filed within 75 days of formation or by March 15'],\n    })\n  }\n  \n  // C-Corp specific\n  if (hasCcorp) {\n    deadlines.push({\n      id: 'filing-1120',\n      name: 'C-Corp Tax Return (1120)',\n      date: `${year}-04-15`,\n      description: 'C-Corporation tax return deadline',\n      category: 'filing',\n      appliesTo: ['ccorp'],\n      recurring: true,\n      priority: 'urgent',\n      actionItems: ['Prepare Form 1120', 'Calculate corporate tax liability', 'File or extend (Form 7004)'],\n    })\n  }\n  \n  // Partnership specific\n  if (hasPartnership) {\n    deadlines.push({\n      id: 'filing-1065',\n      name: 'Partnership Return (1065)',\n      date: `${year}-03-15`,\n      description: 'Partnership return and K-1 generation deadline',\n      category: 'filing',\n      appliesTo: ['partnership'],\n      recurring: true,\n      priority: 'urgent',\n      actionItems: ['Prepare Form 1065', 'Generate K-1s for all partners', 'File or extend (Form 7004)'],\n    })\n  }\n  \n  // Retirement contribution deadlines\n  if (hasSelfEmployment || hasScorp) {\n    deadlines.push({\n      id: 'contrib-sep',\n      name: 'SEP-IRA Contribution Deadline',\n      date: `${year}-04-15`,\n      description: 'SEP-IRA contributions due (or extension deadline if filed)',\n      category: 'contribution',\n      appliesTo: ['all'],\n      recurring: true,\n      priority: 'opportunity',\n      actionItems: ['Calculate maximum SEP-IRA contribution', 'Make contribution before filing deadline', 'Deadline extends to Oct 15 if extension filed'],\n    })\n    \n    deadlines.push({\n      id: 'contrib-solo401k',\n      name: 'Solo 401(k) Employee Contribution Deadline',\n      date: `${year}-12-31`,\n      description: 'Employee salary deferral contributions must be made by year-end',\n      category: 'contribution',\n      appliesTo: ['all'],\n      recurring: true,\n      priority: 'warning',\n      actionItems: ['Maximize employee deferral ($23,500 limit for 2025, $24,000 for 2026)', 'Catch-up contribution if age 50+ ($7,500 additional)', 'Employer contribution due at tax filing deadline'],\n    })\n  }\n  \n  // Year-end planning\n  deadlines.push({\n    id: 'yearend-planning',\n    name: 'Year-End Tax Planning Window',\n    date: `${year}-12-01`,\n    description: 'Final window for tax-reduction strategies before year-end',\n    category: 'payment',\n    appliesTo: ['all'],\n    recurring: true,\n    priority: 'warning',\n    actionItems: [\n      'Accelerate deductible expenses into current year',\n      'Defer income to next year if beneficial',\n      'Harvest tax losses in investment portfolio',\n      'Make charitable contributions',\n      'Purchase business equipment (Section 179)',\n      'Review retirement contribution maximums',\n    ],\n  })\n  \n  // Roth IRA contribution deadline\n  deadlines.push({\n    id: 'contrib-roth',\n    name: 'IRA/Roth IRA Contribution Deadline',\n    date: `${year}-04-15`,\n    description: 'Last day to make IRA contributions for prior tax year',\n    category: 'contribution',\n    appliesTo: ['all'],\n    recurring: true,\n    priority: 'opportunity',\n    actionItems: ['Max out Roth IRA if eligible ($7,000 limit, $8,000 if 50+)', 'Consider backdoor Roth if over income limits', 'Traditional IRA if not covered by employer plan'],\n  })\n  \n  // Sort by date\n  deadlines.sort((a, b) => a.date.localeCompare(b.date))\n  \n  return deadlines\n}\n\n// ==================== Proactive Alerts Generation ====================\n\nexport function generateProactiveAlerts(state: FortunaState): ProactiveAlert[] {\n  const alerts: ProactiveAlert[] = []\n  const now = new Date()\n  const ctx = getQuarterContext(now)\n  const report = generateTaxReport(state)\n  const deadlines = getTaxDeadlines(state)\n  const { profile, incomeStreams, expenses, deductions, entities } = state\n  \n  const totalIncome = incomeStreams.filter(s => s.isActive).reduce((sum, s) => sum + s.annualAmount, 0)\n  const selfEmploymentIncome = incomeStreams\n    .filter(s => ['business', 'freelance'].includes(s.type) && s.isActive)\n    .reduce((sum, s) => sum + s.annualAmount, 0)\n  const totalDeductibleExpenses = expenses.filter(e => e.isDeductible).reduce((sum, e) => sum + (e.annualAmount * e.deductionPct / 100), 0)\n  const netSEIncome = selfEmploymentIncome - totalDeductibleExpenses\n  \n  // ===== 1. BRACKET CROSSING DETECTION =====\n  const brackets2025 = [\n    { rate: 10, single: 11925, mfj: 23850 },\n    { rate: 12, single: 48475, mfj: 96950 },\n    { rate: 22, single: 103350, mfj: 206700 },\n    { rate: 24, single: 197300, mfj: 394600 },\n    { rate: 32, single: 250525, mfj: 501050 },\n    { rate: 35, single: 626350, mfj: 1252700 },\n    { rate: 37, single: Infinity, mfj: Infinity },\n  ]\n  \n  const isJoint = profile.filingStatus === 'married_joint'\n  const taxableIncome = report.taxableIncome\n  const projectedYearEnd = taxableIncome * (1 / Math.max(ctx.yearProgress, 0.1))\n  \n  for (let i = 0; i < brackets2025.length - 1; i++) {\n    const threshold = isJoint ? brackets2025[i].mfj : brackets2025[i].single\n    const nextRate = brackets2025[i + 1].rate\n    const currentRate = brackets2025[i].rate\n    \n    if (taxableIncome < threshold && projectedYearEnd > threshold) {\n      const overshoot = projectedYearEnd - threshold\n      const additionalTax = overshoot * ((nextRate - currentRate) / 100)\n      \n      alerts.push({\n        id: `bracket-cross-${nextRate}`,\n        title: `Projected ${nextRate}% Bracket Crossing`,\n        message: `At current income pace, you'll exceed the ${currentRate}% bracket by ~$${Math.round(overshoot).toLocaleString()} by year-end. This means ~$${Math.round(additionalTax).toLocaleString()} in additional tax at the higher rate.`,\n        severity: additionalTax > 5000 ? 'urgent' : 'warning',\n        category: 'tax',\n        impact: additionalTax,\n        impactLabel: `$${Math.round(additionalTax).toLocaleString()} additional tax`,\n        action: 'Review deduction acceleration strategies',\n        actionView: 'tax',\n        reasoning: `Current taxable income: $${Math.round(taxableIncome).toLocaleString()}. Year-end projection: $${Math.round(projectedYearEnd).toLocaleString()}. ${currentRate}% bracket ceiling: $${threshold.toLocaleString()}.`,\n        createdAt: now.toISOString(),\n      })\n      break\n    }\n  }\n  \n  // ===== 2. ESTIMATED TAX PAYMENT ALERTS =====\n  if (selfEmploymentIncome > 0 || totalIncome > 100000) {\n    const quarterlyEstimate = Math.round(report.totalFederalTax / 4)\n    \n    // Find next estimated tax deadline\n    const estDeadlines = ['04-15', '06-15', '09-15', '01-15']\n    const estMonths = [4, 6, 9, 13] // 13 = next Jan\n    \n    for (let i = 0; i < estDeadlines.length; i++) {\n      const deadlineYear = estMonths[i] === 13 ? now.getFullYear() + 1 : now.getFullYear()\n      const deadlineMonth = estMonths[i] === 13 ? 1 : estMonths[i]\n      const deadline = new Date(deadlineYear, deadlineMonth - 1, 15)\n      const daysUntil = Math.ceil((deadline.getTime() - now.getTime()) / 86400000)\n      \n      if (daysUntil > 0 && daysUntil <= 45) {\n        alerts.push({\n          id: `est-tax-q${i + 1}`,\n          title: `Q${i + 1} Estimated Tax Due in ${daysUntil} Days`,\n          message: `Your estimated quarterly tax payment of ~$${quarterlyEstimate.toLocaleString()} is due ${deadline.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}. Late payment triggers underpayment penalties.`,\n          severity: daysUntil <= 14 ? 'urgent' : 'warning',\n          category: 'deadline',\n          impact: quarterlyEstimate,\n          impactLabel: `$${quarterlyEstimate.toLocaleString()} due`,\n          action: 'Generate 1040-ES voucher',\n          actionView: 'documents',\n          deadline: deadline.toISOString(),\n          daysUntilDeadline: daysUntil,\n          reasoning: `Total estimated federal tax: $${Math.round(report.totalFederalTax).toLocaleString()} ÷ 4 = $${quarterlyEstimate.toLocaleString()} per quarter.`,\n          createdAt: now.toISOString(),\n        })\n        break\n      }\n    }\n  }\n  \n  // ===== 3. RETIREMENT CONTRIBUTION OPTIMIZATION =====\n  const retirementDeductions = deductions.filter(d => d.category === 'retirement')\n  const currentRetirement = retirementDeductions.reduce((sum, d) => sum + d.amount, 0)\n  \n  if (netSEIncome > 30000) {\n    const maxSEP = calculateMaxSEPIRA(netSEIncome)\n    const max401k = calculateMaxSolo401k(netSEIncome, profile.age)\n    const bestOption = max401k.total > maxSEP ? { name: 'Solo 401(k)', max: max401k.total, detail: max401k } : { name: 'SEP-IRA', max: maxSEP, detail: null }\n    \n    if (currentRetirement < bestOption.max * 0.5) {\n      const gap = bestOption.max - currentRetirement\n      const taxSavings = gap * (report.effectiveRate / 100)\n      \n      alerts.push({\n        id: 'retirement-gap',\n        title: 'Retirement Contribution Gap',\n        message: `You're contributing $${currentRetirement.toLocaleString()} but could contribute up to $${Math.round(bestOption.max).toLocaleString()} to a ${bestOption.name}. The additional $${Math.round(gap).toLocaleString()} would save ~$${Math.round(taxSavings).toLocaleString()} in taxes this year.`,\n        severity: gap > 20000 ? 'warning' : 'opportunity',\n        category: 'retirement',\n        impact: taxSavings,\n        impactLabel: `$${Math.round(taxSavings).toLocaleString()} tax savings`,\n        action: 'View retirement strategy',\n        actionView: 'tax',\n        reasoning: `Net SE income: $${Math.round(netSEIncome).toLocaleString()}. Max ${bestOption.name}: $${Math.round(bestOption.max).toLocaleString()}. Current contributions: $${currentRetirement.toLocaleString()}. Effective tax rate: ${report.effectiveRate.toFixed(1)}%.`,\n        createdAt: now.toISOString(),\n      })\n    }\n    \n    // Year-end urgency for Solo 401k employee contributions\n    if (ctx.quarter === 4 && ctx.daysLeftInYear <= 45 && currentRetirement < (max401k.employeeDeferral || 23500)) {\n      alerts.push({\n        id: 'solo401k-yearend',\n        title: 'Solo 401(k) Employee Deferral Deadline Approaching',\n        message: `Employee salary deferrals to a Solo 401(k) must be made by December 31. You have ${ctx.daysLeftInYear} days to contribute up to $${(23500).toLocaleString()} in employee deferrals.`,\n        severity: 'urgent',\n        category: 'deadline',\n        daysUntilDeadline: ctx.daysLeftInYear,\n        action: 'Maximize 401(k) contributions',\n        actionView: 'tax',\n        reasoning: 'Employee deferral deadline is always December 31, regardless of tax filing extensions. Employer contributions can be made until filing deadline.',\n        createdAt: now.toISOString(),\n      })\n    }\n  }\n  \n  // ===== 4. S-CORP ELECTION OPPORTUNITY =====\n  const hasScorp = entities.some(e => (e.type === 'llc_scorp' || e.type === 'scorp') && e.isActive)\n  if (!hasScorp && netSEIncome > 50000) {\n    const reasonableSalary = Math.round(Math.max(netSEIncome * 0.5, Math.min(netSEIncome * 0.7, 80000)))\n    const savings = calculateSCorpSavings(netSEIncome, reasonableSalary)\n    \n    if (savings.savings > 3000) {\n      // Check if S-Corp election deadline is approaching\n      const isBeforeMarch15 = ctx.month <= 3 && (ctx.month < 3 || ctx.dayOfMonth <= 15)\n      \n      alerts.push({\n        id: 'scorp-opportunity',\n        title: `S-Corp Could Save $${savings.savings.toLocaleString()}/yr`,\n        message: isBeforeMarch15\n          ? `You have until March 15 to file Form 2553 for S-Corp election effective this year. With net SE income of $${Math.round(netSEIncome).toLocaleString()}, you'd save ~$${savings.savings.toLocaleString()}/year in self-employment tax.`\n          : `Your income level of $${Math.round(netSEIncome).toLocaleString()} makes you an excellent S-Corp candidate. File Form 2553 to start saving $${savings.savings.toLocaleString()}/year in SE tax starting next year.`,\n        severity: isBeforeMarch15 ? 'urgent' : 'opportunity',\n        category: 'entity',\n        impact: savings.savings,\n        impactLabel: `$${savings.savings.toLocaleString()}/yr savings`,\n        action: 'View entity comparison',\n        actionView: 'entity',\n        deadline: isBeforeMarch15 ? `${now.getFullYear()}-03-15` : undefined,\n        daysUntilDeadline: isBeforeMarch15 ? Math.ceil((new Date(now.getFullYear(), 2, 15).getTime() - now.getTime()) / 86400000) : undefined,\n        reasoning: `Current SE tax: $${savings.currentSETax.toLocaleString()}. After S-Corp (salary $${reasonableSalary.toLocaleString()}): $${savings.sCorpSETax.toLocaleString()}.`,\n        createdAt: now.toISOString(),\n      })\n    }\n  }\n  \n  // ===== 5. AUDIT RISK THRESHOLD ALERTS =====\n  const homeOfficeDeduction = deductions.filter(d => d.category === 'home_office').reduce((sum, d) => sum + d.amount, 0)\n  const charitableDeduction = deductions.filter(d => d.category === 'charitable').reduce((sum, d) => sum + d.amount, 0)\n  const vehicleDeduction = deductions.filter(d => d.category === 'vehicle').reduce((sum, d) => sum + d.amount, 0)\n  \n  // Home office audit flag\n  if (homeOfficeDeduction > 0 && totalIncome > 0) {\n    const homeOfficeRatio = homeOfficeDeduction / totalIncome\n    if (homeOfficeRatio > 0.15) {\n      alerts.push({\n        id: 'audit-home-office',\n        title: 'Home Office Deduction Approaching Audit Threshold',\n        message: `Your home office deduction ($${homeOfficeDeduction.toLocaleString()}) is ${(homeOfficeRatio * 100).toFixed(1)}% of gross income — IRS attention increases above 15%. Consider restructuring or ensuring meticulous documentation.`,\n        severity: homeOfficeRatio > 0.25 ? 'warning' : 'info',\n        category: 'audit',\n        action: 'Review audit risk profile',\n        actionView: 'audit',\n        reasoning: `Home office: $${homeOfficeDeduction.toLocaleString()} / Gross income: $${totalIncome.toLocaleString()} = ${(homeOfficeRatio * 100).toFixed(1)}% ratio. IRS DIF scoring flags returns with unusually high deduction-to-income ratios.`,\n        createdAt: now.toISOString(),\n      })\n    }\n  }\n  \n  // Charitable over 50% AGI\n  if (charitableDeduction > 0 && report.agi > 0) {\n    const charRatio = charitableDeduction / report.agi\n    if (charRatio > 0.30) {\n      alerts.push({\n        id: 'audit-charitable',\n        title: 'Charitable Deductions Drawing Attention',\n        message: `Charitable contributions of $${charitableDeduction.toLocaleString()} represent ${(charRatio * 100).toFixed(1)}% of AGI. Ensure you have acknowledgment letters for all donations over $250 and Form 8283 for non-cash gifts over $500.`,\n        severity: charRatio > 0.50 ? 'warning' : 'info',\n        category: 'audit',\n        action: 'Review audit preparedness',\n        actionView: 'audit',\n        reasoning: `Charitable: $${charitableDeduction.toLocaleString()} / AGI: $${Math.round(report.agi).toLocaleString()} = ${(charRatio * 100).toFixed(1)}%. Deduction limited to 60% of AGI for cash, 30% for appreciated assets.`,\n        createdAt: now.toISOString(),\n      })\n    }\n  }\n  \n  // ===== 6. Q4 YEAR-END ACCELERATION =====\n  if (ctx.quarter === 4) {\n    const potentialDeductions: string[] = []\n    let potentialSavings = 0\n    \n    // Business equipment (Section 179)\n    if (selfEmploymentIncome > 50000) {\n      potentialDeductions.push('Business equipment purchases (Section 179 immediate deduction)')\n    }\n    \n    // Prepay expenses\n    if (netSEIncome > 30000) {\n      potentialDeductions.push('Prepay Q1 rent, insurance, or subscriptions')\n      potentialSavings += netSEIncome * 0.02\n    }\n    \n    // Charitable contributions\n    potentialDeductions.push('Make planned charitable contributions before Dec 31')\n    \n    // Tax loss harvesting\n    potentialDeductions.push('Harvest investment losses to offset gains')\n    \n    if (potentialDeductions.length > 0) {\n      alerts.push({\n        id: 'q4-acceleration',\n        title: `${ctx.daysLeftInYear} Days Left for Year-End Tax Moves`,\n        message: `Key strategies before December 31:\\n${potentialDeductions.map(d => `• ${d}`).join('\\n')}`,\n        severity: ctx.daysLeftInYear <= 15 ? 'urgent' : 'warning',\n        category: 'strategy',\n        action: 'Launch year-end workflow',\n        actionView: 'workflows',\n        daysUntilDeadline: ctx.daysLeftInYear,\n        reasoning: `Q4 is the last window for deduction acceleration, income deferral, and contribution maximization. These strategies cannot be retroactively applied after December 31.`,\n        createdAt: now.toISOString(),\n      })\n    }\n  }\n  \n  // ===== 7. INCOME DIVERSIFICATION =====\n  if (incomeStreams.filter(s => s.isActive).length === 1 && totalIncome > 0) {\n    alerts.push({\n      id: 'diversification',\n      title: 'Single Income Stream Risk',\n      message: 'Your entire income depends on one source. Consider diversifying with additional revenue streams to reduce risk and unlock additional tax optimization strategies.',\n      severity: 'info',\n      category: 'strategy',\n      action: 'Explore revenue strategies',\n      actionView: 'revenue',\n      reasoning: 'Single-source income creates concentration risk and limits entity structuring options. Multiple income types enable more sophisticated tax optimization.',\n      createdAt: now.toISOString(),\n    })\n  }\n  \n  // ===== 8. MISSING DEDUCTION CATEGORIES =====\n  const deductionCategories = new Set(deductions.map(d => d.category))\n  const missingHighValue: { cat: string; label: string; hint: string }[] = []\n  \n  if (selfEmploymentIncome > 0) {\n    if (!deductionCategories.has('home_office') && !deductionCategories.has('vehicle')) {\n      missingHighValue.push({ cat: 'home_office', label: 'Home Office', hint: 'If you use part of your home regularly and exclusively for business' })\n    }\n    if (!deductionCategories.has('retirement')) {\n      missingHighValue.push({ cat: 'retirement', label: 'Retirement', hint: 'SEP-IRA, Solo 401(k), or SIMPLE IRA contributions' })\n    }\n    if (!deductionCategories.has('health') && !profile.hasHealthInsurance) {\n      missingHighValue.push({ cat: 'health', label: 'Health Insurance', hint: 'Self-employed health insurance deduction (above-the-line)' })\n    }\n  }\n  \n  if (missingHighValue.length > 0) {\n    const totalPotential = missingHighValue.length * 3000 // rough estimate\n    alerts.push({\n      id: 'missing-deductions',\n      title: `${missingHighValue.length} Potential Deduction${missingHighValue.length > 1 ? 's' : ''} Not Claimed`,\n      message: `You may be missing: ${missingHighValue.map(m => `${m.label} (${m.hint})`).join('; ')}. Adding these could reduce your tax bill significantly.`,\n      severity: 'opportunity',\n      category: 'tax',\n      action: 'Update deductions',\n      actionView: 'setup',\n      reasoning: `Common high-value deductions not found in your profile. Each could save hundreds to thousands annually depending on your situation.`,\n      createdAt: now.toISOString(),\n    })\n  }\n  \n  // ===== 9. STATE TAX OPTIMIZATION =====\n  const stateRate = STATE_TAX_RATES[profile.state] || 0\n  if (stateRate > 0.06 && totalIncome > 100000) {\n    const noTaxStates = ['AK', 'FL', 'NV', 'NH', 'SD', 'TN', 'TX', 'WA', 'WY']\n    const currentStateTax = totalIncome * stateRate\n    \n    alerts.push({\n      id: 'state-tax-optimization',\n      title: `State Tax: $${Math.round(currentStateTax).toLocaleString()}/yr (${(stateRate * 100).toFixed(1)}%)`,\n      message: `Your ${profile.state} state tax rate of ${(stateRate * 100).toFixed(1)}% costs ~$${Math.round(currentStateTax).toLocaleString()} annually. If your work is location-independent, states like ${noTaxStates.slice(0, 4).join(', ')} have no income tax.`,\n      severity: currentStateTax > 10000 ? 'opportunity' : 'info',\n      category: 'tax',\n      impact: currentStateTax,\n      impactLabel: `$${Math.round(currentStateTax).toLocaleString()}/yr state tax`,\n      action: 'Compare state scenarios',\n      actionView: 'scenarios',\n      reasoning: `Current state: ${profile.state} (${(stateRate * 100).toFixed(1)}%). This is informational — relocation decisions involve many factors beyond tax savings.`,\n      createdAt: now.toISOString(),\n    })\n  }\n  \n  // ===== 10. UNDERPAYMENT PENALTY RISK =====\n  if (report.totalFederalTax > 1000 && selfEmploymentIncome > 0) {\n    const annualizedIncome = totalIncome * (1 / Math.max(ctx.yearProgress, 0.1))\n    const annualizedTax = report.totalFederalTax * (1 / Math.max(ctx.yearProgress, 0.1))\n    \n    // Safe harbor: must pay lesser of 100% of prior year tax or 90% of current year tax\n    // Since we don't have prior year, flag if quarterly payments would be high\n    const quarterlyRequired = Math.round(annualizedTax / 4)\n    \n    if (quarterlyRequired > 2500) {\n      alerts.push({\n        id: 'underpayment-risk',\n        title: 'Underpayment Penalty Prevention',\n        message: `Based on current income, your estimated quarterly tax payment should be ~$${quarterlyRequired.toLocaleString()}. Ensure you're making timely 1040-ES payments to avoid underpayment penalties (currently ~8% annualized).`,\n        severity: 'info',\n        category: 'tax',\n        impact: quarterlyRequired * 4,\n        impactLabel: `$${quarterlyRequired.toLocaleString()}/quarter`,\n        action: 'View estimated tax details',\n        actionView: 'cashflow',\n        reasoning: `Annualized tax projection: $${Math.round(annualizedTax).toLocaleString()}. Safe harbor requires paying at least 90% of current year liability in estimated payments, or 100% of prior year tax.`,\n        createdAt: now.toISOString(),\n      })\n    }\n  }\n  \n  // ── Portfolio Intelligence alerts ────────────────────────────────\n  if (hasPortfolioData()) {\n    const portfolioAlerts = getPortfolioAlerts()\n    for (const pa of portfolioAlerts) {\n      alerts.push({\n        id: pa.id,\n        title: pa.title,\n        message: pa.message,\n        severity: pa.severity,\n        category: pa.category as AlertCategory,\n        impact: pa.impact,\n        impactLabel: pa.impact ? `$${pa.impact.toLocaleString()}` : undefined,\n        action: 'View in Portfolio Intelligence',\n        actionView: pa.actionView,\n        reasoning: pa.message,\n        createdAt: new Date().toISOString(),\n      })\n    }\n  }\n  \n  // ===== METAMODEL-AWARE ALERTS =====\n\n  // Estimated Payment Tracking (from actual estimatedPayments[])\n  const estPayments = state.estimatedPayments || []\n  if (estPayments.length > 0) {\n    const missed = estPayments.filter(p => {\n      const due = new Date(p.dueDate)\n      return due < now && (!p.paidAmount || p.paidAmount === 0)\n    })\n    if (missed.length > 0) {\n      const totalMissed = missed.reduce((s, p) => s + p.amount, 0)\n      alerts.push({\n        id: 'est-payment-missed',\n        title: `${missed.length} Estimated Payment(s) Past Due`,\n        message: `$${totalMissed.toLocaleString()} in estimated tax payments are past due. Late payments accrue interest and may trigger an underpayment penalty (Form 2210).`,\n        severity: 'urgent', category: 'tax', impact: Math.round(totalMissed * 0.04),\n        impactLabel: `~$${Math.round(totalMissed * 0.04).toLocaleString()} potential penalty`,\n        action: 'Make payments immediately to minimize penalties',\n        actionView: 'calendar', reasoning: `Past due payments: ${missed.map(p => p.dueDate).join(', ')}`,\n        createdAt: now.toISOString(),\n      })\n    }\n    const upcoming = estPayments.filter(p => {\n      const due = new Date(p.dueDate)\n      const daysUntil = (due.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)\n      return daysUntil > 0 && daysUntil <= 30 && (!p.paidAmount || p.paidAmount === 0)\n    })\n    if (upcoming.length > 0) {\n      const amt = upcoming.reduce((s, p) => s + p.amount, 0)\n      alerts.push({\n        id: 'est-payment-upcoming',\n        title: `Estimated Payment Due Within 30 Days`,\n        message: `$${amt.toLocaleString()} estimated tax payment due ${upcoming[0].dueDate}. Ensure funds are available to avoid underpayment penalties.`,\n        severity: 'warning', category: 'tax', impact: amt,\n        impactLabel: `$${amt.toLocaleString()} due`, action: 'Prepare quarterly payment',\n        actionView: 'calendar', reasoning: `Next payment: $${amt.toLocaleString()} due ${upcoming[0].dueDate}`,\n        createdAt: now.toISOString(),\n      })\n    }\n  }\n\n  // Depreciation Asset Alerts\n  const depAssets = (state.depreciationAssets || []).filter(a => a.isActive)\n  if (depAssets.length > 0) {\n    const currentYear = now.getFullYear()\n    const yearEndApproaching = now.getMonth() >= 9 // October+\n    const no179 = depAssets.filter(a => a.method !== 'section_179' && a.purchasePrice >= 5000)\n    if (yearEndApproaching && no179.length > 0) {\n      const totalBasis = no179.reduce((s, a) => s + a.purchasePrice, 0)\n      alerts.push({\n        id: 'depreciation-179-opportunity',\n        title: `\\u00A7179 Opportunity: $${totalBasis.toLocaleString()} in Assets`,\n        message: `${no179.length} asset(s) totaling $${totalBasis.toLocaleString()} could qualify for \\u00A7179 immediate expensing. Year-end is approaching \\u2014 consider electing \\u00A7179 to accelerate deductions into ${currentYear}.`,\n        severity: 'opportunity', category: 'tax', impact: Math.round(totalBasis * 0.25),\n        impactLabel: `~$${Math.round(totalBasis * 0.25).toLocaleString()} potential savings`,\n        action: 'Review \\u00A7179 election in Depreciation module',\n        actionView: 'depreciation', reasoning: `Assets without \\u00A7179: ${no179.map(a => a.name).slice(0, 3).join(', ')}`,\n        createdAt: now.toISOString(),\n      })\n    }\n  }\n\n  // Retirement Contribution Gap\n  const retAccounts = state.retirementAccounts || []\n  if (retAccounts.length > 0 && selfEmploymentIncome > 50000) {\n    const totalContrib = retAccounts.reduce((s, a) => s + (a.annualContribution || 0), 0)\n    const maxPossible = retAccounts.reduce((s, a) => s + (a.maxContribution || 0), 0)\n    const gap = maxPossible - totalContrib\n    if (gap > 5000) {\n      alerts.push({\n        id: 'retirement-gap',\n        title: `$${gap.toLocaleString()} Retirement Contribution Gap`,\n        message: `You're contributing $${totalContrib.toLocaleString()}/yr but could contribute up to $${maxPossible.toLocaleString()}/yr across ${retAccounts.length} account(s). The $${gap.toLocaleString()} gap represents missed tax deductions.`,\n        severity: 'opportunity', category: 'optimization', impact: Math.round(gap * 0.25),\n        impactLabel: `~$${Math.round(gap * 0.25).toLocaleString()} tax savings`,\n        action: 'Maximize retirement contributions',\n        actionView: 'retirement', reasoning: `Current: $${totalContrib.toLocaleString()}, Max: $${maxPossible.toLocaleString()}`,\n        createdAt: now.toISOString(),\n      })\n    }\n  }\n\n  // Goal Progress Alerts\n  const goals = (state.goals || []).filter(g => g.status === 'active')\n  for (const goal of goals.slice(0, 2)) {\n    if (goal.targetDate && goal.targetAmount && goal.currentAmount !== undefined) {\n      const daysLeft = (new Date(goal.targetDate).getTime() - now.getTime()) / (1000 * 60 * 60 * 24)\n      const progress = (goal.currentAmount || 0) / goal.targetAmount\n      if (daysLeft < 90 && progress < 0.5) {\n        alerts.push({\n          id: `goal-behind-${goal.id}`,\n          title: `Goal \"${goal.title}\" Behind Pace`,\n          message: `${Math.round(progress * 100)}% progress with ${Math.round(daysLeft)} days remaining. Target: $${goal.targetAmount.toLocaleString()}.`,\n          severity: 'warning', category: 'optimization', impact: goal.targetAmount - (goal.currentAmount || 0),\n          impactLabel: `$${(goal.targetAmount - (goal.currentAmount || 0)).toLocaleString()} remaining`,\n          action: 'Review goal strategy', actionView: 'goals',\n          reasoning: `Goal: ${goal.title}, progress: ${Math.round(progress * 100)}%, deadline: ${goal.targetDate}`,\n          createdAt: now.toISOString(),\n        })\n      }\n    }\n  }\n\n  // Sort: urgent first, then warning, then opportunity, then info\n  const severityOrder: Record<AlertSeverity, number> = { urgent: 0, warning: 1, opportunity: 2, info: 3 }\n  alerts.sort((a, b) => severityOrder[a.severity] - severityOrder[b.severity])\n  \n  return alerts\n}\n\n// ==================== Financial Pulse Summary ====================\n\nexport interface FinancialPulse {\n  headline: string\n  subheadline: string\n  urgentCount: number\n  opportunityCount: number\n  estimatedSavingsAvailable: number\n  nextDeadline: { name: string; daysUntil: number; date: string } | null\n  quarterSummary: string\n}\n\nexport function getFinancialPulse(state: FortunaState): FinancialPulse {\n  const alerts = generateProactiveAlerts(state)\n  const ctx = getQuarterContext()\n  const deadlines = getTaxDeadlines(state)\n  const now = new Date()\n  \n  const urgentCount = alerts.filter(a => a.severity === 'urgent').length\n  const opportunityCount = alerts.filter(a => a.severity === 'opportunity').length\n  const estimatedSavings = alerts\n    .filter(a => a.impact && (a.category === 'tax' || a.category === 'entity' || a.category === 'retirement'))\n    .reduce((sum, a) => sum + (a.impact || 0), 0)\n  \n  // Find next deadline\n  let nextDeadline: FinancialPulse['nextDeadline'] = null\n  for (const d of deadlines) {\n    const deadlineDate = new Date(d.date)\n    const daysUntil = Math.ceil((deadlineDate.getTime() - now.getTime()) / 86400000)\n    if (daysUntil > 0) {\n      nextDeadline = { name: d.name, daysUntil, date: d.date }\n      break\n    }\n  }\n  \n  // Generate headline\n  let headline = ''\n  let subheadline = ''\n  \n  if (urgentCount > 0) {\n    headline = `${urgentCount} urgent item${urgentCount > 1 ? 's' : ''} need${urgentCount === 1 ? 's' : ''} attention`\n    subheadline = alerts.find(a => a.severity === 'urgent')?.title || ''\n  } else if (opportunityCount > 0) {\n    headline = `$${Math.round(estimatedSavings).toLocaleString()} in potential savings identified`\n    subheadline = `${opportunityCount} optimization opportunit${opportunityCount > 1 ? 'ies' : 'y'} available`\n  } else {\n    headline = 'Financial position looks solid'\n    subheadline = 'No urgent items — keep monitoring'\n  }\n  \n  const quarterNames = ['', 'Q1 (Jan-Mar)', 'Q2 (Apr-Jun)', 'Q3 (Jul-Sep)', 'Q4 (Oct-Dec)']\n  const quarterSummary = `${quarterNames[ctx.quarter]} • ${ctx.daysLeftInQuarter} days remaining • Year ${Math.round(ctx.yearProgress * 100)}% complete`\n  \n  return {\n    headline,\n    subheadline,\n    urgentCount,\n    opportunityCount,\n    estimatedSavingsAvailable: estimatedSavings,\n    nextDeadline,\n    quarterSummary,\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\pwa.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":16,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[378,381],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[378,381],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":141,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":141,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4031,4034],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4031,4034],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":144,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":144,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4134,4137],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4134,4137],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":165,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":165,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4656,4659],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4656,4659],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE — PWA Registration & Push Notifications\n * \n * Handles:\n *   - Service worker registration\n *   - Push notification permission requests\n *   - Local notification scheduling (for tax deadlines)\n *   - Install prompt management\n */\n\nexport interface NotificationPayload {\n  title: string\n  body: string\n  tag?: string\n  icon?: string\n  data?: Record<string, any>\n}\n\n// ─── Service Worker Registration ────────────────────────────────────────────\n\nexport async function registerServiceWorker(): Promise<ServiceWorkerRegistration | null> {\n  if (!('serviceWorker' in navigator)) {\n    console.warn('[Fortuna PWA] Service workers not supported')\n    return null\n  }\n\n  try {\n    const registration = await navigator.serviceWorker.register('/sw.js', { scope: '/' })\n    console.log('[Fortuna PWA] Service worker registered:', registration.scope)\n\n    // Check for updates periodically\n    setInterval(() => registration.update(), 60 * 60 * 1000) // hourly\n\n    return registration\n  } catch (err) {\n    console.error('[Fortuna PWA] Registration failed:', err)\n    return null\n  }\n}\n\n// ─── Push Notification Permission ───────────────────────────────────────────\n\nexport async function requestNotificationPermission(): Promise<NotificationPermission> {\n  if (!('Notification' in window)) {\n    console.warn('[Fortuna PWA] Notifications not supported')\n    return 'denied'\n  }\n\n  if (Notification.permission === 'granted') return 'granted'\n  if (Notification.permission === 'denied') return 'denied'\n\n  const permission = await Notification.requestPermission()\n  return permission\n}\n\nexport function getNotificationPermission(): NotificationPermission {\n  if (!('Notification' in window)) return 'denied'\n  return Notification.permission\n}\n\n// ─── Local Notifications (no server needed) ─────────────────────────────────\n\nexport async function showLocalNotification(payload: NotificationPayload): Promise<boolean> {\n  const permission = await requestNotificationPermission()\n  if (permission !== 'granted') return false\n\n  const registration = await navigator.serviceWorker.ready\n  \n  await registration.showNotification(payload.title, {\n    body: payload.body,\n    icon: payload.icon || '/icons/icon-192.png',\n    badge: '/icons/icon-72.png',\n    tag: payload.tag || `fortuna-${Date.now()}`,\n    vibrate: [200, 100, 200],\n    data: payload.data,\n  })\n\n  return true\n}\n\n// ─── Scheduled Notification Engine ──────────────────────────────────────────\n\nconst SCHEDULE_KEY = 'fortuna:notification-schedule'\n\ninterface ScheduledNotification {\n  id: string\n  payload: NotificationPayload\n  scheduledAt: string  // ISO datetime\n  fired: boolean\n}\n\nexport function scheduleNotification(payload: NotificationPayload, date: Date): string {\n  const schedule = getSchedule()\n  const id = 'notif_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 4)\n  \n  schedule.push({\n    id,\n    payload,\n    scheduledAt: date.toISOString(),\n    fired: false,\n  })\n\n  localStorage.setItem(SCHEDULE_KEY, JSON.stringify(schedule))\n  return id\n}\n\nexport function cancelNotification(id: string) {\n  const schedule = getSchedule().filter(n => n.id !== id)\n  localStorage.setItem(SCHEDULE_KEY, JSON.stringify(schedule))\n}\n\nexport function getSchedule(): ScheduledNotification[] {\n  try {\n    return JSON.parse(localStorage.getItem(SCHEDULE_KEY) || '[]')\n  } catch { return [] }\n}\n\n// Check and fire due notifications (call this on app load and periodically)\nexport async function checkScheduledNotifications() {\n  const now = new Date()\n  const schedule = getSchedule()\n  let changed = false\n\n  for (const notif of schedule) {\n    if (notif.fired) continue\n    const scheduled = new Date(notif.scheduledAt)\n    if (now >= scheduled) {\n      await showLocalNotification(notif.payload)\n      notif.fired = true\n      changed = true\n    }\n  }\n\n  if (changed) {\n    localStorage.setItem(SCHEDULE_KEY, JSON.stringify(schedule))\n  }\n}\n\n// ─── Install Prompt Management ──────────────────────────────────────────────\n\nlet deferredPrompt: any = null\n\nexport function initInstallPrompt() {\n  window.addEventListener('beforeinstallprompt', (e: any) => {\n    e.preventDefault()\n    deferredPrompt = e\n  })\n}\n\nexport function canShowInstallPrompt(): boolean {\n  return !!deferredPrompt\n}\n\nexport async function showInstallPrompt(): Promise<boolean> {\n  if (!deferredPrompt) return false\n  \n  deferredPrompt.prompt()\n  const result = await deferredPrompt.userChoice\n  deferredPrompt = null\n  return result.outcome === 'accepted'\n}\n\nexport function isPWAInstalled(): boolean {\n  return window.matchMedia('(display-mode: standalone)').matches ||\n    (window.navigator as any).standalone === true\n}\n\n// ─── PWA Status Summary ─────────────────────────────────────────────────────\n\nexport function getPWAStatus(): {\n  serviceWorkerSupported: boolean\n  serviceWorkerRegistered: boolean\n  notificationSupported: boolean\n  notificationPermission: NotificationPermission\n  isInstalled: boolean\n  canInstall: boolean\n  scheduledNotifications: number\n} {\n  return {\n    serviceWorkerSupported: 'serviceWorker' in navigator,\n    serviceWorkerRegistered: !!navigator.serviceWorker?.controller,\n    notificationSupported: 'Notification' in window,\n    notificationPermission: getNotificationPermission(),\n    isInstalled: isPWAInstalled(),\n    canInstall: canShowInstallPrompt(),\n    scheduledNotifications: getSchedule().filter(n => !n.fired).length,\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\qb-coa-mapper.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\qb-iif-exporter.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\qb-iif-parser.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\qb-ofx-parser.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\real-estate.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'RealEstateProperty' is defined but never used.","line":1,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":47,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"RealEstateProperty"},"fix":{"range":[26,46],"text":""},"desc":"Remove unused variable \"RealEstateProperty\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { FortunaState, RealEstateProperty } from './storage'\r\n\r\nexport interface RealEstateSummary {\r\n  totalPortfolioValue: number\r\n  totalEquity: number\r\n  totalUnrealizedGain: number\r\n  potential1031Value: number\r\n}\r\n\r\nexport function calculateRealEstateSummary(state: FortunaState): RealEstateSummary | null {\r\n  if (!state.realEstate || state.realEstate.length === 0) return null\r\n\r\n  let totalPortfolioValue = 0\r\n  let totalEquity = 0\r\n  let totalUnrealizedGain = 0\r\n  let potential1031Value = 0\r\n\r\n  for (const prop of state.realEstate) {\r\n    totalPortfolioValue += prop.currentValue\r\n    totalEquity += (prop.currentValue - (prop.outstandingMortgage || 0))\r\n    const unrealizedGain = Math.max(0, prop.currentValue - prop.purchasePrice)\r\n    totalUnrealizedGain += unrealizedGain\r\n\r\n    if (prop.type !== 'primary_residence' && prop.is1031ExchangeTarget !== false) {\r\n      potential1031Value += prop.currentValue\r\n    }\r\n  }\r\n\r\n  return {\r\n    totalPortfolioValue,\r\n    totalEquity,\r\n    totalUnrealizedGain,\r\n    potential1031Value\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\receipt-engine.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":270,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":270,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9345,9348],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9345,9348],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":309,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":309,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10944,10947],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10944,10947],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_' is defined but never used.","line":358,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":358,"endColumn":20}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { FortunaState, ReceiptRecord, ReceiptItem, BusinessExpense, DeductionRecord as Deduction } from './storage'\r\nimport { genId } from './storage'\r\nimport { categorizeReceiptAI } from './ai-categorization'\r\n\r\nexport interface AllocationResult {\r\n    receiptId: string\r\n    merchantName: string\r\n    totalAmount: number\r\n    allocatedPersonal: number\r\n    allocatedBusiness: number\r\n    businessAllocations: Record<string, number> // entityId -> amount\r\n    itemsAllocated: number\r\n    itemsNeedingReview: number\r\n    status: 'allocated' | 'needs_review'\r\n}\r\n\r\nexport interface SubscriptionInsight {\r\n    merchantName: string\r\n    entities: string[] // entityIds involved\r\n    totalMonthlyBurn: number\r\n    isDuplicate: boolean\r\n    recommendation: string\r\n}\r\n\r\nexport interface ComminglingRisk {\r\n    receiptId: string\r\n    merchantName: string\r\n    amount: number\r\n    assignedEntityId: string\r\n    paymentMethodId: string\r\n    riskLevel: 'low' | 'medium' | 'high'\r\n    description: string\r\n}\r\n\r\nexport interface GoalAlignment {\r\n    goalId: string\r\n    goalTitle: string\r\n    contributionAmount: number\r\n    receiptIds: string[]\r\n}\r\n\r\nexport interface TaxSignal {\r\n    type: 'estimated_tax_adjustment' | 'deduction_velocity' | 'audit_risk'\r\n    severity: 'info' | 'warning' | 'critical'\r\n    message: string\r\n    actionableLink?: string\r\n}\r\n\r\nexport interface ReceiptIntelligenceReport {\r\n    subscriptions: SubscriptionInsight[]\r\n    comminglingRisks: ComminglingRisk[]\r\n    goalAlignments: GoalAlignment[]\r\n    taxSignals: TaxSignal[]\r\n}\r\n\r\n/**\r\n * Enhanced Receipt Engine\r\n * \r\n * Handles line-item level allocation across multiple business entities and personal scope.\r\n * Uses a heuristic match based on merchant, category, and item description.\r\n */\r\n\r\nconst BUSINESS_CATEGORIES = [\r\n    'Office Supplies', 'Software', 'Advertising', 'Legal & Professional',\r\n    'Travel', 'Meals & Entertainment', 'Equipment', 'Rent', 'Utilities',\r\n    'Consulting', 'Marketing', 'Dues & Subscriptions'\r\n]\r\n\r\nconst PERSONAL_CATEGORIES = [\r\n    'Groceries', 'Clothing', 'Entertainment', 'Personal Care', 'Housing',\r\n    'Dining Out', 'Gifts', 'Hobbies', 'Pet Supplies', 'Medical'\r\n]\r\n\r\nconst MERCHANT_MAPPINGS: Record<string, string> = {\r\n    'AWS': 'business',\r\n    'Google Cloud': 'business',\r\n    'Facebook Ads': 'business',\r\n    'Staples': 'business',\r\n    'Office Depot': 'business',\r\n    'Whole Foods': 'personal',\r\n    'Trader Joes': 'personal',\r\n    'Safeway': 'personal',\r\n    'Netflix': 'personal',\r\n    'Spotify': 'personal',\r\n    'Steam': 'personal'\r\n}\r\n\r\nexport function processReceipts(state: FortunaState, batchId?: string): AllocationResult[] {\r\n    if (!state.receipts || state.receipts.length === 0) return []\r\n\r\n    const results: AllocationResult[] = []\r\n\r\n    const targetReceipts = batchId ? state.receipts.filter(r => r.batchId === batchId) : state.receipts\r\n\r\n    for (const receipt of targetReceipts) {\r\n        if (receipt.status === 'allocated') continue\r\n\r\n        const result: AllocationResult = {\r\n            receiptId: receipt.id,\r\n            merchantName: receipt.merchantName,\r\n            totalAmount: receipt.totalAmount,\r\n            allocatedPersonal: 0,\r\n            allocatedBusiness: 0,\r\n            businessAllocations: {},\r\n            itemsAllocated: 0,\r\n            itemsNeedingReview: 0,\r\n            status: 'allocated'\r\n        }\r\n\r\n        for (const item of receipt.items) {\r\n            const allocation = autoAllocateItem(item, receipt, state)\r\n\r\n            if (allocation) {\r\n                item.allocatedEntityId = allocation.entityId\r\n                item.confidenceScore = allocation.confidence\r\n\r\n                if (allocation.entityId === 'personal') {\r\n                    result.allocatedPersonal += item.amount\r\n                } else {\r\n                    result.allocatedBusiness += item.amount\r\n                    result.businessAllocations[allocation.entityId] = (result.businessAllocations[allocation.entityId] || 0) + item.amount\r\n                }\r\n                result.itemsAllocated++\r\n            } else {\r\n                item.status = 'needs_review'\r\n                result.itemsNeedingReview++\r\n            }\r\n        }\r\n\r\n        // Determine final status\r\n        if (result.itemsNeedingReview > 0) {\r\n            result.status = 'needs_review'\r\n            receipt.status = 'needs_review'\r\n        } else {\r\n            result.status = 'allocated'\r\n            receipt.status = 'allocated'\r\n        }\r\n\r\n        results.push(result)\r\n    }\r\n\r\n    return results\r\n}\r\n\r\n/**\r\n * Asynchronous Receipt Processing with AI fallback\r\n * Runs standard heuristics first, then uses external AI for ambiguous receipts.\r\n */\r\nexport async function processReceiptsAsync(state: FortunaState, batchId?: string): Promise<AllocationResult[]> {\r\n    // 1. Initial heuristic pass\r\n    const syncResults = processReceipts(state, batchId)\r\n\r\n    // 2. Identify receipts that need AI help (needs_review or low confidence items)\r\n    const targetResults = syncResults.filter(r => r.status === 'needs_review')\r\n\r\n    for (const result of targetResults) {\r\n        const receipt = state.receipts.find(r => r.id === result.receiptId)\r\n        if (!receipt) continue\r\n\r\n        // Call AI Bridge\r\n        const aiResult = await categorizeReceiptAI(receipt, state.entities || [])\r\n\r\n        if (aiResult.confidence !== 'low') {\r\n            // Update receipt items based on AI suggestions\r\n            for (const aiAlloc of aiResult.lineItemAllocations) {\r\n                const item = receipt.items.find(i => i.id === aiAlloc.itemId)\r\n                if (item) {\r\n                    item.allocatedEntityId = aiAlloc.isBusiness ? aiResult.suggestedEntityId || 'business' : 'personal'\r\n                    item.inferredCategory = aiAlloc.category\r\n                    item.confidenceScore = aiResult.confidence === 'high' ? 0.95 : 0.75\r\n                    item.status = 'allocated'\r\n                }\r\n            }\r\n\r\n            // Recalculate result metrics\r\n            result.allocatedPersonal = receipt.items\r\n                .filter(i => i.allocatedEntityId === 'personal')\r\n                .reduce((sum, i) => sum + i.amount, 0)\r\n\r\n            result.allocatedBusiness = receipt.items\r\n                .filter(i => i.allocatedEntityId !== 'personal' && i.allocatedEntityId)\r\n                .reduce((sum, i) => sum + i.amount, 0)\r\n\r\n            result.itemsNeedingReview = receipt.items.filter(i => i.status === 'needs_review').length\r\n\r\n            if (result.itemsNeedingReview === 0) {\r\n                result.status = 'allocated'\r\n                receipt.status = 'allocated'\r\n            }\r\n        }\r\n    }\r\n\r\n    return syncResults\r\n}\r\n\r\nfunction autoAllocateItem(item: ReceiptItem, receipt: ReceiptRecord, state: FortunaState): { entityId: string, confidence: number } | null {\r\n    // 1. Check for manual overrides\r\n    if (item.isBusiness === false) return { entityId: 'personal', confidence: 1.0 }\r\n\r\n    const desc = item.description.toLowerCase()\r\n    const merchant = receipt.merchantName.toLowerCase()\r\n    const category = item.inferredCategory\r\n\r\n    // 2. Identify Personal vs Business\r\n    let isPersonal = false\r\n    let isBusiness = false\r\n    let confidence = 0.5\r\n\r\n    // Category Check\r\n    if (PERSONAL_CATEGORIES.includes(category)) {\r\n        isPersonal = true\r\n        confidence = 0.8\r\n    } else if (BUSINESS_CATEGORIES.includes(category)) {\r\n        isBusiness = true\r\n        confidence = 0.8\r\n    }\r\n\r\n    // Merchant Check\r\n    for (const [mKey, type] of Object.entries(MERCHANT_MAPPINGS)) {\r\n        if (merchant.includes(mKey.toLowerCase())) {\r\n            if (type === 'personal') isPersonal = true\r\n            else isBusiness = true\r\n            confidence = 0.95\r\n            break\r\n        }\r\n    }\r\n\r\n    // Keywords Check\r\n    if (desc.includes('diaper') || desc.includes('grocery') || desc.includes('toy')) {\r\n        isPersonal = true\r\n        confidence = 0.9\r\n    }\r\n    if (desc.includes('api') || desc.includes('server') || desc.includes('consulting')) {\r\n        isBusiness = true\r\n        confidence = 0.9\r\n    }\r\n\r\n    // 3. Select Entity\r\n    if (isPersonal) return { entityId: 'personal', confidence }\r\n\r\n    if (isBusiness) {\r\n        // If multiple businesses, try to find the best match or use the largest one\r\n        const activeEntities = state.entities?.filter(e => e.isActive && e.type !== 'personal') || []\r\n\r\n        if (activeEntities.length === 1) {\r\n            return { entityId: activeEntities[0].id, confidence: confidence * 0.95 }\r\n        }\r\n\r\n        // Multi-entity logic: look for name match in description or tags\r\n        for (const entity of activeEntities) {\r\n            if (desc.includes(entity.name.toLowerCase())) {\r\n                return { entityId: entity.id, confidence: 0.95 }\r\n            }\r\n        }\r\n\r\n        // Fallback: If low confidence and multiple businesses, don't auto-assign\r\n        if (activeEntities.length > 1) return null\r\n    }\r\n\r\n    // Final fallback based on overall merchant reputation if no category\r\n    if (confidence < 0.6) return null\r\n\r\n    return null\r\n}\r\n\r\n/**\r\n * Commits allocated receipts to the official ledger (expenses/deductions)\r\n */\r\nexport function syncReceiptsToLedger(state: FortunaState): void {\r\n    const allocated = state.receipts?.filter((r: any) => r.status === 'allocated') || []\r\n\r\n    for (const receipt of allocated) {\r\n        const { expenses, deductions } = generateLedgerEntries(receipt)\r\n\r\n        // Add to state if not already present\r\n        for (const exp of expenses) {\r\n            if (!state.expenses.find(e => e.sourceId === exp.sourceId)) {\r\n                state.expenses.push(exp)\r\n            }\r\n        }\r\n\r\n        for (const ded of deductions) {\r\n            if (!state.deductions.find(d => d.sourceId === ded.sourceId)) {\r\n                state.deductions.push(ded)\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nfunction generateLedgerEntries(receipt: ReceiptRecord): { expenses: BusinessExpense[], deductions: Deduction[] } {\r\n    const expenses: BusinessExpense[] = []\r\n    const deductions: Deduction[] = []\r\n\r\n    for (const item of receipt.items) {\r\n        if (!item.allocatedEntityId) continue\r\n\r\n        if (item.allocatedEntityId === 'personal') {\r\n            // Check for itemized personal deductions (charity, medical)\r\n            if (item.inferredCategory === 'Medical' || item.inferredCategory === 'Charity') {\r\n                deductions.push({\r\n                    id: genId(),\r\n                    description: `${receipt.merchantName}: ${item.description}`,\r\n                    categoryId: item.inferredCategory.toLowerCase(),\r\n                    amount: item.amount,\r\n                    status: 'realized',\r\n                    entityId: 'personal',\r\n                    sourceId: receipt.id + ':' + item.id,\r\n                    taxYear: new Date(receipt.date).getFullYear()\r\n                } as any)\r\n            }\r\n        } else {\r\n            // Business Expense\r\n            expenses.push({\r\n                id: genId(),\r\n                category: item.inferredCategory,\r\n                description: `${receipt.merchantName}: ${item.description}`,\r\n                annualAmount: item.amount,\r\n                isDeductible: true,\r\n                deductionPct: 1,\r\n                entityId: item.allocatedEntityId,\r\n                sourceId: receipt.id + ':' + item.id,\r\n                taxYear: new Date(receipt.date).getFullYear()\r\n            })\r\n        }\r\n    }\r\n\r\n    return { expenses, deductions }\r\n}\r\n\r\n/** \r\n * --- ADVANCED INTELLIGENCE MODULES ---\r\n */\r\n\r\nexport function analyzeReceiptIntelligence(state: FortunaState): ReceiptIntelligenceReport {\r\n    return {\r\n        subscriptions: detectSubscriptionOverlaps(state),\r\n        comminglingRisks: analyzeComminglingRisks(state),\r\n        goalAlignments: alignReceiptsWithGoals(state),\r\n        taxSignals: generateTaxSignals(state)\r\n    }\r\n}\r\n\r\nfunction detectSubscriptionOverlaps(state: FortunaState): SubscriptionInsight[] {\r\n    const recurring = state.receipts?.filter(r => r.isRecurring) || []\r\n    const merchants: Record<string, { entities: Set<string>, totalAmount: number }> = {}\r\n\r\n    for (const r of recurring) {\r\n        const m = r.merchantName.toLowerCase().trim()\r\n        if (!merchants[m]) merchants[m] = { entities: new Set(), totalAmount: 0 }\r\n\r\n        // Find assigned entities for items in this receipt\r\n        const entitiesInReceipt = new Set(r.items.map(i => i.allocatedEntityId).filter(Boolean) as string[])\r\n        entitiesInReceipt.forEach(e => merchants[m].entities.add(e))\r\n        merchants[m].totalAmount += r.totalAmount\r\n    }\r\n\r\n    return Object.entries(merchants)\r\n        .filter(([_, data]) => data.entities.size > 1)\r\n        .map(([name, data]) => ({\r\n            merchantName: name.charAt(0).toUpperCase() + name.slice(1),\r\n            entities: Array.from(data.entities),\r\n            totalMonthlyBurn: data.totalAmount, // Simple sum if monthly\r\n            isDuplicate: true,\r\n            recommendation: `Consolidate ${name} subscriptions. Found across: ${Array.from(data.entities).join(', ')}.`\r\n        }))\r\n}\r\n\r\nfunction analyzeComminglingRisks(state: FortunaState): ComminglingRisk[] {\r\n    const risks: ComminglingRisk[] = []\r\n    const receipts = state.receipts?.filter(r => r.status === 'allocated') || []\r\n\r\n    // We assume entities can have 'linkedAccountIds' in storage.ts\r\n    // For this engine, we'll check if a business-allocated receipt uses a 'personal' method\r\n    for (const r of receipts) {\r\n        const isBusinessReceipt = r.items.some(i => i.allocatedEntityId && i.allocatedEntityId !== 'personal')\r\n\r\n        // Simplified check: if it's business but paymentMethod is 'personal' (or vice-versa)\r\n        // In a real app, we'd look up the account type for r.paymentMethodId\r\n        if (isBusinessReceipt && r.paymentMethodId === 'personal_card') {\r\n            risks.push({\r\n                receiptId: r.id,\r\n                merchantName: r.merchantName,\r\n                amount: r.totalAmount,\r\n                assignedEntityId: 'business',\r\n                paymentMethodId: r.paymentMethodId,\r\n                riskLevel: 'medium',\r\n                description: `Business expense at ${r.merchantName} paid via personal account. Risk of piercing the corporate veil.`\r\n            })\r\n        }\r\n    }\r\n    return risks\r\n}\r\n\r\nfunction alignReceiptsWithGoals(state: FortunaState): GoalAlignment[] {\r\n    const taxGoals = state.goals?.filter(g => g.type === 'tax_reduction' && g.status === 'active') || []\r\n    const alignments: GoalAlignment[] = []\r\n\r\n    for (const goal of taxGoals) {\r\n        // Find receipts contributing to this year's tax deductions\r\n        const currentYear = new Date().getFullYear()\r\n        const relevantReceipts = state.receipts?.filter(r =>\r\n            r.status === 'allocated' &&\r\n            new Date(r.date).getFullYear() === currentYear &&\r\n            r.items.some(i => i.allocatedEntityId !== 'personal' || ['Medical', 'Charity'].includes(i.inferredCategory))\r\n        ) || []\r\n\r\n        const totalContribution = relevantReceipts.reduce((sum, r) => sum + r.totalAmount, 0)\r\n\r\n        if (totalContribution > 0) {\r\n            alignments.push({\r\n                goalId: goal.id,\r\n                goalTitle: goal.title,\r\n                contributionAmount: totalContribution,\r\n                receiptIds: relevantReceipts.map(r => r.id)\r\n            })\r\n        }\r\n    }\r\n    return alignments\r\n}\r\n\r\nfunction generateTaxSignals(state: FortunaState): TaxSignal[] {\r\n    const signals: TaxSignal[] = []\r\n\r\n    // 1. Deduction Velocity Check\r\n    const recentDeducibleTotal = state.receipts?.[0] ? 5000 : 0 // Mock check\r\n    if (recentDeducibleTotal > 0) {\r\n        signals.push({\r\n            type: 'deduction_velocity',\r\n            severity: 'info',\r\n            message: `High deduction velocity detected in Q1. Estimated tax liability may be lower than projected.`\r\n        })\r\n    }\r\n\r\n    // 2. Commingling Critical Warning\r\n    const comminglingCount = analyzeComminglingRisks(state).length\r\n    if (comminglingCount > 5) {\r\n        signals.push({\r\n            type: 'audit_risk',\r\n            severity: 'critical',\r\n            message: `${comminglingCount} commingled transactions detected. Immediate remediation recommended to protect limited liability.`\r\n        })\r\n    }\r\n\r\n    return signals\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\receipt-intelligence.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":8,"column":105,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":108,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[371,374],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[371,374],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[856,859],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[856,859],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":34,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1316,1319],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1316,1319],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":46,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1778,1781],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1778,1781],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect } from 'vitest'\r\nimport { analyzeReceiptIntelligence } from './receipt-engine'\r\nimport type { FortunaState } from './storage'\r\n\r\ndescribe('Receipt Intelligence', () => {\r\n    const mockState: Partial<FortunaState> = {\r\n        goals: [\r\n            { id: 'goal-1', title: 'Reduce Tax Liability', type: 'tax_reduction', status: 'active' } as any\r\n        ],\r\n        receipts: [\r\n            {\r\n                id: 'r1',\r\n                merchantName: 'Zoom',\r\n                isRecurring: true,\r\n                totalAmount: 14.99,\r\n                date: '2026-02-15',\r\n                status: 'allocated',\r\n                paymentMethodId: 'personal_card',\r\n                items: [\r\n                    { id: 'i1', description: 'Zoom Pro', amount: 14.99, allocatedEntityId: 'personal' }\r\n                ]\r\n            } as any,\r\n            {\r\n                id: 'r2',\r\n                merchantName: 'Zoom',\r\n                isRecurring: true,\r\n                totalAmount: 14.99,\r\n                date: '2026-02-16',\r\n                status: 'allocated',\r\n                paymentMethodId: 'personal_card',\r\n                items: [\r\n                    { id: 'i1', description: 'Zoom Business', amount: 14.99, allocatedEntityId: 'entity-123' }\r\n                ]\r\n            } as any,\r\n            {\r\n                id: 'r3',\r\n                merchantName: 'Best Buy',\r\n                isRecurring: false,\r\n                totalAmount: 1200.00,\r\n                date: '2026-02-20',\r\n                status: 'allocated',\r\n                paymentMethodId: 'personal_card',\r\n                items: [\r\n                    { id: 'i3', description: 'Laptop', amount: 1200.00, allocatedEntityId: 'entity-123' }\r\n                ]\r\n            } as any\r\n        ]\r\n    }\r\n\r\n    it('should detect subscription overlaps across entities', () => {\r\n        const report = analyzeReceiptIntelligence(mockState as FortunaState)\r\n        const zoomInsight = report.subscriptions.find(s => s.merchantName === 'Zoom')\r\n        expect(zoomInsight).toBeDefined()\r\n        expect(zoomInsight?.entities).toContain('personal')\r\n        expect(zoomInsight?.entities).toContain('entity-123')\r\n        expect(zoomInsight?.isDuplicate).toBe(true)\r\n    })\r\n\r\n    it('should identify commingling risks (business expense on personal card)', () => {\r\n        const report = analyzeReceiptIntelligence(mockState as FortunaState)\r\n        const commingling = report.comminglingRisks.find(r => r.merchantName === 'Best Buy')\r\n        expect(commingling).toBeDefined()\r\n        expect(commingling?.riskLevel).toBe('medium')\r\n    })\r\n\r\n    it('should align deductible receipts with active tax goals', () => {\r\n        const report = analyzeReceiptIntelligence(mockState as FortunaState)\r\n        const goalMatch = report.goalAlignments.find(a => a.goalTitle === 'Reduce Tax Liability')\r\n        expect(goalMatch).toBeDefined()\r\n        // Best Buy (1200) + Zoom Business (14.99)\r\n        expect(goalMatch?.contributionAmount).toBeGreaterThan(1200)\r\n    })\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\retirement-optimizer.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'rothMagiLimit' is assigned a value but never used.","line":184,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":184,"endColumn":22},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":760,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":760,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[28155,28158],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[28155,28158],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":760,"column":82,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":760,"endColumn":85,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[28186,28189],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[28186,28189],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":761,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":761,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[28228,28231],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[28228,28231],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — Retirement Optimizer v8\n *\n * Comprehensive retirement strategy optimization:\n *  - SEP IRA vs Solo 401(k) comparison with catch-up\n *  - Roth conversion ladder analysis (5-year projection)\n *  - Backdoor Roth IRA eligibility & guidance\n *  - Contribution timing optimization (front-load vs dollar-cost)\n *  - Multi-decade retirement projection with tax-aware modeling\n *  - Social Security optimization timing\n */\n\nimport type { FortunaState, RetirementAccount } from './storage'\nimport { generateTaxReport } from './tax-calculator'\n\n// ===================================================================\n//  2025 LIMITS\n// ===================================================================\n\nconst LIMITS = {\n  IRA_LIMIT: 7000,\n  IRA_CATCHUP_50: 1000,\n  SOLO_401K_EMPLOYEE: 23500,\n  SOLO_401K_CATCHUP_50: 7500,\n  SOLO_401K_CATCHUP_60_63: 11250, // SECURE 2.0\n  SOLO_401K_TOTAL: 70000,\n  SEP_RATE: 0.25, // 25% of net self-employment income\n  SEP_MAX: 70000,\n  ROTH_IRA_MAGI_SINGLE: 150000,\n  ROTH_IRA_PHASEOUT_SINGLE: 165000,\n  ROTH_IRA_MAGI_JOINT: 236000,\n  ROTH_IRA_PHASEOUT_JOINT: 246000,\n  TRAD_IRA_DEDUCT_MAGI_SINGLE: 83000, // if covered by employer plan\n  TRAD_IRA_DEDUCT_MAGI_JOINT: 136000,\n  HSA_SINGLE: 4300,\n  HSA_FAMILY: 8550,\n  HSA_CATCHUP_55: 1000,\n  SS_FULL_RETIREMENT_1960_PLUS: 67,\n  SS_EARLY: 62,\n  SS_DELAYED_MAX: 70,\n}\n\n// ===================================================================\n//  VEHICLE COMPARISON\n// ===================================================================\n\nexport interface RetirementVehicle {\n  name: string\n  type: 'sep_ira' | 'solo_401k' | 'trad_ira' | 'roth_ira' | 'backdoor_roth' | 'hsa'\n  maxContribution: number\n  employeeContribution: number\n  employerContribution: number\n  taxDeductionNow: number\n  taxFreeGrowth: boolean\n  taxFreeWithdrawal: boolean\n  eligibility: 'eligible' | 'income_limited' | 'ineligible'\n  eligibilityNote: string\n  pros: string[]\n  cons: string[]\n  bestFor: string\n  priority: number // higher = recommend more\n}\n\nexport interface RetirementComparison {\n  vehicles: RetirementVehicle[]\n  recommendedStrategy: string\n  totalMaxContribution: number\n  totalTaxDeduction: number\n  netSEIncome: number\n  agi: number\n  age: number\n}\n\nexport function compareRetirementVehicles(state: FortunaState): RetirementComparison {\n  const report = generateTaxReport(state)\n  const age = state.profile.age\n  const filing = state.profile.filingStatus\n  const isJoint = filing === 'married_joint'\n\n  const netSE = report.selfEmploymentIncome -\n    state.expenses.filter(e => e.isDeductible).reduce((s, e) => s + e.annualAmount * e.deductionPct / 100, 0)\n  const adjustedSE = Math.max(0, netSE * 0.9235) // SE income after half SE tax deduction\n\n  const catchup50 = age >= 50\n  const catchup60_63 = age >= 60 && age <= 63\n  const catchup55 = age >= 55\n\n  const vehicles: RetirementVehicle[] = []\n\n  // ---- SEP IRA ----\n  const sepMax = Math.min(LIMITS.SEP_MAX, adjustedSE * LIMITS.SEP_RATE)\n  if (netSE > 0) {\n    vehicles.push({\n      name: 'SEP IRA',\n      type: 'sep_ira',\n      maxContribution: Math.round(sepMax),\n      employeeContribution: 0,\n      employerContribution: Math.round(sepMax),\n      taxDeductionNow: Math.round(sepMax),\n      taxFreeGrowth: false,\n      taxFreeWithdrawal: false,\n      eligibility: 'eligible',\n      eligibilityNote: 'Available to any self-employed individual',\n      pros: [\n        'Simple to set up and maintain',\n        'High contribution limits for high earners',\n        'Flexible — no required annual contributions',\n        'Can be opened and funded up to tax filing deadline',\n      ],\n      cons: [\n        'No Roth option',\n        'No employee catch-up contributions',\n        'Contributions are percentage-based — lower income = lower limit',\n        'Cannot have both SEP and Solo 401k employer contributions',\n      ],\n      bestFor: 'High-income solopreneurs wanting simplicity',\n      priority: netSE > 200000 ? 7 : 5,\n    })\n  }\n\n  // ---- Solo 401(k) ----\n  const solo401kEmployee = Math.min(\n    LIMITS.SOLO_401K_EMPLOYEE + (catchup60_63 ? LIMITS.SOLO_401K_CATCHUP_60_63 : catchup50 ? LIMITS.SOLO_401K_CATCHUP_50 : 0),\n    adjustedSE,\n  )\n  const solo401kEmployer = Math.min(adjustedSE * 0.25, LIMITS.SOLO_401K_TOTAL - solo401kEmployee)\n  const solo401kTotal = Math.min(LIMITS.SOLO_401K_TOTAL, Math.round(solo401kEmployee + Math.max(0, solo401kEmployer)))\n\n  if (netSE > 0) {\n    vehicles.push({\n      name: 'Solo 401(k)',\n      type: 'solo_401k',\n      maxContribution: solo401kTotal,\n      employeeContribution: Math.round(solo401kEmployee),\n      employerContribution: Math.round(Math.max(0, solo401kEmployer)),\n      taxDeductionNow: solo401kTotal, // traditional portion\n      taxFreeGrowth: false,\n      taxFreeWithdrawal: false,\n      eligibility: 'eligible',\n      eligibilityNote: 'Available to self-employed with no employees (except spouse)',\n      pros: [\n        'Highest contribution limits of any retirement vehicle',\n        'Both employee + employer contributions',\n        'Roth option available for employee portion',\n        catchup50 ? `Age ${age} catch-up: +$${catchup60_63 ? LIMITS.SOLO_401K_CATCHUP_60_63.toLocaleString() : LIMITS.SOLO_401K_CATCHUP_50.toLocaleString()}` : 'Catch-up contributions at age 50+',\n        'Loan provision available',\n      ],\n      cons: [\n        'More paperwork than SEP (Form 5500-EZ if >$250k)',\n        'Must be established by Dec 31 of tax year',\n        'Cannot have employees (except spouse)',\n      ],\n      bestFor: 'Self-employed maximizing retirement savings',\n      priority: 9,\n    })\n  }\n\n  // ---- Traditional IRA ----\n  const iraLimit = LIMITS.IRA_LIMIT + (catchup50 ? LIMITS.IRA_CATCHUP_50 : 0)\n  const hasEmployerPlan = netSE > 0 // Solo 401k / SEP counts as employer plan\n  const magiLimit = isJoint ? LIMITS.TRAD_IRA_DEDUCT_MAGI_JOINT : LIMITS.TRAD_IRA_DEDUCT_MAGI_SINGLE\n  const deductible = !hasEmployerPlan || report.agi < magiLimit\n\n  vehicles.push({\n    name: 'Traditional IRA',\n    type: 'trad_ira',\n    maxContribution: iraLimit,\n    employeeContribution: iraLimit,\n    employerContribution: 0,\n    taxDeductionNow: deductible ? iraLimit : 0,\n    taxFreeGrowth: false,\n    taxFreeWithdrawal: false,\n    eligibility: deductible ? 'eligible' : 'income_limited',\n    eligibilityNote: deductible\n      ? 'Fully deductible at your income level'\n      : `Non-deductible: AGI ($${report.agi.toLocaleString()}) exceeds ${isJoint ? '$136K joint' : '$83K single'} with employer plan. Consider backdoor Roth instead.`,\n    pros: ['Tax-deductible contributions', 'No income limit to contribute', 'Simple to open'],\n    cons: ['Low contribution limit', 'Taxed on withdrawal', 'RMDs at 73', deductible ? '' : 'Non-deductible at your income'].filter(Boolean),\n    bestFor: 'Additional tax-deferred savings beyond 401k',\n    priority: deductible ? 4 : 1,\n  })\n\n  // ---- Roth IRA ----\n  const rothMagiLimit = isJoint ? LIMITS.ROTH_IRA_MAGI_SINGLE : LIMITS.ROTH_IRA_MAGI_SINGLE // simplified\n  const rothPhaseout = isJoint ? LIMITS.ROTH_IRA_PHASEOUT_JOINT : LIMITS.ROTH_IRA_PHASEOUT_SINGLE\n  const rothEligible = report.agi < rothPhaseout\n\n  vehicles.push({\n    name: 'Roth IRA',\n    type: 'roth_ira',\n    maxContribution: rothEligible ? iraLimit : 0,\n    employeeContribution: rothEligible ? iraLimit : 0,\n    employerContribution: 0,\n    taxDeductionNow: 0,\n    taxFreeGrowth: true,\n    taxFreeWithdrawal: true,\n    eligibility: rothEligible ? 'eligible' : 'income_limited',\n    eligibilityNote: rothEligible\n      ? 'Direct contributions allowed at your income level'\n      : `AGI ($${report.agi.toLocaleString()}) exceeds Roth limit. Use backdoor Roth instead.`,\n    pros: ['Tax-free growth forever', 'Tax-free withdrawal in retirement', 'No RMDs', 'Contributions withdrawable anytime penalty-free'],\n    cons: ['No tax deduction now', 'Income limits for direct contribution', 'Low contribution limit'],\n    bestFor: 'Tax-free retirement income',\n    priority: rothEligible ? 6 : 0,\n  })\n\n  // ---- Backdoor Roth ----\n  if (!rothEligible) {\n    vehicles.push({\n      name: 'Backdoor Roth IRA',\n      type: 'backdoor_roth',\n      maxContribution: iraLimit,\n      employeeContribution: iraLimit,\n      employerContribution: 0,\n      taxDeductionNow: 0,\n      taxFreeGrowth: true,\n      taxFreeWithdrawal: true,\n      eligibility: 'eligible',\n      eligibilityNote: 'Available via non-deductible Traditional IRA → Roth conversion. ⚠ Pro-rata rule applies if you have existing Traditional IRA balances.',\n      pros: ['Tax-free growth', 'No income limit', 'Bypasses Roth IRA income restrictions'],\n      cons: ['Pro-rata rule can trigger tax if existing Traditional IRA balance', 'Requires two-step process', 'Potential legislative risk'],\n      bestFor: 'High earners wanting Roth benefits',\n      priority: 7,\n    })\n  }\n\n  // ---- HSA ----\n  if (state.profile.hasHealthInsurance) {\n    const hsaLimit = (isJoint ? LIMITS.HSA_FAMILY : LIMITS.HSA_SINGLE) + (catchup55 ? LIMITS.HSA_CATCHUP_55 : 0)\n    vehicles.push({\n      name: 'HSA (Health Savings)',\n      type: 'hsa',\n      maxContribution: hsaLimit,\n      employeeContribution: hsaLimit,\n      employerContribution: 0,\n      taxDeductionNow: hsaLimit,\n      taxFreeGrowth: true,\n      taxFreeWithdrawal: true,\n      eligibility: 'eligible',\n      eligibilityNote: 'Requires High Deductible Health Plan (HDHP). Triple tax advantage: deductible, grows tax-free, withdraws tax-free for medical.',\n      pros: ['Triple tax advantage — only account with all three benefits', 'No use-it-or-lose-it (unlike FSA)', 'Rolls over year to year', 'After 65, can withdraw for any purpose (taxed like Traditional IRA)'],\n      cons: ['Requires HDHP enrollment', 'High deductible means more out-of-pocket', 'Limited to medical expenses before 65 for tax-free withdrawal'],\n      bestFor: 'Anyone with HDHP — the ultimate retirement stealth vehicle',\n      priority: 8,\n    })\n  }\n\n  // Sort by priority\n  vehicles.sort((a, b) => b.priority - a.priority)\n\n  // Build recommendation\n  const topVehicles = vehicles.filter(v => v.eligibility !== 'ineligible' && v.priority >= 5)\n  const totalMax = topVehicles.reduce((s, v) => s + v.maxContribution, 0)\n  const totalDeduction = topVehicles.reduce((s, v) => s + v.taxDeductionNow, 0)\n\n  let recommendation = ''\n  if (topVehicles.length > 0) {\n    const names = topVehicles.map(v => v.name).join(' → ')\n    recommendation = `Recommended priority: ${names}. Total max contribution: $${totalMax.toLocaleString()}/yr with $${totalDeduction.toLocaleString()} tax deduction.`\n  }\n\n  return {\n    vehicles,\n    recommendedStrategy: recommendation,\n    totalMaxContribution: totalMax,\n    totalTaxDeduction: totalDeduction,\n    netSEIncome: Math.max(0, netSE),\n    agi: report.agi,\n    age,\n  }\n}\n\n// ===================================================================\n//  ROTH CONVERSION LADDER\n// ===================================================================\n\nexport interface RothConversionYear {\n  year: number\n  age: number\n  convertAmount: number\n  taxOnConversion: number\n  marginalRate: number\n  netCost: number\n  cumulativeConverted: number\n  cumulativeTax: number\n  withdrawableYear: number // 5 years later\n  notes: string\n}\n\nexport interface RothLadderAnalysis {\n  years: RothConversionYear[]\n  totalConverted: number\n  totalTaxPaid: number\n  taxSavingsVsLumpSum: number\n  optimalAnnualConversion: number\n  strategy: string\n}\n\nexport function analyzeRothLadder(\n  state: FortunaState,\n  traditionalBalance: number,\n  targetRetirementAge: number,\n): RothLadderAnalysis {\n  const report = generateTaxReport(state)\n  const currentAge = state.profile.age\n  const yearsToRetirement = Math.max(1, targetRetirementAge - currentAge)\n  const currentYear = new Date().getFullYear()\n\n  // Find optimal conversion amount to stay in current bracket\n  const brackets2025 = [\n    { limit: 11925, rate: 0.10 },\n    { limit: 48475, rate: 0.12 },\n    { limit: 103350, rate: 0.22 },\n    { limit: 191950, rate: 0.24 },\n    { limit: 243725, rate: 0.32 },\n    { limit: 609350, rate: 0.35 },\n    { limit: Infinity, rate: 0.37 },\n  ]\n\n  // Find how much room in current bracket\n  const currentTaxable = report.agi - report.deductionAmount\n  let bracketRoom = 0\n  for (const bracket of brackets2025) {\n    if (currentTaxable < bracket.limit) {\n      bracketRoom = bracket.limit - currentTaxable\n      break\n    }\n  }\n\n  // Optimal conversion: fill current bracket without jumping\n  const optimalAnnual = Math.min(\n    Math.max(10000, bracketRoom),\n    traditionalBalance / Math.max(1, Math.min(yearsToRetirement, 10)),\n  )\n\n  const years: RothConversionYear[] = []\n  let cumConverted = 0\n  let cumTax = 0\n  let remaining = traditionalBalance\n\n  for (let i = 0; i < Math.min(yearsToRetirement, 15); i++) {\n    if (remaining <= 0) break\n\n    const convertAmount = Math.min(Math.round(optimalAnnual), remaining)\n    const taxableWithConversion = currentTaxable + convertAmount\n    \n    // Calculate marginal rate on conversion\n    let marginalRate = 0.10\n    for (const bracket of brackets2025) {\n      if (taxableWithConversion <= bracket.limit) {\n        marginalRate = bracket.rate\n        break\n      }\n      marginalRate = bracket.rate\n    }\n\n    const taxOnConversion = Math.round(convertAmount * marginalRate)\n    cumConverted += convertAmount\n    cumTax += taxOnConversion\n    remaining -= convertAmount\n\n    years.push({\n      year: currentYear + i,\n      age: currentAge + i,\n      convertAmount,\n      taxOnConversion,\n      marginalRate,\n      netCost: taxOnConversion,\n      cumulativeConverted: cumConverted,\n      cumulativeTax: cumTax,\n      withdrawableYear: currentYear + i + 5,\n      notes: i === 0 ? 'Start ladder' : remaining <= 0 ? 'Final conversion' : '',\n    })\n  }\n\n  // Lump sum comparison\n  const lumpSumRate = 0.32 // assume higher bracket for lump sum\n  const lumpSumTax = Math.round(traditionalBalance * lumpSumRate)\n  const savings = lumpSumTax - cumTax\n\n  const strategy = yearsToRetirement >= 5\n    ? `Convert ~$${Math.round(optimalAnnual).toLocaleString()}/yr over ${years.length} years to stay in the ${(years[0]?.marginalRate * 100 || 22).toFixed(0)}% bracket. Total tax: $${cumTax.toLocaleString()} vs $${lumpSumTax.toLocaleString()} lump sum — saving $${savings.toLocaleString()}.`\n    : 'With less than 5 years to retirement, a full Roth conversion ladder may not be optimal. Consider partial conversions focused on years with lower income.'\n\n  return {\n    years,\n    totalConverted: cumConverted,\n    totalTaxPaid: cumTax,\n    taxSavingsVsLumpSum: savings,\n    optimalAnnualConversion: Math.round(optimalAnnual),\n    strategy,\n  }\n}\n\n// ===================================================================\n//  RETIREMENT PROJECTION\n// ===================================================================\n\nexport interface RetirementProjectionYear {\n  year: number\n  age: number\n  balance: number\n  contributions: number\n  growth: number\n  withdrawals: number\n  taxOnWithdrawals: number\n}\n\nexport interface RetirementProjection {\n  years: RetirementProjectionYear[]\n  retirementAge: number\n  retirementBalance: number\n  sustainableWithdrawal: number // 4% rule\n  monthlyInRetirement: number\n  yearsOfFunding: number // at target withdrawal\n  socialSecurityEstimate: number\n  totalWithSS: number\n  shortfall: number\n  recommendation: string\n}\n\nexport function projectRetirement(\n  state: FortunaState,\n  currentBalance: number,\n  annualContribution: number,\n  returnRate: number = 0.07,\n  retirementAge: number = 65,\n  targetMonthlyIncome: number = 0,\n): RetirementProjection {\n  const age = state.profile.age\n  const yearsToRetirement = Math.max(0, retirementAge - age)\n  const currentYear = new Date().getFullYear()\n  const report = generateTaxReport(state)\n\n  // Default target: 80% of current income\n  const target = targetMonthlyIncome > 0\n    ? targetMonthlyIncome * 12\n    : report.grossIncome * 0.80\n\n  // Accumulation phase\n  const years: RetirementProjectionYear[] = []\n  let balance = currentBalance\n\n  for (let i = 0; i <= yearsToRetirement + 30; i++) {\n    const currentAge = age + i\n    const isRetired = currentAge >= retirementAge\n    const contributions = isRetired ? 0 : annualContribution\n    const growth = Math.round(balance * returnRate)\n    const withdrawals = isRetired ? Math.round(balance * 0.04) : 0 // 4% rule\n    const taxRate = isRetired ? 0.15 : 0 // estimated blended rate in retirement\n    const taxOnWithdrawals = Math.round(withdrawals * taxRate)\n\n    years.push({\n      year: currentYear + i,\n      age: currentAge,\n      balance: Math.round(balance),\n      contributions,\n      growth,\n      withdrawals,\n      taxOnWithdrawals,\n    })\n\n    balance = balance + contributions + growth - withdrawals\n    if (balance <= 0 && isRetired) break\n    if (currentAge > 100) break\n  }\n\n  const retirementBalance = years.find(y => y.age === retirementAge)?.balance || 0\n  const sustainableWithdrawal = Math.round(retirementBalance * 0.04)\n  const monthlyInRetirement = Math.round(sustainableWithdrawal / 12)\n\n  // Social Security estimate (simplified)\n  const avgEarnings = Math.min(report.grossIncome, 176100) // SS wage base\n  const estimatedPIA = Math.round(avgEarnings * 0.012 + 15000) // rough approximation\n  const ssMonthly = Math.round(estimatedPIA / 12)\n\n  const totalMonthly = monthlyInRetirement + ssMonthly\n  const shortfall = Math.max(0, Math.round(target / 12) - totalMonthly)\n\n  // Years of funding\n  const yearsOfFunding = sustainableWithdrawal > 0 ? Math.round(retirementBalance / sustainableWithdrawal) : 0\n\n  let recommendation = ''\n  if (shortfall > 0) {\n    const additionalNeeded = Math.round(shortfall * 12 / 0.04)\n    recommendation = `Current trajectory shows a $${shortfall.toLocaleString()}/mo shortfall vs target. Increase annual contributions by ~$${Math.round(additionalNeeded / yearsToRetirement).toLocaleString()}/yr or target ${Math.round(returnRate * 100) + 1}% returns to close the gap.`\n  } else {\n    recommendation = `On track to exceed retirement income target by $${Math.abs(shortfall).toLocaleString()}/mo. Consider maximizing tax-advantaged accounts and exploring Roth conversions to reduce future tax burden.`\n  }\n\n  return {\n    years: years.slice(0, yearsToRetirement + 31),\n    retirementAge,\n    retirementBalance: Math.round(retirementBalance),\n    sustainableWithdrawal,\n    monthlyInRetirement,\n    yearsOfFunding,\n    socialSecurityEstimate: ssMonthly,\n    totalWithSS: totalMonthly,\n    shortfall,\n    recommendation,\n  }\n}\n\n// ─── Phase F: Type Adapters ─────────────────────────────────────────────────\n\nconst VEHICLE_TO_ACCOUNT_TYPE: Record<string, RetirementAccount['type']> = {\n  sep_ira: 'sep_ira',\n  solo_401k: 'solo_401k',\n  trad_ira: 'traditional_ira',\n  roth_ira: 'roth_ira',\n  backdoor_roth: 'roth_ira',\n  hsa: 'hsa',\n}\n\nconst ACCOUNT_TO_VEHICLE_TYPE: Record<string, RetirementVehicle['type'] | null> = {\n  traditional_401k: null,  // Not modeled by optimizer (employer plan)\n  roth_401k: null,\n  solo_401k: 'solo_401k',\n  sep_ira: 'sep_ira',\n  simple_ira: null,\n  traditional_ira: 'trad_ira',\n  roth_ira: 'roth_ira',\n  hsa: 'hsa',\n  pension: null,\n  other: null,\n}\n\n/** Convert optimizer RetirementVehicle → storage RetirementAccount */\nexport function vehicleToAccount(vehicle: RetirementVehicle, existingAccount?: RetirementAccount): RetirementAccount {\n  return {\n    id: existingAccount?.id || `ret-${vehicle.type}`,\n    name: vehicle.name,\n    type: VEHICLE_TO_ACCOUNT_TYPE[vehicle.type] || 'other',\n    balance: existingAccount?.balance || 0,\n    annualContribution: vehicle.employeeContribution + vehicle.employerContribution,\n    employerMatch: vehicle.employerContribution > 0 ? vehicle.employerContribution : undefined,\n    maxContribution: vehicle.maxContribution,\n    isTaxDeductible: vehicle.taxDeductionNow > 0,\n    entityId: existingAccount?.entityId || 'personal',\n    memberId: existingAccount?.memberId || 'primary',\n    taxYear: new Date().getFullYear(),\n    tags: existingAccount?.tags || [],\n  }\n}\n\n/** Convert storage RetirementAccount → optimizer RetirementVehicle (partial) */\nexport function accountToVehicle(account: RetirementAccount): Partial<RetirementVehicle> & { type: string } {\n  return {\n    name: account.name,\n    type: ACCOUNT_TO_VEHICLE_TYPE[account.type] || 'trad_ira',\n    maxContribution: account.maxContribution,\n    employeeContribution: account.annualContribution,\n    employerContribution: account.employerMatch || 0,\n    taxDeductionNow: account.isTaxDeductible ? account.annualContribution : 0,\n  }\n}\n\n/** Merge optimizer recommendations into existing RetirementAccount[] */\nexport function mergeVehicleRecommendations(\n  existingAccounts: RetirementAccount[],\n  vehicles: RetirementVehicle[],\n): RetirementAccount[] {\n  const result = [...existingAccounts]\n\n  for (const vehicle of vehicles) {\n    if (vehicle.eligibility === 'ineligible') continue\n    const accountType = VEHICLE_TO_ACCOUNT_TYPE[vehicle.type]\n    if (!accountType) continue\n\n    const existing = result.find(a => a.type === accountType)\n    if (existing) {\n      // Update max contribution from optimizer\n      existing.maxContribution = vehicle.maxContribution\n    } else {\n      // Add new recommended account\n      result.push(vehicleToAccount(vehicle))\n    }\n  }\n\n  return result\n}\n\n// ==================== Roth Conversion Optimizer ====================\n// Strategic analysis: when to convert traditional → Roth IRA considering\n// bracket filling, TCJA sunset, IRMAA thresholds, and RMD avoidance.\n\n// TCJA sunset brackets (revert to pre-TCJA rates after 2025)\nconst POST_TCJA_BRACKETS_SINGLE = [\n  { limit: 10275, rate: 0.10 },\n  { limit: 41775, rate: 0.15 },\n  { limit: 89075, rate: 0.25 },\n  { limit: 170050, rate: 0.28 },\n  { limit: 215950, rate: 0.33 },\n  { limit: 539900, rate: 0.35 },\n  { limit: Infinity, rate: 0.396 },\n]\n\nconst POST_TCJA_BRACKETS_JOINT = [\n  { limit: 20550, rate: 0.10 },\n  { limit: 83550, rate: 0.15 },\n  { limit: 178150, rate: 0.25 },\n  { limit: 340100, rate: 0.28 },\n  { limit: 431900, rate: 0.33 },\n  { limit: 647850, rate: 0.35 },\n  { limit: Infinity, rate: 0.396 },\n]\n\n// IRMAA thresholds (Medicare surcharges for high-income retirees)\nconst IRMAA_THRESHOLDS_2024 = [\n  { magi: 103000, monthlyPremiumAdd: 0, label: 'Standard' },\n  { magi: 129000, monthlyPremiumAdd: 65.90, label: 'Tier 1' },\n  { magi: 161000, monthlyPremiumAdd: 164.80, label: 'Tier 2' },\n  { magi: 193000, monthlyPremiumAdd: 263.70, label: 'Tier 3' },\n  { magi: 500000, monthlyPremiumAdd: 362.60, label: 'Tier 4' },\n  { magi: Infinity, monthlyPremiumAdd: 395.60, label: 'Tier 5' },\n]\n\nexport interface RothConversionStrategy {\n  optimalAnnualConversion: number\n  currentBracketRoom: number\n  currentMarginalRate: number\n  nextBracketRate: number\n  tcjaSunsetImpact: {\n    currentRateOnConversion: number\n    postSunsetRate: number\n    urgencyScore: number // 0-100: how urgent is it to convert before sunset\n    savingsIfConvertNow: number\n  }\n  irmaaImpact: {\n    currentTier: string\n    conversionTriggersNextTier: boolean\n    maxConversionBeforeIRMAA: number\n    annualIRMAACost: number\n  }\n  rmdAvoidance: {\n    projectedRMDAge72: number // what RMDs would be without conversion\n    rmdReductionFromConversion: number\n    lifetimeTaxSavingsFromRMDReduction: number\n  }\n  breakEvenYears: number // years until Roth advantage exceeds tax cost\n  yearByYear: {\n    year: number\n    convertAmount: number\n    taxCost: number\n    cumulativeConverted: number\n    cumulativeTax: number\n    remainingTraditional: number\n    projectedRothBalance: number\n    bracketUsed: string\n    isTCJAWindow: boolean\n  }[]\n  summary: string\n  recommendation: 'aggressive' | 'moderate' | 'conservative' | 'wait'\n  reasons: string[]\n}\n\nexport function optimizeRothConversion(\n  state: FortunaState,\n  traditionalBalance: number,\n  targetRetirementAge: number = 65,\n  expectedReturnRate: number = 0.07,\n  retirementTaxRate: number | null = null, // if null, estimated from projection\n): RothConversionStrategy {\n  const report = generateTaxReport(state)\n  const currentAge = state.profile.age\n  const yearsToRetirement = Math.max(1, targetRetirementAge - currentAge)\n  const currentYear = new Date().getFullYear()\n  const isJoint = state.profile.filingStatus === 'married_joint'\n\n  // Current bracket analysis\n  const currentTaxable = report.taxableIncome\n  const brackets2025 = isJoint\n    ? [\n        { limit: 23200, rate: 0.10, label: '10%' }, { limit: 94300, rate: 0.12, label: '12%' },\n        { limit: 201050, rate: 0.22, label: '22%' }, { limit: 383900, rate: 0.24, label: '24%' },\n        { limit: 487450, rate: 0.32, label: '32%' }, { limit: 731200, rate: 0.35, label: '35%' },\n        { limit: Infinity, rate: 0.37, label: '37%' },\n      ]\n    : [\n        { limit: 11600, rate: 0.10, label: '10%' }, { limit: 47150, rate: 0.12, label: '12%' },\n        { limit: 100525, rate: 0.22, label: '22%' }, { limit: 191950, rate: 0.24, label: '24%' },\n        { limit: 243725, rate: 0.32, label: '32%' }, { limit: 609350, rate: 0.35, label: '35%' },\n        { limit: Infinity, rate: 0.37, label: '37%' },\n      ]\n\n  let bracketRoom = 0\n  let currentRate = 0.10\n  let nextRate = 0.12\n  let currentLabel = '10%'\n  for (let i = 0; i < brackets2025.length; i++) {\n    if (currentTaxable < brackets2025[i].limit) {\n      bracketRoom = brackets2025[i].limit - currentTaxable\n      currentRate = brackets2025[i].rate\n      currentLabel = brackets2025[i].label\n      nextRate = i + 1 < brackets2025.length ? brackets2025[i + 1].rate : currentRate\n      break\n    }\n  }\n\n  // TCJA sunset analysis — rates revert after 2025\n  const postSunsetBrackets = isJoint ? POST_TCJA_BRACKETS_JOINT : POST_TCJA_BRACKETS_SINGLE\n  let postSunsetRate = 0.10\n  for (const b of postSunsetBrackets) {\n    if (currentTaxable <= b.limit) { postSunsetRate = b.rate; break }\n    postSunsetRate = b.rate\n  }\n  const tcjaWindowRemaining = Math.max(0, 2026 - currentYear) // years of TCJA rates left\n  const rateDelta = postSunsetRate - currentRate\n  const urgencyScore = Math.min(100, Math.round(\n    (rateDelta > 0 ? 40 : 0) + // rates going up = urgent\n    (tcjaWindowRemaining <= 1 ? 30 : tcjaWindowRemaining <= 2 ? 15 : 0) + // time pressure\n    (traditionalBalance > 500000 ? 20 : traditionalBalance > 200000 ? 10 : 0) + // balance size\n    (currentRate <= 0.22 ? 10 : 0) // low current rate = good time\n  ))\n\n  // IRMAA analysis (relevant for age 63+ due to 2-year lookback)\n  const agi = report.agi\n  let currentIRMAATier = IRMAA_THRESHOLDS_2024[0]\n  let maxBeforeNextIRMAA = Infinity\n  for (let i = 0; i < IRMAA_THRESHOLDS_2024.length; i++) {\n    if (agi <= IRMAA_THRESHOLDS_2024[i].magi) {\n      currentIRMAATier = IRMAA_THRESHOLDS_2024[i]\n      maxBeforeNextIRMAA = IRMAA_THRESHOLDS_2024[i].magi - agi\n      break\n    }\n  }\n  const conversionTriggersIRMAA = bracketRoom > 0 && maxBeforeNextIRMAA < bracketRoom\n\n  // RMD avoidance projection\n  const rmdAge72Balance = traditionalBalance * Math.pow(1 + expectedReturnRate, Math.max(0, 72 - currentAge))\n  const rmdFactor72 = 27.4 // IRS Uniform Lifetime Table at 72\n  const projectedRMDAge72 = Math.round(rmdAge72Balance / rmdFactor72)\n\n  // Optimal annual conversion\n  const optimal = Math.min(\n    bracketRoom > 0 ? bracketRoom : 50000,\n    Math.min(maxBeforeNextIRMAA, Infinity),\n    traditionalBalance / Math.max(1, Math.min(yearsToRetirement, 15)),\n  )\n  const optimalAnnual = Math.max(5000, Math.round(optimal / 1000) * 1000) // round to nearest $1k\n\n  // Year-by-year projection\n  const yearByYear: RothConversionStrategy['yearByYear']  = []\n  let remaining = traditionalBalance\n  let cumConverted = 0\n  let cumTax = 0\n  let rothBalance = 0\n\n  for (let i = 0; i < Math.min(yearsToRetirement, 20); i++) {\n    if (remaining <= 0) break\n    const year = currentYear + i\n    const isTCJA = year <= 2025\n    const convertAmount = Math.min(Math.round(optimalAnnual), remaining)\n\n    // Use current rates if TCJA window, post-sunset otherwise\n    const activeBrackets = isTCJA ? brackets2025 : postSunsetBrackets\n    let yearRate = 0.10\n    for (const b of activeBrackets) {\n      if (currentTaxable + convertAmount <= (b as any).limit) { yearRate = (b as any).rate; break }\n      yearRate = (b as any).rate\n    }\n    const taxCost = Math.round(convertAmount * yearRate)\n    cumConverted += convertAmount\n    cumTax += taxCost\n    remaining -= convertAmount\n    rothBalance = (rothBalance + convertAmount) * (1 + expectedReturnRate)\n\n    yearByYear.push({\n      year,\n      convertAmount,\n      taxCost,\n      cumulativeConverted: cumConverted,\n      cumulativeTax: cumTax,\n      remainingTraditional: Math.round(remaining * Math.pow(1 + expectedReturnRate, 1)),\n      projectedRothBalance: Math.round(rothBalance),\n      bracketUsed: `${(yearRate * 100).toFixed(0)}%`,\n      isTCJAWindow: isTCJA,\n    })\n  }\n\n  // Break-even: how many years until Roth tax-free growth > conversion tax cost\n  const estimatedRetirementRate = retirementTaxRate || Math.max(0.15, currentRate - 0.05)\n  const annualTaxCost = optimalAnnual * currentRate\n  const annualRothBenefit = optimalAnnual * expectedReturnRate * estimatedRetirementRate\n  const breakEvenYears = annualRothBenefit > 0 ? Math.ceil(annualTaxCost / annualRothBenefit) : 99\n\n  // RMD reduction from converting\n  const convertedByRetirement = yearByYear.reduce((s, y) => s + y.convertAmount, 0)\n  const reducedTraditional = traditionalBalance - convertedByRetirement\n  const reducedRMDBalance = reducedTraditional * Math.pow(1 + expectedReturnRate, Math.max(0, 72 - currentAge))\n  const reducedRMD = Math.round(reducedRMDBalance / rmdFactor72)\n  const rmdReduction = projectedRMDAge72 - reducedRMD\n  const lifetimeRMDSavings = Math.round(rmdReduction * estimatedRetirementRate * 15) // ~15 years of RMDs\n\n  // Recommendation\n  const reasons: string[] = []\n  let recommendation: RothConversionStrategy['recommendation'] = 'moderate'\n\n  if (rateDelta > 0.02) { reasons.push(`TCJA sunset will increase your rate from ${(currentRate * 100).toFixed(0)}% to ${(postSunsetRate * 100).toFixed(0)}% — convert while rates are low`); recommendation = 'aggressive' }\n  if (currentRate <= 0.22) { reasons.push(`Current ${(currentRate * 100).toFixed(0)}% bracket is historically low — favorable conversion window`); if (recommendation !== 'aggressive') recommendation = 'aggressive' }\n  if (breakEvenYears > yearsToRetirement) { reasons.push(`Break-even is ${breakEvenYears} years vs ${yearsToRetirement} years to retirement — payoff may not materialize`); recommendation = 'conservative' }\n  if (projectedRMDAge72 > 100000) { reasons.push(`Projected RMDs of $${projectedRMDAge72.toLocaleString()}/year at 72 — conversion reduces forced distributions by $${rmdReduction.toLocaleString()}/year`) }\n  if (currentAge >= 55 && traditionalBalance > 500000) { reasons.push('Large traditional balance with limited conversion window — front-load conversions') }\n  if (conversionTriggersIRMAA && currentAge >= 61) { reasons.push(`Limit conversion to $${Math.round(maxBeforeNextIRMAA).toLocaleString()} to avoid IRMAA surcharge ($${Math.round(currentIRMAATier.monthlyPremiumAdd * 12).toLocaleString()}/year)`) }\n  if (reasons.length === 0) reasons.push('Standard bracket-filling Roth conversion recommended')\n\n  const summary = recommendation === 'aggressive'\n    ? `Convert $${optimalAnnual.toLocaleString()}/year aggressively — TCJA sunset and low bracket create ideal window. ${breakEvenYears}-year break-even.`\n    : recommendation === 'conservative'\n      ? `Conservative approach recommended — convert $${Math.round(optimalAnnual * 0.5).toLocaleString()}/year to stay well within bracket.`\n      : `Convert $${optimalAnnual.toLocaleString()}/year to fill ${currentLabel} bracket. Break-even in ${breakEvenYears} years.`\n\n  return {\n    optimalAnnualConversion: optimalAnnual,\n    currentBracketRoom: Math.round(bracketRoom),\n    currentMarginalRate: currentRate,\n    nextBracketRate: nextRate,\n    tcjaSunsetImpact: {\n      currentRateOnConversion: currentRate,\n      postSunsetRate,\n      urgencyScore,\n      savingsIfConvertNow: Math.round(traditionalBalance * rateDelta * 0.3),\n    },\n    irmaaImpact: {\n      currentTier: currentIRMAATier.label,\n      conversionTriggersNextTier: conversionTriggersIRMAA,\n      maxConversionBeforeIRMAA: Math.round(maxBeforeNextIRMAA),\n      annualIRMAACost: Math.round(currentIRMAATier.monthlyPremiumAdd * 12),\n    },\n    rmdAvoidance: {\n      projectedRMDAge72,\n      rmdReductionFromConversion: rmdReduction,\n      lifetimeTaxSavingsFromRMDReduction: lifetimeRMDSavings,\n    },\n    breakEvenYears,\n    yearByYear,\n    summary,\n    recommendation,\n    reasons,\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\scenario-modeler.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'state' is never reassigned. Use 'const' instead.","line":296,"column":7,"nodeType":"Identifier","messageId":"useConst","endLine":296,"endColumn":26,"fix":{"range":[9335,9398],"text":"const state: FortunaState = JSON.parse(JSON.stringify(baseState))"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":373,"column":80,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":373,"endColumn":83,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13137,13140],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13137,13140],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":572,"column":97,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":572,"endColumn":100,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21649,21652],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21649,21652],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine - Scenario Modeler v2\n * Interactive what-if analysis with multi-year projections,\n * reverse calculators, waterfall breakdowns, and real-time sliders\n */\n\nimport type { FortunaState, IncomeStream, LegalEntity, Deduction } from './storage'\nimport { generateTaxReport, calculateMaxSEPIRA, type TaxReport } from './tax-calculator'\nimport { calculateHealthScore, type FinancialHealthScore } from './strategy-detector'\nimport { genId } from './storage'\nimport { hasPortfolioData, getPortfolioScenarios } from './portfolio-bridge'\n\n// ─── Core Types ──────────────────────────────────────────────────\n\nexport interface ScenarioModification {\n  type: 'add_income' | 'remove_income' | 'modify_income' | 'change_entity' | 'add_deduction' | 'remove_deduction' | 'modify_deduction' | 'add_expense' | 'change_filing' | 'change_state'\n  incomeId?: string\n  incomeName?: string\n  incomeType?: IncomeStream['type']\n  incomeAmount?: number\n  entityType?: LegalEntity['type']\n  entityCost?: number\n  deductionId?: string\n  deductionName?: string\n  deductionCategory?: Deduction['category']\n  deductionAmount?: number\n  expenseDesc?: string\n  expenseAmount?: number\n  expensePct?: number\n  filingStatus?: string\n  stateCode?: string\n}\n\nexport interface ScenarioResult {\n  name: string\n  modifications: ScenarioModification[]\n  taxReport: TaxReport\n  healthScore: FinancialHealthScore\n  state: FortunaState\n}\n\nexport interface ScenarioComparison {\n  baseline: ScenarioResult\n  scenarios: ScenarioResult[]\n}\n\n// ─── Waterfall Breakdown ─────────────────────────────────────────\n\nexport interface WaterfallSegment {\n  label: string\n  amount: number\n  cumulative: number\n  type: 'income' | 'deduction' | 'tax' | 'net'\n  color: string\n}\n\nexport function generateWaterfall(report: TaxReport): WaterfallSegment[] {\n  const segments: WaterfallSegment[] = []\n  let cumulative = 0\n\n  cumulative = report.grossIncome\n  segments.push({ label: 'Gross Revenue', amount: report.grossIncome, cumulative, type: 'income', color: '#60a5fa' })\n\n  const businessDeductions = report.grossIncome - report.agi\n  if (businessDeductions > 0) {\n    cumulative -= businessDeductions\n    segments.push({ label: 'Business Expenses', amount: -businessDeductions, cumulative, type: 'deduction', color: '#f59e0b' })\n  }\n\n  const halfSE = report.selfEmploymentTax * 0.5\n  if (halfSE > 0) {\n    cumulative -= halfSE\n    segments.push({ label: 'SE Tax Ded.', amount: -halfSE, cumulative, type: 'deduction', color: '#f59e0b' })\n  }\n\n  const personalDeductions = report.agi - report.taxableIncome - (report.qbiDeduction || 0) + halfSE\n  if (personalDeductions > 0) {\n    cumulative -= personalDeductions\n    segments.push({ label: 'Std. Deduction', amount: -personalDeductions, cumulative, type: 'deduction', color: '#fbbf24' })\n  }\n\n  if (report.qbiDeduction > 0) {\n    cumulative -= report.qbiDeduction\n    segments.push({ label: 'QBI Deduction', amount: -report.qbiDeduction, cumulative, type: 'deduction', color: '#fbbf24' })\n  }\n\n  if (report.federalIncomeTax > 0) {\n    cumulative -= report.federalIncomeTax\n    segments.push({ label: 'Federal Tax', amount: -report.federalIncomeTax, cumulative, type: 'tax', color: '#ef4444' })\n  }\n\n  if (report.selfEmploymentTax > 0) {\n    cumulative -= report.selfEmploymentTax\n    segments.push({ label: 'SE Tax', amount: -report.selfEmploymentTax, cumulative, type: 'tax', color: '#dc2626' })\n  }\n\n  if (report.stateTax > 0) {\n    cumulative -= report.stateTax\n    segments.push({ label: 'State Tax', amount: -report.stateTax, cumulative, type: 'tax', color: '#b91c1c' })\n  }\n\n  segments.push({ label: 'You Keep', amount: report.afterTaxIncome, cumulative: report.afterTaxIncome, type: 'net', color: '#10b981' })\n\n  return segments\n}\n\n// ─── Multi-Year Projections ──────────────────────────────────────\n\nexport interface ProjectionYear {\n  year: number\n  grossIncome: number\n  totalTax: number\n  afterTaxIncome: number\n  effectiveRate: number\n  cumulativeAfterTax: number\n  cumulativeTax: number\n  retirementBalance: number\n}\n\nexport interface ProjectionConfig {\n  years: number\n  annualGrowthRate: number\n  inflationRate: number\n  retirementContribRate: number\n  retirementReturnRate: number\n}\n\nexport const DEFAULT_PROJECTION: ProjectionConfig = {\n  years: 5,\n  annualGrowthRate: 0.10,\n  inflationRate: 0.03,\n  retirementContribRate: 0.10,\n  retirementReturnRate: 0.08,\n}\n\nexport function projectMultiYear(\n  baseState: FortunaState,\n  mods: ScenarioModification[],\n  config: ProjectionConfig = DEFAULT_PROJECTION\n): ProjectionYear[] {\n  const projections: ProjectionYear[] = []\n  let cumulativeAfterTax = 0\n  let cumulativeTax = 0\n  let retirementBalance = 0\n  const currentYear = new Date().getFullYear()\n\n  for (let i = 0; i < config.years; i++) {\n    const growthMultiplier = Math.pow(1 + config.annualGrowthRate, i)\n    const yearState: FortunaState = JSON.parse(JSON.stringify(baseState))\n\n    yearState.incomeStreams = yearState.incomeStreams.map(s => ({\n      ...s,\n      annualAmount: Math.round(s.annualAmount * growthMultiplier),\n    }))\n\n    const modifiedState = mods.length > 0 ? applyModifications(yearState, mods) : yearState\n    const report = generateTaxReport(modifiedState)\n\n    const retirementContrib = Math.round(report.grossIncome * config.retirementContribRate)\n    retirementBalance = Math.round((retirementBalance + retirementContrib) * (1 + config.retirementReturnRate))\n\n    cumulativeAfterTax += report.afterTaxIncome\n    cumulativeTax += report.totalTax\n\n    projections.push({\n      year: currentYear + i,\n      grossIncome: report.grossIncome,\n      totalTax: report.totalTax,\n      afterTaxIncome: report.afterTaxIncome,\n      effectiveRate: report.effectiveRate,\n      cumulativeAfterTax,\n      cumulativeTax,\n      retirementBalance,\n    })\n  }\n\n  return projections\n}\n\n// ─── Reverse Calculator ──────────────────────────────────────────\n\nexport interface ReverseCalcResult {\n  targetAfterTax: number\n  requiredGrossIncome: number\n  totalTaxAtTarget: number\n  effectiveRateAtTarget: number\n  marginalRateAtTarget: number\n}\n\nexport function reverseCalculateIncome(\n  baseState: FortunaState,\n  targetAfterTax: number\n): ReverseCalcResult {\n  let low = targetAfterTax\n  let high = targetAfterTax * 3\n  let bestGuess = targetAfterTax\n  let bestReport: TaxReport | null = null\n\n  const testState: FortunaState = JSON.parse(JSON.stringify(baseState))\n  const primaryType = testState.incomeStreams.find(s => s.isActive)?.type || 'business'\n  testState.incomeStreams = [{ id: 'rc', name: 'Target', type: primaryType, annualAmount: high, isActive: true }]\n\n  let testReport = generateTaxReport(testState)\n  let iter = 0\n  while (testReport.afterTaxIncome < targetAfterTax && iter < 10) {\n    high *= 2\n    testState.incomeStreams[0].annualAmount = high\n    testReport = generateTaxReport(testState)\n    iter++\n  }\n\n  while (high - low > 100 && iter < 60) {\n    const mid = Math.round((low + high) / 2)\n    testState.incomeStreams[0].annualAmount = mid\n    testReport = generateTaxReport(testState)\n\n    if (testReport.afterTaxIncome < targetAfterTax) {\n      low = mid\n    } else {\n      high = mid\n      bestGuess = mid\n      bestReport = testReport\n    }\n    iter++\n  }\n\n  if (!bestReport) {\n    testState.incomeStreams[0].annualAmount = bestGuess\n    bestReport = generateTaxReport(testState)\n  }\n\n  return {\n    targetAfterTax,\n    requiredGrossIncome: bestGuess,\n    totalTaxAtTarget: bestReport.totalTax,\n    effectiveRateAtTarget: bestReport.effectiveRate,\n    marginalRateAtTarget: bestReport.marginalRate,\n  }\n}\n\n// ─── Income Sensitivity Curve ────────────────────────────────────\n\nexport interface SensitivityPoint {\n  income: number\n  totalTax: number\n  afterTax: number\n  effectiveRate: number\n  marginalRate: number\n  federalTax: number\n  seTax: number\n  stateTax: number\n}\n\nexport function generateSensitivityCurve(\n  baseState: FortunaState,\n  incomeRange: { min: number; max: number },\n  points: number = 25\n): SensitivityPoint[] {\n  const curve: SensitivityPoint[] = []\n  const step = (incomeRange.max - incomeRange.min) / (points - 1)\n\n  for (let i = 0; i < points; i++) {\n    const income = Math.round(incomeRange.min + step * i)\n    const testState: FortunaState = JSON.parse(JSON.stringify(baseState))\n\n    const currentTotal = testState.incomeStreams.filter(s => s.isActive).reduce((s, inc) => s + inc.annualAmount, 0)\n    if (currentTotal > 0) {\n      const scale = income / currentTotal\n      testState.incomeStreams = testState.incomeStreams.map(s => ({\n        ...s,\n        annualAmount: s.isActive ? Math.round(s.annualAmount * scale) : s.annualAmount,\n      }))\n    } else {\n      testState.incomeStreams = [{ id: 'sens', name: 'Income', type: 'business', annualAmount: income, isActive: true }]\n    }\n\n    const report = generateTaxReport(testState)\n    curve.push({\n      income,\n      totalTax: report.totalTax,\n      afterTax: report.afterTaxIncome,\n      effectiveRate: report.effectiveRate,\n      marginalRate: report.marginalRate,\n      federalTax: report.federalIncomeTax,\n      seTax: report.selfEmploymentTax,\n      stateTax: report.stateTax,\n    })\n  }\n\n  return curve\n}\n\n// ─── Apply Modifications ─────────────────────────────────────────\n\nexport function applyModifications(baseState: FortunaState, mods: ScenarioModification[]): FortunaState {\n  let state: FortunaState = JSON.parse(JSON.stringify(baseState))\n\n  for (const mod of mods) {\n    switch (mod.type) {\n      case 'add_income':\n        state.incomeStreams.push({\n          id: genId(), name: mod.incomeName || 'New Income',\n          type: mod.incomeType || 'business', annualAmount: mod.incomeAmount || 0, isActive: true,\n        })\n        break\n      case 'remove_income':\n        state.incomeStreams = state.incomeStreams.filter(s => s.id !== mod.incomeId)\n        break\n      case 'modify_income':\n        state.incomeStreams = state.incomeStreams.map(s =>\n          s.id === mod.incomeId ? { ...s, annualAmount: mod.incomeAmount ?? s.annualAmount, name: mod.incomeName ?? s.name } : s\n        )\n        break\n      case 'change_entity': {\n        const entityName = mod.entityType === 'sole_prop' ? 'Sole Proprietorship'\n          : mod.entityType === 'llc' ? 'Business LLC'\n          : mod.entityType === 'llc_scorp' ? 'Business LLC (S-Corp)'\n          : mod.entityType === 'scorp' ? 'S-Corporation'\n          : mod.entityType === 'ccorp' ? 'C-Corporation' : 'Entity'\n        const newEntityId = genId()\n        state.entities = mod.entityType === 'sole_prop' ? [] : [{\n          id: newEntityId, name: entityName, type: mod.entityType || 'llc',\n          state: state.profile.state,\n          annualCost: mod.entityCost ?? (mod.entityType === 'llc_scorp' ? 2000 : mod.entityType === 'llc' ? 300 : mod.entityType === 'ccorp' ? 5000 : 0),\n          isActive: true,\n        }]\n        // Reassign business/freelance income to new entity\n        if (mod.entityType !== 'sole_prop') {\n          state.incomeStreams = state.incomeStreams.map(s =>\n            ['business', 'freelance'].includes(s.type) && s.isActive\n              ? { ...s, entityId: newEntityId } : s\n          )\n          // Reassign business expenses to new entity\n          state.expenses = state.expenses.map(e =>\n            e.isDeductible ? { ...e, entityId: newEntityId } : e\n          )\n          // Set S-Corp officer salary if applicable\n          if ((mod.entityType === 'llc_scorp' || mod.entityType === 'scorp') && state.incomeStreams.length > 0) {\n            const bizIncome = state.incomeStreams.filter(s => ['business', 'freelance'].includes(s.type) && s.isActive)\n              .reduce((sum, s) => sum + s.annualAmount, 0)\n            state.incomeStreams = state.incomeStreams.map(s =>\n              s.entityId === newEntityId ? { ...s, scorp: { officerSalary: Math.round(bizIncome * 0.6), distributions: Math.round(bizIncome * 0.4) } } : s\n            )\n          }\n        } else {\n          // Revert to personal\n          state.incomeStreams = state.incomeStreams.map(s => ({ ...s, entityId: 'personal' }))\n          state.expenses = state.expenses.map(e => ({ ...e, entityId: 'personal' }))\n        }\n        break\n      }\n      case 'add_deduction':\n        state.deductions.push({\n          id: genId(), name: mod.deductionName || 'New Deduction',\n          category: mod.deductionCategory || 'business', amount: mod.deductionAmount || 0, isItemized: false,\n        })\n        break\n      case 'remove_deduction':\n        state.deductions = state.deductions.filter(d => d.id !== mod.deductionId)\n        break\n      case 'modify_deduction':\n        state.deductions = state.deductions.map(d =>\n          d.id === mod.deductionId ? { ...d, amount: mod.deductionAmount ?? d.amount } : d\n        )\n        break\n      case 'add_expense':\n        state.expenses.push({\n          id: genId(), category: 'business', description: mod.expenseDesc || 'New Expense',\n          annualAmount: mod.expenseAmount || 0, isDeductible: true, deductionPct: mod.expensePct ?? 100,\n        })\n        break\n      case 'change_filing':\n        if (mod.filingStatus) state.profile.filingStatus = mod.filingStatus as any\n        break\n      case 'change_state':\n        if (mod.stateCode) state.profile.state = mod.stateCode\n        break\n    }\n  }\n  return state\n}\n\n// ─── Evaluate & Compare ──────────────────────────────────────────\n\nexport function evaluateScenario(name: string, baseState: FortunaState, mods: ScenarioModification[]): ScenarioResult {\n  const modifiedState = applyModifications(baseState, mods)\n  const taxReport = generateTaxReport(modifiedState)\n  const healthScore = calculateHealthScore(modifiedState)\n  return { name, modifications: mods, taxReport, healthScore, state: modifiedState }\n}\n\nexport function compareScenarios(\n  baseState: FortunaState,\n  scenarios: { name: string; mods: ScenarioModification[] }[]\n): ScenarioComparison {\n  const baseline = evaluateScenario('Current Situation', baseState, [])\n  const evaluated = scenarios.map(s => evaluateScenario(s.name, baseState, s.mods))\n  return { baseline, scenarios: evaluated }\n}\n\n// ─── Smart Scenarios ─────────────────────────────────────────────\n\nexport function generateSmartScenarios(baseState: FortunaState): { name: string; mods: ScenarioModification[]; description: string; icon: string }[] {\n  const scenarios: { name: string; mods: ScenarioModification[]; description: string; icon: string }[] = []\n  const report = generateTaxReport(baseState)\n  const hasScorp = baseState.entities.some(e => (e.type === 'llc_scorp' || e.type === 'scorp') && e.isActive)\n  const netSE = baseState.incomeStreams\n    .filter(s => ['business', 'freelance'].includes(s.type) && s.isActive)\n    .reduce((sum, s) => sum + s.annualAmount, 0)\n\n  if (!hasScorp && netSE > 40000) {\n    scenarios.push({ name: 'S-Corp Election', description: 'Elect S-Corp status to reduce SE tax.', mods: [{ type: 'change_entity', entityType: 'llc_scorp', entityCost: 2000 }], icon: '🏛️' })\n  }\n\n  const maxSEP = calculateMaxSEPIRA(netSE)\n  const currentRetirement = baseState.deductions.filter(d => d.category === 'retirement').reduce((s, d) => s + d.amount, 0)\n  if (maxSEP - currentRetirement > 5000) {\n    scenarios.push({ name: 'Max Retirement', description: `Max SEP-IRA to $${maxSEP.toLocaleString()}.`, mods: [{ type: 'add_deduction', deductionName: 'SEP-IRA Max', deductionCategory: 'retirement', deductionAmount: maxSEP - currentRetirement }], icon: '🏦' })\n  }\n\n  if (!hasScorp && netSE > 50000 && maxSEP - currentRetirement > 5000) {\n    scenarios.push({ name: 'S-Corp + Retirement', description: 'Entity restructure + maxed contributions.', mods: [{ type: 'change_entity', entityType: 'llc_scorp', entityCost: 2000 }, { type: 'add_deduction', deductionName: 'SEP-IRA Max', deductionCategory: 'retirement', deductionAmount: maxSEP - currentRetirement }], icon: '⚡' })\n  }\n\n  if (netSE > 0) {\n    const add = Math.round(netSE * 0.4)\n    scenarios.push({ name: `+$${(add / 1000).toFixed(0)}k Revenue`, description: `Add $${add.toLocaleString()} consulting revenue.`, mods: [{ type: 'add_income', incomeName: 'AI Consulting', incomeType: 'business', incomeAmount: add }], icon: '📈' })\n  }\n\n  if (!hasScorp && netSE > 50000) {\n    const add = Math.round(netSE * 0.4)\n    scenarios.push({ name: 'Full Optimization', description: `S-Corp + Retirement + $${(add / 1000).toFixed(0)}k revenue.`, mods: [{ type: 'change_entity', entityType: 'llc_scorp', entityCost: 2000 }, { type: 'add_deduction', deductionName: 'SEP-IRA Max', deductionCategory: 'retirement', deductionAmount: maxSEP - currentRetirement }, { type: 'add_income', incomeName: 'AI Consulting', incomeType: 'business', incomeAmount: add }], icon: '🚀' })\n  }\n\n  const stateTaxRate = report.stateTax / Math.max(1, report.taxableIncome)\n  if (stateTaxRate > 0.04 && report.stateTax > 3000) {\n    scenarios.push({ name: 'No-Tax State', description: `Relocate to save $${report.stateTax.toLocaleString()}/yr.`, mods: [{ type: 'change_state', stateCode: 'TX' }], icon: '🗺️' })\n  }\n\n  // ── Portfolio Intelligence scenarios ────────────────────────────\n  if (hasPortfolioData()) {\n    const portfolioScens = getPortfolioScenarios()\n    for (const ps of portfolioScens) {\n      const mods: ScenarioModification[] = []\n      if (ps.additionalIncome > 0) {\n        mods.push({ type: 'add_income', incomeName: ps.name, incomeType: 'investment', incomeAmount: ps.additionalIncome })\n      }\n      if (ps.additionalDeduction > 0) {\n        mods.push({ type: 'add_deduction', deductionName: `${ps.name} (loss offset)`, deductionCategory: 'other', deductionAmount: ps.additionalDeduction })\n      }\n      if (ps.capitalGains.shortTerm > 0 && ps.additionalIncome === 0) {\n        mods.push({ type: 'add_income', incomeName: `${ps.name} (ST gains)`, incomeType: 'investment', incomeAmount: ps.capitalGains.shortTerm })\n      }\n      if (ps.capitalGains.longTerm > 0 && ps.additionalIncome === 0) {\n        mods.push({ type: 'add_income', incomeName: `${ps.name} (LT gains)`, incomeType: 'investment', incomeAmount: ps.capitalGains.longTerm })\n      }\n      if (mods.length > 0) {\n        scenarios.push({ name: ps.name, description: ps.description, mods, icon: ps.icon })\n      }\n    }\n  }\n\n  return scenarios\n}\n\n// ==================== Batch Scenario Comparison Matrix ====================\n// Evaluate multiple scenarios simultaneously for side-by-side comparison.\n\nexport interface ScenarioComparisonRow {\n  scenarioName: string\n  scenarioIcon: string\n  // Tax impact\n  totalTax: number\n  effectiveRate: number\n  taxDelta: number // vs baseline\n  taxDeltaPct: number\n  // Income\n  grossIncome: number\n  afterTaxIncome: number\n  // SE / Payroll\n  selfEmploymentTax: number\n  // Components\n  federalTax: number\n  stateTax: number\n  amt: number\n  niit: number\n  // Health & risk\n  healthScoreEstimate: number // simple estimate\n  auditRiskEstimate: 'low' | 'medium' | 'high'\n  // Meta\n  modifications: string[]\n  recommendation: string\n}\n\nexport interface ScenarioMatrix {\n  baseline: ScenarioComparisonRow\n  scenarios: ScenarioComparisonRow[]\n  bestScenario: string\n  worstScenario: string\n  maxSavings: number\n  insights: string[]\n}\n\n/** Evaluate multiple scenarios in batch, returning a comparison matrix */\nexport function compareScenariosBatch(\n  state: FortunaState,\n  scenarios: ScenarioTemplate[],\n  maxScenarios: number = 8,\n): ScenarioMatrix {\n  const baseReport = generateTaxReport(state)\n\n  // Build baseline row\n  const baseline: ScenarioComparisonRow = {\n    scenarioName: 'Current (Baseline)',\n    scenarioIcon: '📊',\n    totalTax: baseReport.totalTax,\n    effectiveRate: baseReport.effectiveRate,\n    taxDelta: 0,\n    taxDeltaPct: 0,\n    grossIncome: baseReport.grossIncome,\n    afterTaxIncome: baseReport.afterTaxIncome,\n    selfEmploymentTax: baseReport.selfEmploymentTax,\n    federalTax: baseReport.federalIncomeTax,\n    stateTax: baseReport.stateTax,\n    amt: baseReport.amt,\n    niit: baseReport.niit,\n    healthScoreEstimate: 50,\n    auditRiskEstimate: 'low',\n    modifications: [],\n    recommendation: 'Current position',\n  }\n\n  const rows: ScenarioComparisonRow[] = []\n\n  for (const template of scenarios.slice(0, maxScenarios)) {\n    const result = evaluateScenario(template.name, state, template.mods)\n    const rpt = result.taxReport\n\n    const delta = rpt.totalTax - baseReport.totalTax\n    const deltaPct = baseReport.totalTax > 0 ? delta / baseReport.totalTax : 0\n\n    // Estimate health score impact\n    let healthEstimate = 50\n    if (delta < -5000) healthEstimate += 15 // significant savings\n    if (rpt.effectiveRate < baseReport.effectiveRate) healthEstimate += 10\n    if (rpt.afterTaxIncome > baseReport.afterTaxIncome) healthEstimate += 10\n    healthEstimate = Math.min(100, Math.max(0, healthEstimate))\n\n    // Estimate audit risk\n    const auditRisk: 'low' | 'medium' | 'high' =\n      template.mods.some(m => m.type === 'change_entity') && Math.abs(delta) > 20000\n        ? 'medium'\n        : Math.abs(delta) > 50000 ? 'high' : 'low'\n\n    const savings = -delta\n    rows.push({\n      scenarioName: template.name,\n      scenarioIcon: template.icon,\n      totalTax: rpt.totalTax,\n      effectiveRate: rpt.effectiveRate,\n      taxDelta: delta,\n      taxDeltaPct: deltaPct,\n      grossIncome: rpt.grossIncome,\n      afterTaxIncome: rpt.afterTaxIncome,\n      selfEmploymentTax: rpt.selfEmploymentTax,\n      federalTax: rpt.federalIncomeTax,\n      stateTax: rpt.stateTax,\n      amt: rpt.amt,\n      niit: rpt.niit,\n      healthScoreEstimate: healthEstimate,\n      auditRiskEstimate: auditRisk,\n      modifications: template.mods.map(m => `${m.type}${m.type.includes('income') ? `: $${(m as any).incomeAmount?.toLocaleString() || ''}` : ''}`),\n      recommendation: savings > 10000\n        ? `Save $${savings.toLocaleString()}/year — high priority`\n        : savings > 3000\n          ? `Save $${savings.toLocaleString()}/year — moderate priority`\n          : savings > 0\n            ? `Marginal savings of $${savings.toLocaleString()}`\n            : `Increases tax by $${Math.abs(savings).toLocaleString()}`,\n    })\n  }\n\n  // Sort by tax delta (most savings first)\n  rows.sort((a, b) => a.taxDelta - b.taxDelta)\n\n  const bestScenario = rows.length > 0 && rows[0].taxDelta < 0 ? rows[0].scenarioName : 'Current (Baseline)'\n  const worstScenario = rows.length > 0 ? rows[rows.length - 1].scenarioName : 'Current (Baseline)'\n  const maxSavings = rows.length > 0 ? Math.max(0, -rows[0].taxDelta) : 0\n\n  // Generate insights\n  const insights: string[] = []\n  if (maxSavings > 10000) insights.push(`Best scenario saves $${maxSavings.toLocaleString()}/year (${rows[0].scenarioName})`)\n  const entityScenarios = rows.filter(r => r.modifications.some(m => m.includes('change_entity')))\n  if (entityScenarios.length > 0 && entityScenarios[0].taxDelta < -5000) {\n    insights.push(`Entity restructuring yields the biggest wins — ${entityScenarios[0].scenarioName} saves $${Math.abs(entityScenarios[0].taxDelta).toLocaleString()}`)\n  }\n  const combinedScenarios = rows.filter(r => r.modifications.length > 1)\n  if (combinedScenarios.length > 0 && combinedScenarios[0].taxDelta < -8000) {\n    insights.push(`Combined strategies outperform single changes — ${combinedScenarios[0].scenarioName}`)\n  }\n  if (rows.some(r => r.auditRiskEstimate === 'high')) {\n    insights.push('⚠️ Some aggressive scenarios may increase IRS scrutiny — review with CPA')\n  }\n\n  return {\n    baseline,\n    scenarios: rows,\n    bestScenario,\n    worstScenario,\n    maxSavings,\n    insights,\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\sec-edgar.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\session-digest.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'FinancialSnapshot' is defined but never used.","line":9,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":46,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"FinancialSnapshot"},"fix":{"range":[293,312],"text":""},"desc":"Remove unused variable \"FinancialSnapshot\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'incomeTrend' is assigned a value but never used.","line":196,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":196,"endColumn":20}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — Session Digest\n *\n * Generates a personalized summary of what changed since the user's last session.\n * Compares current state against the most recent snapshot to produce actionable insights.\n */\n\nimport type { FortunaState } from './storage'\nimport type { HistoryStore, FinancialSnapshot, TrendLine } from './history-engine'\nimport type { DetectedStrategy } from './strategy-detector'\nimport type { TaxReport } from './tax-calculator'\nimport { hasPortfolioData, computePortfolioSummary, getPortfolioAlerts } from './portfolio-bridge'\n\nexport interface DigestItem {\n  id: string\n  type: 'positive' | 'negative' | 'neutral' | 'action' | 'milestone'\n  icon: string\n  title: string\n  detail: string\n  metric?: { label: string; value: string; change?: string }\n  actionLabel?: string\n  actionView?: string\n}\n\nexport interface SessionDigest {\n  greeting: string\n  timeSinceLastSession: string\n  items: DigestItem[]\n  quickStats: { label: string; value: string; color: string }[]\n}\n\nfunction timeSince(dateStr: string): string {\n  const diff = Date.now() - new Date(dateStr).getTime()\n  const mins = Math.floor(diff / 60000)\n  if (mins < 60) return `${mins}m`\n  const hrs = Math.floor(mins / 60)\n  if (hrs < 24) return `${hrs}h`\n  const days = Math.floor(hrs / 24)\n  if (days === 1) return '1 day'\n  if (days < 7) return `${days} days`\n  const weeks = Math.floor(days / 7)\n  if (weeks === 1) return '1 week'\n  if (weeks < 5) return `${weeks} weeks`\n  const months = Math.floor(days / 30)\n  return `${months} month${months > 1 ? 's' : ''}`\n}\n\nexport function generateSessionDigest(\n  state: FortunaState,\n  history: HistoryStore,\n  trends: TrendLine[],\n  strategies: DetectedStrategy[],\n  taxReport: TaxReport,\n  lastSessionTimestamp: string | null,\n): SessionDigest {\n  const items: DigestItem[] = []\n  const snaps = history.snapshots\n  const lastSnap = snaps.length > 0 ? snaps[snaps.length - 1] : null\n  const prevSnap = snaps.length > 1 ? snaps[snaps.length - 2] : null\n\n  const timeSinceSession = lastSessionTimestamp\n    ? timeSince(lastSessionTimestamp)\n    : 'your first session'\n\n  const hour = new Date().getHours()\n  const firstName = state.profile.name?.split(' ')[0] || 'there'\n  const timeGreeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening'\n\n  // ── Health Score Change ──\n  if (lastSnap && prevSnap) {\n    const healthDiff = lastSnap.metrics.healthScore - prevSnap.metrics.healthScore\n    if (Math.abs(healthDiff) >= 3) {\n      items.push({\n        id: 'health-change',\n        type: healthDiff > 0 ? 'positive' : 'negative',\n        icon: healthDiff > 0 ? '📈' : '📉',\n        title: healthDiff > 0 ? 'Health Score Improved' : 'Health Score Declined',\n        detail: `${healthDiff > 0 ? '+' : ''}${healthDiff.toFixed(0)} points since last snapshot`,\n        metric: {\n          label: 'Health Score',\n          value: lastSnap.metrics.healthScore.toFixed(0),\n          change: `${healthDiff > 0 ? '+' : ''}${healthDiff.toFixed(0)}`,\n        },\n        actionLabel: 'View Health',\n        actionView: 'health',\n      })\n    }\n  }\n\n  // ── Tax Rate Movement ──\n  if (lastSnap && prevSnap) {\n    const rateDiff = (lastSnap.metrics.effectiveTaxRate - prevSnap.metrics.effectiveTaxRate) * 100\n    if (Math.abs(rateDiff) >= 0.5) {\n      items.push({\n        id: 'tax-rate-change',\n        type: rateDiff < 0 ? 'positive' : 'negative',\n        icon: rateDiff < 0 ? '💰' : '⚠️',\n        title: rateDiff < 0 ? 'Effective Tax Rate Dropped' : 'Tax Rate Increased',\n        detail: `${rateDiff < 0 ? '' : '+'}${rateDiff.toFixed(1)}pp — now ${(lastSnap.metrics.effectiveTaxRate * 100).toFixed(1)}%`,\n        actionLabel: 'Tax Strategy',\n        actionView: 'tax',\n      })\n    }\n  }\n\n  // ── New Strategies Detected ──\n  const highPriority = strategies.filter(s => s.priority === 'critical' || s.priority === 'high')\n  if (highPriority.length > 0) {\n    const totalSavings = highPriority.reduce((sum, s) => sum + (s.estimatedImpact || 0), 0)\n    items.push({\n      id: 'strategies-pending',\n      type: 'action',\n      icon: '🎯',\n      title: `${highPriority.length} High-Priority ${highPriority.length === 1 ? 'Strategy' : 'Strategies'} Pending`,\n      detail: totalSavings > 0\n        ? `${highPriority[0].title}${highPriority.length > 1 ? ` and ${highPriority.length - 1} more` : ''} — ~$${totalSavings.toLocaleString()}/yr potential`\n        : `${highPriority[0].title}${highPriority.length > 1 ? ` and ${highPriority.length - 1} more` : ''}`,\n      actionLabel: 'Review Strategies',\n      actionView: 'tax',\n    })\n  }\n\n  // ── Income Change ──\n  if (lastSnap && prevSnap) {\n    const incomeDiff = lastSnap.metrics.totalIncome - prevSnap.metrics.totalIncome\n    const pct = prevSnap.metrics.totalIncome > 0\n      ? (incomeDiff / prevSnap.metrics.totalIncome) * 100\n      : 0\n    if (Math.abs(pct) >= 5) {\n      items.push({\n        id: 'income-change',\n        type: incomeDiff > 0 ? 'positive' : 'negative',\n        icon: incomeDiff > 0 ? '🚀' : '📊',\n        title: `Income ${incomeDiff > 0 ? 'Up' : 'Down'} ${Math.abs(pct).toFixed(0)}%`,\n        detail: `$${Math.abs(incomeDiff).toLocaleString()} ${incomeDiff > 0 ? 'increase' : 'decrease'} since last snapshot`,\n        metric: {\n          label: 'Total Income',\n          value: `$${lastSnap.metrics.totalIncome.toLocaleString()}`,\n          change: `${incomeDiff > 0 ? '+' : '-'}$${Math.abs(incomeDiff).toLocaleString()}`,\n        },\n        actionLabel: 'Revenue',\n        actionView: 'revenue',\n      })\n    }\n  }\n\n  // ── Upcoming Quarterly Tax ──\n  const quarterlyEstimated = Math.round(taxReport.totalTax / 4)\n  if (quarterlyEstimated > 0) {\n    const now = new Date()\n    const month = now.getMonth()\n    const day = now.getDate()\n    const year = now.getFullYear()\n    const deadlines = [\n      { q: 'Q1', month: 3, day: 15 },\n      { q: 'Q2', month: 5, day: 15 },\n      { q: 'Q3', month: 8, day: 15 },\n      { q: 'Q4', month: 0, day: 15 },\n    ]\n    const nextDeadline = deadlines.find(d => {\n      const dMonth = d.month\n      if (dMonth > month || (dMonth === month && d.day > day)) return true\n      return false\n    }) || deadlines[0]\n\n    const deadlineDate = new Date(nextDeadline.month === 0 ? year + 1 : year, nextDeadline.month, nextDeadline.day)\n    const daysUntil = Math.ceil((deadlineDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24))\n\n    if (daysUntil <= 30 && daysUntil > 0) {\n      items.push({\n        id: 'quarterly-deadline',\n        type: daysUntil <= 7 ? 'negative' : 'action',\n        icon: daysUntil <= 7 ? '🔴' : '📅',\n        title: `${nextDeadline.q} Estimated Payment Due in ${daysUntil} Day${daysUntil !== 1 ? 's' : ''}`,\n        detail: `$${quarterlyEstimated.toLocaleString()} due ${deadlineDate.toLocaleDateString()}`,\n        actionLabel: 'Tax Documents',\n        actionView: 'taxdocs',\n      })\n    }\n  }\n\n  // ── Snapshot Milestone ──\n  if (snaps.length > 0 && [5, 10, 25, 50].includes(snaps.length)) {\n    items.push({\n      id: 'snapshot-milestone',\n      type: 'milestone',\n      icon: '🏆',\n      title: `${snaps.length} Snapshots Recorded`,\n      detail: 'Your financial history is building. Projections become more accurate with each data point.',\n      actionLabel: 'View History',\n      actionView: 'history',\n    })\n  }\n\n  // ── Trend Highlights ──\n  const incomeTrend = trends.find(t => t.metric === 'totalIncome')\n  const savingsTrend = trends.find(t => t.metric === 'estimatedSavingsTotal')\n\n  if (savingsTrend && savingsTrend.direction === 'up' && savingsTrend.changePct > 10) {\n    items.push({\n      id: 'savings-trend',\n      type: 'positive',\n      icon: '✅',\n      title: 'Implemented Savings Growing',\n      detail: `Up ${savingsTrend.changePct.toFixed(0)}% — you're executing well on recommended strategies`,\n      actionLabel: 'Strategy Impact',\n      actionView: 'history',\n    })\n  }\n\n  // ── Entity Performance Summary ──\n  const activeEntities = state.entities.filter(e => e.isActive)\n  if (activeEntities.length > 0) {\n    const entityPnL = taxReport.entityBreakdown || []\n    const unprofitable = entityPnL.filter(e => e.netIncome < 0)\n    if (unprofitable.length > 0) {\n      const totalLoss = unprofitable.reduce((s, e) => s + Math.abs(e.netIncome), 0)\n      items.push({\n        id: 'entity-losses',\n        type: 'negative',\n        icon: '\\u26A0\\uFE0F',\n        title: `${unprofitable.length} ${unprofitable.length === 1 ? 'Entity' : 'Entities'} Operating at a Loss`,\n        detail: `$${totalLoss.toLocaleString()} combined loss across ${unprofitable.map(e => e.entityName).join(', ')}`,\n        actionLabel: 'Entity P&L',\n        actionView: 'pnl',\n      })\n    }\n    const scorpEntities = activeEntities.filter(e => (e.type === 'llc_scorp' || e.type === 'scorp'))\n    const missingSalary = scorpEntities.filter(e => !e.officerSalary || e.officerSalary === 0)\n    if (missingSalary.length > 0) {\n      items.push({\n        id: 'scorp-salary-missing',\n        type: 'action',\n        icon: '\\uD83D\\uDCCB',\n        title: `${missingSalary.length} S-Corp${missingSalary.length > 1 ? 's' : ''} Missing Officer Salary`,\n        detail: `${missingSalary.map(e => e.name).join(', ')} \\u2014 IRS requires reasonable compensation`,\n        actionLabel: 'Entity Setup',\n        actionView: 'entities',\n      })\n    }\n  }\n\n  // Quick stats\n  const quickStats = [\n    { label: 'Gross Income', value: `$${(taxReport.grossIncome / 1000).toFixed(0)}K`, color: 'var(--accent-gold)' },\n    { label: 'Tax Rate', value: `${(taxReport.effectiveRate * 100).toFixed(1)}%`, color: 'var(--accent-red)' },\n    { label: 'Strategies', value: `${strategies.length}`, color: 'var(--accent-blue)' },\n    { label: 'Snapshots', value: `${snaps.length}`, color: 'var(--accent-purple)' },\n  ]\n\n  // Portfolio digest items\n  if (hasPortfolioData()) {\n    const ps = computePortfolioSummary()\n    const pAlerts = getPortfolioAlerts()\n    const urgentAlerts = pAlerts.filter(a => a.severity === 'urgent')\n\n    if (urgentAlerts.length > 0) {\n      items.push({\n        id: 'portfolio-urgent',\n        type: 'negative',\n        icon: '🚨',\n        title: `${urgentAlerts.length} Urgent Portfolio Alert${urgentAlerts.length !== 1 ? 's' : ''}`,\n        detail: urgentAlerts[0].title,\n        actionLabel: 'View Portfolio',\n        actionView: 'portfolio',\n      })\n    }\n\n    if (ps.harvestCandidates.length > 0) {\n      const harvestable = ps.harvestCandidates.reduce((s, c) => s + c.loss, 0)\n      items.push({\n        id: 'portfolio-harvest',\n        type: 'info',\n        icon: '🌾',\n        title: 'Tax-Loss Harvesting Available',\n        detail: `$${Math.round(harvestable).toLocaleString()} in harvestable losses across ${ps.harvestCandidates.length} positions`,\n        actionLabel: 'View Portfolio',\n        actionView: 'portfolio',\n      })\n    }\n\n    if (ps.positionsNearLTCGThreshold.length > 0) {\n      items.push({\n        id: 'portfolio-ltcg',\n        type: 'info',\n        icon: '⏳',\n        title: `${ps.positionsNearLTCGThreshold.length} Position${ps.positionsNearLTCGThreshold.length !== 1 ? 's' : ''} Near LTCG Threshold`,\n        detail: `Hold a bit longer to qualify for lower long-term capital gains rate`,\n        actionLabel: 'View Portfolio',\n        actionView: 'portfolio',\n      })\n    }\n\n    // Replace Snapshots quickStat with Portfolio if data exists\n    if (ps.totalValue > 0) {\n      quickStats[3] = { label: 'Portfolio', value: `$${(ps.totalValue / 1000).toFixed(0)}K`, color: 'var(--accent-purple)' }\n    }\n  }\n\n  // ── Metamodel: Estimated Payment Status ──\n  const estPayments = state.estimatedPayments || []\n  const missedPayments = estPayments.filter(p => {\n    const due = new Date(p.dueDate)\n    return due < new Date() && (!p.paidAmount || p.paidAmount === 0)\n  })\n  if (missedPayments.length > 0) {\n    const totalMissed = missedPayments.reduce((s, p) => s + p.amount, 0)\n    items.push({\n      id: 'est-payments-missed',\n      type: 'negative',\n      icon: '\\u26A0\\uFE0F',\n      title: `${missedPayments.length} Estimated Payment(s) Past Due`,\n      detail: `$${totalMissed.toLocaleString()} unpaid \\u2014 penalties may apply`,\n      actionLabel: 'View Calendar',\n      actionView: 'calendar',\n    })\n  }\n\n  // ── Metamodel: Goal Progress ──\n  const activeGoals = (state.goals || []).filter(g => g.status === 'active')\n  if (activeGoals.length > 0) {\n    const withProgress = activeGoals.filter(g => g.currentAmount && g.targetAmount && g.currentAmount >= g.targetAmount)\n    if (withProgress.length > 0) {\n      items.push({\n        id: 'goals-completed',\n        type: 'positive',\n        icon: '\\uD83C\\uDFC6',\n        title: `${withProgress.length} Goal${withProgress.length > 1 ? 's' : ''} Reached!`,\n        detail: withProgress.map(g => g.title).join(', '),\n        actionLabel: 'View Goals',\n        actionView: 'goals',\n      })\n    }\n  }\n\n  // ── Metamodel: Retirement Account Summary ──\n  const retAccounts = state.retirementAccounts || []\n  if (retAccounts.length > 0) {\n    const totalBalance = retAccounts.reduce((s, a) => s + (a.balance || 0), 0)\n    const totalContrib = retAccounts.reduce((s, a) => s + (a.annualContribution || 0), 0)\n    const maxContrib = retAccounts.reduce((s, a) => s + (a.maxContribution || 0), 0)\n    if (totalBalance > 0) {\n      quickStats.push({ label: 'Retirement', value: `$${(totalBalance / 1000).toFixed(0)}K`, color: 'var(--accent-blue)' })\n    }\n    if (maxContrib > 0 && totalContrib < maxContrib * 0.5) {\n      items.push({\n        id: 'retirement-undercontributing',\n        type: 'action',\n        icon: '\\uD83D\\uDCB0',\n        title: 'Retirement Contributions Below 50% of Maximum',\n        detail: `$${totalContrib.toLocaleString()}/yr of $${maxContrib.toLocaleString()} max \\u2014 $${(maxContrib - totalContrib).toLocaleString()} gap`,\n        actionLabel: 'Optimize Retirement',\n        actionView: 'retirement',\n      })\n    }\n  }\n\n  // ── Metamodel: Depreciation Asset Count ──\n  const depAssets = (state.depreciationAssets || []).filter(a => a.isActive)\n  if (depAssets.length > 0) {\n    const totalBasis = depAssets.reduce((s, a) => s + a.purchasePrice, 0)\n    quickStats.push({ label: 'Assets', value: `$${(totalBasis / 1000).toFixed(0)}K`, color: 'var(--text-secondary)' })\n  }\n\n  return {\n    greeting: `${timeGreeting}, ${firstName}`,\n    timeSinceLastSession: timeSinceSession,\n    items: items.slice(0, 6), // Max 6 items\n    quickStats,\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\state-arbitrage.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'stateData' is assigned a value but never used.","line":236,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":236,"endColumn":24}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — State Tax Arbitrage v8\n *\n * Compare state tax burdens for remote workers & location-flexible earners.\n * Models total state/local tax impact across income tax, sales tax, property tax.\n * Identifies optimal states based on individual financial profile.\n */\n\nimport type { FortunaState } from './storage'\nimport { generateTaxReport } from './tax-calculator'\n\n// ===================================================================\n//  STATE TAX DATA (2025 rates, simplified top marginal)\n// ===================================================================\n\ninterface StateTaxProfile {\n  code: string\n  name: string\n  incomeTaxRate: number // top marginal rate\n  incomeTaxType: 'none' | 'flat' | 'graduated'\n  salesTaxRate: number // state rate (not including local)\n  avgLocalSalesTax: number\n  avgPropertyTaxRate: number // effective rate as % of home value\n  hasNoIncomeTax: boolean\n  costOfLivingIndex: number // 100 = national average\n  notes: string[]\n}\n\nconst STATE_DATA: StateTaxProfile[] = [\n  { code: 'AK', name: 'Alaska', incomeTaxRate: 0, incomeTaxType: 'none', salesTaxRate: 0, avgLocalSalesTax: 1.76, avgPropertyTaxRate: 1.04, hasNoIncomeTax: true, costOfLivingIndex: 127, notes: ['No state income tax', 'No state sales tax', 'Permanent Fund Dividend (~$1,700/yr)'] },\n  { code: 'AL', name: 'Alabama', incomeTaxRate: 0.05, incomeTaxType: 'graduated', salesTaxRate: 4.0, avgLocalSalesTax: 5.24, avgPropertyTaxRate: 0.39, hasNoIncomeTax: false, costOfLivingIndex: 89, notes: ['Low property tax', 'Federal income tax deductible on state return'] },\n  { code: 'AR', name: 'Arkansas', incomeTaxRate: 0.044, incomeTaxType: 'graduated', salesTaxRate: 6.5, avgLocalSalesTax: 2.97, avgPropertyTaxRate: 0.62, hasNoIncomeTax: false, costOfLivingIndex: 87, notes: ['Low cost of living'] },\n  { code: 'AZ', name: 'Arizona', incomeTaxRate: 0.025, incomeTaxType: 'flat', salesTaxRate: 5.6, avgLocalSalesTax: 2.77, avgPropertyTaxRate: 0.62, hasNoIncomeTax: false, costOfLivingIndex: 103, notes: ['Flat 2.5% income tax'] },\n  { code: 'CA', name: 'California', incomeTaxRate: 0.133, incomeTaxType: 'graduated', salesTaxRate: 7.25, avgLocalSalesTax: 1.57, avgPropertyTaxRate: 0.71, hasNoIncomeTax: false, costOfLivingIndex: 142, notes: ['Highest state income tax', 'High cost of living', 'Additional 1% mental health surcharge above $1M'] },\n  { code: 'CO', name: 'Colorado', incomeTaxRate: 0.044, incomeTaxType: 'flat', salesTaxRate: 2.9, avgLocalSalesTax: 4.87, avgPropertyTaxRate: 0.49, hasNoIncomeTax: false, costOfLivingIndex: 105, notes: ['Flat 4.4% income tax'] },\n  { code: 'CT', name: 'Connecticut', incomeTaxRate: 0.0699, incomeTaxType: 'graduated', salesTaxRate: 6.35, avgLocalSalesTax: 0, avgPropertyTaxRate: 1.96, hasNoIncomeTax: false, costOfLivingIndex: 121, notes: ['High property taxes'] },\n  { code: 'DE', name: 'Delaware', incomeTaxRate: 0.066, incomeTaxType: 'graduated', salesTaxRate: 0, avgLocalSalesTax: 0, avgPropertyTaxRate: 0.53, hasNoIncomeTax: false, costOfLivingIndex: 102, notes: ['No sales tax'] },\n  { code: 'FL', name: 'Florida', incomeTaxRate: 0, incomeTaxType: 'none', salesTaxRate: 6.0, avgLocalSalesTax: 1.01, avgPropertyTaxRate: 0.86, hasNoIncomeTax: true, costOfLivingIndex: 103, notes: ['No state income tax', 'Popular for tax-motivated relocation', 'Homestead exemption up to $50K'] },\n  { code: 'GA', name: 'Georgia', incomeTaxRate: 0.0549, incomeTaxType: 'flat', salesTaxRate: 4.0, avgLocalSalesTax: 3.38, avgPropertyTaxRate: 0.87, hasNoIncomeTax: false, costOfLivingIndex: 93, notes: ['Transitioning to flat tax'] },\n  { code: 'HI', name: 'Hawaii', incomeTaxRate: 0.11, incomeTaxType: 'graduated', salesTaxRate: 4.0, avgLocalSalesTax: 0.44, avgPropertyTaxRate: 0.27, hasNoIncomeTax: false, costOfLivingIndex: 193, notes: ['Very high cost of living', 'Low property tax rate'] },\n  { code: 'ID', name: 'Idaho', incomeTaxRate: 0.058, incomeTaxType: 'flat', salesTaxRate: 6.0, avgLocalSalesTax: 0.02, avgPropertyTaxRate: 0.63, hasNoIncomeTax: false, costOfLivingIndex: 97, notes: ['Flat 5.8% income tax'] },\n  { code: 'IL', name: 'Illinois', incomeTaxRate: 0.0495, incomeTaxType: 'flat', salesTaxRate: 6.25, avgLocalSalesTax: 2.56, avgPropertyTaxRate: 2.07, hasNoIncomeTax: false, costOfLivingIndex: 95, notes: ['Flat 4.95% income tax', 'Very high property taxes', 'Retirement income exempt from state tax'] },\n  { code: 'IN', name: 'Indiana', incomeTaxRate: 0.0305, incomeTaxType: 'flat', salesTaxRate: 7.0, avgLocalSalesTax: 0, avgPropertyTaxRate: 0.81, hasNoIncomeTax: false, costOfLivingIndex: 91, notes: ['Low flat income tax at 3.05%'] },\n  { code: 'KY', name: 'Kentucky', incomeTaxRate: 0.04, incomeTaxType: 'flat', salesTaxRate: 6.0, avgLocalSalesTax: 0, avgPropertyTaxRate: 0.80, hasNoIncomeTax: false, costOfLivingIndex: 90, notes: ['Flat 4% income tax'] },\n  { code: 'MA', name: 'Massachusetts', incomeTaxRate: 0.09, incomeTaxType: 'flat', salesTaxRate: 6.25, avgLocalSalesTax: 0, avgPropertyTaxRate: 1.15, hasNoIncomeTax: false, costOfLivingIndex: 135, notes: ['Flat 5% + 4% millionaire surcharge above $1M'] },\n  { code: 'MI', name: 'Michigan', incomeTaxRate: 0.0425, incomeTaxType: 'flat', salesTaxRate: 6.0, avgLocalSalesTax: 0, avgPropertyTaxRate: 1.38, hasNoIncomeTax: false, costOfLivingIndex: 91, notes: ['Flat 4.25% income tax'] },\n  { code: 'MN', name: 'Minnesota', incomeTaxRate: 0.0985, incomeTaxType: 'graduated', salesTaxRate: 6.875, avgLocalSalesTax: 0.61, avgPropertyTaxRate: 1.05, hasNoIncomeTax: false, costOfLivingIndex: 97, notes: ['High top income tax rate'] },\n  { code: 'MO', name: 'Missouri', incomeTaxRate: 0.048, incomeTaxType: 'graduated', salesTaxRate: 4.225, avgLocalSalesTax: 3.97, avgPropertyTaxRate: 0.91, hasNoIncomeTax: false, costOfLivingIndex: 89, notes: ['Low cost of living'] },\n  { code: 'MT', name: 'Montana', incomeTaxRate: 0.059, incomeTaxType: 'graduated', salesTaxRate: 0, avgLocalSalesTax: 0, avgPropertyTaxRate: 0.74, hasNoIncomeTax: false, costOfLivingIndex: 98, notes: ['No sales tax'] },\n  { code: 'NC', name: 'North Carolina', incomeTaxRate: 0.045, incomeTaxType: 'flat', salesTaxRate: 4.75, avgLocalSalesTax: 2.22, avgPropertyTaxRate: 0.78, hasNoIncomeTax: false, costOfLivingIndex: 96, notes: ['Rate declining annually'] },\n  { code: 'NE', name: 'Nebraska', incomeTaxRate: 0.0564, incomeTaxType: 'graduated', salesTaxRate: 5.5, avgLocalSalesTax: 1.44, avgPropertyTaxRate: 1.61, hasNoIncomeTax: false, costOfLivingIndex: 92, notes: ['High property taxes'] },\n  { code: 'NH', name: 'New Hampshire', incomeTaxRate: 0, incomeTaxType: 'none', salesTaxRate: 0, avgLocalSalesTax: 0, avgPropertyTaxRate: 1.86, hasNoIncomeTax: true, costOfLivingIndex: 112, notes: ['No income tax (interest/dividends tax repealed 2025)', 'No sales tax', 'Very high property tax'] },\n  { code: 'NJ', name: 'New Jersey', incomeTaxRate: 0.1075, incomeTaxType: 'graduated', salesTaxRate: 6.625, avgLocalSalesTax: 0, avgPropertyTaxRate: 2.23, hasNoIncomeTax: false, costOfLivingIndex: 120, notes: ['Highest property taxes in nation'] },\n  { code: 'NM', name: 'New Mexico', incomeTaxRate: 0.059, incomeTaxType: 'graduated', salesTaxRate: 4.875, avgLocalSalesTax: 2.69, avgPropertyTaxRate: 0.67, hasNoIncomeTax: false, costOfLivingIndex: 92, notes: ['Low cost of living'] },\n  { code: 'NV', name: 'Nevada', incomeTaxRate: 0, incomeTaxType: 'none', salesTaxRate: 6.85, avgLocalSalesTax: 1.38, avgPropertyTaxRate: 0.53, hasNoIncomeTax: true, costOfLivingIndex: 104, notes: ['No state income tax', 'Low property tax'] },\n  { code: 'NY', name: 'New York', incomeTaxRate: 0.109, incomeTaxType: 'graduated', salesTaxRate: 4.0, avgLocalSalesTax: 4.52, avgPropertyTaxRate: 1.62, hasNoIncomeTax: false, costOfLivingIndex: 126, notes: ['NYC adds 3.876% city income tax', 'Very high total tax burden'] },\n  { code: 'OH', name: 'Ohio', incomeTaxRate: 0.035, incomeTaxType: 'graduated', salesTaxRate: 5.75, avgLocalSalesTax: 1.47, avgPropertyTaxRate: 1.53, hasNoIncomeTax: false, costOfLivingIndex: 90, notes: ['Low income tax'] },\n  { code: 'OK', name: 'Oklahoma', incomeTaxRate: 0.0475, incomeTaxType: 'graduated', salesTaxRate: 4.5, avgLocalSalesTax: 4.47, avgPropertyTaxRate: 0.86, hasNoIncomeTax: false, costOfLivingIndex: 87, notes: ['Low cost of living'] },\n  { code: 'OR', name: 'Oregon', incomeTaxRate: 0.099, incomeTaxType: 'graduated', salesTaxRate: 0, avgLocalSalesTax: 0, avgPropertyTaxRate: 0.90, hasNoIncomeTax: false, costOfLivingIndex: 113, notes: ['No sales tax', 'High income tax'] },\n  { code: 'PA', name: 'Pennsylvania', incomeTaxRate: 0.0307, incomeTaxType: 'flat', salesTaxRate: 6.0, avgLocalSalesTax: 0.34, avgPropertyTaxRate: 1.49, hasNoIncomeTax: false, costOfLivingIndex: 99, notes: ['Low flat income tax', 'High property taxes', 'Retirement income exempt'] },\n  { code: 'SC', name: 'South Carolina', incomeTaxRate: 0.064, incomeTaxType: 'graduated', salesTaxRate: 6.0, avgLocalSalesTax: 1.43, avgPropertyTaxRate: 0.55, hasNoIncomeTax: false, costOfLivingIndex: 93, notes: ['Low property taxes'] },\n  { code: 'SD', name: 'South Dakota', incomeTaxRate: 0, incomeTaxType: 'none', salesTaxRate: 4.2, avgLocalSalesTax: 1.90, avgPropertyTaxRate: 1.08, hasNoIncomeTax: true, costOfLivingIndex: 94, notes: ['No state income tax', 'Low cost of living'] },\n  { code: 'TN', name: 'Tennessee', incomeTaxRate: 0, incomeTaxType: 'none', salesTaxRate: 7.0, avgLocalSalesTax: 2.55, avgPropertyTaxRate: 0.64, hasNoIncomeTax: true, costOfLivingIndex: 91, notes: ['No state income tax', 'High sales tax', 'Low cost of living'] },\n  { code: 'TX', name: 'Texas', incomeTaxRate: 0, incomeTaxType: 'none', salesTaxRate: 6.25, avgLocalSalesTax: 1.94, avgPropertyTaxRate: 1.60, hasNoIncomeTax: true, costOfLivingIndex: 93, notes: ['No state income tax', 'High property tax compensates', 'Popular relocation target'] },\n  { code: 'UT', name: 'Utah', incomeTaxRate: 0.0465, incomeTaxType: 'flat', salesTaxRate: 6.1, avgLocalSalesTax: 1.09, avgPropertyTaxRate: 0.55, hasNoIncomeTax: false, costOfLivingIndex: 99, notes: ['Flat 4.65% income tax'] },\n  { code: 'VA', name: 'Virginia', incomeTaxRate: 0.0575, incomeTaxType: 'graduated', salesTaxRate: 5.3, avgLocalSalesTax: 0.45, avgPropertyTaxRate: 0.80, hasNoIncomeTax: false, costOfLivingIndex: 103, notes: [] },\n  { code: 'WA', name: 'Washington', incomeTaxRate: 0, incomeTaxType: 'none', salesTaxRate: 6.5, avgLocalSalesTax: 2.74, avgPropertyTaxRate: 0.87, hasNoIncomeTax: true, costOfLivingIndex: 110, notes: ['No state income tax', '7% capital gains tax on gains above $270K'] },\n  { code: 'WI', name: 'Wisconsin', incomeTaxRate: 0.0765, incomeTaxType: 'graduated', salesTaxRate: 5.0, avgLocalSalesTax: 0.43, avgPropertyTaxRate: 1.61, hasNoIncomeTax: false, costOfLivingIndex: 95, notes: [] },\n  { code: 'WV', name: 'West Virginia', incomeTaxRate: 0.0512, incomeTaxType: 'graduated', salesTaxRate: 6.0, avgLocalSalesTax: 0.39, avgPropertyTaxRate: 0.53, hasNoIncomeTax: false, costOfLivingIndex: 84, notes: ['Lowest cost of living region'] },\n  { code: 'WY', name: 'Wyoming', incomeTaxRate: 0, incomeTaxType: 'none', salesTaxRate: 4.0, avgLocalSalesTax: 1.36, avgPropertyTaxRate: 0.55, hasNoIncomeTax: true, costOfLivingIndex: 95, notes: ['No state income tax', 'Low overall tax burden'] },\n]\n\n// ===================================================================\n//  STATE COMPARISON\n// ===================================================================\n\nexport interface StateComparison {\n  code: string\n  name: string\n  estimatedIncomeTax: number\n  estimatedSalesTax: number\n  estimatedPropertyTax: number\n  totalStateTax: number\n  savingsVsCurrent: number\n  costOfLivingIndex: number\n  adjustedSavings: number // savings adjusted for COL\n  incomeTaxType: string\n  notes: string[]\n  rank: number\n}\n\nexport interface ArbitrageAnalysis {\n  currentState: StateComparison\n  comparisons: StateComparison[]\n  bestOverall: StateComparison\n  bestNoIncomeTax: StateComparison | null\n  bestLowCOL: StateComparison\n  topRecommendations: StateComparison[]\n  annualSpending: number\n  homeValue: number\n}\n\nexport function analyzeStateArbitrage(\n  state: FortunaState,\n  annualSpending: number = 60000,\n  homeValue: number = 300000,\n): ArbitrageAnalysis {\n  const report = generateTaxReport(state)\n  const taxableIncome = report.agi - report.deductionAmount\n\n  function calculateStateTax(stateProfile: StateTaxProfile): StateComparison {\n    // Income tax (simplified — uses top marginal as effective for comparison)\n    const effectiveRate = stateProfile.incomeTaxType === 'none' ? 0\n      : stateProfile.incomeTaxType === 'flat' ? stateProfile.incomeTaxRate\n      : stateProfile.incomeTaxRate * 0.75 // approximate effective from marginal\n    const incomeTax = Math.round(Math.max(0, taxableIncome) * effectiveRate)\n\n    // Sales tax\n    const totalSalesRate = (stateProfile.salesTaxRate + stateProfile.avgLocalSalesTax) / 100\n    const taxableSpending = annualSpending * 0.35 // ~35% of spending is taxable goods\n    const salesTax = Math.round(taxableSpending * totalSalesRate)\n\n    // Property tax\n    const propertyTax = Math.round(homeValue * stateProfile.avgPropertyTaxRate / 100)\n\n    const totalTax = incomeTax + salesTax + propertyTax\n\n    return {\n      code: stateProfile.code,\n      name: stateProfile.name,\n      estimatedIncomeTax: incomeTax,\n      estimatedSalesTax: salesTax,\n      estimatedPropertyTax: propertyTax,\n      totalStateTax: totalTax,\n      savingsVsCurrent: 0, // filled later\n      costOfLivingIndex: stateProfile.costOfLivingIndex,\n      adjustedSavings: 0, // filled later\n      incomeTaxType: stateProfile.incomeTaxType === 'none' ? 'None' : stateProfile.incomeTaxType === 'flat' ? `Flat ${(stateProfile.incomeTaxRate * 100).toFixed(1)}%` : `Graduated (up to ${(stateProfile.incomeTaxRate * 100).toFixed(1)}%)`,\n      notes: stateProfile.notes,\n      rank: 0,\n    }\n  }\n\n  const comparisons = STATE_DATA.map(calculateStateTax)\n  const currentState = comparisons.find(c => c.code === state.profile.state) || comparisons[0]\n\n  // Calculate savings vs current\n  comparisons.forEach(c => {\n    c.savingsVsCurrent = currentState.totalStateTax - c.totalStateTax\n    // Adjust for cost of living difference\n    const colDiff = (currentState.costOfLivingIndex - c.costOfLivingIndex) / 100\n    c.adjustedSavings = c.savingsVsCurrent + Math.round(annualSpending * colDiff)\n  })\n\n  // Rank by adjusted savings\n  comparisons.sort((a, b) => b.adjustedSavings - a.adjustedSavings)\n  comparisons.forEach((c, i) => c.rank = i + 1)\n\n  const bestOverall = comparisons[0]\n  const bestNoIncomeTax = comparisons.find(c => c.incomeTaxType === 'None' && c.code !== currentState.code) || null\n  const bestLowCOL = [...comparisons].sort((a, b) => a.costOfLivingIndex - b.costOfLivingIndex)[0]\n\n  // Top recommendations: best 5 that aren't current state\n  const topRecommendations = comparisons.filter(c => c.code !== currentState.code).slice(0, 8)\n\n  return {\n    currentState,\n    comparisons,\n    bestOverall,\n    bestNoIncomeTax,\n    bestLowCOL,\n    topRecommendations,\n    annualSpending,\n    homeValue,\n  }\n}\n\n// ─── Phase H: Entity Nexus Analysis ──────────────────────────────────────────\n\nexport interface EntityNexusInfo {\n  entityId: string\n  entityName: string\n  entityType: string\n  registeredState: string\n  operatingStates: string[]\n  nexusWarnings: string[]\n  relocationImpact: { state: string; savings: number; registrationCost: number; nexusCleared: boolean }[]\n}\n\n/** Analyze entity nexus implications for state changes */\nexport function analyzeEntityNexus(\n  state: FortunaState,\n): EntityNexusInfo[] {\n  const entities = state.entities.filter(e => e.isActive)\n  if (entities.length === 0) return []\n\n  return entities.map(entity => {\n    const registeredState = entity.state || state.profile.state\n    const operatingStates: string[] = [registeredState]\n\n    // Check if entity has income from other states (simplified heuristic)\n    const entityIncome = state.incomeStreams\n      .filter(s => s.entityId === entity.id && s.isActive)\n\n    const nexusWarnings: string[] = []\n\n    // S-Corp/LLC specific warnings\n    if (entity.type === 'llc_scorp' || entity.type === 'scorp') {\n      if (!entity.officerSalary || entity.officerSalary === 0) {\n        nexusWarnings.push('S-Corp requires reasonable officer salary — missing salary creates audit risk in any state')\n      }\n      const totalIncome = entityIncome.reduce((s, i) => s + i.annualAmount, 0)\n      if (entity.officerSalary && totalIncome > 0 && entity.officerSalary / totalIncome < 0.3) {\n        nexusWarnings.push(`Officer salary is ${Math.round((entity.officerSalary / totalIncome) * 100)}% of entity income — IRS scrutinizes ratios below 30-40%`)\n      }\n    }\n\n    // Franchise tax warnings\n    const franchiseTaxStates = ['CA', 'TX', 'IL', 'NY', 'DE']\n    if (franchiseTaxStates.includes(registeredState)) {\n      nexusWarnings.push(`${registeredState} imposes franchise/entity tax regardless of income`)\n    }\n\n    // Multi-state registration\n    if (registeredState !== state.profile.state) {\n      operatingStates.push(state.profile.state)\n      nexusWarnings.push(`Entity registered in ${registeredState} but owner in ${state.profile.state} — may need foreign qualification`)\n    }\n\n    // Estimate relocation impact for top 5 no-income-tax states\n    const noTaxStates = ['TX', 'FL', 'NV', 'WA', 'WY', 'SD', 'AK', 'TN', 'NH']\n    const relocationImpact = noTaxStates\n      .filter(s => s !== registeredState)\n      .slice(0, 5)\n      .map(targetState => {\n        const stateData = STATE_DATA.find(sd => sd.code === targetState)\n        const currentData = STATE_DATA.find(sd => sd.code === registeredState)\n        const totalEntityIncome = entityIncome.reduce((s, i) => s + i.annualAmount, 0)\n\n        const currentRate = currentData?.incomeTaxType === 'none' ? 0\n          : currentData?.incomeTaxType === 'flat' ? (currentData?.incomeTaxRate || 0)\n          : (currentData?.incomeTaxRate || 0) * 0.75\n        const savings = Math.round(totalEntityIncome * currentRate)\n\n        return {\n          state: targetState,\n          savings,\n          registrationCost: targetState === 'WY' ? 100 : targetState === 'NV' ? 425 : targetState === 'TX' ? 300 : 200,\n          nexusCleared: targetState !== state.profile.state,\n        }\n      })\n\n    return {\n      entityId: entity.id,\n      entityName: entity.name,\n      entityType: entity.type,\n      registeredState,\n      operatingStates,\n      nexusWarnings,\n      relocationImpact,\n    }\n  })\n}\n\nconst STATE_DATA_IMPORT = STATE_DATA // for external access\nexport { STATE_DATA_IMPORT as STATE_TAX_DATA }\n\n// ─── State Tax Reciprocity Agreements ─────────────────────────────────────\n// Workers who live in one state and work in another may only need to file\n// in their resident state if a reciprocity agreement exists.\n\n/** Map of work state → list of resident states with reciprocity */\nconst RECIPROCITY_AGREEMENTS: Record<string, string[]> = {\n  AZ: ['CA', 'IN', 'OR', 'VA'],\n  DC: ['all'], // All states have reciprocity with DC\n  IL: ['IA', 'KY', 'MI', 'WI'],\n  IN: ['KY', 'MI', 'OH', 'PA', 'WI'],\n  IA: ['IL'],\n  KY: ['IL', 'IN', 'MI', 'OH', 'VA', 'WV', 'WI'],\n  MD: ['DC', 'PA', 'VA', 'WV'],\n  MI: ['IL', 'IN', 'KY', 'MN', 'OH', 'WI'],\n  MN: ['MI', 'ND'],\n  MT: ['ND'],\n  NJ: ['PA'],\n  ND: ['MN', 'MT'],\n  OH: ['IN', 'KY', 'MI', 'PA', 'WV'],\n  PA: ['IN', 'MD', 'NJ', 'OH', 'VA', 'WV'],\n  VA: ['DC', 'KY', 'MD', 'PA', 'WV'],\n  WV: ['KY', 'MD', 'OH', 'PA', 'VA'],\n  WI: ['IL', 'IN', 'KY', 'MI'],\n}\n\nexport interface ReciprocityResult {\n  workState: string\n  residentState: string\n  hasReciprocity: boolean\n  impact: string\n  recommendation: string\n  estimatedSavings: number\n}\n\n/** Check if cross-border worker benefits from reciprocity */\nexport function checkReciprocity(\n  residentState: string,\n  workState: string,\n  annualIncome: number,\n): ReciprocityResult {\n  const reciprocalResidents = RECIPROCITY_AGREEMENTS[workState]\n  const hasReciprocity = reciprocalResidents\n    ? reciprocalResidents.includes('all') || reciprocalResidents.includes(residentState)\n    : false\n\n  if (residentState === workState) {\n    return {\n      workState, residentState, hasReciprocity: true,\n      impact: 'Same state — no cross-border filing needed',\n      recommendation: 'No action needed',\n      estimatedSavings: 0,\n    }\n  }\n\n  const workStateData = STATE_DATA.find(s => s.code === workState)\n  const resStateData = STATE_DATA.find(s => s.code === residentState)\n  const workRate = workStateData?.incomeTaxType === 'none' ? 0 : (workStateData?.incomeTaxRate || 0)\n  const resRate = resStateData?.incomeTaxType === 'none' ? 0 : (resStateData?.incomeTaxRate || 0)\n\n  if (hasReciprocity) {\n    return {\n      workState, residentState, hasReciprocity: true,\n      impact: `Reciprocity agreement: you only pay tax to ${residentState} (${(resRate * 100).toFixed(1)}%), not ${workState} (${(workRate * 100).toFixed(1)}%).`,\n      recommendation: `File form with ${workState} employer for exemption from ${workState} withholding. Only file ${residentState} return.`,\n      estimatedSavings: workRate > resRate\n        ? Math.round(annualIncome * (workRate - resRate))\n        : 0,\n    }\n  }\n\n  // No reciprocity — may owe both, with credit\n  return {\n    workState, residentState, hasReciprocity: false,\n    impact: `No reciprocity: you must file in both ${workState} and ${residentState}. Your resident state typically gives a credit for taxes paid to ${workState}.`,\n    recommendation: `File non-resident return in ${workState}, then claim credit on ${residentState} resident return. Net tax is approximately the higher of the two rates.`,\n    estimatedSavings: 0,\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\state-tax-engine.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'currentState' is defined but never used.","line":242,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":242,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":253,"column":82,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":253,"endColumn":85,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[30064,30067],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[30064,30067],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":258,"column":80,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":258,"endColumn":83,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[30301,30304],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[30301,30304],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_' is defined but never used.","line":271,"column":42,"nodeType":"Identifier","messageId":"unusedVar","endLine":271,"endColumn":43}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE — 50-State Tax Engine v1\n * \n * Full graduated bracket calculations for all 50 states + DC.\n * Replaces the single-rate approximations in tax-calculator.ts.\n * \n * Data sources: Tax Foundation 2025, state DOR publications.\n * \n * Features:\n *   - Graduated brackets for all progressive states\n *   - Filing status adjustments (single, MFJ, MFS, HoH)\n *   - State standard deductions and personal exemptions\n *   - Notable local surtaxes (NYC, Portland, San Francisco)\n *   - Capital gains treatment variations\n *   - SE health insurance deduction conformity\n */\n\nexport interface StateTaxResult {\n  stateCode: string\n  stateName: string\n  taxableIncome: number\n  stateTax: number\n  effectiveRate: number\n  marginalRate: number\n  localTax: number\n  localName?: string\n  totalStateLocal: number\n  hasCapGainsPreference: boolean\n  notes: string[]\n}\n\ninterface Bracket { min: number; max: number; rate: number }\n\ninterface StateConfig {\n  name: string\n  type: 'none' | 'flat' | 'progressive'\n  standardDeduction: { single: number; mfj: number }\n  personalExemption: { single: number; mfj: number }\n  brackets: { single: Bracket[]; mfj: Bracket[] }\n  flatRate?: number\n  localSurtax?: (income: number) => number\n  localName?: string\n  capGainsRate?: number // if different from income\n  notes: string[]\n}\n\n// ─── State Configurations ───────────────────────────────────────────────────\n\nconst INF = 1e12\n\nconst STATES: Record<string, StateConfig> = {\n  AL: { name: 'Alabama', type: 'progressive', standardDeduction: { single: 2500, mfj: 7500 }, personalExemption: { single: 1500, mfj: 3000 },\n    brackets: { single: [{ min: 0, max: 500, rate: 0.02 }, { min: 500, max: 3000, rate: 0.04 }, { min: 3000, max: INF, rate: 0.05 }], mfj: [{ min: 0, max: 1000, rate: 0.02 }, { min: 1000, max: 6000, rate: 0.04 }, { min: 6000, max: INF, rate: 0.05 }] }, notes: ['Federal income tax deduction allowed (up to $13,903 single)'] },\n  AK: { name: 'Alaska', type: 'none', standardDeduction: { single: 0, mfj: 0 }, personalExemption: { single: 0, mfj: 0 }, brackets: { single: [], mfj: [] }, notes: ['No state income tax'] },\n  AZ: { name: 'Arizona', type: 'flat', standardDeduction: { single: 14600, mfj: 29200 }, personalExemption: { single: 0, mfj: 0 }, flatRate: 0.025, brackets: { single: [{ min: 0, max: INF, rate: 0.025 }], mfj: [{ min: 0, max: INF, rate: 0.025 }] }, notes: ['Flat 2.5% rate effective 2023'] },\n  AR: { name: 'Arkansas', type: 'progressive', standardDeduction: { single: 2340, mfj: 4680 }, personalExemption: { single: 29, mfj: 58 },\n    brackets: { single: [{ min: 0, max: 5100, rate: 0.02 }, { min: 5100, max: 10300, rate: 0.04 }, { min: 10300, max: INF, rate: 0.044 }], mfj: [{ min: 0, max: 5100, rate: 0.02 }, { min: 5100, max: 10300, rate: 0.04 }, { min: 10300, max: INF, rate: 0.044 }] }, notes: ['Top rate dropped to 4.4% in 2025'] },\n  CA: { name: 'California', type: 'progressive', standardDeduction: { single: 5540, mfj: 11080 }, personalExemption: { single: 144, mfj: 288 },\n    brackets: {\n      single: [{ min: 0, max: 10412, rate: 0.01 }, { min: 10412, max: 24684, rate: 0.02 }, { min: 24684, max: 38959, rate: 0.04 }, { min: 38959, max: 54081, rate: 0.06 }, { min: 54081, max: 68350, rate: 0.08 }, { min: 68350, max: 349137, rate: 0.093 }, { min: 349137, max: 418961, rate: 0.103 }, { min: 418961, max: 698271, rate: 0.113 }, { min: 698271, max: 1000000, rate: 0.123 }, { min: 1000000, max: INF, rate: 0.133 }],\n      mfj: [{ min: 0, max: 20824, rate: 0.01 }, { min: 20824, max: 49368, rate: 0.02 }, { min: 49368, max: 77918, rate: 0.04 }, { min: 77918, max: 108162, rate: 0.06 }, { min: 108162, max: 136700, rate: 0.08 }, { min: 136700, max: 698274, rate: 0.093 }, { min: 698274, max: 837922, rate: 0.103 }, { min: 837922, max: 1396542, rate: 0.113 }, { min: 1396542, max: 2000000, rate: 0.123 }, { min: 2000000, max: INF, rate: 0.133 }]\n    }, notes: ['No capital gains preference — taxed as ordinary income', '1% mental health surcharge over $1M', 'Does not conform to §199A QBI deduction'] },\n  CO: { name: 'Colorado', type: 'flat', standardDeduction: { single: 14600, mfj: 29200 }, personalExemption: { single: 0, mfj: 0 }, flatRate: 0.044, brackets: { single: [{ min: 0, max: INF, rate: 0.044 }], mfj: [{ min: 0, max: INF, rate: 0.044 }] }, notes: ['Uses federal taxable income as starting point'] },\n  CT: { name: 'Connecticut', type: 'progressive', standardDeduction: { single: 0, mfj: 0 }, personalExemption: { single: 15000, mfj: 24000 },\n    brackets: { single: [{ min: 0, max: 10000, rate: 0.03 }, { min: 10000, max: 50000, rate: 0.05 }, { min: 50000, max: 100000, rate: 0.055 }, { min: 100000, max: 200000, rate: 0.06 }, { min: 200000, max: 250000, rate: 0.065 }, { min: 250000, max: 500000, rate: 0.069 }, { min: 500000, max: INF, rate: 0.0699 }], mfj: [{ min: 0, max: 20000, rate: 0.03 }, { min: 20000, max: 100000, rate: 0.05 }, { min: 100000, max: 200000, rate: 0.055 }, { min: 200000, max: 400000, rate: 0.06 }, { min: 400000, max: 500000, rate: 0.065 }, { min: 500000, max: 1000000, rate: 0.069 }, { min: 1000000, max: INF, rate: 0.0699 }] }, notes: ['Personal exemption phases out at higher incomes'] },\n  DE: { name: 'Delaware', type: 'progressive', standardDeduction: { single: 3250, mfj: 6500 }, personalExemption: { single: 110, mfj: 220 },\n    brackets: { single: [{ min: 0, max: 2000, rate: 0.0 }, { min: 2000, max: 5000, rate: 0.022 }, { min: 5000, max: 10000, rate: 0.039 }, { min: 10000, max: 20000, rate: 0.048 }, { min: 20000, max: 25000, rate: 0.052 }, { min: 25000, max: 60000, rate: 0.0555 }, { min: 60000, max: INF, rate: 0.066 }], mfj: [{ min: 0, max: 2000, rate: 0.0 }, { min: 2000, max: 5000, rate: 0.022 }, { min: 5000, max: 10000, rate: 0.039 }, { min: 10000, max: 20000, rate: 0.048 }, { min: 20000, max: 25000, rate: 0.052 }, { min: 25000, max: 60000, rate: 0.0555 }, { min: 60000, max: INF, rate: 0.066 }] }, notes: ['Wilmington has 1.25% local wage tax'] },\n  FL: { name: 'Florida', type: 'none', standardDeduction: { single: 0, mfj: 0 }, personalExemption: { single: 0, mfj: 0 }, brackets: { single: [], mfj: [] }, notes: ['No state income tax'] },\n  GA: { name: 'Georgia', type: 'flat', standardDeduction: { single: 12000, mfj: 24000 }, personalExemption: { single: 0, mfj: 0 }, flatRate: 0.0549, brackets: { single: [{ min: 0, max: INF, rate: 0.0549 }], mfj: [{ min: 0, max: INF, rate: 0.0549 }] }, notes: ['Transitioning to flat 5.49% (2025), declining to 4.99% by 2029'] },\n  HI: { name: 'Hawaii', type: 'progressive', standardDeduction: { single: 2200, mfj: 4400 }, personalExemption: { single: 1144, mfj: 2288 },\n    brackets: { single: [{ min: 0, max: 2400, rate: 0.014 }, { min: 2400, max: 4800, rate: 0.032 }, { min: 4800, max: 9600, rate: 0.055 }, { min: 9600, max: 14400, rate: 0.064 }, { min: 14400, max: 19200, rate: 0.068 }, { min: 19200, max: 24000, rate: 0.072 }, { min: 24000, max: 36000, rate: 0.076 }, { min: 36000, max: 48000, rate: 0.079 }, { min: 48000, max: 150000, rate: 0.0825 }, { min: 150000, max: 175000, rate: 0.09 }, { min: 175000, max: 200000, rate: 0.10 }, { min: 200000, max: INF, rate: 0.11 }], mfj: [{ min: 0, max: 4800, rate: 0.014 }, { min: 4800, max: 9600, rate: 0.032 }, { min: 9600, max: 19200, rate: 0.055 }, { min: 19200, max: 28800, rate: 0.064 }, { min: 28800, max: 38400, rate: 0.068 }, { min: 38400, max: 48000, rate: 0.072 }, { min: 48000, max: 72000, rate: 0.076 }, { min: 72000, max: 96000, rate: 0.079 }, { min: 96000, max: 300000, rate: 0.0825 }, { min: 300000, max: 350000, rate: 0.09 }, { min: 350000, max: 400000, rate: 0.10 }, { min: 400000, max: INF, rate: 0.11 }] },\n    capGainsRate: 0.0725, notes: ['Capital gains taxed at 7.25% (lower than income rate)', 'Does not conform to §199A'] },\n  ID: { name: 'Idaho', type: 'flat', standardDeduction: { single: 14600, mfj: 29200 }, personalExemption: { single: 0, mfj: 0 }, flatRate: 0.058, brackets: { single: [{ min: 0, max: INF, rate: 0.058 }], mfj: [{ min: 0, max: INF, rate: 0.058 }] }, notes: ['Flat 5.8% effective 2023'] },\n  IL: { name: 'Illinois', type: 'flat', standardDeduction: { single: 0, mfj: 0 }, personalExemption: { single: 2625, mfj: 5250 }, flatRate: 0.0495, brackets: { single: [{ min: 0, max: INF, rate: 0.0495 }], mfj: [{ min: 0, max: INF, rate: 0.0495 }] }, notes: ['Flat 4.95%', '1.5% replacement tax on S-Corp income'] },\n  IN: { name: 'Indiana', type: 'flat', standardDeduction: { single: 0, mfj: 0 }, personalExemption: { single: 1000, mfj: 2000 }, flatRate: 0.0305, brackets: { single: [{ min: 0, max: INF, rate: 0.0305 }], mfj: [{ min: 0, max: INF, rate: 0.0305 }] }, notes: ['3.05% flat rate', 'County income tax adds 0.5-3.38% depending on county'] },\n  IA: { name: 'Iowa', type: 'flat', standardDeduction: { single: 14600, mfj: 29200 }, personalExemption: { single: 40, mfj: 80 }, flatRate: 0.038, brackets: { single: [{ min: 0, max: INF, rate: 0.038 }], mfj: [{ min: 0, max: INF, rate: 0.038 }] }, notes: ['Flat 3.8% effective 2025'] },\n  KS: { name: 'Kansas', type: 'progressive', standardDeduction: { single: 3500, mfj: 8000 }, personalExemption: { single: 2250, mfj: 4500 },\n    brackets: { single: [{ min: 0, max: 15000, rate: 0.031 }, { min: 15000, max: 30000, rate: 0.0525 }, { min: 30000, max: INF, rate: 0.057 }], mfj: [{ min: 0, max: 30000, rate: 0.031 }, { min: 30000, max: 60000, rate: 0.0525 }, { min: 60000, max: INF, rate: 0.057 }] }, notes: [] },\n  KY: { name: 'Kentucky', type: 'flat', standardDeduction: { single: 3160, mfj: 6320 }, personalExemption: { single: 0, mfj: 0 }, flatRate: 0.04, brackets: { single: [{ min: 0, max: INF, rate: 0.04 }], mfj: [{ min: 0, max: INF, rate: 0.04 }] }, notes: ['Flat 4% effective 2024'] },\n  LA: { name: 'Louisiana', type: 'progressive', standardDeduction: { single: 12500, mfj: 25000 }, personalExemption: { single: 0, mfj: 0 },\n    brackets: { single: [{ min: 0, max: 12500, rate: 0.0185 }, { min: 12500, max: 50000, rate: 0.035 }, { min: 50000, max: INF, rate: 0.0425 }], mfj: [{ min: 0, max: 25000, rate: 0.0185 }, { min: 25000, max: 100000, rate: 0.035 }, { min: 100000, max: INF, rate: 0.0425 }] }, notes: ['Restructured 2025 with new brackets'] },\n  ME: { name: 'Maine', type: 'progressive', standardDeduction: { single: 14600, mfj: 29200 }, personalExemption: { single: 5000, mfj: 10000 },\n    brackets: { single: [{ min: 0, max: 26050, rate: 0.058 }, { min: 26050, max: 61600, rate: 0.0675 }, { min: 61600, max: INF, rate: 0.0715 }], mfj: [{ min: 0, max: 52100, rate: 0.058 }, { min: 52100, max: 123250, rate: 0.0675 }, { min: 123250, max: INF, rate: 0.0715 }] }, notes: [] },\n  MD: { name: 'Maryland', type: 'progressive', standardDeduction: { single: 2550, mfj: 5150 }, personalExemption: { single: 3200, mfj: 6400 },\n    brackets: { single: [{ min: 0, max: 1000, rate: 0.02 }, { min: 1000, max: 2000, rate: 0.03 }, { min: 2000, max: 3000, rate: 0.04 }, { min: 3000, max: 100000, rate: 0.0475 }, { min: 100000, max: 125000, rate: 0.05 }, { min: 125000, max: 150000, rate: 0.0525 }, { min: 150000, max: 250000, rate: 0.055 }, { min: 250000, max: INF, rate: 0.0575 }], mfj: [{ min: 0, max: 1000, rate: 0.02 }, { min: 1000, max: 2000, rate: 0.03 }, { min: 2000, max: 3000, rate: 0.04 }, { min: 3000, max: 150000, rate: 0.0475 }, { min: 150000, max: 175000, rate: 0.05 }, { min: 175000, max: 225000, rate: 0.0525 }, { min: 225000, max: 300000, rate: 0.055 }, { min: 300000, max: INF, rate: 0.0575 }] },\n    localSurtax: () => 0.032, localName: 'County tax (avg 3.2%)', notes: ['County tax 2.25-3.2% on top of state rate'] },\n  MA: { name: 'Massachusetts', type: 'flat', standardDeduction: { single: 0, mfj: 0 }, personalExemption: { single: 4400, mfj: 8800 }, flatRate: 0.05, brackets: { single: [{ min: 0, max: INF, rate: 0.05 }], mfj: [{ min: 0, max: INF, rate: 0.05 }] }, notes: ['4% millionaire surtax on income over $1M (total 9%)', 'Short-term cap gains taxed at 8.5%'] },\n  MI: { name: 'Michigan', type: 'flat', standardDeduction: { single: 0, mfj: 0 }, personalExemption: { single: 5600, mfj: 11200 }, flatRate: 0.0425, brackets: { single: [{ min: 0, max: INF, rate: 0.0425 }], mfj: [{ min: 0, max: INF, rate: 0.0425 }] }, notes: ['Some cities have additional income tax (Detroit 2.4%)'] },\n  MN: { name: 'Minnesota', type: 'progressive', standardDeduction: { single: 14575, mfj: 29150 }, personalExemption: { single: 0, mfj: 0 },\n    brackets: { single: [{ min: 0, max: 31690, rate: 0.0535 }, { min: 31690, max: 104090, rate: 0.068 }, { min: 104090, max: 193240, rate: 0.0785 }, { min: 193240, max: INF, rate: 0.0985 }], mfj: [{ min: 0, max: 46330, rate: 0.0535 }, { min: 46330, max: 184040, rate: 0.068 }, { min: 184040, max: 321450, rate: 0.0785 }, { min: 321450, max: INF, rate: 0.0985 }] }, notes: ['Does not conform to §199A QBI deduction'] },\n  MS: { name: 'Mississippi', type: 'flat', standardDeduction: { single: 2300, mfj: 4600 }, personalExemption: { single: 6000, mfj: 12000 }, flatRate: 0.047, brackets: { single: [{ min: 0, max: 10000, rate: 0.0 }, { min: 10000, max: INF, rate: 0.047 }], mfj: [{ min: 0, max: 10000, rate: 0.0 }, { min: 10000, max: INF, rate: 0.047 }] }, notes: ['First $10K exempt; 4.7% above that (2025)'] },\n  MO: { name: 'Missouri', type: 'progressive', standardDeduction: { single: 14600, mfj: 29200 }, personalExemption: { single: 0, mfj: 0 },\n    brackets: { single: [{ min: 0, max: 1207, rate: 0.02 }, { min: 1207, max: 2414, rate: 0.025 }, { min: 2414, max: 3621, rate: 0.03 }, { min: 3621, max: 4828, rate: 0.035 }, { min: 4828, max: 6035, rate: 0.04 }, { min: 6035, max: 7242, rate: 0.045 }, { min: 7242, max: 8449, rate: 0.05 }, { min: 8449, max: INF, rate: 0.048 }], mfj: [{ min: 0, max: 1207, rate: 0.02 }, { min: 1207, max: 2414, rate: 0.025 }, { min: 2414, max: 3621, rate: 0.03 }, { min: 3621, max: 4828, rate: 0.035 }, { min: 4828, max: 6035, rate: 0.04 }, { min: 6035, max: 7242, rate: 0.045 }, { min: 7242, max: 8449, rate: 0.05 }, { min: 8449, max: INF, rate: 0.048 }] }, notes: ['Top rate dropped to 4.8% in 2025', 'Kansas City and St. Louis have 1% earnings tax'] },\n  MT: { name: 'Montana', type: 'progressive', standardDeduction: { single: 14600, mfj: 29200 }, personalExemption: { single: 0, mfj: 0 },\n    brackets: { single: [{ min: 0, max: 20500, rate: 0.047 }, { min: 20500, max: INF, rate: 0.059 }], mfj: [{ min: 0, max: 41000, rate: 0.047 }, { min: 41000, max: INF, rate: 0.059 }] }, notes: ['2-bracket system effective 2024'] },\n  NE: { name: 'Nebraska', type: 'progressive', standardDeduction: { single: 7900, mfj: 15800 }, personalExemption: { single: 0, mfj: 0 },\n    brackets: { single: [{ min: 0, max: 3700, rate: 0.0246 }, { min: 3700, max: 22170, rate: 0.0351 }, { min: 22170, max: 35730, rate: 0.0501 }, { min: 35730, max: INF, rate: 0.0564 }], mfj: [{ min: 0, max: 7390, rate: 0.0246 }, { min: 7390, max: 44350, rate: 0.0351 }, { min: 44350, max: 71460, rate: 0.0501 }, { min: 71460, max: INF, rate: 0.0564 }] }, notes: [] },\n  NV: { name: 'Nevada', type: 'none', standardDeduction: { single: 0, mfj: 0 }, personalExemption: { single: 0, mfj: 0 }, brackets: { single: [], mfj: [] }, notes: ['No state income tax'] },\n  NH: { name: 'New Hampshire', type: 'none', standardDeduction: { single: 0, mfj: 0 }, personalExemption: { single: 0, mfj: 0 }, brackets: { single: [], mfj: [] }, notes: ['No income tax (interest & dividends tax repealed 2025)'] },\n  NJ: { name: 'New Jersey', type: 'progressive', standardDeduction: { single: 0, mfj: 0 }, personalExemption: { single: 1000, mfj: 2000 },\n    brackets: { single: [{ min: 0, max: 20000, rate: 0.014 }, { min: 20000, max: 35000, rate: 0.0175 }, { min: 35000, max: 40000, rate: 0.035 }, { min: 40000, max: 75000, rate: 0.05525 }, { min: 75000, max: 500000, rate: 0.0637 }, { min: 500000, max: 1000000, rate: 0.0897 }, { min: 1000000, max: INF, rate: 0.1075 }], mfj: [{ min: 0, max: 20000, rate: 0.014 }, { min: 20000, max: 50000, rate: 0.0175 }, { min: 50000, max: 70000, rate: 0.035 }, { min: 70000, max: 80000, rate: 0.05525 }, { min: 80000, max: 150000, rate: 0.0637 }, { min: 150000, max: 500000, rate: 0.0897 }, { min: 500000, max: 1000000, rate: 0.1075 }, { min: 1000000, max: INF, rate: 0.1075 }] },\n    notes: ['Does not conform to §199A', 'Does not allow SE health insurance deduction', 'No standard deduction — uses exemptions only'] },\n  NM: { name: 'New Mexico', type: 'progressive', standardDeduction: { single: 14600, mfj: 29200 }, personalExemption: { single: 0, mfj: 0 },\n    brackets: { single: [{ min: 0, max: 5500, rate: 0.017 }, { min: 5500, max: 11000, rate: 0.032 }, { min: 11000, max: 16000, rate: 0.047 }, { min: 16000, max: 210000, rate: 0.049 }, { min: 210000, max: INF, rate: 0.059 }], mfj: [{ min: 0, max: 8000, rate: 0.017 }, { min: 8000, max: 16000, rate: 0.032 }, { min: 16000, max: 24000, rate: 0.047 }, { min: 24000, max: 315000, rate: 0.049 }, { min: 315000, max: INF, rate: 0.059 }] }, notes: [] },\n  NY: { name: 'New York', type: 'progressive', standardDeduction: { single: 8000, mfj: 16050 }, personalExemption: { single: 0, mfj: 0 },\n    brackets: {\n      single: [{ min: 0, max: 8500, rate: 0.04 }, { min: 8500, max: 11700, rate: 0.045 }, { min: 11700, max: 13900, rate: 0.0525 }, { min: 13900, max: 80650, rate: 0.055 }, { min: 80650, max: 215400, rate: 0.06 }, { min: 215400, max: 1077550, rate: 0.0685 }, { min: 1077550, max: 5000000, rate: 0.0965 }, { min: 5000000, max: 25000000, rate: 0.103 }, { min: 25000000, max: INF, rate: 0.109 }],\n      mfj: [{ min: 0, max: 17150, rate: 0.04 }, { min: 17150, max: 23600, rate: 0.045 }, { min: 23600, max: 27900, rate: 0.0525 }, { min: 27900, max: 161550, rate: 0.055 }, { min: 161550, max: 323200, rate: 0.06 }, { min: 323200, max: 2155350, rate: 0.0685 }, { min: 2155350, max: 5000000, rate: 0.0965 }, { min: 5000000, max: 25000000, rate: 0.103 }, { min: 25000000, max: INF, rate: 0.109 }]\n    },\n    localSurtax: (income) => {\n      // NYC tax (simplified — 4 brackets)\n      if (income <= 12000) return income * 0.03078\n      if (income <= 25000) return 12000 * 0.03078 + (income - 12000) * 0.03762\n      if (income <= 50000) return 12000 * 0.03078 + 13000 * 0.03762 + (income - 25000) * 0.03819\n      return 12000 * 0.03078 + 13000 * 0.03762 + 25000 * 0.03819 + (income - 50000) * 0.03876\n    },\n    localName: 'NYC', notes: ['NYC residents add 3.1-3.9% city tax', 'Yonkers adds 16.75% surcharge on state tax'] },\n  NC: { name: 'North Carolina', type: 'flat', standardDeduction: { single: 12750, mfj: 25500 }, personalExemption: { single: 0, mfj: 0 }, flatRate: 0.045, brackets: { single: [{ min: 0, max: INF, rate: 0.045 }], mfj: [{ min: 0, max: INF, rate: 0.045 }] }, notes: ['Flat 4.5% (2025), declining to 3.99% by 2027'] },\n  ND: { name: 'North Dakota', type: 'flat', standardDeduction: { single: 14600, mfj: 29200 }, personalExemption: { single: 0, mfj: 0 }, flatRate: 0.0195, brackets: { single: [{ min: 0, max: INF, rate: 0.0195 }], mfj: [{ min: 0, max: INF, rate: 0.0195 }] }, notes: ['Flat 1.95% effective 2024'] },\n  OH: { name: 'Ohio', type: 'progressive', standardDeduction: { single: 0, mfj: 0 }, personalExemption: { single: 2400, mfj: 4800 },\n    brackets: { single: [{ min: 0, max: 26050, rate: 0.0 }, { min: 26050, max: 100000, rate: 0.0275 }, { min: 100000, max: INF, rate: 0.035 }], mfj: [{ min: 0, max: 26050, rate: 0.0 }, { min: 26050, max: 100000, rate: 0.0275 }, { min: 100000, max: INF, rate: 0.035 }] }, notes: ['First $26,050 exempt', 'Many cities have 1-2.5% income tax (Columbus 2.5%, Cleveland 2.5%)'] },\n  OK: { name: 'Oklahoma', type: 'progressive', standardDeduction: { single: 6350, mfj: 12700 }, personalExemption: { single: 1000, mfj: 2000 },\n    brackets: { single: [{ min: 0, max: 1000, rate: 0.0025 }, { min: 1000, max: 2500, rate: 0.0075 }, { min: 2500, max: 3750, rate: 0.0175 }, { min: 3750, max: 4900, rate: 0.0275 }, { min: 4900, max: 7200, rate: 0.0375 }, { min: 7200, max: INF, rate: 0.0475 }], mfj: [{ min: 0, max: 2000, rate: 0.0025 }, { min: 2000, max: 5000, rate: 0.0075 }, { min: 5000, max: 7500, rate: 0.0175 }, { min: 7500, max: 9800, rate: 0.0275 }, { min: 9800, max: 12200, rate: 0.0375 }, { min: 12200, max: INF, rate: 0.0475 }] }, notes: [] },\n  OR: { name: 'Oregon', type: 'progressive', standardDeduction: { single: 2745, mfj: 5495 }, personalExemption: { single: 236, mfj: 472 },\n    brackets: { single: [{ min: 0, max: 4050, rate: 0.0475 }, { min: 4050, max: 10200, rate: 0.0675 }, { min: 10200, max: 125000, rate: 0.0875 }, { min: 125000, max: INF, rate: 0.099 }], mfj: [{ min: 0, max: 8100, rate: 0.0475 }, { min: 8100, max: 20400, rate: 0.0675 }, { min: 20400, max: 250000, rate: 0.0875 }, { min: 250000, max: INF, rate: 0.099 }] }, notes: ['No sales tax but high income tax', 'Portland Metro tax adds 1% over $125K/$200K', 'Multnomah County adds 1.5% over $125K/$200K'] },\n  PA: { name: 'Pennsylvania', type: 'flat', standardDeduction: { single: 0, mfj: 0 }, personalExemption: { single: 0, mfj: 0 }, flatRate: 0.0307, brackets: { single: [{ min: 0, max: INF, rate: 0.0307 }], mfj: [{ min: 0, max: INF, rate: 0.0307 }] }, notes: ['Flat 3.07%', 'Philadelphia adds 3.75% wage tax for residents', 'Most municipalities have 1% earned income tax'] },\n  RI: { name: 'Rhode Island', type: 'progressive', standardDeduction: { single: 10550, mfj: 21150 }, personalExemption: { single: 4750, mfj: 9500 },\n    brackets: { single: [{ min: 0, max: 73450, rate: 0.0375 }, { min: 73450, max: 166950, rate: 0.0475 }, { min: 166950, max: INF, rate: 0.0599 }], mfj: [{ min: 0, max: 73450, rate: 0.0375 }, { min: 73450, max: 166950, rate: 0.0475 }, { min: 166950, max: INF, rate: 0.0599 }] }, notes: [] },\n  SC: { name: 'South Carolina', type: 'progressive', standardDeduction: { single: 14600, mfj: 29200 }, personalExemption: { single: 0, mfj: 0 },\n    brackets: { single: [{ min: 0, max: 3460, rate: 0.0 }, { min: 3460, max: 17330, rate: 0.03 }, { min: 17330, max: INF, rate: 0.064 }], mfj: [{ min: 0, max: 3460, rate: 0.0 }, { min: 3460, max: 17330, rate: 0.03 }, { min: 17330, max: INF, rate: 0.064 }] }, notes: ['Top rate declining to 6.2% by 2027'] },\n  SD: { name: 'South Dakota', type: 'none', standardDeduction: { single: 0, mfj: 0 }, personalExemption: { single: 0, mfj: 0 }, brackets: { single: [], mfj: [] }, notes: ['No state income tax'] },\n  TN: { name: 'Tennessee', type: 'none', standardDeduction: { single: 0, mfj: 0 }, personalExemption: { single: 0, mfj: 0 }, brackets: { single: [], mfj: [] }, notes: ['No state income tax (Hall tax on interest/dividends repealed 2021)'] },\n  TX: { name: 'Texas', type: 'none', standardDeduction: { single: 0, mfj: 0 }, personalExemption: { single: 0, mfj: 0 }, brackets: { single: [], mfj: [] }, notes: ['No state income tax', 'Franchise tax applies to businesses with >$2.47M revenue'] },\n  UT: { name: 'Utah', type: 'flat', standardDeduction: { single: 0, mfj: 0 }, personalExemption: { single: 0, mfj: 0 }, flatRate: 0.0465, brackets: { single: [{ min: 0, max: INF, rate: 0.0465 }], mfj: [{ min: 0, max: INF, rate: 0.0465 }] }, notes: ['4.65% flat rate', 'Taxpayer tax credit of 6% of federal personal exemption equivalent'] },\n  VT: { name: 'Vermont', type: 'progressive', standardDeduction: { single: 7000, mfj: 14050 }, personalExemption: { single: 4850, mfj: 9700 },\n    brackets: { single: [{ min: 0, max: 45400, rate: 0.0355 }, { min: 45400, max: 110050, rate: 0.068 }, { min: 110050, max: 229550, rate: 0.077 }, { min: 229550, max: INF, rate: 0.0875 }], mfj: [{ min: 0, max: 75850, rate: 0.0355 }, { min: 75850, max: 183400, rate: 0.068 }, { min: 183400, max: 279450, rate: 0.077 }, { min: 279450, max: INF, rate: 0.0875 }] }, notes: [] },\n  VA: { name: 'Virginia', type: 'progressive', standardDeduction: { single: 8000, mfj: 16000 }, personalExemption: { single: 930, mfj: 1860 },\n    brackets: { single: [{ min: 0, max: 3000, rate: 0.02 }, { min: 3000, max: 5000, rate: 0.03 }, { min: 5000, max: 17000, rate: 0.05 }, { min: 17000, max: INF, rate: 0.0575 }], mfj: [{ min: 0, max: 3000, rate: 0.02 }, { min: 3000, max: 5000, rate: 0.03 }, { min: 5000, max: 17000, rate: 0.05 }, { min: 17000, max: INF, rate: 0.0575 }] }, notes: [] },\n  WA: { name: 'Washington', type: 'none', standardDeduction: { single: 0, mfj: 0 }, personalExemption: { single: 0, mfj: 0 }, brackets: { single: [], mfj: [] }, notes: ['No state income tax', '7% capital gains tax on gains >$250K (legal challenges ongoing)'] },\n  WV: { name: 'West Virginia', type: 'progressive', standardDeduction: { single: 0, mfj: 0 }, personalExemption: { single: 2000, mfj: 4000 },\n    brackets: { single: [{ min: 0, max: 10000, rate: 0.0236 }, { min: 10000, max: 25000, rate: 0.0315 }, { min: 25000, max: 40000, rate: 0.0354 }, { min: 40000, max: 60000, rate: 0.0472 }, { min: 60000, max: INF, rate: 0.0512 }], mfj: [{ min: 0, max: 10000, rate: 0.0236 }, { min: 10000, max: 25000, rate: 0.0315 }, { min: 25000, max: 40000, rate: 0.0354 }, { min: 40000, max: 60000, rate: 0.0472 }, { min: 60000, max: INF, rate: 0.0512 }] }, notes: [] },\n  WI: { name: 'Wisconsin', type: 'progressive', standardDeduction: { single: 12760, mfj: 23620 }, personalExemption: { single: 700, mfj: 1400 },\n    brackets: { single: [{ min: 0, max: 14320, rate: 0.0354 }, { min: 14320, max: 28640, rate: 0.0465 }, { min: 28640, max: 315310, rate: 0.053 }, { min: 315310, max: INF, rate: 0.0765 }], mfj: [{ min: 0, max: 19090, rate: 0.0354 }, { min: 19090, max: 38190, rate: 0.0465 }, { min: 38190, max: 420420, rate: 0.053 }, { min: 420420, max: INF, rate: 0.0765 }] }, notes: [] },\n  WY: { name: 'Wyoming', type: 'none', standardDeduction: { single: 0, mfj: 0 }, personalExemption: { single: 0, mfj: 0 }, brackets: { single: [], mfj: [] }, notes: ['No state income tax'] },\n  DC: { name: 'District of Columbia', type: 'progressive', standardDeduction: { single: 14600, mfj: 29200 }, personalExemption: { single: 0, mfj: 0 },\n    brackets: { single: [{ min: 0, max: 10000, rate: 0.04 }, { min: 10000, max: 40000, rate: 0.06 }, { min: 40000, max: 60000, rate: 0.065 }, { min: 60000, max: 250000, rate: 0.085 }, { min: 250000, max: 500000, rate: 0.0925 }, { min: 500000, max: 1000000, rate: 0.0975 }, { min: 1000000, max: INF, rate: 0.1075 }], mfj: [{ min: 0, max: 10000, rate: 0.04 }, { min: 10000, max: 40000, rate: 0.06 }, { min: 40000, max: 60000, rate: 0.065 }, { min: 60000, max: 250000, rate: 0.085 }, { min: 250000, max: 500000, rate: 0.0925 }, { min: 500000, max: 1000000, rate: 0.0975 }, { min: 1000000, max: INF, rate: 0.1075 }] }, notes: [] },\n}\n\n// ─── Core Calculation ───────────────────────────────────────────────────────\n\nfunction calcBracketTax(income: number, brackets: Bracket[]): { tax: number; marginalRate: number } {\n  let tax = 0\n  let marginalRate = 0\n  let remaining = Math.max(0, income)\n\n  for (const bracket of brackets) {\n    const taxableInBracket = Math.min(remaining, bracket.max - bracket.min)\n    if (taxableInBracket <= 0) break\n    tax += taxableInBracket * bracket.rate\n    marginalRate = bracket.rate\n    remaining -= taxableInBracket\n  }\n\n  return { tax, marginalRate }\n}\n\nexport function calculateFullStateTax(\n  grossIncome: number,\n  stateCode: string,\n  filingStatus: 'single' | 'mfj' | 'mfs' | 'hoh' = 'single',\n  options?: {\n    includeLocal?: boolean\n    localCity?: string  // for NYC, Portland, etc.\n    itemizedDeductions?: number // if > standard deduction\n  }\n): StateTaxResult {\n  const config = STATES[stateCode.toUpperCase()]\n  if (!config) {\n    return {\n      stateCode, stateName: 'Unknown', taxableIncome: grossIncome,\n      stateTax: 0, effectiveRate: 0, marginalRate: 0,\n      localTax: 0, totalStateLocal: 0, hasCapGainsPreference: false, notes: ['State not found'],\n    }\n  }\n\n  if (config.type === 'none') {\n    return {\n      stateCode, stateName: config.name, taxableIncome: 0,\n      stateTax: 0, effectiveRate: 0, marginalRate: 0,\n      localTax: 0, totalStateLocal: 0, hasCapGainsPreference: false, notes: config.notes,\n    }\n  }\n\n  // Map filing status\n  const fs = (filingStatus === 'mfj' || filingStatus === 'mfs') ? 'mfj' : 'single'\n  // HoH typically uses single brackets in most states (simplified)\n  const bracketKey = fs === 'mfj' ? 'mfj' : 'single'\n\n  // Calculate taxable income\n  const stdDed = config.standardDeduction[bracketKey]\n  const persExempt = config.personalExemption[bracketKey]\n  const deduction = options?.itemizedDeductions && options.itemizedDeductions > stdDed\n    ? options.itemizedDeductions : stdDed\n  const taxableIncome = Math.max(0, grossIncome - deduction - persExempt)\n\n  // Calculate tax\n  const brackets = config.brackets[bracketKey]\n  const { tax, marginalRate } = calcBracketTax(taxableIncome, brackets)\n\n  // Local tax\n  let localTax = 0\n  let localName: string | undefined\n  if (options?.includeLocal && config.localSurtax) {\n    const localResult = config.localSurtax(taxableIncome)\n    localTax = typeof localResult === 'number' ? localResult : 0\n    localName = config.localName\n  }\n\n  const effectiveRate = grossIncome > 0 ? tax / grossIncome : 0\n  const totalStateLocal = tax + localTax\n\n  return {\n    stateCode: stateCode.toUpperCase(),\n    stateName: config.name,\n    taxableIncome,\n    stateTax: Math.round(tax),\n    effectiveRate: Math.round(effectiveRate * 10000) / 10000,\n    marginalRate,\n    localTax: Math.round(localTax),\n    localName,\n    totalStateLocal: Math.round(totalStateLocal),\n    hasCapGainsPreference: !!config.capGainsRate,\n    notes: config.notes,\n  }\n}\n\n// ─── State Comparison Tool ──────────────────────────────────────────────────\n\nexport function compareStateTaxes(\n  grossIncome: number,\n  filingStatus: 'single' | 'mfj' = 'single',\n  currentState?: string,\n): StateTaxResult[] {\n  const results = Object.keys(STATES).map(code =>\n    calculateFullStateTax(grossIncome, code, filingStatus, { includeLocal: false })\n  )\n  return results.sort((a, b) => a.totalStateLocal - b.totalStateLocal)\n}\n\n// ─── Exports for use by existing tax-calculator.ts ──────────────────────────\n\nexport function getStateMarginalRate(stateCode: string, taxableIncome: number, filingStatus: string = 'single'): number {\n  const result = calculateFullStateTax(taxableIncome, stateCode, filingStatus as any)\n  return result.marginalRate\n}\n\nexport function getStateEffectiveRate(stateCode: string, grossIncome: number, filingStatus: string = 'single'): number {\n  const result = calculateFullStateTax(grossIncome, stateCode, filingStatus as any)\n  return result.effectiveRate\n}\n\nexport function getStateNames(): Record<string, string> {\n  const names: Record<string, string> = {}\n  for (const [code, config] of Object.entries(STATES)) {\n    names[code] = config.name\n  }\n  return names\n}\n\nexport function getNoIncomeTaxStates(): string[] {\n  return Object.entries(STATES).filter(([_, c]) => c.type === 'none').map(([code]) => code)\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\stock-quotes.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\storage.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":130,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":130,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3903,3906],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3903,3906],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":130,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":130,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3911,3914],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3911,3914],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":131,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":131,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3933,3936],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3933,3936],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":132,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":132,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4006,4009],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4006,4009],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":133,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":133,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4043,4046],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4043,4046],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":134,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":134,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4080,4083],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4080,4083],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":135,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":135,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4117,4120],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4117,4120],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":136,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":136,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4154,4157],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4154,4157],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":152,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":152,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4713,4716],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4713,4716],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":154,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":154,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4823,4826],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4823,4826],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":174,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":174,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5455,5458],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5455,5458],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":175,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":175,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5494,5497],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5494,5497],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":184,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":184,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5737,5740],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5737,5740],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":201,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":201,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6190,6193],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6190,6193],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":206,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":206,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6362,6365],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6362,6365],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":210,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":210,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6449,6452],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6449,6452],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":214,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":214,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6550,6553],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6550,6553],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":218,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":218,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6631,6634],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6631,6634],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":220,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":220,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6701,6704],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6701,6704],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":226,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":226,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6845,6848],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6845,6848],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":229,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":229,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6961,6964],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6961,6964],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":234,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":234,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7045,7048],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7045,7048],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":238,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":238,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7127,7130],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7127,7130],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":240,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":240,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7199,7202],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7199,7202],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":244,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":244,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7319,7322],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7319,7322],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":284,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":284,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8462,8465],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8462,8465],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":451,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":451,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13846,13849],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13846,13849],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":716,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":716,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21834,21837],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21834,21837],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":717,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":717,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21913,21916],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21913,21916],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":718,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":718,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21984,21987],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21984,21987],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":719,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":719,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22062,22065],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22062,22065],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":742,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":742,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22708,22711],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22708,22711],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":843,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":843,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25601,25604],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25601,25604],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":846,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":846,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25700,25703],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25700,25703],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":34,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — Production Persistence Layer v7\n * \n * Dual-backend: localStorage (primary) + window.storage (fallback for Claude artifacts)\n * Schema versioning with automatic forward-migrations\n * UX preference persistence (sidebar, last view, theme)\n * Data export/import for backup & cross-device transfer\n */\n\n// ===================================================================\n//  SCHEMA VERSION — increment on ANY data shape change\n// ===================================================================\nconst SCHEMA_VERSION = 16\n\n// ===================================================================\n//  STORAGE KEYS\n// ===================================================================\nconst KEYS = {\n  FULL_STATE: 'fortuna:full-state',\n  UX_PREFS: 'fortuna:ux-prefs',\n  ADVISOR_HISTORY: 'fortuna:advisor-history',\n  FINANCIAL_HISTORY: 'fortuna:financial-history',\n  SCHEMA_VERSION: 'fortuna:schema-version',\n} as const\n\n// ===================================================================\n//  BACKEND ABSTRACTION\n// ===================================================================\n\ndeclare global {\n  interface Window {\n    storage?: {\n      get(key: string, shared?: boolean): Promise<{ key: string; value: string; shared: boolean } | null>\n      set(key: string, value: string, shared?: boolean): Promise<{ key: string; value: string; shared: boolean } | null>\n      delete(key: string, shared?: boolean): Promise<{ key: string; deleted: boolean; shared: boolean } | null>\n      list(prefix?: string, shared?: boolean): Promise<{ keys: string[]; prefix?: string; shared: boolean } | null>\n    }\n  }\n}\n\n/**\n * Tries localStorage first (works on Hostinger, any browser),\n * falls back to window.storage (Claude artifacts).\n * If both fail, returns fallback silently.\n */\nfunction getBackend(): 'localStorage' | 'windowStorage' | 'none' {\n  try {\n    const testKey = '__fortuna_storage_test__'\n    localStorage.setItem(testKey, '1')\n    localStorage.removeItem(testKey)\n    return 'localStorage'\n  } catch {\n    // localStorage unavailable\n  }\n  if (window.storage) return 'windowStorage'\n  return 'none'\n}\n\nasync function rawGet(key: string): Promise<string | null> {\n  const backend = getBackend()\n  if (backend === 'localStorage') {\n    return localStorage.getItem(key)\n  }\n  if (backend === 'windowStorage') {\n    try {\n      const result = await window.storage!.get(key)\n      return result?.value ?? null\n    } catch { return null }\n  }\n  return null\n}\n\nasync function rawSet(key: string, value: string): Promise<boolean> {\n  const backend = getBackend()\n  if (backend === 'localStorage') {\n    try {\n      localStorage.setItem(key, value)\n      return true\n    } catch { return false }\n  }\n  if (backend === 'windowStorage') {\n    try {\n      const result = await window.storage!.set(key, value)\n      return !!result\n    } catch { return false }\n  }\n  return false\n}\n\nasync function rawDelete(key: string): Promise<boolean> {\n  const backend = getBackend()\n  if (backend === 'localStorage') {\n    try {\n      localStorage.removeItem(key)\n      return true\n    } catch { return false }\n  }\n  if (backend === 'windowStorage') {\n    try {\n      const result = await window.storage!.delete(key)\n      return !!result?.deleted\n    } catch { return false }\n  }\n  return false\n}\n\n// Typed helpers\nasync function safeGet<T>(key: string, fallback: T): Promise<T> {\n  try {\n    const raw = await rawGet(key)\n    if (raw) return JSON.parse(raw) as T\n    return fallback\n  } catch {\n    return fallback\n  }\n}\n\nasync function safeSet<T>(key: string, value: T): Promise<boolean> {\n  try {\n    return await rawSet(key, JSON.stringify(value))\n  } catch {\n    return false\n  }\n}\n\n// ===================================================================\n//  SCHEMA MIGRATIONS\n// ===================================================================\n\nconst migrations: Record<number, (state: any) => any> = {\n  1: (state: any) => ({ ...state, strategies: state.strategies ?? [] }),\n  2: (state: any) => ({ ...state }),\n  3: (state: any) => ({ ...state }),\n  4: (state: any) => ({ ...state }),\n  5: (state: any) => ({ ...state }),\n  6: (state: any) => ({\n    ...state,\n    profile: {\n      name: '', state: 'IL', filingStatus: 'single',\n      dependents: 0, hasHealthInsurance: true, age: 35,\n      ...state.profile,\n    },\n    incomeStreams: state.incomeStreams ?? [],\n    expenses: state.expenses ?? [],\n    entities: state.entities ?? [],\n    deductions: state.deductions ?? [],\n    strategies: state.strategies ?? [],\n    onboardingComplete: state.onboardingComplete ?? false,\n    lastUpdated: state.lastUpdated ?? new Date().toISOString(),\n  }),\n  // v7 → v8: Financial history engine\n  7: (state: any) => ({ ...state }),\n  // v8 → v9: Unified Metamodel — household, attribution, orphaned types\n  8: (state: any) => {\n    // Build household from existing profile\n    const profile = state.profile || {}\n    const household = {\n      members: [{\n        id: 'primary',\n        name: profile.name || '',\n        role: 'primary',\n      }],\n      dependents: Array.from({ length: profile.dependents || 0 }, (_, i) => ({\n        id: `dep-${i + 1}`,\n        name: `Dependent ${i + 1}`,\n        relationship: 'child' as const,\n        dateOfBirth: '',\n        monthsLived: 12,\n      })),\n      filingStatus: profile.filingStatus || 'single',\n    }\n\n    // Backfill entityId='personal' on records that lack it\n    const backfillAttribution = (arr: any[]) =>\n      (arr || []).map((item: any) => ({\n        ...item,\n        entityId: item.entityId || 'personal',\n      }))\n\n    return {\n      ...state,\n      household,\n      taxYear: new Date().getFullYear(),\n      incomeStreams: backfillAttribution(state.incomeStreams).map((s: any) => ({\n        ...s,\n        isPrimary: s.isPrimary ?? false,\n        isTaxable: s.isTaxable ?? true\n      })),\n      expenses: backfillAttribution(state.expenses),\n      deductions: backfillAttribution(state.deductions),\n      depreciationAssets: [],\n      investments: [],\n      retirementAccounts: [],\n      goals: [],\n      documents: [],\n      bankTransactions: [],\n      estimatedPayments: [],\n      carryforwards: {},\n    }\n  },\n  9: (state: any) => ({\n    ...state,\n    realEstate: state.realEstate ?? [],\n    estatePlan: state.estatePlan ?? { trusts: [], directives: [], lifeInsurance: [] },\n  }),\n  10: (state: any) => ({\n    ...state,\n    liabilities: state.liabilities ?? [],\n  }),\n  11: (state: any) => ({\n    ...state,\n    equityCompensation: state.equityCompensation ?? [],\n  }),\n  12: (state: any) => ({\n    ...state,\n    receipts: state.receipts ?? [],\n  }),\n  13: (state: any) => ({\n    ...state,\n    receipts: (state.receipts || []).map((r: any) => ({\n      ...r,\n      paymentMethodId: r.paymentMethodId ?? null,\n      isRecurring: r.isRecurring ?? false,\n    }))\n  }),\n  14: (state: any) => ({\n    ...state,\n    intakeBatches: state.intakeBatches ?? [],\n    receipts: (state.receipts || []).map((r: any) => ({\n      ...r,\n      batchId: r.batchId ?? null\n    }))\n  }),\n  15: (state: any) => ({\n    ...state,\n    documents: state.documents ?? []\n  }),\n  16: (state: any) => ({\n    ...state,\n    documents: (state.documents || []).map((d: any) => ({\n      ...d,\n      batchId: d.batchId ?? null\n    })),\n    intakeBatches: (state.intakeBatches || []).map((b: any) => ({\n      ...b,\n      documentIds: b.documentIds ?? []\n    }))\n  }),\n}\n\nasync function migrateIfNeeded(state: FortunaState): Promise<FortunaState> {\n  let storedVersion = await safeGet<number>(KEYS.SCHEMA_VERSION, 0)\n  if (storedVersion === 0 && state.onboardingComplete) storedVersion = 1\n\n  let migrated = { ...state }\n  for (let v = storedVersion; v < SCHEMA_VERSION; v++) {\n    const fn = migrations[v]\n    if (fn) {\n      migrated = fn(migrated)\n      console.log(`[Fortuna] Migrated schema v${v} → v${v + 1}`)\n    }\n  }\n\n  if (storedVersion < SCHEMA_VERSION) {\n    await safeSet(KEYS.SCHEMA_VERSION, SCHEMA_VERSION)\n  }\n  return migrated\n}\n\n// ===================================================================\n//  UX PREFERENCES\n// ===================================================================\n\nexport interface UXPreferences {\n  sidebarCollapsed: boolean\n  lastActiveView: string\n  theme: 'dark' | 'light'\n  sidebarSections: Record<string, boolean>\n  lastSessionTimestamp: string\n  dataVersion: number\n  // Phase 1-2 UX additions\n  userMode?: 'beginner' | 'standard' | 'power'\n  friendlyLabels?: boolean\n  [key: string]: any // forward-compatible with future prefs\n}\n\nfunction createDefaultUXPrefs(): UXPreferences {\n  return {\n    sidebarCollapsed: false,\n    lastActiveView: 'dashboard',\n    theme: 'dark',\n    sidebarSections: {},\n    lastSessionTimestamp: new Date().toISOString(),\n    dataVersion: SCHEMA_VERSION,\n  }\n}\n\n// ===================================================================\n//  DATA TYPES — UNIFIED METAMODEL v9\n// ===================================================================\n\n// ─── Canonical Entity Type (used everywhere) ────────────────────────\n\nexport type EntityType =\n  | 'personal'    // Individual taxpayer (always exists, id='personal')\n  | 'sole_prop'   // Schedule C\n  | 'llc'         // Single-member LLC (disregarded, treated as sole prop)\n  | 'llc_scorp'   // LLC electing S-Corp treatment\n  | 'scorp'       // S-Corporation\n  | 'ccorp'       // C-Corporation\n  | 'partnership'  // Partnership / Multi-member LLC\n  | 'trust'        // Trust / Estate\n\nexport type FilingStatus = 'single' | 'married_joint' | 'married_separate' | 'head_of_household'\n\n// ─── Universal Attribution (mixed into every financial record) ───────\n\n/** Fields shared by all financial records for entity/person/year attribution */\nexport interface Attribution {\n  entityId?: string     // Which entity this belongs to. Default: 'personal'\n  memberId?: string     // Which household member. Default: primary filer\n  taxYear?: number      // Which tax year. Default: current year\n  tags?: string[]       // User-defined categorization\n  sourceId?: string     // Link to import source (CSV row, bank feed, etc.)\n}\n\n// ─── Household Model (supports joint filers) ────────────────────────\n\nexport interface HouseholdMember {\n  id: string            // 'primary' for main filer, 'spouse' for spouse\n  name: string\n  role: 'primary' | 'spouse'\n  dateOfBirth?: string\n  ssn?: string          // Optional, encrypted if stored\n}\n\nexport interface Dependent {\n  id: string\n  name: string\n  relationship: 'child' | 'stepchild' | 'foster' | 'sibling' | 'parent' | 'other'\n  dateOfBirth: string\n  monthsLived: number   // Months lived with filer (for custody situations)\n  isStudent?: boolean\n  isDisabled?: boolean\n  unearnedIncome?: number  // Investment/passive income (for kiddie tax)\n  earnedIncome?: number    // W-2/self-employment income\n  age: number              // Computed from dateOfBirth or manually set\n}\n\nexport interface Household {\n  members: HouseholdMember[]\n  dependents: Dependent[]\n  filingStatus: FilingStatus\n}\n\n// ─── Profile (backward-compat, household takes precedence) ──────────\n\nexport interface FinancialProfile {\n  name: string\n  state: string\n  filingStatus: FilingStatus\n  dependents: number\n  hasHealthInsurance: boolean\n  age: number\n}\n\n// ─── Core Financial Records ─────────────────────────────────────────\n\nexport interface IncomeStream extends Attribution {\n  id: string\n  name: string\n  type: 'business' | 'w2' | 'freelance' | 'investment' | 'rental' | 'passive' | 'other'\n  annualAmount: number\n  isActive: boolean\n  monthlyBreakdown?: number[]\n  notes?: string\n  isPrimary?: boolean // v9 addition\n  isTaxable?: boolean // v9 addition\n  // W-2 specific fields\n  w2?: {\n    employerName?: string\n    grossSalary?: number\n    federalWithholding?: number\n    stateWithholding?: number\n    ficaWithheld?: number\n    pretax401k?: number\n    pretaxHealthInsurance?: number\n    pretaxHSA?: number\n    employerMatch401k?: number\n    otherPretaxDeductions?: number\n  }\n  // S-Corp specific fields\n  scorp?: {\n    officerSalary?: number     // Reasonable salary for SE tax purposes\n    distributions?: number     // Remaining taken as distributions\n  }\n}\n\nexport interface BusinessExpense extends Attribution {\n  id: string\n  category: string\n  description: string\n  annualAmount: number\n  isDeductible: boolean\n  deductionPct: number\n}\n\nexport interface LegalEntity {\n  id: string\n  name: string\n  type: EntityType\n  state: string\n  einNumber?: string\n  formationDate?: string\n  annualCost: number\n  isActive: boolean\n  // Enhanced fields\n  ownershipPct?: number        // 0-100, your ownership percentage\n  parentEntityId?: string      // For subsidiary relationships\n  officerSalary?: number       // S-Corp reasonable salary\n  healthInsurancePremium?: number\n  retirementContrib?: number\n  linkedAccountIds?: string[]  // IDs of dedicated business accounts\n  notes?: string\n  // QBI fields\n  isSSTB?: boolean             // Specified Service Trade or Business (law, health, consulting, etc.)\n  w2WagesPaid?: number         // Total W-2 wages paid by this entity (for QBI limitation)\n  qualifiedPropertyUBIA?: number // Unadjusted basis of qualified property\n}\n\nexport interface DeductionRecord extends Attribution {\n  id: string\n  entityId: string // Which entity is claiming this (e.g. personal, sole_prop)\n  categoryId: string // e.g. supplies, travel, home_office\n  amount: number\n  description: string\n  date: string\n  status: 'planned' | 'realized' | 'rejected'\n  receiptId?: string\n}\n\nexport type DocumentType = 'receipt' | 'invoice' | 'tax_notice' | 'contract' | 'identity' | 'other' | 'not_applicable'\n\nexport interface DocumentRecord {\n  id: string\n  documentType: DocumentType\n  dateAdded: string\n  pages: string[] // array of blob URLs/references\n  pageThumbnails: string[] // array of low-res thumbnails\n  pageCount: number\n  metadata: Record<string, any>\n  entityId?: string\n  goalId?: string\n  status: 'pending' | 'processed' | 'needs_review' | 'rejected'\n  summary?: string\n  batchId?: string\n}\n\n// ─── Metamodel v13 Additions ──────────────────────────────────────\n\nexport interface RealEstateProperty extends Attribution {\n  id: string\n  address: string\n  type: 'primary_residence' | 'rental' | 'commercial' | 'land' | 'other'\n  purchasePrice: number\n  purchaseDate: string\n  currentValue: number\n  outstandingMortgage: number\n  annualPropertyTax: number\n  annualInsurance: number\n  monthlyRentalIncome?: number\n  is1031Eligible?: boolean\n}\n\nexport interface TrustEntity extends Attribution {\n  id: string\n  name: string\n  type: 'revocable' | 'irrevocable' | 'charitable' | 'special_needs' | 'other'\n  trustees: string[]\n  beneficiaries: string[]\n  assets: string[] // IDs of assets held in trust\n  isGrantor: boolean\n}\n\nexport interface EstateDirective {\n  id: string\n  type: 'will' | 'living_will' | 'power_of_attorney' | 'healthcare_proxy'\n  status: 'draft' | 'signed' | 'notarized'\n  lastUpdated: string\n  fileUrl?: string\n}\n\nexport interface LifeInsurancePolicy extends Attribution {\n  id: string\n  provider: string\n  policyType: 'term' | 'whole' | 'universal' | 'variable'\n  deathBenefit: number\n  annualPremium: number\n  beneficiaries: string[]\n  cashValue?: number\n  expirationDate?: string\n}\n\nexport interface EstatePlan {\n  trusts: TrustEntity[]\n  directives: EstateDirective[]\n  lifeInsurance: LifeInsurancePolicy[]\n}\n\nexport interface Liability extends Attribution {\n  id: string\n  name: string\n  type: 'mortgage' | 'student_loan' | 'auto_loan' | 'credit_card' | 'business_loan' | 'margin' | 'other'\n  principalBalance: number\n  interestRate: number\n  minimumMonthlyPayment: number\n  termMonths?: number\n  isInterestTaxDeductible?: boolean\n}\n\nexport interface EquityCompensation extends Attribution {\n  id: string\n  companyName: string\n  grantType: 'iso' | 'nso' | 'rsu' | 'espp' | 'founder_stock'\n  grantDate: string\n  totalSharesGranted: number\n  vestingSchedule: 'standard_4yr_1yr_cliff' | 'custom' | 'immediate'\n  vestedShares: number\n  unvestedShares: number\n  strikePrice?: number\n  currentFairMarketValue: number\n  has83bElection?: boolean\n  expirationDate?: string\n}\n\nexport interface ReceiptItem {\n  id: string\n  description: string\n  amount: number\n  quantity: number\n  inferredCategory: string\n  allocatedEntityId?: string // 'personal' or specific LegalEntity.id\n  confidenceScore: number    // 0-1 for AI assignment\n  isBusiness?: boolean       // Explicit override flag\n  status?: 'scanned' | 'processing' | 'allocated' | 'needs_review'\n}\n\nexport interface ReceiptRecord extends Attribution {\n  id: string\n  merchantName: string\n  date: string\n  totalAmount: number\n  taxAmount?: number\n  tipAmount?: number\n  items: ReceiptItem[]\n  imageUrl?: string\n  status: 'scanned' | 'processing' | 'allocated' | 'needs_review'\n  splitStrategy?: 'itemized' | 'proportional' | 'manual'\n  paymentMethodId?: string // Link to account/card\n  isRecurring?: boolean   // Subscription flag\n  batchId?: string        // Link to IntakeBatch\n  thumbnail?: string      // low-res base64\n}\n\nexport interface IntakeBatch extends Attribution {\n  id: string\n  name: string\n  dateStarted: string\n  dateCompleted?: string\n  status: 'uploading' | 'processing' | 'completed' | 'failed'\n  totalCount: number\n  successCount: number\n  errorCount: number\n  receiptIds: string[]\n  documentIds: string[]\n  progress: number // 0-100\n  defaultEntityId?: string // Override for all receipts in batch\n}\n\n// ─── Previously Orphaned Types (now persisted in FortunaState) ──────\n\nexport interface DepreciationAsset extends Attribution {\n  id: string\n  name: string\n  category: 'equipment' | 'vehicle' | 'furniture' | 'computer' | 'building' | 'improvement' | 'other'\n  purchaseDate: string\n  purchasePrice: number\n  method: 'straight_line' | 'macrs' | 'section_179' | 'bonus'\n  usefulLifeYears: number\n  businessUsePct: number       // 0-100\n  salvageValue?: number\n  accumulatedDepreciation?: number\n  isActive: boolean\n}\n\nexport interface InvestmentPosition extends Attribution {\n  id: string\n  symbol: string\n  name: string\n  type: 'stock' | 'etf' | 'mutual_fund' | 'bond' | 'crypto' | 'real_estate' | 'other'\n  quantity: number\n  costBasis: number\n  currentValue?: number\n  acquisitionDate: string\n  isLongTerm?: boolean         // Computed from acquisitionDate, but cacheable\n  accountType?: 'taxable' | 'traditional_ira' | 'roth_ira' | '401k' | 'hsa' | 'other'\n}\n\nexport interface RetirementAccount extends Attribution {\n  id: string\n  name: string\n  type: 'traditional_401k' | 'roth_401k' | 'solo_401k' | 'sep_ira' | 'simple_ira' | 'traditional_ira' | 'roth_ira' | 'hsa' | 'pension' | 'other'\n  balance: number\n  annualContribution: number\n  employerMatch?: number       // Employer match amount\n  maxContribution: number      // Annual limit\n  isTaxDeductible: boolean\n}\n\nexport interface FinancialGoal extends Attribution {\n  id: string\n  title: string\n  type: 'tax_reduction' | 'savings' | 'retirement' | 'debt_payoff' | 'investment' | 'income_growth' | 'entity_setup' | 'other'\n  targetAmount?: number\n  currentAmount?: number\n  targetDate?: string\n  priority: 'high' | 'medium' | 'low'\n  status: 'active' | 'completed' | 'paused'\n  notes?: string\n}\n\nexport interface EstimatedPayment extends Attribution {\n  id: string\n  taxYear?: number              // Tax year this payment covers\n  quarter: 1 | 2 | 3 | 4\n  dueDate: string\n  amount: number\n  paidDate?: string\n  paidAmount?: number\n  jurisdiction: 'federal' | string  // 'federal' or state code\n}\n\nexport interface BankTransaction extends Attribution {\n  id: string\n  date: string\n  description: string\n  amount: number               // Positive = income, negative = expense\n  category?: string\n  isReconciled: boolean\n  linkedExpenseId?: string     // Link to BusinessExpense if categorized\n  linkedIncomeId?: string      // Link to IncomeStream if categorized\n  accountName?: string\n}\n\nexport interface Carryforwards {\n  capitalLoss?: number         // Remaining capital loss carryforward\n  netOperatingLoss?: number    // NOL carryforward\n  charitableContributions?: number  // Excess charitable carryforward (5 years)\n  foreignTaxCredit?: number\n  generalBusinessCredit?: number\n  passiveActivityLoss?: number\n  [key: string]: number | undefined  // Forward-compatible\n}\n\n// ─── Strategy & Advisor ─────────────────────────────────────────────\n\nexport interface StrategyRecord {\n  id: string\n  title: string\n  status: 'identified' | 'recommended' | 'in_progress' | 'implemented' | 'dismissed'\n  category: 'tax' | 'entity' | 'revenue' | 'risk' | 'investment'\n  estimatedImpact: number\n  implementedDate?: string\n  notes?: string\n  entityId?: string            // Which entity this strategy applies to\n}\n\nexport interface AdvisorMessage {\n  role: 'user' | 'assistant'\n  content: string\n  timestamp: string\n}\n\n// ─── FortunaState: The Unified Root ─────────────────────────────────\n\nexport interface FortunaState {\n  profile: FinancialProfile\n  incomeStreams: IncomeStream[]\n  expenses: BusinessExpense[]\n  entities: LegalEntity[]\n  deductions: DeductionRecord[] // Changed from Deduction to DeductionRecord\n  strategies: StrategyRecord[]\n  lastUpdated: string\n  onboardingComplete: boolean\n\n  household: Household\n  taxYear: number\n  depreciationAssets: DepreciationAsset[]\n  investmentPortfolio: InvestmentPosition[]\n  retirementAccounts: RetirementAccount[]\n  goals: FinancialGoal[]\n  documents: DocumentRecord[] // Changed from DocumentRecord (Attribution) to new DocumentRecord\n  auditHistory: BankTransaction[] // Renamed from bankTransactions\n  estimatedPayments: EstimatedPayment[]\n  carryforwards: Carryforwards\n\n  // v13 Additions\n  realEstate: RealEstateProperty[]\n  estatePlan: EstatePlan\n  liabilities: Liability[]\n  equityCompensation: EquityCompensation[]\n  receipts: ReceiptRecord[]\n  intakeBatches: IntakeBatch[]\n\n  // Cross-view persistence\n  portfolioOpportunities: any[]  // OpportunityAnalysis from PortfolioIntelligence\n  portfolioTaxEvents: any[]      // TaxEvent from PortfolioIntelligence\n  scenarioSnapshots: any[]       // Saved scenario comparisons from ScenarioModeler\n  aiDocuments: any[]             // AI-generated documents from DocumentCenter\n\n  // UX preferences (moved from separate storage)\n  ux: {\n    sidebarCollapsed: boolean\n    activeView: string\n    theme: 'light' | 'dark' | 'auto'\n    lastSaved: string\n  }\n}\n\n// ===================================================================\n//  EXPORT / IMPORT FORMAT\n// ===================================================================\n\nexport interface FortunaExport {\n  _format: 'fortuna-engine-export'\n  _version: number\n  _exportedAt: string\n  _appVersion: string\n  state: FortunaState\n  advisorHistory: AdvisorMessage[]\n  uxPrefs: UXPreferences\n  financialHistory?: any\n}\n\nconst APP_VERSION = '10.3.0'\n\n// ===================================================================\n//  DEFAULT STATE FACTORY\n// ===================================================================\n\nexport function createDefaultState(): FortunaState {\n  return {\n    profile: {\n      name: '', state: 'IL', filingStatus: 'single',\n      dependents: 0, hasHealthInsurance: true, age: 35,\n    },\n    household: {\n      members: [{ id: 'primary', name: '', role: 'primary' }],\n      dependents: [],\n      filingStatus: 'single',\n    },\n    taxYear: new Date().getFullYear(),\n    incomeStreams: [],\n    expenses: [],\n    entities: [],\n    deductions: [],\n    strategies: [],\n    depreciationAssets: [],\n    investmentPortfolio: [],\n    retirementAccounts: [],\n    goals: [],\n    documents: [],\n    auditHistory: [], // Renamed from bankTransactions\n    estimatedPayments: [],\n    carryforwards: {},\n\n    // v13 Additions\n    realEstate: [],\n    estatePlan: { trusts: [], directives: [], lifeInsurance: [] },\n    liabilities: [],\n    equityCompensation: [],\n    receipts: [],\n    intakeBatches: [],\n\n    portfolioOpportunities: [],\n    portfolioTaxEvents: [],\n    scenarioSnapshots: [],\n    aiDocuments: [],\n    ux: {\n      sidebarCollapsed: false,\n      activeView: 'dashboard',\n      theme: 'auto',\n      lastSaved: new Date().toISOString(),\n    },\n    lastUpdated: new Date().toISOString(),\n    onboardingComplete: false,\n  }\n}\n\n// ===================================================================\n//  PUBLIC API\n// ===================================================================\n\nexport const Storage = {\n  keys: KEYS,\n  schemaVersion: SCHEMA_VERSION,\n  appVersion: APP_VERSION,\n\n  getBackendName: getBackend,\n  isAvailable: () => getBackend() !== 'none',\n\n  // ---- Full State ----\n  async getFullState(): Promise<FortunaState> {\n    const raw = await safeGet<FortunaState>(KEYS.FULL_STATE, createDefaultState())\n    return migrateIfNeeded(raw)\n  },\n  async saveFullState(state: FortunaState): Promise<boolean> {\n    return safeSet(KEYS.FULL_STATE, state)\n  },\n\n  // ---- UX Preferences ----\n  async getUXPrefs(): Promise<UXPreferences> {\n    const prefs = await safeGet<UXPreferences>(KEYS.UX_PREFS, createDefaultUXPrefs())\n    return { ...createDefaultUXPrefs(), ...prefs }\n  },\n  async saveUXPrefs(prefs: UXPreferences): Promise<boolean> {\n    return safeSet(KEYS.UX_PREFS, {\n      ...prefs,\n      lastSessionTimestamp: new Date().toISOString(),\n      dataVersion: SCHEMA_VERSION,\n    })\n  },\n\n  // ---- Advisor History ----\n  async getAdvisorHistory(): Promise<AdvisorMessage[]> {\n    return safeGet<AdvisorMessage[]>(KEYS.ADVISOR_HISTORY, [])\n  },\n  async saveAdvisorHistory(messages: AdvisorMessage[]): Promise<boolean> {\n    return safeSet(KEYS.ADVISOR_HISTORY, messages.slice(-50))\n  },\n\n  // ---- Financial History (snapshots) ----\n  async getFinancialHistory(): Promise<any> {\n    return safeGet(KEYS.FINANCIAL_HISTORY, null)\n  },\n  async saveFinancialHistory(history: any): Promise<boolean> {\n    return safeSet(KEYS.FINANCIAL_HISTORY, history)\n  },\n\n  // ---- Export / Import ----\n  async exportAll(): Promise<FortunaExport> {\n    const [state, advisorHistory, uxPrefs, financialHistory] = await Promise.all([\n      Storage.getFullState(),\n      Storage.getAdvisorHistory(),\n      Storage.getUXPrefs(),\n      Storage.getFinancialHistory(),\n    ])\n    return {\n      _format: 'fortuna-engine-export',\n      _version: SCHEMA_VERSION,\n      _exportedAt: new Date().toISOString(),\n      _appVersion: APP_VERSION,\n      state, advisorHistory, uxPrefs,\n      financialHistory: financialHistory ?? undefined,\n    }\n  },\n\n  async importAll(data: FortunaExport): Promise<{ success: boolean; error?: string }> {\n    if (!data || data._format !== 'fortuna-engine-export') {\n      return { success: false, error: 'Invalid file format. Expected a Fortuna Engine export.' }\n    }\n    if (!data.state?.profile) {\n      return { success: false, error: 'Export file is corrupted — missing state data.' }\n    }\n    try {\n      let state = data.state\n      if (data._version && data._version < SCHEMA_VERSION) {\n        await safeSet(KEYS.SCHEMA_VERSION, data._version)\n        state = await migrateIfNeeded(state)\n      }\n      await Storage.saveFullState(state)\n      if (data.advisorHistory) await Storage.saveAdvisorHistory(data.advisorHistory)\n      if (data.uxPrefs) await Storage.saveUXPrefs({ ...createDefaultUXPrefs(), ...data.uxPrefs })\n      if (data.financialHistory) await Storage.saveFinancialHistory(data.financialHistory)\n      await safeSet(KEYS.SCHEMA_VERSION, SCHEMA_VERSION)\n      return { success: true }\n    } catch (e) {\n      return { success: false, error: `Import failed: ${e instanceof Error ? e.message : 'unknown'}` }\n    }\n  },\n\n  validateExport(json: string): { valid: boolean; data?: FortunaExport; error?: string } {\n    try {\n      const data = JSON.parse(json)\n      if (data._format !== 'fortuna-engine-export') return { valid: false, error: 'Not a Fortuna export' }\n      if (!data.state?.profile) return { valid: false, error: 'Missing profile data' }\n      return { valid: true, data }\n    } catch {\n      return { valid: false, error: 'Invalid JSON' }\n    }\n  },\n\n  // ---- Reset ----\n  async clearAll(): Promise<void> {\n    await Promise.all(Object.values(KEYS).map(k => rawDelete(k)))\n  },\n\n  // ---- Storage diagnostics ----\n  async estimateSize(): Promise<{ bytes: number; formatted: string }> {\n    let totalBytes = 0\n    if (getBackend() === 'localStorage') {\n      for (const key of Object.values(KEYS)) {\n        const val = localStorage.getItem(key)\n        if (val) totalBytes += key.length + val.length\n      }\n    } else {\n      const state = await Storage.getFullState()\n      totalBytes = JSON.stringify(state).length\n    }\n    const formatted = totalBytes < 1024 ? `${totalBytes} B`\n      : totalBytes < 1048576 ? `${(totalBytes / 1024).toFixed(1)} KB`\n      : `${(totalBytes / 1048576).toFixed(2)} MB`\n    return { bytes: totalBytes, formatted }\n  },\n}\n\n// ===================================================================\n//  UTILITIES\n// ===================================================================\n\nexport function genId(): string {\n  return Math.random().toString(36).substring(2, 10)\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\strategy-detector.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TaxReport' is defined but never used.","line":10,"column":47,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":56,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TaxReport"},"fix":{"range":[366,382],"text":""},"desc":"Remove unused variable \"TaxReport\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'profile' is assigned a value but never used.","line":307,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":307,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'strategies' is assigned a value but never used.","line":410,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":410,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'deductions' is assigned a value but never used.","line":412,"column":36,"nodeType":"Identifier","messageId":"unusedVar","endLine":412,"endColumn":46}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine - Strategy Detector\n * Autonomously analyzes financial state and identifies optimization opportunities\n */\n\nimport type { FortunaState } from './storage'\nimport { hasPortfolioData, getPortfolioStrategies } from './portfolio-bridge'\nimport {\n  generateTaxReport, calculateSCorpSavings, calculateMaxSEPIRA,\n  calculateMaxSolo401k, STATE_TAX_RATES, type TaxReport\n} from './tax-calculator'\n\nexport interface DetectedStrategy {\n  id: string\n  title: string\n  category: 'tax' | 'entity' | 'revenue' | 'risk' | 'investment' | 'deduction'\n  priority: 'critical' | 'high' | 'medium' | 'low'\n  estimatedImpact: number // annual dollars\n  impactLabel: string\n  description: string\n  reasoning: string\n  steps: string[]\n  risk: 'none' | 'low' | 'medium' | 'high'\n  timeline: string\n  prerequisites: string[]\n  automatable: boolean\n}\n\nexport interface RiskItem {\n  id: string\n  name: string\n  severity: 'critical' | 'high' | 'medium' | 'low'\n  score: number // 0-100\n  description: string\n  mitigation: string\n  category: string\n  actionable: boolean\n}\n\nexport interface FinancialHealthScore {\n  overall: number\n  components: {\n    taxEfficiency: number\n    entityOptimization: number\n    incomeGrowth: number\n    riskProtection: number\n    retirementReadiness: number\n    diversification: number\n  }\n  grade: string\n}\n\n// ==================== Strategy Detection ====================\n\nexport function detectStrategies(state: FortunaState): DetectedStrategy[] {\n  const strategies: DetectedStrategy[] = []\n  const report = generateTaxReport(state)\n  const { profile, incomeStreams, expenses, deductions, entities } = state\n\n  const netSEIncome = incomeStreams\n    .filter(s => ['business', 'freelance'].includes(s.type) && s.isActive)\n    .reduce((sum, s) => sum + s.annualAmount, 0) -\n    expenses.filter(e => e.isDeductible).reduce((sum, e) => sum + (e.annualAmount * e.deductionPct / 100), 0)\n\n  // 1. S-Corp Election\n  const hasScorp = entities.some(e => (e.type === 'llc_scorp' || e.type === 'scorp') && e.isActive)\n  if (!hasScorp && netSEIncome > 50000) {\n    const reasonableSalary = Math.round(Math.max(netSEIncome * 0.5, Math.min(netSEIncome * 0.7, 80000)))\n    const savings = calculateSCorpSavings(netSEIncome, reasonableSalary)\n\n    if (savings.savings > 2000) {\n      strategies.push({\n        id: 'scorp-election',\n        title: 'S-Corp Election',\n        category: 'entity',\n        priority: savings.savings > 5000 ? 'critical' : 'high',\n        estimatedImpact: savings.savings,\n        impactLabel: `$${savings.savings.toLocaleString()}/yr`,\n        description: `Your self-employment income of $${netSEIncome.toLocaleString()} makes you an excellent candidate for S-Corp election. Pay yourself a reasonable salary of ~$${reasonableSalary.toLocaleString()} and take $${savings.distributionAmount.toLocaleString()} as distributions to avoid SE tax on that portion.`,\n        reasoning: `Current SE tax: $${savings.currentSETax.toLocaleString()}. After S-Corp: $${savings.sCorpSETax.toLocaleString()}. Net savings: $${savings.savings.toLocaleString()}/year.`,\n        steps: [\n          'Form LLC in your state (if not already formed)',\n          'File Form 2553 with the IRS to elect S-Corp status',\n          'Set up payroll service for reasonable salary payments',\n          'Establish quarterly distribution schedule',\n          'Adjust quarterly estimated tax payments',\n        ],\n        risk: 'low',\n        timeline: '30-60 days',\n        prerequisites: ['EIN number', 'LLC formation (or convert existing entity)'],\n        automatable: false,\n      })\n    }\n  }\n\n  // 2. SEP-IRA / Solo 401(k) Maximization\n  if (netSEIncome > 20000) {\n    const maxSEP = calculateMaxSEPIRA(netSEIncome)\n    const solo401k = calculateMaxSolo401k(netSEIncome, profile.age)\n    const currentRetirement = deductions\n      .filter(d => d.category === 'retirement')\n      .reduce((sum, d) => sum + d.amount, 0)\n\n    const bestRetirement = Math.max(maxSEP, solo401k.totalMax)\n    const gap = bestRetirement - currentRetirement\n\n    if (gap > 3000) {\n      const taxSavings = Math.round(gap * report.marginalRate)\n      const useSolo = solo401k.totalMax > maxSEP\n\n      strategies.push({\n        id: 'retirement-max',\n        title: useSolo ? 'Solo 401(k) Maximization' : 'SEP-IRA Maximization',\n        category: 'tax',\n        priority: gap > 10000 ? 'high' : 'medium',\n        estimatedImpact: taxSavings,\n        impactLabel: `$${gap.toLocaleString()} deferral ($${taxSavings.toLocaleString()} tax savings)`,\n        description: `You're contributing $${currentRetirement.toLocaleString()} of a possible $${bestRetirement.toLocaleString()} to retirement accounts. The remaining $${gap.toLocaleString()} in contributions would reduce your taxable income and save $${taxSavings.toLocaleString()} in taxes this year.`,\n        reasoning: `Max ${useSolo ? 'Solo 401(k)' : 'SEP-IRA'}: $${bestRetirement.toLocaleString()}. Current: $${currentRetirement.toLocaleString()}. Gap: $${gap.toLocaleString()}. At ${(report.marginalRate * 100).toFixed(0)}% marginal rate = $${taxSavings.toLocaleString()} saved.`,\n        steps: [\n          `Open/verify ${useSolo ? 'Solo 401(k)' : 'SEP-IRA'} account`,\n          `Calculate exact maximum contribution: $${bestRetirement.toLocaleString()}`,\n          'Make contribution before tax filing deadline (including extensions)',\n          useSolo ? 'Set up employee + employer contribution schedule' : 'Single annual contribution before deadline',\n        ],\n        risk: 'none',\n        timeline: 'Immediate',\n        prerequisites: [useSolo ? 'Solo 401(k) account' : 'SEP-IRA account'],\n        automatable: true,\n      })\n    }\n  }\n\n  // 3. QBI Deduction Optimization\n  if (netSEIncome > 30000 && !hasScorp) {\n    const qbiAmount = Math.round(netSEIncome * 0.20)\n    const isNearPhaseout = report.agi > 150000\n\n    if (qbiAmount > 5000) {\n      strategies.push({\n        id: 'qbi-optimization',\n        title: 'Section 199A QBI Deduction',\n        category: 'tax',\n        priority: isNearPhaseout ? 'high' : 'medium',\n        estimatedImpact: Math.round(qbiAmount * report.marginalRate),\n        impactLabel: `Up to $${qbiAmount.toLocaleString()} deduction`,\n        description: `Your qualifying business income of $${netSEIncome.toLocaleString()} entitles you to a 20% QBI deduction of up to $${qbiAmount.toLocaleString()}. ${isNearPhaseout ? 'Warning: You are approaching the phase-out threshold. Consider strategies to stay under the limit.' : 'You are well below the phase-out threshold.'}`,\n        reasoning: `QBI = 20% × $${netSEIncome.toLocaleString()} = $${qbiAmount.toLocaleString()}. Tax savings at ${(report.marginalRate * 100).toFixed(0)}% marginal rate: $${Math.round(qbiAmount * report.marginalRate).toLocaleString()}.`,\n        steps: [\n          'Ensure all qualifying business income is properly classified',\n          'Verify no specified service trade or business (SSTB) issues',\n          isNearPhaseout ? 'Consider deferring income or accelerating deductions to stay below phase-out' : 'Maintain income below phase-out thresholds',\n          'Coordinate with entity structure for maximum benefit',\n        ],\n        risk: 'none',\n        timeline: 'Tax filing',\n        prerequisites: [],\n        automatable: true,\n      })\n    }\n  }\n\n  // 4. Home Office Deduction\n  const hasHomeOffice = deductions.some(d => d.category === 'home_office')\n  if (netSEIncome > 10000 && !hasHomeOffice) {\n    strategies.push({\n      id: 'home-office',\n      title: 'Home Office Deduction',\n      category: 'deduction',\n      priority: 'medium',\n      estimatedImpact: Math.round(3000 * report.marginalRate),\n      impactLabel: `$1,500-5,000+ deduction`,\n      description: 'No home office deduction detected. If you use a dedicated space for business, you can deduct a proportional share of housing costs (mortgage/rent, utilities, insurance, repairs) or use the simplified method ($5/sqft, max 300 sqft = $1,500).',\n      reasoning: 'Actual expense method typically yields higher deductions than simplified method for dedicated home offices. Average deduction: $3,000-5,000/year.',\n      steps: [\n        'Measure dedicated office space (must be exclusive and regular use)',\n        'Calculate total housing costs eligible for allocation',\n        'Compare simplified ($5/sqft) vs actual expense method',\n        'Photograph space and maintain documentation',\n      ],\n      risk: 'low',\n      timeline: '1-2 weeks',\n      prerequisites: ['Dedicated home office space'],\n      automatable: true,\n    })\n  }\n\n  // 5. LLC Formation (liability protection)\n  const hasLLC = entities.some(e => ['llc', 'llc_scorp', 'scorp', 'ccorp'].includes(e.type) && e.isActive)\n  if (!hasLLC && report.grossIncome > 30000) {\n    strategies.push({\n      id: 'llc-formation',\n      title: 'LLC Formation for Liability Protection',\n      category: 'entity',\n      priority: report.grossIncome > 100000 ? 'critical' : 'high',\n      estimatedImpact: 0, // Protection value, not direct savings\n      impactLabel: 'Personal asset protection',\n      description: 'You are currently operating without a legal entity, exposing all personal assets to business liabilities. An LLC creates a legal separation between personal and business assets.',\n      reasoning: `With gross income of $${report.grossIncome.toLocaleString()}, the risk exposure is significant. LLC formation costs are minimal ($75-800 depending on state) and provide essential protection.`,\n      steps: [\n        `File Articles of Organization in ${STATE_TAX_RATES[profile.state]?.name || profile.state}`,\n        'Obtain EIN from the IRS (free, instant online)',\n        'Open separate business bank account',\n        'Create operating agreement',\n        'Separate business and personal finances completely',\n      ],\n      risk: 'none',\n      timeline: '1-2 weeks',\n      prerequisites: [],\n      automatable: false,\n    })\n  }\n\n  // 6. Income diversification\n  const activeStreams = incomeStreams.filter(s => s.isActive)\n  if (activeStreams.length > 0) {\n    const maxStream = Math.max(...activeStreams.map(s => s.annualAmount))\n    const concentration = maxStream / report.grossIncome\n\n    if (concentration > 0.6) {\n      strategies.push({\n        id: 'diversification',\n        title: 'Income Stream Diversification',\n        category: 'revenue',\n        priority: concentration > 0.8 ? 'high' : 'medium',\n        estimatedImpact: Math.round(report.grossIncome * 0.15),\n        impactLabel: `Reduce ${(concentration * 100).toFixed(0)}% concentration risk`,\n        description: `${(concentration * 100).toFixed(0)}% of your income comes from a single source. This creates significant vulnerability. Diversifying into 2-3 additional streams could reduce risk while growing total revenue.`,\n        reasoning: `Best practice is <50% from any single source. Current: ${(concentration * 100).toFixed(0)}%. Target additional streams to reach healthy diversification.`,\n        steps: [\n          'Identify 2-3 revenue opportunities aligned with existing skills',\n          'Prioritize low-effort, high-confidence opportunities first',\n          'Set 90-day targets for each new stream',\n          'Reinvest initial revenue into stream growth',\n        ],\n        risk: 'none',\n        timeline: '1-3 months',\n        prerequisites: [],\n        automatable: false,\n      })\n    }\n  }\n\n  // 7. Vehicle deduction\n  const hasVehicle = deductions.some(d => d.category === 'vehicle')\n  if (netSEIncome > 20000 && !hasVehicle) {\n    strategies.push({\n      id: 'vehicle-deduction',\n      title: 'Business Vehicle Deduction',\n      category: 'deduction',\n      priority: 'low',\n      estimatedImpact: Math.round(2000 * report.marginalRate),\n      impactLabel: '$1,000-4,000+ deduction',\n      description: 'If you use a personal vehicle for business purposes, you can deduct mileage at $0.67/mile (2024) or actual expenses. Common business uses include client meetings, supply runs, and business errands.',\n      reasoning: 'Average self-employed vehicle deduction: $2,000-4,000/year. IRS standard mileage rate for 2024: $0.67/mile.',\n      steps: [\n        'Begin tracking all business miles (MileIQ app recommended)',\n        'Maintain a contemporaneous mileage log',\n        'Compare standard mileage vs actual expense method',\n        'Keep all fuel, maintenance, and insurance receipts',\n      ],\n      risk: 'none',\n      timeline: 'Start immediately',\n      prerequisites: ['Vehicle used for business'],\n      automatable: true,\n    })\n  }\n\n  // ── Portfolio Intelligence strategies ────────────────────────────\n  if (hasPortfolioData()) {\n    const portfolioStrats = getPortfolioStrategies(report.marginalRate)\n    for (const ps of portfolioStrats) {\n      strategies.push({\n        id: ps.id,\n        title: ps.title,\n        category: ps.category as DetectedStrategy['category'],\n        priority: ps.priority,\n        estimatedImpact: ps.impact,\n        impactLabel: ps.impact > 0 ? `$${ps.impact.toLocaleString()}/year` : 'Risk reduction',\n        description: ps.description,\n        reasoning: ps.description,\n        steps: ps.steps,\n        risk: 'low',\n        timeline: 'This quarter',\n        prerequisites: [],\n        automatable: false,\n      })\n    }\n  }\n\n  // Sort by priority then impact\n  const priorityOrder: Record<string, number> = { critical: 0, high: 1, medium: 2, low: 3 }\n  strategies.sort((a, b) => {\n    const pDiff = priorityOrder[a.priority] - priorityOrder[b.priority]\n    if (pDiff !== 0) return pDiff\n    return b.estimatedImpact - a.estimatedImpact\n  })\n\n  return strategies\n}\n\n// ==================== Risk Analysis ====================\n\nexport function analyzeRisks(state: FortunaState): RiskItem[] {\n  const risks: RiskItem[] = []\n  const report = generateTaxReport(state)\n  const { profile, incomeStreams, entities, deductions, expenses } = state\n\n  const activeStreams = incomeStreams.filter(s => s.isActive)\n  const hasLLC = entities.some(e => ['llc', 'llc_scorp', 'scorp', 'ccorp'].includes(e.type) && e.isActive)\n\n  // Income concentration\n  if (activeStreams.length > 0) {\n    const maxStream = Math.max(...activeStreams.map(s => s.annualAmount))\n    const concentration = report.grossIncome > 0 ? maxStream / report.grossIncome : 0\n    if (concentration > 0.5) {\n      risks.push({\n        id: 'income-concentration',\n        name: 'Income Concentration',\n        severity: concentration > 0.8 ? 'critical' : concentration > 0.6 ? 'high' : 'medium',\n        score: Math.round(concentration * 100),\n        description: `${(concentration * 100).toFixed(0)}% of income from single source. Loss would be catastrophic.`,\n        mitigation: 'Diversify into 2-3 additional revenue streams. Target <50% from any single source.',\n        category: 'Revenue',\n        actionable: true,\n      })\n    }\n  }\n\n  // Liability exposure\n  if (!hasLLC && report.grossIncome > 20000) {\n    risks.push({\n      id: 'liability',\n      name: 'Personal Liability Exposure',\n      severity: report.grossIncome > 100000 ? 'critical' : 'high',\n      score: Math.min(90, Math.round(report.grossIncome / 3000)),\n      description: 'No legal entity protection. All personal assets at risk from business liabilities.',\n      mitigation: 'Form an LLC immediately. Cost: $75-800. Provides personal asset separation.',\n      category: 'Legal',\n      actionable: true,\n    })\n  }\n\n  // Tax underpayment risk\n  if (report.totalTax > 10000) {\n    risks.push({\n      id: 'tax-underpayment',\n      name: 'Estimated Tax Compliance',\n      severity: 'medium',\n      score: 40,\n      description: `Total tax liability of $${report.totalTax.toLocaleString()} requires quarterly estimated payments of ~$${Math.round(report.totalTax / 4).toLocaleString()}.`,\n      mitigation: 'Set calendar reminders for quarterly deadlines (Apr 15, Jun 15, Sep 15, Jan 15). Adjust payments as income fluctuates.',\n      category: 'Tax',\n      actionable: true,\n    })\n  }\n\n  // Emergency fund\n  const monthlyExpenses = expenses.reduce((sum, e) => sum + e.annualAmount / 12, 0) || (report.grossIncome * 0.5 / 12)\n  risks.push({\n    id: 'emergency-fund',\n    name: 'Emergency Fund Adequacy',\n    severity: 'medium',\n    score: 35,\n    description: `Self-employed individuals should maintain 6+ months of expenses (~$${Math.round(monthlyExpenses * 6).toLocaleString()}) in liquid reserves.`,\n    mitigation: 'Target 6-month emergency fund in high-yield savings. Automate monthly contributions.',\n    category: 'Financial',\n    actionable: true,\n  })\n\n  // Insurance gaps\n  risks.push({\n    id: 'insurance',\n    name: 'Insurance Coverage',\n    severity: report.grossIncome > 100000 ? 'high' : 'medium',\n    score: 45,\n    description: 'Verify professional liability (E&O), business property, and disability insurance coverage.',\n    mitigation: 'Obtain professional liability insurance ($500-1,200/yr). Consider disability insurance for income protection.',\n    category: 'Protection',\n    actionable: true,\n  })\n\n  // Documentation\n  const totalDeductions = deductions.reduce((sum, d) => sum + d.amount, 0) +\n    expenses.filter(e => e.isDeductible).reduce((sum, e) => sum + (e.annualAmount * e.deductionPct / 100), 0)\n  if (totalDeductions > 10000) {\n    risks.push({\n      id: 'documentation',\n      name: 'Deduction Documentation',\n      severity: totalDeductions > 30000 ? 'medium' : 'low',\n      score: 30,\n      description: `$${totalDeductions.toLocaleString()} in deductions requires thorough documentation in case of audit.`,\n      mitigation: 'Maintain digital copies of all receipts. Use accounting software for categorization. Keep contemporaneous records for mileage and home office.',\n      category: 'Compliance',\n      actionable: true,\n    })\n  }\n\n  // Sort by severity\n  const sevOrder: Record<string, number> = { critical: 0, high: 1, medium: 2, low: 3 }\n  risks.sort((a, b) => sevOrder[a.severity] - sevOrder[b.severity])\n\n  return risks\n}\n\n// ==================== Financial Health Score ====================\n\nexport function calculateHealthScore(state: FortunaState): FinancialHealthScore {\n  const report = generateTaxReport(state)\n  const strategies = detectStrategies(state)\n  const risks = analyzeRisks(state)\n  const { incomeStreams, entities, deductions } = state\n\n  // Tax efficiency (0-100)\n  const taxEff = Math.max(0, Math.min(100, Math.round((0.35 - report.effectiveRate) / 0.20 * 100)))\n\n  // Entity optimization — enhanced with entityBreakdown\n  const hasLLC = entities.some(e => ['llc', 'llc_scorp', 'scorp', 'ccorp'].includes(e.type) && e.isActive)\n  const hasScorp = entities.some(e => (e.type === 'llc_scorp' || e.type === 'scorp') && e.isActive)\n  let entityScore = 30\n  if (hasLLC) entityScore += 35\n  if (hasScorp && report.selfEmploymentIncome > 50000) entityScore += 35\n  // Bonus: check entity P&L health from entityBreakdown\n  const breakdown = report.entityBreakdown || []\n  const profitableEntities = breakdown.filter(e => e.netIncome > 0)\n  if (profitableEntities.length >= 2) entityScore = Math.min(100, entityScore + 10)\n\n  // Income growth / diversification\n  const activeStreams = incomeStreams.filter(s => s.isActive)\n  const diversification = Math.min(100, activeStreams.length * 25)\n\n  // Risk protection — factor in estimated payment compliance\n  const highRisks = risks.filter(r => r.severity === 'critical' || r.severity === 'high').length\n  let riskScore = Math.max(0, 100 - highRisks * 25)\n  const estPayments = state.estimatedPayments || []\n  const missedPayments = estPayments.filter(p => {\n    const due = new Date(p.dueDate)\n    return due < new Date() && (!p.paidAmount || p.paidAmount === 0)\n  })\n  if (missedPayments.length > 0) riskScore = Math.max(0, riskScore - missedPayments.length * 10)\n\n  // Retirement readiness — enhanced with actual accounts\n  const accounts = state.retirementAccounts || []\n  const accountContribs = accounts.reduce((s, a) => s + (a.annualContribution || 0), 0)\n  const maxPossible = accounts.reduce((s, a) => s + (a.maxContribution || 0), 0)\n  let retirementScore: number\n  if (maxPossible > 0) {\n    retirementScore = Math.round((accountContribs / maxPossible) * 100)\n  } else if (report.maxSEPIRA > 0) {\n    retirementScore = Math.round((report.currentRetirementContributions / report.maxSEPIRA) * 100)\n  } else {\n    retirementScore = 50\n  }\n\n  // Overall\n  const overall = Math.round(\n    taxEff * 0.25 +\n    entityScore * 0.20 +\n    diversification * 0.15 +\n    riskScore * 0.20 +\n    retirementScore * 0.20\n  )\n\n  const grade = overall >= 90 ? 'A+' : overall >= 80 ? 'A' : overall >= 70 ? 'B+' :\n                overall >= 60 ? 'B' : overall >= 50 ? 'C+' : overall >= 40 ? 'C' : 'D'\n\n  return {\n    overall,\n    components: {\n      taxEfficiency: taxEff,\n      entityOptimization: Math.min(100, entityScore),\n      incomeGrowth: diversification,\n      riskProtection: riskScore,\n      retirementReadiness: Math.min(100, retirementScore),\n      diversification,\n    },\n    grade,\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\strategy-knowledge-base.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'clamp' is defined but never used.","line":127,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":127,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'seSavings' is assigned a value but never used.","line":162,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":162,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'marginalRate' is defined but never used.","line":310,"column":32,"nodeType":"Identifier","messageId":"unusedVar","endLine":310,"endColumn":44},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'marginalRate' is defined but never used.","line":482,"column":32,"nodeType":"Identifier","messageId":"unusedVar","endLine":482,"endColumn":44}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE — Tax Strategy Knowledge Base v1\n * \n * Structured database of tax strategies with:\n *   - IRC section references\n *   - Phase-out thresholds\n *   - Dollar-impact estimators\n *   - Implementation checklists\n *   - State-specific notes\n *   - Eligibility criteria\n *   - Risk/audit flags\n *\n * Bridges the gap between Fortuna's contextual 25-40 strategies and\n * Corvee's 1,500+ database by providing deep, authoritative detail\n * for the highest-impact strategies relevant to self-employed entrepreneurs.\n */\n\n// ─── Types ──────────────────────────────────────────────────────────────────\n\nexport interface TaxStrategy {\n  id: string\n  name: string\n  category: StrategyCategory\n  subcategory: string\n  summary: string\n  detailedDescription: string\n  ircReferences: IRCReference[]\n  eligibility: EligibilityCriteria\n  savingsEstimator: (income: number, marginalRate: number, filingStatus: string) => SavingsEstimate\n  implementationChecklist: ChecklistItem[]\n  phaseOuts?: PhaseOut[]\n  stateNotes: StateNote[]\n  auditRisk: 'low' | 'medium' | 'high'\n  auditNotes: string\n  relatedStrategies: string[]\n  tags: string[]\n  effectiveForTaxYear: number[]\n  complexity: 'simple' | 'moderate' | 'complex' | 'specialist'\n}\n\nexport type StrategyCategory =\n  | 'retirement'\n  | 'entity_structure'\n  | 'deductions'\n  | 'credits'\n  | 'income_shifting'\n  | 'timing'\n  | 'investment'\n  | 'real_estate'\n  | 'crypto_defi'\n  | 'health_benefits'\n  | 'education'\n  | 'charitable'\n  | 'estate_planning'\n  | 'international'\n  | 'compliance'\n\nexport interface IRCReference {\n  section: string\n  title: string\n  relevance: string\n  url?: string\n}\n\nexport interface EligibilityCriteria {\n  filingStatuses: string[]\n  incomeRange?: { min?: number; max?: number }\n  entityTypes: string[]\n  requirements: string[]\n  disqualifiers: string[]\n}\n\nexport interface SavingsEstimate {\n  estimatedSavings: number\n  explanation: string\n  confidence: 'high' | 'medium' | 'low'\n  caveats: string[]\n}\n\nexport interface ChecklistItem {\n  step: number\n  action: string\n  deadline?: string\n  professional?: 'cpa' | 'attorney' | 'financial_advisor'\n  details: string\n}\n\nexport interface PhaseOut {\n  description: string\n  startIncome: number\n  endIncome: number\n  filingStatus: string\n  effect: string\n}\n\nexport interface StateNote {\n  states: string[]\n  note: string\n  impact: 'positive' | 'negative' | 'neutral'\n}\n\n// ─── Category Metadata ──────────────────────────────────────────────────────\n\nexport const STRATEGY_CATEGORIES: Record<StrategyCategory, { label: string; emoji: string; color: string; description: string }> = {\n  retirement:       { label: 'Retirement',          emoji: '🏦', color: '#3b82f6', description: 'Tax-advantaged retirement contributions and strategies' },\n  entity_structure: { label: 'Entity Structure',    emoji: '🏢', color: '#8b5cf6', description: 'Business entity optimization for tax efficiency' },\n  deductions:       { label: 'Deductions',          emoji: '✂️', color: '#10b981', description: 'Above/below-the-line deductions and write-offs' },\n  credits:          { label: 'Tax Credits',         emoji: '🎯', color: '#f59e0b', description: 'Dollar-for-dollar tax credits' },\n  income_shifting:  { label: 'Income Shifting',     emoji: '🔄', color: '#ec4899', description: 'Timing and allocation strategies' },\n  timing:           { label: 'Timing Strategies',   emoji: '⏰', color: '#6366f1', description: 'Accelerate deductions, defer income' },\n  investment:       { label: 'Investment',          emoji: '📈', color: '#14b8a6', description: 'Capital gains, harvesting, and portfolio strategies' },\n  real_estate:      { label: 'Real Estate',         emoji: '🏠', color: '#a855f7', description: 'Property-related tax benefits' },\n  crypto_defi:      { label: 'Crypto & DeFi',       emoji: '₿',  color: '#f97316', description: 'Digital asset-specific strategies' },\n  health_benefits:  { label: 'Health Benefits',     emoji: '🏥', color: '#ef4444', description: 'Health insurance and medical deductions' },\n  education:        { label: 'Education',           emoji: '📚', color: '#0ea5e9', description: 'Education credits and deductions' },\n  charitable:       { label: 'Charitable',          emoji: '💝', color: '#d946ef', description: 'Charitable giving strategies' },\n  estate_planning:  { label: 'Estate Planning',     emoji: '📜', color: '#78716c', description: 'Wealth transfer and estate strategies' },\n  international:    { label: 'International',       emoji: '🌍', color: '#0d9488', description: 'Foreign income and treaty strategies' },\n  compliance:       { label: 'Compliance',          emoji: '📋', color: '#64748b', description: 'Filing optimization and penalty avoidance' },\n}\n\n// ─── Helpers ────────────────────────────────────────────────────────────────\n\nconst seRate = 0.9235 * 0.153 // ~14.13% SE tax effective rate\nconst halfSE = (income: number) => income * seRate * 0.5 // deductible half of SE tax\n\nfunction clamp(val: number, min: number, max: number) { return Math.max(min, Math.min(max, val)) }\n\n// ─── Strategy Database ──────────────────────────────────────────────────────\n\nexport const STRATEGY_DATABASE: TaxStrategy[] = [\n\n  // ═══════════════════════════════════════════════════════════════════════════\n  // RETIREMENT STRATEGIES\n  // ═══════════════════════════════════════════════════════════════════════════\n\n  {\n    id: 'solo-401k',\n    name: 'Solo 401(k) Maximization',\n    category: 'retirement',\n    subcategory: 'Defined Contribution',\n    summary: 'Contribute up to $69,000 ($76,500 if 50+) as both employer and employee to a solo 401(k).',\n    detailedDescription: 'A Solo 401(k), also known as an Individual 401(k), allows self-employed individuals with no employees (other than a spouse) to make both employee elective deferrals and employer profit-sharing contributions. For 2025, employee deferrals are $23,500 ($31,000 if age 50+), plus employer contributions up to 25% of net self-employment income (after the SE tax deduction), with a combined limit of $69,000 ($76,500 with catch-up). This is the single most impactful retirement strategy for high-earning self-employed individuals because the employer contribution has no income phase-out.',\n    ircReferences: [\n      { section: 'IRC §401(k)', title: 'Cash or Deferred Arrangements', relevance: 'Establishes 401(k) plan rules including elective deferral limits' },\n      { section: 'IRC §402(g)', title: 'Limitation on Exclusion for Elective Deferrals', relevance: '$23,500 employee deferral limit for 2025' },\n      { section: 'IRC §415(c)', title: 'Limitation for Defined Contribution Plans', relevance: '$69,000 total annual addition limit for 2025' },\n      { section: 'IRC §414(v)', title: 'Catch-Up Contributions', relevance: 'Additional $7,500 for participants age 50+' },\n    ],\n    eligibility: {\n      filingStatuses: ['single', 'mfj', 'mfs', 'hoh'],\n      entityTypes: ['sole_proprietorship', 'single_member_llc', 'partnership', 's_corp'],\n      requirements: ['Self-employed with no full-time employees (spouse OK)', 'Must establish plan by December 31 of tax year', 'Employer contributions must be made by tax filing deadline (with extensions)'],\n      disqualifiers: ['Having non-spouse W-2 employees working 1,000+ hours/year', 'Participating in employer 401(k) reduces employee deferral limit'],\n    },\n    savingsEstimator: (income, marginalRate) => {\n      const netSE = income * 0.9235 - halfSE(income) // net SE income after half SE deduction\n      const employeeDeferral = Math.min(23500, netSE)\n      const employerContrib = Math.min(netSE * 0.25, 69000 - employeeDeferral)\n      const totalContrib = employeeDeferral + employerContrib\n      const taxSavings = totalContrib * marginalRate\n      const seSavings = 0 // 401k doesn't reduce SE income\n      return {\n        estimatedSavings: Math.round(taxSavings),\n        explanation: `Contributing $${employeeDeferral.toLocaleString()} (employee) + $${Math.round(employerContrib).toLocaleString()} (employer) = $${Math.round(totalContrib).toLocaleString()} total. At ${(marginalRate * 100).toFixed(0)}% marginal rate = ~$${Math.round(taxSavings).toLocaleString()} in federal tax savings.`,\n        confidence: 'high',\n        caveats: ['State tax savings additional', 'Required Minimum Distributions begin at age 73', 'Early withdrawal penalty of 10% before age 59½'],\n      }\n    },\n    implementationChecklist: [\n      { step: 1, action: 'Choose a Solo 401(k) provider', details: 'Fidelity, Schwab, Vanguard, or E*TRADE all offer free Solo 401(k) plans. Compare for Roth option, loan provisions, and investment choices.' },\n      { step: 2, action: 'Open and establish the plan by December 31', deadline: 'December 31 of tax year', details: 'The plan must be established (documents signed) by year-end, even though contributions can be made later.' },\n      { step: 3, action: 'Calculate maximum contribution', details: 'Use net SE income (Line 31 of Schedule C minus half SE tax) to compute 25% employer limit. Add employee deferral up to $23,500.' },\n      { step: 4, action: 'Make employee elective deferral', deadline: 'December 31 of tax year (for sole props/partnerships)', details: 'Sole proprietors must make employee deferrals by Dec 31. S-Corp owners must make deferrals through payroll by Dec 31.' },\n      { step: 5, action: 'Make employer profit-sharing contribution', deadline: 'Tax filing deadline (including extensions)', details: 'Can be made up to April 15 (or October 15 with extension). Report on Form 1040, Line 16.' },\n      { step: 6, action: 'File Form 5500-EZ if plan assets exceed $250,000', deadline: 'July 31 following plan year-end', details: 'Required annual filing once assets cross $250K threshold. Penalty for late filing: $250/day up to $150K.', professional: 'cpa' },\n    ],\n    phaseOuts: [], // No income phase-out for Solo 401(k)\n    stateNotes: [\n      { states: ['CA', 'NY', 'NJ', 'HI', 'OR', 'MN', 'VT', 'IA', 'WI', 'ME'], note: 'High state income tax makes the deduction even more valuable — state tax savings add 5-13% on top of federal.', impact: 'positive' },\n      { states: ['TX', 'FL', 'WA', 'NV', 'WY', 'SD', 'AK', 'NH', 'TN'], note: 'No state income tax — savings are federal only.', impact: 'neutral' },\n    ],\n    auditRisk: 'low',\n    auditNotes: 'Well-established retirement vehicle. Main audit risk: contributing more than allowed based on net SE income, or having disqualifying employees.',\n    relatedStrategies: ['sep-ira', 'defined-benefit', 'roth-conversion', 'backdoor-roth'],\n    tags: ['retirement', 'self-employed', 'high-impact', 'tax-deferral'],\n    effectiveForTaxYear: [2024, 2025, 2026],\n    complexity: 'moderate',\n  },\n\n  {\n    id: 'sep-ira',\n    name: 'SEP IRA Contribution',\n    category: 'retirement',\n    subcategory: 'Simplified Employee Pension',\n    summary: 'Contribute up to 25% of net SE income (max $69,000) with minimal administration.',\n    detailedDescription: 'A SEP IRA allows self-employed individuals to contribute up to 25% of net self-employment income (after the half-SE-tax deduction), with a maximum of $69,000 for 2025. Simpler to administer than a Solo 401(k) — no annual Form 5500 filing requirement. However, there is no employee deferral component and no Roth option, making it less flexible than a Solo 401(k) for high earners.',\n    ircReferences: [\n      { section: 'IRC §408(k)', title: 'Simplified Employee Pension', relevance: 'Establishes SEP IRA rules and contribution limits' },\n      { section: 'IRC §402(h)', title: 'SEP Contribution Limit', relevance: '25% of compensation up to $69,000 for 2025' },\n    ],\n    eligibility: {\n      filingStatuses: ['single', 'mfj', 'mfs', 'hoh'],\n      entityTypes: ['sole_proprietorship', 'single_member_llc', 'partnership', 's_corp', 'c_corp'],\n      requirements: ['Self-employment income', 'Can be established and funded up to tax filing deadline (with extensions)'],\n      disqualifiers: ['Must cover eligible employees if you have any (contributing same % for all)', 'Cannot combine with Solo 401(k) employee deferrals at same employer'],\n    },\n    savingsEstimator: (income, marginalRate) => {\n      const netSE = income * 0.9235 - halfSE(income)\n      const maxContrib = Math.min(netSE * 0.25, 69000)\n      const savings = maxContrib * marginalRate\n      return {\n        estimatedSavings: Math.round(savings),\n        explanation: `25% of net SE income = $${Math.round(maxContrib).toLocaleString()} contribution. At ${(marginalRate * 100).toFixed(0)}% = ~$${Math.round(savings).toLocaleString()} federal tax savings.`,\n        confidence: 'high',\n        caveats: ['No Roth option', 'Must contribute same % for all eligible employees', 'Lower total possible contribution than Solo 401(k) at higher incomes'],\n      }\n    },\n    implementationChecklist: [\n      { step: 1, action: 'Open SEP IRA at any brokerage', details: 'Fidelity, Schwab, Vanguard. Simple 1-page IRS Form 5305-SEP.' },\n      { step: 2, action: 'Calculate 25% of net SE income', details: 'Net SE = Schedule C profit × 0.9235, minus half of SE tax. Then multiply by 25%.' },\n      { step: 3, action: 'Make contribution by filing deadline', deadline: 'April 15 (or October 15 with extension)', details: 'This is the key advantage: you can wait until you know your actual income before deciding how much to contribute.' },\n    ],\n    phaseOuts: [],\n    stateNotes: [\n      { states: ['CA', 'NY', 'NJ'], note: 'Deductible for state purposes as well, providing additional 6-13% savings.', impact: 'positive' },\n    ],\n    auditRisk: 'low',\n    auditNotes: 'Very common strategy with minimal audit risk.',\n    relatedStrategies: ['solo-401k', 'defined-benefit', 'simple-ira'],\n    tags: ['retirement', 'self-employed', 'simple', 'tax-deferral'],\n    effectiveForTaxYear: [2024, 2025, 2026],\n    complexity: 'simple',\n  },\n\n  {\n    id: 'defined-benefit',\n    name: 'Defined Benefit Plan (Cash Balance)',\n    category: 'retirement',\n    subcategory: 'Defined Benefit',\n    summary: 'Deduct $100K-$300K+ annually through an actuarially-determined pension plan.',\n    detailedDescription: 'A Defined Benefit (DB) or Cash Balance plan allows dramatically higher tax-deductible contributions than any defined contribution plan. Contribution limits are based on actuarial calculations considering age, income, and years to retirement. For a self-employed individual age 50+, annual deductible contributions can exceed $250,000. Can be combined with a 401(k) for even greater total deductions. Requires annual actuarial certification and is more complex to administer.',\n    ircReferences: [\n      { section: 'IRC §415(b)', title: 'Limitation for Defined Benefit Plans', relevance: 'Annual benefit limit of $280,000 (2025), which drives allowed contributions' },\n      { section: 'IRC §404(a)', title: 'Deduction Limits for Employer Contributions', relevance: 'Employer contribution deduction rules for DB plans' },\n      { section: 'IRC §412', title: 'Minimum Funding Standards', relevance: 'Mandatory annual funding requirements' },\n    ],\n    eligibility: {\n      filingStatuses: ['single', 'mfj', 'mfs', 'hoh'],\n      incomeRange: { min: 200000 },\n      entityTypes: ['sole_proprietorship', 'single_member_llc', 'partnership', 's_corp', 'c_corp'],\n      requirements: ['Consistent high income ($200K+/year for 3+ years recommended)', 'Must commit to funding for 3-5 years minimum', 'Annual actuarial certification required', 'Age 40+ gets highest benefit (contribution limits increase with age)'],\n      disqualifiers: ['Volatile or declining income (creates funding risk)', 'Plans to retire in <3 years without sufficient accumulation'],\n    },\n    savingsEstimator: (income, marginalRate) => {\n      // Simplified estimate based on age 50, $250K income\n      const contribution = Math.min(income * 0.5, 250000) // rough approximation\n      const savings = contribution * marginalRate\n      return {\n        estimatedSavings: Math.round(savings),\n        explanation: `Estimated actuarial contribution of ~$${Math.round(contribution).toLocaleString()} (varies by age and income). At ${(marginalRate * 100).toFixed(0)}% = ~$${Math.round(savings).toLocaleString()} federal savings. Actual amount requires actuarial calculation.`,\n        confidence: 'low',\n        caveats: ['Requires actuarial determination — estimate only', 'Annual actuarial fees $1,500-3,000', 'Must fund plan even in low-income years', 'Excise tax for under-funding'],\n      }\n    },\n    implementationChecklist: [\n      { step: 1, action: 'Consult with actuarial firm', professional: 'financial_advisor', details: 'Companies like Dedicated Defined Benefit, Kravitz, or local TPA firms. Get feasibility analysis based on your age, income, and goals.' },\n      { step: 2, action: 'Establish plan by fiscal year-end', deadline: 'December 31 of tax year', details: 'Plan document must be adopted before year-end.' },\n      { step: 3, action: 'Fund the plan by tax filing deadline', deadline: 'April 15 or October 15 with extension', details: 'Mandatory minimum contribution must be made or face excise tax.' },\n      { step: 4, action: 'Annual actuarial certification', deadline: 'Annually', professional: 'financial_advisor', details: 'Actuary must certify funding status and recalculate contribution each year.' },\n      { step: 5, action: 'File Form 5500', deadline: 'July 31', professional: 'cpa', details: 'Annual filing required with Schedule SB (actuary attaches).' },\n    ],\n    phaseOuts: [],\n    stateNotes: [\n      { states: ['CA'], note: 'California conforms — full state deduction available, adding 9.3-13.3% savings on top of federal.', impact: 'positive' },\n      { states: ['NY'], note: 'New York conforms — deductible for state, adding 4-10.9% savings.', impact: 'positive' },\n    ],\n    auditRisk: 'medium',\n    auditNotes: 'IRS scrutinizes DB plans for owner-only businesses. Key risk: plan termination within 5 years can trigger recapture. Ensure consistent income justifies contribution levels.',\n    relatedStrategies: ['solo-401k', 'sep-ira', 's-corp-election'],\n    tags: ['retirement', 'high-income', 'complex', 'maximum-deferral'],\n    effectiveForTaxYear: [2024, 2025, 2026],\n    complexity: 'specialist',\n  },\n\n  // ═══════════════════════════════════════════════════════════════════════════\n  // ENTITY STRUCTURE STRATEGIES\n  // ═══════════════════════════════════════════════════════════════════════════\n\n  {\n    id: 's-corp-election',\n    name: 'S Corporation Election',\n    category: 'entity_structure',\n    subcategory: 'Entity Optimization',\n    summary: 'Elect S-Corp status to split income into salary (subject to SE tax) and distributions (not subject to SE tax).',\n    detailedDescription: 'An S Corporation election allows business owners to pay themselves a \"reasonable salary\" and take remaining profits as distributions that are NOT subject to self-employment tax (15.3%). For a sole proprietor earning $150K in profit, converting to S-Corp with a $70K salary could save $11,000+ in SE tax annually. The key IRS requirement is \"reasonable compensation\" — salary must be fair market value for the services provided.',\n    ircReferences: [\n      { section: 'IRC §1362', title: 'Election; Revocation; Termination', relevance: 'S-Corp election requirements and procedures (Form 2553)' },\n      { section: 'IRC §1361(b)', title: 'Small Business Corporation Defined', relevance: 'Eligibility: ≤100 shareholders, one class of stock, US shareholders only' },\n      { section: 'Rev. Rul. 74-44', title: 'Reasonable Compensation', relevance: 'IRS position that S-Corp officer-shareholders must receive reasonable compensation' },\n      { section: 'IRC §3121(a)', title: 'Wages; Employment Tax', relevance: 'Only wages (not distributions) subject to FICA taxes' },\n    ],\n    eligibility: {\n      filingStatuses: ['single', 'mfj', 'mfs', 'hoh'],\n      incomeRange: { min: 50000 },\n      entityTypes: ['sole_proprietorship', 'single_member_llc', 'partnership'],\n      requirements: ['Net profit generally >$50K/year for savings to exceed compliance costs', 'Must pay reasonable compensation via payroll', 'Must file Form 1120-S annually', 'Must maintain corporate formalities'],\n      disqualifiers: ['Non-US shareholders', 'More than 100 shareholders', 'Multiple classes of stock', 'Income too low to justify compliance costs'],\n    },\n    savingsEstimator: (income, marginalRate) => {\n      if (income < 50000) return { estimatedSavings: 0, explanation: 'Income below threshold for S-Corp savings.', confidence: 'high', caveats: [] }\n      const reasonableSalary = Math.max(40000, income * 0.45) // rough reasonable comp estimate\n      const distribution = Math.max(0, income - reasonableSalary)\n      const seTaxSaved = distribution * 0.153\n      const additionalCosts = 3000 // payroll + extra filing costs\n      const netSavings = seTaxSaved - additionalCosts\n      return {\n        estimatedSavings: Math.round(Math.max(0, netSavings)),\n        explanation: `Reasonable salary: ~$${Math.round(reasonableSalary).toLocaleString()}, Distribution: ~$${Math.round(distribution).toLocaleString()}. SE tax saved on distributions: ~$${Math.round(seTaxSaved).toLocaleString()}, minus ~$3K compliance costs = ~$${Math.round(netSavings).toLocaleString()} net savings.`,\n        confidence: 'medium',\n        caveats: ['Reasonable compensation is subjective and fact-dependent', 'Additional costs: payroll service ($500-1500/yr), separate tax return ($500-1500)', 'Must file Form 2553 by March 15 (or within 75 days of formation)'],\n      }\n    },\n    implementationChecklist: [\n      { step: 1, action: 'Evaluate if S-Corp makes financial sense', details: 'Rule of thumb: net profit >$50K and SE tax savings exceed $3-5K in additional compliance costs.' },\n      { step: 2, action: 'File Form 2553 with IRS', deadline: 'March 15 of the year election is to take effect (or within 75 days of formation)', details: 'Late elections possible with reasonable cause via Rev. Proc. 2013-30.', professional: 'cpa' },\n      { step: 3, action: 'Set up payroll', details: 'Use Gusto, ADP, or similar to process regular payroll with W-2, withholding, and payroll tax filings.' },\n      { step: 4, action: 'Determine reasonable compensation', details: 'Research comparable salaries for your role using BLS data, salary surveys. Document your methodology.', professional: 'cpa' },\n      { step: 5, action: 'Run payroll at least monthly', details: 'Pay yourself regular salary with proper withholding. Take remaining profits as distributions.' },\n      { step: 6, action: 'File Form 1120-S and Schedule K-1', deadline: 'March 15 (or September 15 with extension)', professional: 'cpa', details: 'S-Corp files its own return. K-1 flows to your personal 1040.' },\n    ],\n    phaseOuts: [],\n    stateNotes: [\n      { states: ['CA'], note: 'California imposes a 1.5% net income tax on S-Corps (minimum $800), reducing savings by ~$800-2,250+.', impact: 'negative' },\n      { states: ['NY'], note: 'New York City does not recognize S-Corp status — city tax still applies on full income.', impact: 'negative' },\n      { states: ['TX'], note: 'Texas franchise tax applies to S-Corps with >$2.47M in revenue. Below threshold: no state impact.', impact: 'neutral' },\n      { states: ['IL'], note: 'Illinois imposes a 1.5% replacement tax on S-Corp income.', impact: 'negative' },\n      { states: ['NH'], note: 'New Hampshire taxes S-Corp distributions as business profits tax (7.5%).', impact: 'negative' },\n    ],\n    auditRisk: 'medium',\n    auditNotes: 'IRS actively audits S-Corp reasonable compensation. Key risk: setting salary too low relative to industry norms. Watson v. Commissioner (2012) established that IRS can reclassify distributions as wages.',\n    relatedStrategies: ['solo-401k', 'qbi-deduction', 'reasonable-comp', 'health-insurance-deduction'],\n    tags: ['entity', 'se-tax-reduction', 'high-impact', 'payroll'],\n    effectiveForTaxYear: [2024, 2025, 2026],\n    complexity: 'moderate',\n  },\n\n  {\n    id: 'qbi-deduction',\n    name: 'Qualified Business Income (QBI) Deduction',\n    category: 'entity_structure',\n    subcategory: 'Pass-Through Deduction',\n    summary: 'Deduct up to 20% of qualified business income from pass-through entities (§199A).',\n    detailedDescription: 'The §199A deduction allows owners of pass-through businesses (sole proprietorships, LLCs, S-Corps, partnerships) to deduct up to 20% of qualified business income. For taxable income below $191,950 (single) / $383,900 (MFJ) in 2025, the deduction is straightforward. Above those thresholds, limitations based on W-2 wages and qualified property begin to apply, and \"specified service trades or businesses\" (SSTBs) face phase-outs.',\n    ircReferences: [\n      { section: 'IRC §199A', title: 'Qualified Business Income', relevance: 'Establishes the 20% pass-through deduction' },\n      { section: 'IRC §199A(d)', title: 'Specified Service Trade or Business', relevance: 'Defines SSTBs subject to income-based phase-outs' },\n      { section: 'Treas. Reg. §1.199A-1 through §1.199A-6', title: 'QBI Regulations', relevance: 'Detailed rules for calculation, aggregation, and limitations' },\n    ],\n    eligibility: {\n      filingStatuses: ['single', 'mfj', 'mfs', 'hoh'],\n      entityTypes: ['sole_proprietorship', 'single_member_llc', 'partnership', 's_corp'],\n      requirements: ['Pass-through business income', 'Not a C Corporation'],\n      disqualifiers: ['C Corporation income', 'Employee wage income (W-2)', 'Guaranteed payments from partnerships (partially)'],\n    },\n    savingsEstimator: (income, marginalRate, filingStatus) => {\n      const qbiAmount = income * 0.2\n      const threshold = filingStatus === 'mfj' ? 383900 : 191950\n      let deduction: number\n      if (income <= threshold) {\n        deduction = qbiAmount\n      } else {\n        deduction = Math.max(0, qbiAmount * (1 - (income - threshold) / 100000))\n      }\n      const savings = deduction * marginalRate\n      return {\n        estimatedSavings: Math.round(savings),\n        explanation: `20% of $${income.toLocaleString()} QBI = $${Math.round(deduction).toLocaleString()} deduction. At ${(marginalRate * 100).toFixed(0)}% = ~$${Math.round(savings).toLocaleString()} savings.`,\n        confidence: income > threshold ? 'medium' : 'high',\n        caveats: income > threshold ? ['SSTB phase-out may reduce or eliminate deduction', 'W-2 wage / qualified property limitations apply above threshold'] : ['Confirm business is not an SSTB', 'Currently set to expire after 2025 unless Congress extends'],\n      }\n    },\n    implementationChecklist: [\n      { step: 1, action: 'Determine if your business qualifies', details: 'Most non-SSTB businesses qualify. SSTBs (consulting, law, accounting, health, financial services) face income-based phase-outs.' },\n      { step: 2, action: 'Calculate QBI on your return', details: 'QBI = net business income minus the deductible half of SE tax, minus SE health insurance, minus retirement contributions.', professional: 'cpa' },\n      { step: 3, action: 'Check income thresholds', details: 'Below $191,950 (single) / $383,900 (MFJ): full 20% deduction. Above: W-2 wages / qualified property test applies.' },\n      { step: 4, action: 'Consider aggregation of businesses', details: 'If you have multiple businesses, aggregating them may help satisfy the W-2 wage test.', professional: 'cpa' },\n    ],\n    phaseOuts: [\n      { description: 'SSTB Income Phase-Out (Single)', startIncome: 191950, endIncome: 241950, filingStatus: 'single', effect: 'SSTB QBI deduction phases out completely over this range' },\n      { description: 'SSTB Income Phase-Out (MFJ)', startIncome: 383900, endIncome: 433900, filingStatus: 'mfj', effect: 'SSTB QBI deduction phases out completely over this range' },\n    ],\n    stateNotes: [\n      { states: ['CA', 'NJ', 'MN', 'HI'], note: 'These states do NOT conform to §199A — no state-level QBI deduction.', impact: 'negative' },\n      { states: ['IL', 'OH', 'PA', 'IN'], note: 'These states generally conform or have flat taxes that aren\\u2019t affected.', impact: 'neutral' },\n    ],\n    auditRisk: 'low',\n    auditNotes: 'Standard deduction claimed on millions of returns. Risk increases if claiming QBI deduction for an SSTB above income thresholds.',\n    relatedStrategies: ['s-corp-election', 'reasonable-comp', 'income-shifting-family'],\n    tags: ['deduction', 'pass-through', 'section-199a', 'sunset-risk-2025'],\n    effectiveForTaxYear: [2024, 2025],\n    complexity: 'moderate',\n  },\n\n  // ═══════════════════════════════════════════════════════════════════════════\n  // CRYPTO & DEFI STRATEGIES\n  // ═══════════════════════════════════════════════════════════════════════════\n\n  {\n    id: 'tax-loss-harvesting-crypto',\n    name: 'Crypto Tax-Loss Harvesting',\n    category: 'crypto_defi',\n    subcategory: 'Capital Loss Optimization',\n    summary: 'Sell underperforming crypto to realize losses that offset capital gains (no wash sale rule for crypto in 2024).',\n    detailedDescription: 'Tax-loss harvesting involves selling crypto assets at a loss to offset realized capital gains, then optionally repurchasing the same or similar asset. For tax years through 2024, the IRS wash sale rule (IRC §1091) technically applies only to \"securities\" and \"stock\" — crypto is classified as \"property,\" not a security, meaning you could theoretically sell and immediately rebuy. IMPORTANT: Starting January 1, 2025, the Tax Cuts and Jobs Act amendments expand wash sale rules to cover digital assets. Capital losses can offset unlimited capital gains, plus up to $3,000 of ordinary income annually, with unlimited carryforward.',\n    ircReferences: [\n      { section: 'IRC §1091', title: 'Loss from Wash Sales of Stock or Securities', relevance: 'Wash sale rule — does not explicitly cover crypto through 2024; extended to digital assets starting 2025' },\n      { section: 'IRC §1211', title: 'Limitation on Capital Losses', relevance: '$3,000 annual limit on capital losses deducted against ordinary income' },\n      { section: 'IRC §1212', title: 'Capital Loss Carryovers', relevance: 'Unlimited carryforward of unused capital losses to future years' },\n      { section: 'Notice 2014-21', title: 'IRS Virtual Currency Guidance', relevance: 'Establishes crypto as \"property\" for tax purposes' },\n      { section: 'Rev. Proc. 2024-28', title: 'Per-Wallet Cost Basis', relevance: 'Mandatory per-wallet cost basis tracking starting 2025' },\n    ],\n    eligibility: {\n      filingStatuses: ['single', 'mfj', 'mfs', 'hoh'],\n      entityTypes: ['sole_proprietorship', 'single_member_llc', 'partnership', 's_corp', 'c_corp', 'individual'],\n      requirements: ['Crypto positions with unrealized losses', 'Realized capital gains to offset (or $3K ordinary income offset)'],\n      disqualifiers: ['No unrealized losses to harvest', 'After 2024: wash sale rule applies to digital assets (30-day restriction)'],\n    },\n    savingsEstimator: (income, marginalRate) => {\n      // Assume 10% of portfolio is at a loss, average loss 30%\n      const estimatedHarvest = income * 0.05 // rough: 5% of income available to harvest\n      const gainOffset = estimatedHarvest * 0.15 // LTCG rate savings\n      const ordinaryOffset = Math.min(3000, estimatedHarvest) * marginalRate\n      const totalSavings = gainOffset + ordinaryOffset\n      return {\n        estimatedSavings: Math.round(totalSavings),\n        explanation: `Estimated harvestable losses offset capital gains at 15% rate plus up to $3,000 at ${(marginalRate * 100).toFixed(0)}% ordinary rate. Actual savings depend on specific positions.`,\n        confidence: 'low',\n        caveats: ['Actual savings depend on portfolio positions', 'Wash sale rules apply starting 2025 for crypto', 'Must maintain documentation of all transactions'],\n      }\n    },\n    implementationChecklist: [\n      { step: 1, action: 'Review portfolio for positions with unrealized losses', details: 'Compare current value vs. cost basis for each position. Prioritize largest losses.' },\n      { step: 2, action: 'Calculate total realized gains YTD', details: 'Sum all capital gains from sales, swaps, and conversions during the tax year.' },\n      { step: 3, action: 'Execute harvesting sales before December 31', deadline: 'December 31', details: 'Sell loss positions. For 2024: can immediately repurchase. For 2025+: wait 30 days to avoid wash sale.' },\n      { step: 4, action: 'Document all transactions', details: 'Record date, quantity, cost basis, proceeds, and exchange for every sale. Keep exchange confirmation screenshots.' },\n      { step: 5, action: 'Report on Form 8949 and Schedule D', deadline: 'Tax filing deadline', professional: 'cpa', details: 'Each harvesting sale must be reported individually.' },\n    ],\n    phaseOuts: [],\n    stateNotes: [\n      { states: ['CA'], note: 'California taxes capital gains as ordinary income — harvesting losses is even more valuable (saves at marginal rate up to 13.3%).', impact: 'positive' },\n      { states: ['NY', 'NJ', 'CT', 'OR', 'HI'], note: 'High state capital gains rates make loss harvesting more impactful.', impact: 'positive' },\n    ],\n    auditRisk: 'low',\n    auditNotes: 'Tax-loss harvesting is a standard, well-accepted strategy. Key documentation: maintain trade confirmations, cost basis records, and timing proof for wash sale compliance (2025+).',\n    relatedStrategies: ['holding-period-optimization', 'staking-entity-structure', 'crypto-donation'],\n    tags: ['crypto', 'capital-gains', 'portfolio', 'year-end'],\n    effectiveForTaxYear: [2024, 2025, 2026],\n    complexity: 'moderate',\n  },\n\n  {\n    id: 'staking-entity-structure',\n    name: 'Staking/Mining Income Entity Structuring',\n    category: 'crypto_defi',\n    subcategory: 'Entity Optimization for Crypto Income',\n    summary: 'Route staking/mining income through an S-Corp to avoid full SE tax on crypto income classified as ordinary income.',\n    detailedDescription: 'Cryptocurrency staking rewards and mining income are taxable as ordinary income at fair market value when received, and may be subject to self-employment tax if conducted as a trade or business. By routing this activity through an S-Corp, you can pay a reasonable salary and take remaining income as distributions exempt from SE tax. This is particularly valuable for validators, large-scale stakers, and miners with significant regular income streams.',\n    ircReferences: [\n      { section: 'IRC §61', title: 'Gross Income Defined', relevance: 'Staking rewards are gross income at FMV when received' },\n      { section: 'IRC §1402', title: 'Self-Employment Tax', relevance: 'Mining/staking as trade or business subject to SE tax' },\n      { section: 'Notice 2014-21', title: 'Virtual Currency', relevance: 'IRS guidance on mining as ordinary income' },\n      { section: 'Rev. Rul. 2023-14', title: 'Staking Rewards', relevance: 'Staking rewards taxable when received (dominion and control)' },\n    ],\n    eligibility: {\n      filingStatuses: ['single', 'mfj', 'mfs', 'hoh'],\n      incomeRange: { min: 20000 },\n      entityTypes: ['sole_proprietorship', 'single_member_llc'],\n      requirements: ['Staking/mining income >$20K/year', 'Activity constitutes trade or business', 'Consistent, regular income stream'],\n      disqualifiers: ['Sporadic small staking rewards (<$5K/year)', 'Activity more passive investment than business'],\n    },\n    savingsEstimator: (income, marginalRate) => {\n      const stakingIncome = Math.min(income * 0.3, 100000)\n      const reasonableSalary = stakingIncome * 0.4\n      const distribution = stakingIncome - reasonableSalary\n      const seTaxSaved = distribution * 0.153\n      const complianceCost = 3000\n      return {\n        estimatedSavings: Math.round(Math.max(0, seTaxSaved - complianceCost)),\n        explanation: `Estimated staking/mining income routed through S-Corp: salary $${Math.round(reasonableSalary).toLocaleString()}, distributions $${Math.round(distribution).toLocaleString()}. SE tax saved: ~$${Math.round(seTaxSaved).toLocaleString()} minus $3K compliance costs.`,\n        confidence: 'medium',\n        caveats: ['IRS position on staking SE tax is evolving', 'Reasonable compensation must be justified', 'S-Corp compliance costs apply'],\n      }\n    },\n    implementationChecklist: [\n      { step: 1, action: 'Evaluate staking/mining income volume', details: 'Track total staking rewards and mining income over 12 months. If >$20K, entity structuring likely beneficial.' },\n      { step: 2, action: 'Form LLC and elect S-Corp status', professional: 'attorney', details: 'Form LLC in your state, then file Form 2553 for S-Corp election.' },\n      { step: 3, action: 'Transfer staking/mining operations to entity', details: 'Move validator nodes, mining equipment, and wallet operations under the entity.' },\n      { step: 4, action: 'Set up payroll and determine reasonable compensation', professional: 'cpa', details: 'Pay regular salary through payroll service. Document compensation analysis.' },\n      { step: 5, action: 'Track all staking rewards with timestamps and FMV', details: 'Maintain detailed log of every reward: date, amount, token, FMV at receipt. Use crypto tax software for automation.' },\n    ],\n    phaseOuts: [],\n    stateNotes: [],\n    auditRisk: 'medium',\n    auditNotes: 'IRS is increasingly scrutinizing crypto income reporting. Key risks: failure to report staking rewards, aggressive salary/distribution splits. Jarrett v. United States (2022) raised questions about staking tax timing (creation vs. receipt) but IRS position remains: taxable at receipt.',\n    relatedStrategies: ['s-corp-election', 'tax-loss-harvesting-crypto', 'solo-401k'],\n    tags: ['crypto', 'staking', 'mining', 'entity', 'se-tax'],\n    effectiveForTaxYear: [2024, 2025, 2026],\n    complexity: 'complex',\n  },\n\n  {\n    id: 'holding-period-optimization',\n    name: 'Crypto Holding Period Optimization',\n    category: 'crypto_defi',\n    subcategory: 'Capital Gains Rate Management',\n    summary: 'Strategically time sales to qualify for long-term capital gains rates (0%/15%/20%) instead of ordinary income rates.',\n    detailedDescription: 'Crypto held for more than 12 months qualifies for preferential long-term capital gains rates: 0% up to $47,025 (single) / $94,050 (MFJ), 15% up to $518,900 (single) / $583,750 (MFJ), and 20% above those thresholds. Short-term gains are taxed at ordinary income rates up to 37%. For a taxpayer in the 32% bracket, the difference between selling at 11 months vs 13 months can be 17 percentage points (32% vs 15%).',\n    ircReferences: [\n      { section: 'IRC §1(h)', title: 'Maximum Capital Gains Rate', relevance: '0%/15%/20% rate structure for long-term capital gains' },\n      { section: 'IRC §1222', title: 'Long-Term and Short-Term Definitions', relevance: 'Defines >12 months holding period for LTCG treatment' },\n      { section: 'IRC §1(h)(11)', title: 'Net Capital Gain', relevance: 'Calculation of preferential rate brackets' },\n    ],\n    eligibility: {\n      filingStatuses: ['single', 'mfj', 'mfs', 'hoh'],\n      entityTypes: ['sole_proprietorship', 'single_member_llc', 'partnership', 's_corp', 'individual'],\n      requirements: ['Crypto positions approaching 12-month holding period', 'Flexibility to time sales'],\n      disqualifiers: ['Day traders (holding period rarely exceeds days)', 'Positions already past 12 months (already qualify)'],\n    },\n    savingsEstimator: (income, marginalRate) => {\n      // Estimate savings from timing a $50K gain as LTCG vs STCG\n      const estimatedGain = 50000\n      const stcgTax = estimatedGain * marginalRate\n      const ltcgRate = income > 518900 ? 0.20 : income > 47025 ? 0.15 : 0\n      const ltcgTax = estimatedGain * ltcgRate\n      const savings = stcgTax - ltcgTax\n      return {\n        estimatedSavings: Math.round(savings),\n        explanation: `On a $50K gain: short-term tax at ${(marginalRate * 100).toFixed(0)}% = $${Math.round(stcgTax).toLocaleString()} vs long-term at ${(ltcgRate * 100).toFixed(0)}% = $${Math.round(ltcgTax).toLocaleString()}. Savings: $${Math.round(savings).toLocaleString()}.`,\n        confidence: 'high',\n        caveats: ['Requires holding for 12+ months', 'Market risk during holding period', 'NIIT (3.8%) may apply above $200K/$250K AGI'],\n      }\n    },\n    implementationChecklist: [\n      { step: 1, action: 'Tag all positions with acquisition dates', details: 'Record exact purchase/receipt date for every position in your portfolio tracker.' },\n      { step: 2, action: 'Set alerts for positions approaching 12-month threshold', details: 'Fortuna\\u2019s proactive alerts will notify you when positions are 10-14 days from LTCG eligibility.' },\n      { step: 3, action: 'Delay planned sales until after LTCG qualification', details: 'If selling a position at 11 months, waiting 30+ days saves the rate differential.' },\n      { step: 4, action: 'Use specific identification method', details: 'When selling partial positions, specifically identify the lots held >12 months to maximize LTCG treatment.', professional: 'cpa' },\n    ],\n    phaseOuts: [],\n    stateNotes: [\n      { states: ['CA', 'NY', 'NJ', 'OR', 'HI', 'MN'], note: 'These states tax capital gains as ordinary income — no state-level benefit from LTCG rate. Federal savings still apply.', impact: 'negative' },\n    ],\n    auditRisk: 'low',\n    auditNotes: 'Standard tax planning. Ensure acquisition date documentation is iron-clad.',\n    relatedStrategies: ['tax-loss-harvesting-crypto', 'staking-entity-structure'],\n    tags: ['crypto', 'capital-gains', 'holding-period', 'timing'],\n    effectiveForTaxYear: [2024, 2025, 2026],\n    complexity: 'simple',\n  },\n\n  {\n    id: 'airdrop-tge-planning',\n    name: 'Airdrop & TGE Tax Planning',\n    category: 'crypto_defi',\n    subcategory: 'Token Event Preparation',\n    summary: 'Plan for the tax impact of token airdrops and Token Generation Events before they create surprise tax bills.',\n    detailedDescription: 'Airdrops and TGE events create taxable ordinary income at the fair market value of tokens when received (dominion and control). For large airdrops (e.g., 100M tokens at $0.02 = $2M income), the tax impact can be devastating if not planned for. Pre-TGE strategies include: estimating tax liability and reserving funds, structuring entity ownership for optimal tax treatment, timing the claim/receipt if possible, and setting up quarterly estimated payments.',\n    ircReferences: [\n      { section: 'IRC §61', title: 'Gross Income', relevance: 'Airdrops are gross income at FMV when received' },\n      { section: 'Rev. Rul. 2019-24', title: 'Airdrop Tax Treatment', relevance: 'IRS confirms airdrops as ordinary income; taxable even if unsolicited' },\n      { section: 'IRC §6654', title: 'Failure to Pay Estimated Tax', relevance: 'Penalty for underpayment of estimated taxes on airdrop income' },\n    ],\n    eligibility: {\n      filingStatuses: ['single', 'mfj', 'mfs', 'hoh'],\n      entityTypes: ['sole_proprietorship', 'single_member_llc', 'partnership', 's_corp', 'individual'],\n      requirements: ['Anticipated or received crypto airdrop/TGE', 'Need to plan for tax impact'],\n      disqualifiers: [],\n    },\n    savingsEstimator: (income, marginalRate) => {\n      const airdropValue = income * 0.1\n      const penaltyAvoided = airdropValue * marginalRate * 0.05 // estimated underpayment penalty\n      return {\n        estimatedSavings: Math.round(penaltyAvoided + airdropValue * 0.02),\n        explanation: `Planning avoids estimated tax penalties (~${Math.round(penaltyAvoided).toLocaleString()}) and enables strategies like entity structuring and timing optimization.`,\n        confidence: 'low',\n        caveats: ['Actual savings depend on airdrop size and timing', 'Token value at receipt determines income', 'Liquidity risk if tokens are illiquid'],\n      }\n    },\n    implementationChecklist: [\n      { step: 1, action: 'Estimate expected airdrop value', details: 'Research token price at comparable projects. For pre-TGE: model scenarios at different price points.' },\n      { step: 2, action: 'Calculate estimated tax impact', details: 'Airdrop value × marginal rate = estimated tax. Add state tax. Add NIIT (3.8%) if AGI >$200K/$250K.' },\n      { step: 3, action: 'Set aside funds for tax liability', details: 'Reserve 30-50% of estimated airdrop value in liquid assets (stablecoins or USD) for tax payments.' },\n      { step: 4, action: 'Make quarterly estimated tax payment', deadline: 'Within quarter of receipt', details: 'File Form 1040-ES with payment to avoid underpayment penalties.' },\n      { step: 5, action: 'Consider entity structuring before TGE', professional: 'cpa', details: 'If TGE is >$50K, S-Corp election may reduce SE tax on staking-earned tokens. Must be structured BEFORE the event.' },\n      { step: 6, action: 'Document FMV at time of receipt', details: 'Screenshot exchange prices, CoinGecko data at exact time of token receipt. This becomes your cost basis.' },\n    ],\n    phaseOuts: [],\n    stateNotes: [],\n    auditRisk: 'medium',\n    auditNotes: 'IRS is actively targeting unreported airdrop income. Key: report ALL airdrops, even small ones. The FMV determination methodology should be documented.',\n    relatedStrategies: ['staking-entity-structure', 'tax-loss-harvesting-crypto', 'holding-period-optimization'],\n    tags: ['crypto', 'airdrop', 'tge', 'planning', 'income'],\n    effectiveForTaxYear: [2024, 2025, 2026],\n    complexity: 'moderate',\n  },\n\n  // ═══════════════════════════════════════════════════════════════════════════\n  // DEDUCTION STRATEGIES\n  // ═══════════════════════════════════════════════════════════════════════════\n\n  {\n    id: 'home-office-deduction',\n    name: 'Home Office Deduction (Actual Method)',\n    category: 'deductions',\n    subcategory: 'Business Use of Home',\n    summary: 'Deduct proportional home expenses (mortgage interest, property tax, utilities, insurance, repairs, depreciation) for dedicated office space.',\n    detailedDescription: 'The home office deduction allows self-employed individuals who use a dedicated portion of their home exclusively and regularly for business to deduct related expenses. Two methods: (1) Simplified method: $5 per sq ft, max 300 sq ft = $1,500 max. (2) Actual expense method: percentage of total home expenses based on square footage ratio. The actual method often yields significantly higher deductions and also allows depreciation of the home (which reduces basis but provides current deduction).',\n    ircReferences: [\n      { section: 'IRC §280A', title: 'Disallowance of Certain Expenses in Connection with Business Use of Home', relevance: 'Primary home office deduction rules' },\n      { section: 'IRC §280A(c)(1)', title: 'Exclusive and Regular Use Test', relevance: 'Space must be used exclusively and regularly for business' },\n      { section: 'IRS Pub. 587', title: 'Business Use of Your Home', relevance: 'Detailed IRS guidance on calculation methods' },\n    ],\n    eligibility: {\n      filingStatuses: ['single', 'mfj', 'mfs', 'hoh'],\n      entityTypes: ['sole_proprietorship', 'single_member_llc'],\n      requirements: ['Dedicated space used exclusively for business', 'Regular and exclusive use', 'Principal place of business OR place to meet clients'],\n      disqualifiers: ['Space used for personal and business (not exclusive)', 'Employee using home office for employer convenience (different rules)', 'S-Corp/C-Corp owners (deducted differently via accountable plan)'],\n    },\n    savingsEstimator: (income, marginalRate) => {\n      // Assume 200 sq ft office in 2000 sq ft home (10%), $30K annual home costs\n      const homeExpenses = 30000\n      const businessPct = 0.10\n      const deduction = homeExpenses * businessPct // $3,000\n      const savings = deduction * (marginalRate + 0.1413) // income tax + SE tax\n      return {\n        estimatedSavings: Math.round(savings),\n        explanation: `Estimated 10% business use on $30K home expenses = $${deduction.toLocaleString()} deduction. Saves at ${(marginalRate * 100).toFixed(0)}% income tax + 14.1% SE tax = ~$${Math.round(savings).toLocaleString()}.`,\n        confidence: 'medium',\n        caveats: ['Actual savings depend on home size, expenses, and office square footage', 'Depreciation reduces home basis (recaptured at sale)', 'Must maintain exclusive use — no dual-purpose space'],\n      }\n    },\n    implementationChecklist: [\n      { step: 1, action: 'Measure your dedicated office space', details: 'Record exact square footage. Must be a dedicated space — not a kitchen table or living room corner.' },\n      { step: 2, action: 'Calculate business use percentage', details: 'Office sq ft ÷ total home sq ft = business percentage. Keep floor plan documentation.' },\n      { step: 3, action: 'Track all home expenses', details: 'Mortgage interest, property taxes, insurance, utilities, repairs, maintenance, HOA fees. Keep receipts.' },\n      { step: 4, action: 'Claim on Schedule C (Form 8829)', deadline: 'Tax filing deadline', details: 'File Form 8829 (Expenses for Business Use of Your Home) with Schedule C.' },\n      { step: 5, action: 'Take photos of your office space', details: 'Document the dedicated space for audit protection. Date-stamped photos showing exclusive business use.' },\n    ],\n    phaseOuts: [],\n    stateNotes: [\n      { states: ['CA'], note: 'California conforms to federal home office rules. State deduction available.', impact: 'positive' },\n    ],\n    auditRisk: 'medium',\n    auditNotes: 'Home office is a known audit trigger, but the IRS has indicated it focuses on the exclusivity test rather than blanket auditing. Key: maintain clear documentation of exclusive business use.',\n    relatedStrategies: ['vehicle-deduction', 'health-insurance-deduction', 'se-tax-deduction'],\n    tags: ['deduction', 'home-office', 'self-employed', 'se-tax-reduction'],\n    effectiveForTaxYear: [2024, 2025, 2026],\n    complexity: 'simple',\n  },\n\n  {\n    id: 'health-insurance-deduction',\n    name: 'Self-Employed Health Insurance Deduction',\n    category: 'health_benefits',\n    subcategory: 'Above-the-Line Deduction',\n    summary: 'Deduct 100% of health, dental, and vision insurance premiums for yourself, spouse, and dependents as an above-the-line deduction.',\n    detailedDescription: 'Self-employed individuals can deduct health insurance premiums as an above-the-line deduction (Line 17 of Schedule 1), which reduces both income tax AND the basis for the QBI deduction. This deduction is available even if you don\\u2019t itemize. For S-Corp owners, the premiums must be paid by or reimbursed by the S-Corp and included on the shareholder\\u2019s W-2.',\n    ircReferences: [\n      { section: 'IRC §162(l)', title: 'Special Rules for Health Insurance Costs of Self-Employed Individuals', relevance: 'Establishes the above-the-line deduction for SE health premiums' },\n      { section: 'Rev. Rul. 91-26', title: 'S-Corp Health Insurance', relevance: 'S-Corp must pay premiums and include on W-2 for >2% shareholder-employees' },\n    ],\n    eligibility: {\n      filingStatuses: ['single', 'mfj', 'mfs', 'hoh'],\n      entityTypes: ['sole_proprietorship', 'single_member_llc', 'partnership', 's_corp'],\n      requirements: ['Self-employed with net profit', 'Not eligible for employer-subsidized health plan (yours or spouse\\u2019s)'],\n      disqualifiers: ['Eligible for employer health plan through spouse', 'Months where you were eligible for employer plan'],\n    },\n    savingsEstimator: (income, marginalRate) => {\n      const premiums = 12000 // average individual premium\n      const savings = premiums * marginalRate // saves on income tax (not SE tax, but reduces QBI)\n      return {\n        estimatedSavings: Math.round(savings),\n        explanation: `$${premiums.toLocaleString()} annual premiums × ${(marginalRate * 100).toFixed(0)}% rate = ~$${Math.round(savings).toLocaleString()} savings. Also reduces QBI computation.`,\n        confidence: 'high',\n        caveats: ['Cannot exceed net SE income', 'Not deductible for months eligible for employer plan', 'Does not reduce SE tax directly (but reduces QBI)'],\n      }\n    },\n    implementationChecklist: [\n      { step: 1, action: 'Ensure you have qualifying health insurance', details: 'Medical, dental, vision, and qualified long-term care insurance all qualify.' },\n      { step: 2, action: 'For S-Corp: set up proper reimbursement', details: 'S-Corp must pay or reimburse premiums and report on W-2 box 1 (not boxes 3/5 — exempt from FICA).', professional: 'cpa' },\n      { step: 3, action: 'Claim deduction on Schedule 1, Line 17', deadline: 'Tax filing deadline', details: 'Report total qualifying premiums. Limited to net SE income for the year.' },\n    ],\n    phaseOuts: [],\n    stateNotes: [\n      { states: ['NJ'], note: 'New Jersey does not allow the SE health insurance deduction. Must add back on NJ return.', impact: 'negative' },\n    ],\n    auditRisk: 'low',\n    auditNotes: 'Very common deduction. Keep insurance statements and proof of payment.',\n    relatedStrategies: ['s-corp-election', 'hsa-contribution', 'home-office-deduction'],\n    tags: ['health', 'deduction', 'above-the-line', 'self-employed'],\n    effectiveForTaxYear: [2024, 2025, 2026],\n    complexity: 'simple',\n  },\n\n  {\n    id: 'hsa-contribution',\n    name: 'Health Savings Account (HSA) Triple Tax Advantage',\n    category: 'health_benefits',\n    subcategory: 'Tax-Advantaged Savings',\n    summary: 'Contribute up to $4,300 (individual) / $8,550 (family) with pre-tax dollars, tax-free growth, and tax-free qualified withdrawals.',\n    detailedDescription: 'HSAs are the only \"triple tax advantage\" account in the tax code: contributions are tax-deductible, investment growth is tax-free, and withdrawals for qualified medical expenses are tax-free. For self-employed individuals with high-deductible health plans, the HSA doubles as a stealth retirement account — after age 65, withdrawals for any purpose are taxed as ordinary income (like a traditional IRA) but with no RMDs.',\n    ircReferences: [\n      { section: 'IRC §223', title: 'Health Savings Accounts', relevance: 'Establishes HSA rules, contribution limits, and eligibility' },\n      { section: 'IRC §223(b)', title: 'HSA Contribution Limits', relevance: '$4,300 individual / $8,550 family for 2025, plus $1,000 catch-up for 55+' },\n      { section: 'IRC §223(c)(2)', title: 'High Deductible Health Plan Requirements', relevance: 'Min deductible: $1,650 individual / $3,300 family; max OOP: $8,300 / $16,600 for 2025' },\n    ],\n    eligibility: {\n      filingStatuses: ['single', 'mfj', 'mfs', 'hoh'],\n      entityTypes: ['sole_proprietorship', 'single_member_llc', 'partnership', 's_corp', 'individual'],\n      requirements: ['Enrolled in qualifying High Deductible Health Plan (HDHP)', 'Not enrolled in Medicare', 'Not claimed as dependent on another return', 'No disqualifying coverage'],\n      disqualifiers: ['Medicare enrollment', 'Non-HDHP health insurance', 'Full-purpose FSA enrollment'],\n    },\n    savingsEstimator: (income, marginalRate) => {\n      const contribution = 4300 // individual\n      const incomeTaxSaved = contribution * marginalRate\n      const seTaxSaved = contribution * 0.0765 // HSA deduction reduces SE income for employee portion\n      const totalSavings = incomeTaxSaved + seTaxSaved\n      return {\n        estimatedSavings: Math.round(totalSavings),\n        explanation: `$${contribution.toLocaleString()} contribution saves $${Math.round(incomeTaxSaved).toLocaleString()} income tax + ~$${Math.round(seTaxSaved).toLocaleString()} in FICA equivalent. Plus tax-free growth and withdrawals for medical.`,\n        confidence: 'high',\n        caveats: ['Must have qualifying HDHP', 'Family contribution limit is $8,550', 'Non-medical withdrawals before 65 incur 20% penalty + income tax'],\n      }\n    },\n    implementationChecklist: [\n      { step: 1, action: 'Verify HDHP enrollment', details: 'Confirm your health plan meets minimum deductible ($1,650 individual / $3,300 family) and maximum OOP requirements.' },\n      { step: 2, action: 'Open HSA account', details: 'Fidelity (no fees, broad investments) or Lively/HSA Bank for self-employed. Avoid HSAs with high fees.' },\n      { step: 3, action: 'Contribute maximum by April 15', deadline: 'April 15 of following year', details: 'Can contribute for prior tax year up to April 15. Set up monthly transfers to spread contributions.' },\n      { step: 4, action: 'Invest HSA funds for long-term growth', details: 'Treat as retirement account: invest in index funds, not savings. Keep separate funds for near-term medical expenses.' },\n      { step: 5, action: 'Save medical receipts indefinitely', details: 'You can reimburse yourself from HSA for past expenses at any time in the future. Keep receipt archive.' },\n    ],\n    phaseOuts: [],\n    stateNotes: [\n      { states: ['CA', 'NJ'], note: 'California and New Jersey do NOT recognize HSA deductions or tax-free growth. HSA contributions are taxable, and investment gains are taxable at state level.', impact: 'negative' },\n      { states: ['AL', 'WI'], note: 'These states have limited HSA conformity. Check current state treatment.', impact: 'negative' },\n    ],\n    auditRisk: 'low',\n    auditNotes: 'Well-established tax-advantaged account. Key: ensure HDHP eligibility and stay within contribution limits.',\n    relatedStrategies: ['health-insurance-deduction', 'solo-401k', 'defined-benefit'],\n    tags: ['health', 'savings', 'triple-tax-advantage', 'retirement'],\n    effectiveForTaxYear: [2024, 2025, 2026],\n    complexity: 'simple',\n  },\n\n  // ═══════════════════════════════════════════════════════════════════════════\n  // TIMING & INCOME STRATEGIES\n  // ═══════════════════════════════════════════════════════════════════════════\n\n  {\n    id: 'quarterly-estimated-optimization',\n    name: 'Quarterly Estimated Tax Payment Optimization',\n    category: 'compliance',\n    subcategory: 'Payment Timing',\n    summary: 'Optimize estimated tax payments to avoid underpayment penalties while preserving cash flow.',\n    detailedDescription: 'Self-employed individuals must make quarterly estimated tax payments (Form 1040-ES). The safe harbor rules allow you to avoid penalties by paying either (1) 100% of prior year tax (110% if AGI >$150K), or (2) 90% of current year tax. The annualized income installment method (Form 2210, Schedule AI) can reduce earlier payments if income is uneven throughout the year. This is critical for entrepreneurs with lumpy income from project completions, TGE events, or seasonal businesses.',\n    ircReferences: [\n      { section: 'IRC §6654', title: 'Failure to Pay Estimated Income Tax', relevance: 'Underpayment penalty rules and safe harbor provisions' },\n      { section: 'IRC §6654(d)(1)(B)', title: 'Safe Harbor', relevance: '100%/110% prior year safe harbor' },\n      { section: 'IRC §6654(d)(2)', title: 'Annualized Income Installment Method', relevance: 'Reduces estimated payments when income is uneven' },\n    ],\n    eligibility: {\n      filingStatuses: ['single', 'mfj', 'mfs', 'hoh'],\n      entityTypes: ['sole_proprietorship', 'single_member_llc', 'partnership', 's_corp'],\n      requirements: ['Expected tax liability >$1,000', 'Self-employment or other non-withheld income'],\n      disqualifiers: [],\n    },\n    savingsEstimator: (income, marginalRate) => {\n      const estimatedTax = income * marginalRate * 0.7\n      const cashFlowBenefit = estimatedTax * 0.05 * 0.25 // 5% opportunity cost saved for 3 months average\n      return {\n        estimatedSavings: Math.round(cashFlowBenefit + 500), // + penalty avoidance value\n        explanation: `Optimized payment timing preserves cash flow (est. $${Math.round(cashFlowBenefit).toLocaleString()} opportunity value) and avoids ~$500+ in underpayment penalties.`,\n        confidence: 'medium',\n        caveats: ['Must still pay enough to meet safe harbor', 'Annualized method requires detailed income tracking'],\n      }\n    },\n    implementationChecklist: [\n      { step: 1, action: 'Calculate safe harbor amount', details: 'Pull prior year total tax from Form 1040. If AGI >$150K, safe harbor is 110%. Divide by 4 for quarterly payments.' },\n      { step: 2, action: 'Set quarterly payment reminders', deadline: 'April 15, June 15, September 15, January 15', details: 'Mark all four dates. Late payments accrue penalties even if annual total is correct.' },\n      { step: 3, action: 'Consider annualized income method for uneven income', details: 'If most income arrives in Q3/Q4, Form 2210 Schedule AI can reduce Q1/Q2 payments.', professional: 'cpa' },\n      { step: 4, action: 'File Form 1040-ES with each payment', details: 'Pay via IRS Direct Pay (irs.gov), EFTPS, or mail Form 1040-ES voucher.' },\n    ],\n    phaseOuts: [],\n    stateNotes: [\n      { states: ['IL'], note: 'Illinois quarterly estimates due on same federal schedule with additional IL-1040-ES.', impact: 'neutral' },\n      { states: ['CA'], note: 'California estimated tax due dates differ: April 15, June 15, and January 15 (no September payment — 3 installments).', impact: 'neutral' },\n    ],\n    auditRisk: 'low',\n    auditNotes: 'No audit risk from optimizing estimated payments. Risk only from underpayment.',\n    relatedStrategies: ['s-corp-election', 'income-deferral'],\n    tags: ['compliance', 'cash-flow', 'estimated-taxes', 'penalties'],\n    effectiveForTaxYear: [2024, 2025, 2026],\n    complexity: 'simple',\n  },\n]\n\n// ─── Lookup Helpers ─────────────────────────────────────────────────────────\n\nexport function getStrategyById(id: string): TaxStrategy | undefined {\n  return STRATEGY_DATABASE.find(s => s.id === id)\n}\n\nexport function getStrategiesByCategory(category: StrategyCategory): TaxStrategy[] {\n  return STRATEGY_DATABASE.filter(s => s.category === category)\n}\n\nexport function getStrategiesByTags(tags: string[]): TaxStrategy[] {\n  return STRATEGY_DATABASE.filter(s => tags.some(t => s.tags.includes(t)))\n}\n\nexport function searchStrategies(query: string): TaxStrategy[] {\n  const q = query.toLowerCase()\n  return STRATEGY_DATABASE.filter(s =>\n    s.name.toLowerCase().includes(q) ||\n    s.summary.toLowerCase().includes(q) ||\n    s.tags.some(t => t.includes(q)) ||\n    s.ircReferences.some(r => r.section.toLowerCase().includes(q) || r.title.toLowerCase().includes(q))\n  )\n}\n\nexport function estimateAllStrategySavings(income: number, marginalRate: number, filingStatus: string): { strategy: TaxStrategy; savings: SavingsEstimate }[] {\n  return STRATEGY_DATABASE\n    .map(strategy => ({\n      strategy,\n      savings: strategy.savingsEstimator(income, marginalRate, filingStatus),\n    }))\n    .filter(r => r.savings.estimatedSavings > 0)\n    .sort((a, b) => b.savings.estimatedSavings - a.savings.estimatedSavings)\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\tax-calculator.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'beforeEach' is defined but never used.","line":5,"column":32,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":42,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"beforeEach"},"fix":{"range":[155,167],"text":""},"desc":"Remove unused variable \"beforeEach\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TaxReport' is defined but never used.","line":12,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":17,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TaxReport"},"fix":{"range":[318,336],"text":""},"desc":"Remove unused variable \"TaxReport\"."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Tax Calculator — Core Test Suite\n * Validates: brackets, QBI/SSTB, AMT, NIIT, SE tax, entity P&L, portfolio bridge\n */\nimport { describe, it, expect, beforeEach } from 'vitest'\nimport {\n  generateTaxReport,\n  calculateFederalIncomeTax,\n  calculateSelfEmploymentTax,\n  calculateQBIDeduction,\n  calculateMaxSEPIRA,\n  type TaxReport,\n} from './tax-calculator'\nimport { createDefaultState, type FortunaState } from './storage'\n\nfunction makeState(overrides: Partial<FortunaState> = {}): FortunaState {\n  return { ...createDefaultState(), ...overrides } as FortunaState\n}\n\n// ── Federal Bracket Tests ──────────────────────────────────────────────────\n\ndescribe('calculateFederalIncomeTax', () => {\n  it('should return 0 for zero income', () => {\n    expect(calculateFederalIncomeTax(0, 'single')).toBe(0)\n  })\n\n  it('should calculate correctly for the 10% bracket', () => {\n    // Single 10% bracket ends at $11,925\n    const tax = calculateFederalIncomeTax(10000, 'single')\n    expect(tax).toBe(1000) // 10% of $10,000\n  })\n\n  it('should span multiple brackets for $100k single', () => {\n    const tax = calculateFederalIncomeTax(100000, 'single')\n    // 10% on $11,925 = $1,192.50\n    // 12% on ($48,475 - $11,925) = $4,386\n    // 22% on ($103,350 - $48,475) = $12,072.50\n    // But only up to $100k: 22% on ($100,000 - $48,475) = $11,335.50\n    // Total ≈ $16,914\n    expect(tax).toBeGreaterThan(16000)\n    expect(tax).toBeLessThan(18000)\n  })\n\n  it('should calculate higher tax for married_joint at same income', () => {\n    const single = calculateFederalIncomeTax(200000, 'single')\n    const joint = calculateFederalIncomeTax(200000, 'married_joint')\n    // Joint brackets are wider, so less tax\n    expect(joint).toBeLessThan(single)\n  })\n})\n\n// ── Self-Employment Tax ────────────────────────────────────────────────────\n\ndescribe('calculateSelfEmploymentTax', () => {\n  it('should return 0 for zero SE income', () => {\n    expect(calculateSelfEmploymentTax(0).total).toBe(0)\n  })\n\n  it('should calculate 15.3% on low SE income', () => {\n    const result = calculateSelfEmploymentTax(50000)\n    // 92.35% of $50k = $46,175 → 15.3% = $7,064.78\n    expect(result.total).toBeGreaterThan(7000)\n    expect(result.total).toBeLessThan(7200)\n  })\n\n  it('should cap Social Security at wage base', () => {\n    // SE income of $200k: SS portion caps at $168,600 * 92.35% threshold\n    const low = calculateSelfEmploymentTax(100000)\n    const high = calculateSelfEmploymentTax(300000)\n    // Higher income pays more (Medicare), but SS is capped\n    const ratio = high.total / low.total\n    expect(ratio).toBeLessThan(3) // Not linear due to SS cap\n  })\n})\n\n// ── QBI Deduction ──────────────────────────────────────────────────────────\n\ndescribe('calculateQBIDeduction', () => {\n  it('should give full 20% below threshold', () => {\n    const qbi = calculateQBIDeduction(100000, 150000, 'single', false)\n    expect(qbi).toBe(20000) // 20% of $100k\n  })\n\n  it('should give full 20% for SSTB below threshold', () => {\n    const qbi = calculateQBIDeduction(100000, 150000, 'single', true)\n    expect(qbi).toBe(20000) // Below threshold, SSTB doesn't matter\n  })\n\n  it('should phase out SSTB to zero above threshold+range', () => {\n    // Single threshold $191,950 + $50,000 range = $241,950\n    const qbi = calculateQBIDeduction(100000, 250000, 'single', true)\n    expect(qbi).toBe(0)\n  })\n\n  it('should partially reduce SSTB in phaseout range', () => {\n    // Midpoint of phaseout: $191,950 + $25,000 = $216,950\n    // Must provide w2Wages for non-zero result (wage limitation applies in phaseout)\n    const full = calculateQBIDeduction(100000, 150000, 'single', true, 80000)\n    const partial = calculateQBIDeduction(100000, 216950, 'single', true, 80000)\n    expect(partial).toBeGreaterThan(0)\n    expect(partial).toBeLessThan(full)\n  })\n\n  it('should use joint thresholds for married_joint', () => {\n    // Joint threshold is $383,900\n    const qbi = calculateQBIDeduction(100000, 350000, 'married_joint', true)\n    expect(qbi).toBe(20000) // Still below joint threshold\n  })\n})\n\n// ── Full Tax Report ────────────────────────────────────────────────────────\n\ndescribe('generateTaxReport', () => {\n  it('should generate a valid report for minimal state', () => {\n    const state = makeState({\n      profile: { name: 'Test', state: 'IL', filingStatus: 'single' },\n      incomeStreams: [],\n      expenses: [],\n      entities: [],\n      deductions: [],\n    })\n    const report = generateTaxReport(state)\n    expect(report.grossIncome).toBe(0)\n    expect(report.totalTax).toBe(0)\n    expect(report.effectiveRate).toBe(0)\n  })\n\n  it('should compute taxes for W-2 income', () => {\n    const state = makeState({\n      profile: { name: 'Test', state: 'IL', filingStatus: 'single' },\n      incomeStreams: [\n        { id: 'w2-1', name: 'Job', type: 'w2', annualAmount: 100000, isActive: true },\n      ],\n      expenses: [],\n      entities: [],\n      deductions: [],\n    })\n    const report = generateTaxReport(state)\n    expect(report.grossIncome).toBe(100000)\n    expect(report.w2Income).toBe(100000)\n    expect(report.selfEmploymentIncome).toBe(0)\n    expect(report.selfEmploymentTax).toBe(0) // W-2 has no SE tax\n    expect(report.federalIncomeTax).toBeGreaterThan(0)\n    expect(report.effectiveRate).toBeGreaterThan(0)\n    expect(report.effectiveRate).toBeLessThan(0.4)\n  })\n\n  it('should compute SE tax for freelance income', () => {\n    const state = makeState({\n      profile: { name: 'Test', state: 'TX', filingStatus: 'single' },\n      incomeStreams: [\n        { id: 'se-1', name: 'Freelance', type: 'freelance', annualAmount: 80000, isActive: true },\n      ],\n      expenses: [],\n      entities: [],\n      deductions: [],\n    })\n    const report = generateTaxReport(state)\n    expect(report.selfEmploymentIncome).toBe(80000)\n    expect(report.selfEmploymentTax).toBeGreaterThan(0)\n    // SE deduction should be half of SE tax\n    expect(report.seDeduction).toBeCloseTo(report.selfEmploymentTax / 2, -1)\n  })\n\n  it('should include entity breakdown', () => {\n    const state = makeState({\n      profile: { name: 'Test', state: 'IL', filingStatus: 'single' },\n      incomeStreams: [\n        { id: 'biz-1', name: 'Consulting', type: 'business', annualAmount: 150000, isActive: true, entityId: 'llc-1' },\n      ],\n      expenses: [\n        { id: 'exp-1', category: 'office_expense', description: 'Software', annualAmount: 5000, isDeductible: true, deductionPct: 100, entityId: 'llc-1' },\n      ],\n      entities: [\n        { id: 'llc-1', name: 'My LLC', type: 'llc', state: 'IL', annualCost: 500, isActive: true },\n      ],\n      deductions: [],\n    })\n    const report = generateTaxReport(state)\n    expect(report.entityBreakdown.length).toBeGreaterThan(0)\n    const llc = report.entityBreakdown.find(e => e.entityId === 'llc-1')\n    expect(llc).toBeDefined()\n    expect(llc!.revenue).toBe(150000)\n  })\n\n  it('should bridge portfolio realized gains into investmentIncome', () => {\n    const state = makeState({\n      profile: { name: 'Test', state: 'TX', filingStatus: 'single' },\n      incomeStreams: [],\n      expenses: [],\n      entities: [],\n      deductions: [],\n      portfolioTaxEvents: [\n        { realized: true, taxYear: new Date().getFullYear(), estimatedAmount: 25000, taxTreatment: 'short_term_cg' },\n        { realized: true, taxYear: new Date().getFullYear(), estimatedAmount: 15000, taxTreatment: 'long_term_cg' },\n      ],\n    })\n    const report = generateTaxReport(state)\n    expect(report.investmentIncome).toBe(40000)\n    expect(report.shortTermPortfolioGains).toBe(25000)\n    expect(report.longTermPortfolioGains).toBe(15000)\n    expect(report.grossIncome).toBe(40000)\n  })\n\n  it('should compute NIIT for high earners with investment income', () => {\n    const state = makeState({\n      profile: { name: 'Test', state: 'TX', filingStatus: 'single' },\n      incomeStreams: [\n        { id: 'w2-1', name: 'Job', type: 'w2', annualAmount: 180000, isActive: true },\n        { id: 'inv-1', name: 'Dividends', type: 'investment', annualAmount: 50000, isActive: true },\n      ],\n      expenses: [],\n      entities: [],\n      deductions: [],\n    })\n    const report = generateTaxReport(state)\n    // AGI $230,000 > NIIT threshold $200,000\n    // NII = $50,000, excess = $30,000\n    // NIIT = min($50k, $30k) * 3.8% = $1,140\n    expect(report.niit).toBeGreaterThan(0)\n    expect(report.niit).toBeLessThan(2000)\n  })\n\n  it('should compute AMT when applicable', () => {\n    const state = makeState({\n      profile: { name: 'Test', state: 'CA', filingStatus: 'single' },\n      incomeStreams: [\n        { id: 'w2-1', name: 'Job', type: 'w2', annualAmount: 500000, isActive: true },\n      ],\n      expenses: [],\n      entities: [],\n      deductions: [\n        { id: 'd-1', name: 'SALT', category: 'other', amount: 50000, isItemized: true },\n      ],\n    })\n    const report = generateTaxReport(state)\n    // At $500k with large SALT deduction, AMT may kick in\n    expect(report.amt).toBeGreaterThanOrEqual(0) // May or may not trigger\n  })\n})\n\n// ── SEP-IRA Calculation ────────────────────────────────────────────────────\n\ndescribe('calculateMaxSEPIRA', () => {\n  it('should return 25% of net SE for modest income', () => {\n    const max = calculateMaxSEPIRA(100000)\n    // After SE tax deduction: ~$92,935 → 25% ≈ $23,234\n    expect(max).toBeGreaterThan(20000)\n    expect(max).toBeLessThan(25000)\n  })\n\n  it('should cap at SEP-IRA annual limit', () => {\n    const max = calculateMaxSEPIRA(500000)\n    expect(max).toBeLessThanOrEqual(69000) // 2024 SEP-IRA max\n  })\n})\n\n// ── Kiddie Tax ─────────────────────────────────────────────────────────────\n\nimport { calculateKiddieTax, calculateUnderpaymentPenalty } from './tax-calculator'\n\ndescribe('calculateKiddieTax', () => {\n  it('should not apply when unearned income below threshold', () => {\n    const result = calculateKiddieTax(2000, 15, false, 0.32, 'married_joint')\n    expect(result.applies).toBe(false)\n    expect(result.kiddieTaxLiability).toBe(0)\n  })\n\n  it('should apply when unearned income above $2,500 and child under 19', () => {\n    const result = calculateKiddieTax(10000, 15, false, 0.32, 'married_joint')\n    expect(result.applies).toBe(true)\n    expect(result.kiddieTaxLiability).toBeGreaterThan(0)\n    // $1,250 tax-free + $1,250 at 10% + $7,500 at 32%\n    expect(result.taxAtChildRate).toBe(125) // $1,250 × 10%\n    expect(result.taxAtParentRate).toBe(2400) // $7,500 × 32%\n  })\n\n  it('should not apply when child age >= 19 and not student', () => {\n    const result = calculateKiddieTax(10000, 20, false, 0.32, 'single')\n    expect(result.applies).toBe(false)\n  })\n\n  it('should apply for students under 24', () => {\n    const result = calculateKiddieTax(10000, 22, true, 0.32, 'single')\n    expect(result.applies).toBe(true)\n  })\n})\n\n// ── Underpayment Penalty ───────────────────────────────────────────────────\n\ndescribe('calculateUnderpaymentPenalty', () => {\n  it('should waive penalty when total tax under $1,000', () => {\n    const result = calculateUnderpaymentPenalty(800, 5000, 100000, 2024, [], 0)\n    expect(result.waived).toBe(true)\n    expect(result.totalPenalty).toBe(0)\n  })\n\n  it('should waive when withholding covers prior year', () => {\n    const result = calculateUnderpaymentPenalty(50000, 40000, 200000, 2024, [], 45000)\n    expect(result.waived).toBe(true)\n  })\n\n  it('should compute safe harbor for high income (110% prior year)', () => {\n    const result = calculateUnderpaymentPenalty(50000, 40000, 200000, 2024, [], 0)\n    // AGI > $150k → 110% of prior year tax = $44,000\n    expect(result.safeHarborMethod).toBe('110%_prior')\n    expect(result.safeHarborAmount).toBeLessThanOrEqual(44000)\n  })\n\n  it('should calculate penalty on shortfall', () => {\n    const result = calculateUnderpaymentPenalty(50000, 20000, 100000, 2024, [\n      { quarter: 1, amount: 2000 },\n      { quarter: 2, amount: 2000 },\n    ], 0)\n    // Some quarters have shortfall\n    expect(result.quarters.filter(q => q.shortfall > 0).length).toBeGreaterThan(0)\n  })\n})\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\tax-calculator.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Deduction' is defined but never used.","line":6,"column":43,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":52,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Deduction"},"fix":{"range":[155,166],"text":""},"desc":"Remove unused variable \"Deduction\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'EntityType' is defined but never used.","line":6,"column":67,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":77,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"EntityType"},"fix":{"range":[179,191],"text":""},"desc":"Remove unused variable \"EntityType\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'SE_TAX_RATE' is assigned a value but never used.","line":56,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":56,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'parentFilingStatus' is defined but never used.","line":323,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":323,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'totalSEIncome' is assigned a value but never used.","line":661,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":661,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'totalSETaxable' is assigned a value but never used.","line":662,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":662,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":696,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":696,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[26301,26304],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[26301,26304],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":698,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":698,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[26390,26393],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[26390,26393],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":699,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":699,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[26500,26503],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[26500,26503],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":701,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":701,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[26612,26615],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[26612,26615],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":702,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":702,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[26760,26763],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[26760,26763],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'hasScorp' is assigned a value but never used.","line":741,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":741,"endColumn":17},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":951,"column":9,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":951,"endColumn":43,"suggestions":[{"messageId":"addBrackets","fix":{"range":[36412,37375],"text":"{ label = 'C-Corporation'\n        seTax = 0\n        annualCost = 5000\n        liabilityProtection = true\n        // C-Corp: 21% flat rate, then personal tax on distributions\n        const corpTax = netSEIncome * 0.21\n        const afterCorpIncome = netSEIncome - corpTax - annualCost\n        const personalTax = calculateFederalIncomeTax(Math.max(0, afterCorpIncome - standardDed), filingStatus)\n        const stTax = calculateStateTax(Math.max(0, afterCorpIncome - standardDed), stateCode)\n        return {\n          type, label,\n          totalTax: Math.round(corpTax + personalTax + stTax),\n          effectiveRate: (corpTax + personalTax + stTax) / netSEIncome,\n          seTax: 0,\n          federalTax: Math.round(corpTax + personalTax),\n          stateTax: stTax,\n          annualCost,\n          netAfterTax: Math.round(netSEIncome - corpTax - personalTax - stTax - annualCost),\n          liabilityProtection,\n          score: 0, // calculated below\n        } }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":952,"column":9,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":952,"endColumn":67,"suggestions":[{"messageId":"addBrackets","fix":{"range":[36412,37375],"text":"{ label = 'C-Corporation'\n        seTax = 0\n        annualCost = 5000\n        liabilityProtection = true\n        // C-Corp: 21% flat rate, then personal tax on distributions\n        const corpTax = netSEIncome * 0.21\n        const afterCorpIncome = netSEIncome - corpTax - annualCost\n        const personalTax = calculateFederalIncomeTax(Math.max(0, afterCorpIncome - standardDed), filingStatus)\n        const stTax = calculateStateTax(Math.max(0, afterCorpIncome - standardDed), stateCode)\n        return {\n          type, label,\n          totalTax: Math.round(corpTax + personalTax + stTax),\n          effectiveRate: (corpTax + personalTax + stTax) / netSEIncome,\n          seTax: 0,\n          federalTax: Math.round(corpTax + personalTax),\n          stateTax: stTax,\n          annualCost,\n          netAfterTax: Math.round(netSEIncome - corpTax - personalTax - stTax - annualCost),\n          liabilityProtection,\n          score: 0, // calculated below\n        } }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":953,"column":9,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":953,"endColumn":112,"suggestions":[{"messageId":"addBrackets","fix":{"range":[36412,37375],"text":"{ label = 'C-Corporation'\n        seTax = 0\n        annualCost = 5000\n        liabilityProtection = true\n        // C-Corp: 21% flat rate, then personal tax on distributions\n        const corpTax = netSEIncome * 0.21\n        const afterCorpIncome = netSEIncome - corpTax - annualCost\n        const personalTax = calculateFederalIncomeTax(Math.max(0, afterCorpIncome - standardDed), filingStatus)\n        const stTax = calculateStateTax(Math.max(0, afterCorpIncome - standardDed), stateCode)\n        return {\n          type, label,\n          totalTax: Math.round(corpTax + personalTax + stTax),\n          effectiveRate: (corpTax + personalTax + stTax) / netSEIncome,\n          seTax: 0,\n          federalTax: Math.round(corpTax + personalTax),\n          stateTax: stTax,\n          annualCost,\n          netAfterTax: Math.round(netSEIncome - corpTax - personalTax - stTax - annualCost),\n          liabilityProtection,\n          score: 0, // calculated below\n        } }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":954,"column":9,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":954,"endColumn":95,"suggestions":[{"messageId":"addBrackets","fix":{"range":[36412,37375],"text":"{ label = 'C-Corporation'\n        seTax = 0\n        annualCost = 5000\n        liabilityProtection = true\n        // C-Corp: 21% flat rate, then personal tax on distributions\n        const corpTax = netSEIncome * 0.21\n        const afterCorpIncome = netSEIncome - corpTax - annualCost\n        const personalTax = calculateFederalIncomeTax(Math.max(0, afterCorpIncome - standardDed), filingStatus)\n        const stTax = calculateStateTax(Math.max(0, afterCorpIncome - standardDed), stateCode)\n        return {\n          type, label,\n          totalTax: Math.round(corpTax + personalTax + stTax),\n          effectiveRate: (corpTax + personalTax + stTax) / netSEIncome,\n          seTax: 0,\n          federalTax: Math.round(corpTax + personalTax),\n          stateTax: stTax,\n          annualCost,\n          netAfterTax: Math.round(netSEIncome - corpTax - personalTax - stTax - annualCost),\n          liabilityProtection,\n          score: 0, // calculated below\n        } }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":1032,"column":64,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":1032,"endColumn":93}],"suppressedMessages":[],"errorCount":17,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine - Tax Calculator\n * Real federal + state + SE tax calculations using 2024/2025 brackets\n */\n\nimport type { FortunaState, IncomeStream, Deduction, LegalEntity, EntityType } from './storage'\n\n// ==================== 2024 Federal Tax Brackets ====================\nconst FEDERAL_BRACKETS_2024 = {\n  single: [\n    { min: 0, max: 11600, rate: 0.10 },\n    { min: 11600, max: 47150, rate: 0.12 },\n    { min: 47150, max: 100525, rate: 0.22 },\n    { min: 100525, max: 191950, rate: 0.24 },\n    { min: 191950, max: 243725, rate: 0.32 },\n    { min: 243725, max: 609350, rate: 0.35 },\n    { min: 609350, max: Infinity, rate: 0.37 },\n  ],\n  married_joint: [\n    { min: 0, max: 23200, rate: 0.10 },\n    { min: 23200, max: 94300, rate: 0.12 },\n    { min: 94300, max: 201050, rate: 0.22 },\n    { min: 201050, max: 383900, rate: 0.24 },\n    { min: 383900, max: 487450, rate: 0.32 },\n    { min: 487450, max: 731200, rate: 0.35 },\n    { min: 731200, max: Infinity, rate: 0.37 },\n  ],\n  married_separate: [\n    { min: 0, max: 11600, rate: 0.10 },\n    { min: 11600, max: 47150, rate: 0.12 },\n    { min: 47150, max: 100525, rate: 0.22 },\n    { min: 100525, max: 191950, rate: 0.24 },\n    { min: 191950, max: 243725, rate: 0.32 },\n    { min: 243725, max: 365600, rate: 0.35 },\n    { min: 365600, max: Infinity, rate: 0.37 },\n  ],\n  head_of_household: [\n    { min: 0, max: 16550, rate: 0.10 },\n    { min: 16550, max: 63100, rate: 0.12 },\n    { min: 63100, max: 100500, rate: 0.22 },\n    { min: 100500, max: 191950, rate: 0.24 },\n    { min: 191950, max: 243700, rate: 0.32 },\n    { min: 243700, max: 609350, rate: 0.35 },\n    { min: 609350, max: Infinity, rate: 0.37 },\n  ],\n}\n\nconst STANDARD_DEDUCTION_2024: Record<string, number> = {\n  single: 14600,\n  married_joint: 29200,\n  married_separate: 14600,\n  head_of_household: 21900,\n}\n\n// SE Tax constants\nconst SE_TAX_RATE = 0.153 // 15.3% (12.4% SS + 2.9% Medicare)\nconst SS_WAGE_BASE_2024 = 168600\nconst SE_DEDUCTIBLE_FRACTION = 0.9235 // Only 92.35% of SE income subject\nconst ADDITIONAL_MEDICARE_THRESHOLD_SINGLE = 200000\nconst ADDITIONAL_MEDICARE_RATE = 0.009 // 0.9%\n\n// QBI deduction\nconst QBI_RATE = 0.20\nconst QBI_THRESHOLD_SINGLE = 191950\nconst QBI_THRESHOLD_JOINT = 383900\n\n// SEP-IRA / Solo 401k limits\nconst SEP_IRA_MAX_2024 = 69000\nconst SEP_IRA_RATE = 0.25 // 25% of net SE income\nconst SOLO_401K_EMPLOYEE_MAX = 23000 // Under 50\n\n// AMT (Alternative Minimum Tax) 2024\nconst AMT_EXEMPTION: Record<string, number> = {\n  single: 85700, married_joint: 133300, married_separate: 66650, head_of_household: 85700,\n}\nconst AMT_PHASEOUT_START: Record<string, number> = {\n  single: 609350, married_joint: 1218700, married_separate: 609350, head_of_household: 609350,\n}\nconst AMT_RATE_1 = 0.26\nconst AMT_RATE_2 = 0.28\nconst AMT_RATE_2_THRESHOLD: Record<string, number> = {\n  single: 232600, married_joint: 232600, married_separate: 116300, head_of_household: 232600,\n}\n\n// NIIT (Net Investment Income Tax) 3.8%\nconst NIIT_RATE = 0.038\nconst NIIT_THRESHOLD: Record<string, number> = {\n  single: 200000, married_joint: 250000, married_separate: 125000, head_of_household: 200000,\n}\nconst SOLO_401K_EMPLOYEE_MAX_50PLUS = 30500\n\n// Kiddie Tax (Form 8615) — 2024\nconst KIDDIE_TAX_THRESHOLD = 2500 // First $1,250 tax-free, next $1,250 at child's rate\nconst KIDDIE_TAX_UNEARNED_LIMIT = 1250\nconst KIDDIE_TAX_AGE_LIMIT = 19 // Under 19, or under 24 if full-time student\nconst KIDDIE_TAX_STUDENT_AGE_LIMIT = 24\n\n// Underpayment Penalty (Form 2210) — 2024\nconst UNDERPAYMENT_PENALTY_RATE = 0.08 // IRS rate (adjusts quarterly, using recent rate)\nconst SAFE_HARBOR_PCT = 1.00 // 100% of prior year tax (110% if AGI > $150k)\nconst SAFE_HARBOR_HIGH_INCOME_PCT = 1.10\nconst SAFE_HARBOR_CURRENT_YEAR_PCT = 0.90 // 90% of current year tax\nconst HIGH_INCOME_THRESHOLD = 150000\n\n// State tax rates (simplified - using flat or effective rates)\nconst STATE_TAX_RATES: Record<string, { rate: number; type: 'flat' | 'progressive'; name: string }> = {\n  AL: { rate: 0.050, type: 'flat', name: 'Alabama' },\n  AK: { rate: 0, type: 'flat', name: 'Alaska' },\n  AZ: { rate: 0.025, type: 'flat', name: 'Arizona' },\n  AR: { rate: 0.044, type: 'flat', name: 'Arkansas' },\n  CA: { rate: 0.093, type: 'progressive', name: 'California' },\n  CO: { rate: 0.044, type: 'flat', name: 'Colorado' },\n  CT: { rate: 0.050, type: 'progressive', name: 'Connecticut' },\n  DE: { rate: 0.066, type: 'progressive', name: 'Delaware' },\n  FL: { rate: 0, type: 'flat', name: 'Florida' },\n  GA: { rate: 0.055, type: 'flat', name: 'Georgia' },\n  HI: { rate: 0.075, type: 'progressive', name: 'Hawaii' },\n  ID: { rate: 0.058, type: 'flat', name: 'Idaho' },\n  IL: { rate: 0.0495, type: 'flat', name: 'Illinois' },\n  IN: { rate: 0.0305, type: 'flat', name: 'Indiana' },\n  IA: { rate: 0.038, type: 'flat', name: 'Iowa' },\n  KS: { rate: 0.057, type: 'progressive', name: 'Kansas' },\n  KY: { rate: 0.040, type: 'flat', name: 'Kentucky' },\n  LA: { rate: 0.0425, type: 'progressive', name: 'Louisiana' },\n  ME: { rate: 0.0715, type: 'progressive', name: 'Maine' },\n  MD: { rate: 0.0575, type: 'progressive', name: 'Maryland' },\n  MA: { rate: 0.050, type: 'flat', name: 'Massachusetts' },\n  MI: { rate: 0.0425, type: 'flat', name: 'Michigan' },\n  MN: { rate: 0.0785, type: 'progressive', name: 'Minnesota' },\n  MS: { rate: 0.050, type: 'flat', name: 'Mississippi' },\n  MO: { rate: 0.048, type: 'progressive', name: 'Missouri' },\n  MT: { rate: 0.059, type: 'progressive', name: 'Montana' },\n  NE: { rate: 0.0564, type: 'progressive', name: 'Nebraska' },\n  NV: { rate: 0, type: 'flat', name: 'Nevada' },\n  NH: { rate: 0, type: 'flat', name: 'New Hampshire' },\n  NJ: { rate: 0.0675, type: 'progressive', name: 'New Jersey' },\n  NM: { rate: 0.059, type: 'progressive', name: 'New Mexico' },\n  NY: { rate: 0.0685, type: 'progressive', name: 'New York' },\n  NC: { rate: 0.045, type: 'flat', name: 'North Carolina' },\n  ND: { rate: 0.0195, type: 'progressive', name: 'North Dakota' },\n  OH: { rate: 0.035, type: 'progressive', name: 'Ohio' },\n  OK: { rate: 0.0475, type: 'progressive', name: 'Oklahoma' },\n  OR: { rate: 0.099, type: 'progressive', name: 'Oregon' },\n  PA: { rate: 0.0307, type: 'flat', name: 'Pennsylvania' },\n  RI: { rate: 0.0599, type: 'progressive', name: 'Rhode Island' },\n  SC: { rate: 0.064, type: 'progressive', name: 'South Carolina' },\n  SD: { rate: 0, type: 'flat', name: 'South Dakota' },\n  TN: { rate: 0, type: 'flat', name: 'Tennessee' },\n  TX: { rate: 0, type: 'flat', name: 'Texas' },\n  UT: { rate: 0.0465, type: 'flat', name: 'Utah' },\n  VT: { rate: 0.0875, type: 'progressive', name: 'Vermont' },\n  VA: { rate: 0.0575, type: 'progressive', name: 'Virginia' },\n  WA: { rate: 0, type: 'flat', name: 'Washington' },\n  WV: { rate: 0.0512, type: 'progressive', name: 'West Virginia' },\n  WI: { rate: 0.0765, type: 'progressive', name: 'Wisconsin' },\n  WY: { rate: 0, type: 'flat', name: 'Wyoming' },\n  DC: { rate: 0.085, type: 'progressive', name: 'District of Columbia' },\n}\n\n// ==================== Core Calculation Functions ====================\n\nexport function calculateFederalIncomeTax(taxableIncome: number, filingStatus: string): number {\n  const brackets = FEDERAL_BRACKETS_2024[filingStatus as keyof typeof FEDERAL_BRACKETS_2024] || FEDERAL_BRACKETS_2024.single\n  let tax = 0\n  let remaining = Math.max(0, taxableIncome)\n\n  for (const bracket of brackets) {\n    const taxable = Math.min(remaining, bracket.max - bracket.min)\n    if (taxable <= 0) break\n    tax += taxable * bracket.rate\n    remaining -= taxable\n  }\n\n  return Math.round(tax)\n}\n\nexport function calculateSelfEmploymentTax(netSEIncome: number): {\n  socialSecurity: number\n  medicare: number\n  additionalMedicare: number\n  total: number\n  deductibleHalf: number\n} {\n  const taxableBase = netSEIncome * SE_DEDUCTIBLE_FRACTION\n  const ssBase = Math.min(taxableBase, SS_WAGE_BASE_2024)\n  const socialSecurity = ssBase * 0.124\n  const medicare = taxableBase * 0.029\n  const additionalMedicare = taxableBase > ADDITIONAL_MEDICARE_THRESHOLD_SINGLE\n    ? (taxableBase - ADDITIONAL_MEDICARE_THRESHOLD_SINGLE) * ADDITIONAL_MEDICARE_RATE\n    : 0\n  const total = socialSecurity + medicare + additionalMedicare\n  const deductibleHalf = total / 2\n\n  return {\n    socialSecurity: Math.round(socialSecurity),\n    medicare: Math.round(medicare),\n    additionalMedicare: Math.round(additionalMedicare),\n    total: Math.round(total),\n    deductibleHalf: Math.round(deductibleHalf),\n  }\n}\n\nexport function calculateSCorpSavings(\n  netSEIncome: number,\n  reasonableSalary: number\n): {\n  currentSETax: number\n  sCorpSETax: number\n  savings: number\n  payrollTaxOnSalary: number\n  distributionAmount: number\n} {\n  // Current: full SE tax on all income\n  const currentSE = calculateSelfEmploymentTax(netSEIncome)\n\n  // S-Corp: only pay payroll tax on reasonable salary\n  const payrollTax = calculateSelfEmploymentTax(reasonableSalary)\n  const distributionAmount = netSEIncome - reasonableSalary\n\n  return {\n    currentSETax: currentSE.total,\n    sCorpSETax: payrollTax.total,\n    savings: currentSE.total - payrollTax.total,\n    payrollTaxOnSalary: payrollTax.total,\n    distributionAmount,\n  }\n}\n\nexport function calculateStateTax(taxableIncome: number, stateCode: string): number {\n  const state = STATE_TAX_RATES[stateCode]\n  if (!state) return 0\n  return Math.round(taxableIncome * state.rate)\n}\n\nexport function calculateQBIDeduction(\n  qbi: number,\n  taxableIncomeBeforeQBI: number,\n  filingStatus: string,\n  isSSTB: boolean = false,  // Specified Service Trade or Business (lawyers, doctors, consultants, etc.)\n  w2Wages: number = 0,      // W-2 wages paid by the business\n  qualifiedProperty: number = 0, // UBIA of qualified property\n): number {\n  const threshold = filingStatus === 'married_joint' ? QBI_THRESHOLD_JOINT : QBI_THRESHOLD_SINGLE\n  const phaseOutRange = filingStatus === 'married_joint' ? 100000 : 50000\n  const phaseOutEnd = threshold + phaseOutRange\n\n  // Below threshold: full 20% deduction regardless of SSTB status\n  if (taxableIncomeBeforeQBI <= threshold) {\n    return Math.round(qbi * QBI_RATE)\n  }\n\n  // SSTB: deduction phases to ZERO above threshold+phaseout\n  if (isSSTB) {\n    if (taxableIncomeBeforeQBI >= phaseOutEnd) return 0\n    // In phaseout range: reduce applicable QBI percentage\n    const phasePct = 1 - (taxableIncomeBeforeQBI - threshold) / phaseOutRange\n    const applicableQBI = qbi * phasePct\n    const applicableWages = w2Wages * phasePct\n    const applicableProperty = qualifiedProperty * phasePct\n    // Apply W-2/UBIA limitation on the phased amount\n    const wageLimit = Math.max(applicableWages * 0.50, applicableWages * 0.25 + applicableProperty * 0.025)\n    return Math.round(Math.min(applicableQBI * QBI_RATE, wageLimit * QBI_RATE))\n  }\n\n  // Non-SSTB above threshold: W-2 wage / UBIA limitation phases in\n  if (taxableIncomeBeforeQBI >= phaseOutEnd) {\n    // Fully subject to W-2/UBIA limitation\n    const wageLimit = Math.max(w2Wages * 0.50, w2Wages * 0.25 + qualifiedProperty * 0.025)\n    return Math.round(Math.min(qbi * QBI_RATE, wageLimit > 0 ? wageLimit : qbi * QBI_RATE))\n  }\n\n  // In phaseout range: blend between full deduction and limited\n  const phasePct = (taxableIncomeBeforeQBI - threshold) / phaseOutRange\n  const fullDeduction = qbi * QBI_RATE\n  const wageLimit = Math.max(w2Wages * 0.50, w2Wages * 0.25 + qualifiedProperty * 0.025)\n  const limitedDeduction = wageLimit > 0 ? Math.min(qbi * QBI_RATE, wageLimit) : fullDeduction\n  const reduction = (fullDeduction - limitedDeduction) * phasePct\n  return Math.round(fullDeduction - reduction)\n}\n\nexport function calculateMaxSEPIRA(netSEIncome: number): number {\n  // SEP-IRA max is 25% of net SE earnings (after SE tax deduction)\n  const seTax = calculateSelfEmploymentTax(netSEIncome)\n  const netAfterSE = netSEIncome - seTax.deductibleHalf\n  const maxContribution = Math.min(netAfterSE * SEP_IRA_RATE, SEP_IRA_MAX_2024)\n  return Math.round(Math.max(0, maxContribution))\n}\n\nexport function calculateMaxSolo401k(netSEIncome: number, age: number): {\n  employeeMax: number\n  employerMax: number\n  totalMax: number\n} {\n  const seTax = calculateSelfEmploymentTax(netSEIncome)\n  const netAfterSE = netSEIncome - seTax.deductibleHalf\n  const employeeMax = age >= 50 ? SOLO_401K_EMPLOYEE_MAX_50PLUS : SOLO_401K_EMPLOYEE_MAX\n  const employerMax = Math.min(netAfterSE * 0.25, SEP_IRA_MAX_2024 - employeeMax)\n  return {\n    employeeMax,\n    employerMax: Math.round(Math.max(0, employerMax)),\n    totalMax: Math.round(Math.min(employeeMax + Math.max(0, employerMax), SEP_IRA_MAX_2024)),\n  }\n}\n\n// ==================== Kiddie Tax (Form 8615) ====================\n\nexport interface KiddieTaxResult {\n  dependentName: string\n  age: number\n  unearnedIncome: number\n  taxAtChildRate: number\n  taxAtParentRate: number\n  kiddieTaxLiability: number\n  applies: boolean\n  reason: string\n}\n\nexport function calculateKiddieTax(\n  unearnedIncome: number,\n  dependentAge: number,\n  isStudent: boolean,\n  parentMarginalRate: number,\n  parentFilingStatus: string,\n): KiddieTaxResult {\n  const ageLimit = isStudent ? KIDDIE_TAX_STUDENT_AGE_LIMIT : KIDDIE_TAX_AGE_LIMIT\n  const applies = dependentAge < ageLimit && unearnedIncome > KIDDIE_TAX_THRESHOLD\n\n  if (!applies) {\n    return {\n      dependentName: '', age: dependentAge, unearnedIncome,\n      taxAtChildRate: 0, taxAtParentRate: 0, kiddieTaxLiability: 0,\n      applies: false,\n      reason: dependentAge >= ageLimit\n        ? `Age ${dependentAge} is at/above the ${ageLimit} limit`\n        : `Unearned income $${unearnedIncome.toLocaleString()} is below $${KIDDIE_TAX_THRESHOLD} threshold`,\n    }\n  }\n\n  // First $1,250: tax-free. Next $1,250: child's rate (10%). Above $2,500: parent's rate\n  const taxFreeAmount = KIDDIE_TAX_UNEARNED_LIMIT\n  const childRateAmount = Math.min(KIDDIE_TAX_UNEARNED_LIMIT, Math.max(0, unearnedIncome - taxFreeAmount))\n  const parentRateAmount = Math.max(0, unearnedIncome - KIDDIE_TAX_THRESHOLD)\n\n  const taxAtChildRate = Math.round(childRateAmount * 0.10)\n  const taxAtParentRate = Math.round(parentRateAmount * parentMarginalRate)\n\n  return {\n    dependentName: '', age: dependentAge, unearnedIncome,\n    taxAtChildRate, taxAtParentRate,\n    kiddieTaxLiability: taxAtChildRate + taxAtParentRate,\n    applies: true,\n    reason: `$${parentRateAmount.toLocaleString()} above $${KIDDIE_TAX_THRESHOLD} threshold taxed at parent's ${(parentMarginalRate * 100).toFixed(0)}% rate`,\n  }\n}\n\n/** Apply kiddie tax across all dependents with unearned income */\nexport function calculateAllKiddieTax(\n  state: FortunaState,\n  parentMarginalRate: number,\n): KiddieTaxResult[] {\n  const household = state.household\n  if (!household?.dependents?.length) return []\n\n  return household.dependents\n    .filter(d => d.unearnedIncome && d.unearnedIncome > 0)\n    .map(d => {\n      const result = calculateKiddieTax(\n        d.unearnedIncome!,\n        d.age,\n        d.isStudent || false,\n        parentMarginalRate,\n        state.profile.filingStatus,\n      )\n      result.dependentName = d.name\n      return result\n    })\n    .filter(r => r.applies)\n}\n\n// ==================== Underpayment Penalty (Form 2210) ====================\n\nexport interface UnderpaymentPenaltyResult {\n  annualRequired: number\n  safeHarborAmount: number\n  safeHarborMethod: '100%_prior' | '110%_prior' | '90%_current'\n  quarterlyRequired: number\n  quarters: {\n    quarter: 1 | 2 | 3 | 4\n    dueDate: string\n    required: number\n    paid: number\n    shortfall: number\n    daysLate: number\n    penalty: number\n  }[]\n  totalPenalty: number\n  waived: boolean\n  waiverReason?: string\n}\n\nexport function calculateUnderpaymentPenalty(\n  currentYearTax: number,\n  priorYearTax: number,\n  priorYearAGI: number,\n  taxYear: number,\n  payments: { quarter: number; amount: number; paidDate?: string }[],\n  withholdingTotal: number,\n): UnderpaymentPenaltyResult {\n  // Safe harbor: 100% of prior year (110% if AGI > $150k), or 90% of current year\n  const priorYearPct = priorYearAGI > HIGH_INCOME_THRESHOLD\n    ? SAFE_HARBOR_HIGH_INCOME_PCT : SAFE_HARBOR_PCT\n  const safeHarborPrior = Math.round(priorYearTax * priorYearPct)\n  const safeHarborCurrent = Math.round(currentYearTax * SAFE_HARBOR_CURRENT_YEAR_PCT)\n  const safeHarborAmount = Math.min(safeHarborPrior, safeHarborCurrent)\n  const safeHarborMethod = safeHarborAmount === safeHarborPrior\n    ? (priorYearPct > 1 ? '110%_prior' : '100%_prior') : '90%_current'\n\n  // Required estimated payments = safe harbor minus withholding\n  const annualRequired = Math.max(0, safeHarborAmount - withholdingTotal)\n  const quarterlyRequired = Math.round(annualRequired / 4)\n\n  const dueDates = [\n    { quarter: 1 as const, dueDate: `${taxYear}-04-15` },\n    { quarter: 2 as const, dueDate: `${taxYear}-06-15` },\n    { quarter: 3 as const, dueDate: `${taxYear}-09-15` },\n    { quarter: 4 as const, dueDate: `${taxYear + 1}-01-15` },\n  ]\n\n  const now = new Date()\n  let totalPenalty = 0\n\n  const quarters = dueDates.map(q => {\n    const payment = payments.find(p => p.quarter === q.quarter)\n    const paid = payment?.amount || 0\n    const shortfall = Math.max(0, quarterlyRequired - paid)\n\n    // Calculate days late (from due date to payment date or now)\n    const dueDate = new Date(q.dueDate)\n    const paidDate = payment?.paidDate ? new Date(payment.paidDate) : now\n    const daysLate = shortfall > 0 ? Math.max(0, Math.round((Math.min(paidDate.getTime(), now.getTime()) - dueDate.getTime()) / (1000 * 60 * 60 * 24))) : 0\n\n    // Penalty: daily rate on shortfall\n    const dailyRate = UNDERPAYMENT_PENALTY_RATE / 365\n    const penalty = Math.round(shortfall * dailyRate * daysLate)\n    totalPenalty += penalty\n\n    return {\n      quarter: q.quarter,\n      dueDate: q.dueDate,\n      required: quarterlyRequired,\n      paid,\n      shortfall,\n      daysLate,\n      penalty,\n    }\n  })\n\n  // Waiver: no penalty if total tax < $1,000 or if withholding covers 100% of prior year\n  const waived = currentYearTax < 1000 || withholdingTotal >= priorYearTax\n  if (waived) totalPenalty = 0\n\n  return {\n    annualRequired,\n    safeHarborAmount,\n    safeHarborMethod,\n    quarterlyRequired,\n    quarters,\n    totalPenalty: waived ? 0 : totalPenalty,\n    waived,\n    waiverReason: currentYearTax < 1000\n      ? 'Total tax under $1,000 — no penalty applies'\n      : withholdingTotal >= priorYearTax\n        ? 'W-2 withholding covers 100% of prior year tax'\n        : undefined,\n  }\n}\n\n// ==================== Comprehensive Tax Report ====================\n\n// ─── Entity-Level P&L (metamodel v9) ─────────────────────────────────\n\nexport interface EntityPnL {\n  entityId: string\n  entityName: string\n  entityType: string\n  revenue: number\n  expenses: number\n  depreciation: number\n  netIncome: number\n  // How this entity's income reaches the personal return\n  flowThrough: 'schedule_c' | 'k1' | 'w2_salary' | 'corporate' | 'personal'\n  seTaxableAmount: number   // Amount subject to SE tax\n  qbiEligibleAmount: number // Amount eligible for §199A\n  officerSalary: number     // S-Corp/C-Corp W-2 salary\n  distributions: number     // S-Corp distributions (not subject to SE)\n}\n\nexport interface TaxReport {\n  // Income\n  grossIncome: number\n  w2Income: number\n  selfEmploymentIncome: number\n  investmentIncome: number\n  otherIncome: number\n\n  // Adjustments\n  seDeduction: number\n  retirementDeduction: number\n  totalAdjustments: number\n  agi: number\n\n  // Deductions\n  standardDeduction: number\n  itemizedDeductions: number\n  deductionUsed: 'standard' | 'itemized'\n  deductionAmount: number\n  qbiDeduction: number\n\n  // Taxable Income\n  taxableIncome: number\n\n  // Taxes\n  federalIncomeTax: number\n  selfEmploymentTax: number\n  stateTax: number\n  amt: number                    // Alternative Minimum Tax\n  niit: number                   // Net Investment Income Tax (3.8%)\n  totalTax: number\n  effectiveRate: number\n  marginalRate: number\n\n  // Take-home\n  afterTaxIncome: number\n\n  // W-2 withholding tracking\n  w2FederalWithheld: number\n  w2StateWithheld: number\n  w2FICAWithheld: number\n  w2PretaxDeductions: number\n  w2EmployerMatch: number\n  netTaxOwed: number\n\n  // Optimization potential\n  maxSEPIRA: number\n  currentRetirementContributions: number\n  retirementGap: number\n  sCorpSavings: number\n  identifiedSavings: number\n\n  // Entity breakdown (metamodel v9)\n  entityBreakdown: EntityPnL[]\n\n  // Portfolio gains breakdown (v10.6)\n  shortTermPortfolioGains: number\n  longTermPortfolioGains: number\n}\n\nexport function generateTaxReport(state: FortunaState): TaxReport {\n  const { profile, incomeStreams, expenses, deductions, entities } = state\n\n  // ═══════════════════════════════════════════════════════════════════\n  //  PHASE 1: Build entity-level P&L\n  // ═══════════════════════════════════════════════════════════════════\n\n  // Collect all entity IDs (always include 'personal')\n  const entityIds = new Set<string>(['personal'])\n  for (const e of entities) if (e.isActive) entityIds.add(e.id)\n\n  // Build entity lookup\n  const entityMap = new Map<string, LegalEntity>()\n  for (const e of entities) entityMap.set(e.id, e)\n\n  // Group active income by entityId\n  const incomeByEntity = new Map<string, IncomeStream[]>()\n  for (const s of incomeStreams.filter(s => s.isActive)) {\n    const eid = s.entityId || 'personal'\n    if (!incomeByEntity.has(eid)) incomeByEntity.set(eid, [])\n    incomeByEntity.get(eid)!.push(s)\n  }\n\n  // Group expenses by entityId\n  const expenseByEntity = new Map<string, typeof expenses>()\n  for (const ex of expenses.filter(e => e.isDeductible)) {\n    const eid = ex.entityId || 'personal'\n    if (!expenseByEntity.has(eid)) expenseByEntity.set(eid, [])\n    expenseByEntity.get(eid)!.push(ex)\n  }\n\n  // Group depreciation by entityId\n  const depAssets = state.depreciationAssets || []\n  const depByEntity = new Map<string, number>()\n  for (const a of depAssets.filter(a => a.isActive)) {\n    const eid = a.entityId || 'personal'\n    // Simple annual depreciation estimate\n    const annualDep = a.method === 'section_179'\n      ? a.purchasePrice * (a.businessUsePct / 100)\n      : (a.purchasePrice - (a.salvageValue || 0)) / Math.max(1, a.usefulLifeYears) * (a.businessUsePct / 100)\n    depByEntity.set(eid, (depByEntity.get(eid) || 0) + annualDep)\n  }\n\n  // Compute per-entity P&L\n  const entityBreakdown: EntityPnL[] = []\n  let totalSEIncome = 0\n  let totalSETaxable = 0\n  let totalQBIEligible = 0\n  let totalOfficerSalary = 0\n\n  for (const eid of entityIds) {\n    const entityStreams = incomeByEntity.get(eid) || []\n    const entityExpenses = expenseByEntity.get(eid) || []\n    const entityDep = depByEntity.get(eid) || 0\n    const entity = entityMap.get(eid)\n    const entityType = entity?.type || 'personal'\n    const entityName = entity?.name || 'Personal'\n\n    const revenue = entityStreams.reduce((s, i) => s + i.annualAmount, 0)\n    const expenseTotal = entityExpenses.reduce((s, e) => s + (e.annualAmount * e.deductionPct / 100), 0)\n    const netIncome = Math.max(0, revenue - expenseTotal - entityDep)\n\n    // Determine flow-through type and SE tax treatment\n    let flowThrough: EntityPnL['flowThrough'] = 'personal'\n    let seTaxableAmount = 0\n    let qbiEligibleAmount = 0\n    let officerSalary = 0\n    let distributions = 0\n\n    if (eid === 'personal') {\n      // Personal income: W-2 not subject to SE, investments not SE\n      flowThrough = 'personal'\n      const seStreams = entityStreams.filter(s => ['business', 'freelance'].includes(s.type))\n      seTaxableAmount = seStreams.reduce((s, i) => s + i.annualAmount, 0) - expenseTotal - entityDep\n      seTaxableAmount = Math.max(0, seTaxableAmount)\n    } else if (entityType === 'sole_prop' || entityType === 'llc') {\n      // Schedule C: all net income subject to SE tax\n      flowThrough = 'schedule_c'\n      seTaxableAmount = netIncome\n      qbiEligibleAmount = netIncome\n    } else if (entityType === 'llc_scorp' || entityType === 'scorp') {\n      // S-Corp: salary subject to FICA, distributions are not\n      flowThrough = 'k1'\n      officerSalary = entity?.officerSalary || Math.round(netIncome * 0.6)\n      officerSalary = Math.min(officerSalary, netIncome) // Can't exceed net\n      distributions = Math.max(0, netIncome - officerSalary)\n      seTaxableAmount = 0 // Salary goes through payroll, not SE tax\n      qbiEligibleAmount = distributions // QBI on distributions\n      totalOfficerSalary += officerSalary\n    } else if (entityType === 'ccorp') {\n      // C-Corp: entity-level tax, salary is deductible\n      flowThrough = 'corporate'\n      officerSalary = entity?.officerSalary || Math.round(netIncome * 0.5)\n      officerSalary = Math.min(officerSalary, netIncome)\n      distributions = 0 // Dividends taxed separately (not modeled in basic calc)\n      totalOfficerSalary += officerSalary\n    } else if (entityType === 'partnership') {\n      flowThrough = 'k1'\n      const ownerPct = (entity?.ownershipPct || 100) / 100\n      seTaxableAmount = netIncome * ownerPct\n      qbiEligibleAmount = netIncome * ownerPct\n    }\n\n    totalSEIncome += (flowThrough === 'schedule_c' || eid === 'personal') ? seTaxableAmount : 0\n    totalSETaxable += seTaxableAmount\n    totalQBIEligible += qbiEligibleAmount\n\n    entityBreakdown.push({\n      entityId: eid,\n      entityName,\n      entityType,\n      revenue,\n      expenses: expenseTotal + entityDep,\n      depreciation: entityDep,\n      netIncome,\n      flowThrough,\n      seTaxableAmount,\n      qbiEligibleAmount,\n      officerSalary,\n      distributions,\n    })\n  }\n\n  // ═══════════════════════════════════════════════════════════════════\n  //  PHASE 2: Aggregate to personal return (backward-compatible)\n  // ═══════════════════════════════════════════════════════════════════\n\n  // Categorize income by type (for backward compat fields)\n  const w2Streams = incomeStreams.filter(s => s.type === 'w2' && s.isActive)\n  const w2Income = w2Streams.reduce((sum, s) => sum + s.annualAmount, 0) + totalOfficerSalary\n  const seIncome = incomeStreams\n    .filter(s => ['business', 'freelance'].includes(s.type) && s.isActive)\n    .reduce((sum, s) => sum + s.annualAmount, 0)\n  const investmentIncome = incomeStreams\n    .filter(s => s.type === 'investment' && s.isActive)\n    .reduce((sum, s) => sum + s.annualAmount, 0)\n\n  // Bridge portfolio realized gains from portfolioTaxEvents[]\n  const portfolioTaxEvents = (state as any).portfolioTaxEvents || []\n  const realizedGains = portfolioTaxEvents\n    .filter((e: any) => e.realized && e.taxYear === (state.taxYear || new Date().getFullYear()))\n    .reduce((sum: number, e: any) => sum + (e.estimatedAmount || 0), 0)\n  const shortTermPortfolioGains = portfolioTaxEvents\n    .filter((e: any) => e.realized && e.taxTreatment === 'short_term_cg' && e.taxYear === (state.taxYear || new Date().getFullYear()))\n    .reduce((sum: number, e: any) => sum + (e.estimatedAmount || 0), 0)\n  const longTermPortfolioGains = Math.max(0, realizedGains - shortTermPortfolioGains)\n\n  const totalInvestmentIncome = investmentIncome + realizedGains\n\n  const otherIncome = incomeStreams\n    .filter(s => ['rental', 'passive', 'other'].includes(s.type) && s.isActive)\n    .reduce((sum, s) => sum + s.annualAmount, 0)\n\n  const grossIncome = w2Income + seIncome + totalInvestmentIncome + otherIncome\n\n  // W-2 withholding\n  let w2FederalWithheld = 0, w2StateWithheld = 0, w2FICAWithheld = 0\n  let w2PretaxDeductions = 0, w2EmployerMatch = 0\n  for (const s of w2Streams) {\n    if (s.w2) {\n      w2FederalWithheld += s.w2.federalWithholding || 0\n      w2StateWithheld += s.w2.stateWithholding || 0\n      w2FICAWithheld += s.w2.ficaWithheld || 0\n      w2PretaxDeductions += (s.w2.pretax401k || 0) + (s.w2.pretaxHealthInsurance || 0)\n        + (s.w2.pretaxHSA || 0) + (s.w2.otherPretaxDeductions || 0)\n      w2EmployerMatch += s.w2.employerMatch401k || 0\n    }\n  }\n\n  // Business expenses total (entity-aware: sum across all entities)\n  const totalBusinessExpenses = entityBreakdown\n    .filter(e => e.entityId !== 'personal')\n    .reduce((s, e) => s + e.expenses, 0)\n    + (expenseByEntity.get('personal') || [])\n      .reduce((s, e) => s + (e.annualAmount * e.deductionPct / 100), 0)\n\n  // Net SE income (entity-aware)\n  const netSEIncome = entityBreakdown\n    .filter(e => e.flowThrough === 'schedule_c')\n    .reduce((s, e) => s + e.seTaxableAmount, 0)\n    + entityBreakdown.find(e => e.entityId === 'personal')?.seTaxableAmount || 0\n\n  // S-Corp detection\n  const hasScorp = entityBreakdown.some(e =>\n    e.flowThrough === 'k1' && (e.entityType === 'llc_scorp' || e.entityType === 'scorp')\n  )\n\n  // SE tax on non-S-Corp income\n  const seTax = calculateSelfEmploymentTax(netSEIncome)\n  const seDeduction = seTax.deductibleHalf\n\n  // S-Corp officer salary SE tax (employer+employee FICA)\n  const scorpFICA = totalOfficerSalary > 0\n    ? Math.round(totalOfficerSalary * 0.153) // Combined employer+employee share\n    : 0\n\n  // Retirement\n  const manualRetirementContributions = deductions\n    .filter(d => d.category === 'retirement')\n    .reduce((sum, d) => sum + d.amount, 0)\n  const retirementContributions = manualRetirementContributions\n\n  const totalAdjustments = seDeduction + retirementContributions\n  const agi = grossIncome - totalBusinessExpenses - totalAdjustments\n\n  // Standard vs Itemized\n  const standardDed = STANDARD_DEDUCTION_2024[profile.filingStatus] || 14600\n  const itemizedTotal = deductions\n    .filter(d => d.isItemized)\n    .reduce((sum, d) => sum + d.amount, 0)\n  const useItemized = itemizedTotal > standardDed\n  const deductionAmount = useItemized ? itemizedTotal : standardDed\n\n  // QBI (entity-aware with SSTB detection)\n  const qbiEntities = entityBreakdown.filter(e => e.qbiEligibleAmount > 0)\n  // Aggregate SSTB status — if ANY QBI entity is SSTB, apply phaseout to that portion\n  const sstbQBI = qbiEntities.filter(e => entityMap.get(e.entityId)?.isSSTB).reduce((s, e) => s + e.qbiEligibleAmount, 0)\n  const nonSSTBQBI = totalQBIEligible - sstbQBI\n  const totalW2Wages = qbiEntities.reduce((s, e) => s + (entityMap.get(e.entityId)?.w2WagesPaid || 0), 0)\n  const totalQualifiedProp = qbiEntities.reduce((s, e) => s + (entityMap.get(e.entityId)?.qualifiedPropertyUBIA || 0), 0)\n\n  const sstbDeduction = sstbQBI > 0\n    ? calculateQBIDeduction(sstbQBI, agi - deductionAmount, profile.filingStatus, true, totalW2Wages, totalQualifiedProp)\n    : 0\n  const nonSSTBDeduction = nonSSTBQBI > 0\n    ? calculateQBIDeduction(nonSSTBQBI, agi - deductionAmount, profile.filingStatus, false, totalW2Wages, totalQualifiedProp)\n    : 0\n  const qbiDeduction = sstbDeduction + nonSSTBDeduction\n\n  // Taxable income\n  const taxableIncome = Math.max(0, agi - deductionAmount - qbiDeduction)\n\n  // Federal tax\n  const federalTax = calculateFederalIncomeTax(taxableIncome, profile.filingStatus)\n\n  // Total SE tax (sole prop SE + S-Corp FICA)\n  const actualSETax = seTax.total + scorpFICA\n\n  // W-2 FICA estimate\n  const estimatedW2FICA = w2FICAWithheld > 0 ? w2FICAWithheld : Math.round(\n    (w2Income - totalOfficerSalary) * 0.0765 // Only on actual W-2, not officer salary already counted\n  )\n\n  // State tax\n  const stateT = calculateStateTax(taxableIncome, profile.state)\n\n  // ── AMT (Alternative Minimum Tax) ──\n  const amtExemption = AMT_EXEMPTION[profile.filingStatus] || AMT_EXEMPTION.single\n  const amtPhaseoutStart = AMT_PHASEOUT_START[profile.filingStatus] || AMT_PHASEOUT_START.single\n  const amtRate2Threshold = AMT_RATE_2_THRESHOLD[profile.filingStatus] || AMT_RATE_2_THRESHOLD.single\n\n  // AMTI = taxable income + add-backs (SALT, misc itemized, ISO spreads)\n  const saltAddBack = useItemized ? Math.min(itemizedTotal * 0.3, 10000) : 0 // SALT cap already limits this, but pre-TCJA had unlimited\n  const amti = taxableIncome + saltAddBack\n  // Phase out exemption\n  const amtExemptionReduction = amti > amtPhaseoutStart ? Math.min(amtExemption, (amti - amtPhaseoutStart) * 0.25) : 0\n  const effectiveExemption = Math.max(0, amtExemption - amtExemptionReduction)\n  const amtBase = Math.max(0, amti - effectiveExemption)\n  // Two-rate AMT\n  const amtTax = amtBase <= amtRate2Threshold\n    ? amtBase * AMT_RATE_1\n    : amtRate2Threshold * AMT_RATE_1 + (amtBase - amtRate2Threshold) * AMT_RATE_2\n  // AMT = excess over regular tax\n  const amt = Math.max(0, Math.round(amtTax - federalTax))\n\n  // ── NIIT (Net Investment Income Tax — 3.8% surtax) ──\n  const niitThreshold = NIIT_THRESHOLD[profile.filingStatus] || NIIT_THRESHOLD.single\n  const nii = totalInvestmentIncome // interest, dividends, capital gains, portfolio realized gains\n  const niit = agi > niitThreshold && nii > 0\n    ? Math.round(Math.min(nii, agi - niitThreshold) * NIIT_RATE)\n    : 0\n\n  // Totals (now includes AMT + NIIT)\n  const totalTax = federalTax + actualSETax + stateT + amt + niit\n  const netTaxOwed = totalTax - w2FederalWithheld - w2StateWithheld\n\n  // S-Corp savings (what they'd save by converting remaining sole prop to S-Corp)\n  const unconvertedSEIncome = entityBreakdown\n    .filter(e => e.flowThrough === 'schedule_c')\n    .reduce((s, e) => s + e.netIncome, 0)\n  const reasonableSalary = Math.round(unconvertedSEIncome * 0.6)\n  const scorpCalc = unconvertedSEIncome > 0\n    ? calculateSCorpSavings(unconvertedSEIncome, reasonableSalary)\n    : { savings: 0, soleProptax: 0, scorpTax: 0 }\n\n  // Retirement gap\n  const maxSEP = calculateMaxSEPIRA(netSEIncome > 0 ? netSEIncome : unconvertedSEIncome)\n  const retirementGap = Math.max(0, maxSEP - retirementContributions)\n\n  // Marginal rate\n  const brackets = FEDERAL_BRACKETS_2024[profile.filingStatus as keyof typeof FEDERAL_BRACKETS_2024] || FEDERAL_BRACKETS_2024.single\n  let marginalRate = 0.10\n  for (const bracket of brackets) {\n    if (taxableIncome > bracket.min) marginalRate = bracket.rate\n  }\n\n  return {\n    grossIncome,\n    w2Income,\n    selfEmploymentIncome: seIncome,\n    investmentIncome: totalInvestmentIncome,\n    otherIncome,\n    seDeduction,\n    retirementDeduction: retirementContributions,\n    totalAdjustments,\n    agi,\n    standardDeduction: standardDed,\n    itemizedDeductions: itemizedTotal,\n    deductionUsed: useItemized ? 'itemized' : 'standard',\n    deductionAmount,\n    qbiDeduction,\n    taxableIncome,\n    federalIncomeTax: federalTax,\n    selfEmploymentTax: actualSETax,\n    stateTax: stateT,\n    amt,\n    niit,\n    totalTax,\n    effectiveRate: grossIncome > 0 ? totalTax / grossIncome : 0,\n    marginalRate,\n    afterTaxIncome: grossIncome - totalTax,\n    w2FederalWithheld,\n    w2StateWithheld,\n    w2FICAWithheld: estimatedW2FICA,\n    w2PretaxDeductions,\n    w2EmployerMatch,\n    netTaxOwed,\n    maxSEPIRA: maxSEP,\n    currentRetirementContributions: retirementContributions,\n    retirementGap,\n    sCorpSavings: scorpCalc.savings,\n    identifiedSavings: scorpCalc.savings + retirementGap * marginalRate,\n    entityBreakdown,\n    shortTermPortfolioGains,\n    longTermPortfolioGains,\n  }\n}\n\n// Entity comparison for a given income level\nexport interface EntityComparison {\n  type: string\n  label: string\n  totalTax: number\n  effectiveRate: number\n  seTax: number\n  federalTax: number\n  stateTax: number\n  annualCost: number\n  netAfterTax: number\n  liabilityProtection: boolean\n  score: number\n}\n\nexport function compareEntities(netSEIncome: number, profile: FortunaState['profile']): EntityComparison[] {\n  const { filingStatus, state: stateCode } = profile\n  const standardDed = STANDARD_DEDUCTION_2024[filingStatus] || 14600\n\n  function calcForEntity(type: string): EntityComparison {\n    let seTax = 0\n    let adjustedIncome = netSEIncome\n    let annualCost = 0\n    let label = ''\n    let liabilityProtection = false\n\n    switch (type) {\n      case 'sole_prop':\n        label = 'Sole Proprietorship'\n        seTax = calculateSelfEmploymentTax(netSEIncome).total\n        adjustedIncome = netSEIncome - calculateSelfEmploymentTax(netSEIncome).deductibleHalf\n        annualCost = 0\n        break\n      case 'llc':\n        label = 'Single-Member LLC'\n        seTax = calculateSelfEmploymentTax(netSEIncome).total\n        adjustedIncome = netSEIncome - calculateSelfEmploymentTax(netSEIncome).deductibleHalf\n        annualCost = 300\n        liabilityProtection = true\n        break\n      case 'llc_scorp': {\n        label = 'LLC + S-Corp Election'\n        const salary = Math.round(netSEIncome * 0.6)\n        seTax = calculateSelfEmploymentTax(salary).total\n        adjustedIncome = netSEIncome - seTax / 2\n        annualCost = 2000\n        liabilityProtection = true\n        break\n      }\n      case 'ccorp':\n        label = 'C-Corporation'\n        seTax = 0\n        annualCost = 5000\n        liabilityProtection = true\n        // C-Corp: 21% flat rate, then personal tax on distributions\n        const corpTax = netSEIncome * 0.21\n        const afterCorpIncome = netSEIncome - corpTax - annualCost\n        const personalTax = calculateFederalIncomeTax(Math.max(0, afterCorpIncome - standardDed), filingStatus)\n        const stTax = calculateStateTax(Math.max(0, afterCorpIncome - standardDed), stateCode)\n        return {\n          type, label,\n          totalTax: Math.round(corpTax + personalTax + stTax),\n          effectiveRate: (corpTax + personalTax + stTax) / netSEIncome,\n          seTax: 0,\n          federalTax: Math.round(corpTax + personalTax),\n          stateTax: stTax,\n          annualCost,\n          netAfterTax: Math.round(netSEIncome - corpTax - personalTax - stTax - annualCost),\n          liabilityProtection,\n          score: 0, // calculated below\n        }\n    }\n\n    const qbi = type !== 'ccorp' ? calculateQBIDeduction(netSEIncome, adjustedIncome, filingStatus) : 0\n    const taxableIncome = Math.max(0, adjustedIncome - standardDed - qbi)\n    const fedTax = calculateFederalIncomeTax(taxableIncome, filingStatus)\n    const stTax = calculateStateTax(taxableIncome, stateCode)\n    const totalTax = fedTax + seTax + stTax\n\n    return {\n      type, label,\n      totalTax,\n      effectiveRate: netSEIncome > 0 ? totalTax / netSEIncome : 0,\n      seTax,\n      federalTax: fedTax,\n      stateTax: stTax,\n      annualCost,\n      netAfterTax: Math.round(netSEIncome - totalTax - annualCost),\n      liabilityProtection,\n      score: 0,\n    }\n  }\n\n  const results = ['sole_prop', 'llc', 'llc_scorp', 'ccorp'].map(calcForEntity)\n\n  // Score entities (lower tax + protection = higher score)\n  const maxNet = Math.max(...results.map(r => r.netAfterTax))\n  const minNet = Math.min(...results.map(r => r.netAfterTax))\n  const range = maxNet - minNet || 1\n\n  results.forEach(r => {\n    let score = ((r.netAfterTax - minNet) / range) * 70 // 70% weight on net income\n    if (r.liabilityProtection) score += 20 // 20% for liability protection\n    if (r.type === 'llc_scorp') score += 10 // Small bonus for balanced approach\n    r.score = Math.round(Math.min(100, score))\n  })\n\n  return results.sort((a, b) => b.score - a.score)\n}\n\nexport { STATE_TAX_RATES, STANDARD_DEDUCTION_2024, FEDERAL_BRACKETS_2024 }\n\n// ─── Portfolio-Enhanced Tax Report ──────────────────────────────────────────\n\nexport interface PortfolioTaxAddendum {\n  portfolioOrdinaryIncome: number      // staking, airdrops, mining\n  shortTermCapitalGains: number\n  longTermCapitalGains: number\n  capitalLossDeduction: number         // max $3k/yr\n  netInvestmentIncome: number          // for NIIT\n  niitTax: number                      // 3.8% on NII above threshold\n  portfolioFederalTax: number\n  portfolioStateTax: number\n  portfolioTotalTax: number\n  adjustedTotalTax: number             // base totalTax + portfolio taxes\n  adjustedEffectiveRate: number\n  adjustedAfterTaxIncome: number\n}\n\n/**\n * Computes a portfolio tax addendum that layers on top of the base TaxReport.\n * Does NOT modify the base report — returns supplemental data.\n * Consumers can use base report alone (backward-compatible) or add portfolio layer.\n */\nexport function computePortfolioTaxAddendum(baseReport: TaxReport, stateCode: string): PortfolioTaxAddendum | null {\n  try {\n    const { hasPortfolioData: hasPD, getPortfolioTaxIncome } = require('./portfolio-bridge')\n    if (!hasPD()) return null\n\n    const ptx = getPortfolioTaxIncome(stateCode)\n    if (ptx.additionalOrdinaryIncome === 0 && ptx.shortTermCapGains === 0 && ptx.longTermCapGains === 0) return null\n\n    const stateRate = STATE_TAX_RATES[stateCode]?.rate || 0\n\n    // Ordinary income from portfolio (taxed at marginal rate)\n    const ordinaryTax = ptx.additionalOrdinaryIncome * baseReport.marginalRate\n    const ordinaryStateTax = ptx.additionalOrdinaryIncome * stateRate\n\n    // Short-term capital gains (taxed at ordinary rates)\n    const stcgTax = ptx.shortTermCapGains * baseReport.marginalRate\n    const stcgStateTax = ptx.shortTermCapGains * stateRate\n\n    // Long-term capital gains (taxed at preferential rates)\n    const ltcgRate = baseReport.taxableIncome > 492300 ? 0.20 : baseReport.taxableIncome > 44625 ? 0.15 : 0\n    const ltcgTax = ptx.longTermCapGains * ltcgRate\n    const ltcgStateTax = ptx.longTermCapGains * stateRate\n\n    // Capital loss deduction benefit\n    const lossDeductionBenefit = ptx.capitalLosses * baseReport.marginalRate\n\n    // NIIT (3.8% on net investment income for AGI > $200k single / $250k MFJ)\n    const niitThreshold = baseReport.taxableIncome > 200000 ? 0.038 : 0\n    const niitTax = Math.round(ptx.netInvestmentIncome * niitThreshold)\n\n    const portfolioFederalTax = Math.round(ordinaryTax + stcgTax + ltcgTax - lossDeductionBenefit + niitTax)\n    const portfolioStateTax = Math.round(ordinaryStateTax + stcgStateTax + ltcgStateTax)\n    const portfolioTotalTax = portfolioFederalTax + portfolioStateTax\n\n    const adjustedTotalTax = baseReport.totalTax + portfolioTotalTax\n    const totalIncome = baseReport.grossIncome + ptx.additionalOrdinaryIncome + ptx.shortTermCapGains + ptx.longTermCapGains\n    const adjustedEffectiveRate = totalIncome > 0 ? adjustedTotalTax / totalIncome : 0\n    const adjustedAfterTaxIncome = totalIncome - adjustedTotalTax\n\n    return {\n      portfolioOrdinaryIncome: ptx.additionalOrdinaryIncome,\n      shortTermCapitalGains: ptx.shortTermCapGains,\n      longTermCapitalGains: ptx.longTermCapGains,\n      capitalLossDeduction: ptx.capitalLosses,\n      netInvestmentIncome: ptx.netInvestmentIncome,\n      niitTax,\n      portfolioFederalTax,\n      portfolioStateTax,\n      portfolioTotalTax,\n      adjustedTotalTax,\n      adjustedEffectiveRate,\n      adjustedAfterTaxIncome,\n    }\n  } catch {\n    return null\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\tax-calendar.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'today' is assigned a value but never used.","line":299,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":299,"endColumn":14}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE — Tax Calendar & Deadline Engine v1\n * \n * Comprehensive tax deadline tracking with:\n *   - All federal estimated tax payment dates\n *   - Filing deadlines (original + extended)\n *   - Entity election windows (S-Corp, fiscal year)\n *   - Retirement contribution deadlines\n *   - State-specific deadlines (CA, NY, etc.)\n *   - Custom user deadlines\n *   - Smart reminder scheduling (7-day, 3-day, 1-day, day-of)\n *   - Penalty estimation for missed deadlines\n */\n\nexport interface TaxDeadline {\n  id: string\n  title: string\n  description: string\n  date: string             // ISO date (YYYY-MM-DD)\n  category: DeadlineCategory\n  priority: 'critical' | 'high' | 'medium' | 'low'\n  recurring: 'annual' | 'quarterly' | 'one-time'\n  applicableTo: ApplicableEntity[]\n  form?: string            // IRS form number\n  penaltyInfo?: string     // what happens if you miss it\n  completed: boolean\n  completedDate?: string\n  notes: string\n  reminderDays: number[]   // days before deadline to remind [7, 3, 1, 0]\n}\n\nexport type DeadlineCategory =\n  | 'estimated_tax'\n  | 'filing'\n  | 'extension'\n  | 'entity_election'\n  | 'retirement'\n  | 'payroll'\n  | 'information_return'\n  | 'state'\n  | 'custom'\n\nexport type ApplicableEntity =\n  | 'all'\n  | 'sole_proprietor'\n  | 'single_member_llc'\n  | 's_corp'\n  | 'c_corp'\n  | 'partnership'\n  | 'self_employed'\n  | 'w2_employee'\n  | 'crypto_investor'\n\nexport interface DeadlineAlert {\n  deadline: TaxDeadline\n  daysUntil: number\n  urgency: 'overdue' | 'today' | 'urgent' | 'upcoming' | 'future'\n  message: string\n}\n\n// ─── Standard Federal Deadlines Generator ───────────────────────────────────\n\nexport function generateFederalDeadlines(taxYear: number): TaxDeadline[] {\n  const y = taxYear\n  const ny = taxYear + 1\n  const deadlines: TaxDeadline[] = []\n  let idCounter = 0\n  const id = () => `fed_${y}_${++idCounter}`\n\n  // ─── Quarterly Estimated Tax Payments ─────────────────────────────\n  const estimatedPayments: [string, string, string][] = [\n    [`${y}-04-15`, 'Q1 Estimated Tax Payment', `First quarterly estimated tax payment for ${y}. Covers income earned Jan 1 – Mar 31.`],\n    [`${y}-06-16`, 'Q2 Estimated Tax Payment', `Second quarterly estimated tax payment for ${y}. Covers income earned Apr 1 – May 31.`],\n    [`${y}-09-15`, 'Q3 Estimated Tax Payment', `Third quarterly estimated tax payment for ${y}. Covers income earned Jun 1 – Aug 31.`],\n    [`${ny}-01-15`, 'Q4 Estimated Tax Payment', `Fourth quarterly estimated tax payment for ${y}. Covers income earned Sep 1 – Dec 31.`],\n  ]\n\n  for (const [date, title, desc] of estimatedPayments) {\n    deadlines.push({\n      id: id(), title, description: desc, date,\n      category: 'estimated_tax', priority: 'critical', recurring: 'quarterly',\n      applicableTo: ['self_employed', 'sole_proprietor', 'single_member_llc', 's_corp', 'partnership'],\n      form: '1040-ES',\n      penaltyInfo: 'Underpayment penalty calculated at short-term federal rate + 3% on the shortfall amount.',\n      completed: false, notes: '', reminderDays: [14, 7, 3, 1, 0],\n    })\n  }\n\n  // ─── Filing Deadlines ─────────────────────────────────────────────\n\n  deadlines.push({\n    id: id(), title: 'S-Corp / Partnership Return Due (Form 1120-S / 1065)',\n    description: `File S-Corp (Form 1120-S) or Partnership (Form 1065) returns and issue Schedule K-1s to partners/shareholders.`,\n    date: `${ny}-03-17`, category: 'filing', priority: 'critical', recurring: 'annual',\n    applicableTo: ['s_corp', 'partnership'], form: '1120-S / 1065',\n    penaltyInfo: 'Late filing penalty: $220/month per shareholder/partner, up to 12 months.',\n    completed: false, notes: '', reminderDays: [30, 14, 7, 3, 1],\n  })\n\n  deadlines.push({\n    id: id(), title: 'Individual Tax Return Due (Form 1040)',\n    description: `File personal income tax return for ${y} or request extension (Form 4868). Also deadline for IRA/HSA contributions.`,\n    date: `${ny}-04-15`, category: 'filing', priority: 'critical', recurring: 'annual',\n    applicableTo: ['all'], form: '1040',\n    penaltyInfo: 'Failure-to-file penalty: 5% of unpaid taxes per month (max 25%). Failure-to-pay: 0.5%/month.',\n    completed: false, notes: '', reminderDays: [30, 14, 7, 3, 1, 0],\n  })\n\n  deadlines.push({\n    id: id(), title: 'C-Corp Tax Return Due (Form 1120)',\n    description: `File C-Corporation income tax return for ${y}.`,\n    date: `${ny}-04-15`, category: 'filing', priority: 'critical', recurring: 'annual',\n    applicableTo: ['c_corp'], form: '1120',\n    penaltyInfo: 'Late filing penalty: 5% of unpaid tax per month (max 25%).',\n    completed: false, notes: '', reminderDays: [30, 14, 7, 3, 1],\n  })\n\n  deadlines.push({\n    id: id(), title: 'Extended S-Corp / Partnership Return Due',\n    description: `Extended deadline to file S-Corp (1120-S) or Partnership (1065) return.`,\n    date: `${ny}-09-15`, category: 'extension', priority: 'high', recurring: 'annual',\n    applicableTo: ['s_corp', 'partnership'], form: '1120-S / 1065 (extended)',\n    penaltyInfo: 'No additional extension available. Penalty applies from original due date.',\n    completed: false, notes: '', reminderDays: [14, 7, 3, 1],\n  })\n\n  deadlines.push({\n    id: id(), title: 'Extended Individual Return Due',\n    description: `Extended deadline for personal tax return (Form 1040) if extension was filed.`,\n    date: `${ny}-10-15`, category: 'extension', priority: 'high', recurring: 'annual',\n    applicableTo: ['all'], form: '1040 (extended)',\n    penaltyInfo: 'Final deadline. Interest accrues from original April 15 due date on any balance owed.',\n    completed: false, notes: '', reminderDays: [30, 14, 7, 3, 1],\n  })\n\n  // ─── Entity Elections ─────────────────────────────────────────────\n\n  deadlines.push({\n    id: id(), title: 'S-Corp Election Deadline (Form 2553)',\n    description: `Last day to file Form 2553 to elect S-Corp status for tax year ${y}. Must be filed within 75 days of fiscal year start or by March 15.`,\n    date: `${y}-03-15`, category: 'entity_election', priority: 'high', recurring: 'annual',\n    applicableTo: ['sole_proprietor', 'single_member_llc', 'partnership'], form: '2553',\n    penaltyInfo: 'Late election requires IRS reasonable cause approval (Rev. Proc. 2013-30). May delay by full year.',\n    completed: false, notes: '', reminderDays: [30, 14, 7, 3],\n  })\n\n  // ─── Retirement Contributions ─────────────────────────────────────\n\n  deadlines.push({\n    id: id(), title: 'Solo 401(k) Employee Deferral Deadline',\n    description: `Last day for employee elective deferrals to Solo 401(k) for tax year ${y} (sole proprietors/partnerships). S-Corp owners: through payroll by Dec 31.`,\n    date: `${y}-12-31`, category: 'retirement', priority: 'high', recurring: 'annual',\n    applicableTo: ['sole_proprietor', 'single_member_llc', 'partnership'],\n    penaltyInfo: 'Cannot make employee deferrals after this date for sole proprietors.',\n    completed: false, notes: '', reminderDays: [30, 14, 7, 3, 1],\n  })\n\n  deadlines.push({\n    id: id(), title: 'Solo 401(k) Plan Establishment Deadline',\n    description: `Last day to establish (sign documents for) a new Solo 401(k) plan for tax year ${y}.`,\n    date: `${y}-12-31`, category: 'retirement', priority: 'high', recurring: 'annual',\n    applicableTo: ['sole_proprietor', 'single_member_llc', 's_corp'],\n    penaltyInfo: 'Cannot retroactively establish a 401(k) plan after year-end.',\n    completed: false, notes: '', reminderDays: [60, 30, 14, 7],\n  })\n\n  deadlines.push({\n    id: id(), title: 'IRA / Roth IRA Contribution Deadline',\n    description: `Last day to make IRA or Roth IRA contributions for tax year ${y}. Max $7,000 ($8,000 if age 50+).`,\n    date: `${ny}-04-15`, category: 'retirement', priority: 'medium', recurring: 'annual',\n    applicableTo: ['all'], form: '5498',\n    completed: false, notes: '', reminderDays: [30, 14, 7, 3],\n  })\n\n  deadlines.push({\n    id: id(), title: 'SEP-IRA / Solo 401(k) Employer Contribution Deadline',\n    description: `Last day for employer contributions to SEP-IRA or Solo 401(k) if extension was filed.`,\n    date: `${ny}-10-15`, category: 'retirement', priority: 'medium', recurring: 'annual',\n    applicableTo: ['sole_proprietor', 'single_member_llc', 's_corp'],\n    completed: false, notes: 'If no extension filed, deadline is April 15.', reminderDays: [14, 7, 3],\n  })\n\n  deadlines.push({\n    id: id(), title: 'HSA Contribution Deadline',\n    description: `Last day to contribute to Health Savings Account for tax year ${y}. Max $4,300 individual / $8,550 family.`,\n    date: `${ny}-04-15`, category: 'retirement', priority: 'medium', recurring: 'annual',\n    applicableTo: ['all'],\n    completed: false, notes: 'Must have HDHP to qualify.', reminderDays: [30, 14, 7],\n  })\n\n  // ─── Information Returns ──────────────────────────────────────────\n\n  deadlines.push({\n    id: id(), title: 'Issue 1099-NEC / 1099-MISC to Recipients',\n    description: `Send Form 1099-NEC to independent contractors paid $600+, and 1099-MISC for rents, royalties, etc.`,\n    date: `${ny}-01-31`, category: 'information_return', priority: 'high', recurring: 'annual',\n    applicableTo: ['sole_proprietor', 'single_member_llc', 's_corp', 'c_corp', 'partnership'], form: '1099-NEC / 1099-MISC',\n    penaltyInfo: 'Late filing: $60/form (≤30 days), $120/form (by Aug 1), $310/form (after Aug 1 or not filed).',\n    completed: false, notes: '', reminderDays: [30, 14, 7, 3, 1],\n  })\n\n  deadlines.push({\n    id: id(), title: 'W-2 Due to Employees & SSA',\n    description: `Issue Form W-2 to employees and file with Social Security Administration.`,\n    date: `${ny}-01-31`, category: 'information_return', priority: 'high', recurring: 'annual',\n    applicableTo: ['s_corp', 'c_corp'], form: 'W-2',\n    penaltyInfo: 'Same penalty structure as 1099-NEC.',\n    completed: false, notes: '', reminderDays: [30, 14, 7, 3, 1],\n  })\n\n  deadlines.push({\n    id: id(), title: 'Form 5500-EZ (Solo 401k with $250K+)',\n    description: `Annual filing for Solo 401(k) plans with assets exceeding $250,000.`,\n    date: `${ny}-07-31`, category: 'information_return', priority: 'medium', recurring: 'annual',\n    applicableTo: ['sole_proprietor', 'single_member_llc', 's_corp'], form: '5500-EZ',\n    penaltyInfo: 'Penalty: $250/day, up to $150,000.',\n    completed: false, notes: 'Only required if plan assets exceed $250K.', reminderDays: [30, 14, 7],\n  })\n\n  // ─── Year-End Planning Windows ────────────────────────────────────\n\n  deadlines.push({\n    id: id(), title: 'Tax-Loss Harvesting Window',\n    description: `Last trading day to execute tax-loss harvesting sales for ${y}. Review portfolio for unrealized losses to offset gains.`,\n    date: `${y}-12-29`, category: 'custom', priority: 'high', recurring: 'annual',\n    applicableTo: ['crypto_investor', 'all'],\n    completed: false, notes: 'After 2024, wash sale rules apply to crypto (30-day repurchase restriction).', reminderDays: [14, 7, 3, 1],\n  })\n\n  deadlines.push({\n    id: id(), title: 'Charitable Contribution Deadline',\n    description: `Last day for charitable donations to be deductible for ${y}.`,\n    date: `${y}-12-31`, category: 'custom', priority: 'low', recurring: 'annual',\n    applicableTo: ['all'],\n    completed: false, notes: 'Consider donating appreciated stock/crypto for double tax benefit.', reminderDays: [30, 14],\n  })\n\n  return deadlines\n}\n\n// ─── State-Specific Deadline Generator ──────────────────────────────────────\n\nexport function generateStateDeadlines(taxYear: number, stateCode: string): TaxDeadline[] {\n  const ny = taxYear + 1\n  const deadlines: TaxDeadline[] = []\n  let idCounter = 0\n  const id = () => `state_${stateCode}_${taxYear}_${++idCounter}`\n\n  // California has different estimated payment schedule\n  if (stateCode === 'CA') {\n    const caPayments: [string, string][] = [\n      [`${taxYear}-04-15`, 'CA Q1 Estimated Tax (30% of annual)'],\n      [`${taxYear}-06-16`, 'CA Q2 Estimated Tax (40% of annual)'],\n      [`${ny}-01-15`, 'CA Q3 Estimated Tax (0% — skip)'],\n      [`${ny}-01-15`, 'CA Q4 Estimated Tax (30% of annual)'],\n    ]\n    for (const [date, title] of caPayments) {\n      if (title.includes('skip')) continue\n      deadlines.push({\n        id: id(), title, description: `California estimated tax payment. CA uses a 30/40/0/30 split (not equal quarters).`,\n        date, category: 'state', priority: 'critical', recurring: 'quarterly',\n        applicableTo: ['self_employed'], form: 'CA 540-ES',\n        penaltyInfo: 'CA underpayment penalty calculated separately from federal.',\n        completed: false, notes: '', reminderDays: [14, 7, 3, 1, 0],\n      })\n    }\n  }\n\n  // Illinois\n  if (stateCode === 'IL') {\n    deadlines.push({\n      id: id(), title: 'IL Individual Tax Return Due',\n      description: `File Illinois IL-1040. Due same day as federal.`,\n      date: `${ny}-04-15`, category: 'state', priority: 'high', recurring: 'annual',\n      applicableTo: ['all'], form: 'IL-1040',\n      completed: false, notes: '4.95% flat rate.', reminderDays: [14, 7, 3, 1],\n    })\n  }\n\n  // Add generic state filing deadline for all states with income tax\n  const noTaxStates = ['AK', 'FL', 'NV', 'NH', 'SD', 'TN', 'TX', 'WA', 'WY']\n  if (!noTaxStates.includes(stateCode)) {\n    deadlines.push({\n      id: id(), title: `${stateCode} State Tax Return Due`,\n      description: `File ${stateCode} state income tax return. Most states follow federal April 15 deadline.`,\n      date: `${ny}-04-15`, category: 'state', priority: 'high', recurring: 'annual',\n      applicableTo: ['all'],\n      completed: false, notes: '', reminderDays: [14, 7, 3, 1],\n    })\n  }\n\n  return deadlines\n}\n\n// ─── Alert Generator ────────────────────────────────────────────────────────\n\nexport function getDeadlineAlerts(deadlines: TaxDeadline[], asOfDate?: Date): DeadlineAlert[] {\n  const now = asOfDate || new Date()\n  const today = now.toISOString().split('T')[0]\n\n  return deadlines\n    .filter(d => !d.completed)\n    .map(d => {\n      const deadlineDate = new Date(d.date + 'T23:59:59')\n      const daysUntil = Math.ceil((deadlineDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24))\n\n      let urgency: DeadlineAlert['urgency']\n      let message: string\n\n      if (daysUntil < 0) {\n        urgency = 'overdue'\n        message = `⚠️ OVERDUE by ${Math.abs(daysUntil)} day(s)! ${d.penaltyInfo || 'Late penalties may apply.'}`\n      } else if (daysUntil === 0) {\n        urgency = 'today'\n        message = `🔴 DUE TODAY! Complete before midnight.`\n      } else if (daysUntil <= 3) {\n        urgency = 'urgent'\n        message = `🟠 Due in ${daysUntil} day(s). Take action now.`\n      } else if (daysUntil <= 14) {\n        urgency = 'upcoming'\n        message = `🟡 Due in ${daysUntil} days. Plan ahead.`\n      } else {\n        urgency = 'future'\n        message = `🟢 Due in ${daysUntil} days.`\n      }\n\n      return { deadline: d, daysUntil, urgency, message }\n    })\n    .sort((a, b) => a.daysUntil - b.daysUntil)\n}\n\n// ─── Calendar View Helpers ──────────────────────────────────────────────────\n\nexport function getDeadlinesForMonth(deadlines: TaxDeadline[], year: number, month: number): TaxDeadline[] {\n  const prefix = `${year}-${String(month).padStart(2, '0')}`\n  return deadlines.filter(d => d.date.startsWith(prefix))\n}\n\nexport function getUpcomingDeadlines(deadlines: TaxDeadline[], days: number = 30): TaxDeadline[] {\n  const now = new Date()\n  const cutoff = new Date(now.getTime() + days * 24 * 60 * 60 * 1000)\n  return deadlines\n    .filter(d => !d.completed && new Date(d.date) >= now && new Date(d.date) <= cutoff)\n    .sort((a, b) => a.date.localeCompare(b.date))\n}\n\n// ─── Penalty Estimator ──────────────────────────────────────────────────────\n\nexport function estimateUnderpaymentPenalty(\n  requiredPayment: number,\n  actualPaid: number,\n  dueDate: string,\n  paidDate: string,\n): { penalty: number; daysLate: number; rate: number } {\n  const due = new Date(dueDate)\n  const paid = new Date(paidDate)\n  const daysLate = Math.max(0, Math.ceil((paid.getTime() - due.getTime()) / (1000 * 60 * 60 * 24)))\n  \n  if (daysLate === 0 || actualPaid >= requiredPayment) {\n    return { penalty: 0, daysLate: 0, rate: 0 }\n  }\n\n  // IRS underpayment rate: federal short-term rate + 3% (currently ~8% annual)\n  const annualRate = 0.08\n  const shortfall = Math.max(0, requiredPayment - actualPaid)\n  const penalty = shortfall * annualRate * (daysLate / 365)\n\n  return { penalty: Math.round(penalty * 100) / 100, daysLate, rate: annualRate }\n}\n\n// ─── Storage ────────────────────────────────────────────────────────────────\n\nconst CALENDAR_STORAGE_KEY = 'fortuna:tax-calendar'\n\nexport function saveCalendar(deadlines: TaxDeadline[]) {\n  localStorage.setItem(CALENDAR_STORAGE_KEY, JSON.stringify(deadlines))\n}\n\nexport function loadCalendar(): TaxDeadline[] {\n  try {\n    const raw = localStorage.getItem(CALENDAR_STORAGE_KEY)\n    if (raw) return JSON.parse(raw)\n  } catch { /* */ }\n  return []\n}\n\nexport function initializeCalendar(taxYear: number, stateCode: string): TaxDeadline[] {\n  const existing = loadCalendar()\n  if (existing.length > 0) return existing\n\n  const federal = generateFederalDeadlines(taxYear)\n  const state = generateStateDeadlines(taxYear, stateCode)\n  const all = [...federal, ...state]\n  saveCalendar(all)\n  return all\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\tax-credits.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'CTC_PHASEOUT_RATE' is assigned a value but never used.","line":28,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":28,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DEPENDENT_CARE_MAX_ONE' is assigned a value but never used.","line":31,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":31,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DEPENDENT_CARE_MAX_TWO' is assigned a value but never used.","line":32,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":32,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DEPENDENT_CARE_MAX_RATE' is assigned a value but never used.","line":33,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":33,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DEPENDENT_CARE_MIN_RATE' is assigned a value but never used.","line":34,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":34,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DEPENDENT_CARE_RATE_THRESHOLD' is assigned a value but never used.","line":35,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":35,"endColumn":36},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'LLC_PHASEOUT_SINGLE' is assigned a value but never used.","line":52,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":52,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'LLC_PHASEOUT_END_SINGLE' is assigned a value but never used.","line":53,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":53,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'RESIDENTIAL_ENERGY_RATE' is assigned a value but never used.","line":80,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":80,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ACA_FPL_2024_SINGLE' is assigned a value but never used.","line":89,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":89,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ACA_CONTRIBUTION_CAPS' is assigned a value but never used.","line":90,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":90,"endColumn":28},{"ruleId":"prefer-const","severity":2,"message":"'childDetails' is never reassigned. Use 'const' instead.","line":147,"column":7,"nodeType":"Identifier","messageId":"useConst","endLine":147,"endColumn":29,"fix":{"range":[5025,5056],"text":"const childDetails: string[] = []"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'state' is defined but never used.","line":302,"column":32,"nodeType":"Identifier","messageId":"unusedVar","endLine":302,"endColumn":37},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'agi' is defined but never used.","line":479,"column":52,"nodeType":"Identifier","messageId":"unusedVar","endLine":479,"endColumn":55}],"suppressedMessages":[],"errorCount":14,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — Tax Credit Optimizer v9\n *\n * Identifies and calculates all available federal tax credits:\n *  - Child Tax Credit / Additional CTC / Child & Dependent Care\n *  - Earned Income Tax Credit (EITC)\n *  - Education Credits (American Opportunity, Lifetime Learning)\n *  - Energy Credits (residential clean energy, EV)\n *  - Health Premium Tax Credit (ACA marketplace)\n *  - Retirement Savings Credit (Saver's Credit)\n *  - R&D Tax Credit (for small businesses)\n *  - Home Office deduction credit interactions\n *  - General Business Credits\n */\n\nimport type { FortunaState } from './storage'\nimport { generateTaxReport } from './tax-calculator'\n\n// ===================================================================\n//  2024 CREDIT CONSTANTS\n// ===================================================================\n\n// Child Tax Credit\nconst CTC_AMOUNT = 2000\nconst CTC_REFUNDABLE_MAX = 1700 // Additional CTC refundable portion\nconst CTC_PHASEOUT_SINGLE = 200000\nconst CTC_PHASEOUT_JOINT = 400000\nconst CTC_PHASEOUT_RATE = 0.05 // $50 per $1000 over threshold\n\n// Child & Dependent Care Credit\nconst DEPENDENT_CARE_MAX_ONE = 3000\nconst DEPENDENT_CARE_MAX_TWO = 6000\nconst DEPENDENT_CARE_MAX_RATE = 0.35\nconst DEPENDENT_CARE_MIN_RATE = 0.20\nconst DEPENDENT_CARE_RATE_THRESHOLD = 15000\n\n// EITC 2024 (zero dependents used as base)\nconst EITC_LIMITS = {\n  0: { maxCredit: 632, phaseoutStart_single: 9800, phaseoutEnd_single: 18591, phaseoutStart_joint: 16510, phaseoutEnd_joint: 25511 },\n  1: { maxCredit: 3995, phaseoutStart_single: 12730, phaseoutEnd_single: 46560, phaseoutStart_joint: 22230, phaseoutEnd_joint: 53120 },\n  2: { maxCredit: 6604, phaseoutStart_single: 12730, phaseoutEnd_single: 52918, phaseoutStart_joint: 22230, phaseoutEnd_joint: 59478 },\n  3: { maxCredit: 7430, phaseoutStart_single: 12730, phaseoutEnd_single: 56838, phaseoutStart_joint: 22230, phaseoutEnd_joint: 63398 },\n}\n\n// Education Credits\nconst AOTC_MAX = 2500\nconst AOTC_PHASEOUT_SINGLE = 80000\nconst AOTC_PHASEOUT_END_SINGLE = 90000\nconst AOTC_PHASEOUT_JOINT = 160000\nconst AOTC_PHASEOUT_END_JOINT = 180000\nconst LLC_MAX = 2000\nconst LLC_PHASEOUT_SINGLE = 80000\nconst LLC_PHASEOUT_END_SINGLE = 90000\n\n// Saver's Credit\nconst SAVERS_CREDIT_LIMITS_2024 = {\n  single: [\n    { maxAGI: 23000, rate: 0.50 },\n    { maxAGI: 25000, rate: 0.20 },\n    { maxAGI: 38250, rate: 0.10 },\n  ],\n  married_joint: [\n    { maxAGI: 46000, rate: 0.50 },\n    { maxAGI: 50000, rate: 0.20 },\n    { maxAGI: 76500, rate: 0.10 },\n  ],\n  head_of_household: [\n    { maxAGI: 34500, rate: 0.50 },\n    { maxAGI: 37500, rate: 0.20 },\n    { maxAGI: 57375, rate: 0.10 },\n  ],\n}\nconst SAVERS_MAX_CONTRIBUTION = 2000\n\n// Clean Energy\nconst EV_CREDIT_NEW = 7500\nconst EV_CREDIT_USED = 4000\nconst EV_AGI_LIMIT_SINGLE = 150000\nconst EV_AGI_LIMIT_JOINT = 300000\nconst RESIDENTIAL_ENERGY_RATE = 0.30\nconst RESIDENTIAL_ENERGY_MAX = 3200\n\n// R&D Credit (small business)\nconst RD_CREDIT_RATE = 0.20\nconst RD_SIMPLIFIED_RATE = 0.14\nconst RD_PAYROLL_TAX_LIMIT = 500000 // for startups\n\n// Health Premium Tax Credit\nconst ACA_FPL_2024_SINGLE = 15060\nconst ACA_CONTRIBUTION_CAPS = [\n  { fplPct: 1.50, contribution: 0.00 },\n  { fplPct: 2.00, contribution: 0.02 },\n  { fplPct: 2.50, contribution: 0.04 },\n  { fplPct: 3.00, contribution: 0.06 },\n  { fplPct: 4.00, contribution: 0.085 },\n]\n\n// ===================================================================\n//  TYPES\n// ===================================================================\n\nexport interface TaxCredit {\n  id: string\n  name: string\n  category: 'family' | 'education' | 'energy' | 'retirement' | 'business' | 'health' | 'foreign'\n  amount: number\n  type: 'nonrefundable' | 'refundable' | 'partially_refundable'\n  eligible: boolean\n  eligibilityReason: string\n  phaseoutApplied: boolean\n  fullAmount: number // before phaseout\n  requirements: string[]\n  actionItems: string[]\n  notes: string[]\n}\n\nexport interface CreditOptimization {\n  title: string\n  description: string\n  additionalCredits: number\n  difficulty: 'easy' | 'moderate' | 'complex'\n  category: string\n}\n\nexport interface TaxCreditSummary {\n  credits: TaxCredit[]\n  totalNonrefundable: number\n  totalRefundable: number\n  totalCredits: number\n  taxLiabilityReduction: number // actual reduction (nonrefundable capped at tax owed)\n  optimizations: CreditOptimization[]\n  unusedCredits: number // nonrefundable credits exceeding tax liability\n  effectiveCreditRate: number // credits as % of gross income\n}\n\n// ===================================================================\n//  CREDIT CALCULATORS\n// ===================================================================\n\nfunction calcChildTaxCredit(state: FortunaState, agi: number): TaxCredit {\n  // Use rich household dependents if available, fall back to profile.dependents count\n  const householdDeps = state.household?.dependents || []\n  const currentYear = state.taxYear || new Date().getFullYear()\n\n  // Count qualifying children (under 17 at end of tax year)\n  let qualifyingChildren: number\n  let childDetails: string[] = []\n  if (householdDeps.length > 0) {\n    const qualifying = householdDeps.filter(d => {\n      if (!d.dateOfBirth) return true // assume qualifying if no DOB\n      const age = currentYear - new Date(d.dateOfBirth).getFullYear()\n      return age < 17\n    })\n    qualifyingChildren = qualifying.length\n    const overAge = householdDeps.filter(d => {\n      if (!d.dateOfBirth) return false\n      const age = currentYear - new Date(d.dateOfBirth).getFullYear()\n      return age >= 17\n    })\n    if (overAge.length > 0) {\n      childDetails.push(`${overAge.length} dependent(s) age 17+ do not qualify for CTC but may qualify for Other Dependent Credit ($500)`)\n    }\n    const disabled = qualifying.filter(d => d.isDisabled)\n    if (disabled.length > 0) {\n      childDetails.push(`${disabled.length} qualifying child(ren) with disability may also qualify for additional credits`)\n    }\n  } else {\n    qualifyingChildren = state.profile.dependents\n  }\n\n  if (qualifyingChildren === 0) {\n    const notes = householdDeps.length > 0 && householdDeps.length > qualifyingChildren\n      ? [`${householdDeps.length} dependent(s) claimed but none under age 17. Other Dependent Credit may apply ($500 each).`]\n      : []\n    return {\n      id: 'ctc', name: 'Child Tax Credit', category: 'family',\n      amount: 0, type: 'partially_refundable', eligible: false,\n      eligibilityReason: householdDeps.length > 0 ? 'No dependents under age 17' : 'No qualifying dependents claimed',\n      phaseoutApplied: false, fullAmount: 0,\n      requirements: ['Child under 17', 'SSN for child', 'Child must be claimed as dependent'],\n      actionItems: [], notes,\n    }\n  }\n\n  const fullCredit = qualifyingChildren * CTC_AMOUNT\n  const threshold = state.profile.filingStatus === 'married_joint'\n    ? CTC_PHASEOUT_JOINT : CTC_PHASEOUT_SINGLE\n  const excess = Math.max(0, agi - threshold)\n  const reduction = Math.ceil(excess / 1000) * 50\n  const credit = Math.max(0, fullCredit - reduction)\n  const refundable = Math.min(credit, qualifyingChildren * CTC_REFUNDABLE_MAX)\n\n  return {\n    id: 'ctc', name: 'Child Tax Credit', category: 'family',\n    amount: credit, type: 'partially_refundable', eligible: credit > 0,\n    eligibilityReason: credit > 0 ? `$${CTC_AMOUNT.toLocaleString()} per qualifying child \\u00D7 ${qualifyingChildren}` : `AGI exceeds phaseout threshold`,\n    phaseoutApplied: reduction > 0, fullAmount: fullCredit,\n    requirements: ['Child under 17 with SSN', 'Claimed as dependent', `AGI under $${(threshold + fullCredit / 0.05 * 1000).toLocaleString()}`],\n    actionItems: reduction > 0 ? ['Consider retirement contributions to reduce AGI below phaseout'] : [],\n    notes: [`Up to $${refundable.toLocaleString()} refundable as Additional CTC`, ...childDetails],\n  }\n}\n\nfunction calcEITC(state: FortunaState, agi: number, earnedIncome: number): TaxCredit {\n  const deps = Math.min(state.profile.dependents, 3) as 0 | 1 | 2 | 3\n  const limits = EITC_LIMITS[deps]\n  const isJoint = state.profile.filingStatus === 'married_joint'\n\n  const phaseoutStart = isJoint ? limits.phaseoutStart_joint : limits.phaseoutStart_single\n  const phaseoutEnd = isJoint ? limits.phaseoutEnd_joint : limits.phaseoutEnd_single\n\n  let credit = 0\n  if (agi <= phaseoutStart) {\n    credit = limits.maxCredit\n  } else if (agi < phaseoutEnd) {\n    const pct = (phaseoutEnd - agi) / (phaseoutEnd - phaseoutStart)\n    credit = Math.round(limits.maxCredit * pct)\n  }\n\n  // Investment income limit ($11,600 for 2024)\n  const investIncome = state.incomeStreams\n    .filter(s => s.type === 'investment' && s.isActive)\n    .reduce((s, i) => s + i.annualAmount, 0)\n  if (investIncome > 11600) credit = 0\n\n  return {\n    id: 'eitc', name: 'Earned Income Tax Credit', category: 'family',\n    amount: credit, type: 'refundable', eligible: credit > 0,\n    eligibilityReason: credit > 0\n      ? `Earned income of $${earnedIncome.toLocaleString()} with ${deps} qualifying children`\n      : `AGI of $${agi.toLocaleString()} exceeds EITC limit of $${phaseoutEnd.toLocaleString()}`,\n    phaseoutApplied: agi > phaseoutStart && credit > 0, fullAmount: limits.maxCredit,\n    requirements: ['Earned income required', 'Investment income under $11,600', `AGI under $${phaseoutEnd.toLocaleString()}`],\n    actionItems: credit === 0 && agi < phaseoutEnd * 1.2\n      ? ['Retirement contributions could reduce AGI into EITC range']\n      : [],\n    notes: deps > 0 ? [`Max credit with ${deps} children: $${limits.maxCredit.toLocaleString()}`] : [],\n  }\n}\n\nfunction calcSaversCredit(state: FortunaState, agi: number): TaxCredit {\n  const statusKey = state.profile.filingStatus === 'married_separate'\n    ? 'single' : (state.profile.filingStatus as keyof typeof SAVERS_CREDIT_LIMITS_2024)\n  const brackets = SAVERS_CREDIT_LIMITS_2024[statusKey] || SAVERS_CREDIT_LIMITS_2024.single\n\n  const retirementContrib = state.deductions\n    .filter(d => d.category === 'retirement')\n    .reduce((s, d) => s + d.amount, 0)\n\n  const eligibleContrib = Math.min(retirementContrib, SAVERS_MAX_CONTRIBUTION)\n  let rate = 0\n  for (const b of brackets) {\n    if (agi <= b.maxAGI) { rate = b.rate; break }\n  }\n\n  const credit = Math.round(eligibleContrib * rate)\n  const maxAGI = brackets[brackets.length - 1]?.maxAGI || 0\n\n  return {\n    id: 'savers', name: 'Retirement Savings Credit', category: 'retirement',\n    amount: credit, type: 'nonrefundable', eligible: credit > 0 && agi <= maxAGI,\n    eligibilityReason: agi > maxAGI\n      ? `AGI of $${agi.toLocaleString()} exceeds limit of $${maxAGI.toLocaleString()}`\n      : retirementContrib === 0\n        ? 'No retirement contributions detected'\n        : `${(rate * 100).toFixed(0)}% credit on $${eligibleContrib.toLocaleString()} contribution`,\n    phaseoutApplied: false, fullAmount: Math.round(SAVERS_MAX_CONTRIBUTION * 0.50),\n    requirements: ['Age 18+', 'Not full-time student', 'Not claimed as dependent', `AGI under $${maxAGI.toLocaleString()}`],\n    actionItems: retirementContrib === 0 ? ['Start retirement contributions to claim up to $1,000 credit'] : [],\n    notes: [`Max credit: $${Math.round(SAVERS_MAX_CONTRIBUTION * 0.50).toLocaleString()} at 50% rate`],\n  }\n}\n\nfunction calcEVCredit(state: FortunaState, agi: number): TaxCredit {\n  const limit = state.profile.filingStatus === 'married_joint'\n    ? EV_AGI_LIMIT_JOINT : EV_AGI_LIMIT_SINGLE\n  const eligible = agi <= limit\n\n  return {\n    id: 'ev_new', name: 'Clean Vehicle Credit (New EV)', category: 'energy',\n    amount: 0, type: 'nonrefundable', eligible,\n    eligibilityReason: eligible\n      ? `AGI under $${limit.toLocaleString()} — eligible for up to $${EV_CREDIT_NEW.toLocaleString()} on qualifying new EV purchase`\n      : `AGI exceeds $${limit.toLocaleString()} limit`,\n    phaseoutApplied: false, fullAmount: EV_CREDIT_NEW,\n    requirements: [\n      `AGI ≤ $${limit.toLocaleString()}`,\n      'Vehicle MSRP under $55K (cars) or $80K (SUVs/trucks)',\n      'Final assembly in North America',\n      'Battery sourcing requirements met',\n    ],\n    actionItems: eligible\n      ? ['Check IRS FuelEconomy.gov for qualifying vehicles', 'Can transfer credit to dealer at point of sale']\n      : [],\n    notes: [\n      `Also available: $${EV_CREDIT_USED.toLocaleString()} credit for used EVs (AGI limit: $${(limit * 0.5).toLocaleString()})`,\n      'Credit can be taken at point of sale starting 2024',\n    ],\n  }\n}\n\nfunction calcResidentialEnergy(state: FortunaState): TaxCredit {\n  return {\n    id: 'residential_energy', name: 'Residential Clean Energy Credit', category: 'energy',\n    amount: 0, type: 'nonrefundable', eligible: true,\n    eligibilityReason: 'Available for qualifying home energy improvements — no income limit',\n    phaseoutApplied: false, fullAmount: RESIDENTIAL_ENERGY_MAX,\n    requirements: [\n      'Must be primary or secondary residence',\n      'Qualifying improvements: solar, wind, geothermal, battery storage',\n      'Heat pumps, insulation, windows, doors also qualify (separate limits)',\n    ],\n    actionItems: [\n      `Solar panels: 30% credit with no cap`,\n      `Energy-efficient improvements: 30% up to $${RESIDENTIAL_ENERGY_MAX.toLocaleString()}/year`,\n      'Keep all receipts and manufacturer certifications',\n    ],\n    notes: [\n      'Solar: 30% of cost with no cap through 2032',\n      `Other improvements: $${RESIDENTIAL_ENERGY_MAX.toLocaleString()} annual limit`,\n      'Heat pump/water heater: up to $2,000 credit',\n    ],\n  }\n}\n\nfunction calcRDCredit(state: FortunaState): TaxCredit {\n  const hasBusinessIncome = state.incomeStreams.some(s =>\n    ['business', 'freelance'].includes(s.type) && s.isActive\n  )\n  const grossReceipts = state.incomeStreams\n    .filter(s => s.isActive)\n    .reduce((s, i) => s + i.annualAmount, 0)\n\n  const isSmallBusiness = grossReceipts < 5000000\n\n  return {\n    id: 'rd_credit', name: 'R&D Tax Credit', category: 'business',\n    amount: 0, type: 'nonrefundable', eligible: hasBusinessIncome,\n    eligibilityReason: hasBusinessIncome\n      ? 'Business income detected — may qualify for R&D credit on development activities'\n      : 'No business income — R&D credit requires business/trade activities',\n    phaseoutApplied: false,\n    fullAmount: 0,\n    requirements: [\n      'Qualified research expenses (wages, supplies, contract research)',\n      'Must involve technological uncertainty',\n      'Process of experimentation required',\n      'Business component purpose',\n    ],\n    actionItems: hasBusinessIncome ? [\n      'Document development hours and activities',\n      'Track software development wages and contractor costs',\n      `Simplified credit: ${RD_SIMPLIFIED_RATE * 100}% of qualified expenses above base`,\n      isSmallBusiness ? `Startups: up to $${(RD_PAYROLL_TAX_LIMIT / 1000).toFixed(0)}K can offset payroll taxes` : '',\n    ].filter(Boolean) : [],\n    notes: [\n      'Software development often qualifies',\n      `Regular method: ${RD_CREDIT_RATE * 100}% | Simplified: ${RD_SIMPLIFIED_RATE * 100}%`,\n      isSmallBusiness ? 'Eligible for payroll tax offset as small business' : '',\n    ].filter(Boolean),\n  }\n}\n\nfunction calcEducationCredits(state: FortunaState, agi: number): TaxCredit {\n  const isJoint = state.profile.filingStatus === 'married_joint'\n  const phaseoutStart = isJoint ? AOTC_PHASEOUT_JOINT : AOTC_PHASEOUT_SINGLE\n  const phaseoutEnd = isJoint ? AOTC_PHASEOUT_END_JOINT : AOTC_PHASEOUT_END_SINGLE\n  const eligible = agi < phaseoutEnd\n\n  let phasedAmount = AOTC_MAX\n  if (agi > phaseoutStart) {\n    const pct = (phaseoutEnd - agi) / (phaseoutEnd - phaseoutStart)\n    phasedAmount = Math.round(AOTC_MAX * Math.max(0, pct))\n  }\n\n  return {\n    id: 'education', name: 'Education Credits (AOTC / LLC)', category: 'education',\n    amount: 0, type: 'partially_refundable', eligible,\n    eligibilityReason: eligible\n      ? `AGI under phaseout — American Opportunity Credit up to $${phasedAmount.toLocaleString()}`\n      : `AGI exceeds $${phaseoutEnd.toLocaleString()} phaseout`,\n    phaseoutApplied: agi > phaseoutStart, fullAmount: AOTC_MAX,\n    requirements: [\n      'Enrolled at eligible educational institution',\n      'Paying qualified tuition and expenses',\n      'AOTC: First 4 years of postsecondary only',\n      'LLC: Any postsecondary or skill improvement',\n    ],\n    actionItems: eligible\n      ? [`AOTC: Up to $${AOTC_MAX.toLocaleString()} (40% refundable = $${Math.round(AOTC_MAX * 0.4).toLocaleString()})`,\n         `LLC: Up to $${LLC_MAX.toLocaleString()} (nonrefundable)`,\n         'Cannot claim both for same student']\n      : [],\n    notes: ['AOTC is more valuable due to partial refundability', '1098-T required from institution'],\n  }\n}\n\n// ===================================================================\n//  OPTIMIZATION SUGGESTIONS\n// ===================================================================\n\nfunction findOptimizations(\n  state: FortunaState,\n  credits: TaxCredit[],\n  agi: number,\n  taxReport: ReturnType<typeof generateTaxReport>,\n): CreditOptimization[] {\n  const opts: CreditOptimization[] = []\n\n  // AGI reduction to unlock credits\n  const ineligible = credits.filter(c => !c.eligible && c.fullAmount > 0)\n  for (const c of ineligible) {\n    if (c.id === 'eitc' || c.id === 'savers') {\n      const retirementGap = taxReport.retirementGap\n      if (retirementGap > 5000) {\n        opts.push({\n          title: `Retirement contributions could unlock ${c.name}`,\n          description: `Contributing $${retirementGap.toLocaleString()} to retirement accounts reduces AGI, potentially qualifying for up to $${c.fullAmount.toLocaleString()}.`,\n          additionalCredits: c.fullAmount,\n          difficulty: 'moderate',\n          category: c.category,\n        })\n      }\n    }\n  }\n\n  // R&D credit for software developers\n  const rdCredit = credits.find(c => c.id === 'rd_credit')\n  if (rdCredit?.eligible) {\n    const devExpenses = state.expenses\n      .filter(e => e.isDeductible && (\n        e.category.toLowerCase().includes('software') ||\n        e.category.toLowerCase().includes('development') ||\n        e.category.toLowerCase().includes('contractor')\n      ))\n      .reduce((s, e) => s + e.annualAmount, 0)\n\n    if (devExpenses > 10000) {\n      opts.push({\n        title: 'Claim R&D Credit on Development Activities',\n        description: `$${devExpenses.toLocaleString()} in potential qualified research expenses detected. Simplified credit of ${RD_SIMPLIFIED_RATE * 100}% could yield $${Math.round(devExpenses * RD_SIMPLIFIED_RATE).toLocaleString()}.`,\n        additionalCredits: Math.round(devExpenses * RD_SIMPLIFIED_RATE),\n        difficulty: 'complex',\n        category: 'business',\n      })\n    }\n  }\n\n  // EV credit reminder\n  const evCredit = credits.find(c => c.id === 'ev_new')\n  if (evCredit?.eligible) {\n    opts.push({\n      title: 'EV Purchase Qualifies for $7,500 Credit',\n      description: 'Your AGI qualifies for the full clean vehicle credit. Can be applied at point of sale for immediate savings.',\n      additionalCredits: EV_CREDIT_NEW,\n      difficulty: 'easy',\n      category: 'energy',\n    })\n  }\n\n  // Energy improvements\n  opts.push({\n    title: 'Home Energy Improvements',\n    description: `30% credit on solar panels (no cap), heat pumps ($2,000), insulation/windows ($1,200). No income limit. Total up to $${RESIDENTIAL_ENERGY_MAX.toLocaleString()}/year for non-solar.`,\n    additionalCredits: RESIDENTIAL_ENERGY_MAX,\n    difficulty: 'moderate',\n    category: 'energy',\n  })\n\n  return opts.sort((a, b) => b.additionalCredits - a.additionalCredits)\n}\n\n// ===================================================================\n//  MAIN ANALYSIS\n// ===================================================================\n\n// ─── Foreign Tax Credit (Form 1116) ────────────────────────────────────────\n\nfunction calcForeignTaxCredit(state: FortunaState, agi: number): TaxCredit {\n  const report = generateTaxReport(state)\n\n  // Check for foreign-source income in investment streams\n  const foreignIncome = state.incomeStreams\n    .filter(s => s.isActive && s.tags?.includes('foreign'))\n    .reduce((s, i) => s + i.annualAmount, 0)\n\n  // Check carryforwards for prior foreign tax credit\n  const carryforward = state.carryforwards?.foreignTaxCredit || 0\n\n  // Foreign taxes paid (from deductions tagged as foreign)\n  const foreignTaxesPaid = state.deductions\n    .filter(d => d.category === 'other' && d.notes?.toLowerCase().includes('foreign tax'))\n    .reduce((s, d) => s + d.amount, 0)\n\n  const totalForeignTax = foreignTaxesPaid + carryforward\n  const eligible = totalForeignTax > 0\n\n  // Credit limitation: (foreign source income / worldwide income) × US tax\n  let creditLimit = Infinity\n  if (foreignIncome > 0 && report.grossIncome > 0) {\n    creditLimit = Math.round((foreignIncome / report.grossIncome) * report.federalIncomeTax)\n  }\n  const creditAmount = Math.min(totalForeignTax, creditLimit)\n\n  return {\n    id: 'foreign_tax_credit',\n    name: 'Foreign Tax Credit',\n    category: 'foreign',\n    amount: eligible ? creditAmount : 0,\n    type: 'nonrefundable',\n    eligible,\n    eligibilityReason: eligible\n      ? `$${foreignTaxesPaid.toLocaleString()} in foreign taxes paid${carryforward > 0 ? ` + $${carryforward.toLocaleString()} carryforward` : ''}`\n      : 'No foreign taxes paid or reported',\n    phaseoutApplied: creditAmount < totalForeignTax,\n    fullAmount: totalForeignTax,\n    requirements: [\n      'Foreign taxes paid or accrued to a foreign country',\n      'Tax must be a legal and actual foreign tax liability',\n      'Must be an income tax or tax in lieu of income tax',\n    ],\n    actionItems: eligible\n      ? creditAmount < totalForeignTax\n        ? [`$${(totalForeignTax - creditAmount).toLocaleString()} excess credit can carry forward 10 years or back 1 year`]\n        : ['Credit fully utilized this year']\n      : ['Tag foreign-source income streams with \"foreign\" tag', 'Add foreign tax payments as deductions with \"foreign tax\" in notes'],\n    notes: eligible\n      ? [`Form 1116 required for credit > $300 single / $600 joint`, `Credit limited to ${foreignIncome > 0 ? Math.round(foreignIncome / report.grossIncome * 100) : 0}% of US tax (foreign income ratio)`]\n      : ['Many international ETFs and funds pay foreign withholding taxes'],\n  }\n}\n\nexport function analyzeTaxCredits(state: FortunaState): TaxCreditSummary {\n  const report = generateTaxReport(state)\n  const agi = report.agi\n  const earnedIncome = report.w2Income + report.selfEmploymentIncome\n\n  // Calculate all credits\n  const credits: TaxCredit[] = [\n    calcChildTaxCredit(state, agi),\n    calcEITC(state, agi, earnedIncome),\n    calcSaversCredit(state, agi),\n    calcEVCredit(state, agi),\n    calcResidentialEnergy(state),\n    calcRDCredit(state),\n    calcEducationCredits(state, agi),\n    calcForeignTaxCredit(state, agi),\n  ]\n\n  // Totals\n  const totalRefundable = credits\n    .filter(c => c.eligible && (c.type === 'refundable' || c.type === 'partially_refundable'))\n    .reduce((s, c) => s + c.amount, 0)\n\n  const totalNonrefundable = credits\n    .filter(c => c.eligible && c.type === 'nonrefundable')\n    .reduce((s, c) => s + c.amount, 0)\n\n  const totalCredits = totalRefundable + totalNonrefundable\n\n  // Nonrefundable credits are limited by tax liability\n  const taxLiability = report.federalIncomeTax\n  const usableNonrefundable = Math.min(totalNonrefundable, taxLiability)\n  const taxLiabilityReduction = usableNonrefundable + totalRefundable\n  const unusedCredits = Math.max(0, totalNonrefundable - taxLiability)\n\n  // Optimizations\n  const optimizations = findOptimizations(state, credits, agi, report)\n\n  return {\n    credits,\n    totalNonrefundable,\n    totalRefundable,\n    totalCredits,\n    taxLiabilityReduction,\n    optimizations,\n    unusedCredits,\n    effectiveCreditRate: report.grossIncome > 0 ? taxLiabilityReduction / report.grossIncome : 0,\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\tax-documents.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TaxReport' is defined but never used.","line":13,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":43,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TaxReport"},"fix":{"range":[430,446],"text":""},"desc":"Remove unused variable \"TaxReport\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — Actionable Tax Document Generator v8\n *\n * Generates ready-to-use tax documents:\n *  - 1040-ES Estimated Tax Payment Vouchers (all 4 quarters)\n *  - State-specific Entity Formation Checklists\n *  - Schedule C / Schedule SE Draft Worksheets\n *  - Retirement Contribution Optimization Worksheet\n *  - Audit Documentation Checklist\n */\n\nimport type { FortunaState } from './storage'\nimport { generateTaxReport, type TaxReport } from './tax-calculator'\nimport { hasPortfolioData, computePortfolioSummary } from './portfolio-bridge'\n\n// ===================================================================\n//  1040-ES ESTIMATED TAX PAYMENT VOUCHERS\n// ===================================================================\n\nexport interface EstimatedPaymentVoucher {\n  quarter: 1 | 2 | 3 | 4\n  dueDate: string\n  paymentAmount: number\n  cumulativePaid: number\n  remainingForYear: number\n  taxYear: number\n  payeeName: string\n  ssn: string // placeholder\n  address: string\n  paymentMethod: string\n  irsMailAddress: string\n  formContent: string // rendered voucher text\n}\n\nexport function generate1040ES(state: FortunaState): {\n  vouchers: EstimatedPaymentVoucher[]\n  totalEstimated: number\n  safeHarborAmount: number\n  notes: string[]\n} {\n  const report = generateTaxReport(state)\n  const taxYear = new Date().getFullYear()\n  const quarterly = report.quarterlyEstimated\n  const totalEstimated = quarterly * 4\n\n  // Safe harbor: pay at least 100% of prior year tax (or 110% if AGI > $150K)\n  const safeHarbor = report.agi > 150000 ? totalEstimated * 1.10 : totalEstimated\n  const safeHarborQuarterly = Math.ceil(safeHarbor / 4)\n\n  const dueDates = [\n    `April 15, ${taxYear}`,\n    `June 15, ${taxYear}`,\n    `September 15, ${taxYear}`,\n    `January 15, ${taxYear + 1}`,\n  ]\n\n  // IRS mailing addresses by state (simplified — Southeast, Northeast, etc.)\n  const stateMailMap: Record<string, string> = {\n    DEFAULT: 'Internal Revenue Service\\nP.O. Box 1300\\nCharlotte, NC 28201-1300',\n    CT: 'Internal Revenue Service\\nP.O. Box 931000\\nLouisville, KY 40293-1000',\n    NY: 'Internal Revenue Service\\nP.O. Box 931000\\nLouisville, KY 40293-1000',\n    CA: 'Internal Revenue Service\\nP.O. Box 510000\\nSan Francisco, CA 94151-5100',\n    TX: 'Internal Revenue Service\\nP.O. Box 1300\\nCharlotte, NC 28201-1300',\n    IL: 'Internal Revenue Service\\nP.O. Box 931000\\nLouisville, KY 40293-1000',\n    FL: 'Internal Revenue Service\\nP.O. Box 1300\\nCharlotte, NC 28201-1300',\n  }\n\n  const irsAddress = stateMailMap[state.profile.state] || stateMailMap.DEFAULT\n\n  const vouchers: EstimatedPaymentVoucher[] = [1, 2, 3, 4].map((q, i) => {\n    const quarterNum = q as 1 | 2 | 3 | 4\n    return {\n      quarter: quarterNum,\n      dueDate: dueDates[i],\n      paymentAmount: safeHarborQuarterly,\n      cumulativePaid: safeHarborQuarterly * q,\n      remainingForYear: safeHarborQuarterly * (4 - q),\n      taxYear,\n      payeeName: state.profile.name || '[YOUR NAME]',\n      ssn: 'XXX-XX-XXXX',\n      address: `[YOUR ADDRESS], ${state.profile.state}`,\n      paymentMethod: 'Check payable to \"United States Treasury\" or pay online at irs.gov/payments',\n      irsMailAddress: irsAddress,\n      formContent: generateVoucherText(\n        quarterNum, dueDates[i], safeHarborQuarterly, taxYear,\n        state.profile.name || '[YOUR NAME]', state.profile.state, irsAddress,\n      ),\n    }\n  })\n\n  const notes: string[] = [\n    `Based on estimated ${taxYear} total federal tax of $${totalEstimated.toLocaleString()}.`,\n    `Safe harbor amount: $${safeHarbor.toLocaleString()} (${report.agi > 150000 ? '110%' : '100%'} of estimated tax).`,\n    'Pay online at irs.gov/payments (recommended) or mail with Form 1040-ES voucher.',\n    'If income changes significantly, recalculate quarterly amounts using Fortuna\\'s scenario modeler.',\n    report.selfEmploymentTax > 0\n      ? `Includes $${report.selfEmploymentTax.toLocaleString()} self-employment tax.`\n      : '',\n  ].filter(Boolean)\n\n  return { vouchers, totalEstimated, safeHarborAmount: safeHarbor, notes }\n}\n\nfunction generateVoucherText(\n  quarter: number, dueDate: string, amount: number, taxYear: number,\n  name: string, stateCode: string, irsAddress: string,\n): string {\n  return `\n╔══════════════════════════════════════════════════════════════════════╗\n║                  FORM 1040-ES PAYMENT VOUCHER ${quarter}                    ║\n║                     Tax Year ${taxYear}                                ║\n╠══════════════════════════════════════════════════════════════════════╣\n║                                                                      ║\n║  Name:    ${name.padEnd(50)}        ║\n║  SSN:     XXX-XX-XXXX                                                ║\n║  State:   ${stateCode}                                                       ║\n║                                                                      ║\n║  ┌─────────────────────────────────────────────┐                     ║\n║  │ PAYMENT AMOUNT:  $${amount.toLocaleString().padEnd(28)}│                     ║\n║  │ DUE DATE:        ${dueDate.padEnd(29)}│                     ║\n║  │ QUARTER:         Q${quarter} of ${taxYear}                       │                     ║\n║  └─────────────────────────────────────────────┘                     ║\n║                                                                      ║\n║  Make check payable to: United States Treasury                       ║\n║  Write \"${taxYear} Form 1040-ES\" and your SSN on check              ║\n║                                                                      ║\n║  Mail to:                                                            ║\n║  ${irsAddress.split('\\n').map(l => l.padEnd(60)).join('║\\n║  ')}           ║\n║                                                                      ║\n║  OR pay online: irs.gov/payments (Direct Pay or EFTPS)               ║\n║                                                                      ║\n╚══════════════════════════════════════════════════════════════════════╝\n\n  ⚠ This is a worksheet — not an official IRS form. Use as reference\n    when making payments via IRS Direct Pay or when completing the\n    official Form 1040-ES from irs.gov/pub/irs-pdf/f1040es.pdf\n`.trim()\n}\n\n// ===================================================================\n//  ENTITY FORMATION CHECKLIST\n// ===================================================================\n\nexport interface FormationStep {\n  step: number\n  title: string\n  description: string\n  estimatedCost: string\n  timeline: string\n  resource?: string\n  completed: boolean\n}\n\nexport interface EntityFormationChecklist {\n  entityType: string\n  state: string\n  stateName: string\n  totalEstimatedCost: string\n  totalTimeline: string\n  steps: FormationStep[]\n  warnings: string[]\n  tips: string[]\n}\n\nconst STATE_NAMES: Record<string, string> = {\n  AL:'Alabama',AK:'Alaska',AZ:'Arizona',AR:'Arkansas',CA:'California',CO:'Colorado',\n  CT:'Connecticut',DE:'Delaware',FL:'Florida',GA:'Georgia',HI:'Hawaii',ID:'Idaho',\n  IL:'Illinois',IN:'Indiana',IA:'Iowa',KS:'Kansas',KY:'Kentucky',LA:'Louisiana',\n  ME:'Maine',MD:'Maryland',MA:'Massachusetts',MI:'Michigan',MN:'Minnesota',MS:'Mississippi',\n  MO:'Missouri',MT:'Montana',NE:'Nebraska',NV:'Nevada',NH:'New Hampshire',NJ:'New Jersey',\n  NM:'New Mexico',NY:'New York',NC:'North Carolina',ND:'North Dakota',OH:'Ohio',OK:'Oklahoma',\n  OR:'Oregon',PA:'Pennsylvania',RI:'Rhode Island',SC:'South Carolina',SD:'South Dakota',\n  TN:'Tennessee',TX:'Texas',UT:'Utah',VT:'Vermont',VA:'Virginia',WA:'Washington',\n  WV:'West Virginia',WI:'Wisconsin',WY:'Wyoming',DC:'District of Columbia',\n}\n\nconst STATE_FEES: Record<string, { llc: number; corp: number; annual: number }> = {\n  CA: { llc: 70, corp: 100, annual: 800 },\n  NY: { llc: 200, corp: 125, annual: 25 },\n  TX: { llc: 300, corp: 300, annual: 0 },\n  FL: { llc: 125, corp: 70, annual: 138 },\n  IL: { llc: 150, corp: 150, annual: 75 },\n  DE: { llc: 90, corp: 89, annual: 300 },\n  WY: { llc: 100, corp: 100, annual: 60 },\n  NV: { llc: 75, corp: 75, annual: 350 },\n  WA: { llc: 200, corp: 180, annual: 60 },\n  DEFAULT: { llc: 150, corp: 150, annual: 100 },\n}\n\nexport function generateFormationChecklist(\n  entityType: 'llc' | 'llc_scorp' | 'scorp' | 'ccorp',\n  stateCode: string,\n): EntityFormationChecklist {\n  const fees = STATE_FEES[stateCode] || STATE_FEES.DEFAULT\n  const stateName = STATE_NAMES[stateCode] || stateCode\n  const isLLC = entityType === 'llc' || entityType === 'llc_scorp'\n  const isSCorp = entityType === 'llc_scorp' || entityType === 'scorp'\n  const formationFee = isLLC ? fees.llc : fees.corp\n\n  const steps: FormationStep[] = []\n  let step = 0\n\n  // 1. Name availability\n  steps.push({\n    step: ++step, title: 'Check Name Availability',\n    description: `Search the ${stateName} Secretary of State business database to verify your desired business name is available. Most states allow online name searches.`,\n    estimatedCost: 'Free',\n    timeline: '1 day',\n    resource: `https://www.sos.${stateCode.toLowerCase()}.gov (or search \"${stateName} Secretary of State business search\")`,\n    completed: false,\n  })\n\n  // 2. Register with state\n  steps.push({\n    step: ++step, title: isLLC ? 'File Articles of Organization' : 'File Articles of Incorporation',\n    description: isLLC\n      ? `File Articles of Organization with the ${stateName} Secretary of State. Include: business name, registered agent, organizer name, and management structure (member-managed vs. manager-managed).`\n      : `File Articles of Incorporation with the ${stateName} Secretary of State. Include: corporate name, registered agent, number of authorized shares, and incorporator information.`,\n    estimatedCost: `$${formationFee}`,\n    timeline: '1-3 weeks (expedited available in most states)',\n    completed: false,\n  })\n\n  // 3. EIN\n  steps.push({\n    step: ++step, title: 'Obtain EIN from IRS',\n    description: 'Apply for an Employer Identification Number (EIN) from the IRS. Required for business bank accounts, hiring employees, and tax filings. Apply online for immediate issuance.',\n    estimatedCost: 'Free',\n    timeline: 'Immediate (online)',\n    resource: 'https://www.irs.gov/businesses/small-businesses-self-employed/apply-for-an-employer-identification-number-ein-online',\n    completed: false,\n  })\n\n  // 4. Operating Agreement / Bylaws\n  steps.push({\n    step: ++step, title: isLLC ? 'Draft Operating Agreement' : 'Draft Corporate Bylaws',\n    description: isLLC\n      ? 'Create an Operating Agreement defining ownership structure, member responsibilities, profit distribution, and dissolution procedures. Not filed with the state but essential for legal protection.'\n      : 'Create Corporate Bylaws governing board meetings, officer roles, shareholder rights, and corporate procedures.',\n    estimatedCost: '$0 (self-drafted) – $500 (attorney)',\n    timeline: '1-2 weeks',\n    completed: false,\n  })\n\n  // 5. Registered Agent\n  steps.push({\n    step: ++step, title: 'Designate Registered Agent',\n    description: `Appoint a registered agent with a physical address in ${stateName} to receive legal documents and state correspondence. Can be yourself, a business member, or a professional service.`,\n    estimatedCost: '$0 (self) – $125/yr (service)',\n    timeline: 'Same day',\n    completed: false,\n  })\n\n  // 6. Business Bank Account\n  steps.push({\n    step: ++step, title: 'Open Business Bank Account',\n    description: 'Open a dedicated business checking account. Bring: EIN confirmation letter, Articles of Organization/Incorporation, Operating Agreement/Bylaws, and government-issued ID.',\n    estimatedCost: '$0-25/mo',\n    timeline: '1 day',\n    completed: false,\n  })\n\n  // S-Corp Election\n  if (isSCorp) {\n    steps.push({\n      step: ++step, title: 'File IRS Form 2553 (S-Corp Election)',\n      description: 'File Form 2553 with the IRS to elect S-Corporation tax status. Must be filed within 75 days of formation OR by March 15 for the current tax year. All shareholders must sign.',\n      estimatedCost: 'Free',\n      timeline: '1-2 months for IRS acceptance letter',\n      resource: 'https://www.irs.gov/forms-pubs/about-form-2553',\n      completed: false,\n    })\n\n    steps.push({\n      step: ++step, title: 'Set Up Payroll',\n      description: 'S-Corps must pay owner-employees a reasonable salary via payroll. Set up payroll service (Gusto, ADP, or similar) to handle W-2 issuance, tax withholding, and quarterly payroll tax filings.',\n      estimatedCost: '$40-80/mo',\n      timeline: '1 week',\n      completed: false,\n    })\n  }\n\n  // 7. Business licenses\n  steps.push({\n    step: ++step, title: 'Obtain Required Business Licenses',\n    description: `Check ${stateName} and local municipality requirements for business licenses, permits, and professional registrations applicable to your industry.`,\n    estimatedCost: 'Varies ($0-500)',\n    timeline: '1-4 weeks',\n    completed: false,\n  })\n\n  // 8. Annual filing\n  steps.push({\n    step: ++step, title: 'Note Annual Filing Requirements',\n    description: `${stateName} requires annual reports/franchise tax filings. Annual cost: ~$${fees.annual}. Mark deadlines in your calendar to maintain good standing.`,\n    estimatedCost: `$${fees.annual}/yr`,\n    timeline: 'Recurring annually',\n    completed: false,\n  })\n\n  // Estimated totals\n  const baseCost = formationFee + (isSCorp ? 480 : 0) // payroll year 1\n  const totalCost = `$${baseCost.toLocaleString()} – $${(baseCost + 700).toLocaleString()}`\n  const totalTimeline = isSCorp ? '3-6 weeks' : '2-4 weeks'\n\n  // State-specific warnings\n  const warnings: string[] = []\n  if (stateCode === 'CA') {\n    warnings.push('California imposes an $800 minimum franchise tax on all LLCs and corporations, due annually regardless of income.')\n  }\n  if (stateCode === 'NY') {\n    warnings.push('New York requires LLCs to publish formation notice in two newspapers for 6 consecutive weeks ($200-2,000+ depending on county).')\n  }\n  if (isSCorp) {\n    warnings.push('S-Corp election requires \"reasonable compensation\" to owner-employees. Underpaying salary is a top IRS audit trigger.')\n    warnings.push('Form 2553 must be filed within 75 days of formation or by March 15 for current-year election. Late elections require reasonable cause.')\n  }\n\n  const tips = [\n    isLLC ? 'Member-managed LLCs are simpler for single-owner businesses. Manager-managed works better for passive investors.' : '',\n    isSCorp ? 'Use Fortuna\\'s Entity Optimizer to determine your optimal salary/distribution split.' : '',\n    'Keep personal and business finances completely separate to maintain liability protection.',\n    `Consider forming in your home state (${stateName}) rather than Delaware or Wyoming — the multi-state compliance costs usually outweigh any benefits for small businesses.`,\n  ].filter(Boolean)\n\n  return {\n    entityType: entityType === 'llc_scorp' ? 'LLC with S-Corp Election' : entityType.toUpperCase(),\n    state: stateCode,\n    stateName,\n    totalEstimatedCost: totalCost,\n    totalTimeline,\n    steps,\n    warnings,\n    tips,\n  }\n}\n\n// ===================================================================\n//  SCHEDULE C DRAFT WORKSHEET\n// ===================================================================\n\nexport interface ScheduleCLine {\n  line: string\n  label: string\n  amount: number\n  notes?: string\n}\n\nexport interface ScheduleCWorksheet {\n  taxYear: number\n  businessName: string\n  businessCode: string\n  ein: string\n  grossReceipts: number\n  totalExpenses: number\n  netProfit: number\n  lines: ScheduleCLine[]\n  partII: ScheduleCLine[] // expenses by category\n  seTaxEstimate: number\n  seDeduction: number\n  formContent: string\n}\n\nconst SCHEDULE_C_EXPENSE_CATEGORIES: Record<string, { line: string; label: string }> = {\n  advertising: { line: '8', label: 'Advertising' },\n  vehicle: { line: '9', label: 'Car and truck expenses' },\n  commissions: { line: '10', label: 'Commissions and fees' },\n  contract_labor: { line: '11', label: 'Contract labor' },\n  depreciation: { line: '13', label: 'Depreciation and section 179' },\n  insurance: { line: '15', label: 'Insurance (other than health)' },\n  interest: { line: '16', label: 'Interest (mortgage/other)' },\n  legal: { line: '17', label: 'Legal and professional services' },\n  office: { line: '18', label: 'Office expense' },\n  rent: { line: '20', label: 'Rent or lease' },\n  repairs: { line: '21', label: 'Repairs and maintenance' },\n  supplies: { line: '22', label: 'Supplies' },\n  taxes: { line: '23', label: 'Taxes and licenses' },\n  travel: { line: '24a', label: 'Travel' },\n  meals: { line: '24b', label: 'Deductible meals' },\n  utilities: { line: '25', label: 'Utilities' },\n  wages: { line: '26', label: 'Wages' },\n  other: { line: '27', label: 'Other expenses' },\n  home_office: { line: '30', label: 'Business use of home' },\n}\n\nexport function generateScheduleC(state: FortunaState): ScheduleCWorksheet {\n  const taxYear = new Date().getFullYear()\n  const report = generateTaxReport(state)\n\n  // Group expenses by category\n  const expensesByCategory: Record<string, number> = {}\n  state.expenses\n    .filter(e => e.isDeductible)\n    .forEach(e => {\n      const cat = e.category.toLowerCase().replace(/\\s+/g, '_')\n      const deductible = e.annualAmount * (e.deductionPct / 100)\n      expensesByCategory[cat] = (expensesByCategory[cat] || 0) + deductible\n    })\n\n  // Map to Schedule C lines\n  const partII: ScheduleCLine[] = []\n  let totalExpenses = 0\n\n  for (const [cat, amount] of Object.entries(expensesByCategory)) {\n    const mapping = SCHEDULE_C_EXPENSE_CATEGORIES[cat] || SCHEDULE_C_EXPENSE_CATEGORIES.other\n    partII.push({\n      line: mapping.line,\n      label: mapping.label,\n      amount: Math.round(amount),\n    })\n    totalExpenses += Math.round(amount)\n  }\n\n  // Add home office deduction if present\n  const homeOffice = state.deductions.find(d => d.category === 'home_office')\n  if (homeOffice) {\n    partII.push({\n      line: '30',\n      label: 'Business use of home',\n      amount: homeOffice.amount,\n    })\n    totalExpenses += homeOffice.amount\n  }\n\n  partII.sort((a, b) => parseInt(a.line) - parseInt(b.line))\n\n  const grossReceipts = report.selfEmploymentIncome\n  const netProfit = grossReceipts - totalExpenses\n\n  // SE tax calculation\n  const seBase = netProfit * 0.9235\n  const seTax = seBase > 0 ? Math.min(seBase, 176100) * 0.153 + Math.max(0, seBase - 176100) * 0.029 : 0\n  const seDeduction = seTax / 2\n\n  // Primary business entity\n  const primaryEntity = state.entities.find(e => e.isActive)\n\n  // Part I lines\n  const lines: ScheduleCLine[] = [\n    { line: '1', label: 'Gross receipts or sales', amount: grossReceipts },\n    { line: '2', label: 'Returns and allowances', amount: 0 },\n    { line: '3', label: 'Cost of goods sold', amount: 0 },\n    { line: '5', label: 'Gross income', amount: grossReceipts },\n    { line: '28', label: 'Total expenses', amount: totalExpenses },\n    { line: '29', label: 'Tentative profit (or loss)', amount: netProfit },\n    { line: '31', label: 'Net profit (or loss)', amount: netProfit },\n  ]\n\n  const formContent = renderScheduleC(\n    taxYear, state.profile.name, primaryEntity?.einNumber || 'XX-XXXXXXX',\n    grossReceipts, totalExpenses, netProfit, partII, seTax, seDeduction,\n  )\n\n  return {\n    taxYear,\n    businessName: primaryEntity?.name || state.profile.name || '[BUSINESS NAME]',\n    businessCode: '999999',\n    ein: primaryEntity?.einNumber || 'XX-XXXXXXX',\n    grossReceipts,\n    totalExpenses,\n    netProfit,\n    lines,\n    partII,\n    seTaxEstimate: Math.round(seTax),\n    seDeduction: Math.round(seDeduction),\n    formContent,\n  }\n}\n\nfunction renderScheduleC(\n  year: number, name: string, ein: string,\n  gross: number, expenses: number, net: number,\n  expenseLines: ScheduleCLine[], seTax: number, seDeduction: number,\n): string {\n  const dollarFmt = (n: number) => '$' + n.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })\n  const pad = (s: string, w: number) => s.padEnd(w)\n\n  let out = `\n╔══════════════════════════════════════════════════════════════════════╗\n║         SCHEDULE C DRAFT WORKSHEET — Profit or Loss                  ║\n║                    From Business (Sole Proprietorship)               ║\n║                         Tax Year ${year}                                ║\n╠══════════════════════════════════════════════════════════════════════╣\n║                                                                      ║\n║  Name: ${pad(name || '[YOUR NAME]', 54)}       ║\n║  EIN:  ${pad(ein, 54)}       ║\n║                                                                      ║\n║  ═══ PART I — INCOME ═════════════════════════════════════════════   ║\n║                                                                      ║\n║  1  Gross receipts or sales .............. ${pad(dollarFmt(gross), 16)}       ║\n║  5  Gross income ........................ ${pad(dollarFmt(gross), 16)}       ║\n║                                                                      ║\n║  ═══ PART II — EXPENSES ══════════════════════════════════════════   ║\n║                                                                      ║\n`\n\n  for (const line of expenseLines) {\n    out += `║  ${pad(line.line, 3)} ${pad(line.label, 36)} ${pad(dollarFmt(line.amount), 16)}       ║\\n`\n  }\n\n  out += `║                                                                      ║\n║  28  Total expenses ..................... ${pad(dollarFmt(expenses), 16)}       ║\n║                                                                      ║\n║  ═══ NET PROFIT ══════════════════════════════════════════════════   ║\n║                                                                      ║\n║  31  Net profit (or loss) ............... ${pad(dollarFmt(net), 16)}       ║\n║                                                                      ║\n║  ═══ SELF-EMPLOYMENT TAX (Schedule SE) ══════════════════════════   ║\n║                                                                      ║\n║  SE tax base (92.35% of net profit) .... ${pad(dollarFmt(Math.round(net * 0.9235)), 16)}       ║\n║  Estimated SE tax ....................... ${pad(dollarFmt(Math.round(seTax)), 16)}       ║\n║  SE tax deduction (50% of SE tax) ...... ${pad(dollarFmt(Math.round(seDeduction)), 16)}       ║\n║                                                                      ║\n╚══════════════════════════════════════════════════════════════════════╝\n\n  ⚠ DRAFT WORKSHEET — Not an official IRS form. Use as a reference when\n    preparing your actual Schedule C with your tax software or CPA.\n    Verify all amounts against your actual financial records.\n`\n\n  return out.trim()\n}\n\n// ===================================================================\n//  AUDIT DOCUMENTATION CHECKLIST\n// ===================================================================\n\nexport interface AuditDocItem {\n  category: string\n  items: {\n    description: string\n    scheduleRef: string\n    priority: 'essential' | 'recommended' | 'optional'\n    status: 'needed' | 'have' | 'na'\n  }[]\n}\n\nexport function generateAuditDocChecklist(state: FortunaState): AuditDocItem[] {\n  const categories: AuditDocItem[] = []\n\n  // Income documentation\n  const incomeItems: AuditDocItem['items'] = []\n  const hasW2 = state.incomeStreams.some(s => s.type === 'w2')\n  const hasSE = state.incomeStreams.some(s => ['business', 'freelance'].includes(s.type))\n  const hasInvest = state.incomeStreams.some(s => s.type === 'investment')\n\n  if (hasW2) {\n    incomeItems.push({ description: 'W-2 forms from all employers', scheduleRef: 'Form 1040, Line 1', priority: 'essential', status: 'needed' })\n  }\n  if (hasSE) {\n    incomeItems.push({ description: '1099-NEC / 1099-MISC for all clients', scheduleRef: 'Schedule C, Line 1', priority: 'essential', status: 'needed' })\n    incomeItems.push({ description: 'Business income ledger / P&L statement', scheduleRef: 'Schedule C', priority: 'essential', status: 'needed' })\n    incomeItems.push({ description: 'Bank statements (business account, 12 months)', scheduleRef: 'Schedule C', priority: 'essential', status: 'needed' })\n    incomeItems.push({ description: 'Invoices sent to clients (all)', scheduleRef: 'Schedule C, Line 1', priority: 'recommended', status: 'needed' })\n  }\n  if (hasInvest) {\n    incomeItems.push({ description: '1099-B (brokerage transactions)', scheduleRef: 'Schedule D', priority: 'essential', status: 'needed' })\n    incomeItems.push({ description: '1099-DIV (dividends)', scheduleRef: 'Schedule B', priority: 'essential', status: 'needed' })\n    incomeItems.push({ description: '1099-INT (interest income)', scheduleRef: 'Schedule B', priority: 'essential', status: 'needed' })\n  }\n  // Portfolio Intelligence — crypto & DeFi specific docs\n  if (hasPortfolioData()) {\n    const ps = computePortfolioSummary()\n    if (ps.activePositionCount > 0) {\n      const hasCrypto = Object.values(ps.allocationByClass).some((a) => a.count > 0 && ['crypto', 'defi', 'nft'].includes('crypto')) || ps.totalValue > 0\n      if (hasCrypto) {\n        incomeItems.push({ description: 'Crypto exchange transaction history (all exchanges)', scheduleRef: 'Form 8949', priority: 'essential', status: 'needed' })\n        incomeItems.push({ description: 'DeFi protocol transaction records', scheduleRef: 'Form 8949 / Schedule D', priority: 'essential', status: 'needed' })\n        incomeItems.push({ description: 'Wallet-to-wallet transfer records', scheduleRef: 'Cost basis tracking', priority: 'recommended', status: 'needed' })\n      }\n      if (ps.stakingRewards > 0) {\n        incomeItems.push({ description: `Staking reward records (~$${Math.round(ps.stakingRewards).toLocaleString()} tracked)`, scheduleRef: 'Schedule 1 / Schedule C', priority: 'essential', status: 'needed' })\n      }\n      if (ps.airdropIncome > 0) {\n        incomeItems.push({ description: `Airdrop documentation with FMV at receipt (~$${Math.round(ps.airdropIncome).toLocaleString()})`, scheduleRef: 'Schedule 1 (ordinary income)', priority: 'essential', status: 'needed' })\n      }\n      if (ps.miningIncome > 0) {\n        incomeItems.push({ description: `Mining income records + electricity/equipment costs (~$${Math.round(ps.miningIncome).toLocaleString()})`, scheduleRef: 'Schedule C', priority: 'essential', status: 'needed' })\n      }\n    }\n  }\n  incomeItems.push({ description: 'Prior year tax return (complete)', scheduleRef: 'Reference', priority: 'essential', status: 'needed' })\n  categories.push({ category: 'Income Documentation', items: incomeItems })\n\n  // Expense documentation\n  if (hasSE || state.expenses.length > 0) {\n    const expenseItems: AuditDocItem['items'] = [\n      { description: 'Receipts for all business expenses over $75', scheduleRef: 'Schedule C, Part II', priority: 'essential', status: 'needed' },\n      { description: 'Credit card statements (business purchases)', scheduleRef: 'Schedule C', priority: 'essential', status: 'needed' },\n      { description: 'Mileage log (if claiming vehicle expenses)', scheduleRef: 'Schedule C, Line 9', priority: 'essential', status: 'needed' },\n    ]\n\n    const hasHomeOffice = state.deductions.some(d => d.category === 'home_office')\n    if (hasHomeOffice) {\n      expenseItems.push({ description: 'Home office measurements (sq ft of office vs total)', scheduleRef: 'Form 8829', priority: 'essential', status: 'needed' })\n      expenseItems.push({ description: 'Mortgage interest / rent payments', scheduleRef: 'Form 8829', priority: 'essential', status: 'needed' })\n      expenseItems.push({ description: 'Utility bills (12 months)', scheduleRef: 'Form 8829', priority: 'recommended', status: 'needed' })\n      expenseItems.push({ description: 'Photo of dedicated home office space', scheduleRef: 'Form 8829', priority: 'recommended', status: 'needed' })\n    }\n\n    expenseItems.push({ description: 'Software/subscription receipts', scheduleRef: 'Schedule C, Line 18/27', priority: 'recommended', status: 'needed' })\n    expenseItems.push({ description: 'Professional services invoices (legal, accounting)', scheduleRef: 'Schedule C, Line 17', priority: 'recommended', status: 'needed' })\n    expenseItems.push({ description: 'Insurance policy documentation', scheduleRef: 'Schedule C, Line 15', priority: 'recommended', status: 'needed' })\n\n    categories.push({ category: 'Expense Documentation', items: expenseItems })\n  }\n\n  // Entity documentation\n  if (state.entities.length > 0) {\n    categories.push({\n      category: 'Entity & Legal',\n      items: [\n        { description: 'Articles of Organization / Incorporation', scheduleRef: 'Entity records', priority: 'essential', status: 'needed' },\n        { description: 'Operating Agreement / Corporate Bylaws', scheduleRef: 'Entity records', priority: 'essential', status: 'needed' },\n        { description: 'EIN confirmation letter', scheduleRef: 'Entity records', priority: 'essential', status: 'needed' },\n        { description: 'S-Corp election acceptance (Form 2553)', scheduleRef: 'Form 1120-S', priority: state.entities.some(e => e.type === 'llc_scorp' || e.type === 'scorp') ? 'essential' : 'optional', status: 'needed' },\n        { description: 'Reasonable compensation analysis', scheduleRef: 'Form 1120-S', priority: state.entities.some(e => e.type === 'llc_scorp' || e.type === 'scorp') ? 'essential' : 'optional', status: 'needed' },\n      ],\n    })\n  }\n\n  // Deduction documentation\n  const deductionItems: AuditDocItem['items'] = []\n  const hasRetirement = state.deductions.some(d => d.category === 'retirement')\n  const hasCharitable = state.deductions.some(d => d.category === 'charitable')\n  const hasHealth = state.deductions.some(d => d.category === 'health')\n\n  if (hasRetirement) {\n    deductionItems.push({ description: '5498 forms (IRA/SEP/Solo 401k contributions)', scheduleRef: 'Form 1040, Line 20', priority: 'essential', status: 'needed' })\n    deductionItems.push({ description: 'Solo 401k adoption agreement', scheduleRef: 'Retirement plan', priority: 'recommended', status: 'needed' })\n  }\n  if (hasCharitable) {\n    deductionItems.push({ description: 'Charitable donation receipts', scheduleRef: 'Schedule A, Line 12', priority: 'essential', status: 'needed' })\n    deductionItems.push({ description: 'Written acknowledgment for donations over $250', scheduleRef: 'Schedule A', priority: 'essential', status: 'needed' })\n  }\n  if (hasHealth) {\n    deductionItems.push({ description: 'Health insurance premium statements (Form 1095)', scheduleRef: 'Schedule A / Schedule C', priority: 'essential', status: 'needed' })\n  }\n  deductionItems.push({ description: 'Estimated tax payment records (1040-ES)', scheduleRef: 'Form 1040, Line 26', priority: 'essential', status: 'needed' })\n\n  if (deductionItems.length > 0) {\n    categories.push({ category: 'Deduction & Credit Documentation', items: deductionItems })\n  }\n\n  return categories\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\tax-prep.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TaxReport' is defined but never used.","line":8,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":43,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TaxReport"},"fix":{"range":[255,271],"text":""},"desc":"Remove unused variable \"TaxReport\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ficaWithheld' is assigned a value but never used.","line":181,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":181,"endColumn":21}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine - Tax Preparation Checklist\n * Generates a comprehensive filing preparation summary organized by form,\n * with document tracking and CPA-ready export data.\n */\n\nimport type { FortunaState } from './storage'\nimport { generateTaxReport, type TaxReport } from './tax-calculator'\n\nexport interface TaxPrepItem {\n  id: string\n  form: string\n  description: string\n  category: 'income' | 'deduction' | 'entity' | 'payment' | 'document' | 'action'\n  status: 'complete' | 'partial' | 'missing' | 'na'\n  amount?: number\n  notes: string\n  priority: 'required' | 'recommended' | 'optional'\n  dueDate?: string\n}\n\nexport interface TaxPrepSection {\n  title: string\n  icon: string\n  items: TaxPrepItem[]\n  completionPct: number\n}\n\nexport interface TaxPrepChecklist {\n  filingYear: number\n  filingDeadline: string\n  filingStatus: string\n  sections: TaxPrepSection[]\n  overallCompletion: number\n  estimatedRefundOrOwed: number\n  isRefund: boolean\n  criticalMissing: TaxPrepItem[]\n  summary: {\n    totalIncome: number\n    totalDeductions: number\n    totalTax: number\n    totalWithheld: number\n    totalEstimatedPaid: number\n    netOwed: number\n  }\n}\n\nexport function generateTaxPrepChecklist(state: FortunaState): TaxPrepChecklist {\n  const report = generateTaxReport(state)\n  const year = new Date().getFullYear() - 1 // Prep is for prior year\n  const filingDeadline = `April 15, ${year + 1}`\n  \n  const sections: TaxPrepSection[] = []\n\n  // ─── Section 1: W-2 Income ──────────────────────────────────────\n  const w2Streams = state.incomeStreams.filter(s => s.type === 'w2' && s.isActive)\n  const w2Items: TaxPrepItem[] = w2Streams.map((s, i) => {\n    const w2 = s.w2 || {}\n    const hasBasic = s.annualAmount > 0\n    const hasWithholding = (w2.federalWithholding || 0) > 0\n    const status = hasBasic && hasWithholding ? 'complete' : hasBasic ? 'partial' : 'missing'\n    return {\n      id: `w2-${i}`, form: 'W-2', description: `${w2.employerName || s.name || 'Employer'} — Wages`,\n      category: 'income' as const, status,\n      amount: s.annualAmount,\n      notes: status === 'complete'\n        ? `Wages: $${s.annualAmount.toLocaleString()}, Fed withheld: $${(w2.federalWithholding || 0).toLocaleString()}`\n        : status === 'partial' ? 'Missing withholding details — enter federal/state withheld amounts'\n        : 'Need W-2 from employer',\n      priority: 'required' as const,\n    }\n  })\n  if (w2Items.length === 0 && w2Streams.length === 0) {\n    // Check if they might need W-2s\n    w2Items.push({\n      id: 'w2-check', form: 'W-2', description: 'Confirm: Any employment income this year?',\n      category: 'document', status: 'na', notes: 'No W-2 income entered. If you had employment income, add it in Setup.',\n      priority: 'recommended',\n    })\n  }\n  sections.push(buildSection('W-2 Employment Income', '💼', w2Items))\n\n  // ─── Section 2: Self-Employment / Schedule C ──────────────────────\n  const seStreams = state.incomeStreams.filter(s => ['business', 'freelance'].includes(s.type) && s.isActive)\n  const seItems: TaxPrepItem[] = []\n  if (seStreams.length > 0) {\n    const totalSE = seStreams.reduce((s, i) => s + i.annualAmount, 0)\n    const bizExpenses = state.expenses.filter(e => e.isDeductible).reduce((s, e) => s + e.annualAmount, 0)\n    seItems.push({\n      id: 'sched-c-income', form: 'Schedule C', description: 'Gross Business Income',\n      category: 'income', status: totalSE > 0 ? 'complete' : 'missing',\n      amount: totalSE, notes: `${seStreams.length} business income stream(s) totaling $${totalSE.toLocaleString()}`,\n      priority: 'required',\n    })\n    seItems.push({\n      id: 'sched-c-expenses', form: 'Schedule C', description: 'Business Expenses',\n      category: 'deduction', status: bizExpenses > 0 ? 'complete' : 'partial',\n      amount: bizExpenses, notes: bizExpenses > 0\n        ? `$${bizExpenses.toLocaleString()} in deductible expenses entered`\n        : 'No business expenses entered — likely missing deductions',\n      priority: 'required',\n    })\n    seItems.push({\n      id: 'sched-se', form: 'Schedule SE', description: 'Self-Employment Tax',\n      category: 'payment', status: 'complete',\n      amount: report.selfEmploymentTax,\n      notes: `SE tax: $${report.selfEmploymentTax.toLocaleString()} (15.3% on 92.35% of net SE income)`,\n      priority: 'required',\n    })\n    // 1099 tracking\n    for (const s of seStreams) {\n      seItems.push({\n        id: `1099-${s.id}`, form: '1099-NEC/MISC', description: `${s.name || 'Business'} — collect 1099 forms`,\n        category: 'document', status: 'missing',\n        notes: `Clients who paid $600+ should send 1099-NEC. Check for $${s.annualAmount.toLocaleString()} income.`,\n        priority: 'recommended',\n      })\n    }\n  }\n  if (seItems.length > 0) sections.push(buildSection('Self-Employment / Schedule C', '🏢', seItems))\n\n  // ─── Section 3: Entity K-1s ────────────────────────────────────────\n  const activeEntities = state.entities.filter(e => e.isActive)\n  const entityItems: TaxPrepItem[] = activeEntities.map(e => ({\n    id: `k1-${e.id}`, form: e.type.includes('scorp') ? 'Schedule K-1 (1120-S)' : 'Schedule K-1 (1065)',\n    description: `${e.name} — ${e.type.toUpperCase()} K-1`,\n    category: 'entity' as const, status: 'missing' as const,\n    notes: `Need K-1 from ${e.name}. Entity return (${e.type.includes('scorp') ? '1120-S' : '1065'}) due March 15.`,\n    priority: 'required' as const, dueDate: `March 15, ${year + 1}`,\n  }))\n  if (activeEntities.length > 0) {\n    entityItems.push({\n      id: 'entity-return', form: activeEntities[0].type.includes('scorp') ? '1120-S' : '1065',\n      description: 'Entity Tax Return Filing',\n      category: 'action', status: 'missing',\n      notes: `Entity return due March 15 (before personal return). File or extend.`,\n      priority: 'required', dueDate: `March 15, ${year + 1}`,\n    })\n  }\n  if (entityItems.length > 0) sections.push(buildSection('Entity / Pass-Through K-1s', '🏛️', entityItems))\n\n  // ─── Section 4: Deductions ─────────────────────────────────────────\n  const dedItems: TaxPrepItem[] = []\n  const retirementDeds = state.deductions.filter(d => d.category === 'retirement')\n  const totalRetirement = retirementDeds.reduce((s, d) => s + d.amount, 0)\n  const w2Retirement = w2Streams.reduce((s, i) => s + (i.w2?.pretax401k || 0), 0)\n  if (totalRetirement + w2Retirement > 0) {\n    dedItems.push({\n      id: 'retirement-ded', form: 'Form 8880 / 1040', description: 'Retirement Contributions',\n      category: 'deduction', status: 'complete', amount: totalRetirement + w2Retirement,\n      notes: `Total: $${(totalRetirement + w2Retirement).toLocaleString()} (W-2 401k: $${w2Retirement.toLocaleString()}, Other: $${totalRetirement.toLocaleString()})`,\n      priority: 'required',\n    })\n  }\n  // Standard vs Itemized\n  const stdDed = report.standardDeduction || 14600\n  const itemizedTotal = state.deductions.filter(d => !['retirement', 'above_line'].includes(d.category)).reduce((s, d) => s + d.amount, 0)\n  dedItems.push({\n    id: 'std-vs-itemized', form: 'Schedule A / 1040', description: 'Standard vs. Itemized Deduction',\n    category: 'deduction', status: 'complete',\n    amount: Math.max(stdDed, itemizedTotal),\n    notes: itemizedTotal > stdDed\n      ? `Itemizing saves $${(itemizedTotal - stdDed).toLocaleString()} over standard deduction`\n      : `Standard deduction ($${stdDed.toLocaleString()}) is better than itemized ($${itemizedTotal.toLocaleString()})`,\n    priority: 'required',\n  })\n  if (report.qbiDeduction > 0) {\n    dedItems.push({\n      id: 'qbi', form: 'Form 8995', description: 'QBI Deduction (Section 199A)',\n      category: 'deduction', status: 'complete', amount: report.qbiDeduction,\n      notes: `$${report.qbiDeduction.toLocaleString()} QBI deduction (20% of qualified business income)`,\n      priority: 'required',\n    })\n  }\n  sections.push(buildSection('Deductions & Adjustments', '📋', dedItems))\n\n  // ─── Section 5: Tax Payments Made ──────────────────────────────────\n  const paymentItems: TaxPrepItem[] = []\n  const fedWithheld = report.w2FederalWithheld\n  const stateWithheld = report.w2StateWithheld\n  const ficaWithheld = report.w2FICAWithheld\n  if (fedWithheld > 0) {\n    paymentItems.push({\n      id: 'w2-fed-withheld', form: 'W-2 Box 2', description: 'Federal Income Tax Withheld',\n      category: 'payment', status: 'complete', amount: fedWithheld,\n      notes: `$${fedWithheld.toLocaleString()} withheld from W-2 paychecks`,\n      priority: 'required',\n    })\n  }\n  if (stateWithheld > 0) {\n    paymentItems.push({\n      id: 'w2-state-withheld', form: 'W-2 Box 17', description: 'State Income Tax Withheld',\n      category: 'payment', status: 'complete', amount: stateWithheld,\n      notes: `$${stateWithheld.toLocaleString()} state tax withheld`,\n      priority: 'required',\n    })\n  }\n  // Estimated tax payments\n  paymentItems.push({\n    id: 'est-q1', form: '1040-ES', description: 'Q1 Estimated Payment (Apr 15)',\n    category: 'payment', status: 'missing', notes: 'Enter amount of Q1 estimated tax payment made, if any',\n    priority: seStreams.length > 0 ? 'required' : 'optional',\n  })\n  paymentItems.push({\n    id: 'est-q2', form: '1040-ES', description: 'Q2 Estimated Payment (Jun 15)',\n    category: 'payment', status: 'missing', notes: 'Enter amount of Q2 estimated tax payment made',\n    priority: seStreams.length > 0 ? 'required' : 'optional',\n  })\n  paymentItems.push({\n    id: 'est-q3', form: '1040-ES', description: 'Q3 Estimated Payment (Sep 15)',\n    category: 'payment', status: 'missing', notes: 'Enter amount of Q3 estimated tax payment made',\n    priority: seStreams.length > 0 ? 'required' : 'optional',\n  })\n  paymentItems.push({\n    id: 'est-q4', form: '1040-ES', description: 'Q4 Estimated Payment (Jan 15)',\n    category: 'payment', status: 'missing', notes: 'Enter amount of Q4 estimated tax payment made',\n    priority: seStreams.length > 0 ? 'required' : 'optional',\n  })\n  sections.push(buildSection('Tax Payments & Withholding', '💰', paymentItems))\n\n  // ─── Section 6: Documents to Collect ───────────────────────────────\n  const docItems: TaxPrepItem[] = []\n  docItems.push({\n    id: 'doc-id', form: 'General', description: 'Photo ID & Social Security numbers',\n    category: 'document', status: 'missing', notes: 'SSN for you, spouse (if filing jointly), and all dependents',\n    priority: 'required',\n  })\n  if (w2Streams.length > 0) {\n    docItems.push({\n      id: 'doc-w2', form: 'W-2', description: `W-2 forms from ${w2Streams.length} employer(s)`,\n      category: 'document', status: 'missing', notes: 'Usually available by Jan 31. Check employer portal.',\n      priority: 'required',\n    })\n  }\n  docItems.push({\n    id: 'doc-1099-int', form: '1099-INT', description: 'Bank interest statements',\n    category: 'document', status: 'missing', notes: 'From banks/credit unions for interest earned > $10',\n    priority: 'recommended',\n  })\n  docItems.push({\n    id: 'doc-1099-div', form: '1099-DIV', description: 'Dividend statements',\n    category: 'document', status: 'missing', notes: 'From brokerages for dividends received',\n    priority: 'recommended',\n  })\n  if (state.incomeStreams.some(s => s.type === 'investment')) {\n    docItems.push({\n      id: 'doc-1099-b', form: '1099-B', description: 'Investment sales / capital gains',\n      category: 'document', status: 'missing', notes: 'From brokerages for stock/crypto/asset sales',\n      priority: 'required',\n    })\n  }\n  if (state.profile.hasHealthInsurance) {\n    docItems.push({\n      id: 'doc-1095', form: '1095-A/B/C', description: 'Health insurance coverage proof',\n      category: 'document', status: 'missing', notes: '1095-A if marketplace, 1095-B/C from insurer/employer',\n      priority: 'recommended',\n    })\n  }\n  if (state.incomeStreams.some(s => s.type === 'rental')) {\n    docItems.push({\n      id: 'doc-rental', form: 'Schedule E', description: 'Rental income & expense records',\n      category: 'document', status: 'missing', notes: 'Rent received, mortgage interest (1098), repairs, depreciation',\n      priority: 'required',\n    })\n  }\n  sections.push(buildSection('Documents to Collect', '📁', docItems))\n\n  // ─── Section 7: Filing Actions ─────────────────────────────────────\n  const actionItems: TaxPrepItem[] = []\n  actionItems.push({\n    id: 'action-review', form: '1040', description: 'Review all income sources for completeness',\n    category: 'action', status: state.incomeStreams.length > 0 ? 'complete' : 'missing',\n    notes: `${state.incomeStreams.filter(s => s.isActive).length} active income streams entered`,\n    priority: 'required',\n  })\n  actionItems.push({\n    id: 'action-efile', form: '1040', description: 'Choose filing method',\n    category: 'action', status: 'missing',\n    notes: 'E-file (free for AGI < $84k via IRS Free File), tax software, or CPA',\n    priority: 'required',\n  })\n  if (activeEntities.length > 0) {\n    actionItems.push({\n      id: 'action-entity-first', form: activeEntities[0].type.includes('scorp') ? '1120-S' : '1065',\n      description: '⚠️ File entity return BEFORE personal return',\n      category: 'action', status: 'missing',\n      notes: `Entity return due March 15 — must be filed first to get K-1 for personal return`,\n      priority: 'required', dueDate: `March 15, ${year + 1}`,\n    })\n  }\n  if (report.netTaxOwed > 1000) {\n    actionItems.push({\n      id: 'action-payment-plan', form: '9465', description: 'Consider IRS payment plan if owed amount is high',\n      category: 'action', status: 'na',\n      notes: `Estimated owed: $${report.netTaxOwed.toLocaleString()}. IRS offers installment agreements.`,\n      priority: 'recommended',\n    })\n  }\n  sections.push(buildSection('Filing Actions', '🎯', actionItems))\n\n  // Calculate overall\n  const allItems = sections.flatMap(s => s.items)\n  const overallCompletion = Math.round(\n    (allItems.filter(i => i.status === 'complete').length / Math.max(1, allItems.filter(i => i.status !== 'na').length)) * 100\n  )\n  const criticalMissing = allItems.filter(i => i.priority === 'required' && (i.status === 'missing' || i.status === 'partial'))\n\n  const totalWithheld = fedWithheld + stateWithheld\n  const netOwed = report.netTaxOwed\n\n  return {\n    filingYear: year,\n    filingDeadline,\n    filingStatus: state.profile.filingStatus,\n    sections,\n    overallCompletion,\n    estimatedRefundOrOwed: Math.abs(netOwed),\n    isRefund: netOwed <= 0,\n    criticalMissing,\n    summary: {\n      totalIncome: report.grossIncome,\n      totalDeductions: report.standardDeduction + (report.seDeduction || 0) + (report.qbiDeduction || 0),\n      totalTax: report.totalTax,\n      totalWithheld,\n      totalEstimatedPaid: 0, // would come from user input\n      netOwed,\n    },\n  }\n}\n\nfunction buildSection(title: string, icon: string, items: TaxPrepItem[]): TaxPrepSection {\n  const applicable = items.filter(i => i.status !== 'na')\n  const complete = applicable.filter(i => i.status === 'complete').length\n  return {\n    title, icon, items,\n    completionPct: applicable.length > 0 ? Math.round((complete / applicable.length) * 100) : 100,\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\tax-return-import.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":87,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":87,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2666,2669],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2666,2669],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":95,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":95,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2839,2842],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2839,2842],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":97,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":97,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2892,2895],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2892,2895],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":97,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":97,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2925,2928],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2925,2928],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":103,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":103,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3180,3183],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3180,3183],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'pages' is assigned a value but never used.","line":334,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":334,"endColumn":10},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":472,"column":83,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":472,"endColumn":86,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19625,19628],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19625,19628],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":474,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":474,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19691,19694],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19691,19694],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE — Tax Return Import v1\n * \n * Extracts structured data from tax return PDFs (digitally-generated).\n * Uses PDF.js text layer extraction + pattern matching for:\n *   - Form 1040 (lines 1-37, AGI, taxable income, total tax)\n *   - Schedule C (business income/expenses)\n *   - Schedule D (capital gains summary)\n *   - Schedule SE (self-employment tax)\n *   - W-2 (wage statements)\n *   - Schedule 1 (additional income/adjustments)\n *\n * Note: This handles digitally-generated PDFs (TurboTax, H&R Block, \n * IRS e-file). For scanned paper returns, OCR (Tesseract) would be\n * needed — that's a Phase 2 enhancement.\n */\n\n// ─── Types ──────────────────────────────────────────────────────────────────\n\nexport interface ExtractedReturn {\n  taxYear: number | null\n  filingStatus: string | null\n  forms: ExtractedForm[]\n  summary: ReturnSummary\n  rawText: string\n  confidence: number // 0-100\n  warnings: string[]\n}\n\nexport interface ExtractedForm {\n  formType: FormType\n  fields: Record<string, ExtractedField>\n  pageNumbers: number[]\n  confidence: number\n}\n\nexport interface ExtractedField {\n  label: string\n  value: string | number | null\n  line?: string       // e.g., \"Line 11\" \n  confidence: number  // 0-100\n  rawText?: string\n}\n\nexport type FormType = '1040' | 'schedule_c' | 'schedule_d' | 'schedule_se' | 'w2' | 'schedule_1' | 'schedule_e' | '8949'\n\nexport interface ReturnSummary {\n  // From 1040\n  grossIncome: number | null\n  agi: number | null\n  taxableIncome: number | null\n  totalTax: number | null\n  totalPayments: number | null\n  refundOrOwed: number | null\n  filingStatus: string | null\n  // From Schedule C\n  businessIncome: number | null\n  businessExpenses: number | null\n  netBusinessProfit: number | null\n  // From Schedule D\n  shortTermGainLoss: number | null\n  longTermGainLoss: number | null\n  // From Schedule SE\n  selfEmploymentTax: number | null\n  // From W-2\n  wagesTotal: number | null\n  federalWithheld: number | null\n  // Computed\n  estimatedMarginalRate: number | null\n  estimatedEffectiveRate: number | null\n}\n\n// ─── PDF Text Extraction (uses pdf.js) ──────────────────────────────────────\n\nexport async function extractTextFromPDF(file: File): Promise<{ pages: string[]; fullText: string }> {\n  // Dynamic import of pdf.js from CDN\n  const pdfjsLib = await loadPDFJS()\n  \n  const arrayBuffer = await file.arrayBuffer()\n  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise\n  const pages: string[] = []\n  \n  for (let i = 1; i <= pdf.numPages; i++) {\n    const page = await pdf.getPage(i)\n    const textContent = await page.getTextContent()\n    const pageText = textContent.items\n      .map((item: any) => item.str)\n      .join(' ')\n    pages.push(pageText)\n  }\n  \n  return { pages, fullText: pages.join('\\n--- PAGE BREAK ---\\n') }\n}\n\nasync function loadPDFJS(): Promise<any> {\n  // Check if already loaded\n  if ((window as any).pdfjsLib) return (window as any).pdfjsLib\n  \n  return new Promise((resolve, reject) => {\n    const script = document.createElement('script')\n    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js'\n    script.onload = () => {\n      const lib = (window as any).pdfjsLib\n      lib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js'\n      resolve(lib)\n    }\n    script.onerror = () => reject(new Error('Failed to load PDF.js'))\n    document.head.appendChild(script)\n  })\n}\n\n// ─── Pattern Matching Engine ────────────────────────────────────────────────\n\nfunction extractNumber(text: string, ...patterns: RegExp[]): { value: number | null; confidence: number; raw: string } {\n  for (const pattern of patterns) {\n    const match = text.match(pattern)\n    if (match) {\n      const raw = match[1] || match[0]\n      const cleaned = raw.replace(/[$,\\s()]/g, '').replace(/^\\((.+)\\)$/, '-$1')\n      const num = parseFloat(cleaned)\n      if (!isNaN(num)) {\n        return { value: num, confidence: 85, raw }\n      }\n    }\n  }\n  return { value: null, confidence: 0, raw: '' }\n}\n\nfunction extractString(text: string, ...patterns: RegExp[]): { value: string | null; confidence: number } {\n  for (const pattern of patterns) {\n    const match = text.match(pattern)\n    if (match) return { value: (match[1] || match[0]).trim(), confidence: 80 }\n  }\n  return { value: null, confidence: 0 }\n}\n\n// ─── Form 1040 Parser ───────────────────────────────────────────────────────\n\nfunction parse1040(text: string): ExtractedForm | null {\n  // Detect if this is a 1040\n  if (!text.match(/Form\\s*1040|U\\.?S\\.?\\s*Individual\\s*Income\\s*Tax\\s*Return|Department of the Treasury/i)) {\n    return null\n  }\n\n  const fields: Record<string, ExtractedField> = {}\n\n  // Filing status\n  const statusPatterns: [RegExp, string][] = [\n    [/Single/i, 'single'],\n    [/Married\\s*filing\\s*jointly/i, 'mfj'],\n    [/Married\\s*filing\\s*separately/i, 'mfs'],\n    [/Head\\s*of\\s*household/i, 'hoh'],\n    [/Qualifying\\s*(surviving\\s*)?spouse/i, 'qss'],\n  ]\n  for (const [pattern, status] of statusPatterns) {\n    if (text.match(pattern)) {\n      fields.filingStatus = { label: 'Filing Status', value: status, confidence: 75 }\n      break\n    }\n  }\n\n  // Tax year\n  const yearMatch = text.match(/(?:Tax\\s*Year|for\\s*the\\s*year)\\s*(\\d{4})/i) || text.match(/20(2[0-9])\\s*(?:Form|1040)/i)\n  if (yearMatch) {\n    const yr = yearMatch[1].length === 2 ? 2000 + parseInt(yearMatch[1]) : parseInt(yearMatch[1])\n    fields.taxYear = { label: 'Tax Year', value: yr, confidence: 90 }\n  }\n\n  // Key 1040 lines\n  const linePatterns: [string, string, RegExp[]][] = [\n    ['line1', 'Wages, salaries, tips (Line 1)', [/(?:Line\\s*1[a-z]?\\b|Wages,?\\s*salaries)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i, /1[a-z]?\\s+[\\w\\s]+\\$?\\s*([\\d,]+\\.?\\d*)/]],\n    ['line2b', 'Taxable interest (Line 2b)', [/(?:Line\\s*2b|Taxable\\s*interest)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['line3b', 'Qualified dividends (Line 3b)', [/(?:Line\\s*3b|Qualified\\s*dividends)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['line7', 'Capital gain/loss (Line 7)', [/(?:Line\\s*7|Capital\\s*gain)[\\s.:]*\\$?\\s*-?([\\d,]+\\.?\\d*)/i]],\n    ['line8', 'Other income (Line 8)', [/(?:Line\\s*8[^0-9]|Other\\s*income.*Schedule\\s*1)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['line9', 'Total income (Line 9)', [/(?:Line\\s*9|Total\\s*income)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['line10', 'Adjustments (Line 10)', [/(?:Line\\s*10|Adjustments\\s*to\\s*income)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['line11', 'AGI (Line 11)', [/(?:Line\\s*11|Adjusted\\s*gross\\s*income)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i, /AGI[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['line12', 'Standard/Itemized deduction (Line 12)', [/(?:Line\\s*12|Standard\\s*deduction|Itemized\\s*deduction)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['line13', 'QBI deduction (Line 13)', [/(?:Line\\s*13|Qualified\\s*business\\s*income)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['line15', 'Taxable income (Line 15)', [/(?:Line\\s*15|Taxable\\s*income)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['line16', 'Tax (Line 16)', [/(?:Line\\s*16\\b)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['line24', 'Total tax (Line 24)', [/(?:Line\\s*24|Total\\s*tax)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['line25d', 'Federal tax withheld (Line 25d)', [/(?:Line\\s*25d|Federal.*withheld|tax\\s*withheld)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['line33', 'Total payments (Line 33)', [/(?:Line\\s*33|Total\\s*payments)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['line34', 'Overpaid/Refund (Line 34)', [/(?:Line\\s*34|Overpaid|Amount.*refunded)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['line37', 'Amount owed (Line 37)', [/(?:Line\\s*37|Amount.*owe)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n  ]\n\n  for (const [key, label, patterns] of linePatterns) {\n    const result = extractNumber(text, ...patterns)\n    if (result.value !== null) {\n      fields[key] = { label, value: result.value, line: key, confidence: result.confidence, rawText: result.raw }\n    }\n  }\n\n  const fieldCount = Object.keys(fields).length\n  if (fieldCount < 3) return null // Not enough data to be a valid 1040\n\n  return {\n    formType: '1040',\n    fields,\n    pageNumbers: [1, 2],\n    confidence: Math.min(95, 50 + fieldCount * 5),\n  }\n}\n\n// ─── Schedule C Parser ──────────────────────────────────────────────────────\n\nfunction parseScheduleC(text: string): ExtractedForm | null {\n  if (!text.match(/Schedule\\s*C|Profit\\s*or\\s*Loss\\s*[Ff]rom\\s*Business/i)) return null\n\n  const fields: Record<string, ExtractedField> = {}\n\n  const patterns: [string, string, RegExp[]][] = [\n    ['grossReceipts', 'Gross receipts (Line 1)', [/(?:Line\\s*1|Gross\\s*receipts)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['grossIncome', 'Gross income (Line 7)', [/(?:Line\\s*7|Gross\\s*income)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['totalExpenses', 'Total expenses (Line 28)', [/(?:Line\\s*28|Total\\s*expenses)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['netProfit', 'Net profit/loss (Line 31)', [/(?:Line\\s*31|Net\\s*profit|Net\\s*loss)[\\s.:]*\\$?\\s*-?([\\d,]+\\.?\\d*)/i]],\n    ['advertising', 'Advertising (Line 8)', [/(?:Line\\s*8|Advertising)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['carExpense', 'Car/truck expenses (Line 9)', [/(?:Line\\s*9|Car.*expense|Vehicle)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['depreciation', 'Depreciation (Line 13)', [/(?:Line\\s*13|Depreciation)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['insurance', 'Insurance (Line 15)', [/(?:Line\\s*15\\b|Insurance.*business)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['officeExpense', 'Office expense (Line 18)', [/(?:Line\\s*18|Office\\s*expense)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['rent', 'Rent/lease (Line 20b)', [/(?:Line\\s*20|Rent|Lease)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['utilities', 'Utilities (Line 25)', [/(?:Line\\s*25|Utilities)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['homeOffice', 'Home office (Line 30)', [/(?:Line\\s*30|business\\s*use\\s*of\\s*home|Home\\s*office)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['businessName', 'Business name', [/(?:Business\\s*name|Name\\s*of\\s*proprietor)[\\s.:]*([A-Za-z][\\w\\s&.,'-]+)/i]],\n  ]\n\n  for (const [key, label, pats] of patterns) {\n    const result = key === 'businessName' ? { value: extractString(text, ...pats).value, confidence: 70 } : (() => { const r = extractNumber(text, ...pats); return { value: r.value, confidence: r.confidence } })()\n    if (result.value !== null) {\n      fields[key] = { label, value: result.value, confidence: result.confidence }\n    }\n  }\n\n  if (Object.keys(fields).length < 2) return null\n\n  return { formType: 'schedule_c', fields, pageNumbers: [], confidence: Math.min(90, 40 + Object.keys(fields).length * 6) }\n}\n\n// ─── Schedule D Parser ──────────────────────────────────────────────────────\n\nfunction parseScheduleD(text: string): ExtractedForm | null {\n  if (!text.match(/Schedule\\s*D|Capital\\s*Gains\\s*and\\s*Losses/i)) return null\n\n  const fields: Record<string, ExtractedField> = {}\n\n  const patterns: [string, string, RegExp[]][] = [\n    ['shortTermGL', 'Short-term gain/loss (Line 7)', [/(?:Line\\s*7|Net\\s*short.?term)[\\s.:]*\\$?\\s*\\(?([\\d,]+\\.?\\d*)\\)?/i]],\n    ['longTermGL', 'Long-term gain/loss (Line 15)', [/(?:Line\\s*15|Net\\s*long.?term)[\\s.:]*\\$?\\s*\\(?([\\d,]+\\.?\\d*)\\)?/i]],\n    ['totalGL', 'Total capital gain/loss (Line 16)', [/(?:Line\\s*16\\b)[\\s.:]*\\$?\\s*\\(?([\\d,]+\\.?\\d*)\\)?/i]],\n    ['form8949ST', 'Form 8949 short-term total', [/8949.*short.?term.*\\$?\\s*\\(?([\\d,]+\\.?\\d*)\\)?/i]],\n    ['form8949LT', 'Form 8949 long-term total', [/8949.*long.?term.*\\$?\\s*\\(?([\\d,]+\\.?\\d*)\\)?/i]],\n  ]\n\n  for (const [key, label, pats] of patterns) {\n    const result = extractNumber(text, ...pats)\n    if (result.value !== null) {\n      fields[key] = { label, value: result.value, confidence: result.confidence }\n    }\n  }\n\n  if (Object.keys(fields).length < 1) return null\n  return { formType: 'schedule_d', fields, pageNumbers: [], confidence: Math.min(85, 40 + Object.keys(fields).length * 10) }\n}\n\n// ─── Schedule SE Parser ─────────────────────────────────────────────────────\n\nfunction parseScheduleSE(text: string): ExtractedForm | null {\n  if (!text.match(/Schedule\\s*SE|Self.?Employment\\s*Tax/i)) return null\n\n  const fields: Record<string, ExtractedField> = {}\n\n  const patterns: [string, string, RegExp[]][] = [\n    ['netEarnings', 'Net SE earnings (Line 4)', [/(?:Line\\s*4|Net\\s*earnings|net\\s*self.?employment)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['seTax', 'Self-employment tax (Line 12)', [/(?:Line\\s*12|Self.?employment\\s*tax)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['deductibleHalf', 'Deductible half (Line 13)', [/(?:Line\\s*13|Deductible\\s*part|one.?half)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n  ]\n\n  for (const [key, label, pats] of patterns) {\n    const result = extractNumber(text, ...pats)\n    if (result.value !== null) {\n      fields[key] = { label, value: result.value, confidence: result.confidence }\n    }\n  }\n\n  if (Object.keys(fields).length < 1) return null\n  return { formType: 'schedule_se', fields, pageNumbers: [], confidence: Math.min(85, 40 + Object.keys(fields).length * 12) }\n}\n\n// ─── W-2 Parser ─────────────────────────────────────────────────────────────\n\nfunction parseW2(text: string): ExtractedForm | null {\n  if (!text.match(/Form\\s*W.?2|Wage\\s*and\\s*Tax\\s*Statement/i)) return null\n\n  const fields: Record<string, ExtractedField> = {}\n\n  const patterns: [string, string, RegExp[]][] = [\n    ['wages', 'Wages (Box 1)', [/(?:Box\\s*1|Wages,?\\s*tips)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['fedWithheld', 'Federal tax withheld (Box 2)', [/(?:Box\\s*2|Federal.*withheld)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['ssWages', 'Social security wages (Box 3)', [/(?:Box\\s*3|Social\\s*security\\s*wages)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['ssTax', 'SS tax withheld (Box 4)', [/(?:Box\\s*4|Social\\s*security\\s*tax)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['medicareWages', 'Medicare wages (Box 5)', [/(?:Box\\s*5|Medicare\\s*wages)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['medicareTax', 'Medicare tax (Box 6)', [/(?:Box\\s*6|Medicare\\s*tax)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['stateWages', 'State wages (Box 16)', [/(?:Box\\s*16|State\\s*wages)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['stateWithheld', 'State tax withheld (Box 17)', [/(?:Box\\s*17|State.*tax.*withheld)[\\s.:]*\\$?\\s*([\\d,]+\\.?\\d*)/i]],\n    ['employer', 'Employer name', [/(?:Employer.?s?\\s*name|[Bb]ox\\s*[Cc])[\\s.:]*([A-Za-z][\\w\\s&.,'-]+)/i]],\n  ]\n\n  for (const [key, label, pats] of patterns) {\n    const result = key === 'employer' ? { value: extractString(text, ...pats).value, confidence: 70 } : (() => { const r = extractNumber(text, ...pats); return { value: r.value, confidence: r.confidence } })()\n    if (result.value !== null) {\n      fields[key] = { label, value: result.value, confidence: result.confidence }\n    }\n  }\n\n  if (Object.keys(fields).length < 2) return null\n  return { formType: 'w2', fields, pageNumbers: [], confidence: Math.min(90, 40 + Object.keys(fields).length * 6) }\n}\n\n// ─── Main Import Orchestrator ───────────────────────────────────────────────\n\nexport async function importTaxReturn(file: File): Promise<ExtractedReturn> {\n  const warnings: string[] = []\n  \n  // Extract text from PDF\n  let pages: string[] = []\n  let fullText = ''\n  \n  try {\n    const extracted = await extractTextFromPDF(file)\n    pages = extracted.pages\n    fullText = extracted.fullText\n  } catch (err) {\n    return {\n      taxYear: null, filingStatus: null, forms: [],\n      summary: emptySummary(),\n      rawText: '', confidence: 0,\n      warnings: [`Failed to extract text from PDF: ${err instanceof Error ? err.message : String(err)}. This may be a scanned document — OCR support coming in Phase 2.`],\n    }\n  }\n\n  if (fullText.trim().length < 50) {\n    return {\n      taxYear: null, filingStatus: null, forms: [],\n      summary: emptySummary(),\n      rawText: fullText, confidence: 0,\n      warnings: ['PDF contains very little text. This may be a scanned image — OCR support coming in Phase 2.'],\n    }\n  }\n\n  // Parse each form type\n  const forms: ExtractedForm[] = []\n  \n  const f1040 = parse1040(fullText)\n  if (f1040) forms.push(f1040)\n  \n  const schC = parseScheduleC(fullText)\n  if (schC) forms.push(schC)\n  \n  const schD = parseScheduleD(fullText)\n  if (schD) forms.push(schD)\n  \n  const schSE = parseScheduleSE(fullText)\n  if (schSE) forms.push(schSE)\n  \n  const w2 = parseW2(fullText)\n  if (w2) forms.push(w2)\n\n  if (forms.length === 0) {\n    warnings.push('Could not identify any standard tax forms in this PDF. Ensure this is a US federal tax return.')\n  }\n\n  // Build summary\n  const summary = buildSummary(forms)\n  \n  // Extract tax year\n  const taxYear = f1040?.fields.taxYear?.value as number | null ||\n    (() => { const m = fullText.match(/20(2[0-9])/); return m ? 2000 + parseInt(m[1]) : null })()\n\n  const filingStatus = f1040?.fields.filingStatus?.value as string | null\n\n  const overallConfidence = forms.length > 0\n    ? Math.round(forms.reduce((s, f) => s + f.confidence, 0) / forms.length)\n    : 0\n\n  return {\n    taxYear,\n    filingStatus,\n    forms,\n    summary,\n    rawText: fullText,\n    confidence: overallConfidence,\n    warnings,\n  }\n}\n\n// ─── Summary Builder ────────────────────────────────────────────────────────\n\nfunction buildSummary(forms: ExtractedForm[]): ReturnSummary {\n  const f1040 = forms.find(f => f.formType === '1040')\n  const schC = forms.find(f => f.formType === 'schedule_c')\n  const schD = forms.find(f => f.formType === 'schedule_d')\n  const schSE = forms.find(f => f.formType === 'schedule_se')\n  const w2 = forms.find(f => f.formType === 'w2')\n\n  const val = (form: ExtractedForm | undefined, key: string): number | null => {\n    const v = form?.fields[key]?.value\n    return typeof v === 'number' ? v : null\n  }\n\n  const grossIncome = val(f1040, 'line9')\n  const agi = val(f1040, 'line11')\n  const taxableIncome = val(f1040, 'line15')\n  const totalTax = val(f1040, 'line24')\n\n  const estimatedMarginalRate = taxableIncome && taxableIncome > 0\n    ? estimateMarginalRate(taxableIncome)\n    : null\n\n  const estimatedEffectiveRate = grossIncome && totalTax && grossIncome > 0\n    ? Math.round((totalTax / grossIncome) * 10000) / 10000\n    : null\n\n  return {\n    grossIncome,\n    agi,\n    taxableIncome,\n    totalTax,\n    totalPayments: val(f1040, 'line33'),\n    refundOrOwed: val(f1040, 'line34') || val(f1040, 'line37'),\n    filingStatus: f1040?.fields.filingStatus?.value as string | null,\n    businessIncome: val(schC, 'grossReceipts'),\n    businessExpenses: val(schC, 'totalExpenses'),\n    netBusinessProfit: val(schC, 'netProfit'),\n    shortTermGainLoss: val(schD, 'shortTermGL'),\n    longTermGainLoss: val(schD, 'longTermGL'),\n    selfEmploymentTax: val(schSE, 'seTax'),\n    wagesTotal: val(w2, 'wages') || val(f1040, 'line1'),\n    federalWithheld: val(w2, 'fedWithheld') || val(f1040, 'line25d'),\n    estimatedMarginalRate,\n    estimatedEffectiveRate,\n  }\n}\n\nfunction estimateMarginalRate(taxableIncome: number): number {\n  // 2024 single brackets\n  if (taxableIncome <= 11600) return 0.10\n  if (taxableIncome <= 47150) return 0.12\n  if (taxableIncome <= 100525) return 0.22\n  if (taxableIncome <= 191950) return 0.24\n  if (taxableIncome <= 243725) return 0.32\n  if (taxableIncome <= 609350) return 0.35\n  return 0.37\n}\n\nfunction emptySummary(): ReturnSummary {\n  return {\n    grossIncome: null, agi: null, taxableIncome: null, totalTax: null,\n    totalPayments: null, refundOrOwed: null, filingStatus: null,\n    businessIncome: null, businessExpenses: null, netBusinessProfit: null,\n    shortTermGainLoss: null, longTermGainLoss: null,\n    selfEmploymentTax: null, wagesTotal: null, federalWithheld: null,\n    estimatedMarginalRate: null, estimatedEffectiveRate: null,\n  }\n}\n\n// ─── Fortuna Pre-fill Helper ────────────────────────────────────────────────\n\nexport function preFillFortunaFromReturn(result: ExtractedReturn): Record<string, any> {\n  const s = result.summary\n  const prefill: Record<string, any> = {}\n  \n  if (s.filingStatus) prefill.filingStatus = s.filingStatus\n  if (s.wagesTotal) prefill.w2Income = s.wagesTotal\n  if (s.netBusinessProfit) prefill.scheduleCIncome = s.netBusinessProfit\n  if (s.businessExpenses) prefill.businessExpenses = s.businessExpenses\n  if (s.shortTermGainLoss !== null) prefill.shortTermCapGains = s.shortTermGainLoss\n  if (s.longTermGainLoss !== null) prefill.longTermCapGains = s.longTermGainLoss\n  if (s.selfEmploymentTax) prefill.priorYearSETax = s.selfEmploymentTax\n  if (s.totalTax) prefill.priorYearTotalTax = s.totalTax\n  if (s.agi) prefill.priorYearAGI = s.agi\n  if (s.federalWithheld) prefill.priorYearWithholding = s.federalWithheld\n  if (result.taxYear) prefill.priorTaxYear = result.taxYear\n  \n  return prefill\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\tax-simulator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\unified-intelligence.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":301,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":301,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14807,14810],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14807,14810],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":302,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":302,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14911,14914],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14911,14914],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_' is defined but never used.","line":346,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":346,"endColumn":16},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":634,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":634,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32038,32041],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32038,32041],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":639,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":639,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32244,32247],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32244,32247],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":659,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":659,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[33427,33430],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[33427,33430],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":661,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":661,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[33579,33582],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[33579,33582],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":679,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":679,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[34612,34615],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[34612,34615],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":681,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":681,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[34784,34787],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[34784,34787],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":728,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":728,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[37497,37500],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[37497,37500],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":752,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":752,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38830,38833],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38830,38833],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":753,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":753,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38892,38895],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38892,38895],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":774,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":774,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[39932,39935],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[39932,39935],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":870,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":870,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[43862,43865],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[43862,43865],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":871,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":871,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[43948,43951],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[43948,43951],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":885,"column":180,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":885,"endColumn":183,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[45622,45625],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[45622,45625],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":16,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — Unified Intelligence Layer v9.1\n *\n * Chains all engines together to produce composite recommendations\n * that no single engine can detect independently. This is the \"brain\"\n * that makes every module smarter by context-sharing.\n *\n * Pipeline: Tax → Entity → Retirement → Credits → Depreciation →\n *           Multi-Year → State Arbitrage → Audit Risk → Health\n *\n * Outputs cross-engine \"nexus insights\" — compound recommendations\n * that reference multiple modules simultaneously.\n */\n\nimport type { FortunaState, ReceiptRecord, LegalEntity } from './storage'\nimport { generateTaxReport, type TaxReport } from './tax-calculator'\nimport { detectStrategies, type DetectedStrategy } from './strategy-detector'\nimport { compareRetirementVehicles, type RetirementComparison } from './retirement-optimizer'\nimport { analyzeTaxCredits, type TaxCreditSummary } from './tax-credits'\nimport { runMultiYearAnalysis, type MultiYearAnalysis } from './multi-year-tax'\nimport { generateDepreciationSummary, type DepreciationSummary } from './depreciation-engine'\nimport { optimizeEntities, type EntityOptimizerResult } from './entity-optimizer'\nimport { analyzeAuditRisk, type AuditRiskProfile } from './audit-risk'\nimport { generateHealthReport, type FinancialHealthReport } from './health-score'\nimport { generateProactiveAlerts, type ProactiveAlert } from './proactive-intelligence'\nimport { hasPortfolioData, computePortfolioSummary, getPortfolioTaxIncome } from './portfolio-bridge'\nimport { processReceipts, type AllocationResult } from './receipt-engine'\n\n// ===================================================================\n//  TYPES\n// ===================================================================\n\nexport interface NexusInsight {\n  id: string\n  title: string\n  description: string\n  engines: string[] // which engines contributed\n  impact: number // estimated dollar impact\n  priority: 'critical' | 'high' | 'medium' | 'low'\n  category: 'compound_savings' | 'timing' | 'structural' | 'risk_mitigation' | 'growth'\n  actions: NexusAction[]\n  reasoning: string\n}\n\nexport interface NexusAction {\n  label: string\n  view: string // ViewKey to navigate to\n  detail: string\n}\n\nexport interface UnifiedIntelligence {\n  // Raw engine outputs (cached for AI advisor)\n  taxReport: TaxReport\n  strategies: DetectedStrategy[]\n  retirement: RetirementComparison\n  credits: TaxCreditSummary\n  multiYear: MultiYearAnalysis\n  depreciation: DepreciationSummary\n  entityOpt: EntityOptimizerResult\n  auditRisk: AuditRiskProfile\n  healthReport: FinancialHealthReport\n  alerts: ProactiveAlert[]\n  receiptAllocations: AllocationResult[]\n\n  // Cross-engine synthesis\n  nexusInsights: NexusInsight[]\n  totalCompoundSavings: number\n  topPriorityAction: NexusAction | null\n\n  // Summary metrics\n  enginesCrossReferenced: number\n  insightsGenerated: number\n  computedAt: string\n}\n\n// ===================================================================\n//  NEXUS DETECTION — Cross-Engine Insight Generators\n// ===================================================================\n\nfunction detectRetirementCreditNexus(\n  tax: TaxReport,\n  credits: TaxCreditSummary,\n  state: FortunaState,\n): NexusInsight | null {\n  // If retirement contributions could reduce AGI enough to unlock credits\n  const saversCredit = credits.credits.find(c => c.id === 'savers')\n\n  if (tax.retirementGap > 5000) {\n    // Check if maxing retirement unlocks Saver's Credit\n    if (saversCredit && !saversCredit.eligible) {\n      const agiAfterRetirement = tax.agi - tax.retirementGap\n      const threshold = state.profile.filingStatus === 'married_joint' ? 76500 : 38250\n      if (agiAfterRetirement <= threshold) {\n        const creditGain = Math.min(2000, Math.round(Math.min(tax.retirementGap, 2000) * 0.10))\n        const taxSaved = Math.round(tax.retirementGap * tax.marginalRate)\n        const total = creditGain + taxSaved\n\n        return {\n          id: 'retirement-credit-nexus',\n          title: 'Retirement + Credit Double Benefit',\n          description: `Contributing $${tax.retirementGap.toLocaleString()} to retirement saves $${taxSaved.toLocaleString()} in taxes AND unlocks the Saver's Credit worth up to $${creditGain.toLocaleString()}.`,\n          engines: ['tax-calculator', 'retirement-optimizer', 'tax-credits'],\n          impact: total,\n          priority: 'high',\n          category: 'compound_savings',\n          actions: [\n            { label: 'Retirement Options', view: 'retirement', detail: 'Compare SEP-IRA vs Solo 401(k) contribution limits' },\n            { label: 'Credit Details', view: 'credits', detail: 'View Saver\\'s Credit eligibility requirements' },\n          ],\n          reasoning: `Your AGI of $${tax.agi.toLocaleString()} is above the Saver's Credit threshold of $${threshold.toLocaleString()}. Contributing $${tax.retirementGap.toLocaleString()} to retirement drops AGI to $${agiAfterRetirement.toLocaleString()}, unlocking the credit while also generating a ${(tax.marginalRate * 100).toFixed(0)}% deduction.`,\n        }\n      }\n    }\n  }\n  return null\n}\n\nfunction detectDepreciationTimingNexus(\n  multiYear: MultiYearAnalysis,\n  depreciation: DepreciationSummary,\n): NexusInsight | null {\n  // If high-bracket year AND bonus depreciation phasing down — buy now\n  const baseline = multiYear.baseline\n\n  if (baseline.length < 2) return null\n\n  const thisYear = baseline[0]\n  const bonusRate = depreciation.bonusDepreciationRate\n\n  if (thisYear.marginalRate >= 0.24 && bonusRate > (depreciation.bonusDepreciationRate - 0.20)) {\n    const examplePurchase = 50000\n    const thisYearDeduction = Math.round(examplePurchase * Math.min(1, bonusRate + 0.20)) // 179 + bonus\n    const nextYearDeduction = Math.round(examplePurchase * Math.max(0, bonusRate - 0.20 + 0.20))\n    const savingsDiff = Math.round((thisYearDeduction - nextYearDeduction) * thisYear.marginalRate)\n\n    if (savingsDiff > 1000) {\n      return {\n        id: 'depreciation-timing-nexus',\n        title: 'Asset Purchase Timing Advantage',\n        description: `Buying $50K in equipment THIS year saves $${savingsDiff.toLocaleString()} more than waiting. Your ${(thisYear.marginalRate * 100).toFixed(0)}% bracket + ${(bonusRate * 100).toFixed(0)}% bonus depreciation is a shrinking window.`,\n        engines: ['depreciation-engine', 'multi-year-tax', 'tax-calculator'],\n        impact: savingsDiff,\n        priority: thisYear.marginalRate >= 0.32 ? 'high' : 'medium',\n        category: 'timing',\n        actions: [\n          { label: 'Calculate Depreciation', view: 'depreciation', detail: 'Model specific asset purchases with §179 and bonus' },\n          { label: 'Multi-Year Impact', view: 'multiyear', detail: 'See how purchases affect your 5-year projection' },\n        ],\n        reasoning: `Current bonus depreciation at ${(bonusRate * 100).toFixed(0)}% drops next year. Combined with your ${(thisYear.marginalRate * 100).toFixed(0)}% marginal rate, each dollar of depreciation saves $${thisYear.marginalRate.toFixed(2)} now vs potentially less later.`,\n      }\n    }\n  }\n  return null\n}\n\nfunction detectEntityTaxCreditNexus(\n  tax: TaxReport,\n  credits: TaxCreditSummary,\n  state: FortunaState,\n): NexusInsight | null {\n  // R&D credit + S-Corp conversion = compound benefit\n  const rdCredit = credits.credits.find(c => c.id === 'rd_credit')\n  const hasBusinessIncome = state.incomeStreams.some(s =>\n    ['business', 'freelance'].includes(s.type) && s.isActive\n  )\n\n  if (rdCredit?.eligible && hasBusinessIncome && tax.sCorpSavings > 3000) {\n    const rdEstimate = state.expenses\n      .filter(e => e.isDeductible && (\n        e.category.toLowerCase().includes('software') ||\n        e.category.toLowerCase().includes('development') ||\n        e.category.toLowerCase().includes('contractor')\n      ))\n      .reduce((s, e) => s + e.annualAmount, 0) * 0.14\n\n    if (rdEstimate > 1000) {\n      const total = Math.round(tax.sCorpSavings + rdEstimate)\n      return {\n        id: 'entity-credit-nexus',\n        title: 'S-Corp + R&D Credit Stack',\n        description: `Converting to S-Corp saves $${tax.sCorpSavings.toLocaleString()} in SE tax, PLUS you can claim ~$${Math.round(rdEstimate).toLocaleString()} R&D credit on development expenses. Combined: $${total.toLocaleString()}/year.`,\n        engines: ['entity-optimizer', 'tax-credits', 'tax-calculator'],\n        impact: total,\n        priority: 'critical',\n        category: 'structural',\n        actions: [\n          { label: 'Entity Optimizer', view: 'optimizer', detail: 'Calculate optimal salary vs distribution split' },\n          { label: 'R&D Credit Details', view: 'credits', detail: 'See R&D credit requirements and calculation' },\n          { label: 'Formation Checklist', view: 'taxdocs', detail: 'Get S-Corp formation steps and timeline' },\n        ],\n        reasoning: `S-Corp election eliminates SE tax on distributions (saving $${tax.sCorpSavings.toLocaleString()}). The R&D credit applies to your development expenses as a separate dollar-for-dollar tax reduction. These stack — one reduces payroll tax, the other reduces income tax.`,\n      }\n    }\n  }\n  return null\n}\n\nfunction detectTCJARetirementNexus(\n  multiYear: MultiYearAnalysis,\n  tax: TaxReport,\n): NexusInsight | null {\n  // If TCJA sunset is within projection window AND retirement gap exists — front-load\n  const sunsetYear = multiYear.baseline.find(y => y.bracketRegime === 'pre_tcja')\n  if (!sunsetYear || tax.retirementGap <= 0) return null\n\n  const yearsUntilSunset = sunsetYear.year - new Date().getFullYear()\n  const totalFrontLoad = Math.round(tax.retirementGap * yearsUntilSunset)\n  const postSunsetRate = sunsetYear.marginalRate\n  const rateGap = postSunsetRate - tax.marginalRate\n\n  if (rateGap > 0.02) {\n    const additionalSavings = Math.round(totalFrontLoad * rateGap)\n    return {\n      id: 'tcja-retirement-nexus',\n      title: 'Front-Load Retirement Before TCJA Sunset',\n      description: `${yearsUntilSunset} years until bracket increases. Maxing retirement contributions now deducts at ${(tax.marginalRate * 100).toFixed(0)}% — after sunset, rates jump to ${(postSunsetRate * 100).toFixed(0)}%. Front-loading saves an extra $${additionalSavings.toLocaleString()}.`,\n      engines: ['multi-year-tax', 'retirement-optimizer', 'tax-calculator'],\n      impact: additionalSavings,\n      priority: 'high',\n      category: 'timing',\n      actions: [\n        { label: 'Multi-Year Projection', view: 'multiyear', detail: 'See TCJA sunset impact on your rates' },\n        { label: 'Retirement Vehicles', view: 'retirement', detail: 'Compare contribution limits and vehicles' },\n      ],\n      reasoning: `Each $1 deducted pre-sunset saves ${(tax.marginalRate * 100).toFixed(0)}¢. Post-sunset, the same deduction saves ${(postSunsetRate * 100).toFixed(0)}¢ — but you've already locked in the higher-value deduction. Over ${yearsUntilSunset} years, the rate differential on $${totalFrontLoad.toLocaleString()} in contributions yields $${additionalSavings.toLocaleString()} extra savings.`,\n    }\n  }\n  return null\n}\n\nfunction detectAuditProtectionNexus(\n  audit: AuditRiskProfile,\n  tax: TaxReport,\n  state: FortunaState,\n): NexusInsight | null {\n  // High audit risk + large deductions = documentation nexus\n  const riskLevel = audit.riskLevel\n  const totalDeductions = state.deductions.reduce((s, d) => s + d.amount, 0) +\n    state.expenses.filter(e => e.isDeductible).reduce((s, e) => s + e.annualAmount * e.deductionPct / 100, 0)\n  const deductionRatio = tax.grossIncome > 0 ? totalDeductions / tax.grossIncome : 0\n\n  if ((riskLevel === 'high' || riskLevel === 'elevated') && deductionRatio > 0.3) {\n    return {\n      id: 'audit-protection-nexus',\n      title: 'Audit Risk × Deduction Documentation',\n      description: `Your audit risk is ${riskLevel} with a ${(deductionRatio * 100).toFixed(0)}% deduction-to-income ratio. Documenting $${totalDeductions.toLocaleString()} in deductions NOW protects $${Math.round(totalDeductions * tax.marginalRate).toLocaleString()} in tax savings.`,\n      engines: ['audit-risk', 'tax-calculator', 'depreciation-engine'],\n      impact: Math.round(totalDeductions * tax.marginalRate),\n      priority: 'high',\n      category: 'risk_mitigation',\n      actions: [\n        { label: 'Audit Profile', view: 'audit', detail: 'Review red flags and mitigation strategies' },\n        { label: 'Audit Documentation', view: 'taxdocs', detail: 'Generate documentation checklists' },\n        { label: 'CPA Export', view: 'cpa', detail: 'Prepare CPA-ready documentation package' },\n      ],\n      reasoning: `The IRS flags returns with high deduction ratios for examination. Your ${(deductionRatio * 100).toFixed(0)}% ratio exceeds the typical threshold. Proactive documentation doesn't reduce deductions — it protects them. Every undocumented deduction is a potential disallowance.`,\n    }\n  }\n  return null\n}\n\nfunction detectStateArbitrageEntityNexus(\n  state: FortunaState,\n  tax: TaxReport,\n): NexusInsight | null {\n  // If state tax is high AND entity restructuring could help\n  const stateRate = tax.stateTax / (tax.grossIncome || 1)\n  if (stateRate < 0.04 || tax.grossIncome < 50000) return null\n\n  const noTaxStates = ['FL', 'TX', 'NV', 'WY', 'SD', 'AK', 'WA', 'NH', 'TN']\n  if (noTaxStates.includes(state.profile.state)) return null\n\n  const stateSavings = tax.stateTax\n  const sCorpSavings = tax.sCorpSavings\n  const combined = stateSavings + sCorpSavings\n\n  if (combined > 5000) {\n    return {\n      id: 'state-entity-nexus',\n      title: 'Relocation + Entity Restructuring Stack',\n      description: `Relocating to a no-income-tax state saves $${stateSavings.toLocaleString()}/yr. Combined with S-Corp election savings of $${sCorpSavings.toLocaleString()}/yr, total optimization: $${combined.toLocaleString()}/yr.`,\n      engines: ['state-arbitrage', 'entity-optimizer', 'tax-calculator'],\n      impact: combined,\n      priority: combined > 15000 ? 'critical' : 'high',\n      category: 'structural',\n      actions: [\n        { label: 'State Comparison', view: 'arbitrage', detail: 'Compare total tax burden by state' },\n        { label: 'Entity Optimizer', view: 'optimizer', detail: 'Model S-Corp conversion at new location' },\n        { label: 'Scenario Modeler', view: 'scenarios', detail: 'Model combined relocation + entity change' },\n      ],\n      reasoning: `You're paying ${(stateRate * 100).toFixed(1)}% state tax ($${stateSavings.toLocaleString()}) that's avoidable in 9 states. Entity restructuring provides additional savings independent of location. Together, these represent the largest structural optimization available.`,\n    }\n  }\n  return null\n}\n\nfunction detectReceiptOptimizationNexus(\n  allocations: AllocationResult[],\n  tax: TaxReport\n): NexusInsight | null {\n  const needsReview = allocations.reduce((sum: number, r: any) => sum + r.itemsNeedingReview, 0)\n  const totalBusinessFound = allocations.reduce((sum: number, r: any) => sum + r.allocatedBusiness, 0)\n  const potentialTaxSaving = Math.round(totalBusinessFound * tax.marginalRate)\n\n  if (totalBusinessFound > 500) {\n    return {\n      id: 'receipt-optimization-nexus',\n      title: 'Hidden Deductions in Receipt Scans',\n      description: `We identified $${totalBusinessFound.toLocaleString()} in potential business expenses across your recent scans. At your ${(tax.marginalRate * 100).toFixed(0)}% tax bracket, these represent $${potentialTaxSaving.toLocaleString()} in immediate tax savings.`,\n      engines: ['Receipt Engine', 'Tax Calculator', 'Entity Optimizer'],\n      impact: potentialTaxSaving,\n      priority: 'high',\n      category: 'compound_savings',\n      actions: [\n        { label: 'Review Allocations', view: 'receipts', detail: `Review ${needsReview} items needing manual entity assignment` },\n        { label: 'Sync to Ledger', view: 'taxdocs', detail: 'Finalize and commit these expenses to your tax return' }\n      ],\n      reasoning: `By analyzing individual line items, we found expenses with business keywords (e.g. software, travel) that were not yet categorized. Direct allocation to your LLCs reduces self-employment and income tax.`\n    }\n  }\n  return null\n}\n\nfunction detectSubscriptionOverlapNexus(\n  receipts: ReceiptRecord[]\n): NexusInsight | null {\n  if (!receipts || receipts.length === 0) return null\n\n  const activeSubscriptions = receipts.filter(r => r.isRecurring)\n  if (activeSubscriptions.length < 2) return null\n\n  // Map category -> Set of Merchants\n  const categoryMerchants: Record<string, Set<string>> = {}\n\n  for (const r of activeSubscriptions) {\n    for (const item of r.items) {\n      if (item.allocatedEntityId && item.allocatedEntityId !== 'personal') {\n        const cat = item.inferredCategory\n        if (!categoryMerchants[cat]) categoryMerchants[cat] = new Set()\n        categoryMerchants[cat].add(r.merchantName)\n      }\n    }\n  }\n\n  const overlaps = Object.entries(categoryMerchants)\n    .filter(([_, merchants]) => merchants.size > 1)\n    .map(([cat, merchants]) => ({ category: cat, merchants: Array.from(merchants) }))\n\n  if (overlaps.length > 0) {\n    const totalPotentialSavings = overlaps.length * 120 // Rough estimate $10/mo consolidated\n    return {\n      id: 'subscription-overlap-nexus',\n      title: 'Redundant Subscriptions Detected',\n      description: `We found overlapping recurring charges in ${overlaps.length} categories (e.g., ${overlaps[0].merchants.slice(0, 2).join(' and ')} for ${overlaps[0].category}). Consolidating these under a single business license could save ~$${totalPotentialSavings.toLocaleString()}/yr.`,\n      engines: ['Receipt Engine'],\n      impact: totalPotentialSavings,\n      priority: 'medium',\n      category: 'compound_savings',\n      actions: [\n        { label: 'Consolidate Subscriptions', view: 'receipts', detail: 'View overlapping recurring service charges' }\n      ],\n      reasoning: `Maintaining separate individual subscriptions for redundant tools (e.g. storage, conferencing, software) across different legal entities or personal scope is inefficient. Consolidating into team or enterprise plans often yields 15-30% savings.`\n    }\n  }\n\n  return null\n}\n\nfunction detectComminglingRiskNexus(\n  receipts: ReceiptRecord[],\n  entities: LegalEntity[]\n): NexusInsight | null {\n  if (!receipts || receipts.length === 0) return null\n\n  const commingled = receipts.filter(r => {\n    if (r.status !== 'allocated' || !r.paymentMethodId) return false\n\n    // Check if any business entity items are in this receipt\n    const businessItems = r.items.filter(i => i.allocatedEntityId && i.allocatedEntityId !== 'personal')\n    if (businessItems.length === 0) return false\n\n    // Usually a single receipt uses a single payment method. \n    // We check if the main allocated entity for this receipt matches the account.\n    const entityId = businessItems[0].allocatedEntityId\n    const entity = entities.find(e => e.id === entityId)\n\n    if (!entity) return false\n\n    // If entity has linked accounts, check if paymentMethodId is in that list.\n    if (entity.linkedAccountIds && entity.linkedAccountIds.length > 0) {\n      return !entity.linkedAccountIds.includes(r.paymentMethodId)\n    }\n\n    return false\n  })\n\n  if (commingled.length > 0) {\n    const totalRiskAmount = commingled.reduce((sum, r) => sum + r.totalAmount, 0)\n    // Find the first entity name for the description\n    const sampleEntityId = commingled[0].items.find(i => i.allocatedEntityId !== 'personal')?.allocatedEntityId\n    const sampleEntity = entities.find(e => e.id === sampleEntityId)\n\n    return {\n      id: 'commingling-risk-nexus',\n      title: 'Corporate Veil Breach Warning',\n      description: `We detected $${totalRiskAmount.toLocaleString()} in business expenses (e.g., for ${sampleEntity?.name || 'your business'}) paid via accounts not dedicated to that entity. This \"commingling\" of funds can jeopardize your limited liability protection.`,\n      engines: ['Receipt Engine', 'Entity Optimizer'],\n      impact: totalRiskAmount,\n      priority: 'high',\n      category: 'risk_mitigation',\n      actions: [\n        { label: 'Review Risks', view: 'receipts', detail: 'Identify and reimburse commingled expenses' }\n      ],\n      reasoning: `To maintain the \"Corporate Veil\" (limited liability), business expenses must be paid from dedicated business accounts. When personal funds are used, a formal reimbursement entry is required to preserve the legal separation of the entity.`\n    }\n  }\n\n  return null\n}\n\nfunction detectSafeHarborAdjustmentNexus(\n  receipts: ReceiptRecord[],\n  tax: TaxReport\n): NexusInsight | null {\n  if (!receipts || receipts.length === 0) return null\n\n  const totalNewBusinessSpend = receipts.reduce((sum, r) => {\n    if (r.status !== 'allocated') return sum\n    const businessSum = r.items.reduce((s, i) => (i.allocatedEntityId && i.allocatedEntityId !== 'personal') ? s + i.amount : s, 0)\n    return sum + businessSum\n  }, 0)\n\n  if (totalNewBusinessSpend > 2000) {\n    const taxVulnerabilityReduction = Math.round(totalNewBusinessSpend * tax.marginalRate)\n    const suggestedQuarterlyReduction = Math.round(taxVulnerabilityReduction / 4)\n\n    return {\n      id: 'safe-harbor-adjustment-nexus',\n      title: 'Safe Harbor Dynamic Optimization',\n      description: `We identified $${totalNewBusinessSpend.toLocaleString()} in new business expenses across your scans. This discovery reduces your estimated annual tax bill by ~$${taxVulnerabilityReduction.toLocaleString()}. You can reduce your next estimated tax payment by $${suggestedQuarterlyReduction.toLocaleString()} while staying within Safe Harbor protection.`,\n      engines: ['Receipt Engine', 'Tax Calculator', 'multi-year-tax'],\n      impact: taxVulnerabilityReduction,\n      priority: 'medium',\n      category: 'compound_savings',\n      actions: [\n        { label: 'Adjust Payments', view: 'tax', detail: `Update Q${Math.ceil((new Date().getMonth() + 1) / 3)} estimated payment by -$${suggestedQuarterlyReduction.toLocaleString()}` }\n      ],\n      reasoning: `Safe Harbor rules (110% of prior year tax) protect against underpayment penalties, but real-time expense discovery allows you to safely reduce current-year payments to match actual projected liability. This optimizes cash flow without incurring interest charges.`\n    }\n  }\n\n  return null\n}\n\nfunction detectIncomeGrowthBracketNexus(\n  multiYear: MultiYearAnalysis,\n): NexusInsight | null {\n  const baseline = multiYear.baseline\n  if (baseline.length < 3) return null\n\n  // Check if growth trajectory pushes into new bracket\n  const current = baseline[0]\n  const future = baseline[2] // 2 years out\n\n  if (future.marginalRate > current.marginalRate && future.marginalRate >= 0.32) {\n    const bracketJump = future.marginalRate - current.marginalRate\n    const incomeGrowth = future.grossIncome - current.grossIncome\n\n    return {\n      id: 'growth-bracket-nexus',\n      title: 'Income Growth → Bracket Jump Warning',\n      description: `Projected growth pushes you from ${(current.marginalRate * 100).toFixed(0)}% to ${(future.marginalRate * 100).toFixed(0)}% by ${future.year}. Proactive strategies can shield $${incomeGrowth.toLocaleString()} in new income from the higher rate.`,\n      engines: ['multi-year-tax', 'strategy-detector', 'retirement-optimizer'],\n      impact: Math.round(incomeGrowth * bracketJump),\n      priority: 'medium',\n      category: 'growth',\n      actions: [\n        { label: 'Multi-Year View', view: 'multiyear', detail: 'Income shifting scenarios to smooth bracket exposure' },\n        { label: 'Strategies', view: 'tax', detail: 'Tax strategies for high-growth periods' },\n        { label: 'Retirement', view: 'retirement', detail: 'Max contributions to offset growing income' },\n      ],\n      reasoning: `Revenue growth of ~$${incomeGrowth.toLocaleString()} over 2 years crosses into the ${(future.marginalRate * 100).toFixed(0)}% bracket. Without intervention, the marginal tax on that growth is ${(future.marginalRate * 100).toFixed(0)}¢ per dollar. Retirement contributions, income deferral, and entity restructuring can keep more income at the current ${(current.marginalRate * 100).toFixed(0)}% rate.`,\n    }\n  }\n  return null\n}\n\n// ===================================================================\n//  MAIN INTELLIGENCE PIPELINE\n// ===================================================================\n\nexport function runUnifiedIntelligence(state: FortunaState): UnifiedIntelligence {\n  // ── Phase 1: Run all engines ──\n  const taxReport = generateTaxReport(state)\n  const strategies = detectStrategies(state)\n  const retirement = compareRetirementVehicles(state)\n  const credits = analyzeTaxCredits(state)\n  const multiYear = runMultiYearAnalysis(state, 5)\n  const depreciation = generateDepreciationSummary(state)\n  const entityOpt = optimizeEntities(state)\n  const auditRisk = analyzeAuditRisk(state)\n  const healthReport = generateHealthReport(state)\n  const alerts = generateProactiveAlerts(state)\n  const receiptAllocations = processReceipts(state)\n\n  // ── Phase 2: Cross-engine nexus detection ──\n  const nexusInsights: NexusInsight[] = []\n\n  const n1 = detectRetirementCreditNexus(taxReport, credits, state)\n  if (n1) nexusInsights.push(n1)\n\n  const n2 = detectDepreciationTimingNexus(multiYear, depreciation)\n  if (n2) nexusInsights.push(n2)\n\n  const n3 = detectEntityTaxCreditNexus(taxReport, credits, state)\n  if (n3) nexusInsights.push(n3)\n\n  const n4 = detectTCJARetirementNexus(multiYear, taxReport)\n  if (n4) nexusInsights.push(n4)\n\n  const n5 = detectAuditProtectionNexus(auditRisk, taxReport, state)\n  if (n5) nexusInsights.push(n5)\n\n  const n6 = detectStateArbitrageEntityNexus(state, taxReport)\n  if (n6) nexusInsights.push(n6)\n\n  const n7 = detectIncomeGrowthBracketNexus(multiYear)\n  if (n7) nexusInsights.push(n7)\n\n  const n8 = detectReceiptOptimizationNexus(receiptAllocations, taxReport)\n  if (n8) nexusInsights.push(n8)\n\n  const n9 = detectSubscriptionOverlapNexus(state.receipts || [])\n  if (n9) nexusInsights.push(n9)\n\n  const n10 = detectComminglingRiskNexus(state.receipts || [], state.entities || [])\n  if (n10) nexusInsights.push(n10)\n\n  const n11 = detectSafeHarborAdjustmentNexus(state.receipts || [], taxReport)\n  if (n11) nexusInsights.push(n11)\n\n  // ── Portfolio Intelligence nexus insights ────────────────────────\n  if (hasPortfolioData()) {\n    const ps = computePortfolioSummary()\n    const ptx = getPortfolioTaxIncome(state.profile.state)\n\n    // Portfolio gains + Retirement contributions = bracket optimization\n    if (ptx.shortTermCapGains > 5000 && taxReport.retirementGap > 5000) {\n      const retirementOffset = Math.min(taxReport.retirementGap, ptx.shortTermCapGains)\n      const savings = Math.round(retirementOffset * taxReport.marginalRate)\n      nexusInsights.push({\n        id: 'portfolio-retirement-bracket',\n        title: 'Capital Gains + Retirement Contribution Offset',\n        description: `$${ptx.shortTermCapGains.toLocaleString()} in short-term capital gains can be offset by increasing retirement contributions by $${retirementOffset.toLocaleString()}, reducing taxable income and saving ~$${savings.toLocaleString()}.`,\n        engines: ['Portfolio Intelligence', 'Retirement Optimizer', 'Tax Calculator'],\n        impact: savings,\n        priority: savings > 3000 ? 'critical' : 'high',\n        category: 'compound_savings',\n        actions: [\n          { label: 'View portfolio positions', view: 'portfolio', detail: 'Review capital gains exposure' },\n          { label: 'Optimize retirement', view: 'retirement', detail: `Increase contributions by $${retirementOffset.toLocaleString()}` },\n        ],\n        reasoning: `Short-term capital gains are taxed at ordinary rates (${(taxReport.marginalRate * 100).toFixed(0)}%). Retirement contributions reduce AGI, effectively sheltering gain income from tax.`,\n      })\n    }\n\n    // Staking/mining income + Entity structure = SE tax avoidance\n    if (ps.stakingRewards + ps.miningIncome > 10000 && entityOpt.scenarios.length > 1) {\n      const seIncome = ps.stakingRewards + ps.miningIncome\n      const seSavings = Math.round(seIncome * 0.153 * 0.4) // ~40% SE tax reduction via S-Corp\n      nexusInsights.push({\n        id: 'portfolio-entity-staking',\n        title: 'Staking Income + Entity Structure Optimization',\n        description: `$${seIncome.toLocaleString()}/yr in staking/mining income may be subject to 15.3% SE tax. Structuring through S-Corp election could save ~$${seSavings.toLocaleString()}/yr.`,\n        engines: ['Portfolio Intelligence', 'Entity Optimizer', 'Tax Calculator'],\n        impact: seSavings,\n        priority: seSavings > 2000 ? 'high' : 'medium',\n        category: 'structural',\n        actions: [\n          { label: 'Review staking income', view: 'portfolio', detail: 'Track staking rewards and mining income' },\n          { label: 'Entity optimization', view: 'optimizer', detail: 'Evaluate S-Corp election for crypto income' },\n        ],\n        reasoning: 'Crypto staking/mining income treatment varies by jurisdiction. If classified as SE income, entity structuring can significantly reduce the tax burden.',\n      })\n    }\n\n    // Tax-loss harvesting + Multi-year projection = strategic loss timing\n    if (ps.harvestCandidates.length > 0 && multiYear.baseline.length > 1) {\n      const harvestTotal = ps.harvestCandidates.reduce((s, c) => s + c.loss, 0)\n      const currentYearRate = taxReport.marginalRate\n      const nextYearRate = multiYear.baseline[1]?.effectiveRate || currentYearRate\n      const betterYear = nextYearRate > currentYearRate ? 'next year' : 'this year'\n      const savings = Math.round(harvestTotal * Math.max(currentYearRate, nextYearRate) * 0.3)\n\n      nexusInsights.push({\n        id: 'portfolio-multiyear-harvest',\n        title: 'Strategic Loss Harvesting Timing',\n        description: `$${harvestTotal.toLocaleString()} in harvestable losses. Multi-year analysis suggests ${betterYear} is optimal for realization at ${(Math.max(currentYearRate, nextYearRate) * 100).toFixed(0)}% marginal rate.`,\n        engines: ['Portfolio Intelligence', 'Multi-Year Tax', 'Strategy Detector'],\n        impact: savings,\n        priority: harvestTotal > 10000 ? 'high' : 'medium',\n        category: 'timing',\n        actions: [\n          { label: 'View harvest candidates', view: 'portfolio', detail: `${ps.harvestCandidates.length} positions with unrealized losses` },\n          { label: 'Multi-year projection', view: 'multiyear', detail: 'Compare tax rates across years' },\n        ],\n        reasoning: `Losses are more valuable when offset against income taxed at higher rates. ${betterYear === 'this year' ? 'Current year has higher marginal rate — harvest now.' : 'Next year projects higher marginal rate — consider deferring losses.'}`,\n      })\n    }\n\n    // Portfolio concentration + Audit risk = documentation flag\n    if (ps.concentrationRisk > 50 && ps.totalValue > 50000) {\n      nexusInsights.push({\n        id: 'portfolio-audit-concentration',\n        title: 'High-Value Concentrated Position — Audit Awareness',\n        description: `${ps.concentrationRisk.toFixed(0)}% of $${Math.round(ps.totalValue).toLocaleString()} portfolio in single position. Large capital gains events from concentrated positions attract IRS scrutiny.`,\n        engines: ['Portfolio Intelligence', 'Audit Profiler'],\n        impact: 0,\n        priority: 'medium',\n        category: 'risk_mitigation',\n        actions: [\n          { label: 'Portfolio diversification', view: 'portfolio', detail: 'Review concentration risk' },\n          { label: 'Audit readiness', view: 'audit', detail: 'Ensure documentation is complete for high-value positions' },\n        ],\n        reasoning: 'IRS DIF scores flag large capital gains, especially from concentrated positions. Proactive documentation reduces audit risk.',\n      })\n    }\n  }\n\n  // ── Metamodel Nexus Insights ──────────────────────────────────────\n\n  // Estimated payments + Income forecast = safe harbor optimization\n  const estPayments = state.estimatedPayments || []\n  const missedEst = estPayments.filter((p: any) => {\n    const due = new Date(p.dueDate)\n    return due < new Date() && (!p.paidAmount || p.paidAmount === 0)\n  })\n  if (missedEst.length > 0) {\n    const totalMissed = missedEst.reduce((s: number, p: any) => s + p.amount, 0)\n    const penaltyEst = Math.round(totalMissed * 0.04)\n    nexusInsights.push({\n      id: 'est-payment-penalty-nexus',\n      title: 'Missed Estimated Payments + Penalty Exposure',\n      description: `${missedEst.length} missed payment(s) totaling $${totalMissed.toLocaleString()} may trigger ~$${penaltyEst.toLocaleString()} in underpayment penalties (Form 2210). Review safe harbor strategy.`,\n      engines: ['Proactive Intelligence', 'Income Forecast', 'Tax Calendar'],\n      impact: penaltyEst,\n      priority: penaltyEst > 1000 ? 'critical' : 'high',\n      category: 'risk_mitigation',\n      actions: [\n        { label: 'Make payments now', view: 'calendar', detail: 'Minimize penalty accrual' },\n        { label: 'Recalculate safe harbor', view: 'forecast', detail: 'Adjust remaining quarterly payments' },\n      ],\n      reasoning: `IRS charges ~4% annualized interest on underpayments. Making up missed payments reduces further accrual.`,\n    })\n  }\n\n  // Depreciation + Entity structure = §179 per-entity optimization\n  const depAssets = (state.depreciationAssets || []).filter(a => a.isActive)\n  const entitiesWithAssets = new Set(depAssets.map((a: any) => a.entityId || 'personal'))\n  if (entitiesWithAssets.size > 1 && depAssets.length >= 3) {\n    const totalBasis = depAssets.reduce((s: number, a: any) => s + (a.purchasePrice || 0), 0)\n    nexusInsights.push({\n      id: 'depreciation-entity-split',\n      title: 'Multi-Entity Depreciation Strategy',\n      description: `${depAssets.length} assets across ${entitiesWithAssets.size} entities totaling $${totalBasis.toLocaleString()}. Each entity gets its own §179 election — strategic asset placement can maximize first-year deductions.`,\n      engines: ['Depreciation Engine', 'Entity Optimizer', 'Tax Calculator'],\n      impact: Math.round(totalBasis * 0.05),\n      priority: 'medium',\n      category: 'structural',\n      actions: [\n        { label: 'Review asset placement', view: 'depreciation', detail: 'Optimize which entity holds each asset' },\n      ],\n      reasoning: 'Per-entity §179 elections allow strategic first-year expensing. Assets should be placed in the entity with the highest marginal rate.',\n    })\n  }\n\n  // Retirement accounts + Goals = alignment check\n  const retAccounts = state.retirementAccounts || []\n  const retGoals = (state.goals || []).filter((g: any) => g.type === 'retirement' && g.status === 'active')\n  if (retAccounts.length > 0 && retGoals.length > 0) {\n    const totalBalance = retAccounts.reduce((s: number, a: any) => s + (a.balance || 0), 0)\n    const targetAmount = retGoals[0].targetAmount || 0\n    if (targetAmount > 0 && totalBalance < targetAmount * 0.5) {\n      const gap = targetAmount - totalBalance\n      nexusInsights.push({\n        id: 'retirement-goal-gap',\n        title: 'Retirement Goal Gap',\n        description: `Current retirement balance $${totalBalance.toLocaleString()} is ${Math.round(totalBalance / targetAmount * 100)}% of your $${targetAmount.toLocaleString()} goal. Consider increasing contributions or adjusting timeline.`,\n        engines: ['Retirement Optimizer', 'Goal Planner', 'Income Forecast'],\n        impact: Math.round(gap * 0.03),\n        priority: 'high',\n        category: 'compound_savings',\n        actions: [\n          { label: 'Maximize contributions', view: 'retirement', detail: `$${gap.toLocaleString()} gap to close` },\n          { label: 'Review goal timeline', view: 'goals', detail: 'Adjust target date or amount' },\n        ],\n        reasoning: 'Earlier contributions benefit from compounding. Each year of delay requires significantly more savings to reach the same target.',\n      })\n    }\n  }\n\n  // Carryforwards + Multi-year = utilization planning\n  const cf = state.carryforwards || {}\n  const totalCarryforward = (cf.capitalLoss || 0) + (cf.netOperatingLoss || 0) + (cf.charitableContributions || 0)\n  if (totalCarryforward > 5000) {\n    nexusInsights.push({\n      id: 'carryforward-utilization',\n      title: `$${totalCarryforward.toLocaleString()} in Tax Carryforwards Available`,\n      description: `Capital loss: $${(cf.capitalLoss || 0).toLocaleString()}, NOL: $${(cf.netOperatingLoss || 0).toLocaleString()}, Charitable: $${(cf.charitableContributions || 0).toLocaleString()}. Multi-year projections now factor these in for optimal utilization timing.`,\n      engines: ['Multi-Year Tax', 'Tax Calculator', 'Strategy Detector'],\n      impact: Math.round(totalCarryforward * taxReport.marginalRate * 0.5),\n      priority: totalCarryforward > 20000 ? 'high' : 'medium',\n      category: 'timing',\n      actions: [\n        { label: 'View multi-year impact', view: 'multiyear', detail: 'Carryforwards propagated through projection' },\n      ],\n      reasoning: 'Carryforwards reduce future taxable income. Capital losses limited to $3k/year against ordinary income, NOLs limited to 80% of income post-2017.',\n    })\n  }\n\n  // Kiddie tax alert for dependents with unearned income\n  const household = state.household\n  if (household?.dependents?.length) {\n    const atRisk = household.dependents.filter(d =>\n      d.unearnedIncome && d.unearnedIncome > 2500 && d.age < 19\n    )\n    if (atRisk.length > 0) {\n      const totalKiddieTax = atRisk.reduce((s: number, d: any) => {\n        const parentRateAmount = Math.max(0, (d.unearnedIncome || 0) - 2500)\n        return s + Math.round(parentRateAmount * taxReport.marginalRate)\n      }, 0)\n      nexusInsights.push({\n        id: 'kiddie-tax-alert',\n        title: `Kiddie Tax Applies to ${atRisk.length} Dependent${atRisk.length > 1 ? 's' : ''}`,\n        description: `${atRisk.map(d => d.name).join(', ')} ha${atRisk.length > 1 ? 've' : 's'} unearned income above $2,500 — excess taxed at your ${(taxReport.marginalRate * 100).toFixed(0)}% rate. Total additional tax: ~$${totalKiddieTax.toLocaleString()}.`,\n        engines: ['Tax Calculator', 'Tax Credits'],\n        impact: totalKiddieTax,\n        priority: totalKiddieTax > 2000 ? 'high' : 'medium',\n        category: 'risk_mitigation',\n        actions: [\n          { label: 'Review dependent income', view: 'tax', detail: 'Consider shifting income to tax-advantaged accounts (529, UTMA)' },\n        ],\n        reasoning: 'Form 8615 requires unearned income above $2,500 for children under 19 (24 if student) to be taxed at the parent\\'s marginal rate.',\n      })\n    }\n  }\n\n  // Cross-entity wash sale detection flag\n  // (Actual detection runs when portfolio view loads — flag presence of multi-entity positions)\n  const multiEntityInvestors = new Set(\n    state.incomeStreams\n      .filter((s: any) => s.isActive && s.type === 'investment')\n      .map((s: any) => s.entityId || 'personal')\n  )\n  if (multiEntityInvestors.size > 1) {\n    nexusInsights.push({\n      id: 'cross-entity-wash-sale-risk',\n      title: 'Cross-Entity Wash Sale Risk',\n      description: `Investment income flows through ${multiEntityInvestors.size} entities. IRS wash sale rules apply across ALL accounts you control — selling at a loss in one entity and repurchasing in another within 30 days triggers wash sale disallowance.`,\n      engines: ['Cost Basis', 'Entity Optimizer', 'Portfolio Intelligence'],\n      impact: 0,\n      priority: 'medium',\n      category: 'risk_mitigation',\n      actions: [\n        { label: 'Review positions', view: 'portfolio', detail: 'Check for cross-entity wash sales' },\n      ],\n      reasoning: 'IRS Publication 550 extends wash sale rules to substantially identical securities across all accounts owned by the taxpayer and spouse.',\n    })\n  }\n\n  // Sort by impact\n  nexusInsights.sort((a, b) => b.impact - a.impact)\n\n  const totalCompoundSavings = nexusInsights.reduce((s: number, n: any) => s + n.impact, 0)\n  const topAction = nexusInsights[0]?.actions[0] || null\n\n  return {\n    taxReport,\n    strategies,\n    retirement,\n    credits,\n    multiYear,\n    depreciation,\n    entityOpt,\n    auditRisk,\n    healthReport,\n    alerts,\n    receiptAllocations,\n    nexusInsights,\n    totalCompoundSavings,\n    topPriorityAction: topAction,\n    enginesCrossReferenced: 14,\n    insightsGenerated: nexusInsights.length,\n    computedAt: new Date().toISOString(),\n  }\n}\n\n/**\n * Build a compact text summary for the AI advisor context\n */\nexport function buildIntelligenceBrief(intel: UnifiedIntelligence): string {\n  const sections: string[] = []\n\n  // Multi-year projection summary\n  const my = intel.multiYear\n  sections.push(`MULTI-YEAR PROJECTION (${my.baseline.length} years):`)\n  for (const yr of my.baseline) {\n    sections.push(`  ${yr.year}: Income $${yr.grossIncome.toLocaleString()} | Tax $${yr.totalTax.toLocaleString()} | Eff ${(yr.effectiveRate * 100).toFixed(1)}% | Marginal ${(yr.marginalRate * 100).toFixed(0)}% | ${yr.bracketRegime === 'pre_tcja' ? '⚠️ POST-TCJA' : 'TCJA'}`)\n  }\n  if (my.tcjaSunsetImpact > 0) {\n    sections.push(`  TCJA Sunset Impact: +$${my.tcjaSunsetImpact.toLocaleString()}/yr additional tax`)\n  }\n  sections.push(`  Bracket Headroom: $${my.bracketHeadroom.toLocaleString()} before next rate jump`)\n\n  // Income shifting scenarios\n  if (my.scenarios.length > 0) {\n    sections.push(`\\nINCOME SHIFTING SCENARIOS:`)\n    for (const sc of my.scenarios.slice(0, 3)) {\n      sections.push(`  - ${sc.name}: Saves $${sc.totalTaxSavings.toLocaleString()} (${sc.recommendation})`)\n    }\n  }\n\n  // Tax credits\n  const cr = intel.credits\n  const activeCreds = cr.credits.filter(c => c.eligible && c.amount > 0)\n  if (activeCreds.length > 0 || cr.optimizations.length > 0) {\n    sections.push(`\\nTAX CREDITS:`)\n    for (const c of activeCreds) {\n      sections.push(`  ✓ ${c.name}: $${c.amount.toLocaleString()} (${c.type})`)\n    }\n    sections.push(`  Total Credits: $${cr.totalCredits.toLocaleString()} | Optimizations Available: ${cr.optimizations.length} (+$${cr.optimizations.reduce((s, o) => s + o.additionalCredits, 0).toLocaleString()} potential)`)\n  }\n\n  // Depreciation\n  const dep = intel.depreciation\n  sections.push(`\\nDEPRECIATION:`)\n  sections.push(`  §179 Available: $${dep.section179Remaining.toLocaleString()} | Bonus Rate: ${(dep.bonusDepreciationRate * 100).toFixed(0)}%`)\n  sections.push(`  Timing Insights: ${dep.purchaseTimingInsights.length} active`)\n\n  // Retirement\n  const ret = intel.retirement\n  if (ret.vehicles && ret.vehicles.length > 0) {\n    const best = ret.vehicles.reduce((a, b) => a.maxContribution > b.maxContribution ? a : b)\n    sections.push(`\\nRETIREMENT:`)\n    sections.push(`  Best Vehicle: ${best.name} ($${best.maxContribution.toLocaleString()} max)`)\n    sections.push(`  Contribution Gap: $${intel.taxReport.retirementGap.toLocaleString()}`)\n  }\n\n  // Entity optimization\n  if (intel.entityOpt && intel.entityOpt.recommended) {\n    sections.push(`\\nENTITY OPTIMIZATION:`)\n    sections.push(`  Recommended: ${intel.entityOpt.recommended.label} — ${intel.entityOpt.summary}`)\n    sections.push(`  Max Savings: $${intel.entityOpt.maxSavings.toLocaleString()}`)\n  }\n\n  // Cross-engine nexus insights\n  if (intel.nexusInsights.length > 0) {\n    sections.push(`\\n★ CROSS-ENGINE COMPOUND INSIGHTS (${intel.nexusInsights.length}):`)\n    for (const n of intel.nexusInsights) {\n      sections.push(`  [${n.priority.toUpperCase()}] ${n.title} — $${n.impact.toLocaleString()} impact`)\n      sections.push(`    ${n.reasoning}`)\n      sections.push(`    Engines: ${n.engines.join(' × ')}`)\n    }\n    sections.push(`  TOTAL COMPOUND SAVINGS POTENTIAL: $${intel.totalCompoundSavings.toLocaleString()}`)\n  }\n\n  // Receipt intelligence summary\n  const ra = intel.receiptAllocations\n  if (ra && ra.length > 0) {\n    const totalBusinessFound = ra.reduce((s: number, r: any) => s + r.allocatedBusiness, 0)\n    const reviewNeeded = ra.reduce((s: number, r: any) => s + r.itemsNeedingReview, 0)\n    sections.push(`\\nRECEIPT INTELLIGENCE:`)\n    sections.push(`  Processed: ${ra.length} receipts | Business Expenses Found: $${totalBusinessFound.toLocaleString()}`)\n    if (reviewNeeded > 0) sections.push(`  ⚠️ Action Required: ${reviewNeeded} items need manual entity allocation`)\n  }\n\n  // Portfolio Intelligence summary\n  if (hasPortfolioData()) {\n    const ps = computePortfolioSummary()\n    sections.push(`\\nPORTFOLIO INTELLIGENCE:`)\n    sections.push(`  Positions: ${ps.activePositionCount} | Value: $${Math.round(ps.totalValue).toLocaleString()} | Unrealized G/L: ${ps.unrealizedGainLoss >= 0 ? '+' : ''}$${Math.round(ps.unrealizedGainLoss).toLocaleString()}`)\n    if (ps.netCapitalGains !== 0) sections.push(`  Net Capital Gains: $${Math.round(ps.netCapitalGains).toLocaleString()} (ST: $${Math.round(ps.shortTermGains - ps.shortTermLosses).toLocaleString()} + LT: $${Math.round(ps.longTermGains - ps.longTermLosses).toLocaleString()})`)\n    if (ps.ordinaryIncomeFromPortfolio > 0) sections.push(`  Portfolio Ordinary Income: $${Math.round(ps.ordinaryIncomeFromPortfolio).toLocaleString()} (staking: $${Math.round(ps.stakingRewards).toLocaleString()}, airdrops: $${Math.round(ps.airdropIncome).toLocaleString()}, mining: $${Math.round(ps.miningIncome).toLocaleString()})`)\n    if (ps.pendingTaxEvents > 0) sections.push(`  Pending Tax Events: ${ps.pendingTaxEvents} (~$${Math.round(ps.estimatedTaxableFromEvents).toLocaleString()} est. taxable)`)\n    if (ps.harvestCandidates.length > 0) sections.push(`  Tax-Loss Harvesting: ${ps.harvestCandidates.length} candidates ($${Math.round(ps.harvestCandidates.reduce((s: number, c: any) => s + c.loss, 0)).toLocaleString()} harvestable)`)\n    sections.push(`  Risk: avg ${ps.avgRiskScore.toFixed(1)}/10 | Concentration: ${ps.concentrationRisk.toFixed(0)}%`)\n    if (ps.activeOpportunities + ps.watchingOpportunities > 0) sections.push(`  Pipeline: ${ps.activeOpportunities} active, ${ps.watchingOpportunities} watching ($${Math.round(ps.totalPipelineValue).toLocaleString()} expected value)`)\n  }\n\n  return sections.join('\\n')\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\validation.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'percentage' is assigned a value but never used.","line":15,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine - Data Validation Schemas\n * Runtime validation for state imports, API responses, CSV data,\n * and cross-engine data flow. Uses Zod for type-safe validation.\n *\n * @module validation\n */\n\nimport { z } from 'zod'\n\n// ─── Primitive Validators ─────────────────────────────────────────────────\n\nconst positiveNumber = z.number().min(0)\nconst currencyAmount = z.number().min(-1_000_000_000).max(1_000_000_000)\nconst percentage = z.number().min(0).max(1)\nconst taxYear = z.number().int().min(2000).max(2099)\nconst stateCode = z.string().length(2).regex(/^[A-Z]{2}$/)\nconst entityId = z.string().min(1).max(50)\nconst dateString = z.string().regex(/^\\d{4}-\\d{2}-\\d{2}/)\n\n// ─── Core Profile ─────────────────────────────────────────────────────────\n\nexport const filingStatusSchema = z.enum([\n  'single', 'married_joint', 'married_separate', 'head_of_household',\n])\n\nexport const profileSchema = z.object({\n  name: z.string().min(1).max(200),\n  state: stateCode,\n  filingStatus: filingStatusSchema,\n  age: z.number().int().min(0).max(120),\n  dependents: z.number().int().min(0).max(20).optional(),\n  spouseAge: z.number().int().min(0).max(120).optional(),\n})\n\n// ─── Income Streams ───────────────────────────────────────────────────────\n\nexport const incomeTypeSchema = z.enum([\n  'w2', 'business', 'freelance', 'rental', 'investment', 'retirement_distribution', 'other',\n])\n\nexport const incomeStreamSchema = z.object({\n  id: z.string().min(1),\n  name: z.string().min(1).max(200),\n  type: incomeTypeSchema,\n  annualAmount: currencyAmount,\n  isActive: z.boolean(),\n  entityId: entityId.optional(),\n  memberId: z.enum(['primary', 'spouse']).optional(),\n  // W-2 specific\n  w2FederalWithheld: positiveNumber.optional(),\n  w2StateWithheld: positiveNumber.optional(),\n  w2FICAPaid: positiveNumber.optional(),\n  w2PretaxDeductions: positiveNumber.optional(),\n  w2EmployerMatch: positiveNumber.optional(),\n})\n\n// ─── Expenses ─────────────────────────────────────────────────────────────\n\nexport const expenseSchema = z.object({\n  id: z.string().min(1),\n  name: z.string().min(1).max(200),\n  category: z.string().min(1).max(100),\n  monthlyAmount: currencyAmount,\n  isDeductible: z.boolean().optional(),\n  entityId: entityId.optional(),\n})\n\n// ─── Deductions ───────────────────────────────────────────────────────────\n\nexport const deductionSchema = z.object({\n  id: z.string().min(1),\n  name: z.string().min(1).max(200),\n  category: z.string().min(1).max(100),\n  amount: currencyAmount,\n  isItemized: z.boolean().optional(),\n  entityId: entityId.optional(),\n})\n\n// ─── Legal Entities ───────────────────────────────────────────────────────\n\nexport const entityTypeSchema = z.enum([\n  'sole_prop', 'llc_single', 'llc_partnership', 'llc_scorp',\n  'scorp', 'ccorp', 'partnership', 'trust',\n])\n\nexport const entitySchema = z.object({\n  id: entityId,\n  name: z.string().min(1).max(200),\n  type: entityTypeSchema,\n  state: stateCode,\n  isActive: z.boolean(),\n  ein: z.string().optional(),\n  formationDate: dateString.optional(),\n  isSSTB: z.boolean().optional(),\n  officerSalary: positiveNumber.optional(),\n  ownershipPct: z.number().min(0).max(100).optional(),\n})\n\n// ─── Investments ──────────────────────────────────────────────────────────\n\nexport const investmentSchema = z.object({\n  id: z.string().min(1),\n  symbol: z.string().min(1).max(20),\n  name: z.string().min(1).max(200),\n  type: z.enum(['stock', 'etf', 'mutual_fund', 'bond', 'crypto', 'real_estate', 'other']),\n  quantity: z.number(),\n  costBasis: currencyAmount,\n  currentValue: currencyAmount.optional(),\n  acquisitionDate: dateString,\n  isLongTerm: z.boolean().optional(),\n  entityId: entityId.optional(),\n})\n\n// ─── Household ────────────────────────────────────────────────────────────\n\nexport const dependentSchema = z.object({\n  id: z.string().min(1),\n  name: z.string().min(1).max(200),\n  relationship: z.enum(['child', 'stepchild', 'foster', 'sibling', 'parent', 'other']),\n  dateOfBirth: dateString,\n  monthsLived: z.number().int().min(0).max(12),\n  isStudent: z.boolean().optional(),\n  isDisabled: z.boolean().optional(),\n  unearnedIncome: positiveNumber.optional(),\n  earnedIncome: positiveNumber.optional(),\n  age: z.number().int().min(0).max(120),\n})\n\nexport const householdSchema = z.object({\n  members: z.array(z.object({\n    id: z.string().min(1),\n    role: z.enum(['primary', 'spouse']),\n    name: z.string().min(1).max(200),\n    age: z.number().int().min(0).max(120),\n    ssn: z.string().optional(), // not validated for content — sensitive\n  })),\n  dependents: z.array(dependentSchema),\n  filingStatus: filingStatusSchema,\n})\n\n// ─── Estimated Payments ───────────────────────────────────────────────────\n\nexport const estimatedPaymentSchema = z.object({\n  id: z.string().min(1),\n  quarter: z.number().int().min(1).max(4),\n  taxYear: taxYear,\n  dueDate: dateString,\n  amount: positiveNumber,\n  paidAmount: positiveNumber.optional(),\n  paidDate: dateString.optional(),\n})\n\n// ─── Retirement Accounts ──────────────────────────────────────────────────\n\nexport const retirementAccountSchema = z.object({\n  id: z.string().min(1),\n  name: z.string().min(1).max(200),\n  type: z.enum([\n    'traditional_401k', 'roth_401k', 'solo_401k', 'sep_ira', 'simple_ira',\n    'traditional_ira', 'roth_ira', 'hsa', 'pension', 'other',\n  ]),\n  balance: positiveNumber,\n  annualContribution: positiveNumber,\n  employerMatch: positiveNumber.optional(),\n  maxContribution: positiveNumber,\n  isTaxDeductible: z.boolean(),\n})\n\n// ─── Full State Schema ────────────────────────────────────────────────────\n\nexport const fortunaStateSchema = z.object({\n  profile: profileSchema,\n  incomeStreams: z.array(incomeStreamSchema),\n  expenses: z.array(expenseSchema),\n  deductions: z.array(deductionSchema),\n  entities: z.array(entitySchema),\n  investments: z.array(investmentSchema).optional(),\n  household: householdSchema.optional(),\n  estimatedPayments: z.array(estimatedPaymentSchema).optional(),\n  retirementAccounts: z.array(retirementAccountSchema).optional(),\n}).passthrough() // Allow additional fields for extensibility\n\n// ─── Validation Functions ─────────────────────────────────────────────────\n\nexport interface ValidationResult {\n  valid: boolean\n  errors: { path: string; message: string; value?: unknown }[]\n  warnings: { path: string; message: string }[]\n  sanitized?: unknown // cleaned data if valid\n}\n\n/** Validate full FortunaState */\nexport function validateState(data: unknown): ValidationResult {\n  const result = fortunaStateSchema.safeParse(data)\n  if (result.success) {\n    return { valid: true, errors: [], warnings: generateWarnings(result.data), sanitized: result.data }\n  }\n  return {\n    valid: false,\n    errors: result.error.issues.map(issue => ({\n      path: issue.path.join('.'),\n      message: issue.message,\n    })),\n    warnings: [],\n  }\n}\n\n/** Validate a single income stream */\nexport function validateIncome(data: unknown): ValidationResult {\n  const result = incomeStreamSchema.safeParse(data)\n  if (result.success) return { valid: true, errors: [], warnings: [] }\n  return {\n    valid: false,\n    errors: result.error.issues.map(i => ({ path: i.path.join('.'), message: i.message })),\n    warnings: [],\n  }\n}\n\n/** Validate entity */\nexport function validateEntity(data: unknown): ValidationResult {\n  const result = entitySchema.safeParse(data)\n  if (result.success) return { valid: true, errors: [], warnings: [] }\n  return {\n    valid: false,\n    errors: result.error.issues.map(i => ({ path: i.path.join('.'), message: i.message })),\n    warnings: [],\n  }\n}\n\n/** Validate CSV import row (lenient) */\nexport function validateImportRow(row: Record<string, unknown>, rowIndex: number): ValidationResult {\n  const warnings: { path: string; message: string }[] = []\n  const errors: { path: string; message: string; value?: unknown }[] = []\n\n  // Check for required fields\n  if (!row.name && !row.Name && !row.description) {\n    errors.push({ path: `row[${rowIndex}].name`, message: 'Missing name/description field' })\n  }\n\n  // Check numeric fields\n  for (const [key, value] of Object.entries(row)) {\n    if (['amount', 'annualAmount', 'monthlyAmount', 'costBasis', 'quantity', 'balance'].includes(key)) {\n      const num = Number(value)\n      if (isNaN(num)) {\n        errors.push({ path: `row[${rowIndex}].${key}`, message: `\"${value}\" is not a valid number`, value })\n      } else if (num < -1_000_000_000 || num > 1_000_000_000) {\n        warnings.push({ path: `row[${rowIndex}].${key}`, message: `Value ${num} seems unusually large` })\n      }\n    }\n  }\n\n  // Check dates\n  for (const [key, value] of Object.entries(row)) {\n    if (['date', 'acquiredDate', 'disposalDate', 'dueDate'].includes(key) && value) {\n      const d = new Date(value as string)\n      if (isNaN(d.getTime())) {\n        errors.push({ path: `row[${rowIndex}].${key}`, message: `\"${value}\" is not a valid date` })\n      }\n    }\n  }\n\n  return { valid: errors.length === 0, errors, warnings }\n}\n\n// ─── Warning Generator ────────────────────────────────────────────────────\n\nfunction generateWarnings(state: z.infer<typeof fortunaStateSchema>): { path: string; message: string }[] {\n  const warnings: { path: string; message: string }[] = []\n\n  // Check for suspiciously high values\n  for (let i = 0; i < state.incomeStreams.length; i++) {\n    const s = state.incomeStreams[i]\n    if (s.annualAmount > 10_000_000) {\n      warnings.push({ path: `incomeStreams[${i}].annualAmount`, message: `$${s.annualAmount.toLocaleString()} is unusually high — verify` })\n    }\n    if (s.annualAmount < 0) {\n      warnings.push({ path: `incomeStreams[${i}].annualAmount`, message: 'Negative income — should this be an expense or loss?' })\n    }\n  }\n\n  // Check entity references exist\n  const entityIds = new Set(state.entities.map(e => e.id))\n  for (let i = 0; i < state.incomeStreams.length; i++) {\n    const s = state.incomeStreams[i]\n    if (s.entityId && s.entityId !== 'personal' && !entityIds.has(s.entityId)) {\n      warnings.push({ path: `incomeStreams[${i}].entityId`, message: `References entity \"${s.entityId}\" which doesn't exist` })\n    }\n  }\n\n  // Check S-Corp has officer salary\n  for (let i = 0; i < state.entities.length; i++) {\n    const e = state.entities[i]\n    if ((e.type === 'llc_scorp' || e.type === 'scorp') && e.isActive && (!e.officerSalary || e.officerSalary === 0)) {\n      warnings.push({ path: `entities[${i}].officerSalary`, message: `Active S-Corp \"${e.name}\" has no officer salary — IRS requires reasonable compensation` })\n    }\n  }\n\n  return warnings\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\vision-processor.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":27,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[982,985],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[982,985],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":29,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1047,1050],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1047,1050],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, vi } from 'vitest'\r\nimport { createThumbnail, processDocumentImage } from './vision-processor'\r\nimport * as aiProviders from './ai-providers'\r\n\r\nvi.mock('./ai-providers', () => ({\r\n  sendAIMessage: vi.fn()\r\n}))\r\n\r\ndescribe('vision-processor', () => {\r\n  describe('createThumbnail', () => {\r\n    it('should return a placeholder for invalid input', async () => {\r\n      // In a real environment, this might use canvas-mock, but here we check the logic\r\n      const thumb = await createThumbnail('')\r\n      expect(thumb).toBeDefined()\r\n    })\r\n  })\r\n\r\n  describe('processDocumentImage', () => {\r\n    it('should include thumbnails in the result', async () => {\r\n      vi.mocked(aiProviders.sendAIMessage).mockResolvedValue({\r\n        text: JSON.stringify({\r\n          documentType: 'receipt',\r\n          summary: 'Test Receipt',\r\n          confidenceScore: 0.9,\r\n          metadata: { merchantName: 'Test Corp', totalAmount: 100 }\r\n        })\r\n      } as any)\r\n\r\n      const mockState = { profile: {}, entities: [] } as any\r\n      const result = await processDocumentImage('data:image/png;base64,mock', mockState)\r\n      \r\n      expect(result.document?.pageThumbnails).toBeDefined()\r\n      expect(result.document?.pageThumbnails.length).toBeGreaterThan(0)\r\n    })\r\n  })\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\vision-processor.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":120,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":120,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5278,5281],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5278,5281],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":138,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":138,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5858,5861],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5858,5861],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { sendAIMessage, type ProviderId } from './ai-providers'\r\nimport { type DocumentType, type DocumentRecord, type ReceiptItem, genId } from './storage'\r\n\r\nexport interface VisionDocumentResult {\r\n    success: boolean\r\n    document?: DocumentRecord\r\n    receiptItems?: ReceiptItem[] // Included if documentType === 'receipt'\r\n    fullImage?: string           // The original high-res image\r\n    isContinuation: boolean      // Whether this image belongs to the previous document\r\n    error?: string\r\n    confidence: number\r\n}\r\n\r\nconst VISION_SYSTEM_PROMPT = `You are a financial data extraction AI.\r\nThe user will provide an image of a document.\r\nIf 'previousContext' is provided, determine if this image is a continuation (next page) of that document or a brand new document.\r\n\r\nAuto-classify the document into ONE of these types: \"receipt\", \"invoice\", \"tax_notice\", \"contract\", \"identity\", or \"not_applicable\" (for blurry/irrelevant images).\r\nExtract the relevant data and respond ONLY with a JSON object matching this schema:\r\n{\r\n  \"isContinuation\": boolean, // REQUIRED: true if this is Page 2+ of the previous document\r\n  \"documentType\": \"receipt|invoice|tax_notice|contract|identity|not_applicable\",\r\n  \"documentDate\": \"YYYY-MM-DD\",\r\n  \"summary\": \"Brief 1-sentence summary of the document\",\r\n  \"confidenceScore\": \"number between 0 and 1\",\r\n  \"deductionSignals\": [\"list of potential tax deductions found, e.g. home office, vehicle, travel\"],\r\n  \"metadata\": {\r\n     // IF documentType === 'receipt' OR 'invoice':\r\n     \"merchantName\": \"string\",\r\n     \"totalAmount\": \"number\",\r\n     \"taxAmount\": \"number or 0\",\r\n     \"tipAmount\": \"number or 0\",\r\n     \"lineItems\": [\r\n       { \"description\": \"string\", \"amount\": \"number\", \"category\": \"best guess business category (e.g. Dining, Travel, Supplies)\" }\r\n     ],\r\n     ...\r\n  }\r\n}\r\nDo not include any conversational text outside the JSON block.`\r\n\r\n/** Generates a low-res thumbnail from base64 image */\r\nexport async function createThumbnail(base64: string, maxWidth = 200): Promise<string> {\r\n    return new Promise((resolve) => {\r\n        if (typeof document === 'undefined') return resolve('') // Node environment safety\r\n        const img = new Image()\r\n        img.onload = () => {\r\n            const canvas = document.createElement('canvas')\r\n            const ratio = img.height / img.width\r\n            canvas.width = maxWidth\r\n            canvas.height = maxWidth * ratio\r\n            const ctx = canvas.getContext('2d')\r\n            if (!ctx) return resolve(base64.substring(0, 100)) \r\n            ctx.drawImage(img, 0, 0, canvas.width, canvas.height)\r\n            resolve(canvas.toDataURL('image/jpeg', 0.6))\r\n        }\r\n        img.onerror = () => resolve('')\r\n        img.src = base64\r\n    })\r\n}\r\n\r\nexport async function processDocumentImage(\r\n    base64Image: string,\r\n    provider: ProviderId = 'openrouter',\r\n    model: string = 'google/gemini-2.0-flash-001',\r\n    previousContext?: { summary: string; type: string; merchant?: string }\r\n): Promise<VisionDocumentResult> {\r\n    try {\r\n        const thumbnailPromise = createThumbnail(base64Image)\r\n\r\n        const contextText = previousContext\r\n            ? `\\nPREVIOUS DOCUMENT CONTEXT:\\nType: ${previousContext.type}\\nMerchant: ${previousContext.merchant || 'N/A'}\\nSummary: ${previousContext.summary}\\nDoes this new image look like the next page of the document described above?`\r\n            : \"This is the first document in the current stream.\"\r\n\r\n        const response = await sendAIMessage(\r\n            [\r\n                { \r\n                    role: 'user', \r\n                    content: [\r\n                        { type: 'text', text: `Extract the document details from this image. ${contextText}` },\r\n                        { type: 'image_url', image_url: { url: base64Image } }\r\n                    ]\r\n                }\r\n            ],\r\n            VISION_SYSTEM_PROMPT,\r\n            {\r\n                mode: 'proxy',\r\n                provider,\r\n                model,\r\n                clientKeys: {}\r\n            }\r\n        )\r\n\r\n        const thumbnail = await thumbnailPromise\r\n        const jsonMatch = response.text.match(/\\{[\\s\\S]*\\}/)\r\n        if (!jsonMatch) throw new Error(\"AI failed to return valid JSON structure.\")\r\n\r\n        const data = JSON.parse(jsonMatch[0])\r\n        const docId = genId()\r\n        const documentType = (data.documentType as DocumentType) || 'other'\r\n        const isReceiptLike = documentType === 'receipt' || documentType === 'invoice'\r\n\r\n        const documentRecord: DocumentRecord = {\r\n            id: docId,\r\n            documentType,\r\n            dateAdded: new Date().toISOString(),\r\n            pages: [`blob:${docId}`],\r\n            pageThumbnails: [thumbnail],\r\n            pageCount: 1,\r\n            summary: data.summary || 'Unclassified Document',\r\n            status: 'needs_review',\r\n            metadata: {\r\n                ...(data.metadata || {}),\r\n                deductionSignals: data.deductionSignals || []\r\n            },\r\n            batchId: undefined\r\n        }\r\n\r\n        let receiptItems: ReceiptItem[] | undefined = undefined;\r\n        if (isReceiptLike && data.metadata && Array.isArray(data.metadata.lineItems)) {\r\n            receiptItems = data.metadata.lineItems.map((item: any) => ({\r\n                id: genId(),\r\n                description: item.description || 'Item',\r\n                amount: Number(item.amount) || 0,\r\n                inferredCategory: item.category || 'Uncategorized',\r\n                status: 'pending'\r\n            }))\r\n        }\r\n\r\n        return {\r\n            success: true,\r\n            document: documentRecord,\r\n            receiptItems,\r\n            fullImage: base64Image,\r\n            isContinuation: !!data.isContinuation,\r\n            confidence: Number(data.confidenceScore) || 0.5\r\n        }\r\n\r\n    } catch (error: any) {\r\n        console.error(\"Vision Processing Error:\", error)\r\n        return {\r\n            success: false,\r\n            error: error.message || \"Failed to process document image.\",\r\n            isContinuation: false,\r\n            confidence: 0\r\n        }\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\engine\\workspace-api.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":23,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[749,752],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[749,752],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":33,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":33,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1035,1038],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1035,1038],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":168,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":168,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5005,5008],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5005,5008],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":171,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":171,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5188,5191],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5188,5191],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — Workspace API Client v2\n *\n * ALL mutations use POST. GET for reads only.\n * Action names match workspace.php v2.\n */\n\nimport { getAPIBaseUrl } from './api-client'\n\n// ─── HTTP Helpers ─────────────────────────────────────────────────\n\nconst getHeaders = (): Record<string, string> => {\n  const h: Record<string, string> = { 'Content-Type': 'application/json' }\n  const token = localStorage.getItem('fortuna:access-token')\n  if (token) h['Authorization'] = `Bearer ${token}`\n  return h\n}\n\nconst url = (params: string) => `${getAPIBaseUrl()}/workspace.php?${params}`\n\nasync function api<T>(endpoint: string, opts?: RequestInit): Promise<T> {\n  const res = await fetch(endpoint, { headers: getHeaders(), ...opts })\n  let data: any\n  try {\n    data = await res.json()\n  } catch {\n    throw new Error(`Server error ${res.status} (non-JSON response)`)\n  }\n  if (!res.ok || data.error) throw new Error(data.message || `Error ${res.status}`)\n  return data as T\n}\n\nfunction post<T>(action: string, body: Record<string, any>): Promise<T> {\n  return api<T>(url(`action=${action}`), {\n    method: 'POST',\n    body: JSON.stringify(body),\n  })\n}\n\nfunction get<T>(action: string, params = ''): Promise<T> {\n  return api<T>(url(`action=${action}${params ? '&' + params : ''}`))\n}\n\n// ─── Types ────────────────────────────────────────────────────────\n\nexport interface Workspace {\n  id: number\n  uuid: string\n  name: string\n  description: string | null\n  slug: string\n  role: 'owner' | 'admin' | 'member' | 'viewer'\n  member_count: number\n  joined_at?: string\n  owner?: string\n  max_members?: number\n  created_at?: string\n}\n\nexport interface WorkspaceMember {\n  user_uuid: string\n  email: string\n  display_name: string | null\n  role: 'owner' | 'admin' | 'member' | 'viewer'\n  joined_at: string\n  last_active_at: string | null\n  permissions: WorkspacePermissions\n}\n\nexport interface SharedResource {\n  uuid: string\n  type: string\n  title: string\n  description: string | null\n  content: string | null\n  file_name: string | null\n  tags: string[]\n  is_pinned: boolean\n  uploaded_by: string\n  created_at: string\n  updated_at: string\n}\n\nexport interface SharedAIKey {\n  id: number\n  provider: string\n  label: string\n  key_preview: string\n  is_active: boolean\n  usage_count: number\n  last_used_at: string | null\n  added_by: string\n  created_at: string\n}\n\nexport interface ActivityEntry {\n  action: string\n  detail: string | null\n  user: string\n  created_at: string\n}\n\nexport type WorkspacePermissions = {\n  can_edit_data: boolean\n  can_manage_members: boolean\n  can_manage_keys: boolean\n  can_export: boolean\n  can_use_advisor: boolean\n}\n\n// ─── Workspace CRUD ───────────────────────────────────────────────\n\nexport function listWorkspaces() {\n  return get<{ workspaces: Workspace[]; active_workspace_id: number | null }>('list')\n}\n\nexport function createWorkspace(name: string, description?: string) {\n  return post<{ workspace: Workspace }>('create', { name, description })\n}\n\nexport function getWorkspace(id: number) {\n  return get<{ workspace: Workspace; my_role: string; permissions: WorkspacePermissions }>('get', `id=${id}`)\n}\n\nexport function updateWorkspace(id: number, data: Partial<{ name: string; description: string }>) {\n  return post<{ updated: boolean }>('update', { workspace_id: id, ...data })\n}\n\nexport function deleteWorkspace(id: number) {\n  return post<{ deleted: boolean }>('delete', { workspace_id: id })\n}\n\n// ─── Members ──────────────────────────────────────────────────────\n\nexport function listMembers(wsId: number) {\n  return get<{ members: WorkspaceMember[] }>('members', `id=${wsId}`)\n}\n\nexport function changeMemberRole(wsId: number, targetUuid: string, role: string) {\n  return post<{ updated: boolean }>('member_role', { workspace_id: wsId, target_user_uuid: targetUuid, role })\n}\n\nexport function removeMember(wsId: number, targetUuid: string) {\n  return post<{ removed: boolean }>('remove_member', { workspace_id: wsId, target_user_uuid: targetUuid })\n}\n\nexport function leaveWorkspace(id: number) {\n  return post<{ left: boolean }>('leave', { workspace_id: id })\n}\n\n// ─── Invites ──────────────────────────────────────────────────────\n\nexport function createInvite(wsId: number, opts?: { role?: string; max_uses?: number; expires_hours?: number; email?: string }) {\n  return post<{ invite_code: string; role: string; max_uses: number; expires_at: string | null }>('invite', { workspace_id: wsId, ...opts })\n}\n\nexport function getInviteInfo(code: string) {\n  return get<{ workspace_name: string; workspace_description: string | null; role: string; member_count: number; restricted_email: boolean }>('invite_info', `code=${code}`)\n}\n\nexport function joinWorkspace(inviteCode: string) {\n  return post<{ joined: boolean; workspace: { id: number; name: string; role: string } }>('join', { invite_code: inviteCode })\n}\n\n// ─── Shared State ─────────────────────────────────────────────────\n\nexport function loadWorkspaceState(wsId: number) {\n  return get<{ state_data: any; version: number; checksum: string | null; last_edited_by: string; last_synced_at: string }>('state', `id=${wsId}`)\n}\n\nexport function saveWorkspaceState(wsId: number, stateData: any, expectedVersion?: number, force?: boolean) {\n  return post<{ saved: boolean; version: number; checksum: string }>('save_state', { workspace_id: wsId, state_data: stateData, expected_version: expectedVersion, force })\n}\n\n// ─── Shared Resources ─────────────────────────────────────────────\n\nexport function listResources(wsId: number, type?: string) {\n  return get<{ resources: SharedResource[] }>('resources', `id=${wsId}${type ? '&type=' + type : ''}`)\n}\n\nexport function createResource(wsId: number, data: { title: string; resource_type: string; description?: string; content?: string; tags?: string[] }) {\n  return post<{ uuid: string; created: boolean }>('add_resource', { workspace_id: wsId, ...data })\n}\n\nexport function deleteResource(uuid: string) {\n  return post<{ deleted: boolean }>('delete_resource', { uuid })\n}\n\n// ─── Shared AI Keys ───────────────────────────────────────────────\n\nexport function listAIKeys(wsId: number) {\n  return get<{ keys: SharedAIKey[] }>('keys', `id=${wsId}`)\n}\n\nexport function addAIKey(wsId: number, provider: string, apiKey: string, label?: string) {\n  return post<{ added: boolean }>('add_key', { workspace_id: wsId, provider, api_key: apiKey, label })\n}\n\nexport function deleteAIKey(keyId: number) {\n  return post<{ deleted: boolean }>('delete_key', { key_id: keyId })\n}\n\n// ─── Activity ─────────────────────────────────────────────────────\n\nexport function getActivity(wsId: number, limit = 50) {\n  return get<{ activity: ActivityEntry[] }>('activity', `id=${wsId}&limit=${limit}`)\n}\n\n// ─── Switch Workspace ─────────────────────────────────────────────\n\nexport function switchWorkspace(id: number | null) {\n  return post<{ switched: boolean; workspace_id: number | null; mode: string }>('switch', { workspace_id: id ?? 0 })\n}\n\n// ─── Local Storage ────────────────────────────────────────────────\n\nconst WS_KEY = 'fortuna:active-workspace'\n\nexport function getLocalActiveWorkspace(): { id: number; name: string; role: string } | null {\n  try {\n    const raw = localStorage.getItem(WS_KEY)\n    return raw ? JSON.parse(raw) : null\n  } catch { return null }\n}\n\nexport function setLocalActiveWorkspace(ws: { id: number; name: string; role: string } | null): void {\n  if (ws) localStorage.setItem(WS_KEY, JSON.stringify(ws))\n  else localStorage.removeItem(WS_KEY)\n  // Notify sidebar badge etc\n  window.dispatchEvent(new Event('storage'))\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\hooks\\use-toast.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'actionTypes' is assigned a value but only used as a type.","line":18,"column":7,"nodeType":"Identifier","messageId":"usedOnlyAsType","endLine":18,"endColumn":18}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\hooks\\useFortuna.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":261,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":261,"endColumn":27},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":267,"column":10,"nodeType":"Identifier","messageId":"namedExport","endLine":267,"endColumn":15}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createContext, useContext, useState, useEffect, useCallback, useRef, type ReactNode } from 'react'\nimport { Storage, createDefaultState, type FortunaState, type UXPreferences, genId } from '../engine/storage'\nimport { generateTaxReport, compareEntities, type TaxReport, type EntityComparison } from '../engine/tax-calculator'\nimport { detectStrategies, analyzeRisks, calculateHealthScore, type DetectedStrategy, type RiskItem, type FinancialHealthScore } from '../engine/strategy-detector'\nimport {\n  type HistoryStore,\n  createEmptyHistory,\n  shouldAutoSnapshot,\n  captureSnapshot,\n  addSnapshot,\n  computeTrends,\n  analyzeStrategyEffectiveness,\n  projectTrajectory,\n  buildTimeline,\n  type TrendLine,\n  type StrategyEffect,\n  type Projection,\n  type Milestone,\n} from '../engine/history-engine'\nimport { generateSessionDigest, type SessionDigest } from '../engine/session-digest'\nimport { validateState, repairState, saveBackup, recoverFromBackups, logCorruption } from '../engine/data-safety'\n\ninterface FortunaContextType {\n  state: FortunaState\n  setState: (s: FortunaState) => void\n  updateState: (updater: (prev: FortunaState) => FortunaState) => void\n  save: () => Promise<void>\n  loading: boolean\n  // UX Preferences\n  uxPrefs: UXPreferences\n  updateUXPrefs: (partial: Partial<UXPreferences>) => void\n  // Computed values\n  taxReport: TaxReport\n  strategies: DetectedStrategy[]\n  risks: RiskItem[]\n  healthScore: FinancialHealthScore\n  entityComparison: EntityComparison[]\n  // History\n  history: HistoryStore\n  trends: TrendLine[]\n  strategyEffects: StrategyEffect[]\n  projections: Projection[]\n  milestones: Milestone[]\n  takeManualSnapshot: (description?: string) => void\n  // Session intelligence\n  sessionDigest: SessionDigest\n  // Storage info\n  storageBackend: string\n}\n\nconst FortunaContext = createContext<FortunaContextType | null>(null)\n\nconst defaultUXPrefs: UXPreferences = {\n  sidebarCollapsed: false,\n  lastActiveView: 'dashboard',\n  theme: 'dark',\n  sidebarSections: {},\n  lastSessionTimestamp: new Date().toISOString(),\n  dataVersion: 8,\n}\n\nexport function FortunaProvider({ children }: { children: ReactNode }) {\n  const [state, setStateRaw] = useState<FortunaState>(createDefaultState())\n  const [uxPrefs, setUXPrefsRaw] = useState<UXPreferences>(defaultUXPrefs)\n  const [history, setHistory] = useState<HistoryStore>(createEmptyHistory())\n  const [loading, setLoading] = useState(true)\n  const [storageBackend, setStorageBackend] = useState('none')\n  const uxSaveTimer = useRef<ReturnType<typeof setTimeout> | null>(null)\n  const autoSnapshotDone = useRef(false)\n  const saveCount = useRef(0)\n\n  // Load from storage on mount — with corruption recovery\n  useEffect(() => {\n    async function load() {\n      try {\n        setStorageBackend(Storage.getBackendName())\n        const [savedState, savedPrefs, savedHistory] = await Promise.all([\n          Storage.getFullState(),\n          Storage.getUXPrefs(),\n          Storage.getFinancialHistory(),\n        ])\n\n        if (savedState?.profile) {\n          // Validate loaded state\n          const validation = validateState(savedState)\n          if (validation.valid) {\n            setStateRaw(savedState)\n          } else {\n            console.warn('[Fortuna] State validation failed, attempting repair:', validation.errors)\n            logCorruption({ error: validation.errors.join('; '), source: 'load', recovered: false })\n            const { state: repaired, repairs } = repairState(savedState)\n            const recheck = validateState(repaired)\n            if (recheck.valid) {\n              console.info('[Fortuna] State repaired:', repairs)\n              logCorruption({ error: repairs.join('; '), source: 'load', recovered: true, method: 'repair' })\n              setStateRaw(repaired)\n            } else {\n              // Try backup chain\n              console.warn('[Fortuna] Repair failed, trying backup recovery')\n              const recovered = recoverFromBackups()\n              if (recovered) {\n                console.info('[Fortuna] Recovered from backup:', recovered.source)\n                logCorruption({ error: 'Recovered from backup', source: 'load', recovered: true, method: 'backup' })\n                setStateRaw(recovered.state)\n              } else {\n                console.warn('[Fortuna] All recovery failed, using defaults')\n                logCorruption({ error: 'All recovery failed', source: 'load', recovered: false })\n              }\n            }\n          }\n        }\n\n        setUXPrefsRaw(prev => ({ ...prev, ...savedPrefs }))\n        if (savedHistory?.snapshots) setHistory(savedHistory)\n      } catch (e) {\n        console.warn('[Fortuna] Storage load failed, attempting backup recovery', e)\n        logCorruption({ error: (e as Error).message, source: 'load', recovered: false })\n        const recovered = recoverFromBackups()\n        if (recovered) {\n          setStateRaw(recovered.state)\n          logCorruption({ error: 'Load exception recovered from backup', source: 'load', recovered: true, method: 'backup' })\n        }\n      } finally {\n        setLoading(false)\n      }\n    }\n    load()\n  }, [])\n\n  // ---- State management ----\n\n  const setState = useCallback((s: FortunaState) => {\n    setStateRaw({ ...s, lastUpdated: new Date().toISOString() })\n  }, [])\n\n  const updateState = useCallback((updater: (prev: FortunaState) => FortunaState) => {\n    setStateRaw(prev => {\n      const next = updater(prev)\n      return { ...next, lastUpdated: new Date().toISOString() }\n    })\n  }, [])\n\n  const save = useCallback(async () => {\n    await Storage.saveFullState(state)\n  }, [state])\n\n  // Auto-save financial state (debounced 1s) + trigger cloud sync + backup rotation\n  useEffect(() => {\n    if (loading) return\n    const timer = setTimeout(() => {\n      Storage.saveFullState(state)\n      // Dispatch event for AuthContext cloud sync listener\n      window.dispatchEvent(new CustomEvent('fortuna:state-saved', { detail: state }))\n      // Backup rotation: create a backup every 5th save\n      saveCount.current++\n      if (saveCount.current % 5 === 0) {\n        try { saveBackup(state) } catch { /* non-critical */ }\n      }\n    }, 1000)\n    return () => clearTimeout(timer)\n  }, [state, loading])\n\n  // Listen for state updates from cloud sync (login merge)\n  useEffect(() => {\n    const handler = (e: Event) => {\n      const newState = (e as CustomEvent).detail\n      if (newState?.profile) {\n        setStateRaw(newState)\n      }\n    }\n    window.addEventListener('fortuna:state-updated', handler)\n    return () => window.removeEventListener('fortuna:state-updated', handler)\n  }, [])\n\n  // ---- UX Preferences ----\n\n  const updateUXPrefs = useCallback((partial: Partial<UXPreferences>) => {\n    setUXPrefsRaw(prev => {\n      const next = { ...prev, ...partial }\n      if (uxSaveTimer.current) clearTimeout(uxSaveTimer.current)\n      uxSaveTimer.current = setTimeout(() => {\n        Storage.saveUXPrefs(next)\n      }, 200)\n      return next\n    })\n  }, [])\n\n  // ---- Auto-snapshot ----\n\n  useEffect(() => {\n    if (loading || autoSnapshotDone.current || !state.onboardingComplete) return\n\n    const check = shouldAutoSnapshot(state, history)\n    if (check.should) {\n      const snap = captureSnapshot(state, check.trigger, check.reason)\n      const updated = addSnapshot(history, snap)\n      setHistory(updated)\n      Storage.saveFinancialHistory(updated)\n      console.log(`[Fortuna] Auto-snapshot: ${check.reason}`)\n    }\n    autoSnapshotDone.current = true\n  }, [loading, state, history])\n\n  // Manual snapshot\n  const takeManualSnapshot = useCallback((description?: string) => {\n    const snap = captureSnapshot(state, 'manual', description || 'Manual snapshot')\n    const updated = addSnapshot(history, snap)\n    setHistory(updated)\n    Storage.saveFinancialHistory(updated)\n  }, [state, history])\n\n  // ---- Computed values ----\n\n  const netSEIncome = state.incomeStreams\n    .filter(s => ['business', 'freelance'].includes(s.type) && s.isActive)\n    .reduce((sum, s) => sum + s.annualAmount, 0) -\n    state.expenses.filter(e => e.isDeductible).reduce((sum, e) => sum + (e.annualAmount * e.deductionPct / 100), 0)\n\n  const taxReport = generateTaxReport(state)\n  const strategies = detectStrategies(state)\n  const risks = analyzeRisks(state)\n  const healthScore = calculateHealthScore(state)\n  const entityComparison = compareEntities(Math.max(0, netSEIncome), state.profile)\n\n  // History computed values\n  const trends = computeTrends(history)\n  const strategyEffects = analyzeStrategyEffectiveness(state, history)\n  const projections = projectTrajectory(history)\n  const milestones = buildTimeline(state, history)\n\n  // Session digest\n  const sessionDigest = generateSessionDigest(\n    state, history, trends, strategies, taxReport,\n    uxPrefs.lastSessionTimestamp || null,\n  )\n\n  // Update last session timestamp once loading completes\n  const sessionTracked = useRef(false)\n  useEffect(() => {\n    if (!loading && !sessionTracked.current) {\n      sessionTracked.current = true\n      // Delay to let digest read the previous timestamp\n      setTimeout(() => updateUXPrefs({ lastSessionTimestamp: new Date().toISOString() }), 2000)\n    }\n  }, [loading, updateUXPrefs])\n\n  return (\n    <FortunaContext.Provider value={{\n      state, setState, updateState, save, loading,\n      uxPrefs, updateUXPrefs,\n      taxReport, strategies, risks, healthScore, entityComparison,\n      history, trends, strategyEffects, projections, milestones, takeManualSnapshot,\n      sessionDigest,\n      storageBackend,\n    }}>\n      {children}\n    </FortunaContext.Provider>\n  )\n}\n\nexport function useFortuna() {\n  const ctx = useContext(FortunaContext)\n  if (!ctx) throw new Error('useFortuna must be used within FortunaProvider')\n  return ctx\n}\n\nexport { genId }\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\hooks\\useUndoRedo.ts","messages":[{"ruleId":"react-hooks/immutability","severity":2,"message":"Error: Cannot access variable before it is declared\n\n`performUndo` is accessed before it is declared, which prevents the earlier access from updating when this value changes over time.\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\hooks\\useUndoRedo.ts:59:25\n  57 |         duration: 6000,\n  58 |         actionLabel: 'Undo',\n> 59 |         onAction: () => performUndo(),\n     |                         ^^^^^^^^^^^ `performUndo` accessed before it is declared\n  60 |       })\n  61 |     }\n  62 |   }, [state, addToast])\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\hooks\\useUndoRedo.ts:67:3\n  65 |    * Undo the last action.\n  66 |    */\n> 67 |   const performUndo = useCallback(() => {\n     |   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 68 |     const entry = undoStack.current.pop()\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 69 |     if (!entry) return false\n     …\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 87 |     return true\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 88 |   }, [state, setState, addToast])\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ `performUndo` is declared here\n  89 |\n  90 |   /**\n  91 |    * Redo the last undone action.","line":59,"column":25,"nodeType":null,"endLine":59,"endColumn":36},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'performUndo'. Either include it or remove the dependency array.","line":62,"column":6,"nodeType":"ArrayExpression","endLine":62,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [state, addToast, performUndo]","fix":{"range":[1884,1901],"text":"[state, addToast, performUndo]"}}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * FORTUNA ENGINE — Undo/Redo System (Phase 2 UX Fix)\n *\n * Maintains a stack of state snapshots. Every destructive action\n * (delete, clear, bulk update) goes through this system and shows\n * an \"Undo\" toast. Ctrl+Z / Cmd+Z triggers global undo.\n *\n * Usage:\n *   const { execute, undo, redo, canUndo, canRedo } = useUndoRedo()\n *   execute('Deleted scenario \"Max Roth\"', () => removeScenario(id))\n */\n\nimport { useCallback, useRef, useEffect } from 'react'\nimport { useFortuna } from './useFortuna'\nimport { useToasts } from '../components/ToastSystem'\nimport type { FortunaState } from '../engine/storage'\n\n// ─── Types ──────────────────────────────────────────────────────────\n\ninterface UndoEntry {\n  description: string\n  previousState: FortunaState\n  timestamp: number\n}\n\nconst MAX_STACK = 30\n\n// ─── Hook ───────────────────────────────────────────────────────────\n\nexport function useUndoRedo() {\n  const { state, setState } = useFortuna()\n  const { addToast } = useToasts()\n  const undoStack = useRef<UndoEntry[]>([])\n  const redoStack = useRef<UndoEntry[]>([])\n\n  /**\n   * Execute a destructive action with undo support.\n   * Captures current state before running the action.\n   */\n  const execute = useCallback((description: string, action: () => void, options?: { silent?: boolean }) => {\n    // Capture snapshot before action\n    undoStack.current = [\n      ...undoStack.current.slice(-MAX_STACK + 1),\n      { description, previousState: structuredClone(state), timestamp: Date.now() },\n    ]\n    // Clear redo stack (new action invalidates redo history)\n    redoStack.current = []\n\n    // Run the action\n    action()\n\n    // Show undo toast (unless silent)\n    if (!options?.silent) {\n      addToast({\n        type: 'info',\n        title: description,\n        duration: 6000,\n        actionLabel: 'Undo',\n        onAction: () => performUndo(),\n      })\n    }\n  }, [state, addToast])\n\n  /**\n   * Undo the last action.\n   */\n  const performUndo = useCallback(() => {\n    const entry = undoStack.current.pop()\n    if (!entry) return false\n\n    // Push current state to redo stack\n    redoStack.current.push({\n      description: entry.description,\n      previousState: structuredClone(state),\n      timestamp: Date.now(),\n    })\n\n    // Restore previous state\n    setState(entry.previousState)\n\n    addToast({\n      type: 'success',\n      title: `Undone: ${entry.description}`,\n      duration: 3000,\n    })\n\n    return true\n  }, [state, setState, addToast])\n\n  /**\n   * Redo the last undone action.\n   */\n  const performRedo = useCallback(() => {\n    const entry = redoStack.current.pop()\n    if (!entry) return false\n\n    // Push current state to undo stack\n    undoStack.current.push({\n      description: `Redo: ${entry.description}`,\n      previousState: structuredClone(state),\n      timestamp: Date.now(),\n    })\n\n    setState(entry.previousState)\n\n    addToast({\n      type: 'info',\n      title: `Redone: ${entry.description}`,\n      duration: 3000,\n    })\n\n    return true\n  }, [state, setState, addToast])\n\n  // Ctrl+Z / Cmd+Z / Ctrl+Shift+Z / Cmd+Shift+Z global shortcut\n  useEffect(() => {\n    const handler = (e: KeyboardEvent) => {\n      // Don't capture if user is typing in an input/textarea\n      if (\n        e.target instanceof HTMLInputElement ||\n        e.target instanceof HTMLTextAreaElement ||\n        (e.target as HTMLElement)?.isContentEditable\n      ) {\n        return\n      }\n\n      if ((e.metaKey || e.ctrlKey) && e.key === 'z') {\n        e.preventDefault()\n        if (e.shiftKey) {\n          performRedo()\n        } else {\n          performUndo()\n        }\n      }\n    }\n    window.addEventListener('keydown', handler)\n    return () => window.removeEventListener('keydown', handler)\n  }, [performUndo, performRedo])\n\n  return {\n    execute,\n    undo: performUndo,\n    redo: performRedo,\n    canUndo: undoStack.current.length > 0,\n    canRedo: redoStack.current.length > 0,\n    undoCount: undoStack.current.length,\n    redoCount: redoStack.current.length,\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\main.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\AIAdvisor.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ProviderId' is defined but never used.","line":8,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":35,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ProviderId"},"fix":{"range":[405,422],"text":""},"desc":"Remove unused variable \"ProviderId\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TrendingUp' is defined but never used.","line":11,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":34,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TrendingUp"},"fix":{"range":[507,519],"text":""},"desc":"Remove unused variable \"TrendingUp\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Shield' is defined but never used.","line":11,"column":36,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":42,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Shield"},"fix":{"range":[519,527],"text":""},"desc":"Remove unused variable \"Shield\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":175,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":175,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10988,10991],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10988,10991],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":613,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":613,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32429,32432],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32429,32432],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":613,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":613,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32446,32449],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32446,32449],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":613,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":613,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32460,32463],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32460,32463],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":613,"column":86,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":613,"endColumn":89,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32480,32483],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32480,32483],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":626,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":626,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[33080,33083],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[33080,33083],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":629,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":629,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[33241,33244],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[33241,33244],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":10,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useRef, useEffect } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { buildSystemPrompt, buildConversationMessages } from '../engine/ai-context'\nimport { Storage, type AdvisorMessage } from '../engine/storage'\nimport {\n  sendAIMessage, getAISettings, saveAISettings, getProviderIcon, getModelDisplayName,\n  fetchServerProviders, DEFAULT_PROVIDERS,\n  type AISettings, type ProviderId, type ProviderConfig,\n} from '../engine/ai-providers'\nimport {\n  Bot, Send, Sparkles, TrendingUp, Shield, DollarSign, Building2,\n  Loader2, Trash2, HelpCircle, BookOpen, Target, PiggyBank,\n  Wallet, ChevronRight, MessageSquare, Settings, X\n} from 'lucide-react'\n\n// ─── Query Categories ──────────────────────────────────────────────────\n\ninterface QueryCategory {\n  id: string\n  label: string\n  icon: JSX.Element\n  color: string\n  queries: { label: string; query: string }[]\n}\n\nconst QUERY_CATEGORIES: QueryCategory[] = [\n  {\n    id: 'strategy', label: 'Tax Strategy', icon: <DollarSign size={14} />, color: 'var(--accent-gold)',\n    queries: [\n      { label: 'Top 3 actions to reduce my taxes', query: 'What are my top 3 highest-impact actions to reduce my total tax bill? Show me the specific dollar savings for each.' },\n      { label: 'Should I form an S-Corp?', query: 'Should I form an S-Corp? Walk me through the exact math — current SE tax vs. S-Corp FICA savings, minus compliance costs. Give me a clear yes/no recommendation.' },\n      { label: 'Am I leaving deductions on the table?', query: 'Analyze my deductions and tell me what I\\'m missing. What unclaimed deductions should I be taking and how much would each save me?' },\n      { label: 'How to lower my effective rate', query: 'My effective tax rate is what it is — what specific strategies can bring it down, and by how many percentage points each?' },\n    ],\n  },\n  {\n    id: 'income', label: 'Income & Paycheck', icon: <Wallet size={14} />, color: 'var(--accent-emerald)',\n    queries: [\n      { label: 'Break down my paycheck', query: 'Walk me through exactly where every dollar of my paycheck goes — gross to net, including all deductions and taxes.' },\n      { label: 'How much do I actually keep?', query: 'What\\'s my effective keep rate — for every dollar I earn, how much actually ends up in my pocket after all taxes?' },\n      { label: 'Am I withholding correctly?', query: 'Based on my W-2 withholding and total tax liability, am I on track for a refund or will I owe? Should I adjust my W-4?' },\n      { label: 'Income diversification ideas', query: 'Based on my skills and current income profile, what additional revenue streams should I consider? What are the tax implications of each?' },\n    ],\n  },\n  {\n    id: 'entity', label: 'Business & Entity', icon: <Building2 size={14} />, color: 'var(--accent-purple)',\n    queries: [\n      { label: 'Compare my entity options', query: 'Compare sole prop vs LLC vs S-Corp vs C-Corp for my specific income level. Show me the total tax, compliance costs, and net benefit of each.' },\n      { label: 'Entity compliance requirements', query: 'What are the ongoing compliance requirements for my current entities? Annual filings, deadlines, costs, and what happens if I miss them.' },\n      { label: 'Reasonable salary for S-Corp', query: 'If I have or form an S-Corp, what would be a reasonable salary to set? What factors does the IRS look at?' },\n      { label: 'Multi-entity strategy', query: 'Would it make sense to have multiple entities for my income streams? Walk me through the pros, cons, and optimal structure.' },\n    ],\n  },\n  {\n    id: 'retirement', label: 'Retirement & Savings', icon: <PiggyBank size={14} />, color: 'var(--accent-blue)',\n    queries: [\n      { label: 'Maximize retirement contributions', query: 'How can I maximize my retirement savings across all available vehicles? What\\'s the total I can shelter from taxes this year?' },\n      { label: 'SEP-IRA vs Solo 401(k)', query: 'Compare SEP-IRA vs Solo 401(k) for my situation. Which lets me contribute more and what are the tradeoffs?' },\n      { label: 'Roth conversion strategy', query: 'Does a Roth conversion make sense for me? What income level makes it optimal and what\\'s the tax cost?' },\n      { label: 'How much do I need to retire?', query: 'Based on my current spending and income, how much do I need saved to retire comfortably? Am I on track?' },\n    ],\n  },\n  {\n    id: 'planning', label: 'Planning & Goals', icon: <Target size={14} />, color: '#f59e0b',\n    queries: [\n      { label: 'Complete financial health checkup', query: 'Give me a comprehensive financial health assessment. What\\'s working well, what needs attention, and what\\'s my action plan in priority order?' },\n      { label: 'What if I earned 50% more?', query: 'If my income increased by 50%, how would my taxes change? What new brackets, phase-outs, or planning opportunities would apply?' },\n      { label: 'Year-end tax planning', query: 'What year-end tax planning moves should I make before December 31? List them in priority order with deadlines and estimated savings.' },\n      { label: 'Build a 12-month financial plan', query: 'Help me build a 12-month financial action plan. Monthly priorities, quarterly estimated taxes, annual deadlines, and growth targets.' },\n    ],\n  },\n  {\n    id: 'education', label: 'Learn & Understand', icon: <BookOpen size={14} />, color: '#ec4899',\n    queries: [\n      { label: 'Explain marginal vs effective rate', query: 'Explain the difference between my marginal and effective tax rate in plain English, using my actual numbers. Why does this matter for financial decisions?' },\n      { label: 'How self-employment tax works', query: 'Walk me through exactly how self-employment tax works — the 92.35% calculation, the 15.3% rate, the deductible half, and how it stacks with income tax.' },\n      { label: 'What is the QBI deduction?', query: 'Explain the QBI (Section 199A) deduction in simple terms. Do I qualify? How much am I getting and could I get more?' },\n      { label: 'How depreciation saves taxes', query: 'Explain how Section 179 and bonus depreciation work. Can I use them? Give me a practical example with my income level.' },\n    ],\n  },\n  {\n    id: 'features', label: 'Using Fortuna', icon: <HelpCircle size={14} />, color: 'var(--text-muted)',\n    queries: [\n      { label: 'What can Fortuna do for me?', query: 'Give me a tour of all Fortuna Engine features and how each one can help my specific financial situation. What should I explore first?' },\n      { label: 'How to set up my W-2 data', query: 'Walk me through how to correctly enter my W-2 information into Fortuna. What fields matter most and where do I find them on my W-2?' },\n      { label: 'How to run what-if scenarios', query: 'How do I use the Scenario Modeler? What are the most valuable scenarios to run for my situation?' },\n      { label: 'Is my data complete enough?', query: 'Look at what I\\'ve entered so far and tell me what\\'s missing. What additional data would unlock better analysis and recommendations?' },\n    ],\n  },\n]\n\n// ─── Quick Starts (no category selected) ───────────────────────────────\n\nconst QUICK_STARTS = [\n  { icon: <DollarSign size={14} />, label: 'Top 3 tax savings actions', query: 'What are my top 3 highest-impact actions to reduce my total tax bill right now? Show specific dollar savings.' },\n  { icon: <Sparkles size={14} />, label: 'Full financial health checkup', query: 'Give me a comprehensive financial health assessment — what\\'s working, what needs attention, and prioritized action plan.' },\n  { icon: <Building2 size={14} />, label: 'Should I restructure?', query: 'Should I change my business entity structure? Compare my current setup vs. alternatives with exact numbers.' },\n  { icon: <HelpCircle size={14} />, label: 'What can Fortuna do?', query: 'Give me a tour of all Fortuna Engine features and tell me which ones are most valuable for my specific situation.' },\n]\n\n// ─── Component ─────────────────────────────────────────────────────────\n\nexport function AIAdvisor() {\n  const { state, taxReport, strategies, risks, healthScore } = useFortuna()\n  const [messages, setMessages] = useState<AdvisorMessage[]>([])\n  const [input, setInput] = useState('')\n  const [isLoading, setIsLoading] = useState(false)\n  const [activeCategory, setActiveCategory] = useState<string | null>(null)\n  const [showSettings, setShowSettings] = useState(false)\n  const [aiSettings, setAISettings] = useState<AISettings>(getAISettings)\n  const [serverProviders, setServerProviders] = useState<ProviderConfig[] | null>(null)\n  const [lastModel, setLastModel] = useState<string | null>(null)\n  const chatEndRef = useRef<HTMLDivElement>(null)\n  const inputRef = useRef<HTMLInputElement>(null)\n\n  useEffect(() => {\n    Storage.getAdvisorHistory().then(h => { if (h.length > 0) setMessages(h) })\n    // Fetch server providers\n    fetchServerProviders().then(r => {\n      if (r?.providers?.length) setServerProviders(r.providers)\n    })\n  }, [])\n\n  useEffect(() => {\n    chatEndRef.current?.scrollIntoView({ behavior: 'smooth' })\n  }, [messages])\n\n  // Get available providers based on mode\n  const availableProviders: ProviderConfig[] = aiSettings.mode === 'proxy' && serverProviders\n    ? serverProviders\n    : DEFAULT_PROVIDERS\n\n  const currentProvider = availableProviders.find(p => p.id === aiSettings.provider)\n\n  const updateSettings = (partial: Partial<AISettings>) => {\n    const updated = { ...aiSettings, ...partial }\n    // If provider changed, reset model to provider's default\n    if (partial.provider && partial.provider !== aiSettings.provider) {\n      const prov = availableProviders.find(p => p.id === partial.provider)\n      if (prov) updated.model = prov.defaultModel\n    }\n    setAISettings(updated)\n    saveAISettings(updated)\n  }\n\n  const sendMessage = async (content: string) => {\n    if (!content.trim() || isLoading) return\n\n    const userMsg: AdvisorMessage = { role: 'user', content: content.trim(), timestamp: new Date().toISOString() }\n    const updatedMessages = [...messages, userMsg]\n    setMessages(updatedMessages)\n    setInput('')\n    setActiveCategory(null)\n    setIsLoading(true)\n\n    try {\n      const systemPrompt = await buildSystemPrompt(state)\n      const conversationMessages = buildConversationMessages(\n        updatedMessages.map(m => ({ role: m.role, content: m.content })),\n        systemPrompt\n      )\n\n      const result = await sendAIMessage(\n        conversationMessages.map(m => ({ role: m.role as 'user' | 'assistant', content: m.content })),\n        systemPrompt,\n        aiSettings,\n      )\n\n      setLastModel(`${getProviderIcon(result.provider)} ${getModelDisplayName(result.model)}`)\n\n      const assistantMsg: AdvisorMessage = { role: 'assistant', content: result.text, timestamp: new Date().toISOString() }\n      const final = [...updatedMessages, assistantMsg]\n      setMessages(final)\n      await Storage.saveAdvisorHistory(final.slice(-40))\n    } catch (err: any) {\n      console.error('AI Advisor error:', err)\n      // Show error message or fallback\n      const errorContent = err.message?.includes('API key')\n        || err.message?.includes('not configured')\n        || err.message?.includes('API not configured')\n        ? `⚙️ **Setup Required**\\n\\n${err.message}\\n\\nClick the ⚙ icon in the header to configure your AI provider.`\n        : buildFallback(taxReport, strategies, risks, healthScore)\n\n      const fallback: AdvisorMessage = {\n        role: 'assistant',\n        content: errorContent,\n        timestamp: new Date().toISOString(),\n      }\n      setMessages(prev => [...prev, fallback])\n    } finally {\n      setIsLoading(false)\n      inputRef.current?.focus()\n    }\n  }\n\n  const clearHistory = async () => { setMessages([]); await Storage.saveAdvisorHistory([]) }\n  const hasData = state.incomeStreams.length > 0\n\n  return (\n    <div className=\"view-enter\" style={{ display: 'flex', flexDirection: 'column', height: 'calc(100vh - 64px)' }}>\n      {/* Header */}\n      <div style={{ marginBottom: 16, display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>\n        <div>\n          <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 4 }}>\n            <h1 className=\"section-title\">AI Financial Advisor</h1>\n            <span className=\"pill gold\"><Sparkles size={11} /> Full Context</span>\n            {currentProvider && (\n              <span className=\"pill\" style={{ background: 'rgba(139, 92, 246, 0.15)', color: '#a78bfa', fontSize: 10 }}>\n                {getProviderIcon(aiSettings.provider)} {getModelDisplayName(aiSettings.model)}\n              </span>\n            )}\n          </div>\n          <p className=\"section-subtitle\">\n            {hasData\n              ? `Analyzing $${taxReport.grossIncome.toLocaleString()} income · ${strategies.length} strategies · Score: ${healthScore.overall}/100 — Ask anything about finances, taxes, business, or this tool`\n              : 'Ask general financial questions, or set up your profile for personalized advice'}\n          </p>\n        </div>\n        <div style={{ display: 'flex', gap: 6 }}>\n          <button onClick={() => setShowSettings(!showSettings)} className=\"btn btn-ghost\" style={{ fontSize: 11, padding: '4px 10px' }}>\n            <Settings size={11} /> AI Settings\n          </button>\n          {messages.length > 0 && (\n            <button onClick={clearHistory} className=\"btn btn-ghost\" style={{ fontSize: 11, padding: '4px 10px' }}>\n              <Trash2 size={11} /> Clear\n            </button>\n          )}\n        </div>\n      </div>\n\n      {/* AI Settings Panel */}\n      {showSettings && (\n        <div style={{\n          background: 'var(--bg-card)', border: '1px solid var(--border-subtle)', borderRadius: 12,\n          padding: 16, marginBottom: 16, position: 'relative',\n        }}>\n          <button onClick={() => setShowSettings(false)} style={{\n            position: 'absolute', top: 8, right: 8, background: 'none', border: 'none',\n            color: 'var(--text-muted)', cursor: 'pointer',\n          }}><X size={14} /></button>\n          \n          <h3 style={{ fontSize: 13, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 12 }}>\n            AI Provider Settings\n          </h3>\n\n          {/* Mode Toggle */}\n          <div style={{ marginBottom: 12 }}>\n            <label style={{ fontSize: 11, color: 'var(--text-muted)', display: 'block', marginBottom: 4 }}>Connection Mode</label>\n            <div style={{ display: 'flex', gap: 6 }}>\n              {(['proxy', 'direct'] as const).map(mode => (\n                <button\n                  key={mode}\n                  onClick={() => updateSettings({ mode })}\n                  style={{\n                    flex: 1, padding: '6px 10px', borderRadius: 6, fontSize: 11, cursor: 'pointer',\n                    border: aiSettings.mode === mode ? '1px solid var(--accent-gold)' : '1px solid var(--border-subtle)',\n                    background: aiSettings.mode === mode ? 'rgba(251, 191, 36, 0.1)' : 'var(--bg-hover)',\n                    color: aiSettings.mode === mode ? 'var(--accent-gold)' : 'var(--text-secondary)',\n                  }}\n                >\n                  {mode === 'proxy' ? '🔒 Server Proxy' : '🔑 Direct (Your Keys)'}\n                </button>\n              ))}\n            </div>\n            <p style={{ fontSize: 10, color: 'var(--text-muted)', marginTop: 4 }}>\n              {aiSettings.mode === 'proxy'\n                ? 'API keys stored securely on your server. Requires backend setup.'\n                : 'API keys stored in your browser. No server needed — works standalone.'}\n            </p>\n          </div>\n\n          {/* Provider Select */}\n          <div style={{ marginBottom: 12 }}>\n            <label style={{ fontSize: 11, color: 'var(--text-muted)', display: 'block', marginBottom: 4 }}>Provider</label>\n            <div style={{ display: 'flex', flexWrap: 'wrap', gap: 6 }}>\n              {availableProviders.map(p => (\n                <button\n                  key={p.id}\n                  onClick={() => updateSettings({ provider: p.id })}\n                  style={{\n                    padding: '5px 10px', borderRadius: 6, fontSize: 11, cursor: 'pointer',\n                    border: aiSettings.provider === p.id ? '1px solid var(--accent-gold)' : '1px solid var(--border-subtle)',\n                    background: aiSettings.provider === p.id ? 'rgba(251, 191, 36, 0.1)' : 'var(--bg-hover)',\n                    color: aiSettings.provider === p.id ? 'var(--accent-gold)' : 'var(--text-secondary)',\n                  }}\n                >\n                  {getProviderIcon(p.id)} {p.name}\n                </button>\n              ))}\n            </div>\n          </div>\n\n          {/* Model Select */}\n          {currentProvider && (\n            <div style={{ marginBottom: 12 }}>\n              <label style={{ fontSize: 11, color: 'var(--text-muted)', display: 'block', marginBottom: 4 }}>Model</label>\n              <select\n                value={aiSettings.model}\n                onChange={e => updateSettings({ model: e.target.value })}\n                style={{\n                  width: '100%', padding: '6px 8px', borderRadius: 6, fontSize: 12,\n                  background: 'var(--bg-hover)', border: '1px solid var(--border-subtle)',\n                  color: 'var(--text-primary)', outline: 'none',\n                }}\n              >\n                {currentProvider.models.map(m => (\n                  <option key={m} value={m}>{getModelDisplayName(m)}</option>\n                ))}\n              </select>\n            </div>\n          )}\n\n          {/* Client API Key (direct mode only) */}\n          {aiSettings.mode === 'direct' && (\n            <div style={{ marginBottom: 8 }}>\n              <label style={{ fontSize: 11, color: 'var(--text-muted)', display: 'block', marginBottom: 4 }}>\n                {currentProvider?.name || 'Provider'} API Key\n              </label>\n              <input\n                type=\"password\"\n                placeholder={`Enter your ${aiSettings.provider} API key...`}\n                value={aiSettings.clientKeys[aiSettings.provider] || ''}\n                onChange={e => updateSettings({\n                  clientKeys: { ...aiSettings.clientKeys, [aiSettings.provider]: e.target.value }\n                })}\n                style={{\n                  width: '100%', padding: '6px 8px', borderRadius: 6, fontSize: 12,\n                  background: 'var(--bg-hover)', border: '1px solid var(--border-subtle)',\n                  color: 'var(--text-primary)', outline: 'none', fontFamily: 'var(--font-mono)',\n                  boxSizing: 'border-box',\n                }}\n              />\n              <p style={{ fontSize: 10, color: 'var(--text-muted)', marginTop: 4 }}>\n                Stored in your browser only. Never sent to our server.\n              </p>\n            </div>\n          )}\n\n          {lastModel && (\n            <p style={{ fontSize: 10, color: 'var(--text-muted)', borderTop: '1px solid var(--border-subtle)', paddingTop: 8, marginTop: 4 }}>\n              Last response: {lastModel}\n            </p>\n          )}\n        </div>\n      )}\n\n      {/* Chat Area */}\n      <div style={{ flex: 1, overflow: 'auto', display: 'flex', flexDirection: 'column', gap: 16, paddingBottom: 16 }}>\n\n        {/* Welcome State */}\n        {messages.length === 0 && (\n          <div style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center' }}>\n            <div style={{\n              width: 56, height: 56, borderRadius: 16, marginBottom: 16,\n              background: 'linear-gradient(135deg, var(--accent-gold), #b8912e)',\n              display: 'flex', alignItems: 'center', justifyContent: 'center',\n              boxShadow: '0 4px 20px rgba(212,168,67,0.3)',\n            }}>\n              <Bot size={28} color=\"#0c0e12\" />\n            </div>\n            <div style={{ fontFamily: 'var(--font-display)', fontSize: 20, marginBottom: 6, color: 'var(--text-primary)' }}>\n              Your Financial Intelligence System\n            </div>\n            <p style={{ fontSize: 13, color: 'var(--text-muted)', lineHeight: 1.6, maxWidth: 520, textAlign: 'center', marginBottom: 24 }}>\n              Ask anything — tax strategy, business structure, paycheck questions, retirement, how to use Fortuna features, financial concepts, or guidance on improving your situation.\n            </p>\n\n            {/* Category Chips */}\n            <div style={{ display: 'flex', gap: 6, flexWrap: 'wrap', justifyContent: 'center', marginBottom: 16, maxWidth: 600 }}>\n              {QUERY_CATEGORIES.map(cat => (\n                <button key={cat.id}\n                  onClick={() => setActiveCategory(activeCategory === cat.id ? null : cat.id)}\n                  style={{\n                    padding: '6px 14px', borderRadius: 20, cursor: 'pointer',\n                    border: `1px solid ${activeCategory === cat.id ? cat.color : 'var(--border-subtle)'}`,\n                    background: activeCategory === cat.id ? `${cat.color}15` : 'var(--bg-surface)',\n                    color: activeCategory === cat.id ? cat.color : 'var(--text-muted)',\n                    fontSize: 12, fontWeight: 500, display: 'flex', alignItems: 'center', gap: 6,\n                    transition: 'all 0.2s',\n                  }}>\n                  {cat.icon} {cat.label}\n                </button>\n              ))}\n            </div>\n\n            {/* Category Queries */}\n            {activeCategory ? (\n              <div style={{ width: '100%', maxWidth: 600, display: 'flex', flexDirection: 'column', gap: 6 }}>\n                {QUERY_CATEGORIES.find(c => c.id === activeCategory)?.queries.map((q, i) => (\n                  <button key={i} onClick={() => sendMessage(q.query)}\n                    className=\"hover-border-gold\"\n                    style={{\n                      padding: '10px 16px', borderRadius: 10, textAlign: 'left', cursor: 'pointer',\n                      background: 'var(--bg-elevated)', border: '1px solid var(--border-subtle)',\n                      color: 'var(--text-secondary)', fontSize: 12,\n                      display: 'flex', alignItems: 'center', gap: 8, transition: 'border-color 0.2s',\n                    }}>\n                    <MessageSquare size={12} color=\"var(--accent-gold)\" style={{ flexShrink: 0 }} />\n                    <span style={{ flex: 1 }}>{q.label}</span>\n                    <ChevronRight size={12} color=\"var(--text-muted)\" />\n                  </button>\n                ))}\n              </div>\n            ) : (\n              /* Quick Starts Grid */\n              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 8, maxWidth: 600, width: '100%' }}>\n                {QUICK_STARTS.map((q, i) => (\n                  <button key={i} onClick={() => sendMessage(q.query)}\n                    className=\"hover-border-gold\"\n                    style={{\n                      padding: '12px 16px', borderRadius: 10, textAlign: 'left', cursor: 'pointer',\n                      background: 'var(--bg-elevated)', border: '1px solid var(--border-subtle)',\n                      color: 'var(--text-secondary)', fontSize: 12,\n                      display: 'flex', alignItems: 'center', gap: 10, transition: 'border-color 0.2s',\n                    }}>\n                    <div style={{ color: 'var(--accent-gold)' }}>{q.icon}</div>\n                    {q.label}\n                  </button>\n                ))}\n              </div>\n            )}\n          </div>\n        )}\n\n        {/* Messages */}\n        {messages.map((msg, i) => (\n          <div key={i} style={{\n            display: 'flex', gap: 12, alignItems: 'flex-start',\n            maxWidth: msg.role === 'user' ? '75%' : '100%',\n            marginLeft: msg.role === 'user' ? 'auto' : 0,\n          }}>\n            {msg.role === 'assistant' && (\n              <div style={{\n                width: 32, height: 32, borderRadius: 10, flexShrink: 0,\n                background: 'linear-gradient(135deg, var(--accent-gold), #b8912e)',\n                display: 'flex', alignItems: 'center', justifyContent: 'center',\n              }}>\n                <Bot size={16} color=\"#0c0e12\" />\n              </div>\n            )}\n            <div style={{\n              background: msg.role === 'user' ? 'var(--accent-gold-dim)' : 'var(--bg-elevated)',\n              border: `1px solid ${msg.role === 'user' ? 'rgba(212,168,67,0.2)' : 'var(--border-subtle)'}`,\n              borderRadius: msg.role === 'user' ? '14px 14px 4px 14px' : '14px 14px 14px 4px',\n              padding: '16px 20px', fontSize: 13, lineHeight: 1.7, color: 'var(--text-secondary)',\n            }}>\n              {msg.role === 'assistant' ? renderContent(msg.content) : msg.content}\n            </div>\n          </div>\n        ))}\n\n        {/* Loading */}\n        {isLoading && (\n          <div style={{ display: 'flex', gap: 12, alignItems: 'flex-start' }}>\n            <div style={{\n              width: 32, height: 32, borderRadius: 10,\n              background: 'linear-gradient(135deg, var(--accent-gold), #b8912e)',\n              display: 'flex', alignItems: 'center', justifyContent: 'center',\n            }}>\n              <Bot size={16} color=\"#0c0e12\" />\n            </div>\n            <div style={{\n              background: 'var(--bg-elevated)', border: '1px solid var(--border-subtle)',\n              borderRadius: '14px 14px 14px 4px', padding: '16px 20px',\n              display: 'flex', alignItems: 'center', gap: 8,\n            }}>\n              <Loader2 size={14} color=\"var(--accent-gold)\" className=\"spin\" />\n              <span style={{ fontSize: 13, color: 'var(--text-muted)' }}>Analyzing your financial data...</span>\n            </div>\n          </div>\n        )}\n\n        <div ref={chatEndRef} />\n      </div>\n\n      {/* Follow-up suggestions */}\n      {messages.length > 0 && messages.length < 10 && !isLoading && (\n        <div style={{ display: 'flex', gap: 6, flexWrap: 'wrap', marginBottom: 8 }}>\n          {getFollowUps(messages).map((s, i) => (\n            <button key={i} onClick={() => sendMessage(s)} className=\"btn btn-ghost\"\n              style={{ fontSize: 11, padding: '4px 10px' }}>{s}</button>\n          ))}\n        </div>\n      )}\n\n      {/* Input */}\n      <div style={{\n        display: 'flex', gap: 12, alignItems: 'center',\n        background: 'var(--bg-elevated)', border: '1px solid var(--border-medium)',\n        borderRadius: 14, padding: '12px 16px',\n      }}>\n        <input ref={inputRef} type=\"text\" value={input}\n          onChange={e => setInput(e.target.value)}\n          onKeyDown={e => e.key === 'Enter' && sendMessage(input)}\n          placeholder=\"Ask about taxes, business, retirement, Fortuna features, or anything financial...\"\n          disabled={isLoading}\n          style={{\n            flex: 1, background: 'transparent', border: 'none', outline: 'none',\n            color: 'var(--text-primary)', fontFamily: 'var(--font-body)', fontSize: 14,\n            opacity: isLoading ? 0.5 : 1,\n          }} />\n        <button onClick={() => sendMessage(input)}\n          disabled={isLoading || !input.trim()} className=\"btn btn-primary\"\n          style={{ padding: '8px 14px', borderRadius: 10, opacity: isLoading || !input.trim() ? 0.5 : 1 }}>\n          {isLoading ? <Loader2 size={16} className=\"spin\" /> : <Send size={16} />}\n        </button>\n      </div>\n\n      <style>{`\n        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }\n        .spin { animation: spin 1s linear infinite; }\n        .hover-border-gold:hover { border-color: var(--accent-gold-glow) !important; }\n      `}</style>\n    </div>\n  )\n}\n\n// ─── Markdown Renderer ─────────────────────────────────────────────────\n\nfunction renderContent(text: string) {\n  return text.split('\\n').map((line, i) => {\n    if (line.startsWith('### '))\n      return <div key={i} style={{ fontWeight: 600, color: 'var(--text-primary)', fontSize: 14, marginTop: 12, marginBottom: 4 }}>{renderInline(line.slice(4))}</div>\n    if (line.startsWith('## '))\n      return <div key={i} style={{ fontWeight: 600, color: 'var(--accent-gold)', fontSize: 15, marginTop: 16, marginBottom: 6, fontFamily: 'var(--font-display)' }}>{renderInline(line.slice(3))}</div>\n\n    if (line.startsWith('- ') || line.startsWith('• ') || line.startsWith('* '))\n      return <div key={i} style={{ paddingLeft: 16, position: 'relative', marginBottom: 4 }}>\n        <span style={{ position: 'absolute', left: 0, color: 'var(--accent-gold)' }}>•</span>\n        {renderInline(line.replace(/^[-•*]\\s*/, ''))}\n      </div>\n\n    if (/^\\d+\\.\\s/.test(line)) {\n      const num = line.match(/^\\d+/)?.[0]\n      return <div key={i} style={{ paddingLeft: 24, position: 'relative', marginBottom: 6 }}>\n        <span style={{ position: 'absolute', left: 0, color: 'var(--accent-gold)', fontFamily: 'var(--font-mono)', fontWeight: 600, fontSize: 12 }}>{num}.</span>\n        {renderInline(line.replace(/^\\d+\\.\\s*/, ''))}\n      </div>\n    }\n\n    if (line.trim() === '---' || line.trim().startsWith('═'))\n      return <hr key={i} style={{ border: 'none', borderTop: '1px solid var(--border-subtle)', margin: '8px 0' }} />\n    if (line.trim() === '') return <div key={i} style={{ height: 8 }} />\n    return <div key={i} style={{ marginBottom: 4 }}>{renderInline(line)}</div>\n  })\n}\n\nfunction renderInline(text: string): React.ReactNode {\n  const segments: React.ReactNode[] = []\n  let remaining = text\n  let key = 0\n\n  while (remaining.length > 0) {\n    const boldMatch = remaining.match(/\\*\\*(.*?)\\*\\*/)\n    const codeMatch = remaining.match(/`(.*?)`/)\n    const dollarMatch = remaining.match(/\\$[\\d,]+(?:\\.\\d{2})?(?:\\/\\w+)?/)\n\n    const matches = [\n      boldMatch ? { type: 'bold' as const, match: boldMatch, index: boldMatch.index! } : null,\n      codeMatch ? { type: 'code' as const, match: codeMatch, index: codeMatch.index! } : null,\n      dollarMatch ? { type: 'dollar' as const, match: dollarMatch, index: dollarMatch.index! } : null,\n    ].filter(Boolean).sort((a, b) => a!.index - b!.index)\n\n    if (matches.length === 0) { segments.push(remaining); break }\n    const first = matches[0]!\n    if (first.index > 0) segments.push(remaining.slice(0, first.index))\n\n    if (first.type === 'bold') {\n      segments.push(<strong key={key++} style={{ color: 'var(--text-primary)', fontWeight: 600 }}>{first.match![1]}</strong>)\n    } else if (first.type === 'code') {\n      segments.push(<code key={key++} style={{ background: 'var(--bg-hover)', padding: '1px 5px', borderRadius: 4, fontFamily: 'var(--font-mono)', fontSize: 12 }}>{first.match![1]}</code>)\n    } else {\n      segments.push(<span key={key++} style={{ fontFamily: 'var(--font-mono)', fontWeight: 600, color: 'var(--accent-gold)' }}>{first.match![0]}</span>)\n    }\n    remaining = remaining.slice(first.index + first.match![0].length)\n  }\n\n  return segments.length <= 1 ? (segments[0] ?? '') : <>{segments}</>\n}\n\n// ─── Follow-up Suggestions ────────────────────────────────────────────\n\nfunction getFollowUps(messages: AdvisorMessage[]): string[] {\n  const last = [...messages].reverse().find(m => m.role === 'assistant')?.content.toLowerCase() || ''\n  const out: string[] = []\n\n  if (last.includes('s-corp') || last.includes('entity')) {\n    out.push('What are the S-Corp compliance costs?')\n    out.push('How do I make the S-Corp election?')\n  }\n  if (last.includes('retirement') || last.includes('401k') || last.includes('sep-ira'))\n    out.push('What\\'s my max contribution this year?')\n  if (last.includes('deduction') || last.includes('home office'))\n    out.push('What records do I need to keep?')\n  if (last.includes('quarterly') || last.includes('estimated'))\n    out.push('How much should my quarterly payments be?')\n  if (last.includes('marginal') || last.includes('bracket'))\n    out.push('Where are my rate danger zones?')\n  if (last.includes('goal') || last.includes('target'))\n    out.push('Build me a monthly action plan')\n  if (last.includes('fortuna') || last.includes('feature'))\n    out.push('Which feature should I try first?')\n\n  if (out.length < 2) {\n    out.push('What else should I know?')\n    out.push('What\\'s the single most impactful thing I should do next?')\n  }\n  return out.slice(0, 3)\n}\n\n// ─── Fallback Response ────────────────────────────────────────────────\n\nfunction buildFallback(taxReport: any, strategies: any[], risks: any[], healthScore: any): string {\n  return `I encountered an error connecting to the AI service, but here's what your pre-computed analysis shows:\n\n**Financial Health Score: ${healthScore.overall}/100 (Grade: ${healthScore.grade})**\n\n**Key Numbers:**\n- Gross Income: $${taxReport.grossIncome.toLocaleString()}\n- Total Tax: $${taxReport.totalTax.toLocaleString()}\n- Effective Rate: ${(taxReport.effectiveRate * 100).toFixed(1)}%\n- After-Tax Income: $${taxReport.afterTaxIncome.toLocaleString()}\n- Identified Savings: $${taxReport.identifiedSavings.toLocaleString()}\n\n**Top Strategies:**\n${strategies.slice(0, 5).map((s: any, i: number) => `${i + 1}. **${s.title}** — ${s.impactLabel} (${s.priority})\\n   ${s.description}`).join('\\n\\n')}\n\n**Key Risks:**\n${risks.slice(0, 3).map((r: any) => `- [${r.severity.toUpperCase()}] ${r.name}: ${r.description}`).join('\\n')}\n\nTry your question again in a moment. In the meantime, explore **Deduction Finder**, **Scenario Modeler**, and **Marginal Rates** views for immediate insights.`\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\AuditProfiler.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AuditTrigger' is defined but never used.","line":3,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":45,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AuditTrigger"},"fix":{"range":[116,135],"text":""},"desc":"Remove unused variable \"AuditTrigger\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AuditRiskProfile' is defined but never used.","line":3,"column":52,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":68,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AuditRiskProfile"},"fix":{"range":[135,158],"text":""},"desc":"Remove unused variable \"AuditRiskProfile\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ChevronUp' is defined but never used.","line":6,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":12,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ChevronUp"},"fix":{"range":[266,279],"text":""},"desc":"Remove unused variable \"ChevronUp\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AlertCircle' is defined but never used.","line":6,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":40,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AlertCircle"},"fix":{"range":[294,307],"text":""},"desc":"Remove unused variable \"AlertCircle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'progress' is assigned a value but never used.","line":647,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":647,"endColumn":17}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { analyzeAuditRisk, type AuditTrigger, type AuditRiskProfile } from '../engine/audit-risk'\nimport {\n  ShieldAlert, ShieldCheck, AlertTriangle, CheckCircle2, ChevronDown,\n  ChevronUp, FileText, Eye, AlertCircle, Info, Target, Gauge,\n  TrendingDown, Lock, Fingerprint, ClipboardCheck, Scale,\n  ShieldX, ShieldQuestion, ArrowRight\n} from 'lucide-react'\n\ntype Tab = 'overview' | 'triggers' | 'documentation' | 'mitigation'\n\nconst TABS: { key: Tab; label: string; icon: React.ReactNode }[] = [\n  { key: 'overview', label: 'Risk Overview', icon: <Gauge size={14} /> },\n  { key: 'triggers', label: 'Audit Triggers', icon: <AlertTriangle size={14} /> },\n  { key: 'documentation', label: 'Documentation', icon: <ClipboardCheck size={14} /> },\n  { key: 'mitigation', label: 'Mitigation Plan', icon: <ShieldCheck size={14} /> },\n]\n\nconst severityConfig: Record<string, { color: string; bg: string; label: string; icon: React.ReactNode }> = {\n  critical: { color: '#ef4444', bg: 'rgba(239,68,68,0.12)', label: 'CRITICAL', icon: <ShieldX size={14} /> },\n  high: { color: '#f59e0b', bg: 'rgba(245,158,11,0.12)', label: 'HIGH', icon: <AlertTriangle size={14} /> },\n  medium: { color: '#60a5fa', bg: 'rgba(96,165,250,0.12)', label: 'MEDIUM', icon: <ShieldQuestion size={14} /> },\n  low: { color: '#10b981', bg: 'rgba(16,185,129,0.12)', label: 'LOW', icon: <ShieldCheck size={14} /> },\n}\n\nconst categoryLabels: Record<string, { label: string; icon: React.ReactNode }> = {\n  income: { label: 'Income', icon: <Target size={13} /> },\n  deductions: { label: 'Deductions', icon: <TrendingDown size={13} /> },\n  credits: { label: 'Credits', icon: <Scale size={13} /> },\n  reporting: { label: 'Reporting', icon: <FileText size={13} /> },\n  entity: { label: 'Entity', icon: <Lock size={13} /> },\n  lifestyle: { label: 'Lifestyle', icon: <Fingerprint size={13} /> },\n}\n\nfunction pctStr(n: number): string { return `${(n * 100).toFixed(2)}%` }\n\nexport function AuditProfiler() {\n  const { state } = useFortuna()\n  const [activeTab, setActiveTab] = useState<Tab>('overview')\n  const [expandedTrigger, setExpandedTrigger] = useState<string | null>(null)\n  const [categoryFilter, setCategoryFilter] = useState<string | null>(null)\n\n  const hasData = state.incomeStreams.length > 0\n  const profile = useMemo(() => analyzeAuditRisk(state), [state])\n\n  if (!hasData) {\n    return (\n      <div className=\"view-enter\" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '50vh' }}>\n        <div style={{ textAlign: 'center', maxWidth: 400 }}>\n          <ShieldAlert size={32} color=\"var(--accent-gold)\" style={{ marginBottom: 12 }} />\n          <h2 style={{ fontFamily: 'var(--font-display)', marginBottom: 8 }}>Audit Risk Profiler</h2>\n          <p style={{ fontSize: 13, color: 'var(--text-muted)' }}>Add your financial data first to analyze IRS audit triggers and risk exposure.</p>\n        </div>\n      </div>\n    )\n  }\n\n  const riskColor = profile.overallScore >= 50 ? '#ef4444'\n    : profile.overallScore >= 35 ? '#f59e0b'\n    : profile.overallScore >= 20 ? '#60a5fa'\n    : '#10b981'\n\n  const filteredTriggers = categoryFilter\n    ? profile.triggers.filter(t => t.category === categoryFilter)\n    : profile.triggers\n\n  const triggeredTriggers = profile.triggers.filter(t => t.triggered)\n  const categories = [...new Set(profile.triggers.map(t => t.category))]\n\n  return (\n    <div className=\"view-enter\">\n      {/* Header */}\n      <div style={{ marginBottom: 20 }}>\n        <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 4 }}>\n          <h1 className=\"section-title\">Audit Risk Profiler</h1>\n          <span className=\"pill\" style={{ background: `${riskColor}18`, color: riskColor, border: `1px solid ${riskColor}33` }}>\n            <ShieldAlert size={11} /> {profile.riskLevel.replace('-', ' ').toUpperCase()}\n          </span>\n        </div>\n        <p className=\"section-subtitle\">IRS audit trigger analysis based on DIF scoring factors, published audit rates, and known examination criteria.</p>\n      </div>\n\n      {/* ── Top Stats ── */}\n      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: 12, marginBottom: 24 }}>\n        {[\n          { label: 'Risk Score', value: `${profile.overallScore}`, sub: '/100', color: riskColor, big: true },\n          { label: 'National Audit Rate', value: pctStr(profile.baselineAuditRate), sub: 'for your income level', color: 'var(--accent-blue)' },\n          { label: 'Your Adjusted Rate', value: pctStr(profile.adjustedAuditRate), sub: 'estimated with triggers', color: profile.adjustedAuditRate > profile.baselineAuditRate * 1.5 ? '#f59e0b' : 'var(--accent-emerald)' },\n          { label: 'Red Flags', value: `${profile.redFlagCount}`, sub: 'critical+high', color: profile.redFlagCount > 0 ? '#ef4444' : 'var(--accent-emerald)' },\n          { label: 'Checks Passed', value: `${profile.totalChecks - profile.triggeredCount}/${profile.totalChecks}`, sub: 'clean triggers', color: 'var(--accent-emerald)' },\n        ].map((m, i) => (\n          <div key={i} style={{\n            padding: '16px 14px', borderRadius: 14, background: 'var(--bg-elevated)',\n            border: `1px solid ${i === 0 ? `${riskColor}33` : 'var(--border-subtle)'}`,\n          }}>\n            <div style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.08em', fontWeight: 500, marginBottom: 8 }}>{m.label}</div>\n            <div style={{ display: 'flex', alignItems: 'baseline', gap: 4 }}>\n              <span style={{ fontFamily: 'var(--font-mono)', fontSize: m.big ? 28 : 20, fontWeight: 700, color: m.color }}>{m.value}</span>\n              {m.sub && <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>{m.sub}</span>}\n            </div>\n          </div>\n        ))}\n      </div>\n\n      {/* ── Tab Navigation ── */}\n      <div style={{ display: 'flex', gap: 4, marginBottom: 20, borderBottom: '1px solid var(--border-subtle)' }}>\n        {TABS.map(tab => (\n          <button key={tab.key} onClick={() => setActiveTab(tab.key)}\n            style={{\n              display: 'flex', alignItems: 'center', gap: 6,\n              padding: '10px 16px', borderRadius: '10px 10px 0 0',\n              border: 'none', borderBottom: activeTab === tab.key ? '2px solid var(--accent-gold)' : '2px solid transparent',\n              background: activeTab === tab.key ? 'var(--bg-elevated)' : 'transparent',\n              color: activeTab === tab.key ? 'var(--accent-gold)' : 'var(--text-muted)',\n              cursor: 'pointer', fontSize: 12, fontWeight: 500, fontFamily: 'var(--font-body)', transition: 'all 0.2s',\n            }}>\n            {tab.icon} {tab.label}\n          </button>\n        ))}\n      </div>\n\n      {/* ══════════════ TAB: OVERVIEW ══════════════ */}\n      {activeTab === 'overview' && (\n        <>\n          {/* Risk Gauge + Breakdown */}\n          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16, marginBottom: 20 }}>\n            {/* Gauge Card */}\n            <div className=\"card\">\n              <div className=\"card-header\"><span className=\"card-title\">Audit Risk Assessment</span></div>\n              <div className=\"card-body\" style={{ padding: '24px', textAlign: 'center' }}>\n                <RiskGauge score={profile.overallScore} color={riskColor} />\n                <div style={{ marginTop: 16, fontSize: 14, fontWeight: 500, color: riskColor }}>{profile.riskLabel}</div>\n                <div style={{ marginTop: 8, fontSize: 12, color: 'var(--text-muted)', lineHeight: 1.6, maxWidth: 360, margin: '8px auto 0' }}>\n                  Based on {profile.totalChecks} IRS audit trigger checks against your financial profile. \n                  {profile.triggeredCount > 0\n                    ? ` ${profile.triggeredCount} trigger${profile.triggeredCount > 1 ? 's' : ''} detected.`\n                    : ' No significant triggers detected.'}\n                </div>\n              </div>\n            </div>\n\n            {/* Audit Rate Comparison */}\n            <div className=\"card\">\n              <div className=\"card-header\"><span className=\"card-title\">IRS Audit Rate Comparison</span></div>\n              <div className=\"card-body\" style={{ padding: '24px' }}>\n                <div style={{ marginBottom: 20 }}>\n                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 6 }}>\n                    <span style={{ fontSize: 12, color: 'var(--text-secondary)' }}>National average (your income bracket)</span>\n                    <span style={{ fontFamily: 'var(--font-mono)', fontSize: 13, color: 'var(--accent-blue)', fontWeight: 600 }}>{pctStr(profile.baselineAuditRate)}</span>\n                  </div>\n                  <div style={{ height: 10, borderRadius: 5, background: 'var(--bg-surface)', overflow: 'hidden' }}>\n                    <div style={{\n                      width: `${Math.min(100, profile.baselineAuditRate * 400)}%`,\n                      height: '100%', borderRadius: 5,\n                      background: 'linear-gradient(90deg, #60a5fa, #3b82f6)',\n                      transition: 'width 0.6s ease',\n                    }} />\n                  </div>\n                </div>\n\n                <div style={{ marginBottom: 20 }}>\n                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 6 }}>\n                    <span style={{ fontSize: 12, color: 'var(--text-secondary)' }}>Your estimated audit probability</span>\n                    <span style={{ fontFamily: 'var(--font-mono)', fontSize: 13, color: riskColor, fontWeight: 600 }}>{pctStr(profile.adjustedAuditRate)}</span>\n                  </div>\n                  <div style={{ height: 10, borderRadius: 5, background: 'var(--bg-surface)', overflow: 'hidden' }}>\n                    <div style={{\n                      width: `${Math.min(100, profile.adjustedAuditRate * 400)}%`,\n                      height: '100%', borderRadius: 5,\n                      background: `linear-gradient(90deg, ${riskColor}, ${riskColor}cc)`,\n                      transition: 'width 0.6s ease',\n                    }} />\n                  </div>\n                </div>\n\n                <div style={{\n                  padding: 14, borderRadius: 10, background: 'var(--bg-surface)', border: '1px solid var(--border-subtle)',\n                  fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.6,\n                }}>\n                  <Info size={13} style={{ verticalAlign: 'middle', marginRight: 6, color: 'var(--accent-blue)' }} />\n                  {profile.adjustedAuditRate > profile.baselineAuditRate * 1.5\n                    ? `Your triggers push your estimated audit probability to ${(profile.adjustedAuditRate / profile.baselineAuditRate).toFixed(1)}x the national average for your income level. Focus on red-flag mitigation.`\n                    : `Your filing profile is close to the national average. Maintaining good documentation keeps you in safe territory.`}\n                </div>\n\n                {/* Risk factor breakdown */}\n                <div style={{ marginTop: 20 }}>\n                  <div style={{ fontSize: 11, fontWeight: 500, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 10 }}>\n                    Trigger Severity Distribution\n                  </div>\n                  <div style={{ display: 'flex', gap: 10, flexWrap: 'wrap' }}>\n                    {(['critical', 'high', 'medium', 'low'] as const).map(sev => {\n                      const count = profile.triggers.filter(t => t.triggered && t.severity === sev).length\n                      const cfg = severityConfig[sev]\n                      return (\n                        <div key={sev} style={{\n                          display: 'flex', alignItems: 'center', gap: 8,\n                          padding: '8px 14px', borderRadius: 10,\n                          background: count > 0 ? cfg.bg : 'var(--bg-surface)',\n                          border: `1px solid ${count > 0 ? cfg.color + '33' : 'var(--border-subtle)'}`,\n                        }}>\n                          <span style={{ color: cfg.color }}>{cfg.icon}</span>\n                          <span style={{ fontSize: 12, color: count > 0 ? cfg.color : 'var(--text-muted)', fontWeight: 600 }}>{count}</span>\n                          <span style={{ fontSize: 10, color: 'var(--text-muted)' }}>{cfg.label}</span>\n                        </div>\n                      )\n                    })}\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          {/* Top Recommendations */}\n          <div className=\"card\" style={{ marginBottom: 20 }}>\n            <div className=\"card-header\"><span className=\"card-title\">Top Recommendations</span></div>\n            <div className=\"card-body\" style={{ padding: '16px 20px' }}>\n              {profile.topRecommendations.map((rec, i) => (\n                <div key={i} style={{\n                  display: 'flex', gap: 12, alignItems: 'flex-start',\n                  padding: '12px 0',\n                  borderBottom: i < profile.topRecommendations.length - 1 ? '1px solid var(--border-subtle)' : 'none',\n                }}>\n                  <div style={{\n                    width: 24, height: 24, borderRadius: 12, flexShrink: 0,\n                    background: i === 0 && profile.redFlagCount > 0 ? 'rgba(239,68,68,0.15)' : 'var(--accent-gold-dim)',\n                    display: 'flex', alignItems: 'center', justifyContent: 'center',\n                    color: i === 0 && profile.redFlagCount > 0 ? '#ef4444' : 'var(--accent-gold)',\n                    fontSize: 11, fontWeight: 700, fontFamily: 'var(--font-mono)',\n                  }}>\n                    {i + 1}\n                  </div>\n                  <div style={{ fontSize: 13, color: 'var(--text-primary)', lineHeight: 1.5 }}>{rec}</div>\n                </div>\n              ))}\n            </div>\n          </div>\n\n          {/* Quick trigger summary */}\n          {triggeredTriggers.length > 0 && (\n            <div className=\"card\">\n              <div className=\"card-header\">\n                <span className=\"card-title\">Active Triggers at a Glance</span>\n                <button onClick={() => setActiveTab('triggers')} style={{\n                  background: 'none', border: 'none', color: 'var(--accent-gold)', cursor: 'pointer',\n                  fontSize: 11, fontFamily: 'var(--font-body)', display: 'flex', alignItems: 'center', gap: 4,\n                }}>View All <ArrowRight size={12} /></button>\n              </div>\n              <div className=\"card-body\" style={{ padding: '12px 16px' }}>\n                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))', gap: 10 }}>\n                  {triggeredTriggers.slice(0, 6).map(trigger => {\n                    const cfg = severityConfig[trigger.severity]\n                    return (\n                      <div key={trigger.id} style={{\n                        padding: '12px 14px', borderRadius: 10,\n                        background: 'var(--bg-surface)', border: `1px solid ${cfg.color}22`,\n                        display: 'flex', alignItems: 'center', gap: 10,\n                      }}>\n                        <span style={{ color: cfg.color, flexShrink: 0 }}>{cfg.icon}</span>\n                        <div style={{ minWidth: 0 }}>\n                          <div style={{ fontSize: 12, fontWeight: 500, color: 'var(--text-primary)', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{trigger.name}</div>\n                          <div style={{ fontSize: 10, color: cfg.color, fontWeight: 600 }}>{cfg.label} · Score: {trigger.riskScore}</div>\n                        </div>\n                      </div>\n                    )\n                  })}\n                </div>\n              </div>\n            </div>\n          )}\n        </>\n      )}\n\n      {/* ══════════════ TAB: TRIGGERS ══════════════ */}\n      {activeTab === 'triggers' && (\n        <>\n          {/* Category filter */}\n          <div style={{ display: 'flex', gap: 8, marginBottom: 16, flexWrap: 'wrap' }}>\n            <button onClick={() => setCategoryFilter(null)}\n              style={{\n                padding: '6px 14px', borderRadius: 8,\n                border: `1px solid ${!categoryFilter ? 'rgba(212,168,67,0.4)' : 'var(--border-subtle)'}`,\n                background: !categoryFilter ? 'var(--accent-gold-dim)' : 'var(--bg-elevated)',\n                color: !categoryFilter ? 'var(--accent-gold)' : 'var(--text-muted)',\n                cursor: 'pointer', fontSize: 11, fontFamily: 'var(--font-body)', fontWeight: 500,\n              }}>\n              All ({profile.triggers.length})\n            </button>\n            {categories.map(cat => {\n              const count = profile.triggers.filter(t => t.category === cat).length\n              const triggered = profile.triggers.filter(t => t.category === cat && t.triggered).length\n              const catInfo = categoryLabels[cat] || { label: cat, icon: <Info size={13} /> }\n              return (\n                <button key={cat} onClick={() => setCategoryFilter(categoryFilter === cat ? null : cat)}\n                  style={{\n                    padding: '6px 14px', borderRadius: 8,\n                    border: `1px solid ${categoryFilter === cat ? 'rgba(212,168,67,0.4)' : 'var(--border-subtle)'}`,\n                    background: categoryFilter === cat ? 'var(--accent-gold-dim)' : 'var(--bg-elevated)',\n                    color: categoryFilter === cat ? 'var(--accent-gold)' : 'var(--text-muted)',\n                    cursor: 'pointer', fontSize: 11, fontFamily: 'var(--font-body)', fontWeight: 500,\n                    display: 'flex', alignItems: 'center', gap: 6,\n                  }}>\n                  {catInfo.icon} {catInfo.label} ({triggered}/{count})\n                </button>\n              )\n            })}\n          </div>\n\n          {/* Trigger list */}\n          <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>\n            {filteredTriggers.map(trigger => {\n              const cfg = severityConfig[trigger.severity]\n              const isExpanded = expandedTrigger === trigger.id\n              return (\n                <div key={trigger.id} className=\"card\" style={{\n                  border: trigger.triggered ? `1px solid ${cfg.color}22` : '1px solid var(--border-subtle)',\n                  opacity: trigger.triggered ? 1 : 0.6,\n                }}>\n                  <div\n                    className=\"card-body\"\n                    style={{ padding: '16px 20px', cursor: 'pointer' }}\n                    onClick={() => setExpandedTrigger(isExpanded ? null : trigger.id)}\n                  >\n                    {/* Trigger header */}\n                    <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>\n                      <div style={{\n                        width: 36, height: 36, borderRadius: 10, flexShrink: 0,\n                        background: cfg.bg, display: 'flex', alignItems: 'center', justifyContent: 'center',\n                        color: cfg.color,\n                      }}>\n                        {cfg.icon}\n                      </div>\n                      <div style={{ flex: 1, minWidth: 0 }}>\n                        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n                          <span style={{ fontSize: 14, fontWeight: 500, color: 'var(--text-primary)' }}>{trigger.name}</span>\n                          <span style={{\n                            fontSize: 9, fontWeight: 700, padding: '2px 8px', borderRadius: 4,\n                            background: cfg.bg, color: cfg.color, letterSpacing: '0.05em',\n                          }}>\n                            {cfg.label}\n                          </span>\n                          {trigger.triggered && (\n                            <span style={{ fontSize: 9, fontWeight: 600, padding: '2px 8px', borderRadius: 4, background: 'rgba(239,68,68,0.1)', color: '#ef4444' }}>\n                              TRIGGERED\n                            </span>\n                          )}\n                        </div>\n                        <div style={{ fontSize: 12, color: 'var(--text-muted)', marginTop: 4, lineHeight: 1.5 }}>\n                          {trigger.description.length > 150 && !isExpanded\n                            ? trigger.description.substring(0, 150) + '…'\n                            : trigger.description}\n                        </div>\n                      </div>\n                      <div style={{ display: 'flex', alignItems: 'center', gap: 12, flexShrink: 0 }}>\n                        {/* Risk score bar */}\n                        <div style={{ textAlign: 'right' }}>\n                          <div style={{ fontFamily: 'var(--font-mono)', fontSize: 16, fontWeight: 700, color: cfg.color }}>{trigger.riskScore}</div>\n                          <div style={{ fontSize: 9, color: 'var(--text-muted)' }}>RISK</div>\n                        </div>\n                        <span style={{ color: 'var(--text-muted)', transition: 'transform 0.2s', transform: isExpanded ? 'rotate(180deg)' : 'none' }}>\n                          <ChevronDown size={16} />\n                        </span>\n                      </div>\n                    </div>\n\n                    {/* Expanded details */}\n                    {isExpanded && (\n                      <div style={{ marginTop: 16, paddingTop: 16, borderTop: '1px solid var(--border-subtle)' }}>\n                        {/* IRS Context */}\n                        <div style={{\n                          padding: 14, borderRadius: 10, background: 'rgba(96,165,250,0.06)',\n                          border: '1px solid rgba(96,165,250,0.15)', marginBottom: 14,\n                        }}>\n                          <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 6 }}>\n                            <Eye size={12} color=\"#60a5fa\" />\n                            <span style={{ fontSize: 10, fontWeight: 600, color: '#60a5fa', textTransform: 'uppercase', letterSpacing: '0.06em' }}>What the IRS Looks For</span>\n                          </div>\n                          <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.6 }}>{trigger.irsContext}</div>\n                        </div>\n\n                        {/* Threshold */}\n                        {trigger.threshold && (\n                          <div style={{\n                            padding: '10px 14px', borderRadius: 8, background: 'var(--bg-surface)',\n                            fontSize: 12, color: 'var(--text-secondary)', marginBottom: 14,\n                            display: 'flex', alignItems: 'center', gap: 8,\n                          }}>\n                            <Target size={13} color=\"var(--accent-gold)\" />\n                            <span style={{ fontWeight: 500, color: 'var(--accent-gold)' }}>Threshold:</span> {trigger.threshold}\n                          </div>\n                        )}\n\n                        {/* Mitigation */}\n                        <div style={{ marginBottom: 14 }}>\n                          <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 8 }}>\n                            <ShieldCheck size={12} color=\"var(--accent-emerald)\" />\n                            <span style={{ fontSize: 10, fontWeight: 600, color: 'var(--accent-emerald)', textTransform: 'uppercase', letterSpacing: '0.06em' }}>Mitigation Strategy</span>\n                          </div>\n                          <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.6 }}>{trigger.mitigation}</div>\n                        </div>\n\n                        {/* Documentation Needed */}\n                        <div>\n                          <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 8 }}>\n                            <FileText size={12} color=\"var(--accent-amber)\" />\n                            <span style={{ fontSize: 10, fontWeight: 600, color: 'var(--accent-amber)', textTransform: 'uppercase', letterSpacing: '0.06em' }}>Documentation Needed</span>\n                          </div>\n                          <div style={{ display: 'flex', flexDirection: 'column', gap: 6 }}>\n                            {trigger.documentationNeeded.map((doc, i) => (\n                              <div key={i} style={{\n                                display: 'flex', alignItems: 'flex-start', gap: 8,\n                                fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.4,\n                              }}>\n                                <div style={{\n                                  width: 18, height: 18, borderRadius: 5, flexShrink: 0, marginTop: 1,\n                                  border: '1.5px solid var(--border-medium)', display: 'flex',\n                                  alignItems: 'center', justifyContent: 'center',\n                                }}>\n                                  <span style={{ fontSize: 9, color: 'var(--text-muted)', fontFamily: 'var(--font-mono)' }}>{i + 1}</span>\n                                </div>\n                                {doc}\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              )\n            })}\n          </div>\n        </>\n      )}\n\n      {/* ══════════════ TAB: DOCUMENTATION ══════════════ */}\n      {activeTab === 'documentation' && (\n        <>\n          {/* Documentation Score */}\n          <div className=\"card\" style={{ marginBottom: 20 }}>\n            <div className=\"card-body\" style={{ padding: '28px', textAlign: 'center' }}>\n              <div style={{ fontSize: 11, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.08em', marginBottom: 12 }}>\n                Documentation Readiness Score\n              </div>\n              <div style={{\n                fontFamily: 'var(--font-mono)', fontSize: 48, fontWeight: 700,\n                color: profile.documentationScore >= 70 ? 'var(--accent-emerald)' : profile.documentationScore >= 40 ? 'var(--accent-gold)' : '#ef4444',\n              }}>\n                {profile.documentationScore}\n              </div>\n              <div style={{\n                width: '60%', height: 8, borderRadius: 4, background: 'var(--bg-surface)',\n                margin: '16px auto', overflow: 'hidden',\n              }}>\n                <div style={{\n                  width: `${profile.documentationScore}%`, height: '100%', borderRadius: 4,\n                  background: profile.documentationScore >= 70 ? 'var(--accent-emerald)' : profile.documentationScore >= 40 ? 'var(--accent-gold)' : '#ef4444',\n                  transition: 'width 0.6s ease',\n                }} />\n              </div>\n              <div style={{ fontSize: 13, color: 'var(--text-secondary)', maxWidth: 480, margin: '0 auto' }}>\n                {profile.documentationScore >= 70\n                  ? 'Good documentation posture. If audited, you likely have the records needed to defend your positions.'\n                  : profile.documentationScore >= 40\n                  ? 'Moderate documentation gaps. Some audit triggers require better records to defend your positions.'\n                  : 'Significant documentation gaps. Without proper records, triggered deductions could be disallowed entirely.'}\n              </div>\n            </div>\n          </div>\n\n          {/* Master Documentation Checklist */}\n          <div className=\"card\">\n            <div className=\"card-header\"><span className=\"card-title\">Master Documentation Checklist</span></div>\n            <div className=\"card-body\" style={{ padding: '16px 20px' }}>\n              {triggeredTriggers.map(trigger => (\n                <div key={trigger.id} style={{ marginBottom: 20 }}>\n                  <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 10 }}>\n                    <span style={{ color: severityConfig[trigger.severity].color }}>\n                      {severityConfig[trigger.severity].icon}\n                    </span>\n                    <span style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)' }}>{trigger.name}</span>\n                    <span style={{\n                      fontSize: 9, fontWeight: 600, padding: '2px 8px', borderRadius: 4,\n                      background: severityConfig[trigger.severity].bg,\n                      color: severityConfig[trigger.severity].color,\n                    }}>\n                      {severityConfig[trigger.severity].label}\n                    </span>\n                  </div>\n                  <div style={{ paddingLeft: 8, borderLeft: `2px solid ${severityConfig[trigger.severity].color}22` }}>\n                    {trigger.documentationNeeded.map((doc, i) => (\n                      <div key={i} style={{\n                        display: 'flex', alignItems: 'center', gap: 10,\n                        padding: '8px 12px', marginBottom: 4, borderRadius: 8,\n                        background: 'var(--bg-surface)',\n                        fontSize: 12, color: 'var(--text-secondary)',\n                      }}>\n                        <div style={{\n                          width: 18, height: 18, borderRadius: 5, flexShrink: 0,\n                          border: '1.5px solid var(--border-medium)',\n                          display: 'flex', alignItems: 'center', justifyContent: 'center',\n                        }} />\n                        {doc}\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              ))}\n              {triggeredTriggers.length === 0 && (\n                <div style={{ textAlign: 'center', padding: 32, color: 'var(--text-muted)', fontSize: 13 }}>\n                  <CheckCircle2 size={28} color=\"var(--accent-emerald)\" style={{ marginBottom: 8 }} />\n                  <div>No active triggers requiring documentation.</div>\n                </div>\n              )}\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* ══════════════ TAB: MITIGATION ══════════════ */}\n      {activeTab === 'mitigation' && (\n        <>\n          {/* Priority Actions */}\n          <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>\n            {triggeredTriggers\n              .filter(t => t.severity === 'critical' || t.severity === 'high')\n              .map((trigger, i) => {\n                const cfg = severityConfig[trigger.severity]\n                return (\n                  <div key={trigger.id} className=\"card\" style={{ border: `1px solid ${cfg.color}22` }}>\n                    <div className=\"card-body\" style={{ padding: '20px' }}>\n                      <div style={{ display: 'flex', alignItems: 'flex-start', gap: 14 }}>\n                        <div style={{\n                          width: 40, height: 40, borderRadius: 12, flexShrink: 0,\n                          background: cfg.bg, display: 'flex', alignItems: 'center', justifyContent: 'center',\n                          color: cfg.color, fontFamily: 'var(--font-mono)', fontSize: 14, fontWeight: 700,\n                        }}>\n                          #{i + 1}\n                        </div>\n                        <div style={{ flex: 1 }}>\n                          <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 6 }}>\n                            <span style={{ fontSize: 14, fontWeight: 600, color: 'var(--text-primary)' }}>{trigger.name}</span>\n                            <span style={{\n                              fontSize: 9, fontWeight: 700, padding: '2px 8px', borderRadius: 4,\n                              background: cfg.bg, color: cfg.color,\n                            }}>{cfg.label} PRIORITY</span>\n                          </div>\n                          <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.6, marginBottom: 12 }}>\n                            {trigger.mitigation}\n                          </div>\n                          <div style={{\n                            padding: 12, borderRadius: 10, background: 'var(--bg-surface)',\n                            border: '1px solid var(--border-subtle)',\n                          }}>\n                            <div style={{ fontSize: 10, fontWeight: 600, color: 'var(--accent-amber)', textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 8 }}>\n                              Required Documentation\n                            </div>\n                            {trigger.documentationNeeded.map((doc, j) => (\n                              <div key={j} style={{\n                                display: 'flex', alignItems: 'center', gap: 8,\n                                padding: '6px 0', fontSize: 12, color: 'var(--text-secondary)',\n                                borderBottom: j < trigger.documentationNeeded.length - 1 ? '1px solid var(--border-subtle)' : 'none',\n                              }}>\n                                <ArrowRight size={10} color=\"var(--accent-gold)\" style={{ flexShrink: 0 }} />\n                                {doc}\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                )\n              })}\n\n            {/* Medium triggers */}\n            {triggeredTriggers.filter(t => t.severity === 'medium').length > 0 && (\n              <div className=\"card\">\n                <div className=\"card-header\">\n                  <span className=\"card-title\">Secondary Concerns</span>\n                  <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>\n                    {triggeredTriggers.filter(t => t.severity === 'medium').length} items\n                  </span>\n                </div>\n                <div className=\"card-body\" style={{ padding: '12px 16px' }}>\n                  {triggeredTriggers.filter(t => t.severity === 'medium').map(trigger => (\n                    <div key={trigger.id} style={{\n                      display: 'flex', gap: 12, alignItems: 'flex-start',\n                      padding: '12px 0',\n                      borderBottom: '1px solid var(--border-subtle)',\n                    }}>\n                      <span style={{ color: '#60a5fa', marginTop: 2 }}><ShieldQuestion size={14} /></span>\n                      <div>\n                        <div style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)', marginBottom: 4 }}>{trigger.name}</div>\n                        <div style={{ fontSize: 12, color: 'var(--text-muted)', lineHeight: 1.5 }}>{trigger.mitigation}</div>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n\n            {/* Low risk items */}\n            {triggeredTriggers.filter(t => t.severity === 'low').length > 0 && (\n              <div className=\"card\">\n                <div className=\"card-header\">\n                  <span className=\"card-title\">Monitoring Items</span>\n                  <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>Low risk — maintain awareness</span>\n                </div>\n                <div className=\"card-body\" style={{ padding: '12px 16px' }}>\n                  {triggeredTriggers.filter(t => t.severity === 'low').map(trigger => (\n                    <div key={trigger.id} style={{\n                      display: 'flex', gap: 10, alignItems: 'center',\n                      padding: '10px 0',\n                      borderBottom: '1px solid var(--border-subtle)',\n                    }}>\n                      <CheckCircle2 size={14} color=\"var(--accent-emerald)\" style={{ flexShrink: 0 }} />\n                      <span style={{ fontSize: 12, color: 'var(--text-secondary)' }}>{trigger.name}</span>\n                      <span style={{ fontSize: 10, color: 'var(--text-muted)', marginLeft: 'auto', fontFamily: 'var(--font-mono)' }}>Score: {trigger.riskScore}</span>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n\n            {triggeredTriggers.length === 0 && (\n              <div style={{ textAlign: 'center', padding: 48, background: 'var(--bg-elevated)', borderRadius: 14, border: '1px dashed var(--border-medium)' }}>\n                <ShieldCheck size={32} color=\"var(--accent-emerald)\" style={{ marginBottom: 12 }} />\n                <div style={{ fontSize: 15, fontWeight: 500, color: 'var(--accent-emerald)', marginBottom: 4 }}>Clean Profile</div>\n                <div style={{ fontSize: 13, color: 'var(--text-muted)' }}>No significant audit triggers detected. Maintain current practices.</div>\n              </div>\n            )}\n          </div>\n        </>\n      )}\n    </div>\n  )\n}\n\n// ─── Risk Gauge (SVG) ──────────────────────────────────────────────\n\nfunction RiskGauge({ score, color }: { score: number; color: string }) {\n  const radius = 80\n  const strokeWidth = 14\n  const circumference = Math.PI * radius // Half circle\n  const progress = (score / 100) * circumference\n\n  // Angle for the needle (0 = left, 180 = right)\n  const needleAngle = (score / 100) * 180\n  const needleRadians = (needleAngle - 90) * (Math.PI / 180) // Adjust so 0 is left\n  const cx = 100\n  const cy = 90\n  const needleLen = radius - 20\n  const nx = cx + needleLen * Math.cos(needleRadians - Math.PI)\n  const ny = cy + needleLen * Math.sin(needleRadians - Math.PI)\n\n  return (\n    <svg width={200} height={120} viewBox=\"0 0 200 120\" style={{ margin: '0 auto', display: 'block' }}>\n      {/* Background arc */}\n      <path\n        d={`M ${cx - radius} ${cy} A ${radius} ${radius} 0 0 1 ${cx + radius} ${cy}`}\n        fill=\"none\"\n        stroke=\"var(--bg-surface)\"\n        strokeWidth={strokeWidth}\n        strokeLinecap=\"round\"\n      />\n      {/* Colored arc segments - gradient from green to red */}\n      <defs>\n        <linearGradient id=\"gaugeGrad\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"0%\">\n          <stop offset=\"0%\" stopColor=\"#10b981\" />\n          <stop offset=\"35%\" stopColor=\"#60a5fa\" />\n          <stop offset=\"60%\" stopColor=\"#f59e0b\" />\n          <stop offset=\"100%\" stopColor=\"#ef4444\" />\n        </linearGradient>\n      </defs>\n      <path\n        d={`M ${cx - radius} ${cy} A ${radius} ${radius} 0 0 1 ${cx + radius} ${cy}`}\n        fill=\"none\"\n        stroke=\"url(#gaugeGrad)\"\n        strokeWidth={strokeWidth}\n        strokeLinecap=\"round\"\n        opacity={0.3}\n      />\n      {/* Progress arc */}\n      <path\n        d={`M ${cx - radius} ${cy} A ${radius} ${radius} 0 ${score > 50 ? 1 : 0} 1 ${cx + radius * Math.cos(Math.PI - needleAngle * Math.PI / 180)} ${cy - radius * Math.sin(Math.PI - needleAngle * Math.PI / 180)}`}\n        fill=\"none\"\n        stroke={color}\n        strokeWidth={strokeWidth}\n        strokeLinecap=\"round\"\n        style={{ filter: `drop-shadow(0 0 6px ${color}66)` }}\n      />\n      {/* Needle */}\n      <circle cx={cx} cy={cy} r={6} fill={color} />\n      <line x1={cx} y1={cy} x2={nx} y2={ny} stroke={color} strokeWidth={2.5} strokeLinecap=\"round\" />\n      {/* Labels */}\n      <text x={cx - radius - 5} y={cy + 16} fontSize={9} fill=\"var(--text-muted)\" textAnchor=\"middle\" fontFamily=\"var(--font-mono)\">LOW</text>\n      <text x={cx + radius + 5} y={cy + 16} fontSize={9} fill=\"var(--text-muted)\" textAnchor=\"middle\" fontFamily=\"var(--font-mono)\">HIGH</text>\n      <text x={cx} y={cy + 4} fontSize={9} fill=\"var(--text-muted)\" textAnchor=\"middle\" fontFamily=\"var(--font-mono)\">MED</text>\n    </svg>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\AuthScreen.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\AuthScreen.tsx:34:27\n  32 |   // If API not configured after auto-detect, show manual setup\n  33 |   useEffect(() => {\n> 34 |     if (!isApiConfigured) setShowApiSetup(true)\n     |                           ^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  35 |     else setShowApiSetup(false)\n  36 |   }, [isApiConfigured])\n  37 |   ","line":34,"column":27,"nodeType":null,"endLine":34,"endColumn":42}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — Auth Screen\n * \n * Beautiful login/register gateway with API configuration\n * and offline mode fallback.\n */\n\nimport { useState, useEffect, useRef } from 'react'\nimport { useAuth, type AuthMode } from '../context/AuthContext'\nimport { testAPIConnection } from '../engine/api-client'\n\nexport function AuthScreen() {\n  const {\n    login, register, authError, isApiConfigured,\n    apiBaseUrl, setApiUrl, enableOfflineMode,\n  } = useAuth()\n  \n  const [mode, setMode] = useState<AuthMode>('login')\n  const [email, setEmail] = useState('')\n  const [password, setPassword] = useState('')\n  const [confirmPassword, setConfirmPassword] = useState('')\n  const [displayName, setDisplayName] = useState('')\n  const [isSubmitting, setIsSubmitting] = useState(false)\n  const [localError, setLocalError] = useState<string | null>(null)\n  \n  // API Setup - only if auto-detection failed\n  const [showApiSetup, setShowApiSetup] = useState(false)\n  const [apiUrl, setApiUrlInput] = useState(apiBaseUrl || '')\n  const [apiTesting, setApiTesting] = useState(false)\n  const [apiResult, setApiResult] = useState<{ connected: boolean; latency?: number; error?: string } | null>(null)\n\n  // If API not configured after auto-detect, show manual setup\n  useEffect(() => {\n    if (!isApiConfigured) setShowApiSetup(true)\n    else setShowApiSetup(false)\n  }, [isApiConfigured])\n  \n  const emailRef = useRef<HTMLInputElement>(null)\n\n  useEffect(() => {\n    if (!showApiSetup && emailRef.current) {\n      emailRef.current.focus()\n    }\n  }, [showApiSetup])\n\n  // ---- API Setup ----\n\n  const handleTestAPI = async () => {\n    if (!apiUrl.trim()) return\n    setApiTesting(true)\n    setApiResult(null)\n    \n    const result = await testAPIConnection(apiUrl.trim())\n    setApiResult(result)\n    setApiTesting(false)\n  }\n\n  const handleSaveAPI = async () => {\n    if (!apiUrl.trim()) return\n    const ok = await setApiUrl(apiUrl.trim())\n    if (ok) {\n      setShowApiSetup(false)\n    } else {\n      setApiResult({ connected: false, error: 'Could not connect to API' })\n    }\n  }\n\n  // ---- Auth Submit ----\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setLocalError(null)\n    \n    if (!email.trim() || !password.trim()) {\n      setLocalError('Please fill in all fields')\n      return\n    }\n    \n    if (mode === 'register') {\n      if (password.length < 8) {\n        setLocalError('Password must be at least 8 characters')\n        return\n      }\n      if (password !== confirmPassword) {\n        setLocalError('Passwords do not match')\n        return\n      }\n    }\n    \n    setIsSubmitting(true)\n    \n    const success = mode === 'login'\n      ? await login(email, password)\n      : await register(email, password, displayName || undefined)\n    \n    setIsSubmitting(false)\n    \n    if (!success) {\n      // Error will be in authError from context\n    }\n  }\n\n  const error = localError || authError\n\n  // ---- Styles ----\n\n  const styles = {\n    container: {\n      minHeight: '100vh',\n      display: 'flex',\n      alignItems: 'center',\n      justifyContent: 'center',\n      background: 'linear-gradient(135deg, #0a0e1a 0%, #111827 50%, #0f172a 100%)',\n      fontFamily: \"'Inter', -apple-system, BlinkMacSystemFont, sans-serif\",\n      padding: '1rem',\n    } as React.CSSProperties,\n    card: {\n      width: '100%',\n      maxWidth: '420px',\n      background: 'rgba(17, 24, 39, 0.8)',\n      border: '1px solid rgba(251, 191, 36, 0.15)',\n      borderRadius: '16px',\n      padding: '2.5rem 2rem',\n      backdropFilter: 'blur(20px)',\n      boxShadow: '0 25px 50px rgba(0, 0, 0, 0.5)',\n    } as React.CSSProperties,\n    logo: {\n      textAlign: 'center' as const,\n      marginBottom: '2rem',\n    },\n    logoIcon: {\n      fontSize: '2.5rem',\n      marginBottom: '0.5rem',\n    },\n    logoText: {\n      fontSize: '1.5rem',\n      fontWeight: 700,\n      color: '#fbbf24',\n      letterSpacing: '-0.02em',\n    },\n    logoSub: {\n      fontSize: '0.8rem',\n      color: '#9ca3af',\n      marginTop: '0.25rem',\n    },\n    label: {\n      display: 'block',\n      fontSize: '0.8rem',\n      fontWeight: 500,\n      color: '#d1d5db',\n      marginBottom: '0.4rem',\n    },\n    input: {\n      width: '100%',\n      padding: '0.7rem 0.9rem',\n      background: 'rgba(31, 41, 55, 0.8)',\n      border: '1px solid rgba(75, 85, 99, 0.5)',\n      borderRadius: '8px',\n      color: '#f3f4f6',\n      fontSize: '0.9rem',\n      outline: 'none',\n      transition: 'border-color 0.2s',\n      boxSizing: 'border-box' as const,\n    } as React.CSSProperties,\n    inputFocus: {\n      borderColor: '#fbbf24',\n    },\n    fieldGroup: {\n      marginBottom: '1rem',\n    },\n    button: {\n      width: '100%',\n      padding: '0.75rem',\n      background: 'linear-gradient(135deg, #f59e0b, #d97706)',\n      border: 'none',\n      borderRadius: '8px',\n      color: '#0a0e1a',\n      fontSize: '0.95rem',\n      fontWeight: 600,\n      cursor: 'pointer',\n      transition: 'all 0.2s',\n      marginTop: '0.5rem',\n    } as React.CSSProperties,\n    buttonDisabled: {\n      opacity: 0.6,\n      cursor: 'not-allowed',\n    },\n    secondaryButton: {\n      width: '100%',\n      padding: '0.6rem',\n      background: 'transparent',\n      border: '1px solid rgba(75, 85, 99, 0.5)',\n      borderRadius: '8px',\n      color: '#9ca3af',\n      fontSize: '0.85rem',\n      cursor: 'pointer',\n      transition: 'all 0.2s',\n      marginTop: '0.75rem',\n    } as React.CSSProperties,\n    toggleRow: {\n      textAlign: 'center' as const,\n      marginTop: '1.5rem',\n      fontSize: '0.85rem',\n      color: '#9ca3af',\n    },\n    toggleLink: {\n      color: '#fbbf24',\n      cursor: 'pointer',\n      fontWeight: 500,\n      background: 'none',\n      border: 'none',\n      fontSize: '0.85rem',\n      textDecoration: 'underline',\n    } as React.CSSProperties,\n    error: {\n      background: 'rgba(239, 68, 68, 0.1)',\n      border: '1px solid rgba(239, 68, 68, 0.3)',\n      borderRadius: '8px',\n      padding: '0.6rem 0.8rem',\n      marginBottom: '1rem',\n      fontSize: '0.8rem',\n      color: '#fca5a5',\n    },\n    success: {\n      background: 'rgba(34, 197, 94, 0.1)',\n      border: '1px solid rgba(34, 197, 94, 0.3)',\n      borderRadius: '8px',\n      padding: '0.6rem 0.8rem',\n      marginBottom: '1rem',\n      fontSize: '0.8rem',\n      color: '#86efac',\n    },\n    divider: {\n      display: 'flex',\n      alignItems: 'center',\n      gap: '0.75rem',\n      margin: '1.5rem 0',\n      fontSize: '0.75rem',\n      color: '#6b7280',\n    },\n    dividerLine: {\n      flex: 1,\n      height: '1px',\n      background: 'rgba(75, 85, 99, 0.4)',\n    },\n    apiRow: {\n      display: 'flex',\n      gap: '0.5rem',\n      marginBottom: '0.75rem',\n    },\n    apiTestButton: {\n      padding: '0.7rem 1rem',\n      background: 'rgba(251, 191, 36, 0.15)',\n      border: '1px solid rgba(251, 191, 36, 0.3)',\n      borderRadius: '8px',\n      color: '#fbbf24',\n      fontSize: '0.8rem',\n      cursor: 'pointer',\n      whiteSpace: 'nowrap' as const,\n    } as React.CSSProperties,\n  }\n\n  // ---- API Setup Screen ----\n\n  if (showApiSetup && !isApiConfigured) {\n    return (\n      <div style={styles.container}>\n        <div style={styles.card}>\n          <div style={styles.logo}>\n            <div style={styles.logoIcon}>⚡</div>\n            <div style={styles.logoText}>FORTUNA ENGINE</div>\n            <div style={styles.logoSub}>Connect Your Backend</div>\n          </div>\n\n          <p style={{ color: '#9ca3af', fontSize: '0.85rem', lineHeight: '1.5', marginBottom: '1.5rem' }}>\n            Enter your Fortuna API URL. This is where you uploaded the <code style={{ color: '#fbbf24' }}>/api/</code> files on your hosting.\n          </p>\n\n          <div style={styles.fieldGroup}>\n            <label style={styles.label}>API Base URL</label>\n            <div style={styles.apiRow}>\n              <input\n                type=\"url\"\n                placeholder=\"https://yourdomain.com/api\"\n                value={apiUrl}\n                onChange={e => setApiUrlInput(e.target.value)}\n                style={{ ...styles.input, flex: 1 }}\n              />\n              <button\n                onClick={handleTestAPI}\n                disabled={apiTesting || !apiUrl.trim()}\n                style={{ ...styles.apiTestButton, ...(apiTesting ? styles.buttonDisabled : {}) }}\n              >\n                {apiTesting ? '...' : 'Test'}\n              </button>\n            </div>\n          </div>\n\n          {apiResult && (\n            <div style={apiResult.connected ? styles.success : styles.error}>\n              {apiResult.connected \n                ? `✓ Connected! (${apiResult.latency}ms latency)`\n                : `✗ ${apiResult.error || 'Connection failed'}`\n              }\n            </div>\n          )}\n\n          <button\n            onClick={handleSaveAPI}\n            disabled={!apiResult?.connected}\n            style={{ ...styles.button, ...(apiResult?.connected ? {} : styles.buttonDisabled) }}\n          >\n            Save & Continue\n          </button>\n\n          <div style={styles.divider}>\n            <div style={styles.dividerLine} />\n            <span>or</span>\n            <div style={styles.dividerLine} />\n          </div>\n\n          <button\n            onClick={enableOfflineMode}\n            style={styles.secondaryButton}\n          >\n            Continue Without Account (Local Only)\n          </button>\n\n          <p style={{ color: '#6b7280', fontSize: '0.7rem', textAlign: 'center', marginTop: '1rem' }}>\n            Offline mode stores data in your browser only. You can connect an account later.\n          </p>\n        </div>\n      </div>\n    )\n  }\n\n  // ---- Login / Register Screen ----\n\n  return (\n    <div style={styles.container}>\n      <div style={styles.card}>\n        <div style={styles.logo}>\n          <div style={styles.logoIcon}>⚡</div>\n          <div style={styles.logoText}>FORTUNA ENGINE</div>\n          <div style={styles.logoSub}>\n            {mode === 'login' ? 'Welcome Back' : 'Create Your Account'}\n          </div>\n        </div>\n\n        {error && <div style={styles.error}>{error}</div>}\n\n        <form onSubmit={handleSubmit}>\n          {mode === 'register' && (\n            <div style={styles.fieldGroup}>\n              <label style={styles.label}>Display Name (optional)</label>\n              <input\n                type=\"text\"\n                placeholder=\"How should we address you?\"\n                value={displayName}\n                onChange={e => setDisplayName(e.target.value)}\n                style={styles.input}\n                autoComplete=\"name\"\n              />\n            </div>\n          )}\n\n          <div style={styles.fieldGroup}>\n            <label style={styles.label}>Email</label>\n            <input\n              ref={emailRef}\n              type=\"email\"\n              placeholder=\"you@example.com\"\n              value={email}\n              onChange={e => setEmail(e.target.value)}\n              style={styles.input}\n              autoComplete=\"email\"\n              required\n            />\n          </div>\n\n          <div style={styles.fieldGroup}>\n            <label style={styles.label}>Password</label>\n            <input\n              type=\"password\"\n              placeholder={mode === 'register' ? 'At least 8 characters' : '••••••••'}\n              value={password}\n              onChange={e => setPassword(e.target.value)}\n              style={styles.input}\n              autoComplete={mode === 'login' ? 'current-password' : 'new-password'}\n              required\n            />\n          </div>\n\n          {mode === 'register' && (\n            <div style={styles.fieldGroup}>\n              <label style={styles.label}>Confirm Password</label>\n              <input\n                type=\"password\"\n                placeholder=\"Confirm your password\"\n                value={confirmPassword}\n                onChange={e => setConfirmPassword(e.target.value)}\n                style={styles.input}\n                autoComplete=\"new-password\"\n                required\n              />\n            </div>\n          )}\n\n          <button\n            type=\"submit\"\n            disabled={isSubmitting}\n            style={{ ...styles.button, ...(isSubmitting ? styles.buttonDisabled : {}) }}\n          >\n            {isSubmitting\n              ? (mode === 'login' ? 'Signing In...' : 'Creating Account...')\n              : (mode === 'login' ? 'Sign In' : 'Create Account')\n            }\n          </button>\n        </form>\n\n        <div style={styles.toggleRow}>\n          {mode === 'login' ? (\n            <>\n              Don't have an account?{' '}\n              <button style={styles.toggleLink} onClick={() => { setMode('register'); setLocalError(null) }}>\n                Sign up\n              </button>\n            </>\n          ) : (\n            <>\n              Already have an account?{' '}\n              <button style={styles.toggleLink} onClick={() => { setMode('login'); setLocalError(null) }}>\n                Sign in\n              </button>\n            </>\n          )}\n        </div>\n\n        <div style={styles.divider}>\n          <div style={styles.dividerLine} />\n          <span>or</span>\n          <div style={styles.dividerLine} />\n        </div>\n\n        <button\n          onClick={enableOfflineMode}\n          style={styles.secondaryButton}\n        >\n          Continue Without Account\n        </button>\n\n        {isApiConfigured && (\n          <button\n            onClick={() => setShowApiSetup(true)}\n            style={{ ...styles.secondaryButton, marginTop: '0.5rem', fontSize: '0.75rem', color: '#6b7280' }}\n          >\n            ⚙ Change API URL\n          </button>\n        )}\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\Automations.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Play' is defined but never used.","line":5,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":33,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Play"},"fix":{"range":[190,196],"text":""},"desc":"Remove unused variable \"Play\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Pause' is defined but never used.","line":5,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":40,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Pause"},"fix":{"range":[196,203],"text":""},"desc":"Remove unused variable \"Pause\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AlertTriangle' is defined but never used.","line":7,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":16,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AlertTriangle"},"fix":{"range":[250,267],"text":""},"desc":"Remove unused variable \"AlertTriangle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Settings' is defined but never used.","line":7,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":26,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Settings"},"fix":{"range":[267,277],"text":""},"desc":"Remove unused variable \"Settings\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'RefreshCw' is defined but never used.","line":7,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":37,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"RefreshCw"},"fix":{"range":[277,288],"text":""},"desc":"Remove unused variable \"RefreshCw\"."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { generateTimeline } from '../engine/execution-timeline'\nimport {\n  Zap, Clock, CheckCircle2, Play, Pause,\n  Bot, DollarSign, Calendar, FileText, Shield,\n  AlertTriangle, Settings, RefreshCw, ArrowRight\n} from 'lucide-react'\n\ninterface AutomationItem {\n  id: string\n  name: string\n  description: string\n  category: string\n  status: 'active' | 'paused' | 'available'\n  frequency: string\n  impact: string\n  icon: React.ReactNode\n  automatable: boolean\n  steps: string[]\n}\n\nexport function Automations() {\n  const { state, strategies, taxReport } = useFortuna()\n  const [toggledIds, setToggledIds] = useState<Set<string>>(new Set())\n  const hasData = state.incomeStreams.length > 0\n\n  const timeline = useMemo(() => generateTimeline(state), [state])\n\n  // Build automation items from real strategies and timeline\n  const automations: AutomationItem[] = useMemo(() => {\n    const items: AutomationItem[] = []\n\n    // Quarterly tax payments\n    if (taxReport.totalTax > 1000) {\n      const quarterly = Math.round(taxReport.totalTax / 4)\n      items.push({\n        id: 'auto-estimated-tax',\n        name: 'Quarterly Estimated Tax',\n        description: `Auto-calculate and remind for quarterly payments of ~$${quarterly.toLocaleString()} via IRS Direct Pay.`,\n        category: 'Compliance',\n        status: 'available',\n        frequency: 'Quarterly',\n        impact: `$${quarterly.toLocaleString()} per quarter`,\n        icon: <Calendar size={18} />,\n        automatable: true,\n        steps: ['Calculate quarterly amount from projected annual tax', 'Set reminders 7 days before each deadline', 'Generate Form 1040-ES worksheet', 'Track payments against projected liability'],\n      })\n    }\n\n    // Mileage tracking\n    const vehicleStrat = strategies.find(s => s.id === 'vehicle-deduction')\n    if (vehicleStrat) {\n      items.push({\n        id: 'auto-mileage',\n        name: 'Business Mileage Tracker',\n        description: `Track business miles automatically. At $0.67/mile (2024 rate), this could save ${vehicleStrat.impactLabel}.`,\n        category: 'Deductions',\n        status: 'available',\n        frequency: 'Continuous',\n        impact: vehicleStrat.impactLabel,\n        icon: <DollarSign size={18} />,\n        automatable: true,\n        steps: ['Log trip start/end automatically', 'Categorize business vs personal', 'Calculate deduction at IRS standard rate', 'Generate year-end mileage report'],\n      })\n    }\n\n    // Expense categorization\n    if (state.expenses.length > 0 || state.incomeStreams.some(s => s.type === 'business')) {\n      items.push({\n        id: 'auto-expense-cat',\n        name: 'AI Expense Categorizer',\n        description: 'Automatically categorize business expenses and flag deductible items using AI classification.',\n        category: 'Bookkeeping',\n        status: 'available',\n        frequency: 'Continuous',\n        impact: 'Time savings + missed deductions',\n        icon: <Bot size={18} />,\n        automatable: true,\n        steps: ['Connect bank feed or import transactions', 'AI classifies each transaction', 'Flag unusual or non-deductible items', 'Generate categorized expense reports'],\n      })\n    }\n\n    // Tax document collection\n    items.push({\n      id: 'auto-doc-collect',\n      name: 'Tax Document Collector',\n      description: 'Track and collect all tax documents (1099s, W-2s, receipts) as they arrive. Alert on missing documents.',\n      category: 'Compliance',\n      status: 'available',\n      frequency: 'Jan-Mar annually',\n      impact: 'Prevent late filing',\n      icon: <FileText size={18} />,\n      automatable: true,\n      steps: ['Create document checklist from income streams', 'Track received vs expected documents', 'Send reminders for missing items', 'Organize for tax preparer'],\n    })\n\n    // Retirement contribution optimizer\n    const retirementStrat = strategies.find(s => s.id === 'retirement-max')\n    if (retirementStrat) {\n      items.push({\n        id: 'auto-retirement',\n        name: 'Retirement Contribution Optimizer',\n        description: `Monitor income and auto-calculate optimal retirement contributions. Gap: ${retirementStrat.impactLabel}.`,\n        category: 'Retirement',\n        status: 'available',\n        frequency: 'Monthly',\n        impact: retirementStrat.impactLabel,\n        icon: <Shield size={18} />,\n        automatable: true,\n        steps: ['Track YTD income against projections', 'Calculate optimal contribution schedule', 'Alert before contribution deadlines', 'Model tax impact of contributions'],\n      })\n    }\n\n    // Entity compliance\n    if (state.entities.some(e => e.isActive)) {\n      items.push({\n        id: 'auto-entity-compliance',\n        name: 'Entity Compliance Monitor',\n        description: 'Track annual report filings, registered agent renewals, and entity maintenance requirements.',\n        category: 'Legal',\n        status: 'available',\n        frequency: 'Annually',\n        impact: 'Prevent dissolution',\n        icon: <Shield size={18} />,\n        automatable: true,\n        steps: ['Track state filing deadlines', 'Remind before annual report due dates', 'Monitor registered agent renewal', 'Verify good standing status'],\n      })\n    }\n\n    // Deadline monitor from timeline\n    if (timeline.length > 0) {\n      const urgentCount = timeline.filter(a => a.status === 'urgent' || a.status === 'overdue').length\n      items.push({\n        id: 'auto-deadline-monitor',\n        name: 'Deadline Intelligence',\n        description: `Real-time monitoring of ${timeline.length} financial deadlines. ${urgentCount > 0 ? `${urgentCount} need immediate attention.` : 'All deadlines on track.'}`,\n        category: 'Monitoring',\n        status: 'active',\n        frequency: 'Continuous',\n        impact: `${timeline.length} deadlines tracked`,\n        icon: <Clock size={18} />,\n        automatable: true,\n        steps: ['Monitor all tax and compliance deadlines', 'Send escalating alerts as deadlines approach', 'Track completion status', 'Auto-reschedule based on extensions'],\n      })\n    }\n\n    return items\n  }, [state, strategies, taxReport, timeline])\n\n  const activeCount = automations.filter(a => toggledIds.has(a.id) || a.status === 'active').length\n  const totalImpactStrategies = strategies.filter(s => s.automatable).reduce((s, st) => s + st.estimatedImpact, 0)\n\n  if (!hasData) {\n    return (\n      <div className=\"view-enter\" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '50vh' }}>\n        <div style={{ textAlign: 'center', maxWidth: 400 }}>\n          <Zap size={32} color=\"var(--accent-gold)\" style={{ marginBottom: 12 }} />\n          <h2 style={{ fontFamily: 'var(--font-display)', marginBottom: 8 }}>Automations</h2>\n          <p style={{ fontSize: 13, color: 'var(--text-muted)' }}>Add financial data to unlock automation opportunities.</p>\n        </div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"view-enter\">\n      <div style={{ marginBottom: 28 }}>\n        <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 4 }}>\n          <h1 className=\"section-title\">Automations</h1>\n          <span className=\"pill gold\"><Zap size={11} /> Autonomous</span>\n        </div>\n        <p className=\"section-subtitle\">Engine-detected automation opportunities — reduce manual work and capture missed savings</p>\n      </div>\n\n      {/* Metrics */}\n      <div className=\"grid-4 stagger\" style={{ marginBottom: 24 }}>\n        <div className=\"metric-card\">\n          <span className=\"metric-label\">Available</span>\n          <div className=\"metric-value\" style={{ color: 'var(--accent-gold)' }}>{automations.length}</div>\n          <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>Automations detected</span>\n        </div>\n        <div className=\"metric-card\">\n          <span className=\"metric-label\">Active</span>\n          <div className=\"metric-value\" style={{ color: 'var(--accent-emerald)' }}>{activeCount}</div>\n          <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>Currently running</span>\n        </div>\n        <div className=\"metric-card\">\n          <span className=\"metric-label\">Automatable Savings</span>\n          <div className=\"metric-value\" style={{ color: 'var(--accent-emerald)' }}>${totalImpactStrategies.toLocaleString()}</div>\n          <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>From automatable strategies</span>\n        </div>\n        <div className=\"metric-card\">\n          <span className=\"metric-label\">Deadlines Tracked</span>\n          <div className=\"metric-value\" style={{ color: 'var(--accent-blue)' }}>{timeline.length}</div>\n          <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>Via Execution Timeline</span>\n        </div>\n      </div>\n\n      {/* Automation Cards */}\n      <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>\n        {automations.map(auto => (\n          <AutoCard key={auto.id} auto={auto} isActive={toggledIds.has(auto.id) || auto.status === 'active'}\n            onToggle={() => {\n              setToggledIds(prev => {\n                const next = new Set(prev)\n                if (next.has(auto.id)) next.delete(auto.id)\n                else next.add(auto.id)\n                return next\n              })\n            }}\n          />\n        ))}\n      </div>\n    </div>\n  )\n}\n\nfunction AutoCard({ auto, isActive, onToggle }: { auto: AutomationItem; isActive: boolean; onToggle: () => void }) {\n  const [expanded, setExpanded] = useState(false)\n\n  return (\n    <div className=\"card\" style={{\n      borderColor: isActive ? 'rgba(52,211,153,0.2)' : 'var(--border-subtle)',\n    }}>\n      <div style={{ padding: '18px 22px', display: 'flex', alignItems: 'center', gap: 16 }}>\n        <div style={{\n          width: 42, height: 42, borderRadius: 10,\n          background: isActive ? 'var(--accent-emerald-dim)' : 'var(--bg-surface)',\n          display: 'flex', alignItems: 'center', justifyContent: 'center',\n          color: isActive ? 'var(--accent-emerald)' : 'var(--text-muted)',\n          flexShrink: 0,\n        }}>{auto.icon}</div>\n\n        <div style={{ flex: 1, minWidth: 0 }}>\n          <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4, flexWrap: 'wrap' }}>\n            <span style={{ fontSize: 14, fontWeight: 500 }}>{auto.name}</span>\n            <span className=\"pill\" style={{ fontSize: 10, background: 'var(--bg-surface)', color: 'var(--text-muted)', border: '1px solid var(--border-subtle)' }}>{auto.category}</span>\n            <span className=\"pill\" style={{ fontSize: 10, background: 'var(--bg-surface)', color: 'var(--text-muted)', border: '1px solid var(--border-subtle)' }}>\n              <Clock size={9} /> {auto.frequency}\n            </span>\n          </div>\n          <div style={{ fontSize: 12, color: 'var(--text-muted)', lineHeight: 1.5 }}>{auto.description}</div>\n        </div>\n\n        <div style={{ textAlign: 'right', flexShrink: 0 }}>\n          <div style={{ fontFamily: 'var(--font-mono)', fontSize: 12, fontWeight: 500, color: 'var(--accent-emerald)', marginBottom: 4 }}>{auto.impact}</div>\n        </div>\n\n        <button onClick={onToggle} style={{\n          width: 44, height: 24, borderRadius: 12, border: 'none',\n          background: isActive ? 'var(--accent-emerald)' : 'var(--border-medium)',\n          cursor: 'pointer', position: 'relative', transition: 'background 0.2s',\n          flexShrink: 0,\n        }}>\n          <div style={{\n            width: 18, height: 18, borderRadius: 9, background: '#fff',\n            position: 'absolute', top: 3,\n            left: isActive ? 23 : 3,\n            transition: 'left 0.2s',\n          }} />\n        </button>\n\n        <button onClick={() => setExpanded(!expanded)}\n          style={{ background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', padding: 4 }}>\n          <ArrowRight size={14} style={{ transition: 'transform 0.2s', transform: expanded ? 'rotate(90deg)' : '' }} />\n        </button>\n      </div>\n\n      {expanded && (\n        <div style={{ padding: '0 22px 18px 80px', borderTop: '1px solid var(--border-subtle)', paddingTop: 16 }}>\n          <div style={{ fontSize: 12, fontWeight: 500, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 10 }}>Automation Steps</div>\n          {auto.steps.map((step, i) => (\n            <div key={i} style={{ display: 'flex', gap: 10, marginBottom: 8, alignItems: 'flex-start' }}>\n              <div style={{\n                width: 20, height: 20, borderRadius: 5, flexShrink: 0,\n                background: isActive ? 'var(--accent-emerald-dim)' : 'var(--bg-surface)',\n                border: `1px solid ${isActive ? 'rgba(52,211,153,0.2)' : 'var(--border-subtle)'}`,\n                display: 'flex', alignItems: 'center', justifyContent: 'center',\n                fontSize: 10, fontFamily: 'var(--font-mono)', color: isActive ? 'var(--accent-emerald)' : 'var(--text-muted)',\n              }}>{isActive ? <CheckCircle2 size={10} /> : i + 1}</div>\n              <span style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.5 }}>{step}</span>\n            </div>\n          ))}\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\CPAExport.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Share2' is defined but never used.","line":4,"column":82,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":88,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Share2"},"fix":{"range":[250,258],"text":""},"desc":"Remove unused variable \"Share2\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { generateCPAExport, type CPAExportPackage } from '../engine/cpa-export'\nimport { FileText, Download, Copy, CheckCircle, ChevronDown, ChevronUp, Printer, Share2 } from 'lucide-react'\n\nexport function CPAExport() {\n  const { state } = useFortuna()\n  const [copied, setCopied] = useState(false)\n  const [expandedSection, setExpandedSection] = useState<number | null>(0)\n\n  const pkg = useMemo(() => {\n    try {\n      return generateCPAExport(state)\n    } catch (err) {\n      console.error('[Fortuna] CPA Export generation failed:', err)\n      return {\n        generatedDate: new Date().toISOString(),\n        taxYear: new Date().getFullYear(),\n        clientName: state.profile?.name || 'Client',\n        filingStatus: state.profile?.filingStatus || 'single',\n        state: state.profile?.state || 'N/A',\n        sections: [{ title: 'ERROR', content: `Export generation failed: ${err instanceof Error ? err.message : 'Unknown error'}. Please add some income data first.` }],\n        rawText: 'Export generation failed. Please ensure you have income data entered.',\n      } as CPAExportPackage\n    }\n  }, [state])\n\n  const handleCopy = async () => {\n    try {\n      await navigator.clipboard.writeText(pkg.rawText)\n      setCopied(true)\n      setTimeout(() => setCopied(false), 2000)\n    } catch {\n      // Fallback\n      const ta = document.createElement('textarea')\n      ta.value = pkg.rawText\n      document.body.appendChild(ta)\n      ta.select()\n      document.execCommand('copy')\n      document.body.removeChild(ta)\n      setCopied(true)\n      setTimeout(() => setCopied(false), 2000)\n    }\n  }\n\n  const handlePrint = () => {\n    const win = window.open('', '_blank')\n    if (win) {\n      win.document.write(`\n        <html><head><title>Fortuna CPA Export - ${pkg.clientName}</title>\n        <style>\n          body { font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.6; padding: 40px; max-width: 800px; margin: 0 auto; }\n          pre { white-space: pre-wrap; word-wrap: break-word; }\n          @media print { body { padding: 20px; } }\n        </style></head>\n        <body><pre>${pkg.rawText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre></body></html>\n      `)\n      win.document.close()\n      setTimeout(() => win.print(), 300)\n    }\n  }\n\n  const handleDownload = () => {\n    const blob = new Blob([pkg.rawText], { type: 'text/plain' })\n    const url = URL.createObjectURL(blob)\n    const a = document.createElement('a')\n    a.href = url\n    a.download = `fortuna-cpa-export-${pkg.taxYear}-${new Date().toISOString().split('T')[0]}.txt`\n    document.body.appendChild(a)\n    a.click()\n    document.body.removeChild(a)\n    URL.revokeObjectURL(url)\n  }\n\n  return (\n    <div style={{ padding: 32, maxWidth: 900 }}>\n      {/* Header */}\n      <div style={{ marginBottom: 32 }}>\n        <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 8 }}>\n          <FileText size={24} style={{ color: 'var(--accent-gold)' }} />\n          <h1 style={{ fontFamily: 'var(--font-display)', fontSize: 28, color: 'var(--text-primary)', margin: 0 }}>\n            CPA Export Package\n          </h1>\n        </div>\n        <p style={{ color: 'var(--text-muted)', fontSize: 14, margin: 0 }}>\n          Professional tax preparation handoff for your CPA or accountant\n        </p>\n      </div>\n\n      {/* Info Banner */}\n      <div style={{\n        padding: 16, background: 'var(--accent-gold-dim)', borderRadius: 12,\n        border: '1px solid rgba(212,175,55,0.2)', marginBottom: 24,\n        fontSize: 13, color: 'var(--text-secondary)', lineHeight: 1.5,\n      }}>\n        This package summarizes your financial position, entity structure, tax estimates, strategy recommendations,\n        and audit risk factors. Share it with your tax professional to streamline preparation and ensure\n        all optimization opportunities are addressed.\n      </div>\n\n      {/* Action Buttons */}\n      <div style={{ display: 'flex', gap: 10, marginBottom: 24, flexWrap: 'wrap' }}>\n        <button\n          onClick={handleCopy}\n          style={{\n            display: 'flex', alignItems: 'center', gap: 8,\n            padding: '10px 20px', borderRadius: 10,\n            background: copied ? 'rgba(16,185,129,0.1)' : 'var(--accent-gold-dim)',\n            border: `1px solid ${copied ? 'rgba(16,185,129,0.3)' : 'rgba(212,175,55,0.3)'}`,\n            color: copied ? '#10b981' : 'var(--accent-gold)',\n            cursor: 'pointer', fontSize: 13, fontWeight: 600,\n            transition: 'all 0.2s',\n          }}\n        >\n          {copied ? <CheckCircle size={16} /> : <Copy size={16} />}\n          {copied ? 'Copied!' : 'Copy to Clipboard'}\n        </button>\n\n        <button\n          onClick={handleDownload}\n          style={{\n            display: 'flex', alignItems: 'center', gap: 8,\n            padding: '10px 20px', borderRadius: 10,\n            background: 'var(--bg-elevated)',\n            border: '1px solid var(--border-subtle)',\n            color: 'var(--text-secondary)',\n            cursor: 'pointer', fontSize: 13, fontWeight: 600,\n          }}\n        >\n          <Download size={16} /> Download .txt\n        </button>\n\n        <button\n          onClick={handlePrint}\n          style={{\n            display: 'flex', alignItems: 'center', gap: 8,\n            padding: '10px 20px', borderRadius: 10,\n            background: 'var(--bg-elevated)',\n            border: '1px solid var(--border-subtle)',\n            color: 'var(--text-secondary)',\n            cursor: 'pointer', fontSize: 13, fontWeight: 600,\n          }}\n        >\n          <Printer size={16} /> Print\n        </button>\n      </div>\n\n      {/* Meta */}\n      <div style={{\n        display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 12, marginBottom: 24,\n      }}>\n        {[\n          { label: 'Client', value: pkg.clientName },\n          { label: 'Tax Year', value: pkg.taxYear.toString() },\n          { label: 'Filing Status', value: pkg.filingStatus },\n          { label: 'State', value: pkg.state },\n        ].map((m, i) => (\n          <div key={i} style={{\n            padding: 14, background: 'var(--bg-elevated)', borderRadius: 10,\n            border: '1px solid var(--border-subtle)',\n          }}>\n            <div style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.05em' }}>\n              {m.label}\n            </div>\n            <div style={{ fontSize: 14, fontWeight: 600, color: 'var(--text-primary)', marginTop: 2 }}>\n              {m.value}\n            </div>\n          </div>\n        ))}\n      </div>\n\n      {/* Sections */}\n      <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>\n        {pkg.sections.map((section, i) => {\n          const isExpanded = expandedSection === i\n          return (\n            <div key={i} style={{\n              background: 'var(--bg-elevated)', borderRadius: 12,\n              border: '1px solid var(--border-subtle)', overflow: 'hidden',\n            }}>\n              <button\n                onClick={() => setExpandedSection(isExpanded ? null : i)}\n                style={{\n                  display: 'flex', alignItems: 'center', justifyContent: 'space-between',\n                  width: '100%', padding: '14px 18px',\n                  background: 'transparent', border: 'none', cursor: 'pointer',\n                }}\n              >\n                <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>\n                  <div style={{\n                    width: 24, height: 24, borderRadius: 6,\n                    background: 'var(--accent-gold-dim)', color: 'var(--accent-gold)',\n                    display: 'flex', alignItems: 'center', justifyContent: 'center',\n                    fontFamily: 'var(--font-mono)', fontSize: 11, fontWeight: 700,\n                  }}>\n                    {i + 1}\n                  </div>\n                  <div style={{ fontSize: 13, fontWeight: 700, color: 'var(--text-primary)', textAlign: 'left' }}>\n                    {section.title}\n                  </div>\n                </div>\n                {isExpanded ? <ChevronUp size={16} style={{ color: 'var(--text-muted)' }} /> : <ChevronDown size={16} style={{ color: 'var(--text-muted)' }} />}\n              </button>\n\n              {isExpanded && (\n                <div style={{\n                  padding: '0 18px 18px', borderTop: '1px solid var(--border-subtle)',\n                }}>\n                  <pre style={{\n                    fontFamily: 'var(--font-mono)', fontSize: 11, lineHeight: 1.6,\n                    color: 'var(--text-secondary)', whiteSpace: 'pre-wrap', wordWrap: 'break-word',\n                    margin: '12px 0 0', padding: 16, background: 'var(--bg-primary)',\n                    borderRadius: 8, overflow: 'auto',\n                  }}>\n                    {section.content}\n                  </pre>\n                </div>\n              )}\n            </div>\n          )\n        })}\n      </div>\n\n      {/* Full Preview Toggle */}\n      <details style={{ marginTop: 24 }}>\n        <summary style={{\n          cursor: 'pointer', fontSize: 13, color: 'var(--text-muted)', fontWeight: 600,\n          padding: '10px 0',\n        }}>\n          View Full Raw Export\n        </summary>\n        <pre style={{\n          fontFamily: 'var(--font-mono)', fontSize: 10, lineHeight: 1.5,\n          color: 'var(--text-secondary)', whiteSpace: 'pre-wrap', wordWrap: 'break-word',\n          padding: 20, background: 'var(--bg-elevated)', borderRadius: 12,\n          border: '1px solid var(--border-subtle)', maxHeight: 600, overflow: 'auto',\n        }}>\n          {pkg.rawText}\n        </pre>\n      </details>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\CashFlow.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'CashFlowSummary' is defined but never used.","line":3,"column":54,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":69,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CashFlowSummary"},"fix":{"range":[137,159],"text":""},"desc":"Remove unused variable \"CashFlowSummary\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BarChart' is defined but never used.","line":9,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":28,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"BarChart"},"fix":{"range":[379,389],"text":""},"desc":"Remove unused variable \"BarChart\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Legend' is defined but never used.","line":10,"column":83,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":89,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Legend"},"fix":{"range":[497,505],"text":""},"desc":"Remove unused variable \"Legend\"."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { generateCashFlow, type CashFlowConfig, type CashFlowSummary } from '../engine/cash-flow'\nimport {\n  Wallet, TrendingUp, TrendingDown, Calendar, AlertTriangle,\n  DollarSign, PiggyBank, Activity, ArrowUpRight, ArrowDownRight, Shield\n} from 'lucide-react'\nimport {\n  AreaChart, Area, BarChart, Bar, ComposedChart, Line,\n  XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell, ReferenceLine, Legend\n} from 'recharts'\n\nfunction fmt(n: number): string { return `$${Math.round(n).toLocaleString()}` }\n\nconst PATTERNS: Record<string, { label: string; color: string }> = {\n  stable: { label: 'Stable', color: '#10b981' },\n  growth: { label: 'Growth', color: '#d4a843' },\n  cyclical: { label: 'Cyclical', color: '#60a5fa' },\n  decline: { label: 'Declining', color: '#ef4444' },\n}\n\nexport function CashFlow() {\n  const { state, taxReport } = useFortuna()\n  const hasData = state.incomeStreams.length > 0\n\n  // Config state\n  const [projMonths, setProjMonths] = useState(12)\n  const [startingCash, setStartingCash] = useState(10000)\n  const [growthRate, setGrowthRate] = useState(2)\n  const [seasonality, setSeasonality] = useState<'none' | 'mild' | 'moderate' | 'strong'>('mild')\n  const [personalExp, setPersonalExp] = useState(3000)\n  const [retirementPct, setRetirementPct] = useState(10)\n\n  const config: CashFlowConfig = useMemo(() => ({\n    projectionMonths: projMonths,\n    startingCash,\n    growthRate,\n    seasonality,\n    personalMonthlyExpenses: personalExp,\n    retirementPct,\n  }), [projMonths, startingCash, growthRate, seasonality, personalExp, retirementPct])\n\n  const cashFlow = useMemo(() => generateCashFlow(state, config), [state, config])\n\n  // Chart data\n  const flowChartData = cashFlow.months.map(m => ({\n    name: m.label,\n    income: m.grossIncome,\n    bizExpenses: -m.businessExpenses,\n    personalExp: -m.personalExpenses,\n    retirement: -m.retirementContribution,\n    w2Withholding: -m.w2Withholding,\n    taxPayment: -m.estimatedTaxPayment,\n    net: m.netCashFlow,\n    cumulative: m.cumulativeCash,\n    isQTax: m.isQuarterlyPaymentMonth,\n  }))\n\n  const cumulativeData = cashFlow.months.map(m => ({\n    name: m.label,\n    cash: m.cumulativeCash,\n    runway: m.monthsOfRunway,\n  }))\n\n  const pattern = PATTERNS[cashFlow.seasonalPattern]\n\n  if (!hasData) {\n    return (\n      <div className=\"view-enter\" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '50vh' }}>\n        <div style={{ textAlign: 'center', maxWidth: 400 }}>\n          <Wallet size={32} color=\"var(--accent-gold)\" style={{ marginBottom: 12 }} />\n          <h2 style={{ fontFamily: 'var(--font-display)', marginBottom: 8 }}>Cash Flow Forecaster</h2>\n          <p style={{ fontSize: 13, color: 'var(--text-muted)' }}>Add income and expenses first to project cash flow.</p>\n        </div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"view-enter\">\n      {/* Header */}\n      <div style={{ marginBottom: 28 }}>\n        <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 4 }}>\n          <h1 className=\"section-title\">Cash Flow Forecaster</h1>\n          <span className=\"pill gold\"><Activity size={11} /> {projMonths}-Month Projection</span>\n          <span className=\"pill\" style={{\n            background: `${pattern.color}15`, color: pattern.color,\n            border: `1px solid ${pattern.color}30`,\n          }}>\n            {pattern.label} Pattern\n          </span>\n        </div>\n        <p className=\"section-subtitle\">Monthly cash flow projections with tax payment timing, seasonal modeling, and runway analysis</p>\n      </div>\n\n      {/* ── KPI Cards ── */}\n      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: 14, marginBottom: 24 }}>\n        <KPI\n          label=\"Avg Monthly Cash\"\n          value={fmt(cashFlow.averageMonthlyCash)}\n          icon={<DollarSign size={15} />}\n          color={cashFlow.averageMonthlyCash >= 0 ? '#10b981' : '#ef4444'}\n          sub={cashFlow.averageMonthlyCash >= 0 ? 'Positive flow' : 'Cash deficit'}\n        />\n        <KPI\n          label=\"Total Net Cash\"\n          value={fmt(cashFlow.totalNetCash)}\n          icon={cashFlow.totalNetCash >= 0 ? <ArrowUpRight size={15} /> : <ArrowDownRight size={15} />}\n          color={cashFlow.totalNetCash >= 0 ? '#10b981' : '#ef4444'}\n          sub={`Over ${projMonths} months`}\n        />\n        <KPI\n          label=\"Burn Rate\"\n          value={fmt(cashFlow.burnRate)}\n          icon={<TrendingDown size={15} />}\n          color=\"#f59e0b\"\n          sub=\"Monthly expenses\"\n        />\n        <KPI\n          label=\"Runway\"\n          value={`${Math.min(cashFlow.runwayMonths, 99)} mo`}\n          icon={<Calendar size={15} />}\n          color={cashFlow.runwayMonths >= 6 ? '#10b981' : cashFlow.runwayMonths >= 3 ? '#f59e0b' : '#ef4444'}\n          sub={cashFlow.runwayMonths >= 6 ? 'Healthy' : 'Build reserves'}\n        />\n        <KPI\n          label=\"Emergency Target\"\n          value={fmt(cashFlow.emergencyFundTarget)}\n          icon={<Shield size={15} />}\n          color=\"#60a5fa\"\n          sub=\"6-month reserve\"\n        />\n      </div>\n\n      {/* ── W-2 Withholding vs Estimated Tax ── */}\n      {cashFlow.totalW2Withheld > 0 && (\n        <div className=\"glass-card\" style={{ padding: '14px 20px', marginBottom: 20 }}>\n          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 10 }}>\n            <span style={{ fontSize: 12, color: 'var(--text-muted)', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.06em' }}>W-2 Withholding vs Estimated Tax Payments</span>\n          </div>\n          <div style={{ display: 'flex', gap: 0 }}>\n            {[\n              { label: 'W-2 Monthly', value: cashFlow.months[0]?.w2Withholding || 0, color: '#38bdf8', sub: 'Auto-withheld/mo' },\n              { label: 'W-2 Annual', value: cashFlow.totalW2Withheld, color: '#38bdf8', sub: 'Total withheld' },\n              { label: 'Est. Tax Payments', value: cashFlow.totalTaxPayments, color: '#d4a843', sub: 'Quarterly estimates' },\n              { label: 'Total Tax Coverage', value: cashFlow.totalW2Withheld + cashFlow.totalTaxPayments, color: '#10b981', sub: 'All sources' },\n            ].map((item, i, arr) => (\n              <div key={i} style={{ flex: 1, textAlign: 'center', padding: '0 12px', borderRight: i < arr.length - 1 ? '1px solid var(--border-subtle)' : 'none' }}>\n                <div style={{ fontSize: 10, color: 'var(--text-muted)', marginBottom: 4 }}>{item.label}</div>\n                <div style={{ fontFamily: 'var(--font-mono)', fontSize: 15, fontWeight: 600, color: item.color }}>{fmt(item.value)}</div>\n                <div style={{ fontSize: 9, color: 'var(--text-muted)', marginTop: 2 }}>{item.sub}</div>\n              </div>\n            ))}\n          </div>\n          <div style={{ marginTop: 8, fontSize: 11, color: 'var(--text-muted)', padding: '4px 0' }}>\n            💡 W-2 withholding covers tax automatically each paycheck. Quarterly estimated payments are only needed for non-W-2 income (SE, rental, investment).\n          </div>\n        </div>\n      )}\n\n      {/* ── Config Sliders ── */}\n      <div className=\"card\" style={{ marginBottom: 24, padding: '18px 24px' }}>\n        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(6, 1fr)', gap: 16, alignItems: 'center' }}>\n          <SliderControl label=\"Starting Cash\" value={startingCash} min={0} max={200000} step={1000} unit=\"$\" onChange={setStartingCash} />\n          <SliderControl label=\"Growth Rate\" value={growthRate} min={-5} max={20} step={0.5} unit=\"%\" onChange={setGrowthRate} />\n          <SliderControl label=\"Personal Expenses\" value={personalExp} min={0} max={20000} step={250} unit=\"$/mo\" onChange={setPersonalExp} />\n          <SliderControl label=\"Retirement %\" value={retirementPct} min={0} max={30} step={1} unit=\"%\" onChange={setRetirementPct} />\n          <SliderControl label=\"Months\" value={projMonths} min={6} max={24} step={1} unit=\"mo\" onChange={setProjMonths} />\n          <div>\n            <div style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 6 }}>Seasonality</div>\n            <div style={{ display: 'flex', gap: 4 }}>\n              {(['none', 'mild', 'moderate', 'strong'] as const).map(s => (\n                <button key={s} onClick={() => setSeasonality(s)} style={{\n                  padding: '4px 8px', borderRadius: 6, border: 'none', cursor: 'pointer',\n                  fontSize: 10, fontWeight: 500, fontFamily: 'var(--font-body)',\n                  background: seasonality === s ? 'var(--accent-gold)' : 'var(--bg-surface)',\n                  color: seasonality === s ? '#0c0e12' : 'var(--text-muted)',\n                  transition: 'all 0.2s',\n                }}>{s}</button>\n              ))}\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* ── Main Chart: Cash Flow Waterfall ── */}\n      <div className=\"card\" style={{ marginBottom: 24 }}>\n        <div style={{ padding: '18px 24px 8px', borderBottom: '1px solid var(--border-subtle)' }}>\n          <div style={{ fontSize: 14, fontWeight: 600, color: 'var(--text-primary)', fontFamily: 'var(--font-display)' }}>\n            Monthly Cash Flow\n          </div>\n          <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 2 }}>\n            Income vs expenses with quarterly tax payments highlighted\n          </div>\n        </div>\n        <div style={{ padding: '16px 16px 8px' }}>\n          <ResponsiveContainer width=\"100%\" height={300}>\n            <ComposedChart data={flowChartData}>\n              <CartesianGrid strokeDasharray=\"3 3\" stroke=\"rgba(255,255,255,0.04)\" />\n              <XAxis dataKey=\"name\" tick={{ fill: '#6b7280', fontSize: 10 }} />\n              <YAxis tick={{ fill: '#6b7280', fontSize: 10 }} tickFormatter={v => `$${(v / 1000).toFixed(0)}k`} />\n              <Tooltip\n                contentStyle={{ background: '#1a1d24', border: '1px solid rgba(255,255,255,0.1)', borderRadius: 10, fontSize: 12 }}\n                formatter={(value: number, name: string) => {\n                  const labels: Record<string, string> = {\n                    income: 'Income', bizExpenses: 'Business Exp', personalExp: 'Personal Exp',\n                    retirement: 'Retirement', w2Withholding: 'W-2 Withholding', taxPayment: 'Est. Tax Payment', net: 'Net Cash Flow',\n                  }\n                  return [fmt(Math.abs(value)), labels[name] || name]\n                }}\n              />\n              <Bar dataKey=\"income\" stackId=\"pos\" fill=\"#10b981\" opacity={0.7} radius={[2, 2, 0, 0]} />\n              <Bar dataKey=\"bizExpenses\" stackId=\"neg\" fill=\"#ef4444\" opacity={0.5} radius={[0, 0, 2, 2]} />\n              <Bar dataKey=\"personalExp\" stackId=\"neg\" fill=\"#f97316\" opacity={0.5} />\n              <Bar dataKey=\"retirement\" stackId=\"neg\" fill=\"#a78bfa\" opacity={0.5} />\n              <Bar dataKey=\"w2Withholding\" stackId=\"neg\" fill=\"#38bdf8\" opacity={0.6} />\n              <Bar dataKey=\"taxPayment\" stackId=\"neg\" fill=\"#d4a843\" opacity={0.8}>\n                {flowChartData.map((entry, i) => (\n                  <Cell key={i} fill={entry.isQTax ? '#d4a843' : '#d4a84340'} />\n                ))}\n              </Bar>\n              <Line type=\"monotone\" dataKey=\"net\" stroke=\"#60a5fa\" strokeWidth={2} dot={{ r: 3, fill: '#60a5fa' }} />\n              <ReferenceLine y={0} stroke=\"rgba(255,255,255,0.15)\" strokeDasharray=\"4 4\" />\n            </ComposedChart>\n          </ResponsiveContainer>\n          {/* Legend */}\n          <div style={{ display: 'flex', gap: 16, justifyContent: 'center', marginTop: 8, marginBottom: 4 }}>\n            {[\n              { label: 'Income', color: '#10b981' },\n              { label: 'Business', color: '#ef4444' },\n              { label: 'Personal', color: '#f97316' },\n              { label: 'Retirement', color: '#a78bfa' },\n              { label: 'W-2 Withholding', color: '#38bdf8' },\n              { label: 'Est. Tax', color: '#d4a843' },\n              { label: 'Net Flow', color: '#60a5fa' },\n            ].map(l => (\n              <div key={l.label} style={{ display: 'flex', alignItems: 'center', gap: 5, fontSize: 10, color: 'var(--text-muted)' }}>\n                <div style={{ width: 8, height: 8, borderRadius: 2, background: l.color }} />\n                {l.label}\n              </div>\n            ))}\n          </div>\n        </div>\n      </div>\n\n      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 20, marginBottom: 24 }}>\n        {/* ── Cumulative Cash Chart ── */}\n        <div className=\"card\">\n          <div style={{ padding: '18px 24px 8px', borderBottom: '1px solid var(--border-subtle)' }}>\n            <div style={{ fontSize: 14, fontWeight: 600, color: 'var(--text-primary)', fontFamily: 'var(--font-display)' }}>\n              Cumulative Cash Position\n            </div>\n          </div>\n          <div style={{ padding: '16px 16px 8px' }}>\n            <ResponsiveContainer width=\"100%\" height={220}>\n              <AreaChart data={cumulativeData}>\n                <defs>\n                  <linearGradient id=\"cashGrad\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n                    <stop offset=\"5%\" stopColor=\"#10b981\" stopOpacity={0.3} />\n                    <stop offset=\"95%\" stopColor=\"#10b981\" stopOpacity={0} />\n                  </linearGradient>\n                </defs>\n                <CartesianGrid strokeDasharray=\"3 3\" stroke=\"rgba(255,255,255,0.04)\" />\n                <XAxis dataKey=\"name\" tick={{ fill: '#6b7280', fontSize: 10 }} />\n                <YAxis tick={{ fill: '#6b7280', fontSize: 10 }} tickFormatter={v => `$${(v / 1000).toFixed(0)}k`} />\n                <Tooltip\n                  contentStyle={{ background: '#1a1d24', border: '1px solid rgba(255,255,255,0.1)', borderRadius: 10, fontSize: 12 }}\n                  formatter={(v: number) => [fmt(v), 'Cash']}\n                />\n                <Area type=\"monotone\" dataKey=\"cash\" stroke=\"#10b981\" fill=\"url(#cashGrad)\" strokeWidth={2} />\n                <ReferenceLine y={cashFlow.emergencyFundTarget} stroke=\"#60a5fa\" strokeDasharray=\"6 3\" label={{ value: '6mo Reserve', fill: '#60a5fa', fontSize: 10 }} />\n                <ReferenceLine y={cashFlow.cashReserveRecommendation} stroke=\"#f59e0b\" strokeDasharray=\"6 3\" label={{ value: '3mo Reserve', fill: '#f59e0b', fontSize: 10 }} />\n              </AreaChart>\n            </ResponsiveContainer>\n          </div>\n        </div>\n\n        {/* ── Runway Gauge ── */}\n        <div className=\"card\">\n          <div style={{ padding: '18px 24px 8px', borderBottom: '1px solid var(--border-subtle)' }}>\n            <div style={{ fontSize: 14, fontWeight: 600, color: 'var(--text-primary)', fontFamily: 'var(--font-display)' }}>\n              Runway & Reserve Analysis\n            </div>\n          </div>\n          <div style={{ padding: 20 }}>\n            {/* Runway gauge */}\n            <div style={{ display: 'flex', alignItems: 'center', gap: 20, marginBottom: 20 }}>\n              <div style={{\n                width: 80, height: 80, borderRadius: '50%',\n                border: `4px solid ${cashFlow.runwayMonths >= 6 ? '#10b981' : cashFlow.runwayMonths >= 3 ? '#f59e0b' : '#ef4444'}`,\n                display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center',\n              }}>\n                <div style={{ fontFamily: 'var(--font-mono)', fontSize: 24, fontWeight: 700, color: cashFlow.runwayMonths >= 6 ? '#10b981' : cashFlow.runwayMonths >= 3 ? '#f59e0b' : '#ef4444' }}>\n                  {Math.min(cashFlow.runwayMonths, 99)}\n                </div>\n                <div style={{ fontSize: 8, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.08em' }}>months</div>\n              </div>\n              <div>\n                <div style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)', marginBottom: 4 }}>\n                  {cashFlow.runwayMonths >= 12 ? 'Strong Runway' : cashFlow.runwayMonths >= 6 ? 'Adequate Runway' : cashFlow.runwayMonths >= 3 ? 'Limited Runway' : 'Critical — Build Reserves'}\n                </div>\n                <div style={{ fontSize: 12, color: 'var(--text-muted)', lineHeight: 1.5 }}>\n                  At current burn rate of {fmt(cashFlow.burnRate)}/mo, starting cash of {fmt(startingCash)} provides {Math.min(cashFlow.runwayMonths, 99)} months of coverage.\n                </div>\n              </div>\n            </div>\n\n            {/* Reserve targets */}\n            <div style={{ display: 'grid', gap: 10 }}>\n              <ReserveBar label=\"3-Month Reserve\" target={cashFlow.cashReserveRecommendation} current={startingCash} color=\"#f59e0b\" />\n              <ReserveBar label=\"6-Month Emergency\" target={cashFlow.emergencyFundTarget} current={startingCash} color=\"#60a5fa\" />\n              <ReserveBar label=\"12-Month Safety\" target={cashFlow.burnRate * 12} current={startingCash} color=\"#a78bfa\" />\n            </div>\n\n            {/* Quarterly tax calendar */}\n            <div style={{ marginTop: 16, padding: '12px 14px', background: 'var(--accent-gold-dim)', borderRadius: 10, border: '1px solid rgba(212,168,67,0.2)' }}>\n              <div style={{ fontSize: 10, color: 'var(--accent-gold)', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 8 }}>\n                Quarterly Tax Payments\n              </div>\n              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 6 }}>\n                {cashFlow.months.filter(m => m.isQuarterlyPaymentMonth).slice(0, 4).map(m => (\n                  <div key={m.label} style={{ display: 'flex', justifyContent: 'space-between', fontSize: 11 }}>\n                    <span style={{ color: 'var(--text-muted)' }}>{m.label}</span>\n                    <span style={{ fontFamily: 'var(--font-mono)', color: 'var(--accent-gold)', fontWeight: 500 }}>{fmt(m.estimatedTaxPayment)}</span>\n                  </div>\n                ))}\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* ── Monthly Breakdown Table ── */}\n      <div className=\"card\" style={{ marginBottom: 24 }}>\n        <div style={{ padding: '18px 24px 8px', borderBottom: '1px solid var(--border-subtle)' }}>\n          <div style={{ fontSize: 14, fontWeight: 600, color: 'var(--text-primary)', fontFamily: 'var(--font-display)' }}>\n            Monthly Breakdown\n          </div>\n        </div>\n        <div style={{ overflowX: 'auto' }}>\n          <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 11, fontFamily: 'var(--font-mono)' }}>\n            <thead>\n              <tr style={{ borderBottom: '1px solid var(--border-subtle)' }}>\n                {['Month', 'Income', 'Biz Exp', 'Personal', 'Retire', 'Tax Pmt', 'Net Flow', 'Cumulative', 'Runway'].map(h => (\n                  <th key={h} style={{ padding: '10px 12px', textAlign: 'right', fontSize: 10, color: 'var(--text-muted)', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.05em' }}>\n                    {h}\n                  </th>\n                ))}\n              </tr>\n            </thead>\n            <tbody>\n              {cashFlow.months.map((m, i) => (\n                <tr key={i} style={{\n                  borderBottom: '1px solid var(--border-subtle)',\n                  background: m.isQuarterlyPaymentMonth ? 'rgba(212,168,67,0.04)' : 'transparent',\n                }}>\n                  <td style={{ padding: '8px 12px', textAlign: 'right', color: 'var(--text-primary)', fontWeight: 500 }}>\n                    {m.label} {m.isQuarterlyPaymentMonth && <span style={{ color: '#d4a843', fontSize: 9 }}>TAX</span>}\n                  </td>\n                  <td style={{ padding: '8px 12px', textAlign: 'right', color: '#10b981' }}>{fmt(m.grossIncome)}</td>\n                  <td style={{ padding: '8px 12px', textAlign: 'right', color: '#ef4444' }}>{fmt(m.businessExpenses)}</td>\n                  <td style={{ padding: '8px 12px', textAlign: 'right', color: '#f97316' }}>{fmt(m.personalExpenses)}</td>\n                  <td style={{ padding: '8px 12px', textAlign: 'right', color: '#a78bfa' }}>{fmt(m.retirementContribution)}</td>\n                  <td style={{ padding: '8px 12px', textAlign: 'right', color: m.estimatedTaxPayment > 0 ? '#d4a843' : 'var(--text-muted)' }}>\n                    {m.estimatedTaxPayment > 0 ? fmt(m.estimatedTaxPayment) : '—'}\n                  </td>\n                  <td style={{ padding: '8px 12px', textAlign: 'right', color: m.netCashFlow >= 0 ? '#10b981' : '#ef4444', fontWeight: 600 }}>\n                    {m.netCashFlow >= 0 ? '+' : ''}{fmt(m.netCashFlow)}\n                  </td>\n                  <td style={{ padding: '8px 12px', textAlign: 'right', color: m.cumulativeCash >= 0 ? 'var(--text-primary)' : '#ef4444', fontWeight: 500 }}>\n                    {fmt(m.cumulativeCash)}\n                  </td>\n                  <td style={{ padding: '8px 12px', textAlign: 'right', color: m.monthsOfRunway >= 6 ? '#10b981' : m.monthsOfRunway >= 3 ? '#f59e0b' : '#ef4444' }}>\n                    {m.monthsOfRunway}mo\n                  </td>\n                </tr>\n              ))}\n            </tbody>\n          </table>\n        </div>\n      </div>\n\n      {/* ── Insights ── */}\n      <div className=\"card\" style={{ padding: 20, marginBottom: 24 }}>\n        <div style={{ fontSize: 12, fontWeight: 600, color: 'var(--accent-gold)', textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 12 }}>\n          Cash Flow Insights\n        </div>\n        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.6 }}>\n          <InsightItem\n            icon={cashFlow.averageMonthlyCash >= 0 ? <TrendingUp size={13} color=\"#10b981\" /> : <TrendingDown size={13} color=\"#ef4444\" />}\n            text={`Average monthly net cash flow: ${fmt(cashFlow.averageMonthlyCash)}.${cashFlow.averageMonthlyCash > 0 ? \" You\\u2019re building wealth each month.\" : \" Consider reducing expenses or increasing revenue.\"}`}\n          />\n          <InsightItem\n            icon={<Calendar size={13} color=\"#d4a843\" />}\n            text={`Quarterly tax payments of ~${fmt(Math.round(taxReport.totalTax / 4))} are due in Apr, Jun, Sep, and Jan. These are your biggest cash flow events.`}\n          />\n          <InsightItem\n            icon={<AlertTriangle size={13} color=\"#f59e0b\" />}\n            text={`Tightest month: ${cashFlow.lowestCashMonth.label} (${fmt(cashFlow.lowestCashMonth.netCashFlow)} net). ${cashFlow.monthsNegative > 0 ? `${cashFlow.monthsNegative} month(s) projected negative.` : 'No negative months projected.'}`}\n          />\n          <InsightItem\n            icon={<PiggyBank size={13} color=\"#a78bfa\" />}\n            text={`Emergency fund target: ${fmt(cashFlow.emergencyFundTarget)} (6 months of expenses). ${startingCash >= cashFlow.emergencyFundTarget ? 'You meet this target.' : `You need ${fmt(cashFlow.emergencyFundTarget - startingCash)} more.`}`}\n          />\n        </div>\n      </div>\n    </div>\n  )\n}\n\n// ─── Sub-components ──────────────────────────────────────────────\n\nfunction KPI({ label, value, icon, color, sub }: { label: string; value: string; icon: React.ReactNode; color: string; sub: string }) {\n  return (\n    <div className=\"metric-card\" style={{ borderColor: `${color}22` }}>\n      <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 6 }}>\n        <span style={{ color }}>{icon}</span>\n        <span className=\"metric-label\">{label}</span>\n      </div>\n      <div className=\"metric-value\" style={{ color, fontSize: 20 }}>{value}</div>\n      <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 2 }}>{sub}</div>\n    </div>\n  )\n}\n\nfunction SliderControl({ label, value, min, max, step, unit, onChange }: {\n  label: string; value: number; min: number; max: number; step: number; unit: string; onChange: (v: number) => void\n}) {\n  return (\n    <div>\n      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>\n        <span style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.06em' }}>{label}</span>\n        <span style={{ fontSize: 11, fontFamily: 'var(--font-mono)', color: 'var(--accent-gold)', fontWeight: 500 }}>\n          {unit === '$' ? `$${value.toLocaleString()}` : unit === '$/mo' ? `$${value.toLocaleString()}/mo` : `${value}${unit}`}\n        </span>\n      </div>\n      <input type=\"range\" min={min} max={max} step={step} value={value} onChange={e => onChange(Number(e.target.value))}\n        style={{ width: '100%', accentColor: 'var(--accent-gold)', height: 4, cursor: 'pointer' }} />\n    </div>\n  )\n}\n\nfunction ReserveBar({ label, target, current, color }: { label: string; target: number; current: number; color: string }) {\n  const pct = Math.min(100, (current / Math.max(1, target)) * 100)\n  const met = current >= target\n  return (\n    <div>\n      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>\n        <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>{label}</span>\n        <span style={{ fontSize: 11, fontFamily: 'var(--font-mono)', color: met ? '#10b981' : color }}>\n          {`$${Math.round(current).toLocaleString()}`} / {`$${Math.round(target).toLocaleString()}`}\n        </span>\n      </div>\n      <div className=\"progress-bar\">\n        <div className=\"progress-fill\" style={{ width: `${pct}%`, background: met ? '#10b981' : color, transition: 'width 0.5s ease' }} />\n      </div>\n    </div>\n  )\n}\n\nfunction InsightItem({ icon, text }: { icon: React.ReactNode; text: string }) {\n  return (\n    <div style={{ display: 'flex', gap: 8, alignItems: 'flex-start' }}>\n      <span style={{ flexShrink: 0, marginTop: 2 }}>{icon}</span>\n      <span>{text}</span>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\Dashboard.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useEffect' is defined but never used.","line":1,"column":36,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":45,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useEffect"},"fix":{"range":[33,44],"text":""},"desc":"Remove unused variable \"useEffect\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TrendingDown' is defined but never used.","line":10,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":57,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TrendingDown"},"fix":{"range":[550,564],"text":""},"desc":"Remove unused variable \"TrendingDown\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'PiggyBank' is defined but never used.","line":11,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":12,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"PiggyBank"},"fix":{"range":[576,589],"text":""},"desc":"Remove unused variable \"PiggyBank\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Target' is defined but never used.","line":11,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":20,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Target"},"fix":{"range":[589,597],"text":""},"desc":"Remove unused variable \"Target\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Minus' is defined but never used.","line":11,"column":46,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":51,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Minus"},"fix":{"range":[621,628],"text":""},"desc":"Remove unused variable \"Minus\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'CheckCircle2' is defined but never used.","line":12,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":15,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CheckCircle2"},"fix":{"range":[628,644],"text":""},"desc":"Remove unused variable \"CheckCircle2\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Clock' is defined but never used.","line":12,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":22,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Clock"},"fix":{"range":[644,651],"text":""},"desc":"Remove unused variable \"Clock\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AlertTriangle' is defined but never used.","line":12,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":37,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AlertTriangle"},"fix":{"range":[651,666],"text":""},"desc":"Remove unused variable \"AlertTriangle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Activity' is defined but never used.","line":12,"column":47,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":55,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Activity"},"fix":{"range":[674,684],"text":""},"desc":"Remove unused variable \"Activity\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Calendar' is defined but never used.","line":13,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":22,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Calendar"},"fix":{"range":[697,707],"text":""},"desc":"Remove unused variable \"Calendar\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'MapPin' is defined but never used.","line":13,"column":46,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":52,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"MapPin"},"fix":{"range":[729,737],"text":""},"desc":"Remove unused variable \"MapPin\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ExternalLink' is defined but never used.","line":14,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":27,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ExternalLink"},"fix":{"range":[751,765],"text":""},"desc":"Remove unused variable \"ExternalLink\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Eye' is defined but never used.","line":14,"column":36,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":39,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Eye"},"fix":{"range":[772,777],"text":""},"desc":"Remove unused variable \"Eye\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Tooltip' is defined but never used.","line":18,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":52,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Tooltip"},"fix":{"range":[903,912],"text":""},"desc":"Remove unused variable \"Tooltip\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BarChart' is defined but never used.","line":20,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":11,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"BarChart"},"fix":{"range":[960,972],"text":""},"desc":"Remove unused variable \"BarChart\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Bar' is defined but never used.","line":20,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":16,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Bar"},"fix":{"range":[972,977],"text":""},"desc":"Remove unused variable \"Bar\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'XAxis' is defined but never used.","line":20,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":23,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"XAxis"},"fix":{"range":[977,984],"text":""},"desc":"Remove unused variable \"XAxis\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'YAxis' is defined but never used.","line":20,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":30,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"YAxis"},"fix":{"range":[984,991],"text":""},"desc":"Remove unused variable \"YAxis\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'risks' is assigned a value but never used.","line":71,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":71,"endColumn":46},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'milestones' is assigned a value but never used.","line":71,"column":82,"nodeType":"Identifier","messageId":"unusedVar","endLine":71,"endColumn":92},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":157,"column":85,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":157,"endColumn":88,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8507,8510],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8507,8510],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":167,"column":88,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":167,"endColumn":91,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9430,9433],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9430,9433],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":175,"column":84,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":175,"endColumn":87,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10102,10105],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10102,10105],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":193,"column":104,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":193,"endColumn":107,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11347,11350],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11347,11350],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'allWithheld' is assigned a value but never used.","line":211,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":211,"endColumn":26}],"suppressedMessages":[],"errorCount":25,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useMemo, useEffect } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { evaluateScenario, generateSmartScenarios } from '../engine/scenario-modeler'\nimport type { ViewKey } from '../App'\nimport { SessionDigestBar } from '../components/SessionDigestBar'\nimport { ProactivePulse } from '../components/ProactivePulse'\nimport { CompletionBanner } from '../components/CompletionTracker'\nimport { getPortfolioDashboardData } from '../engine/portfolio-bridge'\nimport {\n  ArrowUpRight, ArrowDownRight, TrendingUp, TrendingDown, DollarSign,\n  PiggyBank, Target, Sparkles, ChevronRight, Minus,\n  CheckCircle2, Clock, AlertTriangle, Shield, Activity,\n  BarChart3, Calendar, Building2, Bell, Zap, MapPin,\n  ArrowRight, ExternalLink, Flame, Eye, FileText,\n  History, Brain, CreditCard, Briefcase,\n} from 'lucide-react'\nimport {\n  PieChart, Pie, Cell, ResponsiveContainer, Tooltip, RadarChart,\n  PolarGrid, PolarAngleAxis, Radar,\n  BarChart, Bar, XAxis, YAxis,\n} from 'recharts'\n\ninterface DashboardProps { onNavigate: (view: ViewKey) => void }\n\nfunction fmt(n: number): string { return `$${Math.round(n).toLocaleString()}` }\n\nfunction MiniSparkline({ points, color, w = 80, h = 28 }: { points: number[]; color: string; w?: number; h?: number }) {\n  if (points.length < 2) return null\n  const min = Math.min(...points), max = Math.max(...points), range = max - min || 1\n  const path = points.map((v, i) => {\n    const x = (i / (points.length - 1)) * w\n    const y = h - ((v - min) / range) * (h - 4) - 2\n    return `${i === 0 ? 'M' : 'L'}${x},${y}`\n  }).join(' ')\n  const area = `M0,${h} ${path.replace('M', 'L')} L${w},${h} Z`\n  return (\n    <svg width={w} height={h} style={{ display: 'block' }}>\n      <defs>\n        <linearGradient id={`spark-${color.replace(/[^a-z0-9]/gi, '')}`} x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n          <stop offset=\"0%\" stopColor={color} stopOpacity=\"0.15\" />\n          <stop offset=\"100%\" stopColor={color} stopOpacity=\"0\" />\n        </linearGradient>\n      </defs>\n      <path d={area} fill={`url(#spark-${color.replace(/[^a-z0-9]/gi, '')})`} />\n      <path d={path} fill=\"none\" stroke={color} strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\n    </svg>\n  )\n}\n\nfunction getGreeting(name: string): string {\n  const hour = new Date().getHours()\n  const first = name.split(' ')[0] || 'there'\n  if (hour < 12) return `Good morning, ${first}`\n  if (hour < 17) return `Good afternoon, ${first}`\n  return `Good evening, ${first}`\n}\n\nfunction getDayContext(): string {\n  const now = new Date()\n  const month = now.getMonth(), day = now.getDate()\n  if (month === 0 && day <= 15) return 'Q4 estimated taxes due Jan 15'\n  if (month === 3 && day <= 15) return 'Tax filing deadline Apr 15'\n  if (month === 5 && day <= 15) return 'Q2 estimated taxes due Jun 15'\n  if (month === 8 && day <= 15) return 'Q3 estimated taxes due Sep 15'\n  if (month === 11) return 'Year-end tax planning window'\n  if (month >= 9) return 'Q4 optimization window open'\n  return ''\n}\n\nexport function Dashboard({ onNavigate }: DashboardProps) {\n  const { state, taxReport, strategies, risks, healthScore, trends, projections, milestones, strategyEffects, history, sessionDigest } = useFortuna()\n  const hasData = state.incomeStreams.length > 0\n  const [digestDismissed, setDigestDismissed] = useState(false)\n  const snapshotCount = history.snapshots.length\n  const incomeTrend = trends.find(t => t.metric === 'totalIncome')\n  const taxRateTrend = trends.find(t => t.metric === 'effectiveTaxRate')\n  const healthTrend = trends.find(t => t.metric === 'healthScore')\n  const netTrend = trends.find(t => t.metric === 'netIncome')\n  const criticalStrategies = strategies.filter(s => s.priority === 'critical' || s.priority === 'high')\n  const urgentCount = criticalStrategies.length\n  const dayContext = getDayContext()\n  const revenueStreams = state.incomeStreams.filter(s => s.isActive && s.annualAmount > 0).sort((a, b) => b.annualAmount - a.annualAmount)\n  const totalRevenue = revenueStreams.reduce((s, r) => s + r.annualAmount, 0)\n  const taxAllocation = [\n    { name: 'Federal Income', value: taxReport.federalIncomeTax, color: '#d4a843' },\n    { name: 'State', value: taxReport.stateTax, color: '#60a5fa' },\n    { name: 'Self-Employment', value: taxReport.selfEmploymentTax, color: '#a78bfa' },\n  ].filter(d => d.value > 0)\n  const radarData = [\n    { dimension: 'Tax Eff.', value: healthScore.components.taxEfficiency },\n    { dimension: 'Entity', value: healthScore.components.entityOptimization },\n    { dimension: 'Diverse', value: healthScore.components.diversification },\n    { dimension: 'Risk', value: healthScore.components.riskProtection },\n    { dimension: 'Retire', value: healthScore.components.retirementReadiness },\n  ]\n  const priorityColors: Record<string, string> = { critical: 'var(--accent-red)', high: 'var(--accent-gold)', medium: 'var(--accent-blue)', low: 'var(--text-muted)' }\n  const portfolioWidget = useMemo(() => getPortfolioDashboardData(), [])\n\n  if (!hasData) {\n    return (\n      <div className=\"view-enter\" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '60vh' }}>\n        <div style={{ textAlign: 'center', maxWidth: 520 }}>\n          <div className=\"animate-float\" style={{ width: 72, height: 72, borderRadius: 20, margin: '0 auto 24px', background: 'linear-gradient(135deg, var(--accent-gold), #b8912e)', display: 'flex', alignItems: 'center', justifyContent: 'center', boxShadow: '0 8px 40px rgba(212,168,67,0.3)' }}>\n            <Sparkles size={32} color=\"#0c0e12\" />\n          </div>\n          <h1 style={{ fontFamily: 'var(--font-display)', fontSize: 32, marginBottom: 12, color: 'var(--text-primary)' }}>Welcome to Fortuna Engine</h1>\n          <p style={{ fontSize: 14, color: 'var(--text-secondary)', lineHeight: 1.7, marginBottom: 32, maxWidth: 440, margin: '0 auto 32px' }}>Autonomous tax optimization, strategy detection, risk analysis, and AI-powered financial intelligence — all in one system.</p>\n          <button className=\"btn btn-primary animate-glow\" style={{ fontSize: 15, padding: '14px 28px', borderRadius: 12 }} onClick={() => onNavigate('setup')}><Sparkles size={16} /> Set Up Financial Profile</button>\n        </div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"view-enter\">\n      {/* Header */}\n      <div style={{ marginBottom: 20 }}>\n        <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 4 }}>\n          <h1 className=\"section-title\" style={{ fontSize: 26 }}>{getGreeting(state.profile.name)}</h1>\n          <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}><div className=\"pulse-dot\" style={{ background: 'var(--accent-emerald)' }} /><span style={{ fontSize: 11, color: 'var(--accent-emerald)', fontFamily: 'var(--font-mono)', fontWeight: 500 }}>LIVE</span></div>\n        </div>\n        <p className=\"section-subtitle\">\n          {snapshotCount > 0 ? `${snapshotCount} snapshots · ` : ''}{strategies.length} strategies detected · Health: {healthScore.grade}\n          {dayContext && <span style={{ color: 'var(--accent-amber)', marginLeft: 8 }}>· {dayContext}</span>}\n        </p>\n      </div>\n\n      {/* Profile completion banner */}\n      <CompletionBanner onNavigate={onNavigate} />\n\n      {/* Urgency bar */}\n      {urgentCount > 0 && (\n        <div className=\"urgency-bar warning\" style={{ cursor: 'pointer' }} onClick={() => onNavigate('alerts')}>\n          <Flame size={14} />\n          <span style={{ fontWeight: 600 }}>{urgentCount} high-priority action{urgentCount > 1 ? 's' : ''}</span>\n          <span style={{ opacity: 0.7 }}>—</span>\n          <span>{criticalStrategies[0]?.title}</span>\n          {criticalStrategies[0]?.impactLabel && <span className=\"badge amber\" style={{ marginLeft: 'auto' }}>{criticalStrategies[0].impactLabel}</span>}\n          <ChevronRight size={14} style={{ marginLeft: 4, opacity: 0.5 }} />\n        </div>\n      )}\n\n      {/* Session Intelligence Digest */}\n      {!digestDismissed && sessionDigest.items.length > 0 && (\n        <SessionDigestBar\n          digest={sessionDigest}\n          onNavigate={onNavigate}\n          onDismiss={() => setDigestDismissed(true)}\n        />\n      )}\n\n      {/* Proactive Intelligence Pulse */}\n      {hasData && <ProactivePulse onNavigate={onNavigate} />}\n\n      {/* KPI Row */}\n      <div className=\"grid-4 stagger-fast\" style={{ marginBottom: 20 }}>\n        <div className=\"kpi-card\" style={{ '--kpi-color': 'var(--accent-gold)' } as any}>\n          <div className=\"kpi-label\">Gross Income</div>\n          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-end' }}>\n            <div className=\"kpi-value\">${(taxReport.grossIncome / 1000).toFixed(0)}k</div>\n            {incomeTrend && <MiniSparkline points={incomeTrend.points.map(p => p.value)} color=\"var(--accent-gold)\" />}\n          </div>\n          <div className=\"kpi-sub\" style={{ color: incomeTrend?.isPositive ? 'var(--accent-emerald)' : incomeTrend ? 'var(--accent-red)' : 'var(--text-muted)' }}>\n            {incomeTrend ? <>{incomeTrend.direction === 'up' ? <ArrowUpRight size={12} /> : <ArrowDownRight size={12} />} {Math.abs(incomeTrend.changePct).toFixed(1)}%</> : <>{revenueStreams.length} stream{revenueStreams.length !== 1 ? 's' : ''}</>}\n          </div>\n        </div>\n        <div className=\"kpi-card\" style={{ '--kpi-color': 'var(--accent-emerald)' } as any}>\n          <div className=\"kpi-label\">After-Tax Income</div>\n          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-end' }}>\n            <div className=\"kpi-value\">${(taxReport.afterTaxIncome / 1000).toFixed(0)}k</div>\n            {netTrend && <MiniSparkline points={netTrend.points.map(p => p.value)} color=\"var(--accent-emerald)\" />}\n          </div>\n          <div className=\"kpi-sub\" style={{ color: 'var(--accent-emerald)' }}>{((taxReport.afterTaxIncome / (taxReport.grossIncome || 1)) * 100).toFixed(0)}% retention rate</div>\n        </div>\n        <div className=\"kpi-card\" style={{ '--kpi-color': 'var(--accent-red)' } as any}>\n          <div className=\"kpi-label\">Total Tax</div>\n          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-end' }}>\n            <div className=\"kpi-value\" style={{ color: 'var(--accent-red)' }}>${(taxReport.totalTax / 1000).toFixed(0)}k</div>\n            {taxRateTrend && <MiniSparkline points={taxRateTrend.points.map(p => p.value)} color=\"var(--accent-red)\" />}\n          </div>\n          <div className=\"kpi-sub\" style={{ color: 'var(--text-muted)' }}>\n            {(taxReport.effectiveRate * 100).toFixed(1)}% effective · {(taxReport.marginalRate * 100).toFixed(0)}% marginal\n            {(taxReport.w2FederalWithheld > 0 || taxReport.w2StateWithheld > 0) && (\n              <div style={{ fontSize: 10, marginTop: 2, color: taxReport.netTaxOwed <= 0 ? 'var(--accent-emerald)' : 'var(--accent-gold)' }}>\n                {taxReport.netTaxOwed <= 0\n                  ? `Refund est. $${Math.abs(taxReport.netTaxOwed).toLocaleString()}`\n                  : `Still owed ~$${taxReport.netTaxOwed.toLocaleString()}`\n                }\n              </div>\n            )}\n          </div>\n        </div>\n        <div className=\"kpi-card\" style={{ '--kpi-color': 'var(--accent-gold)', cursor: 'pointer' } as any} onClick={() => onNavigate('health')}>\n          <div className=\"kpi-label\">Health Score</div>\n          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-end' }}>\n            <div className=\"kpi-value\" style={{ color: healthScore.overall >= 70 ? 'var(--accent-emerald)' : healthScore.overall >= 50 ? 'var(--accent-gold)' : 'var(--accent-red)' }}>\n              {healthScore.overall}<span style={{ fontSize: 14, color: 'var(--text-muted)', fontWeight: 400 }}>/100</span>\n            </div>\n            {healthTrend && <MiniSparkline points={healthTrend.points.map(p => p.value)} color={healthScore.overall >= 70 ? 'var(--accent-emerald)' : 'var(--accent-gold)'} />}\n          </div>\n          <div className=\"kpi-sub\" style={{ color: healthScore.overall >= 70 ? 'var(--accent-emerald)' : 'var(--accent-gold)' }}>\n            Grade: {healthScore.grade}{healthTrend && healthTrend.direction !== 'flat' && <span style={{ marginLeft: 6 }}>{healthTrend.direction === 'up' ? <ArrowUpRight size={11} /> : <ArrowDownRight size={11} />} {Math.abs(healthTrend.change).toFixed(0)} pts</span>}\n          </div>\n        </div>\n      </div>\n\n      {/* W-2 Withholding Summary — only shows when W-2 data present */}\n      {taxReport.w2FederalWithheld > 0 && (() => {\n        const totalWithheld = taxReport.w2FederalWithheld + taxReport.w2StateWithheld\n        const ficaWithheld = taxReport.w2FICAWithheld\n        const allWithheld = totalWithheld + ficaWithheld\n        const owed = taxReport.netTaxOwed\n        const isRefund = owed <= 0\n        const w2Streams = state.incomeStreams.filter(s => s.type === 'w2' && s.isActive)\n        const w2Pretax = w2Streams.reduce((s, inc) => s + ((inc.w2?.pretax401k || 0) + (inc.w2?.pretaxHealthInsurance || 0) + (inc.w2?.pretaxHSA || 0)), 0)\n        const empMatch = w2Streams.reduce((s, inc) => s + (inc.w2?.employerMatch401k || 0), 0)\n        return (\n          <div className=\"glass-card\" style={{ padding: '14px 20px', marginBottom: 20 }}>\n            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 10 }}>\n              <span style={{ fontSize: 12, color: 'var(--text-muted)', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.06em', display: 'flex', alignItems: 'center', gap: 6 }}>\n                <CreditCard size={13} /> W-2 Withholding & Benefits\n              </span>\n              <span className={`badge ${isRefund ? 'emerald' : 'amber'}`}>{isRefund ? `Refund ~${fmt(Math.abs(owed))}` : `Owe ~${fmt(owed)}`}</span>\n            </div>\n            <div style={{ display: 'flex', gap: 0 }}>\n              {[\n                { label: 'Federal Withheld', value: taxReport.w2FederalWithheld, color: 'var(--accent-gold)' },\n                { label: 'State Withheld', value: taxReport.w2StateWithheld, color: 'var(--accent-blue)' },\n                { label: 'FICA Withheld', value: ficaWithheld, color: 'var(--accent-purple)' },\n                ...(w2Pretax > 0 ? [{ label: 'Pre-tax Deductions', value: w2Pretax, color: 'var(--accent-emerald)' }] : []),\n                ...(empMatch > 0 ? [{ label: 'Employer 401k Match', value: empMatch, color: 'var(--accent-amber)' }] : []),\n              ].map((item, i, arr) => (\n                <div key={i} style={{ flex: 1, textAlign: 'center', padding: '0 12px', borderRight: i < arr.length - 1 ? '1px solid var(--border-subtle)' : 'none' }}>\n                  <div style={{ fontSize: 10, color: 'var(--text-muted)', marginBottom: 4 }}>{item.label}</div>\n                  <div style={{ fontFamily: 'var(--font-mono)', fontSize: 15, fontWeight: 600, color: item.color }}>{fmt(item.value)}</div>\n                </div>\n              ))}\n            </div>\n            <div style={{ marginTop: 10, display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '6px 10px', borderRadius: 8, background: isRefund ? 'rgba(16,185,129,0.06)' : 'rgba(212,168,67,0.06)' }}>\n              <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>Total tax liability: {fmt(taxReport.totalTax)} · Withheld: {fmt(totalWithheld)}</span>\n              <span style={{ fontSize: 12, fontFamily: 'var(--font-mono)', fontWeight: 600, color: isRefund ? 'var(--accent-emerald)' : 'var(--accent-gold)' }}>\n                {isRefund ? `≈ ${fmt(Math.abs(owed))} refund` : `≈ ${fmt(owed)} still owed`}\n              </span>\n            </div>\n          </div>\n        )\n      })()}\n\n      {/* Savings banner */}\n      {taxReport.identifiedSavings > 2000 && (\n        <div className=\"glass-card gold-glow\" style={{ padding: '16px 20px', marginBottom: 20, display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer' }} onClick={() => onNavigate('tax')}>\n          <div style={{ display: 'flex', alignItems: 'center', gap: 14 }}>\n            <div style={{ width: 42, height: 42, borderRadius: 12, background: 'var(--accent-gold-dim)', display: 'flex', alignItems: 'center', justifyContent: 'center' }}><DollarSign size={20} color=\"var(--accent-gold)\" /></div>\n            <div>\n              <div style={{ fontFamily: 'var(--font-mono)', fontSize: 20, fontWeight: 600, color: 'var(--accent-gold)' }}>${taxReport.identifiedSavings.toLocaleString()}<span style={{ fontSize: 13, fontWeight: 400, color: 'var(--text-muted)' }}>/year savings identified</span></div>\n              <div style={{ fontSize: 12, color: 'var(--text-secondary)', marginTop: 2 }}>{strategies.length} strategies ready{taxReport.sCorpSavings > 0 && ` · S-Corp saves $${taxReport.sCorpSavings.toLocaleString()}`}</div>\n            </div>\n          </div>\n          <ChevronRight size={18} color=\"var(--accent-gold)\" />\n        </div>\n      )}\n\n      {/* Next Best Action */}\n      {(() => {\n        const smartScens = generateSmartScenarios(state)\n        if (smartScens.length === 0) return null\n        const scResults = smartScens.slice(0, 4).map(sc => {\n          const r = evaluateScenario(sc.name, state, sc.mods)\n          return { ...sc, result: r, delta: r.taxReport.afterTaxIncome - taxReport.afterTaxIncome, taxDelta: taxReport.totalTax - r.taxReport.totalTax }\n        }).filter(s => s.delta !== 0)\n        if (scResults.length === 0) return null\n        return (\n          <div className=\"card\" style={{ marginBottom: 20 }}>\n            <div className=\"card-header\">\n              <span className=\"card-title\" style={{ display: 'flex', alignItems: 'center', gap: 6 }}><Zap size={15} /> Quick What-If</span>\n              <button className=\"btn btn-ghost\" style={{ fontSize: 11, padding: '4px 10px' }} onClick={() => onNavigate('scenarios')}>Full Modeler <ChevronRight size={12} /></button>\n            </div>\n            <div className=\"card-body\" style={{ display: 'grid', gridTemplateColumns: `repeat(${Math.min(scResults.length, 4)}, 1fr)`, gap: 10 }}>\n              {scResults.map((sc, i) => {\n                const isPositive = sc.delta > 0\n                return (\n                  <div key={i} style={{ padding: '12px 14px', borderRadius: 10, background: 'var(--bg-primary)', border: `1px solid ${isPositive ? 'rgba(16,185,129,0.15)' : 'var(--border-subtle)'}`, cursor: 'pointer', transition: 'border-color 0.2s' }}\n                    onClick={() => onNavigate('scenarios')}>\n                    <div style={{ fontSize: 16, marginBottom: 6 }}>{sc.icon}</div>\n                    <div style={{ fontSize: 12, fontWeight: 500, color: 'var(--text-primary)', marginBottom: 4 }}>{sc.name}</div>\n                    <div style={{ fontFamily: 'var(--font-mono)', fontSize: 16, fontWeight: 600, color: isPositive ? 'var(--accent-emerald)' : 'var(--accent-red)', display: 'flex', alignItems: 'center', gap: 4 }}>\n                      {isPositive ? <ArrowUpRight size={14} /> : <ArrowDownRight size={14} />}\n                      {fmt(Math.abs(sc.delta))}\n                    </div>\n                    <div style={{ fontSize: 10, color: 'var(--text-muted)', marginTop: 2 }}>\n                      {sc.taxDelta > 0 ? `Saves ${fmt(sc.taxDelta)} tax` : sc.description}\n                    </div>\n                    <div style={{ marginTop: 6, height: 3, borderRadius: 2, background: 'var(--bg-hover)' }}>\n                      <div style={{ height: '100%', borderRadius: 2, width: `${Math.min(100, (Math.abs(sc.delta) / Math.max(1, taxReport.afterTaxIncome)) * 100 * 10)}%`, background: isPositive ? 'var(--accent-emerald)' : 'var(--accent-red)' }} />\n                    </div>\n                  </div>\n                )\n              })}\n            </div>\n          </div>\n        )\n      })()}\n\n      {/* Next Best Action — Strategy Focus */}\n      {criticalStrategies.length > 0 && (() => {\n        const nextAction = criticalStrategies[0]\n        const stepCount = nextAction.steps?.length || 0\n        return (\n          <div style={{\n            marginBottom: 20, padding: '18px 20px', borderRadius: 14,\n            background: 'linear-gradient(135deg, var(--bg-elevated), var(--bg-surface))',\n            border: '1px solid var(--border-medium)',\n            display: 'flex', gap: 16, alignItems: 'center',\n            cursor: 'pointer',\n            transition: 'border-color 0.3s, box-shadow 0.3s',\n          }}\n          onClick={() => onNavigate('workflows')}\n          onMouseEnter={e => {\n            e.currentTarget.style.borderColor = 'var(--border-glow)'\n            e.currentTarget.style.boxShadow = '0 4px 24px rgba(212,168,67,0.08)'\n          }}\n          onMouseLeave={e => {\n            e.currentTarget.style.borderColor = 'var(--border-medium)'\n            e.currentTarget.style.boxShadow = 'none'\n          }}\n          >\n            <div style={{\n              width: 48, height: 48, borderRadius: 14, flexShrink: 0,\n              background: 'linear-gradient(135deg, var(--accent-gold), #b8912e)',\n              display: 'flex', alignItems: 'center', justifyContent: 'center',\n              boxShadow: '0 4px 16px rgba(212,168,67,0.25)',\n            }}>\n              <Zap size={22} color=\"#0c0e12\" />\n            </div>\n            <div style={{ flex: 1, minWidth: 0 }}>\n              <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 3 }}>\n                <span style={{ fontSize: 10, fontFamily: 'var(--font-mono)', fontWeight: 600, letterSpacing: '0.1em', color: 'var(--accent-gold)' }}>NEXT BEST ACTION</span>\n                <span className={`badge ${nextAction.priority === 'critical' ? 'red' : 'amber'}`}>{nextAction.priority}</span>\n              </div>\n              <div style={{ fontSize: 14, fontWeight: 500, color: 'var(--text-primary)', marginBottom: 3 }}>{nextAction.title}</div>\n              <div style={{ display: 'flex', gap: 12, fontSize: 11, color: 'var(--text-muted)' }}>\n                <span style={{ color: 'var(--accent-emerald)', fontFamily: 'var(--font-mono)', fontWeight: 500 }}>{nextAction.impactLabel}</span>\n                <span>{nextAction.timeline}</span>\n                {stepCount > 0 && <span>{stepCount} step{stepCount !== 1 ? 's' : ''}</span>}\n              </div>\n            </div>\n            <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 2 }}>\n              <div style={{\n                width: 36, height: 36, borderRadius: 10,\n                background: 'var(--accent-gold-dim)', display: 'flex', alignItems: 'center', justifyContent: 'center',\n              }}>\n                <ArrowRight size={16} color=\"var(--accent-gold)\" />\n              </div>\n              <span style={{ fontSize: 9, color: 'var(--text-muted)', fontFamily: 'var(--font-mono)' }}>Start</span>\n            </div>\n          </div>\n        )\n      })()}\n\n      {/* Projections bar */}\n      {projections.length > 0 && (\n        <div className=\"glass-card\" style={{ padding: '14px 20px', marginBottom: 20 }}>\n          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 10 }}>\n            <span style={{ fontSize: 12, color: 'var(--text-muted)', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.06em', display: 'flex', alignItems: 'center', gap: 6 }}><TrendingUp size={13} /> 12-Month Trajectory</span>\n            <span className=\"badge muted\">{projections[0]?.confidence} conf · {snapshotCount} pts</span>\n          </div>\n          <div style={{ display: 'flex', gap: 0 }}>\n            {projections.slice(0, 5).map((proj, i) => {\n              const diff12 = proj.projected12Month - proj.current\n              const isUp = diff12 > 0\n              const isBetter = proj.metric === 'effectiveTaxRate' || proj.metric === 'totalTaxBurden' ? !isUp : isUp\n              const color = Math.abs(diff12) < 1 ? 'var(--text-muted)' : isBetter ? 'var(--accent-emerald)' : 'var(--accent-red)'\n              return (\n                <div key={proj.metric} style={{ flex: 1, textAlign: 'center', padding: '0 12px', borderRight: i < 4 ? '1px solid var(--border-subtle)' : 'none' }}>\n                  <div style={{ fontSize: 10, color: 'var(--text-muted)', marginBottom: 4 }}>{proj.label}</div>\n                  <div style={{ fontFamily: 'var(--font-mono)', fontSize: 15, fontWeight: 600, color: 'var(--text-primary)' }}>{proj.unit === '$' ? `$${(proj.current / 1000).toFixed(0)}K` : `${proj.current.toFixed(1)}${proj.unit}`}</div>\n                  <div style={{ fontSize: 10, fontFamily: 'var(--font-mono)', color, marginTop: 3, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 2 }}><ArrowRight size={9} />{proj.unit === '$' ? `$${(proj.projected12Month / 1000).toFixed(0)}K` : `${proj.projected12Month.toFixed(1)}${proj.unit}`}</div>\n                </div>\n              )\n            })}\n          </div>\n        </div>\n      )}\n\n      {/* Main grid: Strategy Feed + Health Radar */}\n      <div style={{ display: 'grid', gridTemplateColumns: '1fr 320px', gap: 16, marginBottom: 20 }}>\n        <div className=\"card\">\n          <div className=\"card-header\"><span className=\"card-title\">Strategy Intelligence</span><button className=\"btn btn-ghost\" style={{ fontSize: 11, padding: '4px 10px' }} onClick={() => onNavigate('tax')}>All Strategies <ChevronRight size={12} /></button></div>\n          <div className=\"card-body\" style={{ display: 'flex', flexDirection: 'column', gap: 0, maxHeight: 320, overflow: 'auto' }}>\n            {strategies.length > 0 ? strategies.slice(0, 6).map(strat => (\n              <div key={strat.id} style={{ padding: '12px 0', borderBottom: '1px solid var(--border-subtle)' }}>\n                <div style={{ display: 'flex', gap: 10, alignItems: 'flex-start' }}>\n                  <div style={{ width: 8, height: 8, borderRadius: 4, marginTop: 6, flexShrink: 0, background: priorityColors[strat.priority], boxShadow: strat.priority === 'critical' ? '0 0 8px rgba(239,107,107,0.4)' : 'none' }} />\n                  <div style={{ flex: 1, minWidth: 0 }}>\n                    <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 2 }}>\n                      <span style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)' }}>{strat.title}</span>\n                      <span className={`badge ${strat.priority === 'critical' ? 'red' : strat.priority === 'high' ? 'gold' : 'muted'}`}>{strat.priority}</span>\n                    </div>\n                    <div style={{ display: 'flex', gap: 12, fontSize: 12, color: 'var(--text-muted)' }}>\n                      <span style={{ color: 'var(--accent-emerald)', fontFamily: 'var(--font-mono)', fontWeight: 500 }}>{strat.impactLabel}</span>\n                      <span>{strat.timeline}</span>\n                      <span>Risk: {strat.risk}</span>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            )) : <div style={{ color: 'var(--text-muted)', fontSize: 13, textAlign: 'center', padding: 20 }}>Add financial data to detect strategies</div>}\n          </div>\n        </div>\n\n        <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>\n          <div className=\"card\" style={{ padding: '12px 16px' }}>\n            <div style={{ fontSize: 12, color: 'var(--text-muted)', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 4 }}>Health Radar</div>\n            <ResponsiveContainer width=\"100%\" height={160}>\n              <RadarChart data={radarData} cx=\"50%\" cy=\"50%\" outerRadius=\"70%\">\n                <PolarGrid stroke=\"var(--border-subtle)\" />\n                <PolarAngleAxis dataKey=\"dimension\" tick={{ fill: 'var(--text-muted)', fontSize: 10 }} />\n                <Radar name=\"Score\" dataKey=\"value\" stroke=\"var(--accent-gold)\" fill=\"var(--accent-gold)\" fillOpacity={0.2} strokeWidth={2} />\n              </RadarChart>\n            </ResponsiveContainer>\n          </div>\n          {taxAllocation.length > 0 && (\n            <div className=\"card\" style={{ padding: '12px 16px' }}>\n              <div style={{ fontSize: 12, color: 'var(--text-muted)', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 4 }}>Tax Allocation</div>\n              <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>\n                <ResponsiveContainer width={80} height={80}><PieChart><Pie data={taxAllocation} dataKey=\"value\" innerRadius={24} outerRadius={38} paddingAngle={2} strokeWidth={0}>{taxAllocation.map((d, i) => <Cell key={i} fill={d.color} />)}</Pie></PieChart></ResponsiveContainer>\n                <div style={{ display: 'flex', flexDirection: 'column', gap: 4, flex: 1 }}>\n                  {taxAllocation.map((d, i) => (\n                    <div key={i} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\n                      <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}><div style={{ width: 6, height: 6, borderRadius: 3, background: d.color }} /><span style={{ fontSize: 11, color: 'var(--text-secondary)' }}>{d.name}</span></div>\n                      <span style={{ fontFamily: 'var(--font-mono)', fontSize: 11, color: 'var(--text-primary)' }}>${(d.value / 1000).toFixed(1)}k</span>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Revenue Streams */}\n      <div className=\"card\" style={{ marginBottom: 20 }}>\n        <div className=\"card-header\">\n          <span className=\"card-title\">Revenue Streams</span>\n          <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n            <span style={{ fontFamily: 'var(--font-mono)', fontSize: 14, fontWeight: 600, color: 'var(--text-primary)' }}>${(totalRevenue / 1000).toFixed(0)}k<span style={{ fontSize: 11, color: 'var(--text-muted)', fontWeight: 400 }}>/yr</span></span>\n            <button className=\"btn btn-ghost\" style={{ fontSize: 11, padding: '4px 10px' }} onClick={() => onNavigate('revenue')}>Manage <ChevronRight size={12} /></button>\n          </div>\n        </div>\n        <div className=\"card-body\" style={{ display: 'grid', gridTemplateColumns: `repeat(${Math.min(revenueStreams.length || 1, 4)}, 1fr)`, gap: 12 }}>\n          {revenueStreams.slice(0, 4).map((stream, i) => {\n            const pct = totalRevenue > 0 ? (stream.annualAmount / totalRevenue) * 100 : 0\n            const colors = ['var(--accent-gold)', 'var(--accent-blue)', 'var(--accent-purple)', 'var(--accent-emerald)']\n            const color = colors[i % colors.length]\n            return (\n              <div key={stream.id} style={{ padding: '12px 14px', borderRadius: 10, background: 'var(--bg-primary)', borderLeft: `3px solid ${color}` }}>\n                <div style={{ fontSize: 12, color: 'var(--text-muted)', marginBottom: 4 }}>{stream.name || stream.type}</div>\n                <div style={{ fontFamily: 'var(--font-mono)', fontSize: 18, fontWeight: 600, color: 'var(--text-primary)' }}>${(stream.annualAmount / 1000).toFixed(0)}k</div>\n                <div style={{ display: 'flex', alignItems: 'center', gap: 4, marginTop: 4 }}>\n                  <div style={{ flex: 1, height: 3, borderRadius: 2, background: 'var(--bg-hover)' }}><div style={{ width: `${pct}%`, height: '100%', borderRadius: 2, background: color }} /></div>\n                  <span style={{ fontFamily: 'var(--font-mono)', fontSize: 10, color: pct > 60 ? 'var(--accent-red)' : 'var(--text-muted)' }}>{pct.toFixed(0)}%</span>\n                </div>\n              </div>\n            )\n          })}\n          {revenueStreams.length === 0 && <div style={{ gridColumn: '1/-1', color: 'var(--text-muted)', fontSize: 13, textAlign: 'center', padding: 16 }}>No revenue streams configured</div>}\n        </div>\n      </div>\n\n      {/* Entity P&L Breakdown */}\n      {taxReport.entityBreakdown && taxReport.entityBreakdown.filter(e => e.revenue > 0 || e.expenses > 0).length > 1 && (\n        <div className=\"card\" style={{ marginBottom: 20 }}>\n          <div className=\"card-header\">\n            <span className=\"card-title\">Entity P&L</span>\n            <button className=\"btn btn-ghost\" style={{ fontSize: 11, padding: '4px 10px' }} onClick={() => onNavigate('entity')}>Manage <ChevronRight size={12} /></button>\n          </div>\n          <div className=\"card-body\" style={{ display: 'grid', gridTemplateColumns: `repeat(${Math.min(taxReport.entityBreakdown.filter(e => e.revenue > 0 || e.expenses > 0).length, 3)}, 1fr)`, gap: 12 }}>\n            {taxReport.entityBreakdown.filter(e => e.revenue > 0 || e.expenses > 0).map(ent => {\n              const margin = ent.revenue > 0 ? (ent.netIncome / ent.revenue) * 100 : 0\n              const flowColors: Record<string, string> = { schedule_c: 'var(--accent-gold)', k1: 'var(--accent-purple)', w2_salary: 'var(--accent-blue)', corporate: 'var(--accent-red)', personal: 'var(--accent-emerald)' }\n              const flowLabels: Record<string, string> = { schedule_c: 'Sched C', k1: 'K-1', w2_salary: 'W-2', corporate: 'Corp', personal: 'Personal' }\n              return (\n                <div key={ent.entityId} style={{ padding: '14px 16px', borderRadius: 10, background: 'var(--bg-primary)', borderLeft: `3px solid ${flowColors[ent.flowThrough] || 'var(--text-muted)'}` }}>\n                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8 }}>\n                    <span style={{ fontSize: 13, fontWeight: 600, color: 'var(--text-primary)' }}>{ent.entityName}</span>\n                    <span className=\"badge\" style={{ background: `${flowColors[ent.flowThrough] || 'var(--text-muted)'}22`, color: flowColors[ent.flowThrough] || 'var(--text-muted)', fontSize: 10 }}>\n                      {flowLabels[ent.flowThrough] || ent.flowThrough}\n                    </span>\n                  </div>\n                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 6, fontSize: 12 }}>\n                    <div>\n                      <div style={{ color: 'var(--text-muted)', fontSize: 10, marginBottom: 2 }}>Revenue</div>\n                      <div style={{ fontFamily: 'var(--font-mono)', fontWeight: 600, color: 'var(--accent-emerald)' }}>${(ent.revenue / 1000).toFixed(0)}k</div>\n                    </div>\n                    <div>\n                      <div style={{ color: 'var(--text-muted)', fontSize: 10, marginBottom: 2 }}>Net Income</div>\n                      <div style={{ fontFamily: 'var(--font-mono)', fontWeight: 600, color: ent.netIncome >= 0 ? 'var(--text-primary)' : 'var(--accent-red)' }}>${(ent.netIncome / 1000).toFixed(0)}k</div>\n                    </div>\n                  </div>\n                  {ent.officerSalary > 0 && (\n                    <div style={{ fontSize: 10, color: 'var(--text-muted)', marginTop: 6 }}>Officer salary: ${ent.officerSalary.toLocaleString()} · Distributions: ${ent.distributions.toLocaleString()}</div>\n                  )}\n                  <div style={{ display: 'flex', alignItems: 'center', gap: 4, marginTop: 6 }}>\n                    <div style={{ flex: 1, height: 3, borderRadius: 2, background: 'var(--bg-hover)' }}>\n                      <div style={{ width: `${Math.max(0, Math.min(100, margin))}%`, height: '100%', borderRadius: 2, background: margin > 30 ? 'var(--accent-emerald)' : margin > 10 ? 'var(--accent-gold)' : 'var(--accent-red)' }} />\n                    </div>\n                    <span style={{ fontFamily: 'var(--font-mono)', fontSize: 10, color: 'var(--text-muted)' }}>{margin.toFixed(0)}% margin</span>\n                  </div>\n                </div>\n              )\n            })}\n          </div>\n        </div>\n      )}\n\n      {/* Strategy Effectiveness */}\n      {strategyEffects.length > 0 && (\n        <div className=\"card\" style={{ marginBottom: 20 }}>\n          <div className=\"card-header\"><span className=\"card-title\">Strategy Impact Tracking</span><button className=\"btn btn-ghost\" style={{ fontSize: 11, padding: '4px 10px' }} onClick={() => onNavigate('history')}>Full History <ChevronRight size={12} /></button></div>\n          <div className=\"card-body\" style={{ display: 'flex', gap: 12, flexWrap: 'wrap' }}>\n            {strategyEffects.slice(0, 3).map((effect, i) => {\n              const vColor = { positive: 'var(--accent-emerald)', negative: 'var(--accent-red)', neutral: 'var(--accent-gold)', insufficient_data: 'var(--text-muted)' }[effect.verdict]\n              return (<div key={i} style={{ flex: '1 1 200px', padding: 14, borderRadius: 10, background: 'var(--bg-primary)', borderLeft: `3px solid ${vColor}` }}><div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 4 }}><span style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)' }}>{effect.strategyTitle}</span><span className={`badge ${effect.verdict === 'positive' ? 'emerald' : effect.verdict === 'negative' ? 'red' : 'muted'}`}>{effect.verdict === 'insufficient_data' ? 'pending' : effect.verdict}</span></div><div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.4 }}>{effect.summary}</div></div>)\n            })}\n          </div>\n        </div>\n      )}\n\n      {/* Portfolio Intelligence Widget */}\n      {portfolioWidget && (\n        <div style={{ marginBottom: 20, padding: '18px 20px', borderRadius: 14, background: 'linear-gradient(135deg, var(--bg-elevated), var(--bg-surface))', border: '1px solid var(--border-medium)', cursor: 'pointer', transition: 'border-color 0.3s' }}\n          onClick={() => onNavigate('portfolio')}\n          onMouseEnter={e => { e.currentTarget.style.borderColor = '#8b5cf6' }}\n          onMouseLeave={e => { e.currentTarget.style.borderColor = 'var(--border-medium)' }}\n        >\n          <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 14 }}>\n            <Briefcase size={14} color=\"#8b5cf6\" />\n            <span style={{ fontSize: 10, fontFamily: 'var(--font-mono)', fontWeight: 600, letterSpacing: '0.1em', color: '#8b5cf6', textTransform: 'uppercase' }}>Portfolio Intelligence</span>\n            {portfolioWidget.alertCount > 0 && <span className=\"badge red\" style={{ fontSize: 9 }}>{portfolioWidget.alertCount} alert{portfolioWidget.alertCount !== 1 ? 's' : ''}</span>}\n          </div>\n          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 16 }}>\n            <div>\n              <div style={{ fontSize: 11, color: 'var(--text-muted)', marginBottom: 4 }}>Portfolio Value</div>\n              <div style={{ fontSize: 18, fontWeight: 600, fontFamily: 'var(--font-mono)', color: 'var(--text-primary)' }}>${Math.round(portfolioWidget.totalValue).toLocaleString()}</div>\n            </div>\n            <div>\n              <div style={{ fontSize: 11, color: 'var(--text-muted)', marginBottom: 4 }}>Gain / Loss</div>\n              <div style={{ fontSize: 18, fontWeight: 600, fontFamily: 'var(--font-mono)', color: portfolioWidget.gainLoss >= 0 ? 'var(--accent-emerald)' : 'var(--accent-red)' }}>\n                {portfolioWidget.gainLoss >= 0 ? '+' : ''}{portfolioWidget.gainLossPct.toFixed(1)}%\n              </div>\n            </div>\n            <div>\n              <div style={{ fontSize: 11, color: 'var(--text-muted)', marginBottom: 4 }}>Positions</div>\n              <div style={{ fontSize: 18, fontWeight: 600, fontFamily: 'var(--font-mono)', color: 'var(--text-primary)' }}>{portfolioWidget.positionCount}</div>\n            </div>\n            <div>\n              <div style={{ fontSize: 11, color: 'var(--text-muted)', marginBottom: 4 }}>Pending Events</div>\n              <div style={{ fontSize: 18, fontWeight: 600, fontFamily: 'var(--font-mono)', color: portfolioWidget.pendingEvents > 0 ? 'var(--accent-amber)' : 'var(--text-primary)' }}>{portfolioWidget.pendingEvents}</div>\n            </div>\n          </div>\n          {portfolioWidget.topPositions.length > 0 && (\n            <div style={{ marginTop: 12, display: 'flex', gap: 8, flexWrap: 'wrap' }}>\n              {portfolioWidget.topPositions.map((p, i) => (\n                <span key={i} style={{ fontSize: 11, padding: '3px 8px', borderRadius: 6, background: 'var(--bg-primary)', color: 'var(--text-secondary)', fontFamily: 'var(--font-mono)' }}>\n                  {p.name} · ${Math.round(p.value).toLocaleString()} · {p.pct.toFixed(0)}%\n                </span>\n              ))}\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* Quick Actions */}\n      <div style={{ marginTop: 8 }}>\n        <div style={{ fontSize: 12, color: 'var(--text-muted)', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 12 }}>Quick Actions</div>\n        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 10 }} className=\"stagger-fast\">\n          {[\n            { key: 'scenarios', label: 'Scenarios', sub: 'What-if modeler', icon: <BarChart3 size={18} />, color: 'var(--accent-gold)' },\n            { key: 'document-scan', label: 'Scanner', sub: 'Multi-doc intake', icon: <FileText size={18} />, color: 'var(--accent-blue)' },\n            { key: 'audit', label: 'Audit Profiler', sub: 'IRS DIF scoring', icon: <Shield size={18} />, color: 'var(--accent-red)' },\n            { key: 'optimizer', label: 'Entity Optimizer', sub: 'Structure arbitrage', icon: <Building2 size={18} />, color: 'var(--accent-purple)' },\n            { key: 'advisor', label: 'AI Advisor', sub: 'Full-context AI', icon: <Brain size={18} />, color: 'var(--accent-emerald)' },\n            { key: 'history', label: 'History', sub: `${snapshotCount} snapshots`, icon: <History size={18} />, color: 'var(--accent-gold)' },\n            { key: 'cpa', label: 'CPA Export', sub: 'Professional handoff', icon: <Briefcase size={18} />, color: 'var(--accent-blue)' },\n            { key: 'alerts', label: 'Intelligence', sub: 'Proactive alerts', icon: <Bell size={18} />, color: 'var(--accent-amber)' },\n          ].map(item => (\n            <div key={item.key} className=\"action-card\" onClick={() => onNavigate(item.key as ViewKey)}>\n              <div className=\"action-icon\" style={{ background: `${item.color}12`, color: item.color }}>{item.icon}</div>\n              <div><div style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)' }}>{item.label}</div><div style={{ fontSize: 11, color: 'var(--text-muted)' }}>{item.sub}</div></div>\n            </div>\n          ))}\n        </div>\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\DataImport.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useMemo' is defined but never used.","line":1,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":48,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useMemo"},"fix":{"range":[38,47],"text":""},"desc":"Remove unused variable \"useMemo\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'CategorizedTransaction' is defined but never used.","line":3,"column":50,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":72,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CategorizedTransaction"},"fix":{"range":[161,190],"text":""},"desc":"Remove unused variable \"CategorizedTransaction\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'X' is defined but never used.","line":4,"column":42,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":43,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"X"},"fix":{"range":[261,264],"text":""},"desc":"Remove unused variable \"X\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'state' is assigned a value but never used.","line":9,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'selectedTransactions' is assigned a value but never used.","line":14,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":30}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useCallback, useRef, useMemo } from 'react'\nimport { useFortuna, genId } from '../hooks/useFortuna'\nimport { importFromFile, type ImportResult, type CategorizedTransaction } from '../engine/data-import'\nimport { Upload, FileSpreadsheet, Check, X, AlertTriangle, TrendingUp, TrendingDown, ArrowRight, RefreshCw } from 'lucide-react'\n\ntype ImportStage = 'upload' | 'review' | 'confirm' | 'done'\n\nexport function DataImport() {\n  const { state, updateState } = useFortuna()\n  const [stage, setStage] = useState<ImportStage>('upload')\n  const [result, setResult] = useState<ImportResult | null>(null)\n  const [error, setError] = useState<string | null>(null)\n  const [dragOver, setDragOver] = useState(false)\n  const [selectedTransactions, setSelectedTransactions] = useState<Set<number>>(new Set())\n  const [importedCount, setImportedCount] = useState(0)\n  const fileRef = useRef<HTMLInputElement>(null)\n  \n  const handleFile = useCallback((file: File) => {\n    setError(null)\n    const reader = new FileReader()\n    reader.onload = (e) => {\n      const content = e.target?.result as string\n      if (!content) {\n        setError('Could not read file')\n        return\n      }\n      \n      const importResult = importFromFile(content)\n      if ('error' in importResult) {\n        setError(importResult.error)\n        return\n      }\n      \n      setResult(importResult)\n      // Pre-select all business transactions\n      const selected = new Set<number>()\n      importResult.transactions.forEach((tx, i) => {\n        if (tx.autoCategory !== 'transfer' && tx.autoCategory !== 'personal' && tx.confidence > 0.3) {\n          selected.add(i)\n        }\n      })\n      setSelectedTransactions(selected)\n      setStage('review')\n    }\n    reader.readAsText(file)\n  }, [])\n  \n  const handleDrop = useCallback((e: React.DragEvent) => {\n    e.preventDefault()\n    setDragOver(false)\n    const file = e.dataTransfer.files[0]\n    if (file) handleFile(file)\n  }, [handleFile])\n  \n  const handleImport = useCallback(() => {\n    if (!result) return\n    \n    updateState(prev => {\n      const newIncome = [...prev.incomeStreams]\n      const newExpenses = [...prev.expenses]\n      \n      // Add suggested income streams\n      for (const stream of result.suggestedIncomeStreams) {\n        if (stream.annualAmount && stream.annualAmount > 0) {\n          newIncome.push({\n            id: genId(),\n            name: stream.name || 'Imported Income',\n            type: stream.type || 'other',\n            annualAmount: stream.annualAmount,\n            isActive: true,\n          })\n        }\n      }\n      \n      // Add suggested expenses\n      for (const exp of result.suggestedExpenses) {\n        if (exp.annualAmount && exp.annualAmount > 0) {\n          newExpenses.push({\n            id: genId(),\n            category: exp.category || 'Uncategorized',\n            description: exp.description || 'Imported Expense',\n            annualAmount: exp.annualAmount,\n            isDeductible: exp.isDeductible ?? true,\n            deductionPct: exp.deductionPct ?? 100,\n          })\n        }\n      }\n      \n      return { ...prev, incomeStreams: newIncome, expenses: newExpenses }\n    })\n    \n    setImportedCount(\n      (result.suggestedIncomeStreams.length || 0) + (result.suggestedExpenses.length || 0)\n    )\n    setStage('done')\n  }, [result, updateState])\n  \n  const reset = () => {\n    setStage('upload')\n    setResult(null)\n    setError(null)\n    setSelectedTransactions(new Set())\n  }\n  \n  const categoryColors: Record<string, string> = {\n    business_income: '#10b981', freelance_income: '#10b981', salary: '#3b82f6',\n    investment_income: '#8b5cf6', rental_income: '#f59e0b', other_income: '#6b7280',\n    software_subscriptions: '#ec4899', advertising: '#f97316', travel: '#06b6d4',\n    meals: '#ef4444', vehicle: '#78716c', office_supplies: '#a855f7', equipment: '#6366f1',\n    professional_services: '#0ea5e9', utilities: '#64748b', education: '#14b8a6',\n    charitable: '#f43f5e', health_medical: '#22c55e', personal: '#9ca3af',\n    transfer: '#475569', unknown: '#6b7280', insurance: '#3b82f6',\n    bank_fees: '#ef4444', taxes_paid: '#dc2626', rent_lease: '#a78bfa',\n  }\n  \n  return (\n    <div style={{ padding: 32, maxWidth: 1000 }}>\n      {/* Header */}\n      <div style={{ marginBottom: 32 }}>\n        <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 8 }}>\n          <Upload size={24} style={{ color: 'var(--accent-gold)' }} />\n          <h1 style={{ fontFamily: 'var(--font-display)', fontSize: 28, color: 'var(--text-primary)', margin: 0 }}>\n            Data Import\n          </h1>\n        </div>\n        <p style={{ color: 'var(--text-muted)', fontSize: 14, margin: 0 }}>\n          Import bank statements (CSV, OFX, QFX) for automatic categorization and integration\n        </p>\n      </div>\n      \n      {/* Stage: Upload */}\n      {stage === 'upload' && (\n        <div>\n          <div\n            onDragOver={e => { e.preventDefault(); setDragOver(true) }}\n            onDragLeave={() => setDragOver(false)}\n            onDrop={handleDrop}\n            onClick={() => fileRef.current?.click()}\n            style={{\n              padding: 64,\n              border: `2px dashed ${dragOver ? 'var(--accent-gold)' : 'var(--border-subtle)'}`,\n              borderRadius: 16,\n              background: dragOver ? 'var(--accent-gold-dim)' : 'var(--bg-elevated)',\n              textAlign: 'center',\n              cursor: 'pointer',\n              transition: 'all 0.3s',\n            }}\n          >\n            <div style={{\n              width: 64, height: 64, borderRadius: 16, margin: '0 auto 20px',\n              background: 'var(--accent-gold-dim)', display: 'flex', alignItems: 'center', justifyContent: 'center',\n            }}>\n              <FileSpreadsheet size={28} style={{ color: 'var(--accent-gold)' }} />\n            </div>\n            <div style={{ fontSize: 16, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 8 }}>\n              Drop your bank statement here\n            </div>\n            <div style={{ fontSize: 13, color: 'var(--text-muted)', marginBottom: 4 }}>\n              or click to browse files\n            </div>\n            <div style={{ fontSize: 12, color: 'var(--text-muted)' }}>\n              Supports CSV, OFX, QFX formats\n            </div>\n            <input\n              ref={fileRef}\n              type=\"file\"\n              accept=\".csv,.ofx,.qfx,.txt\"\n              style={{ display: 'none' }}\n              onChange={e => {\n                const file = e.target.files?.[0]\n                if (file) handleFile(file)\n              }}\n            />\n          </div>\n          \n          {error && (\n            <div style={{\n              marginTop: 16, padding: 16, background: 'rgba(239,68,68,0.1)',\n              borderRadius: 12, display: 'flex', alignItems: 'center', gap: 10,\n              border: '1px solid rgba(239,68,68,0.2)',\n            }}>\n              <AlertTriangle size={16} style={{ color: 'var(--accent-red)' }} />\n              <span style={{ fontSize: 13, color: 'var(--accent-red)' }}>{error}</span>\n            </div>\n          )}\n          \n          {/* Supported formats info */}\n          <div style={{ marginTop: 32, display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 16 }}>\n            {[\n              { format: 'CSV', desc: 'Most banks offer CSV export from transaction history', sources: 'Chase, Bank of America, Wells Fargo, Capital One' },\n              { format: 'OFX/QFX', desc: 'Open Financial Exchange — direct bank download format', sources: 'Quicken, many online banking portals' },\n              { format: 'Auto-Categorize', desc: 'AI categorizes transactions into income types & expense categories', sources: '60+ merchant/vendor patterns recognized' },\n            ].map(info => (\n              <div key={info.format} style={{\n                padding: 20, background: 'var(--bg-elevated)', borderRadius: 12,\n                border: '1px solid var(--border-subtle)',\n              }}>\n                <div style={{ fontSize: 13, fontWeight: 600, color: 'var(--accent-gold)', marginBottom: 6 }}>\n                  {info.format}\n                </div>\n                <div style={{ fontSize: 12, color: 'var(--text-secondary)', marginBottom: 8, lineHeight: 1.5 }}>\n                  {info.desc}\n                </div>\n                <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>\n                  {info.sources}\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n      \n      {/* Stage: Review */}\n      {stage === 'review' && result && (\n        <div>\n          {/* Import Summary */}\n          <div style={{\n            display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 12, marginBottom: 24,\n          }}>\n            {[\n              { label: 'Transactions', value: result.summary.totalTransactions.toLocaleString(), color: 'var(--text-primary)' },\n              { label: 'Total Income', value: `$${Math.round(result.summary.totalIncome).toLocaleString()}`, color: 'var(--accent-emerald)' },\n              { label: 'Total Expenses', value: `$${Math.round(result.summary.totalExpenses).toLocaleString()}`, color: 'var(--accent-red)' },\n              { label: 'Unclassified', value: result.summary.unclassified.toString(), color: result.summary.unclassified > 10 ? 'var(--accent-gold)' : 'var(--text-muted)' },\n            ].map(stat => (\n              <div key={stat.label} style={{\n                padding: 16, background: 'var(--bg-elevated)', borderRadius: 12,\n                border: '1px solid var(--border-subtle)',\n              }}>\n                <div style={{ fontSize: 11, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.05em' }}>\n                  {stat.label}\n                </div>\n                <div style={{ fontSize: 22, fontWeight: 700, color: stat.color, fontFamily: 'var(--font-mono)', marginTop: 4 }}>\n                  {stat.value}\n                </div>\n              </div>\n            ))}\n          </div>\n          \n          {/* Date range */}\n          <div style={{ fontSize: 12, color: 'var(--text-muted)', marginBottom: 20 }}>\n            Date range: {result.summary.dateRange.start} to {result.summary.dateRange.end}\n          </div>\n          \n          {/* Suggested income streams */}\n          {result.suggestedIncomeStreams.length > 0 && (\n            <div style={{ marginBottom: 24 }}>\n              <div style={{ fontSize: 14, fontWeight: 600, color: 'var(--accent-emerald)', marginBottom: 12, display: 'flex', alignItems: 'center', gap: 8 }}>\n                <TrendingUp size={16} />\n                Detected Income Streams ({result.suggestedIncomeStreams.length})\n              </div>\n              <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>\n                {result.suggestedIncomeStreams.map((stream, i) => (\n                  <div key={i} style={{\n                    padding: '12px 16px', background: 'rgba(16,185,129,0.06)', borderRadius: 10,\n                    border: '1px solid rgba(16,185,129,0.15)', display: 'flex', justifyContent: 'space-between', alignItems: 'center',\n                  }}>\n                    <div>\n                      <div style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)' }}>{stream.name}</div>\n                      <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>Type: {stream.type}</div>\n                    </div>\n                    <div style={{ fontFamily: 'var(--font-mono)', fontSize: 14, fontWeight: 600, color: 'var(--accent-emerald)' }}>\n                      ${stream.annualAmount?.toLocaleString()}/yr\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </div>\n          )}\n          \n          {/* Suggested expenses */}\n          {result.suggestedExpenses.length > 0 && (\n            <div style={{ marginBottom: 24 }}>\n              <div style={{ fontSize: 14, fontWeight: 600, color: 'var(--accent-red)', marginBottom: 12, display: 'flex', alignItems: 'center', gap: 8 }}>\n                <TrendingDown size={16} />\n                Detected Expense Categories ({result.suggestedExpenses.length})\n              </div>\n              <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>\n                {result.suggestedExpenses.map((exp, i) => (\n                  <div key={i} style={{\n                    padding: '12px 16px', background: 'rgba(239,68,68,0.04)', borderRadius: 10,\n                    border: '1px solid rgba(239,68,68,0.1)', display: 'flex', justifyContent: 'space-between', alignItems: 'center',\n                  }}>\n                    <div>\n                      <div style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)' }}>{exp.category}</div>\n                      <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>\n                        {exp.isDeductible ? `${exp.deductionPct}% deductible` : 'Not deductible'}\n                      </div>\n                    </div>\n                    <div style={{ fontFamily: 'var(--font-mono)', fontSize: 14, fontWeight: 600, color: 'var(--text-secondary)' }}>\n                      ${exp.annualAmount?.toLocaleString()}/yr\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </div>\n          )}\n          \n          {/* Top categories chart */}\n          <div style={{ marginBottom: 24 }}>\n            <div style={{ fontSize: 14, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 12 }}>\n              Category Breakdown\n            </div>\n            {result.summary.topCategories.slice(0, 8).map(cat => {\n              const maxAmount = result.summary.topCategories[0]?.amount || 1\n              const pct = (cat.amount / maxAmount) * 100\n              return (\n                <div key={cat.category} style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 8 }}>\n                  <div style={{ width: 140, fontSize: 11, color: 'var(--text-muted)', textAlign: 'right', flexShrink: 0 }}>\n                    {cat.category.replace(/_/g, ' ')}\n                  </div>\n                  <div style={{ flex: 1, height: 20, background: 'var(--bg-elevated)', borderRadius: 4, overflow: 'hidden' }}>\n                    <div style={{\n                      height: '100%', width: `${pct}%`, borderRadius: 4,\n                      background: categoryColors[cat.category] || '#6b7280',\n                      transition: 'width 0.5s ease',\n                    }} />\n                  </div>\n                  <div style={{ width: 80, fontSize: 11, fontFamily: 'var(--font-mono)', color: 'var(--text-secondary)', flexShrink: 0 }}>\n                    ${Math.round(cat.amount).toLocaleString()}\n                  </div>\n                  <div style={{ width: 30, fontSize: 10, color: 'var(--text-muted)', flexShrink: 0 }}>\n                    ×{cat.count}\n                  </div>\n                </div>\n              )\n            })}\n          </div>\n          \n          {/* Action buttons */}\n          <div style={{ display: 'flex', gap: 12, paddingTop: 16, borderTop: '1px solid var(--border-subtle)' }}>\n            <button onClick={reset} style={{\n              padding: '10px 24px', borderRadius: 10, border: '1px solid var(--border-subtle)',\n              background: 'var(--bg-elevated)', color: 'var(--text-secondary)', cursor: 'pointer',\n              fontSize: 13, fontWeight: 500, display: 'flex', alignItems: 'center', gap: 8,\n            }}>\n              <RefreshCw size={14} /> Import Different File\n            </button>\n            <button onClick={handleImport} style={{\n              padding: '10px 32px', borderRadius: 10, border: 'none',\n              background: 'var(--accent-gold)', color: '#0c0e12', cursor: 'pointer',\n              fontSize: 13, fontWeight: 700, display: 'flex', alignItems: 'center', gap: 8,\n            }}>\n              <Check size={14} /> Import {result.suggestedIncomeStreams.length + result.suggestedExpenses.length} Items\n              <ArrowRight size={14} />\n            </button>\n          </div>\n        </div>\n      )}\n      \n      {/* Stage: Done */}\n      {stage === 'done' && (\n        <div style={{\n          textAlign: 'center', padding: 64,\n          background: 'var(--bg-elevated)', borderRadius: 16,\n          border: '1px solid var(--border-subtle)',\n        }}>\n          <div style={{\n            width: 64, height: 64, borderRadius: '50%', margin: '0 auto 20px',\n            background: 'rgba(16,185,129,0.15)', display: 'flex', alignItems: 'center', justifyContent: 'center',\n          }}>\n            <Check size={32} style={{ color: 'var(--accent-emerald)' }} />\n          </div>\n          <div style={{ fontSize: 22, fontWeight: 700, color: 'var(--text-primary)', marginBottom: 8 }}>\n            Import Complete\n          </div>\n          <div style={{ fontSize: 14, color: 'var(--text-muted)', marginBottom: 24 }}>\n            {importedCount} items added to your financial profile\n          </div>\n          <div style={{ display: 'flex', gap: 12, justifyContent: 'center' }}>\n            <button onClick={reset} style={{\n              padding: '10px 24px', borderRadius: 10, border: '1px solid var(--border-subtle)',\n              background: 'var(--bg-elevated)', color: 'var(--text-secondary)', cursor: 'pointer',\n              fontSize: 13, fontWeight: 500,\n            }}>\n              Import More Data\n            </button>\n          </div>\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\DataManager.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'setState' is assigned a value but never used.","line":10,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":26},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":79,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":79,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3021,3024],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3021,3024],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":89,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3347,3350],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3347,3350],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":93,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":93,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3488,3491],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3488,3491],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":105,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":105,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3904,3907],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3904,3907],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { Storage, type FortunaExport } from '../engine/storage'\nimport {\n  Download, Upload, Trash2, HardDrive, Shield,\n  CheckCircle, AlertTriangle, XCircle, RefreshCw, Copy, Info,\n} from 'lucide-react'\n\nexport function DataManager() {\n  const { state, setState, storageBackend } = useFortuna()\n  const [storageSize, setStorageSize] = useState('...')\n  const [exportStatus, setExportStatus] = useState<'idle' | 'success' | 'error'>('idle')\n  const [importStatus, setImportStatus] = useState<{ state: 'idle' | 'success' | 'error' | 'confirm'; message?: string }>({ state: 'idle' })\n  const [resetConfirm, setResetConfirm] = useState(false)\n  const [resetDone, setResetDone] = useState(false)\n  const fileInputRef = useRef<HTMLInputElement>(null)\n\n  useEffect(() => {\n    Storage.estimateSize().then(s => setStorageSize(s.formatted))\n  }, [state])\n\n  // ---- Export ----\n  const handleExport = async () => {\n    try {\n      const data = await Storage.exportAll()\n      const json = JSON.stringify(data, null, 2)\n      const blob = new Blob([json], { type: 'application/json' })\n      const url = URL.createObjectURL(blob)\n      const a = document.createElement('a')\n      const dateStr = new Date().toISOString().slice(0, 10)\n      a.href = url\n      a.download = `fortuna-backup-${dateStr}.json`\n      a.click()\n      URL.revokeObjectURL(url)\n      setExportStatus('success')\n      setTimeout(() => setExportStatus('idle'), 3000)\n    } catch {\n      setExportStatus('error')\n      setTimeout(() => setExportStatus('idle'), 3000)\n    }\n  }\n\n  // ---- Copy to clipboard ----\n  const handleCopyExport = async () => {\n    try {\n      const data = await Storage.exportAll()\n      await navigator.clipboard.writeText(JSON.stringify(data, null, 2))\n      setExportStatus('success')\n      setTimeout(() => setExportStatus('idle'), 3000)\n    } catch {\n      setExportStatus('error')\n      setTimeout(() => setExportStatus('idle'), 3000)\n    }\n  }\n\n  // ---- Import ----\n  const handleImportClick = () => {\n    fileInputRef.current?.click()\n  }\n\n  const handleFileSelected = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0]\n    if (!file) return\n\n    try {\n      const text = await file.text()\n      const validation = Storage.validateExport(text)\n      if (!validation.valid || !validation.data) {\n        setImportStatus({ state: 'error', message: validation.error || 'Invalid file' })\n        setTimeout(() => setImportStatus({ state: 'idle' }), 5000)\n        return\n      }\n      // Show confirmation with summary\n      const d = validation.data\n      const summary = `${d.state.profile.name || 'Unnamed'} | ${d.state.incomeStreams.length} streams | ${d.state.expenses.length} expenses | v${d._version} from ${new Date(d._exportedAt).toLocaleDateString()}`\n      setImportStatus({ state: 'confirm', message: summary })\n\n      // Store the data temporarily for confirm\n      ;(window as any).__fortuna_pending_import = validation.data\n    } catch {\n      setImportStatus({ state: 'error', message: 'Could not read file' })\n      setTimeout(() => setImportStatus({ state: 'idle' }), 5000)\n    }\n    // Reset file input\n    e.target.value = ''\n  }\n\n  const confirmImport = async () => {\n    const data = (window as any).__fortuna_pending_import as FortunaExport\n    if (!data) return\n\n    const result = await Storage.importAll(data)\n    delete (window as any).__fortuna_pending_import\n\n    if (result.success) {\n      setImportStatus({ state: 'success', message: 'Data restored successfully. Reloading...' })\n      setTimeout(() => window.location.reload(), 1500)\n    } else {\n      setImportStatus({ state: 'error', message: result.error })\n      setTimeout(() => setImportStatus({ state: 'idle' }), 5000)\n    }\n  }\n\n  const cancelImport = () => {\n    delete (window as any).__fortuna_pending_import\n    setImportStatus({ state: 'idle' })\n  }\n\n  // ---- Reset ----\n  const handleReset = async () => {\n    if (!resetConfirm) {\n      setResetConfirm(true)\n      return\n    }\n    await Storage.clearAll()\n    setResetDone(true)\n    setResetConfirm(false)\n    setTimeout(() => window.location.reload(), 1500)\n  }\n\n  // ---- Styles ----\n  const card: React.CSSProperties = {\n    background: 'var(--bg-elevated)',\n    border: '1px solid var(--border-subtle)',\n    borderRadius: 14,\n    padding: 24,\n  }\n  const sectionTitle: React.CSSProperties = {\n    fontSize: 13,\n    fontWeight: 600,\n    color: 'var(--text-primary)',\n    marginBottom: 4,\n  }\n  const sectionDesc: React.CSSProperties = {\n    fontSize: 12,\n    color: 'var(--text-muted)',\n    lineHeight: 1.5,\n    marginBottom: 16,\n  }\n  const btn = (color: string, bg: string): React.CSSProperties => ({\n    display: 'inline-flex',\n    alignItems: 'center',\n    gap: 8,\n    padding: '10px 18px',\n    borderRadius: 10,\n    border: '1px solid ' + color + '33',\n    background: bg,\n    color,\n    cursor: 'pointer',\n    fontFamily: 'var(--font-body)',\n    fontSize: 13,\n    fontWeight: 500,\n    transition: 'all 0.2s',\n  })\n  const badge = (bg: string, color: string): React.CSSProperties => ({\n    display: 'inline-flex',\n    alignItems: 'center',\n    gap: 6,\n    padding: '6px 12px',\n    borderRadius: 8,\n    background: bg,\n    color,\n    fontSize: 12,\n    fontWeight: 500,\n  })\n\n  const backendLabel = storageBackend === 'localStorage' ? 'Browser Storage (localStorage)'\n    : storageBackend === 'windowStorage' ? 'Artifact Storage (window.storage)'\n    : 'No persistent storage available'\n  const backendColor = storageBackend === 'localStorage' ? 'var(--accent-emerald)'\n    : storageBackend === 'windowStorage' ? 'var(--accent-gold)'\n    : 'var(--accent-red)'\n\n  return (\n    <div style={{ padding: '32px 40px', maxWidth: 860 }}>\n      {/* Header */}\n      <div style={{ marginBottom: 32 }}>\n        <h1 style={{ fontFamily: 'var(--font-display)', fontSize: 26, color: 'var(--text-primary)', marginBottom: 6 }}>\n          Data Manager\n        </h1>\n        <p style={{ fontSize: 13, color: 'var(--text-muted)', lineHeight: 1.6 }}>\n          Backup, restore, and manage your Fortuna financial data. Your data persists automatically\n          between sessions — use this page to create portable backups or transfer data between devices.\n        </p>\n      </div>\n\n      <div style={{ display: 'flex', flexDirection: 'column', gap: 20 }}>\n\n        {/* Storage Status */}\n        <div style={card}>\n          <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 16 }}>\n            <HardDrive size={18} color=\"var(--accent-gold)\" />\n            <span style={sectionTitle}>Storage Status</span>\n          </div>\n          <div style={{ display: 'flex', flexWrap: 'wrap', gap: 12 }}>\n            <div style={badge(backendColor + '18', backendColor)}>\n              {storageBackend !== 'none' ? <CheckCircle size={14} /> : <XCircle size={14} />}\n              {backendLabel}\n            </div>\n            <div style={badge('var(--bg-primary)', 'var(--text-secondary)')}>\n              <HardDrive size={14} />\n              {storageSize} used\n            </div>\n            <div style={badge('var(--bg-primary)', 'var(--text-secondary)')}>\n              <Shield size={14} />\n              Schema v{Storage.schemaVersion}\n            </div>\n            <div style={badge('var(--bg-primary)', 'var(--text-secondary)')}>\n              <Info size={14} />\n              App v{Storage.appVersion}\n            </div>\n          </div>\n          {state.onboardingComplete && (\n            <div style={{ marginTop: 16, padding: '12px 16px', background: 'var(--bg-primary)', borderRadius: 10, fontSize: 12, color: 'var(--text-muted)', lineHeight: 1.6 }}>\n              <strong style={{ color: 'var(--text-secondary)' }}>Profile:</strong> {state.profile.name || 'Unnamed'} &nbsp;·&nbsp;\n              <strong style={{ color: 'var(--text-secondary)' }}>Streams:</strong> {state.incomeStreams.length} &nbsp;·&nbsp;\n              <strong style={{ color: 'var(--text-secondary)' }}>Expenses:</strong> {state.expenses.length} &nbsp;·&nbsp;\n              <strong style={{ color: 'var(--text-secondary)' }}>Entities:</strong> {state.entities.length} &nbsp;·&nbsp;\n              <strong style={{ color: 'var(--text-secondary)' }}>Deductions:</strong> {state.deductions.length} &nbsp;·&nbsp;\n              <strong style={{ color: 'var(--text-secondary)' }}>Last saved:</strong> {new Date(state.lastUpdated).toLocaleString()}\n            </div>\n          )}\n        </div>\n\n        {/* Export */}\n        <div style={card}>\n          <div style={sectionTitle}>\n            <Download size={15} style={{ display: 'inline', verticalAlign: -2, marginRight: 8 }} />\n            Export Backup\n          </div>\n          <div style={sectionDesc}>\n            Download a complete snapshot of your financial data, advisor history, and preferences.\n            This file can be imported on any device or after a fresh install.\n          </div>\n          <div style={{ display: 'flex', gap: 10, flexWrap: 'wrap', alignItems: 'center' }}>\n            <button style={btn('var(--accent-emerald)', 'var(--accent-emerald)18')} onClick={handleExport}>\n              <Download size={15} /> Download .json\n            </button>\n            <button style={btn('var(--accent-blue)', 'var(--accent-blue)18')} onClick={handleCopyExport}>\n              <Copy size={15} /> Copy to clipboard\n            </button>\n            {exportStatus === 'success' && (\n              <span style={badge('var(--accent-emerald)18', 'var(--accent-emerald)')}>\n                <CheckCircle size={14} /> Exported\n              </span>\n            )}\n            {exportStatus === 'error' && (\n              <span style={badge('var(--accent-red)18', 'var(--accent-red)')}>\n                <XCircle size={14} /> Export failed\n              </span>\n            )}\n          </div>\n        </div>\n\n        {/* Import */}\n        <div style={card}>\n          <div style={sectionTitle}>\n            <Upload size={15} style={{ display: 'inline', verticalAlign: -2, marginRight: 8 }} />\n            Import / Restore\n          </div>\n          <div style={sectionDesc}>\n            Restore from a Fortuna backup file. Older export versions are automatically migrated\n            to the current schema. This will <strong>replace</strong> all current data.\n          </div>\n\n          <input\n            ref={fileInputRef}\n            type=\"file\"\n            accept=\".json,application/json\"\n            style={{ display: 'none' }}\n            onChange={handleFileSelected}\n          />\n\n          {importStatus.state === 'idle' && (\n            <button style={btn('var(--accent-gold)', 'var(--accent-gold)18')} onClick={handleImportClick}>\n              <Upload size={15} /> Select backup file...\n            </button>\n          )}\n\n          {importStatus.state === 'confirm' && (\n            <div style={{ padding: 16, background: 'var(--accent-gold)10', border: '1px solid var(--accent-gold)33', borderRadius: 10 }}>\n              <div style={{ fontSize: 13, color: 'var(--accent-gold)', fontWeight: 600, marginBottom: 6 }}>\n                <AlertTriangle size={14} style={{ display: 'inline', verticalAlign: -2, marginRight: 6 }} />\n                Confirm Restore\n              </div>\n              <div style={{ fontSize: 12, color: 'var(--text-secondary)', marginBottom: 12, lineHeight: 1.5 }}>\n                This will replace all current data with: <strong>{importStatus.message}</strong>\n              </div>\n              <div style={{ display: 'flex', gap: 10 }}>\n                <button style={btn('var(--accent-gold)', 'var(--accent-gold)22')} onClick={confirmImport}>\n                  <RefreshCw size={14} /> Yes, restore\n                </button>\n                <button style={btn('var(--text-muted)', 'transparent')} onClick={cancelImport}>\n                  Cancel\n                </button>\n              </div>\n            </div>\n          )}\n\n          {importStatus.state === 'success' && (\n            <div style={badge('var(--accent-emerald)18', 'var(--accent-emerald)')}>\n              <CheckCircle size={14} /> {importStatus.message}\n            </div>\n          )}\n\n          {importStatus.state === 'error' && (\n            <div style={badge('var(--accent-red)18', 'var(--accent-red)')}>\n              <XCircle size={14} /> {importStatus.message}\n            </div>\n          )}\n        </div>\n\n        {/* Persistence Info */}\n        <div style={{ ...card, background: 'var(--bg-primary)', border: '1px dashed var(--border-subtle)' }}>\n          <div style={sectionTitle}>\n            <Shield size={15} style={{ display: 'inline', verticalAlign: -2, marginRight: 8 }} />\n            How Persistence Works\n          </div>\n          <div style={{ fontSize: 12, color: 'var(--text-muted)', lineHeight: 1.8 }}>\n            <p style={{ margin: '0 0 8px' }}>\n              Fortuna automatically saves your data to <strong style={{ color: 'var(--text-secondary)' }}>browser localStorage</strong> after every change.\n              Your data stays even after closing the tab, restarting the browser, or updating to a new build.\n            </p>\n            <p style={{ margin: '0 0 8px' }}>\n              <strong style={{ color: 'var(--text-secondary)' }}>Schema migrations</strong> run automatically when a new build introduces data structure changes —\n              your existing data is preserved and upgraded seamlessly.\n            </p>\n            <p style={{ margin: 0 }}>\n              <strong style={{ color: 'var(--accent-gold)' }}>Recommendation:</strong> Export a backup periodically or before clearing browser data.\n              Fortuna data is local to this browser — it does not sync across devices without export/import.\n            </p>\n          </div>\n        </div>\n\n        {/* Danger Zone */}\n        <div style={{ ...card, borderColor: 'var(--accent-red)33' }}>\n          <div style={{ ...sectionTitle, color: 'var(--accent-red)' }}>\n            <Trash2 size={15} style={{ display: 'inline', verticalAlign: -2, marginRight: 8 }} />\n            Danger Zone\n          </div>\n          <div style={sectionDesc}>\n            Permanently delete all Fortuna data from this browser. This cannot be undone\n            unless you have an exported backup.\n          </div>\n\n          {resetDone ? (\n            <div style={badge('var(--accent-red)18', 'var(--accent-red)')}>\n              <Trash2 size={14} /> Data cleared. Reloading...\n            </div>\n          ) : resetConfirm ? (\n            <div style={{ padding: 16, background: 'var(--accent-red)10', border: '1px solid var(--accent-red)33', borderRadius: 10 }}>\n              <div style={{ fontSize: 13, color: 'var(--accent-red)', fontWeight: 600, marginBottom: 8 }}>\n                Are you absolutely sure?\n              </div>\n              <div style={{ fontSize: 12, color: 'var(--text-secondary)', marginBottom: 12 }}>\n                All financial data, strategies, preferences, and advisor history will be permanently deleted.\n              </div>\n              <div style={{ display: 'flex', gap: 10 }}>\n                <button\n                  style={{ ...btn('white', 'var(--accent-red)'), border: 'none' }}\n                  onClick={handleReset}\n                >\n                  <Trash2 size={14} /> Delete everything\n                </button>\n                <button style={btn('var(--text-muted)', 'transparent')} onClick={() => setResetConfirm(false)}>\n                  Cancel\n                </button>\n              </div>\n            </div>\n          ) : (\n            <button style={btn('var(--accent-red)', 'transparent')} onClick={handleReset}>\n              <Trash2 size={15} /> Reset all data...\n            </button>\n          )}\n        </div>\n\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\DataSetup.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ArrowRight' is defined but never used.","line":7,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":41,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ArrowRight"},"fix":{"range":[527,539],"text":""},"desc":"Remove unused variable \"ArrowRight\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AlertTriangle' is defined but never used.","line":8,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":47,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AlertTriangle"},"fix":{"range":[589,604],"text":""},"desc":"Remove unused variable \"AlertTriangle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Target' is defined but never used.","line":8,"column":54,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":60,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Target"},"fix":{"range":[609,617],"text":""},"desc":"Remove unused variable \"Target\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'hasEntities' is assigned a value but never used.","line":212,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":212,"endColumn":20},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":445,"column":144,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":445,"endColumn":147,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24893,24896],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24893,24896],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":479,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":479,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27234,27237],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27234,27237],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":479,"column":96,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":479,"endColumn":99,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[27268,27271],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[27268,27271],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":498,"column":76,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":498,"endColumn":79,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[28360,28363],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[28360,28363],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":498,"column":110,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":498,"endColumn":113,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[28394,28397],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[28394,28397],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":548,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":548,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[31957,31960],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[31957,31960],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":728,"column":163,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":728,"endColumn":166,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[46889,46892],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[46889,46892],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":981,"column":173,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":981,"endColumn":176,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[63444,63447],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[63444,63447],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":12,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from 'react'\nimport { useFortuna, genId } from '../hooks/useFortuna'\nimport type { IncomeStream, BusinessExpense, LegalEntity, Deduction, FinancialProfile } from '../engine/storage'\nimport { STATE_TAX_RATES, calculateSelfEmploymentTax, calculateSCorpSavings, calculateMaxSEPIRA, calculateMaxSolo401k, calculateFederalIncomeTax, calculateStateTax, calculateQBIDeduction } from '../engine/tax-calculator'\nimport {\n  User, DollarSign, Building2, Receipt, ChevronRight, ChevronLeft,\n  Plus, Trash2, CheckCircle2, ArrowRight, Sparkles, Edit3,\n  Lightbulb, TrendingUp, Shield, AlertTriangle, Zap, Target, PiggyBank, Calculator,\n} from 'lucide-react'\n\nconst STEPS = ['Profile', 'Income', 'Entities', 'Expenses', 'Deductions', 'Review']\nconst INCOME_TYPES = ['business', 'w2', 'freelance', 'investment', 'rental', 'passive', 'other'] as const\nconst ENTITY_TYPES = ['sole_prop', 'llc', 'llc_scorp', 'scorp', 'ccorp', 'partnership', 'trust'] as const\nconst DEDUCTION_CATS = ['home_office', 'vehicle', 'retirement', 'health', 'education', 'charitable', 'business', 'other'] as const\n\n// ─── Deduction Templates ──────────────────────────────────────────────\n\ninterface DeductionTemplate {\n  id: string\n  label: string\n  emoji: string\n  items: Omit<Deduction, 'id'>[]\n}\n\nconst DEDUCTION_TEMPLATES: DeductionTemplate[] = [\n  {\n    id: 'self-employed',\n    label: 'Self-Employed',\n    emoji: '🏢',\n    items: [\n      { name: 'SEP-IRA contribution', category: 'retirement', amount: 0, isItemized: false },\n      { name: 'Solo 401(k) employee deferral', category: 'retirement', amount: 0, isItemized: false },\n      { name: 'Solo 401(k) employer contribution', category: 'retirement', amount: 0, isItemized: false },\n      { name: 'SE health insurance premiums', category: 'health', amount: 0, isItemized: false },\n      { name: 'SE tax deduction (50% of SE tax)', category: 'business', amount: 0, isItemized: false },\n      { name: 'Qualified Business Income (QBI) deduction', category: 'business', amount: 0, isItemized: false },\n    ],\n  },\n  {\n    id: 'w2-itemized',\n    label: 'W-2 Itemized',\n    emoji: '💼',\n    items: [\n      { name: 'Traditional IRA contribution', category: 'retirement', amount: 0, isItemized: false },\n      { name: 'Roth IRA contribution', category: 'retirement', amount: 0, isItemized: false, notes: 'Not deductible but tracks contribution for planning' },\n      { name: 'HSA contribution', category: 'health', amount: 0, isItemized: false },\n      { name: 'Mortgage interest', category: 'other', amount: 0, isItemized: true },\n      { name: 'State & local taxes (SALT)', category: 'other', amount: 0, isItemized: true, notes: 'Capped at $10,000' },\n      { name: 'Charitable donations (cash)', category: 'charitable', amount: 0, isItemized: true },\n      { name: 'Charitable donations (non-cash)', category: 'charitable', amount: 0, isItemized: true },\n    ],\n  },\n  {\n    id: 'student-educator',\n    label: 'Student / Educator',\n    emoji: '📚',\n    items: [\n      { name: 'Student loan interest', category: 'education', amount: 0, isItemized: false, notes: 'Up to $2,500 above-the-line' },\n      { name: 'Educator expenses', category: 'education', amount: 0, isItemized: false, notes: 'Up to $300 for K-12 educators' },\n      { name: 'Tuition & fees', category: 'education', amount: 0, isItemized: false },\n    ],\n  },\n]\n\n// ─── Expense Templates ────────────────────────────────────────────────\n\ninterface ExpenseTemplate {\n  id: string\n  label: string\n  description: string\n  emoji: string\n  items: Omit<BusinessExpense, 'id'>[]\n}\n\nconst EXPENSE_TEMPLATES: ExpenseTemplate[] = [\n  {\n    id: 'w2-individual',\n    label: 'W-2 Employee',\n    description: 'Standard employee with wage income',\n    emoji: '💼',\n    items: [\n      { category: 'education', description: 'Professional development / courses', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n      { category: 'business', description: 'Union dues / professional memberships', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n      { category: 'business', description: 'Work tools & supplies (unreimbursed)', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n    ],\n  },\n  {\n    id: 'single-llc',\n    label: 'Single-Member LLC',\n    description: 'Schedule C business expenses',\n    emoji: '🏢',\n    items: [\n      { category: 'home_office', description: 'Home office (simplified: $5/sqft × sqft)', annualAmount: 1500, isDeductible: true, deductionPct: 100 },\n      { category: 'business', description: 'Internet service', annualAmount: 1200, isDeductible: true, deductionPct: 50 },\n      { category: 'business', description: 'Cell phone', annualAmount: 1200, isDeductible: true, deductionPct: 40 },\n      { category: 'business', description: 'Software & SaaS subscriptions', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n      { category: 'business', description: 'Professional services (CPA, legal)', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n      { category: 'business', description: 'Business insurance (liability, E&O)', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n      { category: 'business', description: 'Marketing & advertising', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n      { category: 'business', description: 'Office supplies & equipment', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n      { category: 'vehicle', description: 'Vehicle / mileage (business use)', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n      { category: 'business', description: 'Business meals', annualAmount: 0, isDeductible: true, deductionPct: 50 },\n      { category: 'business', description: 'Travel (flights, hotels, transport)', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n      { category: 'education', description: 'Education & training / conferences', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n      { category: 'health', description: 'Health insurance premiums (SE deduction)', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n      { category: 'business', description: 'Bank & payment processing fees', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n      { category: 'business', description: 'Contractor / subcontractor payments', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n    ],\n  },\n  {\n    id: 'multi-llc',\n    label: 'Multi-Member LLC Partner',\n    description: 'Unreimbursed partner expenses',\n    emoji: '🤝',\n    items: [\n      { category: 'home_office', description: 'Home office (partnership use)', annualAmount: 1500, isDeductible: true, deductionPct: 100 },\n      { category: 'business', description: 'Internet service (partnership use)', annualAmount: 1200, isDeductible: true, deductionPct: 50 },\n      { category: 'business', description: 'Cell phone (partnership use)', annualAmount: 1200, isDeductible: true, deductionPct: 40 },\n      { category: 'business', description: 'Unreimbursed partner expenses (UPE)', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n      { category: 'vehicle', description: 'Vehicle / mileage (partnership business)', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n      { category: 'business', description: 'Professional services (CPA, legal)', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n      { category: 'business', description: 'Travel for partnership business', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n      { category: 'education', description: 'Education & training (partnership role)', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n    ],\n  },\n  {\n    id: 'combined',\n    label: 'W-2 + LLC Owner',\n    description: 'Employee with side business',\n    emoji: '⚡',\n    items: [\n      { category: 'home_office', description: 'Home office (business use)', annualAmount: 1500, isDeductible: true, deductionPct: 100 },\n      { category: 'business', description: 'Internet service', annualAmount: 1200, isDeductible: true, deductionPct: 50 },\n      { category: 'business', description: 'Cell phone', annualAmount: 1200, isDeductible: true, deductionPct: 40 },\n      { category: 'business', description: 'Software & SaaS subscriptions', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n      { category: 'business', description: 'Professional services (CPA, legal)', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n      { category: 'business', description: 'Business insurance', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n      { category: 'business', description: 'Marketing & advertising', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n      { category: 'business', description: 'Office supplies & equipment', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n      { category: 'vehicle', description: 'Vehicle / mileage (business use only)', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n      { category: 'business', description: 'Business meals', annualAmount: 0, isDeductible: true, deductionPct: 50 },\n      { category: 'health', description: 'Health insurance premiums (if not via employer)', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n      { category: 'business', description: 'Bank & payment processing fees', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n      { category: 'business', description: 'Contractor / subcontractor payments', annualAmount: 0, isDeductible: true, deductionPct: 100 },\n    ],\n  },\n]\n\nconst entityLabels: Record<string, string> = {\n  sole_prop: 'Sole Proprietorship', llc: 'LLC', llc_scorp: 'LLC + S-Corp',\n  scorp: 'S-Corporation', ccorp: 'C-Corporation', partnership: 'Partnership', trust: 'Trust / Estate',\n}\n\nconst inputStyle: React.CSSProperties = {\n  width: '100%', padding: '10px 14px', borderRadius: 8, border: '1px solid var(--border-medium)',\n  background: 'var(--bg-surface)', color: 'var(--text-primary)', fontFamily: 'var(--font-body)',\n  fontSize: 13, outline: 'none',\n}\nconst selectStyle: React.CSSProperties = { ...inputStyle, cursor: 'pointer' }\nconst labelStyle: React.CSSProperties = {\n  fontSize: 12, fontWeight: 500, color: 'var(--text-secondary)', marginBottom: 6, display: 'block',\n}\n\ninterface DataSetupProps {\n  onComplete: () => void\n  editMode?: boolean\n}\n\n// ─── Strategy Hint Component ──────────────────────────────────────────\n\nfunction StrategyHint({ icon, color, title, children }: {\n  icon: JSX.Element; color: string; title: string; children: React.ReactNode\n}) {\n  return (\n    <div style={{\n      padding: '12px 14px', borderRadius: 10, marginBottom: 14,\n      background: `${color}08`, border: `1px solid ${color}18`,\n    }}>\n      <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 6 }}>\n        <div style={{ color, flexShrink: 0 }}>{icon}</div>\n        <div style={{ fontSize: 11, fontWeight: 700, color, textTransform: 'uppercase', letterSpacing: '0.04em' }}>{title}</div>\n      </div>\n      <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.6 }}>{children}</div>\n    </div>\n  )\n}\n\n// ─── Live Strategy Stack Preview ──────────────────────────────────────\n\ninterface StrategyItem {\n  icon: string\n  title: string\n  description: string\n  impact: string\n  color: string\n  priority: 'critical' | 'high' | 'medium' | 'low'\n}\n\nfunction computeStrategyPreview(\n  profile: FinancialProfile,\n  incomes: IncomeStream[],\n  entities: LegalEntity[],\n  expenses: BusinessExpense[],\n  deductions: Deduction[],\n): StrategyItem[] {\n  const strategies: StrategyItem[] = []\n  const totalIncome = incomes.reduce((s, i) => s + i.annualAmount, 0)\n  const businessIncome = incomes.filter(i => i.type === 'business' || i.type === 'freelance').reduce((s, i) => s + i.annualAmount, 0)\n  const w2Income = incomes.filter(i => i.type === 'w2').reduce((s, i) => s + i.annualAmount, 0)\n  const totalExpenses = expenses.filter(e => e.isDeductible).reduce((s, e) => s + (e.annualAmount * e.deductionPct / 100), 0)\n  const netSE = Math.max(0, businessIncome - totalExpenses)\n  const hasEntities = entities.length > 0\n  const hasSCorpEntity = entities.some(e => e.type === 'scorp' || e.type === 'llc_scorp')\n  const retirementDeds = deductions.filter(d => d.category === 'retirement')\n  const totalRetirement = retirementDeds.reduce((s, d) => s + d.amount, 0)\n  const stateRate = STATE_TAX_RATES[profile.state]?.rate || 0\n\n  // S-Corp election analysis\n  if (netSE > 50000 && !hasSCorpEntity) {\n    const savings = calculateSCorpSavings(netSE, profile.state)\n    if (savings.annualSavings > 2000) {\n      strategies.push({\n        icon: '🏛️', title: 'S-Corp Election',\n        description: `Your $${Math.round(netSE).toLocaleString()} net self-employment income is above the S-Corp sweet spot. Electing S-Corp status lets you split income into salary (subject to payroll tax) and distributions (not), reducing self-employment tax significantly.`,\n        impact: `~$${Math.round(savings.annualSavings).toLocaleString()}/yr savings`,\n        color: '#10b981', priority: 'critical',\n      })\n    }\n  }\n\n  // Self-employment tax awareness\n  if (netSE > 0 && !hasSCorpEntity) {\n    const seTax = calculateSelfEmploymentTax(netSE)\n    strategies.push({\n      icon: '💰', title: 'Self-Employment Tax',\n      description: `As a self-employed individual, you pay both the employer and employee portions of FICA — that's 15.3% on the first $176,100 of net earnings. Your estimated SE tax: $${Math.round(seTax.totalSETax).toLocaleString()}. The 50% deduction for the employer half helps, but this is often the biggest surprise for new business owners.`,\n      impact: `$${Math.round(seTax.totalSETax).toLocaleString()} SE tax`,\n      color: '#ef4444', priority: 'high',\n    })\n  }\n\n  // Retirement contribution gaps\n  if (netSE > 30000) {\n    const sepMax = calculateMaxSEPIRA(netSE)\n    const solo = calculateMaxSolo401k(netSE, profile.age)\n    const maxAvailable = Math.max(sepMax, solo.total)\n    if (totalRetirement < maxAvailable * 0.5) {\n      const gap = maxAvailable - totalRetirement\n      const taxSaved = gap * (0.22 + stateRate) // rough marginal rate estimate\n      strategies.push({\n        icon: '🏦', title: 'Retirement Tax Shield',\n        description: `Self-employed retirement accounts (SEP-IRA up to $${Math.round(sepMax).toLocaleString()}, Solo 401(k) up to $${Math.round(solo.total).toLocaleString()}) are the most powerful deduction available to you — every dollar contributed reduces your taxable income dollar-for-dollar. ${totalRetirement > 0 ? `You're contributing $${totalRetirement.toLocaleString()}, but could contribute up to $${Math.round(maxAvailable).toLocaleString()}.` : 'You haven\\'t entered retirement contributions yet — this is likely your single biggest tax-saving opportunity.'}`,\n        impact: `Up to $${Math.round(taxSaved).toLocaleString()} tax saved`,\n        color: '#8b5cf6', priority: totalRetirement === 0 ? 'critical' : 'high',\n      })\n    }\n  } else if (w2Income > 30000) {\n    const has401k = deductions.some(d => d.name.toLowerCase().includes('401k') || d.name.toLowerCase().includes('ira'))\n    if (!has401k) {\n      strategies.push({\n        icon: '🏦', title: 'Retirement Contributions',\n        description: 'If your employer offers a 401(k) match, contributing at least enough to get the full match is essentially free money. Traditional IRA contributions (up to $7,000, or $8,000 if 50+) may also be deductible depending on your income and filing status.',\n        impact: 'Free employer match + tax deduction',\n        color: '#8b5cf6', priority: 'medium',\n      })\n    }\n  }\n\n  // QBI Deduction\n  if (netSE > 0) {\n    const qbi = calculateQBIDeduction(netSE, totalIncome - totalExpenses, profile.filingStatus)\n    if (qbi > 0) {\n      strategies.push({\n        icon: '📋', title: 'QBI Deduction (Section 199A)',\n        description: `As a pass-through business owner, you may qualify for a 20% deduction on qualified business income. Based on your data, that's approximately $${Math.round(qbi).toLocaleString()} — a significant above-the-line deduction that reduces your federal taxable income without itemizing.`,\n        impact: `~$${Math.round(qbi).toLocaleString()} deduction`,\n        color: '#3b82f6', priority: 'high',\n      })\n    }\n  }\n\n  // State tax optimization\n  if (stateRate > 0.05 && totalIncome > 100000) {\n    strategies.push({\n      icon: '🗺️', title: 'State Tax Impact',\n      description: `${STATE_TAX_RATES[profile.state]?.name} has a ${(stateRate * 100).toFixed(1)}% state income tax rate. On $${Math.round(totalIncome).toLocaleString()} income, that's roughly $${Math.round(totalIncome * stateRate).toLocaleString()} in state tax alone. Fortuna's State Arbitrage module can compare your tax burden across all 50 states if relocation is ever on the table.`,\n      impact: `$${Math.round(totalIncome * stateRate).toLocaleString()}/yr state tax`,\n      color: '#f59e0b', priority: 'medium',\n    })\n  } else if (stateRate === 0) {\n    strategies.push({\n      icon: '🗺️', title: 'No State Income Tax',\n      description: `${STATE_TAX_RATES[profile.state]?.name} has no state income tax — that's a significant structural advantage. You're saving thousands compared to high-tax states. Fortuna will still optimize your federal position and look for other opportunities.`,\n      impact: 'Already optimized',\n      color: '#10b981', priority: 'low',\n    })\n  }\n\n  // Multi-entity strategy\n  if (entities.length >= 2) {\n    strategies.push({\n      icon: '🏗️', title: 'Multi-Entity Structure',\n      description: 'Multiple entities create opportunities for income splitting, liability isolation, and tax optimization through management fees, shared services agreements, and strategic allocation of expenses. Fortuna\\'s Entity Design module will analyze whether your current structure is optimal.',\n      impact: 'Structure optimization available',\n      color: '#06b6d4', priority: 'medium',\n    })\n  }\n\n  // Partnership-specific\n  if (entities.some(e => e.type === 'partnership')) {\n    strategies.push({\n      icon: '🤝', title: 'Partnership K-1 Strategy',\n      description: 'As a partner in a multi-member LLC, your distributive share of income is subject to self-employment tax. Key strategies: negotiate guaranteed payments vs. profit distributions, track unreimbursed partner expenses (UPE) carefully, and consider whether the partnership should elect S-Corp status.',\n      impact: 'K-1 optimization available',\n      color: '#ec4899', priority: 'medium',\n    })\n  }\n\n  // Expense completeness check\n  if (businessIncome > 0 && totalExpenses < businessIncome * 0.1) {\n    strategies.push({\n      icon: '🔍', title: 'Expense Gap Detected',\n      description: `Your business expenses ($${Math.round(totalExpenses).toLocaleString()}) are less than 10% of business income ($${Math.round(businessIncome).toLocaleString()}). Most self-employed individuals have deductible expenses of 20-40% of revenue. Common missed deductions: home office, vehicle mileage, professional development, software subscriptions, and the health insurance premium deduction.`,\n      impact: 'Likely missing deductions',\n      color: '#f59e0b', priority: 'high',\n    })\n  }\n\n  // Filing status optimization\n  if (profile.filingStatus === 'single' && profile.dependents > 0) {\n    strategies.push({\n      icon: '👨‍👧', title: 'Head of Household Filing',\n      description: 'You have dependents but are filing Single. If you qualify for Head of Household status (unmarried, paying >50% of household costs, with a qualifying dependent), you get a higher standard deduction ($22,500 vs $15,700) and wider tax brackets. This could save $1,000-3,000+ depending on income.',\n      impact: 'Potential bracket + deduction savings',\n      color: '#10b981', priority: 'critical',\n    })\n  }\n\n  // Estimated tax payments\n  if (netSE > 20000) {\n    strategies.push({\n      icon: '📅', title: 'Quarterly Estimated Taxes',\n      description: 'Self-employment income doesn\\'t have automatic withholding. The IRS expects quarterly estimated payments (1040-ES) due Apr 15, Jun 15, Sep 15, Jan 15. Underpayment triggers penalties. Fortuna tracks deadlines and can generate your 1040-ES vouchers with the correct amounts.',\n      impact: 'Avoid underpayment penalty',\n      color: '#ef4444', priority: 'high',\n    })\n  }\n\n  // Sort by priority\n  const priorityOrder = { critical: 0, high: 1, medium: 2, low: 3 }\n  return strategies.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority])\n}\n\nexport function DataSetup({ onComplete, editMode }: DataSetupProps) {\n  const { state, updateState, save } = useFortuna()\n  const [step, setStep] = useState(0)\n  const [profile, setProfile] = useState<FinancialProfile>({ ...state.profile })\n  const [incomes, setIncomes] = useState<IncomeStream[]>(\n    state.incomeStreams.length > 0 ? [...state.incomeStreams] : []\n  )\n  const [entities, setEntities] = useState<LegalEntity[]>(\n    state.entities.length > 0 ? [...state.entities] : []\n  )\n  const [expenses, setExpenses] = useState<BusinessExpense[]>(\n    state.expenses.length > 0 ? [...state.expenses] : []\n  )\n  const [deductions, setDeductions] = useState<Deduction[]>(\n    state.deductions.length > 0 ? [...state.deductions] : []\n  )\n\n  const handleFinish = async () => {\n    updateState(prev => ({\n      ...prev,\n      profile,\n      incomeStreams: incomes,\n      entities,\n      expenses,\n      deductions,\n      onboardingComplete: true,\n    }))\n    setTimeout(async () => {\n      await save()\n      onComplete()\n    }, 100)\n  }\n\n  const addIncome = () => setIncomes(prev => [...prev, {\n    id: genId(), name: '', type: 'business', annualAmount: 0, isActive: true,\n  }])\n  const addEntity = () => setEntities(prev => [...prev, {\n    id: genId(), name: '', type: 'llc', state: profile.state, annualCost: 0, isActive: true,\n  }])\n  const addExpense = () => setExpenses(prev => [...prev, {\n    id: genId(), category: 'business', description: '', annualAmount: 0, isDeductible: true, deductionPct: 100,\n  }])\n\n  const applyExpenseTemplate = (template: ExpenseTemplate) => {\n    const newExpenses = template.items.map(item => ({\n      ...item,\n      id: genId(),\n    }))\n    // Merge: add template items that don't already exist (by description match)\n    const existingDescs = new Set(expenses.map(e => e.description.toLowerCase()))\n    const toAdd = newExpenses.filter(e => !existingDescs.has(e.description.toLowerCase()))\n    if (toAdd.length === 0) return // all already present\n    setExpenses(prev => [...prev, ...toAdd])\n  }\n  const addDeduction = () => setDeductions(prev => [...prev, {\n    id: genId(), name: '', category: 'business', amount: 0, isItemized: false,\n  }])\n\n  const applyDeductionTemplate = (template: DeductionTemplate) => {\n    const newDeds = template.items.map(item => ({ ...item, id: genId() }))\n    const existingNames = new Set(deductions.map(d => d.name.toLowerCase()))\n    const toAdd = newDeds.filter(d => !existingNames.has(d.name.toLowerCase()))\n    if (toAdd.length === 0) return\n    setDeductions(prev => [...prev, ...toAdd])\n  }\n\n  const renderStep = () => {\n    switch (step) {\n      case 0: return (\n        <div style={{ display: 'flex', flexDirection: 'column', gap: 20 }}>\n          <StrategyHint icon={<Lightbulb size={14} />} color=\"#f59e0b\" title=\"Why This Matters\">\n            Your state, filing status, and age directly control which tax brackets, deductions, and strategies apply to you.\n            For example, <strong>filing status</strong> determines your standard deduction ($15,700 single vs. $31,400 MFJ for 2025)\n            and bracket widths. <strong>State</strong> determines whether you pay 0% or 13%+ in state income tax.\n            <strong> Age</strong> affects retirement contribution limits (catch-up provisions at 50+). Get these right and everything downstream is accurate.\n          </StrategyHint>\n          <div className=\"grid-2\" style={{ gap: 16 }}>\n            <div>\n              <label style={labelStyle}>Full Name</label>\n              <input style={inputStyle} value={profile.name} onChange={e => setProfile(p => ({ ...p, name: e.target.value }))} placeholder=\"Your name\" />\n            </div>\n            <div>\n              <label style={labelStyle}>State</label>\n              <select style={selectStyle} value={profile.state} onChange={e => setProfile(p => ({ ...p, state: e.target.value }))}>\n                {Object.entries(STATE_TAX_RATES).sort((a, b) => a[1].name.localeCompare(b[1].name)).map(([code, s]) => (\n                  <option key={code} value={code}>{s.name} ({(s.rate * 100).toFixed(1)}%)</option>\n                ))}\n              </select>\n            </div>\n            <div>\n              <label style={labelStyle}>Filing Status</label>\n              <select style={selectStyle} value={profile.filingStatus} onChange={e => setProfile(p => ({ ...p, filingStatus: e.target.value as any }))}>\n                <option value=\"single\">Single</option>\n                <option value=\"married_joint\">Married Filing Jointly</option>\n                <option value=\"married_separate\">Married Filing Separately</option>\n                <option value=\"head_of_household\">Head of Household</option>\n              </select>\n            </div>\n            <div>\n              <label style={labelStyle}>Age</label>\n              <input style={inputStyle} type=\"number\" value={profile.age} onChange={e => setProfile(p => ({ ...p, age: parseInt(e.target.value) || 0 }))} />\n            </div>\n            <div>\n              <label style={labelStyle}>Dependents</label>\n              <input style={inputStyle} type=\"number\" min={0} value={profile.dependents} onChange={e => setProfile(p => ({ ...p, dependents: parseInt(e.target.value) || 0 }))} />\n            </div>\n            <div>\n              <label style={labelStyle}>Health Insurance</label>\n              <select style={selectStyle} value={profile.hasHealthInsurance ? 'yes' : 'no'} onChange={e => setProfile(p => ({ ...p, hasHealthInsurance: e.target.value === 'yes' }))}>\n                <option value=\"yes\">Yes</option>\n                <option value=\"no\">No</option>\n              </select>\n            </div>\n          </div>\n          {/* Spouse section for joint/separate filers */}\n          {(profile.filingStatus === 'married_joint' || profile.filingStatus === 'married_separate') && (\n            <div style={{ marginTop: 20, padding: 16, background: 'var(--bg-surface)', borderRadius: 10, border: '1px solid var(--border-subtle)' }}>\n              <div style={{ fontSize: 13, fontWeight: 600, marginBottom: 12, display: 'flex', alignItems: 'center', gap: 8 }}>\n                <span style={{ width: 20, height: 20, borderRadius: 6, background: 'rgba(167,139,250,0.15)', display: 'inline-flex', alignItems: 'center', justifyContent: 'center', fontSize: 11 }}>👤</span>\n                Spouse Information\n                <span style={{ fontWeight: 400, color: 'var(--text-muted)', fontSize: 11 }}>— for accurate joint return calculations</span>\n              </div>\n              <div className=\"grid-2\" style={{ gap: 12 }}>\n                <div>\n                  <label style={labelStyle}>Spouse Name</label>\n                  <input style={inputStyle} value={(state as any).household?.members?.find((m: any) => m.role === 'spouse')?.name || ''} placeholder=\"Spouse name\" onChange={e => {\n                    const name = e.target.value\n                    updateState(prev => {\n                      const h = prev.household || { members: [{ id: 'primary', name: prev.profile.name, role: 'primary' as const }], dependents: [], filingStatus: prev.profile.filingStatus }\n                      const hasSpouse = h.members.some(m => m.role === 'spouse')\n                      return {\n                        ...prev,\n                        household: {\n                          ...h,\n                          members: hasSpouse\n                            ? h.members.map(m => m.role === 'spouse' ? { ...m, name } : m)\n                            : [...h.members, { id: 'spouse', name, role: 'spouse' as const }],\n                        },\n                      }\n                    })\n                  }} />\n                </div>\n                <div>\n                  <label style={labelStyle}>Spouse Age</label>\n                  <input style={inputStyle} type=\"number\" value={(state as any).household?.members?.find((m: any) => m.role === 'spouse')?.age || ''} placeholder=\"Age\" onChange={e => {\n                    const age = parseInt(e.target.value) || 0\n                    updateState(prev => {\n                      const h = prev.household || { members: [{ id: 'primary', name: prev.profile.name, role: 'primary' as const }], dependents: [], filingStatus: prev.profile.filingStatus }\n                      return {\n                        ...prev,\n                        household: {\n                          ...h,\n                          members: h.members.map(m => m.role === 'spouse' ? { ...m, dateOfBirth: `${new Date().getFullYear() - age}-01-01` } : m),\n                        },\n                      }\n                    })\n                  }} />\n                </div>\n              </div>\n              <p style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 8 }}>\n                Add spouse W-2 and income in the Income tab — mark them as belonging to your spouse.\n              </p>\n            </div>\n          )}\n        </div>\n      )\n\n      case 1: return (\n        <div>\n          <StrategyHint icon={<TrendingUp size={14} />} color=\"#3b82f6\" title=\"The Strategic Stack: How Income Type Drives Your Tax Strategy\">\n            Not all income is taxed the same. <strong>W-2 wages</strong> have payroll taxes split with your employer, withholding handled automatically, but limited deduction options.\n            <strong> Business / freelance income</strong> (Schedule C) is subject to 15.3% self-employment tax on top of income tax — but you unlock the full range of business deductions, QBI deduction (20% of qualified income), and self-employed retirement accounts.\n            <strong> Investment income</strong> may qualify for lower capital gains rates. <strong>Rental income</strong> has unique depreciation advantages.\n            Adding each income type helps Fortuna build your complete strategic stack.\n          </StrategyHint>\n          <p style={{ fontSize: 13, color: 'var(--text-muted)', marginBottom: 16 }}>Add all income sources — W-2 jobs, businesses, freelance, investments, etc.</p>\n          {incomes.map((inc, i) => (\n            <div key={inc.id} style={{ background: 'var(--bg-surface)', borderRadius: 10, padding: 16, marginBottom: 12, border: '1px solid var(--border-subtle)' }}>\n              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 12 }}>\n                <span style={{ fontSize: 13, fontWeight: 500 }}>\n                  {inc.type === 'w2' ? '💼 W-2 Employment' : `Income Stream #${i + 1}`}\n                </span>\n                <button onClick={() => setIncomes(prev => prev.filter(x => x.id !== inc.id))} style={{ background: 'none', border: 'none', color: 'var(--accent-red)', cursor: 'pointer' }}>\n                  <Trash2 size={14} />\n                </button>\n              </div>\n              <div className=\"grid-3\" style={{ gap: 12 }}>\n                <div>\n                  <label style={labelStyle}>{inc.type === 'w2' ? 'Employer / Job Title' : 'Name'}</label>\n                  <input style={inputStyle} value={inc.name} placeholder={inc.type === 'w2' ? 'e.g. Acme Corp — Software Engineer' : 'e.g. Web Dev Business'} onChange={e => setIncomes(prev => prev.map(x => x.id === inc.id ? { ...x, name: e.target.value } : x))} />\n                </div>\n                <div>\n                  <label style={labelStyle}>Type</label>\n                  <select style={selectStyle} value={inc.type} onChange={e => {\n                    const newType = e.target.value as any\n                    setIncomes(prev => prev.map(x => x.id === inc.id ? {\n                      ...x, type: newType,\n                      // Initialize W-2 sub-object when switching to w2\n                      w2: newType === 'w2' ? (x.w2 || {}) : x.w2,\n                      entityId: newType === 'w2' ? undefined : x.entityId, // W-2 never assigned to entity\n                    } : x))\n                  }}>\n                    {INCOME_TYPES.map(t => <option key={t} value={t}>\n                      {t === 'w2' ? 'W-2 Employment' : t.charAt(0).toUpperCase() + t.slice(1).replace('_', ' ')}\n                    </option>)}\n                  </select>\n                </div>\n                <div>\n                  <label style={labelStyle}>{inc.type === 'w2' ? 'Annual Wages (Box 1)' : 'Annual Amount ($)'}</label>\n                  <input style={inputStyle} type=\"number\" value={inc.annualAmount || ''} placeholder=\"0\" onChange={e => setIncomes(prev => prev.map(x => x.id === inc.id ? { ...x, annualAmount: parseFloat(e.target.value) || 0 } : x))} />\n                </div>\n              </div>\n              {/* Entity assignment (non-W2 income only) */}\n              {inc.type !== 'w2' && entities.length > 0 && (\n                <div style={{ marginTop: 8 }}>\n                  <label style={labelStyle}>Belongs to</label>\n                  <select style={{ ...selectStyle, maxWidth: 260 }} value={inc.entityId || 'personal'} onChange={e => setIncomes(prev => prev.map(x => x.id === inc.id ? { ...x, entityId: e.target.value === 'personal' ? undefined : e.target.value } : x))}>\n                    <option value=\"personal\">Personal (no entity)</option>\n                    {entities.filter(e => e.isActive).map(e => <option key={e.id} value={e.id}>{e.name} ({e.type.replace('_', ' ')})</option>)}\n                  </select>\n                </div>\n              )}\n\n              {/* W-2 Specific Fields */}\n              {inc.type === 'w2' && (\n                <div style={{ marginTop: 12 }}>\n                  <div style={{ fontSize: 11, color: 'var(--accent-blue)', fontWeight: 500, marginBottom: 8, display: 'flex', alignItems: 'center', gap: 6 }}>\n                    <span style={{ width: 16, height: 16, borderRadius: 4, background: 'rgba(96,165,250,0.15)', display: 'inline-flex', alignItems: 'center', justifyContent: 'center', fontSize: 9 }}>📋</span>\n                    W-2 Details <span style={{ color: 'var(--text-muted)', fontWeight: 400 }}>— for accurate tax picture (optional)</span>\n                  </div>\n\n                  {/* Row 1: Gross salary + employer name */}\n                  <div className=\"grid-2\" style={{ gap: 10, marginBottom: 8 }}>\n                    <div>\n                      <label style={{ ...labelStyle, fontSize: 11 }}>Gross Salary (total comp)</label>\n                      <input style={{ ...inputStyle, fontSize: 12 }} type=\"number\" value={inc.w2?.grossSalary || ''} placeholder={inc.annualAmount ? String(inc.annualAmount) : 'Before pre-tax deductions'}\n                        onChange={e => setIncomes(prev => prev.map(x => x.id === inc.id ? { ...x, w2: { ...x.w2, grossSalary: parseFloat(e.target.value) || 0 } } : x))} />\n                    </div>\n                    <div>\n                      <label style={{ ...labelStyle, fontSize: 11 }}>Employer Name</label>\n                      <input style={{ ...inputStyle, fontSize: 12 }} value={inc.w2?.employerName || ''} placeholder=\"Company name\"\n                        onChange={e => setIncomes(prev => prev.map(x => x.id === inc.id ? { ...x, w2: { ...x.w2, employerName: e.target.value } } : x))} />\n                    </div>\n                  </div>\n\n                  {/* Row 2: Withholding */}\n                  <div className=\"grid-3\" style={{ gap: 10, marginBottom: 8 }}>\n                    <div>\n                      <label style={{ ...labelStyle, fontSize: 11 }}>Federal Withheld</label>\n                      <input style={{ ...inputStyle, fontSize: 12 }} type=\"number\" value={inc.w2?.federalWithholding || ''} placeholder=\"Box 2\"\n                        onChange={e => setIncomes(prev => prev.map(x => x.id === inc.id ? { ...x, w2: { ...x.w2, federalWithholding: parseFloat(e.target.value) || 0 } } : x))} />\n                    </div>\n                    <div>\n                      <label style={{ ...labelStyle, fontSize: 11 }}>State Withheld</label>\n                      <input style={{ ...inputStyle, fontSize: 12 }} type=\"number\" value={inc.w2?.stateWithholding || ''} placeholder=\"Box 17\"\n                        onChange={e => setIncomes(prev => prev.map(x => x.id === inc.id ? { ...x, w2: { ...x.w2, stateWithholding: parseFloat(e.target.value) || 0 } } : x))} />\n                    </div>\n                    <div>\n                      <label style={{ ...labelStyle, fontSize: 11 }}>FICA Withheld</label>\n                      <input style={{ ...inputStyle, fontSize: 12 }} type=\"number\" value={inc.w2?.ficaWithheld || ''} placeholder={inc.annualAmount ? `~${Math.round(inc.annualAmount * 0.0765).toLocaleString()}` : 'Box 4+6'}\n                        onChange={e => setIncomes(prev => prev.map(x => x.id === inc.id ? { ...x, w2: { ...x.w2, ficaWithheld: parseFloat(e.target.value) || 0 } } : x))} />\n                    </div>\n                  </div>\n\n                  {/* Row 3: Pre-tax deductions */}\n                  <div className=\"grid-4\" style={{ gap: 10 }}>\n                    <div>\n                      <label style={{ ...labelStyle, fontSize: 11 }}>401(k) Pre-tax</label>\n                      <input style={{ ...inputStyle, fontSize: 12 }} type=\"number\" value={inc.w2?.pretax401k || ''} placeholder=\"0\"\n                        onChange={e => setIncomes(prev => prev.map(x => x.id === inc.id ? { ...x, w2: { ...x.w2, pretax401k: parseFloat(e.target.value) || 0 } } : x))} />\n                    </div>\n                    <div>\n                      <label style={{ ...labelStyle, fontSize: 11 }}>Health Ins.</label>\n                      <input style={{ ...inputStyle, fontSize: 12 }} type=\"number\" value={inc.w2?.pretaxHealthInsurance || ''} placeholder=\"0\"\n                        onChange={e => setIncomes(prev => prev.map(x => x.id === inc.id ? { ...x, w2: { ...x.w2, pretaxHealthInsurance: parseFloat(e.target.value) || 0 } } : x))} />\n                    </div>\n                    <div>\n                      <label style={{ ...labelStyle, fontSize: 11 }}>HSA</label>\n                      <input style={{ ...inputStyle, fontSize: 12 }} type=\"number\" value={inc.w2?.pretaxHSA || ''} placeholder=\"0\"\n                        onChange={e => setIncomes(prev => prev.map(x => x.id === inc.id ? { ...x, w2: { ...x.w2, pretaxHSA: parseFloat(e.target.value) || 0 } } : x))} />\n                    </div>\n                    <div>\n                      <label style={{ ...labelStyle, fontSize: 11 }}>Employer 401k Match</label>\n                      <input style={{ ...inputStyle, fontSize: 12 }} type=\"number\" value={inc.w2?.employerMatch401k || ''} placeholder=\"0\"\n                        onChange={e => setIncomes(prev => prev.map(x => x.id === inc.id ? { ...x, w2: { ...x.w2, employerMatch401k: parseFloat(e.target.value) || 0 } } : x))} />\n                    </div>\n                  </div>\n\n                  {/* W-2 Validation Warnings */}\n                  {inc.annualAmount > 0 && (() => {\n                    const warnings: string[] = []\n                    const w = inc.w2 || {}\n                    if (w.pretax401k && w.pretax401k > 23500) warnings.push(`401(k) contribution $${w.pretax401k.toLocaleString()} exceeds 2025 limit of $23,500 (or $31,000 if age 50+)`)\n                    if (w.pretaxHSA && w.pretaxHSA > 4300 && profile.filingStatus === 'single') warnings.push(`HSA contribution $${w.pretaxHSA.toLocaleString()} exceeds 2025 single limit of $4,300`)\n                    if (w.pretaxHSA && w.pretaxHSA > 8550 && profile.filingStatus !== 'single') warnings.push(`HSA contribution $${w.pretaxHSA.toLocaleString()} exceeds 2025 family limit of $8,550`)\n                    if (w.federalWithholding && w.federalWithholding > 0 && w.federalWithholding < inc.annualAmount * 0.05 && inc.annualAmount > 20000) warnings.push(`Federal withholding is only ${((w.federalWithholding / inc.annualAmount) * 100).toFixed(1)}% of wages — may result in a large tax bill`)\n                    if (w.federalWithholding && w.federalWithholding > inc.annualAmount * 0.40) warnings.push(`Federal withholding is ${((w.federalWithholding / inc.annualAmount) * 100).toFixed(0)}% of wages — unusually high, verify W-4`)\n                    if (w.ficaWithheld && w.ficaWithheld > 0 && inc.annualAmount > 176100 && w.ficaWithheld > 176100 * 0.0765 + (inc.annualAmount - 176100) * 0.0145 + 500) warnings.push(`FICA withholding seems high — Social Security caps at $176,100 wage base for 2025`)\n                    if (w.grossSalary && w.grossSalary > 0 && inc.annualAmount > w.grossSalary) warnings.push(`W-2 Box 1 ($${inc.annualAmount.toLocaleString()}) is higher than gross salary ($${w.grossSalary.toLocaleString()}) — Box 1 should be ≤ gross`)\n                    if (warnings.length === 0) return null\n                    return (\n                      <div style={{ marginTop: 8 }}>\n                        {warnings.map((warn, wi) => (\n                          <div key={wi} style={{ display: 'flex', alignItems: 'flex-start', gap: 6, padding: '6px 10px', marginBottom: 4,\n                            borderRadius: 6, background: 'rgba(245,158,11,0.08)', border: '1px solid rgba(245,158,11,0.15)', fontSize: 11, color: '#f59e0b', lineHeight: 1.4 }}>\n                            <span style={{ fontSize: 12, flexShrink: 0 }}>⚠️</span> {warn}\n                          </div>\n                        ))}\n                      </div>\n                    )\n                  })()}\n\n                  {/* W-2 Summary */}\n                  {inc.annualAmount > 0 && (\n                    <div style={{ marginTop: 10, padding: '8px 12px', borderRadius: 8, background: 'rgba(96,165,250,0.06)', border: '1px solid rgba(96,165,250,0.12)', fontSize: 11, color: 'var(--text-muted)' }}>\n                      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 2 }}>\n                        <span>Employer FICA (their half):</span>\n                        <span style={{ fontFamily: 'var(--font-mono)' }}>~${Math.round(inc.annualAmount * 0.0765).toLocaleString()}</span>\n                      </div>\n                      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 2 }}>\n                        <span>Your FICA (withheld):</span>\n                        <span style={{ fontFamily: 'var(--font-mono)' }}>{inc.w2?.ficaWithheld ? `$${inc.w2.ficaWithheld.toLocaleString()}` : `~$${Math.round(inc.annualAmount * 0.0765).toLocaleString()}`}</span>\n                      </div>\n                      <div style={{ display: 'flex', justifyContent: 'space-between', color: 'var(--accent-blue)' }}>\n                        <span>Total employer cost:</span>\n                        <span style={{ fontFamily: 'var(--font-mono)', fontWeight: 500 }}>\n                          ~${Math.round(inc.annualAmount + inc.annualAmount * 0.0765 + (inc.w2?.employerMatch401k || 0) + (inc.w2?.pretaxHealthInsurance || 0) * 0.7).toLocaleString()}\n                        </span>\n                      </div>\n                    </div>\n                  )}\n                </div>\n              )}\n            </div>\n          ))}\n          <div style={{ display: 'flex', gap: 8, marginTop: 4 }}>\n            <button onClick={() => setIncomes(prev => [...prev, {\n              id: genId(), name: '', type: 'w2', annualAmount: 0, isActive: true, w2: {},\n            }])} className=\"btn btn-ghost\" style={{ flex: 1, justifyContent: 'center', padding: 12 }}>\n              <Plus size={14} /> Add W-2 Job\n            </button>\n            <button onClick={addIncome} className=\"btn btn-ghost\" style={{ flex: 1, justifyContent: 'center', padding: 12 }}>\n              <Plus size={14} /> Add Other Income\n            </button>\n          </div>\n        </div>\n      )\n\n      case 2: return (\n        <div>\n          <StrategyHint icon={<Building2 size={14} />} color=\"#8b5cf6\" title=\"Entity Structure = Tax Architecture\">\n            Your legal entity choice is one of the highest-impact tax decisions you'll make. Here's the quick framework:\n            {'\\n\\n'}• <strong>Sole Proprietorship</strong> — simplest, no filing cost, but you pay full 15.3% SE tax on all net profit and have no liability protection.\n            {'\\n'}• <strong>Single-Member LLC</strong> — same taxes as sole prop (disregarded entity), but adds liability protection. Low annual cost ($50-800 depending on state).\n            {'\\n'}• <strong>LLC + S-Corp election</strong> — the \"sweet spot\" for most self-employed above ~$50-60k net profit. You pay yourself a reasonable salary (payroll tax applies), then take remaining profit as distributions (no SE tax). Typical savings: $3,000-15,000+/yr.\n            {'\\n'}• <strong>Multi-Member LLC (Partnership)</strong> — each partner's share flows to their K-1. Can also elect S-Corp status. Key: track unreimbursed partner expenses and guaranteed payments.\n            {'\\n'}• <strong>C-Corp</strong> — flat 21% corporate rate, but profits are taxed twice (corporate + dividend). Rarely optimal for small businesses unless retaining significant earnings.\n          </StrategyHint>\n          <p style={{ fontSize: 13, color: 'var(--text-muted)', marginBottom: 16 }}>Add your legal entities (LLCs, corps, etc.) — or skip if you're a sole proprietor.</p>\n          {entities.map((ent, i) => (\n            <div key={ent.id} style={{ background: 'var(--bg-surface)', borderRadius: 10, padding: 16, marginBottom: 12, border: '1px solid var(--border-subtle)' }}>\n              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 12 }}>\n                <span style={{ fontSize: 13, fontWeight: 500 }}>Entity #{i + 1}</span>\n                <button onClick={() => setEntities(prev => prev.filter(x => x.id !== ent.id))} style={{ background: 'none', border: 'none', color: 'var(--accent-red)', cursor: 'pointer' }}>\n                  <Trash2 size={14} />\n                </button>\n              </div>\n              <div className=\"grid-3\" style={{ gap: 12 }}>\n                <div>\n                  <label style={labelStyle}>Entity Name</label>\n                  <input style={inputStyle} value={ent.name} placeholder=\"e.g. My Business LLC\" onChange={e => setEntities(prev => prev.map(x => x.id === ent.id ? { ...x, name: e.target.value } : x))} />\n                </div>\n                <div>\n                  <label style={labelStyle}>Type</label>\n                  <select style={selectStyle} value={ent.type} onChange={e => setEntities(prev => prev.map(x => x.id === ent.id ? { ...x, type: e.target.value as any } : x))}>\n                    {ENTITY_TYPES.map(t => <option key={t} value={t}>{entityLabels[t]}</option>)}\n                  </select>\n                </div>\n                <div>\n                  <label style={labelStyle}>Annual Cost ($)</label>\n                  <input style={inputStyle} type=\"number\" value={ent.annualCost || ''} placeholder=\"0\" onChange={e => setEntities(prev => prev.map(x => x.id === ent.id ? { ...x, annualCost: parseFloat(e.target.value) || 0 } : x))} />\n                </div>\n              </div>\n              {/* S-Corp / C-Corp: officer salary + ownership */}\n              {['llc_scorp', 'scorp', 'ccorp'].includes(ent.type) && (\n                <div className=\"grid-3\" style={{ gap: 12, marginTop: 10 }}>\n                  <div>\n                    <label style={labelStyle}>Officer Salary ($)</label>\n                    <input style={inputStyle} type=\"number\" value={ent.officerSalary || ''} placeholder=\"Reasonable compensation\" onChange={e => setEntities(prev => prev.map(x => x.id === ent.id ? { ...x, officerSalary: parseFloat(e.target.value) || 0 } : x))} />\n                  </div>\n                  <div>\n                    <label style={labelStyle}>Ownership %</label>\n                    <input style={inputStyle} type=\"number\" min={0} max={100} value={ent.ownershipPct ?? 100} onChange={e => setEntities(prev => prev.map(x => x.id === ent.id ? { ...x, ownershipPct: parseInt(e.target.value) || 100 } : x))} />\n                  </div>\n                  <div>\n                    <label style={labelStyle}>EIN</label>\n                    <input style={inputStyle} value={ent.einNumber || ''} placeholder=\"XX-XXXXXXX\" onChange={e => setEntities(prev => prev.map(x => x.id === ent.id ? { ...x, einNumber: e.target.value } : x))} />\n                  </div>\n                </div>\n              )}\n              {/* Partnership: ownership % */}\n              {ent.type === 'partnership' && (\n                <div style={{ marginTop: 10, maxWidth: 200 }}>\n                  <label style={labelStyle}>Your Ownership %</label>\n                  <input style={inputStyle} type=\"number\" min={0} max={100} value={ent.ownershipPct ?? 100} onChange={e => setEntities(prev => prev.map(x => x.id === ent.id ? { ...x, ownershipPct: parseInt(e.target.value) || 100 } : x))} />\n                </div>\n              )}\n            </div>\n          ))}\n          <button onClick={addEntity} className=\"btn btn-ghost\" style={{ width: '100%', justifyContent: 'center', padding: 12 }}>\n            <Plus size={14} /> Add Entity\n          </button>\n          <div style={{ fontSize: 12, color: 'var(--text-muted)', marginTop: 12, textAlign: 'center' }}>\n            No entities? That's fine — the engine will analyze whether you should form one.\n          </div>\n        </div>\n      )\n\n      case 3: return (\n        <div>\n          <StrategyHint icon={<Shield size={14} />} color=\"#10b981\" title=\"Every Dollar Captured = Tax Saved\">\n            Business expenses directly reduce your taxable income AND your self-employment tax base. At a combined marginal rate of 30-40%+, a $1,000 deduction you missed is $300-400 more in taxes you didn't need to pay.\n            Key nuances: <strong>Home office</strong> can be simplified ($5/sqft, max $1,500) or actual (% of rent/mortgage + utilities).\n            <strong> Meals</strong> are 50% deductible when business-related. <strong>Vehicle</strong> can use standard mileage (67¢/mile) or actual costs.\n            <strong> Health insurance premiums</strong> for self-employed individuals are an above-the-line deduction — often overlooked.\n            Use the templates below as a checklist, then adjust amounts to match your actual spending.\n          </StrategyHint>\n          <p style={{ fontSize: 13, color: 'var(--text-muted)', marginBottom: 12 }}>Add recurring business expenses that may be deductible.</p>\n\n          {/* Expense Templates */}\n          {expenses.length === 0 && (\n            <div style={{ marginBottom: 20 }}>\n              <div style={{ fontSize: 11, fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.05em', marginBottom: 8 }}>\n                Quick Start — choose your situation\n              </div>\n              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 8 }}>\n                {EXPENSE_TEMPLATES.map(tmpl => (\n                  <button\n                    key={tmpl.id}\n                    onClick={() => applyExpenseTemplate(tmpl)}\n                    style={{\n                      display: 'flex', alignItems: 'center', gap: 10,\n                      padding: '12px 14px', borderRadius: 10,\n                      border: '1px solid var(--border-subtle)',\n                      background: 'var(--bg-surface)', cursor: 'pointer',\n                      textAlign: 'left', transition: 'all 0.2s',\n                    }}\n                    onMouseEnter={e => { e.currentTarget.style.borderColor = 'var(--accent-gold)'; e.currentTarget.style.background = 'var(--accent-gold-dim, rgba(245,158,11,0.06))' }}\n                    onMouseLeave={e => { e.currentTarget.style.borderColor = 'var(--border-subtle)'; e.currentTarget.style.background = 'var(--bg-surface)' }}\n                  >\n                    <span style={{ fontSize: 22 }}>{tmpl.emoji}</span>\n                    <div>\n                      <div style={{ fontSize: 12, fontWeight: 600, color: 'var(--text-primary)' }}>{tmpl.label}</div>\n                      <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>{tmpl.description}</div>\n                    </div>\n                  </button>\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Add more templates when expenses already exist */}\n          {expenses.length > 0 && (\n            <div style={{ marginBottom: 16 }}>\n              <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 8 }}>\n                <Sparkles size={12} style={{ color: 'var(--accent-gold)' }} />\n                <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>Add common expenses for:</span>\n                {EXPENSE_TEMPLATES.map(tmpl => (\n                  <button\n                    key={tmpl.id}\n                    onClick={() => applyExpenseTemplate(tmpl)}\n                    style={{\n                      padding: '3px 8px', borderRadius: 5, fontSize: 10, fontWeight: 500,\n                      background: 'var(--bg-surface)', border: '1px solid var(--border-subtle)',\n                      color: 'var(--text-secondary)', cursor: 'pointer', transition: 'all 0.15s',\n                    }}\n                    onMouseEnter={e => { e.currentTarget.style.borderColor = 'var(--accent-gold)'; e.currentTarget.style.color = 'var(--accent-gold)' }}\n                    onMouseLeave={e => { e.currentTarget.style.borderColor = 'var(--border-subtle)'; e.currentTarget.style.color = 'var(--text-secondary)' }}\n                  >\n                    {tmpl.emoji} {tmpl.label}\n                  </button>\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Tip for template users */}\n          {expenses.length > 0 && expenses.some(e => e.annualAmount === 0) && (\n            <div style={{\n              display: 'flex', alignItems: 'center', gap: 8,\n              padding: '8px 12px', marginBottom: 12, borderRadius: 8,\n              background: 'rgba(245,158,11,0.06)', border: '1px solid rgba(245,158,11,0.12)',\n              fontSize: 11, color: 'var(--accent-gold)',\n            }}>\n              <Edit3 size={12} />\n              Fill in the amounts that apply to you — leave $0 items and they'll be ignored. Delete any that don't apply.\n            </div>\n          )}\n\n          {expenses.map((exp, i) => (\n            <div key={exp.id} style={{ background: 'var(--bg-surface)', borderRadius: 10, padding: 16, marginBottom: 12, border: '1px solid var(--border-subtle)' }}>\n              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 12 }}>\n                <span style={{ fontSize: 13, fontWeight: 500 }}>Expense #{i + 1}</span>\n                <button onClick={() => setExpenses(prev => prev.filter(x => x.id !== exp.id))} style={{ background: 'none', border: 'none', color: 'var(--accent-red)', cursor: 'pointer' }}>\n                  <Trash2 size={14} />\n                </button>\n              </div>\n              <div className=\"grid-3\" style={{ gap: 12 }}>\n                <div>\n                  <label style={labelStyle}>Description</label>\n                  <input style={inputStyle} value={exp.description} placeholder=\"e.g. Software subscriptions\" onChange={e => setExpenses(prev => prev.map(x => x.id === exp.id ? { ...x, description: e.target.value } : x))} />\n                </div>\n                <div>\n                  <label style={labelStyle}>Annual Amount ($)</label>\n                  <input style={inputStyle} type=\"number\" value={exp.annualAmount || ''} placeholder=\"0\" onChange={e => setExpenses(prev => prev.map(x => x.id === exp.id ? { ...x, annualAmount: parseFloat(e.target.value) || 0 } : x))} />\n                </div>\n                <div>\n                  <label style={labelStyle}>Deductible %</label>\n                  <input style={inputStyle} type=\"number\" min={0} max={100} value={exp.deductionPct} onChange={e => setExpenses(prev => prev.map(x => x.id === exp.id ? { ...x, deductionPct: parseInt(e.target.value) || 0 } : x))} />\n                </div>\n              </div>\n              {entities.length > 0 && (\n                <div style={{ marginTop: 8 }}>\n                  <label style={labelStyle}>Belongs to</label>\n                  <select style={{ ...selectStyle, maxWidth: 260 }} value={exp.entityId || 'personal'} onChange={e => setExpenses(prev => prev.map(x => x.id === exp.id ? { ...x, entityId: e.target.value === 'personal' ? undefined : e.target.value } : x))}>\n                    <option value=\"personal\">Personal (no entity)</option>\n                    {entities.filter(e => e.isActive).map(e => <option key={e.id} value={e.id}>{e.name} ({e.type.replace('_', ' ')})</option>)}\n                  </select>\n                </div>\n              )}\n            </div>\n          ))}\n          <button onClick={addExpense} className=\"btn btn-ghost\" style={{ width: '100%', justifyContent: 'center', padding: 12 }}>\n            <Plus size={14} /> Add Expense\n          </button>\n        </div>\n      )\n\n      case 4: return (\n        <div>\n          <StrategyHint icon={<PiggyBank size={14} />} color=\"#ec4899\" title=\"Above-the-Line vs. Itemized: Know the Difference\">\n            <strong>Above-the-line deductions</strong> (retirement contributions, SE health insurance, student loan interest, 50% of SE tax, QBI deduction) reduce your AGI regardless of whether you itemize — they're always valuable.\n            <strong> Itemized deductions</strong> (mortgage interest, SALT up to $10k, charitable gifts) only help if they exceed your standard deduction (${profile.filingStatus === 'married_joint' ? '$31,400 MFJ' : profile.filingStatus === 'head_of_household' ? '$22,500 HoH' : '$15,700 single'} for 2025).\n            The biggest self-employed deductions: <strong>SEP-IRA</strong> (up to 25% of net SE income, max $70,000) or <strong>Solo 401(k)</strong> ($23,500 employee + 25% employer, up to $70,000 total). These are often the single largest tax-saving move available.\n          </StrategyHint>\n          <p style={{ fontSize: 13, color: 'var(--text-muted)', marginBottom: 12 }}>Add any specific deductions you're already taking (retirement contributions, home office, etc.)</p>\n\n          {/* Deduction Templates */}\n          {deductions.length === 0 && (\n            <div style={{ marginBottom: 20 }}>\n              <div style={{ fontSize: 11, fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.05em', marginBottom: 8 }}>\n                Quick Start — common deduction categories\n              </div>\n              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 8 }}>\n                {DEDUCTION_TEMPLATES.map(tmpl => (\n                  <button\n                    key={tmpl.id}\n                    onClick={() => applyDeductionTemplate(tmpl)}\n                    style={{\n                      display: 'flex', alignItems: 'center', gap: 8,\n                      padding: '10px 12px', borderRadius: 10,\n                      border: '1px solid var(--border-subtle)',\n                      background: 'var(--bg-surface)', cursor: 'pointer',\n                      textAlign: 'left', transition: 'all 0.2s',\n                    }}\n                    onMouseEnter={e => { e.currentTarget.style.borderColor = 'var(--accent-gold)'; e.currentTarget.style.background = 'var(--accent-gold-dim, rgba(245,158,11,0.06))' }}\n                    onMouseLeave={e => { e.currentTarget.style.borderColor = 'var(--border-subtle)'; e.currentTarget.style.background = 'var(--bg-surface)' }}\n                  >\n                    <span style={{ fontSize: 18 }}>{tmpl.emoji}</span>\n                    <div style={{ fontSize: 11, fontWeight: 600, color: 'var(--text-primary)' }}>{tmpl.label}</div>\n                  </button>\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Compact template add when deductions exist */}\n          {deductions.length > 0 && (\n            <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 12 }}>\n              <Sparkles size={12} style={{ color: 'var(--accent-gold)' }} />\n              <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>Add:</span>\n              {DEDUCTION_TEMPLATES.map(tmpl => (\n                <button\n                  key={tmpl.id}\n                  onClick={() => applyDeductionTemplate(tmpl)}\n                  style={{\n                    padding: '3px 8px', borderRadius: 5, fontSize: 10, fontWeight: 500,\n                    background: 'var(--bg-surface)', border: '1px solid var(--border-subtle)',\n                    color: 'var(--text-secondary)', cursor: 'pointer', transition: 'all 0.15s',\n                  }}\n                  onMouseEnter={e => { e.currentTarget.style.borderColor = 'var(--accent-gold)'; e.currentTarget.style.color = 'var(--accent-gold)' }}\n                  onMouseLeave={e => { e.currentTarget.style.borderColor = 'var(--border-subtle)'; e.currentTarget.style.color = 'var(--text-secondary)' }}\n                >\n                  {tmpl.emoji} {tmpl.label}\n                </button>\n              ))}\n            </div>\n          )}\n\n          {/* Tip for template users */}\n          {deductions.length > 0 && deductions.some(d => d.amount === 0) && (\n            <div style={{\n              display: 'flex', alignItems: 'center', gap: 8,\n              padding: '8px 12px', marginBottom: 12, borderRadius: 8,\n              background: 'rgba(245,158,11,0.06)', border: '1px solid rgba(245,158,11,0.12)',\n              fontSize: 11, color: 'var(--accent-gold)',\n            }}>\n              <Edit3 size={12} />\n              Fill in your actual amounts — delete any that don't apply. $0 items will be ignored in calculations.\n            </div>\n          )}\n\n          {deductions.map((ded, i) => (\n            <div key={ded.id} style={{ background: 'var(--bg-surface)', borderRadius: 10, padding: 16, marginBottom: 12, border: '1px solid var(--border-subtle)' }}>\n              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 12 }}>\n                <span style={{ fontSize: 13, fontWeight: 500 }}>Deduction #{i + 1}</span>\n                <button onClick={() => setDeductions(prev => prev.filter(x => x.id !== ded.id))} style={{ background: 'none', border: 'none', color: 'var(--accent-red)', cursor: 'pointer' }}>\n                  <Trash2 size={14} />\n                </button>\n              </div>\n              <div className=\"grid-3\" style={{ gap: 12 }}>\n                <div>\n                  <label style={labelStyle}>Name</label>\n                  <input style={inputStyle} value={ded.name} placeholder=\"e.g. SEP-IRA contribution\" onChange={e => setDeductions(prev => prev.map(x => x.id === ded.id ? { ...x, name: e.target.value } : x))} />\n                </div>\n                <div>\n                  <label style={labelStyle}>Category</label>\n                  <select style={selectStyle} value={ded.category} onChange={e => setDeductions(prev => prev.map(x => x.id === ded.id ? { ...x, category: e.target.value as any } : x))}>\n                    {DEDUCTION_CATS.map(c => <option key={c} value={c}>{c.replace('_', ' ').charAt(0).toUpperCase() + c.replace('_', ' ').slice(1)}</option>)}\n                  </select>\n                </div>\n                <div>\n                  <label style={labelStyle}>Annual Amount ($)</label>\n                  <input style={inputStyle} type=\"number\" value={ded.amount || ''} placeholder=\"0\" onChange={e => setDeductions(prev => prev.map(x => x.id === ded.id ? { ...x, amount: parseFloat(e.target.value) || 0 } : x))} />\n                </div>\n              </div>\n              {entities.length > 0 && ['business', 'home_office', 'vehicle', 'retirement', 'health'].includes(ded.category) && (\n                <div style={{ marginTop: 8 }}>\n                  <label style={labelStyle}>Belongs to</label>\n                  <select style={{ ...selectStyle, maxWidth: 260 }} value={ded.entityId || 'personal'} onChange={e => setDeductions(prev => prev.map(x => x.id === ded.id ? { ...x, entityId: e.target.value === 'personal' ? undefined : e.target.value } : x))}>\n                    <option value=\"personal\">Personal</option>\n                    {entities.filter(e => e.isActive).map(e => <option key={e.id} value={e.id}>{e.name} ({e.type.replace('_', ' ')})</option>)}\n                  </select>\n                </div>\n              )}\n            </div>\n          ))}\n          <button onClick={addDeduction} className=\"btn btn-ghost\" style={{ width: '100%', justifyContent: 'center', padding: 12 }}>\n            <Plus size={14} /> Add Deduction\n          </button>\n        </div>\n      )\n\n      case 5: {\n        const totalIncome = incomes.reduce((s, i) => s + i.annualAmount, 0)\n        const totalExpenses = expenses.reduce((s, e) => s + e.annualAmount, 0)\n        const totalDeductions = deductions.reduce((s, d) => s + d.amount, 0)\n        const strategies = computeStrategyPreview(profile, incomes, entities, expenses, deductions)\n        const criticalCount = strategies.filter(s => s.priority === 'critical').length\n        const highCount = strategies.filter(s => s.priority === 'high').length\n\n        // Quick tax estimate\n        const businessIncome = incomes.filter(i => i.type === 'business' || i.type === 'freelance').reduce((s, i) => s + i.annualAmount, 0)\n        const deductibleExpenses = expenses.filter(e => e.isDeductible).reduce((s, e) => s + (e.annualAmount * e.deductionPct / 100), 0)\n        const netSE = Math.max(0, businessIncome - deductibleExpenses)\n        const seTax = netSE > 0 ? calculateSelfEmploymentTax(netSE) : { totalSETax: 0 }\n        const estAGI = Math.max(0, totalIncome - deductibleExpenses - totalDeductions - seTax.totalSETax * 0.5)\n        const fedTax = calculateFederalIncomeTax(Math.max(0, estAGI - (profile.filingStatus === 'married_joint' ? 31400 : profile.filingStatus === 'head_of_household' ? 22500 : 15700)), profile.filingStatus)\n        const stateTax = calculateStateTax(estAGI, profile.state)\n        const totalTax = fedTax + stateTax + seTax.totalSETax\n        const effectiveRate = totalIncome > 0 ? (totalTax / totalIncome) * 100 : 0\n        const netIncome = totalIncome - totalTax\n\n        return (\n          <div>\n            <div style={{ background: 'linear-gradient(135deg, rgba(212,168,67,0.08), rgba(52,211,153,0.04))', border: '1px solid rgba(212,168,67,0.15)', borderRadius: 14, padding: 24, marginBottom: 20, textAlign: 'center' }}>\n              <Sparkles size={24} color=\"var(--accent-gold)\" style={{ marginBottom: 8 }} />\n              <div style={{ fontSize: 16, fontWeight: 500, color: 'var(--accent-gold)', marginBottom: 4 }}>Ready to Analyze</div>\n              <div style={{ fontSize: 13, color: 'var(--text-secondary)' }}>\n                Fortuna detected <strong style={{ color: '#ef4444' }}>{criticalCount} critical</strong> and <strong style={{ color: '#f59e0b' }}>{highCount} high-priority</strong> strategies from your data.\n              </div>\n            </div>\n\n            {/* Quick Summary Grid */}\n            <div className=\"grid-2\" style={{ gap: 12, marginBottom: 16 }}>\n              <div style={{ background: 'var(--bg-surface)', borderRadius: 10, padding: 16, border: '1px solid var(--border-subtle)' }}>\n                <div style={{ fontSize: 11, textTransform: 'uppercase', letterSpacing: '0.08em', color: 'var(--text-muted)', marginBottom: 8 }}>Profile</div>\n                <div style={{ fontSize: 13, color: 'var(--text-secondary)' }}>{profile.name || 'Not set'} · {STATE_TAX_RATES[profile.state]?.name} · {profile.filingStatus.replace('_', ' ')}</div>\n              </div>\n              <div style={{ background: 'var(--bg-surface)', borderRadius: 10, padding: 16, border: '1px solid var(--border-subtle)' }}>\n                <div style={{ fontSize: 11, textTransform: 'uppercase', letterSpacing: '0.08em', color: 'var(--text-muted)', marginBottom: 8 }}>Income Streams</div>\n                <div style={{ fontFamily: 'var(--font-mono)', fontSize: 16, fontWeight: 500 }}>{incomes.length} streams · ${totalIncome.toLocaleString()}</div>\n              </div>\n              <div style={{ background: 'var(--bg-surface)', borderRadius: 10, padding: 16, border: '1px solid var(--border-subtle)' }}>\n                <div style={{ fontSize: 11, textTransform: 'uppercase', letterSpacing: '0.08em', color: 'var(--text-muted)', marginBottom: 8 }}>Legal Entities</div>\n                <div style={{ fontFamily: 'var(--font-mono)', fontSize: 16, fontWeight: 500 }}>{entities.length || 'Sole Proprietor'}</div>\n              </div>\n              <div style={{ background: 'var(--bg-surface)', borderRadius: 10, padding: 16, border: '1px solid var(--border-subtle)' }}>\n                <div style={{ fontSize: 11, textTransform: 'uppercase', letterSpacing: '0.08em', color: 'var(--text-muted)', marginBottom: 8 }}>Expenses & Deductions</div>\n                <div style={{ fontFamily: 'var(--font-mono)', fontSize: 16, fontWeight: 500 }}>${(totalExpenses + totalDeductions).toLocaleString()}</div>\n              </div>\n            </div>\n\n            {/* Tax Estimate Preview */}\n            {totalIncome > 0 && (\n              <div style={{\n                background: 'var(--bg-surface)', borderRadius: 12, padding: 16,\n                border: '1px solid var(--border-subtle)', marginBottom: 16,\n              }}>\n                <div style={{ fontSize: 11, fontWeight: 700, textTransform: 'uppercase', letterSpacing: '0.05em', color: 'var(--text-muted)', marginBottom: 10, display: 'flex', alignItems: 'center', gap: 6 }}>\n                  <Calculator size={12} /> Preliminary Tax Estimate\n                </div>\n                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 10 }}>\n                  {[\n                    { label: 'Federal', value: `$${Math.round(fedTax).toLocaleString()}`, color: '#3b82f6' },\n                    { label: 'State', value: `$${Math.round(stateTax).toLocaleString()}`, color: '#8b5cf6' },\n                    { label: 'SE Tax', value: `$${Math.round(seTax.totalSETax).toLocaleString()}`, color: '#f59e0b' },\n                    { label: 'Total Tax', value: `$${Math.round(totalTax).toLocaleString()}`, color: '#ef4444' },\n                  ].map(item => (\n                    <div key={item.label} style={{ textAlign: 'center' }}>\n                      <div style={{ fontSize: 9, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.05em', marginBottom: 2 }}>{item.label}</div>\n                      <div style={{ fontSize: 15, fontWeight: 700, color: item.color, fontFamily: 'var(--font-mono)' }}>{item.value}</div>\n                    </div>\n                  ))}\n                </div>\n                <div style={{\n                  display: 'flex', justifyContent: 'space-between', marginTop: 10, paddingTop: 10,\n                  borderTop: '1px solid var(--border-subtle)', fontSize: 12,\n                }}>\n                  <div>\n                    <span style={{ color: 'var(--text-muted)' }}>Effective Rate: </span>\n                    <span style={{ fontWeight: 600, color: effectiveRate > 30 ? '#ef4444' : effectiveRate > 20 ? '#f59e0b' : '#10b981', fontFamily: 'var(--font-mono)' }}>\n                      {effectiveRate.toFixed(1)}%\n                    </span>\n                  </div>\n                  <div>\n                    <span style={{ color: 'var(--text-muted)' }}>Estimated Net: </span>\n                    <span style={{ fontWeight: 600, color: '#10b981', fontFamily: 'var(--font-mono)' }}>\n                      ${Math.round(netIncome).toLocaleString()}\n                    </span>\n                  </div>\n                  <div>\n                    <span style={{ color: 'var(--text-muted)' }}>Keep Rate: </span>\n                    <span style={{ fontWeight: 600, color: 'var(--text-primary)', fontFamily: 'var(--font-mono)' }}>\n                      {totalIncome > 0 ? ((netIncome / totalIncome) * 100).toFixed(1) : '0.0'}%\n                    </span>\n                  </div>\n                </div>\n                <div style={{ fontSize: 10, color: 'var(--text-muted)', marginTop: 6, fontStyle: 'italic' }}>\n                  This is a preliminary estimate. Full analysis with bracket optimization, AMT, and credits runs after launch.\n                </div>\n              </div>\n            )}\n\n            {/* Strategy Stack Preview */}\n            {strategies.length > 0 && (\n              <div style={{ marginBottom: 8 }}>\n                <div style={{ fontSize: 11, fontWeight: 700, textTransform: 'uppercase', letterSpacing: '0.05em', color: 'var(--text-muted)', marginBottom: 10, display: 'flex', alignItems: 'center', gap: 6 }}>\n                  <Zap size={12} /> Strategy Stack — {strategies.length} strategies detected\n                </div>\n                {strategies.map((strat, i) => (\n                  <div key={i} style={{\n                    padding: '12px 14px', borderRadius: 10, marginBottom: 8,\n                    background: `${strat.color}06`, border: `1px solid ${strat.color}15`,\n                  }}>\n                    <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>\n                      <span style={{ fontSize: 16 }}>{strat.icon}</span>\n                      <div style={{ flex: 1 }}>\n                        <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>\n                          <span style={{ fontSize: 12, fontWeight: 700, color: 'var(--text-primary)' }}>{strat.title}</span>\n                          <span style={{\n                            fontSize: 9, fontWeight: 700, padding: '1px 6px', borderRadius: 4,\n                            textTransform: 'uppercase', letterSpacing: '0.04em',\n                            background: strat.priority === 'critical' ? 'rgba(239,68,68,0.12)' :\n                              strat.priority === 'high' ? 'rgba(245,158,11,0.12)' : 'rgba(107,114,128,0.12)',\n                            color: strat.priority === 'critical' ? '#ef4444' :\n                              strat.priority === 'high' ? '#f59e0b' : 'var(--text-muted)',\n                          }}>\n                            {strat.priority}\n                          </span>\n                        </div>\n                        <span style={{ fontSize: 11, fontWeight: 600, color: strat.color }}>{strat.impact}</span>\n                      </div>\n                    </div>\n                    <div style={{ fontSize: 11, color: 'var(--text-muted)', lineHeight: 1.5, paddingLeft: 24 }}>\n                      {strat.description}\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n        )\n      }\n    }\n  }\n\n  return (\n    <div className=\"view-enter\" style={{ maxWidth: 800, margin: '0 auto' }}>\n      <div style={{ marginBottom: 32 }}>\n        <h1 className=\"section-title\">{editMode ? 'Edit Financial Profile' : 'Set Up Your Financial Profile'}</h1>\n        <p className=\"section-subtitle\">{editMode ? 'Update your data — the engine will recalculate everything automatically' : 'Enter your financial data and the Fortuna Engine will do the rest'}</p>\n      </div>\n\n      {/* Step indicator */}\n      <div style={{ display: 'flex', gap: 4, marginBottom: 32 }}>\n        {STEPS.map((s, i) => (\n          <div key={s} style={{ flex: 1, cursor: 'pointer' }} onClick={() => setStep(i)}>\n            <div style={{\n              height: 4, borderRadius: 2, marginBottom: 8,\n              background: i <= step ? 'var(--accent-gold)' : 'var(--bg-surface)',\n              transition: 'background 0.3s',\n            }} />\n            <div style={{\n              fontSize: 11, fontWeight: i === step ? 600 : 400,\n              color: i <= step ? 'var(--accent-gold)' : 'var(--text-muted)',\n              textAlign: 'center',\n            }}>{s}</div>\n          </div>\n        ))}\n      </div>\n\n      {/* Step content */}\n      <div className=\"card\" style={{ marginBottom: 24 }}>\n        <div className=\"card-header\">\n          <span className=\"card-title\" style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n            {step === 0 && <User size={18} />}\n            {step === 1 && <DollarSign size={18} />}\n            {step === 2 && <Building2 size={18} />}\n            {step === 3 && <Receipt size={18} />}\n            {step === 4 && <Receipt size={18} />}\n            {step === 5 && <CheckCircle2 size={18} color=\"var(--accent-emerald)\" />}\n            {STEPS[step]}\n          </span>\n          <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>Step {step + 1} of {STEPS.length}</span>\n        </div>\n        <div className=\"card-body\">\n          {renderStep()}\n        </div>\n      </div>\n\n      {/* Navigation */}\n      <div style={{ display: 'flex', justifyContent: 'space-between' }}>\n        <button className=\"btn btn-ghost\" onClick={() => setStep(Math.max(0, step - 1))} disabled={step === 0} style={{ opacity: step === 0 ? 0.3 : 1 }}>\n          <ChevronLeft size={14} /> Back\n        </button>\n        {step < STEPS.length - 1 ? (\n          <button className=\"btn btn-primary\" onClick={() => setStep(step + 1)}>\n            Continue <ChevronRight size={14} />\n          </button>\n        ) : (\n          <button className=\"btn btn-primary\" onClick={handleFinish}>\n            <Sparkles size={14} /> {editMode ? 'Save & Recalculate' : 'Launch Fortuna Engine'}\n          </button>\n        )}\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\DeductionDiscovery.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Plus' is defined but never used.","line":6,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":7,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Plus"},"fix":{"range":[266,274],"text":""},"desc":"Remove unused variable \"Plus\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'PiggyBank' is defined but never used.","line":6,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":26,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"PiggyBank"},"fix":{"range":[282,293],"text":""},"desc":"Remove unused variable \"PiggyBank\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Zap' is defined but never used.","line":6,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":31,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Zap"},"fix":{"range":[293,298],"text":""},"desc":"Remove unused variable \"Zap\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Eye' is defined but never used.","line":6,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":36,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Eye"},"fix":{"range":[298,303],"text":""},"desc":"Remove unused variable \"Eye\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Tag' is defined but never used.","line":6,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":41,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Tag"},"fix":{"range":[303,308],"text":""},"desc":"Remove unused variable \"Tag\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":89,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5124,5127],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5124,5127],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { discoverDeductions, type DiscoveredDeduction } from '../engine/deduction-discovery'\nimport {\n  Search, DollarSign, CheckCircle2, AlertTriangle, ChevronDown, ChevronUp,\n  Plus, Shield, PiggyBank, Zap, Eye, Tag\n} from 'lucide-react'\n\nfunction fmt(n: number): string { return `$${Math.round(n).toLocaleString()}` }\n\nconst CONFIDENCE_COLORS: Record<string, string> = { high: 'var(--accent-emerald)', medium: 'var(--accent-gold)', low: 'var(--text-muted)' }\nconst CATEGORY_ICONS: Record<string, string> = {\n  health: '🏥', home_office: '🏠', vehicle: '🚗', retirement: '🏦', business: '💼',\n  education: '🎓', charitable: '❤️', other: '📋',\n}\n\nexport function DeductionDiscovery() {\n  const { state } = useFortuna()\n  const discoveries = useMemo(() => discoverDeductions(state), [state])\n  const [expanded, setExpanded] = useState<string | null>(null)\n  const [filter, setFilter] = useState<'all' | 'unclaimed' | 'claimed'>('all')\n\n  const unclaimed = discoveries.filter(d => !d.alreadyClaimed && d.applies)\n  const claimed = discoveries.filter(d => d.alreadyClaimed)\n  const totalPotentialSavings = unclaimed.reduce((s, d) => s + d.taxSavings, 0)\n  const displayed = filter === 'unclaimed' ? unclaimed : filter === 'claimed' ? claimed : discoveries.filter(d => d.applies)\n\n  const hasData = state.incomeStreams.length > 0\n\n  if (!hasData) {\n    return (\n      <div className=\"view-enter\" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '50vh' }}>\n        <div style={{ textAlign: 'center', maxWidth: 400 }}>\n          <Search size={32} color=\"var(--accent-gold)\" style={{ marginBottom: 12 }} />\n          <h2 style={{ fontFamily: 'var(--font-display)', marginBottom: 8 }}>Deduction Discovery</h2>\n          <p style={{ fontSize: 13, color: 'var(--text-muted)' }}>Add your financial profile to discover unclaimed deductions and credits.</p>\n        </div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"view-enter\">\n      <div style={{ marginBottom: 24 }}>\n        <h1 className=\"section-title\">Deduction Discovery</h1>\n        <p className=\"section-subtitle\">Proactively identifies deductions and credits you may be missing</p>\n      </div>\n\n      {/* Summary Banner */}\n      {totalPotentialSavings > 0 && (\n        <div className=\"glass-card gold-glow\" style={{ padding: '16px 20px', marginBottom: 20, display: 'flex', alignItems: 'center', gap: 16 }}>\n          <div style={{ width: 48, height: 48, borderRadius: 14, background: 'var(--accent-gold-dim)', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>\n            <DollarSign size={22} color=\"var(--accent-gold)\" />\n          </div>\n          <div style={{ flex: 1 }}>\n            <div style={{ fontFamily: 'var(--font-mono)', fontSize: 24, fontWeight: 600, color: 'var(--accent-gold)' }}>\n              {fmt(totalPotentialSavings)}<span style={{ fontSize: 13, fontWeight: 400, color: 'var(--text-muted)' }}> potential tax savings</span>\n            </div>\n            <div style={{ fontSize: 12, color: 'var(--text-secondary)', marginTop: 2 }}>\n              {unclaimed.length} unclaimed deduction{unclaimed.length !== 1 ? 's' : ''} found · {claimed.length} already captured\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* KPI Row */}\n      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 12, marginBottom: 20 }}>\n        {[\n          { label: 'Discovered', value: `${discoveries.filter(d => d.applies).length}`, color: 'var(--accent-blue)', icon: <Search size={14} /> },\n          { label: 'Unclaimed', value: `${unclaimed.length}`, color: 'var(--accent-gold)', icon: <AlertTriangle size={14} /> },\n          { label: 'Already Captured', value: `${claimed.length}`, color: 'var(--accent-emerald)', icon: <CheckCircle2 size={14} /> },\n          { label: 'Potential Savings', value: fmt(totalPotentialSavings), color: 'var(--accent-gold)', icon: <DollarSign size={14} /> },\n        ].map((kpi, i) => (\n          <div key={i} style={{ padding: '12px 16px', borderRadius: 10, background: 'var(--bg-surface)', border: '1px solid var(--border-subtle)', textAlign: 'center' }}>\n            <div style={{ color: kpi.color, marginBottom: 4 }}>{kpi.icon}</div>\n            <div style={{ fontFamily: 'var(--font-mono)', fontSize: 18, fontWeight: 600, color: kpi.color }}>{kpi.value}</div>\n            <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>{kpi.label}</div>\n          </div>\n        ))}\n      </div>\n\n      {/* Filter tabs */}\n      <div style={{ display: 'flex', gap: 4, marginBottom: 16, background: 'var(--bg-surface)', borderRadius: 10, padding: 3, border: '1px solid var(--border-subtle)', width: 'fit-content' }}>\n        {[\n          { key: 'all', label: `All (${discoveries.filter(d => d.applies).length})` },\n          { key: 'unclaimed', label: `Unclaimed (${unclaimed.length})` },\n          { key: 'claimed', label: `Captured (${claimed.length})` },\n        ].map(tab => (\n          <button key={tab.key} onClick={() => setFilter(tab.key as any)}\n            style={{ padding: '6px 14px', borderRadius: 8, border: 'none', fontSize: 11, fontWeight: 500, cursor: 'pointer',\n              background: filter === tab.key ? 'var(--accent-gold)' : 'transparent',\n              color: filter === tab.key ? '#0c0e12' : 'var(--text-muted)' }}>\n            {tab.label}\n          </button>\n        ))}\n      </div>\n\n      {/* Deduction Cards */}\n      <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>\n        {displayed.map(ded => (\n          <DeductionCard key={ded.id} ded={ded} expanded={expanded === ded.id}\n            onToggle={() => setExpanded(expanded === ded.id ? null : ded.id)} />\n        ))}\n        {displayed.length === 0 && (\n          <div style={{ textAlign: 'center', padding: 40, color: 'var(--text-muted)', fontSize: 13 }}>\n            {filter === 'unclaimed' ? 'No unclaimed deductions found — great job!' : 'No deductions found for this filter.'}\n          </div>\n        )}\n      </div>\n    </div>\n  )\n}\n\nfunction DeductionCard({ ded, expanded, onToggle }: { ded: DiscoveredDeduction; expanded: boolean; onToggle: () => void }) {\n  const icon = CATEGORY_ICONS[ded.category] || '📋'\n  const confColor = CONFIDENCE_COLORS[ded.confidence]\n\n  return (\n    <div style={{\n      borderRadius: 12, background: ded.alreadyClaimed ? 'var(--bg-surface)' : 'var(--bg-elevated)',\n      border: `1px solid ${ded.alreadyClaimed ? 'var(--border-subtle)' : ded.taxSavings > 1000 ? 'var(--accent-gold-glow)' : 'var(--border-medium)'}`,\n      overflow: 'hidden', opacity: ded.alreadyClaimed ? 0.7 : 1,\n    }}>\n      <div style={{ padding: '14px 18px', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 12 }} onClick={onToggle}>\n        <span style={{ fontSize: 20 }}>{icon}</span>\n        <div style={{ flex: 1, minWidth: 0 }}>\n          <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n            <span style={{ fontSize: 13, fontWeight: 600, color: 'var(--text-primary)' }}>{ded.name}</span>\n            {ded.alreadyClaimed && <span className=\"badge emerald\" style={{ fontSize: 9 }}>Captured</span>}\n            <span className=\"badge muted\" style={{ fontSize: 9 }}>{ded.confidence} confidence</span>\n            {ded.deductionSignals && ded.deductionSignals.length > 0 && (\n              <span className=\"badge gold\" style={{ fontSize: 9, background: 'var(--accent-gold-dim)', color: 'var(--accent-gold)', border: '1px solid var(--accent-gold)22' }}>\n                <Shield size={8} style={{ marginRight: 3 }} /> Evidence Found\n              </span>\n            )}\n          </div>\n          <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 2 }}>{ded.eligibility}</div>\n        </div>\n        <div style={{ textAlign: 'right', marginRight: 8 }}>\n          <div style={{ fontFamily: 'var(--font-mono)', fontSize: 16, fontWeight: 600, color: ded.alreadyClaimed ? 'var(--text-muted)' : 'var(--accent-emerald)' }}>\n            {fmt(ded.taxSavings)}\n          </div>\n          <div style={{ fontSize: 9, color: 'var(--text-muted)' }}>tax savings</div>\n        </div>\n        {expanded ? <ChevronUp size={14} color=\"var(--text-muted)\" /> : <ChevronDown size={14} color=\"var(--text-muted)\" />}\n      </div>\n\n      {expanded && (\n        <div style={{ padding: '0 18px 16px', borderTop: '1px solid var(--border-subtle)' }}>\n          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginTop: 14 }}>\n            <div style={{ padding: '10px 14px', borderRadius: 8, background: 'var(--bg-primary)' }}>\n              <div style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 4 }}>Estimated Deduction</div>\n              <div style={{ fontFamily: 'var(--font-mono)', fontSize: 16, fontWeight: 600, color: 'var(--accent-gold)' }}>{fmt(ded.estimatedAmount)}</div>\n            </div>\n            <div style={{ padding: '10px 14px', borderRadius: 8, background: 'var(--bg-primary)' }}>\n              <div style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 4 }}>Tax Savings</div>\n              <div style={{ fontFamily: 'var(--font-mono)', fontSize: 16, fontWeight: 600, color: 'var(--accent-emerald)' }}>{fmt(ded.taxSavings)}</div>\n            </div>\n          </div>\n\n          <div style={{ marginTop: 12 }}>\n            <div style={{ fontSize: 11, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 6 }}>How to Claim</div>\n            <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.6, padding: '8px 12px', borderRadius: 8, background: 'var(--bg-primary)' }}>\n              {ded.howToClaim}\n            </div>\n          </div>\n\n          <div style={{ marginTop: 12 }}>\n            <div style={{ fontSize: 11, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 6 }}>Requirements</div>\n            <div style={{ display: 'flex', flexDirection: 'column', gap: 4 }}>\n              {ded.requirements.map((req, i) => (\n                <div key={i} style={{ display: 'flex', alignItems: 'flex-start', gap: 6, fontSize: 11, color: 'var(--text-secondary)' }}>\n                  <CheckCircle2 size={12} color=\"var(--accent-emerald)\" style={{ marginTop: 1, flexShrink: 0 }} />\n                  {req}\n                </div>\n              ))}\n            </div>\n          </div>\n\n          <div style={{ marginTop: 12, display: 'flex', alignItems: 'center', gap: 6, fontSize: 10, color: 'var(--text-muted)' }}>\n            <div style={{ width: 6, height: 6, borderRadius: 3, background: confColor }} />\n            Confidence: {ded.confidence} · Category: {ded.category}\n          </div>\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\DepreciationView.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'SECTION_179_LIMIT_2024' is defined but never used.","line":6,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":40,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"SECTION_179_LIMIT_2024"},"fix":{"range":[235,259],"text":""},"desc":"Remove unused variable \"SECTION_179_LIMIT_2024\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'STANDARD_MILEAGE_RATE_2024' is defined but never used.","line":6,"column":42,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":68,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"STANDARD_MILEAGE_RATE_2024"},"fix":{"range":[259,287],"text":""},"desc":"Remove unused variable \"STANDARD_MILEAGE_RATE_2024\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DepreciationSummary' is defined but never used.","line":7,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":47,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DepreciationSummary"},"fix":{"range":[335,361],"text":""},"desc":"Remove unused variable \"DepreciationSummary\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Calculator' is defined but never used.","line":10,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":27,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Calculator"},"fix":{"range":[425,437],"text":""},"desc":"Remove unused variable \"Calculator\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ChevronDown' is defined but never used.","line":11,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":14,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ChevronDown"},"fix":{"range":[489,504],"text":""},"desc":"Remove unused variable \"ChevronDown\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DollarSign' is defined but never used.","line":11,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":26,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DollarSign"},"fix":{"range":[504,516],"text":""},"desc":"Remove unused variable \"DollarSign\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'onNavigate' is defined but never used.","line":20,"column":36,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":46},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":47,"column":198,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":47,"endColumn":201,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1949,1952],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1949,1952],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":55,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2379,2382],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2379,2382],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":9,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from 'react'\nimport { useFortuna, genId } from '../hooks/useFortuna'\nimport type { ViewKey } from '../App'\nimport {\n  generateDepreciationSummary, analyzeVehicleDeduction, analyzeHomeOffice,\n  ASSET_CLASSES, SECTION_179_LIMIT_2024, STANDARD_MILEAGE_RATE_2024, BONUS_DEPRECIATION_RATES,\n  type BusinessAsset, type DepreciationSummary,\n} from '../engine/depreciation-engine'\nimport {\n  Plus, Trash2, Calculator, Car, Home, Package, AlertTriangle, Lightbulb, Info,\n  ChevronDown, DollarSign, Clock,\n} from 'lucide-react'\n\ninterface DepreciationViewProps {\n  onNavigate: (view: ViewKey) => void\n}\n\nconst fmt = (n: number) => '$' + Math.abs(n).toLocaleString()\n\nexport function DepreciationView({ onNavigate }: DepreciationViewProps) {\n  const { state, updateState } = useFortuna()\n\n  // Adapt storage DepreciationAssets → engine BusinessAssets on load\n  const storageAssets = (state.depreciationAssets || []).map(da => ({\n    id: da.id,\n    name: da.name,\n    classId: da.category || 'computer',\n    purchaseDate: da.purchaseDate,\n    cost: da.purchasePrice,\n    businessUsePercent: da.businessUsePct,\n    section179Elected: da.method === 'section_179',\n    bonusDepreciation: da.method === 'bonus',\n    salvageValue: da.salvageValue || 0,\n  })) as BusinessAsset[]\n  const [assets, _setAssets] = useState<BusinessAsset[]>(storageAssets)\n\n  // Persist to FortunaState whenever assets change\n  const setAssets: typeof _setAssets = (update) => {\n    _setAssets(prev => {\n      const next = typeof update === 'function' ? update(prev) : update\n      // Convert back to storage DepreciationAsset format\n      updateState(s => ({\n        ...s,\n        depreciationAssets: next.map(a => ({\n          id: a.id,\n          name: a.name,\n          category: (a.classId === 'computer' ? 'computer' : a.classId === 'vehicle' ? 'vehicle' : a.classId === 'furniture' ? 'furniture' : a.classId === 'building' ? 'building' : 'equipment') as any,\n          purchaseDate: a.purchaseDate,\n          purchasePrice: a.cost,\n          method: a.section179Elected ? 'section_179' as const : a.bonusDepreciation ? 'bonus' as const : 'macrs' as const,\n          usefulLifeYears: ASSET_CLASSES.find(c => c.id === a.classId)?.macrsLife || 5,\n          businessUsePct: a.businessUsePercent,\n          salvageValue: a.salvageValue,\n          isActive: true,\n          entityId: (a as any).entityId || 'personal',\n          memberId: 'primary',\n          taxYear: new Date().getFullYear(),\n          tags: [],\n        })),\n      }))\n      return next\n    })\n  }\n  const [activeTab, setActiveTab] = useState<'assets' | 'vehicle' | 'homeoffice' | 'timing'>('assets')\n  const [showAddForm, setShowAddForm] = useState(false)\n\n  // Asset form state\n  const [newAsset, setNewAsset] = useState<Partial<BusinessAsset>>({\n    classId: 'computer', cost: 0, businessUsePercent: 100,\n    section179Elected: true, bonusDepreciation: true, salvageValue: 0,\n    purchaseDate: new Date().toISOString().slice(0, 10),\n  })\n\n  // Vehicle form state\n  const [vehicle, setVehicle] = useState({\n    annualMiles: 15000, businessMiles: 10000, cost: 35000,\n    fuel: 3000, insurance: 1800, maintenance: 1200, parking: 600,\n  })\n\n  // Home office form state\n  const [homeOffice, setHomeOffice] = useState({\n    homeSqFt: 1500, officeSqFt: 150, rentMortgage: 18000,\n    utilities: 3600, insurance: 1800, homeValue: 250000, isOwner: true,\n  })\n\n  const summary = useMemo(\n    () => generateDepreciationSummary(state, assets),\n    [state, assets],\n  )\n\n  const vehicleAnalysis = useMemo(\n    () => analyzeVehicleDeduction(\n      vehicle.annualMiles, vehicle.businessMiles, vehicle.cost,\n      vehicle.fuel, vehicle.insurance, vehicle.maintenance, vehicle.parking,\n      summary.assetResults[0]?.taxSavingsFirstYear ? 0.24 : 0.22,\n    ),\n    [vehicle, summary],\n  )\n\n  const homeOfficeAnalysis = useMemo(\n    () => analyzeHomeOffice(\n      homeOffice.homeSqFt, homeOffice.officeSqFt,\n      homeOffice.rentMortgage, homeOffice.utilities, homeOffice.insurance,\n      homeOffice.homeValue, homeOffice.isOwner, 0.24,\n    ),\n    [homeOffice],\n  )\n\n  const addAsset = () => {\n    if (!newAsset.name || !newAsset.cost) return\n    setAssets(prev => [...prev, {\n      id: genId(),\n      name: newAsset.name || 'New Asset',\n      classId: newAsset.classId || 'computer',\n      purchaseDate: newAsset.purchaseDate || new Date().toISOString().slice(0, 10),\n      cost: newAsset.cost || 0,\n      businessUsePercent: newAsset.businessUsePercent || 100,\n      section179Elected: newAsset.section179Elected ?? true,\n      bonusDepreciation: newAsset.bonusDepreciation ?? true,\n      salvageValue: newAsset.salvageValue || 0,\n    }])\n    setNewAsset({ classId: 'computer', cost: 0, businessUsePercent: 100, section179Elected: true, bonusDepreciation: true, salvageValue: 0, purchaseDate: new Date().toISOString().slice(0, 10) })\n    setShowAddForm(false)\n  }\n\n  const removeAsset = (id: string) => setAssets(prev => prev.filter(a => a.id !== id))\n\n  const bonusRate = BONUS_DEPRECIATION_RATES[new Date().getFullYear()] ?? 0\n\n  const tabs = [\n    { id: 'assets' as const, label: 'Assets & §179', icon: <Package size={14} /> },\n    { id: 'vehicle' as const, label: 'Vehicle', icon: <Car size={14} /> },\n    { id: 'homeoffice' as const, label: 'Home Office', icon: <Home size={14} /> },\n    { id: 'timing' as const, label: 'Purchase Timing', icon: <Clock size={14} /> },\n  ]\n\n  return (\n    <div className=\"view-container\" style={{ padding: 32 }}>\n      <div style={{ marginBottom: 24 }}>\n        <h2 className=\"view-title\" style={{ marginBottom: 4 }}>Depreciation & Asset Strategy</h2>\n        <p style={{ fontSize: 13, color: 'var(--text-muted)' }}>Section 179, bonus depreciation, MACRS schedules, vehicle & home office deductions</p>\n      </div>\n\n      {/* KPI Cards */}\n      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 14, marginBottom: 24 }}>\n        <div className=\"glass-card\" style={{ padding: '16px 18px' }}>\n          <div style={{ fontSize: 10, fontFamily: 'var(--font-mono)', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 6 }}>This Year Deductions</div>\n          <div style={{ fontSize: 22, fontWeight: 600, fontFamily: 'var(--font-mono)', color: 'var(--accent-emerald)' }}>{fmt(summary.currentYearDeduction)}</div>\n        </div>\n        <div className=\"glass-card\" style={{ padding: '16px 18px' }}>\n          <div style={{ fontSize: 10, fontFamily: 'var(--font-mono)', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 6 }}>Tax Savings</div>\n          <div style={{ fontSize: 22, fontWeight: 600, fontFamily: 'var(--font-mono)', color: 'var(--accent-gold)' }}>{fmt(summary.totalTaxSavingsThisYear)}</div>\n        </div>\n        <div className=\"glass-card\" style={{ padding: '16px 18px' }}>\n          <div style={{ fontSize: 10, fontFamily: 'var(--font-mono)', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 6 }}>§179 Remaining</div>\n          <div style={{ fontSize: 22, fontWeight: 600, fontFamily: 'var(--font-mono)', color: 'var(--text-primary)' }}>{fmt(summary.section179Remaining)}</div>\n        </div>\n        <div className=\"glass-card\" style={{ padding: '16px 18px' }}>\n          <div style={{ fontSize: 10, fontFamily: 'var(--font-mono)', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 6 }}>Bonus Depr. Rate</div>\n          <div style={{ fontSize: 22, fontWeight: 600, fontFamily: 'var(--font-mono)', color: bonusRate > 0.5 ? 'var(--accent-emerald)' : 'var(--accent-amber)' }}>{(bonusRate * 100).toFixed(0)}%</div>\n        </div>\n      </div>\n\n      {/* Tabs */}\n      <div style={{ display: 'flex', gap: 4, marginBottom: 20 }}>\n        {tabs.map(t => (\n          <button key={t.id} onClick={() => setActiveTab(t.id)} className={`tab-btn ${activeTab === t.id ? 'active' : ''}`}\n            style={{ display: 'flex', alignItems: 'center', gap: 6, padding: '8px 16px' }}>\n            {t.icon} {t.label}\n          </button>\n        ))}\n      </div>\n\n      {/* ── ASSETS TAB ── */}\n      {activeTab === 'assets' && (\n        <div>\n          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>\n            <div style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)' }}>Business Assets ({assets.length})</div>\n            <button className=\"btn btn-primary\" onClick={() => setShowAddForm(!showAddForm)} style={{ fontSize: 12, padding: '6px 14px', display: 'flex', alignItems: 'center', gap: 6 }}>\n              <Plus size={14} /> Add Asset\n            </button>\n          </div>\n\n          {showAddForm && (\n            <div className=\"glass-card\" style={{ padding: 20, marginBottom: 16 }}>\n              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 12, marginBottom: 12 }}>\n                <div>\n                  <label style={{ fontSize: 11, color: 'var(--text-muted)', display: 'block', marginBottom: 4 }}>Asset Name</label>\n                  <input className=\"input\" value={newAsset.name || ''} onChange={e => setNewAsset({ ...newAsset, name: e.target.value })} placeholder=\"MacBook Pro\" />\n                </div>\n                <div>\n                  <label style={{ fontSize: 11, color: 'var(--text-muted)', display: 'block', marginBottom: 4 }}>Asset Class</label>\n                  <select className=\"input\" value={newAsset.classId} onChange={e => setNewAsset({ ...newAsset, classId: e.target.value })}>\n                    {ASSET_CLASSES.map(c => (\n                      <option key={c.id} value={c.id}>{c.name} ({c.macrsLife}-yr)</option>\n                    ))}\n                  </select>\n                </div>\n                <div>\n                  <label style={{ fontSize: 11, color: 'var(--text-muted)', display: 'block', marginBottom: 4 }}>Purchase Date</label>\n                  <input className=\"input\" type=\"date\" value={newAsset.purchaseDate || ''} onChange={e => setNewAsset({ ...newAsset, purchaseDate: e.target.value })} />\n                </div>\n                <div>\n                  <label style={{ fontSize: 11, color: 'var(--text-muted)', display: 'block', marginBottom: 4 }}>Cost ($)</label>\n                  <input className=\"input\" type=\"number\" value={newAsset.cost || ''} onChange={e => setNewAsset({ ...newAsset, cost: +e.target.value })} placeholder=\"2500\" />\n                </div>\n                <div>\n                  <label style={{ fontSize: 11, color: 'var(--text-muted)', display: 'block', marginBottom: 4 }}>Business Use %</label>\n                  <input className=\"input\" type=\"number\" min={0} max={100} value={newAsset.businessUsePercent || 100} onChange={e => setNewAsset({ ...newAsset, businessUsePercent: +e.target.value })} />\n                </div>\n                <div>\n                  <label style={{ fontSize: 11, color: 'var(--text-muted)', display: 'block', marginBottom: 4 }}>Salvage Value ($)</label>\n                  <input className=\"input\" type=\"number\" value={newAsset.salvageValue || 0} onChange={e => setNewAsset({ ...newAsset, salvageValue: +e.target.value })} />\n                </div>\n              </div>\n              <div style={{ display: 'flex', gap: 16, marginBottom: 12 }}>\n                <label style={{ display: 'flex', alignItems: 'center', gap: 6, fontSize: 12, color: 'var(--text-secondary)', cursor: 'pointer' }}>\n                  <input type=\"checkbox\" checked={newAsset.section179Elected} onChange={e => setNewAsset({ ...newAsset, section179Elected: e.target.checked })} />\n                  Section 179 Expensing\n                </label>\n                <label style={{ display: 'flex', alignItems: 'center', gap: 6, fontSize: 12, color: 'var(--text-secondary)', cursor: 'pointer' }}>\n                  <input type=\"checkbox\" checked={newAsset.bonusDepreciation} onChange={e => setNewAsset({ ...newAsset, bonusDepreciation: e.target.checked })} />\n                  Bonus Depreciation ({bonusRate * 100}%)\n                </label>\n              </div>\n              <div style={{ display: 'flex', gap: 8 }}>\n                <button className=\"btn btn-primary\" onClick={addAsset}>Add Asset</button>\n                <button className=\"btn\" onClick={() => setShowAddForm(false)}>Cancel</button>\n              </div>\n            </div>\n          )}\n\n          {/* Asset results */}\n          {summary.assetResults.length > 0 ? (\n            <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>\n              {summary.assetResults.map(result => (\n                <div key={result.asset.id} className=\"glass-card\" style={{ padding: '18px 20px' }}>\n                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>\n                    <div>\n                      <div style={{ fontSize: 14, fontWeight: 500, color: 'var(--text-primary)', marginBottom: 4 }}>\n                        {result.asset.name}\n                      </div>\n                      <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>\n                        <span className=\"badge gold\">{result.assetClass.name}</span>\n                        <span className=\"badge muted\">{result.method}</span>\n                        <span className=\"badge emerald\">1st yr: {fmt(result.firstYearDeduction)}</span>\n                      </div>\n                    </div>\n                    <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>\n                      <div style={{ textAlign: 'right' }}>\n                        <div style={{ fontSize: 16, fontWeight: 600, fontFamily: 'var(--font-mono)', color: 'var(--accent-emerald)' }}>\n                          {fmt(result.taxSavingsFirstYear)}\n                        </div>\n                        <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>1st yr tax savings</div>\n                      </div>\n                      <button onClick={() => removeAsset(result.asset.id)} style={{ background: 'none', border: 'none', cursor: 'pointer', color: 'var(--text-muted)', padding: 4 }}>\n                        <Trash2 size={14} />\n                      </button>\n                    </div>\n                  </div>\n\n                  {/* Depreciation schedule */}\n                  <div style={{ marginTop: 14, paddingTop: 14, borderTop: '1px solid var(--border-subtle)' }}>\n                    <div style={{ display: 'flex', gap: 6, flexWrap: 'wrap' }}>\n                      {result.schedule.map(yr => (\n                        <div key={yr.year} style={{\n                          padding: '6px 10px', borderRadius: 8, background: 'var(--bg-surface)',\n                          textAlign: 'center', minWidth: 80,\n                        }}>\n                          <div style={{ fontSize: 10, fontFamily: 'var(--font-mono)', color: 'var(--text-muted)' }}>{yr.year}</div>\n                          <div style={{ fontSize: 12, fontFamily: 'var(--font-mono)', fontWeight: 600, color: yr.totalDepreciation > 0 ? 'var(--accent-gold)' : 'var(--text-muted)' }}>\n                            {fmt(yr.totalDepreciation)}\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          ) : (\n            <div className=\"glass-card\" style={{ padding: 32, textAlign: 'center' }}>\n              <Package size={36} color=\"var(--text-muted)\" style={{ marginBottom: 12 }} />\n              <p style={{ color: 'var(--text-secondary)', margin: 0 }}>Add business assets to calculate depreciation schedules and tax savings.</p>\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* ── VEHICLE TAB ── */}\n      {activeTab === 'vehicle' && (\n        <div>\n          <div className=\"glass-card\" style={{ padding: 20, marginBottom: 16 }}>\n            <div style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)', marginBottom: 14 }}>Vehicle Deduction Calculator</div>\n            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 12, marginBottom: 16 }}>\n              {[\n                { label: 'Annual Miles', key: 'annualMiles', val: vehicle.annualMiles },\n                { label: 'Business Miles', key: 'businessMiles', val: vehicle.businessMiles },\n                { label: 'Vehicle Cost ($)', key: 'cost', val: vehicle.cost },\n                { label: 'Annual Fuel ($)', key: 'fuel', val: vehicle.fuel },\n                { label: 'Annual Insurance ($)', key: 'insurance', val: vehicle.insurance },\n                { label: 'Maintenance ($)', key: 'maintenance', val: vehicle.maintenance },\n                { label: 'Parking/Tolls ($)', key: 'parking', val: vehicle.parking },\n              ].map(f => (\n                <div key={f.key}>\n                  <label style={{ fontSize: 11, color: 'var(--text-muted)', display: 'block', marginBottom: 4 }}>{f.label}</label>\n                  <input className=\"input\" type=\"number\" value={f.val} onChange={e => setVehicle({ ...vehicle, [f.key]: +e.target.value })} />\n                </div>\n              ))}\n            </div>\n          </div>\n\n          {/* Comparison */}\n          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 14 }}>\n            <div className=\"glass-card\" style={{\n              padding: 20,\n              border: vehicleAnalysis.recommendation === 'standard_mileage' ? '1px solid var(--accent-emerald)' : undefined,\n            }}>\n              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>\n                <div style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)' }}>Standard Mileage</div>\n                {vehicleAnalysis.recommendation === 'standard_mileage' && <span className=\"badge emerald\">✓ RECOMMENDED</span>}\n              </div>\n              <div style={{ fontSize: 24, fontWeight: 600, fontFamily: 'var(--font-mono)', color: 'var(--accent-gold)', marginBottom: 8 }}>\n                {fmt(vehicleAnalysis.standardMileage.annualDeduction)}\n              </div>\n              <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.5 }}>\n                {vehicleAnalysis.standardMileage.calculation}\n              </div>\n            </div>\n            <div className=\"glass-card\" style={{\n              padding: 20,\n              border: vehicleAnalysis.recommendation === 'actual_expense' ? '1px solid var(--accent-emerald)' : undefined,\n            }}>\n              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>\n                <div style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)' }}>Actual Expense</div>\n                {vehicleAnalysis.recommendation === 'actual_expense' && <span className=\"badge emerald\">✓ RECOMMENDED</span>}\n              </div>\n              <div style={{ fontSize: 24, fontWeight: 600, fontFamily: 'var(--font-mono)', color: 'var(--accent-gold)', marginBottom: 8 }}>\n                {fmt(vehicleAnalysis.actualExpense.annualDeduction)}\n              </div>\n              <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.5 }}>\n                {vehicleAnalysis.actualExpense.calculation}\n              </div>\n            </div>\n          </div>\n\n          <div className=\"glass-card\" style={{ padding: 16, marginTop: 14 }}>\n            <div style={{ fontSize: 12, fontWeight: 500, color: 'var(--accent-gold)', marginBottom: 8 }}>\n              Difference: {fmt(vehicleAnalysis.difference)}/year more with {vehicleAnalysis.recommendation === 'standard_mileage' ? 'Standard Mileage' : 'Actual Expense'}\n            </div>\n            {vehicleAnalysis.notes.map((n, i) => (\n              <div key={i} style={{ fontSize: 12, color: 'var(--text-secondary)', padding: '3px 0', display: 'flex', gap: 6, alignItems: 'flex-start' }}>\n                <Info size={12} color=\"var(--text-muted)\" style={{ flexShrink: 0, marginTop: 2 }} /> {n}\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {/* ── HOME OFFICE TAB ── */}\n      {activeTab === 'homeoffice' && (\n        <div>\n          <div className=\"glass-card\" style={{ padding: 20, marginBottom: 16 }}>\n            <div style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)', marginBottom: 14 }}>Home Office Deduction Calculator</div>\n            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 12 }}>\n              {[\n                { label: 'Total Home (sq ft)', key: 'homeSqFt', val: homeOffice.homeSqFt },\n                { label: 'Office (sq ft)', key: 'officeSqFt', val: homeOffice.officeSqFt },\n                { label: 'Rent/Mortgage ($/yr)', key: 'rentMortgage', val: homeOffice.rentMortgage },\n                { label: 'Utilities ($/yr)', key: 'utilities', val: homeOffice.utilities },\n                { label: 'Insurance ($/yr)', key: 'insurance', val: homeOffice.insurance },\n                { label: 'Home Value ($)', key: 'homeValue', val: homeOffice.homeValue },\n              ].map(f => (\n                <div key={f.key}>\n                  <label style={{ fontSize: 11, color: 'var(--text-muted)', display: 'block', marginBottom: 4 }}>{f.label}</label>\n                  <input className=\"input\" type=\"number\" value={f.val} onChange={e => setHomeOffice({ ...homeOffice, [f.key]: +e.target.value })} />\n                </div>\n              ))}\n              <div>\n                <label style={{ fontSize: 11, color: 'var(--text-muted)', display: 'block', marginBottom: 4 }}>Ownership</label>\n                <select className=\"input\" value={homeOffice.isOwner ? 'own' : 'rent'} onChange={e => setHomeOffice({ ...homeOffice, isOwner: e.target.value === 'own' })}>\n                  <option value=\"own\">Own</option>\n                  <option value=\"rent\">Rent</option>\n                </select>\n              </div>\n            </div>\n          </div>\n\n          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 14 }}>\n            <div className=\"glass-card\" style={{\n              padding: 20,\n              border: homeOfficeAnalysis.recommendation === 'simplified' ? '1px solid var(--accent-emerald)' : undefined,\n            }}>\n              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>\n                <div style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)' }}>Simplified Method</div>\n                {homeOfficeAnalysis.recommendation === 'simplified' && <span className=\"badge emerald\">✓ RECOMMENDED</span>}\n              </div>\n              <div style={{ fontSize: 24, fontWeight: 600, fontFamily: 'var(--font-mono)', color: 'var(--accent-gold)', marginBottom: 8 }}>\n                {fmt(homeOfficeAnalysis.simplified.deduction)}\n              </div>\n              <div style={{ fontSize: 12, color: 'var(--text-secondary)' }}>{homeOfficeAnalysis.simplified.calculation}</div>\n            </div>\n            <div className=\"glass-card\" style={{\n              padding: 20,\n              border: homeOfficeAnalysis.recommendation === 'regular' ? '1px solid var(--accent-emerald)' : undefined,\n            }}>\n              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>\n                <div style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)' }}>Regular Method</div>\n                {homeOfficeAnalysis.recommendation === 'regular' && <span className=\"badge emerald\">✓ RECOMMENDED</span>}\n              </div>\n              <div style={{ fontSize: 24, fontWeight: 600, fontFamily: 'var(--font-mono)', color: 'var(--accent-gold)', marginBottom: 8 }}>\n                {fmt(homeOfficeAnalysis.regular.deduction)}\n              </div>\n              <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.5 }}>{homeOfficeAnalysis.regular.calculation}</div>\n            </div>\n          </div>\n\n          <div className=\"glass-card\" style={{ padding: 16, marginTop: 14, fontSize: 12, color: 'var(--accent-gold)' }}>\n            Difference: {fmt(homeOfficeAnalysis.difference)}/year more with {homeOfficeAnalysis.recommendation === 'simplified' ? 'Simplified' : 'Regular'} method\n          </div>\n        </div>\n      )}\n\n      {/* ── PURCHASE TIMING TAB ── */}\n      {activeTab === 'timing' && (\n        <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>\n          {summary.purchaseTimingInsights.map((ins, i) => {\n            const cfg: Record<string, { icon: React.ReactNode; color: string }> = {\n              warning: { icon: <AlertTriangle size={16} />, color: 'var(--accent-amber)' },\n              opportunity: { icon: <Lightbulb size={16} />, color: 'var(--accent-emerald)' },\n              info: { icon: <Info size={16} />, color: 'var(--accent-blue)' },\n            }\n            const c = cfg[ins.type] || cfg.info\n\n            return (\n              <div key={i} className=\"glass-card\" style={{ padding: '16px 20px', display: 'flex', gap: 14, alignItems: 'flex-start' }}>\n                <div style={{\n                  width: 32, height: 32, borderRadius: 10, flexShrink: 0,\n                  background: `${c.color}15`, display: 'flex', alignItems: 'center', justifyContent: 'center',\n                  color: c.color,\n                }}>{c.icon}</div>\n                <div style={{ flex: 1 }}>\n                  <div style={{ fontSize: 14, fontWeight: 500, color: 'var(--text-primary)', marginBottom: 4 }}>{ins.title}</div>\n                  <p style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.5, margin: 0 }}>{ins.detail}</p>\n                </div>\n                {ins.impact != null && (\n                  <div style={{ textAlign: 'right', flexShrink: 0 }}>\n                    <div style={{ fontSize: 16, fontWeight: 600, fontFamily: 'var(--font-mono)', color: c.color }}>{fmt(ins.impact)}</div>\n                  </div>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\DocumentCenter.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useEffect' is defined but never used.","line":1,"column":50,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":59,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useEffect"},"fix":{"range":[47,58],"text":""},"desc":"Remove unused variable \"useEffect\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":76,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":76,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3475,3478],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3475,3478],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'setAiDocs'. Either include it or remove the dependency array.","line":82,"column":6,"nodeType":"ArrayExpression","endLine":82,"endColumn":13,"suggestions":[{"desc":"Update the dependencies array to be: [setAiDocs, state]","fix":{"range":[3628,3635],"text":"[setAiDocs, state]"}}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo, useRef, useCallback, useEffect } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { getAvailableDocuments, type GeneratedDocument, type DocumentTemplate } from '../engine/document-generator'\nimport {\n  generateAIDocument, saveAIDocument, getAIDocuments, deleteAIDocument,\n  AI_DOC_TEMPLATES, type GeneratedAIDocument, type DocGenStatus,\n} from '../engine/ai-documents'\nimport { getAISettings } from '../engine/ai-providers'\nimport {\n  FileText, Download, Printer, Eye, ChevronRight, FileCheck, Briefcase,\n  Shield, Receipt, Sparkles, Loader2, Trash2, Clock, Bot, AlertTriangle,\n} from 'lucide-react'\n\nexport function DocumentCenter() {\n  const { state, updateState } = useFortuna()\n  const [selectedDoc, setSelectedDoc] = useState<GeneratedDocument | null>(null)\n  const [selectedAIDoc, setSelectedAIDoc] = useState<GeneratedAIDocument | null>(null)\n  const [activeCategory, setActiveCategory] = useState<string>('ai')\n  const [genStatus, setGenStatus] = useState<DocGenStatus>('idle')\n  const [genError, setGenError] = useState<string | null>(null)\n  const [generatingId, setGeneratingId] = useState<string | null>(null)\n  // Hydrate from FortunaState (cloud), fall back to localStorage (migration)\n  const [aiDocs, setAiDocsRaw] = useState<GeneratedAIDocument[]>(() => {\n    const fromState = state.aiDocuments as GeneratedAIDocument[] | undefined\n    return (fromState && fromState.length > 0) ? fromState : getAIDocuments()\n  })\n  const setAiDocs = useCallback((docs: GeneratedAIDocument[]) => {\n    setAiDocsRaw(docs)\n    updateState(s => ({ ...s, aiDocuments: docs }))\n  }, [updateState])\n  const previewRef = useRef<HTMLDivElement>(null)\n\n  const templates = useMemo(() => getAvailableDocuments(state), [state])\n\n  const categories = [\n    { key: 'ai', label: 'AI Documents', icon: <Sparkles size={16} /> },\n    { key: 'all', label: 'All Templates', icon: <FileText size={16} /> },\n    { key: 'tax', label: 'Tax Documents', icon: <Receipt size={16} /> },\n    { key: 'audit', label: 'Audit Prep', icon: <Shield size={16} /> },\n    { key: 'cpa', label: 'CPA Package', icon: <Briefcase size={16} /> },\n    { key: 'entity', label: 'Entity', icon: <FileCheck size={16} /> },\n  ]\n\n  const filtered = activeCategory === 'all' ? templates\n    : activeCategory === 'ai' ? []\n    : templates.filter(t => t.category === activeCategory)\n\n  const activeDoc = selectedAIDoc || selectedDoc\n  const activeContent = selectedAIDoc?.content || selectedDoc?.content || ''\n  const activeTitle = selectedAIDoc?.title || selectedDoc?.title || ''\n\n  const generateTemplateDoc = (template: DocumentTemplate) => {\n    setSelectedAIDoc(null)\n    const doc = template.generator(state)\n    setSelectedDoc(doc)\n  }\n\n  const handleAIGenerate = useCallback(async (templateId: string) => {\n    const settings = getAISettings()\n    const hasDirectKey = settings.providers.some(p => p.apiKey)\n    const hasProxy = settings.mode === 'proxy'\n    if (!hasDirectKey && !hasProxy) {\n      setGenError('No AI provider configured. Set up an API key in the AI Advisor settings, or log in to use server-side keys.')\n      return\n    }\n    setGenError(null)\n    setGeneratingId(templateId)\n    setGenStatus('idle')\n    try {\n      const doc = await generateAIDocument(templateId, state, setGenStatus)\n      saveAIDocument(doc)\n      setAiDocs(getAIDocuments())\n      setSelectedDoc(null)\n      setSelectedAIDoc(doc)\n      setGenStatus('complete')\n    } catch (err: any) {\n      setGenError(err.message || 'Document generation failed')\n      setGenStatus('error')\n    } finally {\n      setGeneratingId(null)\n    }\n  }, [state])\n\n  const viewAIDoc = (doc: GeneratedAIDocument) => { setSelectedDoc(null); setSelectedAIDoc(doc) }\n\n  const removeAIDoc = (id: string) => {\n    deleteAIDocument(id)\n    setAiDocs(getAIDocuments())\n    if (selectedAIDoc?.id === id) setSelectedAIDoc(null)\n  }\n\n  const handlePrint = () => {\n    if (!activeContent) return\n    const w = window.open('', '_blank')\n    if (w) {\n      w.document.write(`<!DOCTYPE html><html><head><title>${activeTitle}</title><style>body{margin:24px}@media print{body{margin:0}}</style></head><body>${activeContent}</body></html>`)\n      w.document.close(); w.print()\n    }\n  }\n\n  const handleDownload = () => {\n    if (!activeContent) return\n    const blob = new Blob([`<!DOCTYPE html><html><head><meta charset=\"utf-8\"><title>${activeTitle}</title></head><body>${activeContent}</body></html>`], { type: 'text/html' })\n    const url = URL.createObjectURL(blob)\n    const a = document.createElement('a'); a.href = url\n    a.download = `${activeTitle.replace(/[^a-z0-9]+/gi, '-').toLowerCase()}.html`\n    a.click(); URL.revokeObjectURL(url)\n  }\n\n  const typeLabels: Record<string, { label: string; color: string }> = {\n    voucher: { label: 'VOUCHER', color: 'var(--accent-gold)' },\n    checklist: { label: 'CHECKLIST', color: 'var(--accent-emerald)' },\n    worksheet: { label: 'WORKSHEET', color: 'var(--accent-blue, #60a5fa)' },\n    report: { label: 'REPORT', color: 'var(--accent-blue, #60a5fa)' },\n    letter: { label: 'LETTER', color: 'var(--text-secondary)' },\n  }\n\n  const statusLabels: Record<DocGenStatus, string> = {\n    idle: '', 'building-context': 'Analyzing financial data...', generating: 'AI is writing your document...', complete: 'Complete!', error: 'Generation failed',\n  }\n\n  return (\n    <div style={{ padding: 32, maxWidth: 1200, display: 'flex', gap: 24, minHeight: 'calc(100vh - 64px)' }}>\n      {/* Left: Document List */}\n      <div style={{ width: activeDoc ? 380 : '100%', flexShrink: 0, transition: 'width 0.3s ease' }}>\n        <div style={{ marginBottom: 24 }}>\n          <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 8 }}>\n            <FileText size={24} style={{ color: 'var(--accent-gold)' }} />\n            <h1 style={{ fontFamily: 'var(--font-display)', fontSize: 28, color: 'var(--text-primary)', margin: 0 }}>Document Center</h1>\n          </div>\n          <p style={{ color: 'var(--text-muted)', fontSize: 14, margin: 0 }}>Generate documents with AI or use templates for tax forms and checklists</p>\n        </div>\n\n        {/* Category tabs */}\n        <div style={{ display: 'flex', gap: 6, marginBottom: 20, flexWrap: 'wrap' }}>\n          {categories.map(cat => (\n            <button key={cat.key} onClick={() => setActiveCategory(cat.key)} style={{\n              display: 'flex', alignItems: 'center', gap: 6, padding: '7px 14px', borderRadius: 8,\n              border: 'none', cursor: 'pointer',\n              background: activeCategory === cat.key ? 'var(--accent-gold-dim)' : 'var(--bg-elevated)',\n              color: activeCategory === cat.key ? 'var(--accent-gold)' : 'var(--text-secondary)',\n              fontSize: 12, fontWeight: 500, transition: 'all 0.2s',\n            }}>\n              {cat.icon} {cat.label}\n            </button>\n          ))}\n        </div>\n\n        {/* Error banner */}\n        {genError && (\n          <div style={{ display: 'flex', alignItems: 'center', gap: 8, padding: '10px 14px', marginBottom: 12, borderRadius: 10, background: 'rgba(239,68,68,0.08)', border: '1px solid rgba(239,68,68,0.15)', fontSize: 12, color: '#fca5a5' }}>\n            <AlertTriangle size={14} />\n            <span style={{ flex: 1 }}>{genError}</span>\n            <button onClick={() => setGenError(null)} style={{ background: 'none', border: 'none', color: '#fca5a5', cursor: 'pointer', fontSize: 16 }}>×</button>\n          </div>\n        )}\n\n        {/* AI Document Templates */}\n        {activeCategory === 'ai' && (\n          <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>\n            <div style={{ fontSize: 11, fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.05em', marginBottom: 4 }}>Generate New</div>\n\n            {AI_DOC_TEMPLATES.map(template => {\n              const isGenerating = generatingId === template.id\n              return (\n                <button key={template.id} onClick={() => !isGenerating && handleAIGenerate(template.id)} disabled={isGenerating}\n                  style={{\n                    display: 'flex', alignItems: 'center', gap: 14, padding: '14px 16px', borderRadius: 12,\n                    border: '1px solid var(--border-subtle)', background: isGenerating ? 'rgba(245,158,11,0.06)' : 'var(--bg-elevated)',\n                    cursor: isGenerating ? 'wait' : 'pointer', textAlign: 'left', width: '100%',\n                    transition: 'all 0.2s', opacity: isGenerating ? 0.8 : 1,\n                  }}\n                  onMouseEnter={e => { if (!isGenerating) e.currentTarget.style.borderColor = 'var(--accent-gold)' }}\n                  onMouseLeave={e => { e.currentTarget.style.borderColor = 'var(--border-subtle)' }}\n                >\n                  <div style={{ width: 40, height: 40, borderRadius: 10, background: 'rgba(245,158,11,0.08)', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0, fontSize: 20 }}>\n                    {isGenerating ? <Loader2 size={18} className=\"spin\" style={{ color: 'var(--accent-gold)' }} /> : template.icon}\n                  </div>\n                  <div style={{ flex: 1, minWidth: 0 }}>\n                    <div style={{ fontSize: 13, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 2 }}>{template.title}</div>\n                    <div style={{ fontSize: 11, color: 'var(--text-muted)', lineHeight: 1.4 }}>{isGenerating ? statusLabels[genStatus] : template.description}</div>\n                  </div>\n                  <div style={{ display: 'flex', alignItems: 'center', gap: 6, flexShrink: 0 }}>\n                    <span style={{ padding: '2px 8px', borderRadius: 4, fontSize: 9, fontWeight: 700, letterSpacing: '0.05em', color: 'var(--accent-gold)', background: 'rgba(245,158,11,0.1)' }}>AI</span>\n                    {!isGenerating && <ChevronRight size={14} style={{ color: 'var(--text-muted)' }} />}\n                  </div>\n                </button>\n              )\n            })}\n\n            {/* Previously generated */}\n            {aiDocs.length > 0 && (\n              <>\n                <div style={{ fontSize: 11, fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.05em', marginTop: 16, marginBottom: 4 }}>\n                  Previously Generated ({aiDocs.length})\n                </div>\n                {aiDocs.map(doc => (\n                  <div key={doc.id} onClick={() => viewAIDoc(doc)} style={{\n                    display: 'flex', alignItems: 'center', gap: 12, padding: '10px 14px', borderRadius: 10,\n                    border: `1px solid ${selectedAIDoc?.id === doc.id ? 'var(--accent-gold)' : 'var(--border-subtle)'}`,\n                    background: selectedAIDoc?.id === doc.id ? 'var(--accent-gold-dim)' : 'var(--bg-elevated)',\n                    cursor: 'pointer', transition: 'all 0.2s',\n                  }}>\n                    <Bot size={14} style={{ color: 'var(--accent-gold)', flexShrink: 0 }} />\n                    <div style={{ flex: 1, minWidth: 0 }}>\n                      <div style={{ fontSize: 12, fontWeight: 500, color: 'var(--text-primary)', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{doc.title}</div>\n                      <div style={{ fontSize: 10, color: 'var(--text-muted)', display: 'flex', alignItems: 'center', gap: 6 }}>\n                        <Clock size={9} />\n                        {new Date(doc.generatedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}\n                        <span>•</span>\n                        {doc.aiProvider}\n                      </div>\n                    </div>\n                    <button onClick={e => { e.stopPropagation(); removeAIDoc(doc.id) }} style={{ background: 'none', border: 'none', cursor: 'pointer', color: 'var(--text-muted)', padding: 4, opacity: 0.5 }} title=\"Delete\">\n                      <Trash2 size={12} />\n                    </button>\n                  </div>\n                ))}\n              </>\n            )}\n          </div>\n        )}\n\n        {/* Template Documents */}\n        {activeCategory !== 'ai' && (\n          <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>\n            {filtered.map(template => {\n              const typeInfo = typeLabels[template.type] || typeLabels.report\n              return (\n                <button key={template.id} onClick={() => generateTemplateDoc(template)} style={{\n                  display: 'flex', alignItems: 'center', gap: 14, padding: '16px 18px', borderRadius: 12,\n                  border: '1px solid var(--border-subtle)', background: 'var(--bg-elevated)',\n                  cursor: 'pointer', textAlign: 'left', width: '100%', transition: 'all 0.2s',\n                }}\n                  onMouseEnter={e => { e.currentTarget.style.borderColor = 'var(--accent-gold)' }}\n                  onMouseLeave={e => { e.currentTarget.style.borderColor = 'var(--border-subtle)' }}\n                >\n                  <div style={{ width: 40, height: 40, borderRadius: 10, background: `${typeInfo.color}15`, display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 }}>\n                    <FileText size={18} style={{ color: typeInfo.color }} />\n                  </div>\n                  <div style={{ flex: 1, minWidth: 0 }}>\n                    <div style={{ fontSize: 13, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 2 }}>{template.title}</div>\n                    <div style={{ fontSize: 11, color: 'var(--text-muted)', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{template.description}</div>\n                  </div>\n                  <div style={{ display: 'flex', alignItems: 'center', gap: 8, flexShrink: 0 }}>\n                    <span style={{ padding: '2px 8px', borderRadius: 4, fontSize: 9, fontWeight: 700, letterSpacing: '0.05em', color: typeInfo.color, background: `${typeInfo.color}15` }}>{typeInfo.label}</span>\n                    <ChevronRight size={14} style={{ color: 'var(--text-muted)' }} />\n                  </div>\n                </button>\n              )\n            })}\n          </div>\n        )}\n      </div>\n\n      {/* Right: Document Preview */}\n      {activeDoc && (\n        <div style={{ flex: 1, minWidth: 0 }}>\n          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '12px 16px', background: 'var(--bg-elevated)', borderRadius: '12px 12px 0 0', border: '1px solid var(--border-subtle)', borderBottom: 'none' }}>\n            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n              {selectedAIDoc ? <Sparkles size={14} style={{ color: 'var(--accent-gold)' }} /> : <Eye size={14} style={{ color: 'var(--accent-gold)' }} />}\n              <span style={{ fontSize: 13, fontWeight: 600, color: 'var(--text-primary)' }}>{activeTitle}</span>\n            </div>\n            <div style={{ display: 'flex', gap: 8 }}>\n              <button onClick={handlePrint} style={{ display: 'flex', alignItems: 'center', gap: 6, padding: '6px 14px', borderRadius: 8, border: '1px solid var(--border-subtle)', background: 'var(--bg-primary)', color: 'var(--text-secondary)', cursor: 'pointer', fontSize: 12, fontWeight: 500 }}>\n                <Printer size={13} /> Print\n              </button>\n              <button onClick={handleDownload} style={{ display: 'flex', alignItems: 'center', gap: 6, padding: '6px 14px', borderRadius: 8, border: 'none', background: 'var(--accent-gold)', color: '#0c0e12', cursor: 'pointer', fontSize: 12, fontWeight: 600 }}>\n                <Download size={13} /> Download\n              </button>\n            </div>\n          </div>\n          <div ref={previewRef} style={{ background: '#ffffff', border: '1px solid var(--border-subtle)', borderRadius: '0 0 12px 12px', minHeight: 500, maxHeight: 'calc(100vh - 200px)', overflow: 'auto', padding: selectedAIDoc ? 24 : 0 }} dangerouslySetInnerHTML={{ __html: activeContent }} />\n          <div style={{ display: 'flex', justifyContent: 'space-between', padding: '10px 4px', fontSize: 11, color: 'var(--text-muted)' }}>\n            <span>Generated: {new Date(selectedAIDoc?.generatedAt || selectedDoc?.generatedAt || '').toLocaleString()}</span>\n            {selectedAIDoc?.tokensUsed && <span>{selectedAIDoc.tokensUsed.toLocaleString()} tokens</span>}\n          </div>\n        </div>\n      )}\n\n      <style>{`.spin { animation: spin 1s linear infinite; } @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }`}</style>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\DocumentIntake.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'X' is defined but never used.","line":2,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":19,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"X"},"fix":{"range":[73,76],"text":""},"desc":"Remove unused variable \"X\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":61,"column":72,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":75,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2890,2893],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2890,2893],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":198,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":198,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9307,9310],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9307,9310],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":265,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":265,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12370,12373],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12370,12373],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":272,"column":75,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":272,"endColumn":78,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12629,12632],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12629,12632],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":292,"column":88,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":292,"endColumn":91,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13466,13469],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13466,13469],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":560,"column":92,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":560,"endColumn":95,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32601,32604],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32601,32604],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":672,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":672,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[42179,42182],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[42179,42182],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useMemo, useRef } from 'react'\r\nimport { Camera, X, Check, Loader2, ArrowRight, TrendingDown, FileText, ImageIcon, Ban, RefreshCw, Trash2, AlertTriangle, Shield, AlertCircle } from 'lucide-react'\r\nimport { useFortuna } from '../hooks/useFortuna'\r\nimport { MobileDocumentScanner } from '../components/MobileDocumentScanner'\r\nimport { processDocumentImage } from '../engine/vision-processor'\r\nimport { createBatch, processBatch } from '../engine/batch-intake'\r\nimport { BlobStore } from '../engine/blob-store'\r\nimport { type IntakeBatch, type DocumentRecord, type ReceiptRecord, type FortunaState } from '../engine/storage'\r\n\r\ntype IntakeStage = 'idle' | 'scanning' | 'processing' | 'review' | 'done'\r\n\r\nexport function DocumentIntake() {\r\n    const { state, updateState } = useFortuna()\r\n    const [stage, setStage] = useState<IntakeStage>('idle')\r\n    const [error, setError] = useState<string | null>(null)\r\n    const [processingMessage, setProcessingMessage] = useState('Initializing...')\r\n    const [selectedDocIds, setSelectedDocIds] = useState<string[]>([])\r\n    const [backgroundProcessingCount, setBackgroundProcessingCount] = useState(0)\r\n    const [expandedDocId, setExpandedDocId] = useState<string | null>(null)\r\n\r\n    // REACTIVE STATE: Derive current session data directly from global state\r\n    // This solves multi-device sync and button-not-firing issues\r\n    const currentBatch = useMemo(() => {\r\n        if (!state.intakeBatches) return null\r\n        return state.intakeBatches.find(b => b.status === 'uploading') || null\r\n    }, [state.intakeBatches])\r\n\r\n    const [activeSessionBatchId, setActiveSessionBatchId] = useState<string | null>(null)\r\n\r\n    // Sync activeBatchId with currentBatch\r\n    React.useEffect(() => {\r\n        if (currentBatch?.id) {\r\n            setActiveSessionBatchId(currentBatch.id)\r\n        }\r\n    }, [currentBatch?.id])\r\n\r\n    const scannedDocuments = useMemo(() => {\r\n        const bid = activeSessionBatchId || currentBatch?.id\r\n        if (!bid) return []\r\n        return state.documents.filter(d => d.batchId === bid)\r\n    }, [state.documents, currentBatch, activeSessionBatchId])\r\n\r\n    const scannedImageCount = scannedDocuments.length\r\n\r\n    // Auto-advance to review if we have a recovered or active session\r\n    useMemo(() => {\r\n        if (stage === 'idle' && scannedDocuments.length > 0) {\r\n            setStage('review')\r\n        }\r\n    }, [scannedDocuments.length, stage])\r\n\r\n    const stats = useMemo(() => {\r\n        const result = {\r\n            totalCount: scannedDocuments.length,\r\n            notApplicableCount: 0,\r\n            notApplicableTotal: 0,\r\n            categorizedCount: 0,\r\n            totalAmount: 0,\r\n            byTypeCount: {} as Record<string, number>,\r\n            byTypeTotal: {} as Record<string, number>,\r\n            receipts: [] as { merchant: string; amount: number; items: any[] }[]\r\n        }\r\n\r\n        scannedDocuments.forEach((doc: DocumentRecord) => {\r\n            const type = doc.documentType\r\n            const amount = Number(doc.metadata.totalAmount || doc.metadata.amountDue || 0)\r\n\r\n            if (type === 'not_applicable') {\r\n                result.notApplicableCount++\r\n                result.notApplicableTotal += amount\r\n            } else {\r\n                result.categorizedCount++\r\n                result.totalAmount += amount\r\n\r\n                result.byTypeCount[type] = (result.byTypeCount[type] || 0) + 1\r\n                result.byTypeTotal[type] = (result.byTypeTotal[type] || 0) + amount\r\n\r\n                if (type === 'receipt') {\r\n                    result.receipts.push({\r\n                        merchant: doc.metadata.merchantName || 'Receipt',\r\n                        amount,\r\n                        items: doc.metadata.lineItems || []\r\n                    })\r\n                }\r\n            }\r\n        })\r\n\r\n        return result\r\n    }, [scannedDocuments])\r\n\r\n    const handleStartScanning = () => {\r\n        setError(null)\r\n        setStage('scanning')\r\n    }\r\n\r\n    const handleImageCapture = async (base64Image: string) => {\r\n        setBackgroundProcessingCount((prev: number) => prev + 1)\r\n        setError(null)\r\n\r\n        try {\r\n            // 0. Provide context for multi-page grouping\r\n            // Find the last document in the current active batch for context\r\n            const activeBatch = state.intakeBatches.find(b => b.status === 'uploading')\r\n            const lastDoc = activeBatch\r\n                ? [...state.documents].reverse().find(d => d.batchId === activeBatch.id)\r\n                : null\r\n\r\n            const previousContext = lastDoc ? {\r\n                summary: lastDoc.summary || '',\r\n                type: lastDoc.documentType,\r\n                merchant: lastDoc.metadata.merchantName || lastDoc.metadata.agency\r\n            } : undefined\r\n\r\n            // 1. Process via Vision AI\r\n            const visionResult = await processDocumentImage(base64Image, 'openrouter', 'google/gemini-2.0-flash-001', previousContext)\r\n\r\n            if (!visionResult.success || !visionResult.document) {\r\n                throw new Error(visionResult.error || \"Failed to extract document data.\")\r\n            }\r\n\r\n            const newImageData = visionResult.document\r\n            const { isContinuation } = visionResult\r\n\r\n            // 1.5 Save full image to BlobStore (always use the new ID generated by vision-processor for the blob)\r\n            if (visionResult.fullImage) {\r\n                await BlobStore.save(newImageData.id, visionResult.fullImage)\r\n            }\r\n\r\n            // 2. Update global state atomically\r\n            updateState((s: FortunaState) => {\r\n                const draft: FortunaState = { ...s }\r\n                let batch = draft.intakeBatches.find((b: IntakeBatch) => b.status === 'uploading')\r\n\r\n                if (!batch) {\r\n                    batch = createBatch('Mobile Scan Session')\r\n                    draft.intakeBatches = [...draft.intakeBatches, batch]\r\n                }\r\n\r\n                const activeBatchId = batch.id\r\n\r\n                // If it's a continuation, append to the last document instead of creating a new one\r\n                const existingDoc = isContinuation\r\n                    ? draft.documents.find((d: DocumentRecord) => d.id === lastDoc?.id)\r\n                    : null\r\n\r\n                if (existingDoc) {\r\n                    // APPEND PAGE\r\n                    existingDoc.pages = [...existingDoc.pages, `blob:${newImageData.id}`]\r\n                    existingDoc.pageThumbnails = [...existingDoc.pageThumbnails, newImageData.pageThumbnails[0]]\r\n                    existingDoc.pageCount = (existingDoc.pageCount || 1) + 1\r\n\r\n                    // Also update receipt if applicable (appending to the items list?)\r\n                    if (visionResult.receiptItems && visionResult.receiptItems.length > 0) {\r\n                        const existingReceipt = draft.receipts.find((r: ReceiptRecord) => r.id === existingDoc.id)\r\n                        if (existingReceipt) {\r\n                            existingReceipt.items = [...existingReceipt.items, ...visionResult.receiptItems]\r\n                            // Sum up totals if they were extracted from this page too (optional complexity)\r\n                            if (newImageData.metadata.totalAmount) {\r\n                                existingReceipt.totalAmount = (existingReceipt.totalAmount || 0) + Number(newImageData.metadata.totalAmount)\r\n                            }\r\n                        }\r\n                    }\r\n                } else {\r\n                    // NEW DOCUMENT\r\n                    const documentWithBatch: DocumentRecord = { ...newImageData, batchId: activeBatchId }\r\n                    draft.documents = [...draft.documents, documentWithBatch]\r\n\r\n                    // Handle Receipts\r\n                    if (visionResult.receiptItems) {\r\n                        const receiptRecord: ReceiptRecord = {\r\n                            id: newImageData.id,\r\n                            date: newImageData.metadata.documentDate || new Date().toISOString().split('T')[0],\r\n                            merchantName: newImageData.metadata.merchantName || 'Unknown Vendor',\r\n                            totalAmount: Number(newImageData.metadata.totalAmount) || 0,\r\n                            taxAmount: Number(newImageData.metadata.taxAmount) || 0,\r\n                            tipAmount: Number(newImageData.metadata.tipAmount) || 0,\r\n                            status: 'needs_review' as const,\r\n                            batchId: activeBatchId,\r\n                            items: visionResult.receiptItems\r\n                        }\r\n                        draft.receipts = [...draft.receipts, receiptRecord]\r\n                    }\r\n\r\n                    // Update batch counts for new document\r\n                    batch.totalCount = (batch.totalCount || 0) + 1\r\n                    if (newImageData.documentType === 'receipt') {\r\n                        batch.receiptIds = [...(batch.receiptIds || []), newImageData.id]\r\n                    } else {\r\n                        batch.documentIds = [...(batch.documentIds || []), newImageData.id]\r\n                    }\r\n                }\r\n\r\n                return draft\r\n            })\r\n\r\n\r\n\r\n        } catch (err: any) {\r\n            console.error(err)\r\n            setError(err.message || \"Failed to process image.\")\r\n        } finally {\r\n            setBackgroundProcessingCount((prev: number) => prev - 1)\r\n        }\r\n    }\r\n\r\n    // Use a ref to keep track of the batch ID even if the state is overwritten by sync\r\n    const lastSeenBatchId = useRef<string | null>(null)\r\n    if (currentBatch) lastSeenBatchId.current = currentBatch.id\r\n\r\n    const handleProcessBatch = async () => {\r\n        // Find the batch to process - be extremely robust\r\n        const targetBatch = state.intakeBatches.find(b => b.status === 'uploading') ||\r\n            state.intakeBatches.find(b => b.id === (activeSessionBatchId || currentBatch?.id)) ||\r\n            state.intakeBatches[state.intakeBatches.length - 1] // Fallback to last batch if lost\r\n\r\n        if (!targetBatch || (scannedDocuments.length === 0 && !targetBatch.totalCount)) {\r\n            console.error(\"No active batch found for processing. State batches:\", state.intakeBatches)\r\n            setError(\"Scanning session expired or was lost. Please capture an image to resume.\")\r\n            return\r\n        }\r\n\r\n        setStage('processing')\r\n        setProcessingMessage('Applying routing rules & entity assignment...')\r\n\r\n        try {\r\n            const { draft } = await processBatch(\r\n                state,\r\n                targetBatch.id,\r\n                (progress: number) => { setProcessingMessage(`Processing: ${Math.round(progress)}%`) },\r\n                true\r\n            )\r\n\r\n            updateState((currentGlobal: FortunaState) => {\r\n                // Merge the processed batch results into the latest global state\r\n                // This prevents overwriting other concurrent state changes\r\n                const final = { ...currentGlobal }\r\n                final.intakeBatches = final.intakeBatches.map(b =>\r\n                    b.id === draft.intakeBatches.find(db => db.id === b.id)?.id\r\n                        ? draft.intakeBatches.find(db => db.id === b.id)!\r\n                        : b\r\n                )\r\n                final.documents = [...final.documents]\r\n                draft.documents.forEach(dd => {\r\n                    const idx = final.documents.findIndex(fd => fd.id === dd.id)\r\n                    if (idx >= 0) {\r\n                        final.documents[idx] = dd\r\n                    } else if (dd.batchId === targetBatch.id) {\r\n                        final.documents.push(dd)\r\n                    }\r\n                })\r\n\r\n                final.receipts = [...final.receipts]\r\n                draft.receipts.forEach(dr => {\r\n                    const idx = final.receipts.findIndex(fr => fr.id === dr.id)\r\n                    if (idx >= 0) {\r\n                        final.receipts[idx] = dr\r\n                    } else if (dr.id === targetBatch.id || dr.batchId === targetBatch.id) {\r\n                        final.receipts.push(dr)\r\n                    }\r\n                })\r\n\r\n                return final\r\n            })\r\n            setStage('done')\r\n        } catch (err: any) {\r\n            console.error(\"Batch processing failed:\", err)\r\n            setError(err.message || \"Batch processing failed.\")\r\n            setStage('review')\r\n        }\r\n    }\r\n\r\n    const handleUpdateDocMetadata = (docId: string, field: string, value: any) => {\r\n        updateState((draft: FortunaState) => {\r\n            draft.documents = draft.documents.map(d => {\r\n                if (d.id === docId) {\r\n                    return { ...d, metadata: { ...d.metadata, [field]: value } }\r\n                }\r\n                return d\r\n            })\r\n            // If it's a receipt, also update the receipt record\r\n            draft.receipts = draft.receipts.map(r => {\r\n                if (r.id === docId) {\r\n                    const rField = field === 'merchantName' ? 'merchantName' : field === 'totalAmount' ? 'totalAmount' : field\r\n                    return { ...r, [rField]: value }\r\n                }\r\n                return r\r\n            })\r\n            return draft\r\n        })\r\n    }\r\n\r\n    const handleUpdateLineItem = (docId: string, itemId: string, field: string, value: any) => {\r\n        updateState((draft: FortunaState) => {\r\n            draft.receipts = draft.receipts.map(r => {\r\n                if (r.id === docId) {\r\n                    const items = r.items?.map(i => i.id === itemId ? { ...i, [field]: value } : i)\r\n                    return { ...r, items }\r\n                }\r\n                return r\r\n            })\r\n            return draft\r\n        })\r\n    }\r\n\r\n    const resetSession = () => {\r\n        setStage('idle')\r\n        setError(null)\r\n        // Mark current batch as cancelled or just clear status to stop recovery\r\n        if (currentBatch) {\r\n            updateState(draft => {\r\n                const batch = draft.intakeBatches.find(b => b.id === currentBatch.id)\r\n                if (batch) batch.status = 'completed' // or a dynamic 'cancelled' if we add it\r\n                return draft\r\n            })\r\n        }\r\n    }\r\n\r\n    return (\r\n        <div style={{ padding: '20px 16px 120px 16px', maxWidth: 800, margin: '0 auto', minHeight: 'calc(100vh - 64px)' }}>\r\n\r\n            <div style={{ marginBottom: 32, display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>\r\n                <div>\r\n                    <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 8 }}>\r\n                        <Camera size={28} style={{ color: 'var(--accent-gold)' }} />\r\n                        <h1 style={{ fontFamily: 'var(--font-display)', fontSize: 28, color: 'var(--text-primary)', margin: 0 }}>\r\n                            Mobile Intake\r\n                        </h1>\r\n                    </div>\r\n                    <p style={{ color: 'var(--text-muted)', fontSize: 14, margin: 0 }}>\r\n                        Auto-capture documents with your camera to extract data and categorize records.\r\n                    </p>\r\n                </div>\r\n\r\n                {backgroundProcessingCount > 0 && stage !== 'scanning' && (\r\n                    <div style={{ display: 'flex', alignItems: 'center', gap: 8, padding: '8px 16px', background: 'var(--accent-gold-dim)', borderRadius: 20, color: 'var(--accent-gold)' }}>\r\n                        <Loader2 size={16} className=\"spin\" />\r\n                        <span style={{ fontSize: 13, fontWeight: 600 }}>{backgroundProcessingCount} Extracting</span>\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* Error Banner */}\r\n            {error && (\r\n                <div style={{\r\n                    padding: 16, background: 'rgba(239,68,68,0.1)',\r\n                    borderRadius: 12, display: 'flex', alignItems: 'center', gap: 10,\r\n                    border: '1px solid rgba(239,68,68,0.2)', marginBottom: 24,\r\n                }}>\r\n                    <AlertTriangle size={18} style={{ color: 'var(--accent-red)' }} />\r\n                    <span style={{ fontSize: 13, color: 'var(--accent-red)' }}>{error}</span>\r\n                </div>\r\n            )}\r\n\r\n            {/* Stage: Idle */}\r\n            {stage === 'idle' && (\r\n                <div style={styles.card}>\r\n                    <div style={styles.iconCircle}>\r\n                        <ImageIcon size={32} style={{ color: 'var(--accent-gold)' }} />\r\n                    </div>\r\n                    <div style={{ fontSize: 18, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 8 }}>\r\n                        Ready to scan\r\n                    </div>\r\n                    <div style={{ fontSize: 14, color: 'var(--text-muted)', marginBottom: 24, textAlign: 'center' }}>\r\n                        Ensure good lighting and hold the camera steady over the document. The system will automatically capture when the image is stable.\r\n                    </div>\r\n                    <button onClick={handleStartScanning} style={styles.primaryButtonLarge}>\r\n                        <Camera size={20} /> Launch Scanner\r\n                    </button>\r\n                </div>\r\n            )}\r\n\r\n            {/* Stage: Scanning (Fullscreen Overlay) */}\r\n            {stage === 'scanning' && (\r\n                <MobileDocumentScanner\r\n                    onCapture={handleImageCapture}\r\n                    onClose={() => setStage(scannedImageCount > 0 ? 'review' : 'idle')}\r\n                />\r\n            )}\r\n\r\n            {/* Stage: Processing */}\r\n            {stage === 'processing' && (\r\n                <div style={styles.card}>\r\n                    <Loader2 size={40} className=\"spin\" style={{ color: 'var(--accent-gold)', marginBottom: 24 }} />\r\n                    <div style={{ fontSize: 18, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 8 }}>\r\n                        Analyzing...\r\n                    </div>\r\n                    <div style={{ fontSize: 14, color: 'var(--text-muted)' }}>\r\n                        {processingMessage}\r\n                    </div>\r\n                    <style>{`.spin { animation: spin 1s linear infinite; } @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }`}</style>\r\n                </div>\r\n            )}\r\n\r\n            {/* Stage: Review */}\r\n            {stage === 'review' && (\r\n                <div>\r\n                    <style>{`.spin { animation: spin 1s linear infinite; } @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }`}</style>\r\n                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24 }}>\r\n                        <div style={{ display: 'flex', alignItems: 'center', gap: 16 }}>\r\n                            <div style={{ fontSize: 18, fontWeight: 600, color: 'var(--text-primary)' }}>\r\n                                Scanned Documents ({scannedDocuments.length})\r\n                            </div>\r\n                            {scannedDocuments.length > 0 && (\r\n                                <button\r\n                                    onClick={() => {\r\n                                        const allIds = scannedDocuments.map(d => d.id)\r\n                                        setSelectedDocIds(allIds.length === selectedDocIds.length ? [] : allIds)\r\n                                    }}\r\n                                    style={{ background: 'none', border: 'none', color: 'var(--accent-gold)', fontSize: 13, fontWeight: 500, cursor: 'pointer' }}\r\n                                >\r\n                                    {selectedDocIds.length === scannedDocuments.length ? 'Deselect All' : 'Select All'}\r\n                                </button>\r\n                            )}\r\n                        </div>\r\n                        <div style={{ display: 'flex', gap: 12 }}>\r\n                            {selectedDocIds.length > 0 && (\r\n                                <button\r\n                                    onClick={() => {\r\n                                        const idsToRemove = [...selectedDocIds]\r\n                                        setScannedDocuments(prev => prev.filter(d => !idsToRemove.includes(d.id)))\r\n                                        setSelectedDocIds([])\r\n\r\n                                        // Sync deletion to global state\r\n                                        updateState((s: FortunaState) => ({\r\n                                            ...s,\r\n                                            documents: s.documents.filter(d => !idsToRemove.includes(d.id)),\r\n                                            receipts: s.receipts.filter(r => !idsToRemove.includes(r.id))\r\n                                        }))\r\n                                    }}\r\n                                    style={{ ...styles.secondaryButton, color: 'var(--accent-red)', borderColor: 'var(--accent-red)44' }}\r\n                                >\r\n                                    <Trash2 size={16} /> Delete ({selectedDocIds.length})\r\n                                </button>\r\n                            )}\r\n                            <button onClick={handleStartScanning} style={styles.secondaryButton}>\r\n                                <Camera size={16} /> Scan More\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div style={{ display: 'flex', flexDirection: 'column', gap: 12, marginBottom: 32 }}>\r\n                        {scannedDocuments.map(doc => {\r\n                            const isExpanded = expandedDocId === doc.id\r\n                            const isSelected = selectedDocIds.includes(doc.id)\r\n                            const isLowConfidence = (doc.metadata.confidenceScore || 1) < 0.7\r\n                            return (\r\n                                <div key={doc.id} style={{ display: 'flex', flexDirection: 'column', gap: 1, position: 'relative' }}>\r\n                                    <div\r\n                                        style={{ position: 'absolute', left: -32, top: 20, zIndex: 1 }}\r\n                                        onClick={(e) => {\r\n                                            e.stopPropagation()\r\n                                            setSelectedDocIds(prev => prev.includes(doc.id) ? prev.filter(id => id !== doc.id) : [...prev, doc.id])\r\n                                        }}\r\n                                    >\r\n                                        <div style={{\r\n                                            width: 18, height: 18, borderRadius: 4,\r\n                                            border: `2px solid ${isSelected ? 'var(--accent-gold)' : 'var(--border-medium)'}`,\r\n                                            background: isSelected ? 'var(--accent-gold)' : 'transparent',\r\n                                            display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n                                            cursor: 'pointer'\r\n                                        }}>\r\n                                            {isSelected && <Check size={12} color=\"#000\" strokeWidth={3} />}\r\n                                        </div>\r\n                                    </div>\r\n                                    <div\r\n                                        onClick={() => setExpandedDocId(isExpanded ? null : doc.id)}\r\n                                        style={{ ...styles.receiptRow, cursor: 'pointer', borderBottomLeftRadius: isExpanded ? 0 : 12, borderBottomRightRadius: isExpanded ? 0 : 12 }}\r\n                                    >\r\n                                        <div style={{ display: 'flex', alignItems: 'center', gap: 16 }}>\r\n                                            <div style={{ display: 'flex', position: 'relative', width: 44, height: 44 }}>\r\n                                                {doc.pageThumbnails && doc.pageThumbnails.length > 0 ? (\r\n                                                    doc.pageThumbnails.slice(0, 2).map((thumb, idx) => (\r\n                                                        <img\r\n                                                            key={idx}\r\n                                                            src={thumb}\r\n                                                            style={{\r\n                                                                width: 40, height: 40, borderRadius: 8, objectFit: 'cover',\r\n                                                                border: '1px solid var(--border-subtle)',\r\n                                                                position: 'absolute',\r\n                                                                left: idx * 4,\r\n                                                                top: idx * 4,\r\n                                                                zIndex: 10 - idx,\r\n                                                                opacity: 1 - (idx * 0.3)\r\n                                                            }}\r\n                                                            alt=\"doc\"\r\n                                                        />\r\n                                                    ))\r\n                                                ) : (\r\n                                                    <div style={{ ...styles.docIcon, background: doc.documentType === 'receipt' ? 'rgba(239,68,68,0.06)' : doc.documentType === 'not_applicable' ? 'rgba(107,114,128,0.1)' : 'rgba(59,130,246,0.06)' }}>\r\n                                                        {doc.documentType === 'receipt' ? (\r\n                                                            <TrendingDown size={18} style={{ color: 'var(--accent-red)' }} />\r\n                                                        ) : doc.documentType === 'not_applicable' ? (\r\n                                                            <Ban size={18} style={{ color: 'var(--text-muted)' }} />\r\n                                                        ) : (\r\n                                                            <FileText size={18} style={{ color: '#3b82f6' }} />\r\n                                                        )}\r\n                                                    </div>\r\n                                                )}\r\n                                                {doc.pageCount > 1 && (\r\n                                                    <div style={{\r\n                                                        position: 'absolute', bottom: -4, right: -4,\r\n                                                        background: 'var(--accent-gold)', color: '#000',\r\n                                                        fontSize: 9, fontWeight: 800, padding: '1px 4px',\r\n                                                        borderRadius: 4, zIndex: 20, boxShadow: '0 2px 4px rgba(0,0,0,0.3)'\r\n                                                    }}>\r\n                                                        {doc.pageCount}P\r\n                                                    </div>\r\n                                                )}\r\n                                            </div>\r\n                                            <div>\r\n                                                <div style={{ fontSize: 15, fontWeight: 600, color: 'var(--text-primary)', textTransform: 'capitalize' }}>\r\n                                                    {doc.documentType} • {doc.metadata.merchantName || doc.metadata.agency || doc.metadata.subject || 'Document'}\r\n                                                </div>\r\n                                                <div style={{ fontSize: 12, color: 'var(--text-muted)' }}>{new Date(doc.dateAdded).toLocaleDateString()}</div>\r\n                                            </div>\r\n                                        </div>\r\n                                        <div style={{ display: 'flex', alignItems: 'center', gap: 16 }}>\r\n                                            <div style={{ fontSize: 16, fontFamily: 'var(--font-mono)', fontWeight: 600, color: 'var(--text-secondary)' }}>\r\n                                                {doc.metadata.totalAmount ? `$${Number(doc.metadata.totalAmount).toFixed(2)}` : ''}\r\n                                                {doc.metadata.amountDue ? `$${Number(doc.metadata.amountDue).toFixed(2)}` : ''}\r\n                                            </div>\r\n                                            <div style={{ color: 'var(--text-muted)', transform: isExpanded ? 'rotate(180deg)' : 'none', transition: 'transform 0.2s' }}>\r\n                                                <ArrowRight size={16} />\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    {isExpanded && (\r\n                                        <div style={styles.expandedContent}>\r\n                                            <div style={{ display: 'flex', flexDirection: 'column', gap: 16, marginBottom: 20 }}>\r\n                                                <div style={styles.inputGroup}>\r\n                                                    <label style={{ ...styles.label, color: isLowConfidence && !doc.metadata.merchantName ? 'var(--accent-gold)' : 'var(--text-muted)' }}>\r\n                                                        Merchant / Name {isLowConfidence && <AlertCircle size={10} style={{ marginLeft: 4 }} />}\r\n                                                    </label>\r\n                                                    <input\r\n                                                        style={{ ...styles.input, borderColor: isLowConfidence ? 'var(--accent-gold)55' : 'var(--border-subtle)' }}\r\n                                                        value={doc.metadata.merchantName || doc.metadata.subject || ''}\r\n                                                        onChange={(e: React.ChangeEvent<HTMLInputElement>) => handleUpdateDocMetadata(doc.id, doc.metadata.merchantName ? 'merchantName' : doc.metadata.agency ? 'agency' : 'subject', e.target.value)}\r\n                                                    />\r\n                                                </div>\r\n                                                <div style={styles.inputGroup}>\r\n                                                    <label style={{ ...styles.label, color: isLowConfidence && !doc.metadata.totalAmount ? 'var(--accent-gold)' : 'var(--text-muted)' }}>\r\n                                                        Total Amount {isLowConfidence && <AlertCircle size={10} style={{ marginLeft: 4 }} />}\r\n                                                    </label>\r\n                                                    <input\r\n                                                        style={{ ...styles.input, borderColor: isLowConfidence ? 'var(--accent-gold)55' : 'var(--border-subtle)' }}\r\n                                                        type=\"number\"\r\n                                                        value={doc.metadata.totalAmount || doc.metadata.amountDue || 0}\r\n                                                        onChange={(e: React.ChangeEvent<HTMLInputElement>) => handleUpdateDocMetadata(doc.id, doc.metadata.totalAmount ? 'totalAmount' : 'amountDue', parseFloat(e.target.value))}\r\n                                                    />\r\n                                                </div>\r\n                                            </div>\r\n\r\n                                            {doc.metadata.lineItems && doc.metadata.lineItems.length > 0 && (\r\n                                                <div>\r\n                                                    <div style={{ fontSize: 12, fontWeight: 700, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.05em', marginBottom: 12 }}>\r\n                                                        Line Items ({doc.metadata.lineItems.length})\r\n                                                    </div>\r\n                                                    <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>\r\n                                                        {doc.metadata.lineItems.map((item: any) => (\r\n                                                            <div key={item.id} style={styles.lineItemRow}>\r\n                                                                <input\r\n                                                                    style={{ ...styles.inputPlain, flex: 1 }}\r\n                                                                    value={item.description}\r\n                                                                    onChange={(e: React.ChangeEvent<HTMLInputElement>) => handleUpdateLineItem(doc.id, item.id, 'description', e.target.value)}\r\n                                                                />\r\n                                                                <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>\r\n                                                                    <div style={styles.categoryBadge}>\r\n                                                                        {item.inferredCategory || 'Misc'}\r\n                                                                    </div>\r\n                                                                    <input\r\n                                                                        style={{ ...styles.inputPlain, width: 80, textAlign: 'right', fontWeight: 600 }}\r\n                                                                        type=\"number\"\r\n                                                                        value={item.amount}\r\n                                                                        onChange={(e: React.ChangeEvent<HTMLInputElement>) => handleUpdateLineItem(doc.id, item.id, 'amount', parseFloat(e.target.value))}\r\n                                                                    />\r\n                                                                </div>\r\n                                                            </div>\r\n                                                        ))}\r\n                                                    </div>\r\n                                                </div>\r\n                                            )}\r\n\r\n                                            {doc.metadata.deductionSignals && doc.metadata.deductionSignals.length > 0 && (\r\n                                                <div style={{ marginTop: 16, padding: '10px 14px', borderRadius: 10, background: 'var(--accent-gold-dim)', border: '1px solid var(--accent-gold)22' }}>\r\n                                                    <div style={{ fontSize: 10, fontWeight: 700, color: 'var(--accent-gold)', textTransform: 'uppercase', letterSpacing: '0.06em', display: 'flex', alignItems: 'center', gap: 6, marginBottom: 8 }}>\r\n                                                        <Shield size={12} /> Tax Intelligence Signals\r\n                                                    </div>\r\n                                                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: 6 }}>\r\n                                                        {doc.metadata.deductionSignals.map((sig: string, idx: number) => (\r\n                                                            <span key={idx} style={{ fontSize: 11, color: 'var(--text-primary)', background: 'rgba(0,0,0,0.2)', padding: '4px 8px', borderRadius: 6 }}>\r\n                                                                {sig}\r\n                                                            </span>\r\n                                                        ))}\r\n                                                    </div>\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            )\r\n                        })}\r\n                    </div>\r\n\r\n                    <div style={{ display: 'flex', flexDirection: 'column', gap: 12, borderTop: '1px solid var(--border-subtle)', paddingTop: 24 }}>\r\n                        <button onClick={resetSession} style={{ ...styles.secondaryButton, flex: 1, padding: 16 }}>\r\n                            <RefreshCw size={18} /> Discard Batch\r\n                        </button>\r\n                        <button\r\n                            onClick={handleProcessBatch}\r\n                            disabled={backgroundProcessingCount > 0}\r\n                            style={{ ...styles.primaryButtonLarge, flex: 2, padding: 16, opacity: backgroundProcessingCount > 0 ? 0.5 : 1 }}\r\n                        >\r\n                            {backgroundProcessingCount > 0 ? (\r\n                                <><Loader2 size={18} className=\"spin\" /> Waiting for extraction...</>\r\n                            ) : (\r\n                                <><Check size={18} /> Finalize Intake <ArrowRight size={18} /></>\r\n                            )}\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            )}\r\n\r\n            {/* Stage: Done */}\r\n            {stage === 'done' && (\r\n                <div style={{ ...styles.card, maxWidth: 600, width: '100%', margin: '0 auto', padding: '32px 24px' }}>\r\n                    <div style={styles.successIcon}>\r\n                        <Check size={32} color=\"#000\" />\r\n                    </div>\r\n                    <h2 style={{ fontSize: 24, fontWeight: 700, color: 'var(--text-primary)', marginBottom: 8, textAlign: 'center' }}>\r\n                        Processing Complete\r\n                    </h2>\r\n                    {stats.categorizedCount} documents processed from {scannedImageCount} captures. {stats.notApplicableCount} marked as not applicable.\r\n\r\n                    <div style={{ display: 'flex', flexDirection: 'column', gap: 24, marginBottom: 32 }}>\r\n                        {/* Summary Totals */}\r\n                        <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>\r\n                            <div style={{ background: 'rgba(255,255,255,0.03)', padding: 16, borderRadius: 12, border: '1px solid var(--border-subtle)' }}>\r\n                                <div style={{ fontSize: 11, fontWeight: 700, color: 'var(--text-muted)', textTransform: 'uppercase', marginBottom: 4 }}>Categorized</div>\r\n                                <div style={{ fontSize: 20, fontWeight: 700, color: 'var(--accent-gold)' }}>${stats.totalAmount.toFixed(2)}</div>\r\n                                <div style={{ fontSize: 12, color: 'var(--text-secondary)' }}>{stats.categorizedCount} items</div>\r\n                            </div>\r\n                            <div style={{ background: 'rgba(255,255,255,0.03)', padding: 16, borderRadius: 12, border: '1px solid var(--border-subtle)' }}>\r\n                                <div style={{ fontSize: 11, fontWeight: 700, color: 'var(--text-muted)', textTransform: 'uppercase', marginBottom: 4 }}>Not Applicable</div>\r\n                                <div style={{ fontSize: 20, fontWeight: 700, color: 'var(--text-secondary)' }}>${stats.notApplicableTotal.toFixed(2)}</div>\r\n                                <div style={{ fontSize: 12, color: 'var(--text-secondary)' }}>{stats.notApplicableCount} items</div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Breakdown per Type */}\r\n                        <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>\r\n                            <div style={{ fontSize: 13, fontWeight: 700, color: 'var(--text-primary)', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Breakdown by Type</div>\r\n                            {Object.entries(stats.byTypeCount).map(([type, count]) => (\r\n                                <div key={type} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '12px 16px', background: 'rgba(0,0,0,0.2)', borderRadius: 10 }}>\r\n                                    <div style={{ textTransform: 'capitalize', fontSize: 14, fontWeight: 500 }}>{type} ({count})</div>\r\n                                    <div style={{ fontFamily: 'var(--font-mono)', fontWeight: 600 }}>${stats.byTypeTotal[type].toFixed(2)}</div>\r\n                                </div>\r\n                            ))}\r\n                        </div>\r\n\r\n                        {/* Line Items for Receipts */}\r\n                        {stats.receipts.length > 0 && (\r\n                            <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>\r\n                                <div style={{ fontSize: 13, fontWeight: 700, color: 'var(--text-primary)', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Receipt Details</div>\r\n                                {stats.receipts.map((r, i) => (\r\n                                    <div key={i} style={{ border: '1px solid var(--border-subtle)', borderRadius: 10, overflow: 'hidden' }}>\r\n                                        <div style={{ background: 'rgba(255,255,255,0.02)', padding: '10px 16px', borderBottom: '1px solid var(--border-subtle)', display: 'flex', justifyContent: 'space-between' }}>\r\n                                            <span style={{ fontWeight: 600 }}>{r.merchant}</span>\r\n                                            <span style={{ color: 'var(--accent-gold)' }}>${r.amount.toFixed(2)}</span>\r\n                                        </div>\r\n                                        <div style={{ padding: 12, display: 'flex', flexDirection: 'column', gap: 4 }}>\r\n                                            {r.items.map((item: any, j: number) => (\r\n                                                <div key={j} style={{ display: 'flex', justifyContent: 'space-between', fontSize: 12 }}>\r\n                                                    <span style={{ color: 'var(--text-secondary)' }}>{item.description}</span>\r\n                                                    <span style={{ color: 'var(--text-muted)' }}>${Number(item.amount).toFixed(2)}</span>\r\n                                                </div>\r\n                                            ))}\r\n                                        </div>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    <button onClick={resetSession} style={{ ...styles.primaryButtonLarge, width: '100%' }}>\r\n                        Start New Batch <ArrowRight size={18} />\r\n                    </button>\r\n                </div>\r\n            )}\r\n\r\n        </div>\r\n    )\r\n}\r\n\r\nconst styles: Record<string, React.CSSProperties> = {\r\n    card: {\r\n        background: 'var(--bg-elevated)',\r\n        borderRadius: 16,\r\n        border: '1px solid var(--border-subtle)',\r\n        padding: '32px 24px',\r\n        display: 'flex',\r\n        flexDirection: 'column',\r\n        alignItems: 'center',\r\n        justifyContent: 'center',\r\n    },\r\n    successIcon: {\r\n        width: 64, height: 64, borderRadius: '50%',\r\n        background: 'var(--accent-gold)',\r\n        display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n        marginBottom: 20,\r\n    },\r\n    iconCircle: {\r\n        width: 80, height: 80, borderRadius: '50%',\r\n        background: 'var(--accent-gold-dim)',\r\n        display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n        marginBottom: 24,\r\n    },\r\n    primaryButtonLarge: {\r\n        padding: '16px 32px',\r\n        borderRadius: 12, border: 'none',\r\n        background: 'var(--accent-gold)', color: '#000',\r\n        cursor: 'pointer', fontSize: 16, fontWeight: 700,\r\n        display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 12,\r\n        transition: 'all 0.2s',\r\n    },\r\n    secondaryButton: {\r\n        padding: '10px 20px',\r\n        borderRadius: 10, border: '1px solid var(--border-subtle)',\r\n        background: 'var(--bg-elevated)', color: 'var(--text-secondary)',\r\n        cursor: 'pointer', fontSize: 14, fontWeight: 500,\r\n        display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8,\r\n    },\r\n    receiptRow: {\r\n        display: 'flex', justifyContent: 'space-between', alignItems: 'center',\r\n        padding: '16px 20px', borderRadius: 12,\r\n        background: 'var(--bg-elevated)', border: '1px solid var(--border-subtle)',\r\n    },\r\n    docIcon: {\r\n        width: 40, height: 40, borderRadius: 10,\r\n        display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n    },\r\n    expandedContent: {\r\n        background: 'rgba(255,255,255,0.02)',\r\n        border: '1px solid var(--border-subtle)',\r\n        borderTop: 'none',\r\n        borderBottomLeftRadius: 12,\r\n        borderBottomRightRadius: 12,\r\n        padding: 20,\r\n        marginBottom: 8,\r\n    },\r\n    inputGroup: {\r\n        display: 'flex',\r\n        flexDirection: 'column',\r\n        gap: 6,\r\n    },\r\n    label: {\r\n        fontSize: 11,\r\n        fontWeight: 700,\r\n        color: 'var(--text-muted)',\r\n        textTransform: 'uppercase',\r\n        letterSpacing: '0.05em',\r\n    },\r\n    input: {\r\n        background: 'rgba(0,0,0,0.2)',\r\n        border: '1px solid var(--border-subtle)',\r\n        borderRadius: 8,\r\n        padding: '10px 12px',\r\n        color: 'var(--text-primary)',\r\n        fontSize: 14,\r\n        outline: 'none',\r\n    },\r\n    inputPlain: {\r\n        background: 'transparent',\r\n        border: 'none',\r\n        color: 'var(--text-primary)',\r\n        fontSize: 14,\r\n        outline: 'none',\r\n        padding: '4px 0',\r\n    },\r\n    lineItemRow: {\r\n        display: 'flex',\r\n        justifyContent: 'space-between',\r\n        alignItems: 'center',\r\n        padding: '8px 12px',\r\n        background: 'rgba(255,255,255,0.03)',\r\n        borderRadius: 8,\r\n    },\r\n    categoryBadge: {\r\n        fontSize: 10,\r\n        fontWeight: 700,\r\n        padding: '4px 8px',\r\n        borderRadius: 6,\r\n        background: 'var(--accent-gold-dim)',\r\n        color: 'var(--accent-gold)',\r\n        textTransform: 'uppercase',\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\EntityDesign.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Shield' is defined but never used.","line":2,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":47,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Shield"},"fix":{"range":[87,95],"text":""},"desc":"Remove unused variable \"Shield\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ArrowRight' is defined but never used.","line":2,"column":49,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":59,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ArrowRight"},"fix":{"range":[95,107],"text":""},"desc":"Remove unused variable \"ArrowRight\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'hasEntities' is assigned a value but never used.","line":25,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":20}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useFortuna } from '../hooks/useFortuna'\nimport { Building2, Check, X, Sparkles, Shield, ArrowRight } from 'lucide-react'\n\nconst entityDetails: Record<string, { pros: string[]; cons: string[] }> = {\n  sole_prop: {\n    pros: ['Simplest setup', 'No formation costs', 'Direct tax filing'],\n    cons: ['Unlimited personal liability', 'Full SE tax on all profit', 'No asset protection'],\n  },\n  llc: {\n    pros: ['Personal asset protection', 'Pass-through taxation', 'Flexible management'],\n    cons: ['Still pays full SE tax', 'Annual state fees', 'Some paperwork required'],\n  },\n  llc_scorp: {\n    pros: ['SE tax savings via salary split', 'Asset protection', 'QBI deduction eligible', 'Professional credibility'],\n    cons: ['Requires reasonable salary', 'Payroll setup needed', 'More bookkeeping'],\n  },\n  ccorp: {\n    pros: ['21% flat corporate rate', 'Stock compensation options', 'Retained earnings'],\n    cons: ['Double taxation risk', 'Higher compliance costs', 'Not ideal for pass-through income'],\n  },\n}\n\nexport function EntityDesign() {\n  const { state, entityComparison, taxReport } = useFortuna()\n  const hasEntities = state.entities.some(e => e.isActive)\n  const currentType = state.entities.find(e => e.isActive)?.type || 'sole_prop'\n  const bestEntity = entityComparison[0]\n\n  return (\n    <div className=\"view-enter\">\n      <div style={{ marginBottom: 32 }}>\n        <h1 className=\"section-title\">Entity Architecture</h1>\n        <p className=\"section-subtitle\">Computed entity comparison based on your ${taxReport.grossIncome > 0 ? `$${taxReport.grossIncome.toLocaleString()} income` : 'financial profile'}</p>\n      </div>\n\n      {bestEntity && bestEntity.type !== currentType && bestEntity.score > 60 && (\n        <div style={{\n          background: 'linear-gradient(135deg, rgba(212,168,67,0.06), rgba(52,211,153,0.04))',\n          border: '1px solid rgba(212,168,67,0.12)',\n          borderRadius: 14, padding: 24, marginBottom: 28,\n          display: 'flex', alignItems: 'center', gap: 24,\n        }}>\n          <div style={{ flex: 1 }}>\n            <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 8 }}>\n              <Sparkles size={16} color=\"var(--accent-gold)\" />\n              <span style={{ fontSize: 14, fontWeight: 500, color: 'var(--accent-gold)' }}>Entity Restructure Recommended</span>\n            </div>\n            <p style={{ fontSize: 13, color: 'var(--text-secondary)', lineHeight: 1.6 }}>\n              Switching from your current structure to <strong style={{ color: 'var(--text-primary)' }}>{bestEntity.label}</strong> could save{' '}\n              <span style={{ color: 'var(--accent-emerald)', fontWeight: 600, fontFamily: 'var(--font-mono)' }}>\n                ${Math.max(0, taxReport.totalTax - bestEntity.totalTax).toLocaleString()}/year\n              </span> in taxes while providing {bestEntity.liabilityProtection ? 'personal asset protection' : 'simplified operations'}.\n            </p>\n          </div>\n        </div>\n      )}\n\n      <div className=\"grid-4\" style={{ marginBottom: 28 }}>\n        {entityComparison.map((entity, i) => {\n          const isCurrent = entity.type === currentType\n          const isBest = i === 0\n          const details = entityDetails[entity.type] || { pros: [], cons: [] }\n\n          return (\n            <div key={entity.type} className=\"card\" style={{\n              borderColor: isBest ? 'rgba(212,168,67,0.3)' : 'var(--border-subtle)',\n              position: 'relative',\n            }}>\n              {isBest && (\n                <div style={{ position: 'absolute', top: -1, left: 20, right: 20, height: 3, background: 'linear-gradient(90deg, var(--accent-gold), #e0b84d)', borderRadius: '0 0 3px 3px' }} />\n              )}\n              {isCurrent && (\n                <div style={{ position: 'absolute', top: 12, right: 12 }}>\n                  <span className=\"pill blue\" style={{ fontSize: 10 }}>Current</span>\n                </div>\n              )}\n              {isBest && !isCurrent && (\n                <div style={{ position: 'absolute', top: 12, right: 12 }}>\n                  <span className=\"pill gold\" style={{ fontSize: 10 }}><Sparkles size={10} /> Best Fit</span>\n                </div>\n              )}\n\n              <div style={{ padding: '20px 20px 16px' }}>\n                <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 16 }}>\n                  <Building2 size={16} color={isBest ? 'var(--accent-gold)' : 'var(--text-muted)'} />\n                  <span style={{ fontSize: 14, fontWeight: 500 }}>{entity.label}</span>\n                </div>\n\n                <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16 }}>\n                  <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>Score:</span>\n                  <div style={{ flex: 1 }}>\n                    <div className=\"progress-bar\" style={{ height: 4 }}>\n                      <div className=\"progress-fill\" style={{\n                        width: `${entity.score}%`,\n                        background: entity.score >= 80 ? 'var(--accent-emerald)' : entity.score >= 60 ? 'var(--accent-gold)' : 'var(--accent-red)',\n                      }} />\n                    </div>\n                  </div>\n                  <span style={{ fontFamily: 'var(--font-mono)', fontSize: 13, fontWeight: 600, color: entity.score >= 80 ? 'var(--accent-emerald)' : entity.score >= 60 ? 'var(--accent-gold)' : 'var(--accent-red)' }}>\n                    {entity.score}\n                  </span>\n                </div>\n\n                <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>\n                  {[\n                    ['Total Tax', `$${entity.totalTax.toLocaleString()}`],\n                    ['Effective Rate', `${(entity.effectiveRate * 100).toFixed(1)}%`],\n                    ['SE Tax', `$${entity.seTax.toLocaleString()}`],\n                    ['Net After Tax', `$${entity.netAfterTax.toLocaleString()}`],\n                    ['Annual Cost', `$${entity.annualCost.toLocaleString()}`],\n                    ['Liability', entity.liabilityProtection ? 'Limited ✓' : 'Unlimited ✗'],\n                  ].map(([label, val]) => (\n                    <div key={label as string} style={{ display: 'flex', justifyContent: 'space-between' }}>\n                      <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>{label}</span>\n                      <span style={{ fontSize: 12, fontFamily: 'var(--font-mono)', color: 'var(--text-secondary)', fontWeight: 500 }}>{val}</span>\n                    </div>\n                  ))}\n                </div>\n              </div>\n\n              <div style={{ padding: '12px 20px', borderTop: '1px solid var(--border-subtle)' }}>\n                {details.pros.slice(0, 3).map((pro, j) => (\n                  <div key={j} style={{ display: 'flex', gap: 6, alignItems: 'center', marginBottom: 3 }}>\n                    <Check size={11} color=\"var(--accent-emerald)\" />\n                    <span style={{ fontSize: 11, color: 'var(--text-secondary)' }}>{pro}</span>\n                  </div>\n                ))}\n                {details.cons.slice(0, 2).map((con, j) => (\n                  <div key={j} style={{ display: 'flex', gap: 6, alignItems: 'center', marginBottom: 3 }}>\n                    <X size={11} color=\"var(--accent-red)\" />\n                    <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>{con}</span>\n                  </div>\n                ))}\n              </div>\n            </div>\n          )\n        })}\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\EntityFlow.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useRef' is defined but never used.","line":1,"column":42,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":48,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useRef"},"fix":{"range":[39,47],"text":""},"desc":"Remove unused variable \"useRef\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'generateTaxReport' is defined but never used.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":27,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"generateTaxReport"},"fix":{"range":[130,191],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":149,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":149,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8326,8329],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8326,8329],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/preserve-manual-memoization","severity":2,"message":"Compilation Skipped: Existing memoization could not be preserved\n\nReact Compiler has skipped optimizing this component because the existing manual memoization could not be preserved. This dependency may be mutated later, which could cause the value to change unexpectedly.\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\EntityFlow.tsx:180:7\n  178 |     })\n  179 |     return { entityIncomeMap: map, unassignedStreams: unassigned, entitySummaries: summaries }\n> 180 |   }, [activeStreams, activeEntities])\n      |       ^^^^^^^^^^^^^ This dependency may be modified later\n  181 |\n  182 |   // ─── Actions ─────────────────────────────────────────────────────────\n  183 |","line":180,"column":7,"nodeType":null,"endLine":180,"endColumn":20},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":688,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":688,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[44541,44544],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[44541,44544],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":767,"column":144,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":767,"endColumn":147,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[48995,48998],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[48995,48998],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'entities' is defined but never used.","line":780,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":780,"endColumn":49},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'fmtK' is defined but never used.","line":780,"column":83,"nodeType":"Identifier","messageId":"unusedVar","endLine":780,"endColumn":87},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\EntityFlow.tsx:791:21\n  789 |   const isScorp = form.type === 'llc_scorp' || form.type === 'scorp'\n  790 |\n> 791 |   useEffect(() => { setForm(entity); setEditing(false); setConfirmDel(false) }, [entity])\n      |                     ^^^^^^^ Avoid calling setState() directly within an effect\n  792 |\n  793 |   const upd = (partial: Partial<LegalEntity>) => { setForm(prev => ({ ...prev, ...partial })); setEditing(true) }\n  794 |","line":791,"column":21,"nodeType":null,"endLine":791,"endColumn":28},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":802,"column":84,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":802,"endColumn":87,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[50862,50865],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[50862,50865],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\EntityFlow.tsx:887:21\n  885 |   const [form, setForm] = useState(stream)\n  886 |   const [editing, setEditing] = useState(false)\n> 887 |   useEffect(() => { setForm(stream); setEditing(false) }, [stream])\n      |                     ^^^^^^^ Avoid calling setState() directly within an effect\n  888 |   const upd = (partial: Partial<IncomeStream>) => { setForm(prev => ({ ...prev, ...partial })); setEditing(true) }\n  889 |\n  890 |   return (","line":887,"column":21,"nodeType":null,"endLine":887,"endColumn":28},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":897,"column":84,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":897,"endColumn":87,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[57597,57600],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[57597,57600],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":998,"column":115,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":998,"endColumn":118,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[65086,65089],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[65086,65089],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":13,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMemo, useState, useCallback, useRef, useEffect } from 'react'\nimport { useFortuna, genId } from '../hooks/useFortuna'\nimport { generateTaxReport } from '../engine/tax-calculator'\nimport { calculateReasonableSalary } from '../engine/entity-optimizer'\nimport type { LegalEntity, IncomeStream, FortunaState } from '../engine/storage'\nimport {\n  Building2, ArrowDown, DollarSign, User, Landmark, Wallet,\n  Shield, Zap, Plus, X, Trash2, GripVertical,\n  ChevronRight, Check, AlertTriangle, Link2, Unlink,\n  Brain, Sparkles, ChevronDown, ChevronUp, Target, Info, Calculator\n} from 'lucide-react'\n\n// ─── Constants ──────────────────────────────────────────────────────────\n\nconst ENTITY_TYPE_LABELS: Record<string, string> = {\n  sole_prop: 'Sole Proprietorship', llc: 'LLC (Disregarded)',\n  llc_scorp: 'LLC (S-Corp Election)', scorp: 'S-Corporation',\n  ccorp: 'C-Corporation', partnership: 'Partnership',\n}\nconst ENTITY_TYPES = Object.entries(ENTITY_TYPE_LABELS)\n\nconst INCOME_COLORS: Record<string, string> = {\n  business: '#d4a843', freelance: '#a78bfa', w2: '#60a5fa',\n  investment: '#34d399', rental: '#fbbf24', passive: '#f472b6', other: '#94a3b8',\n}\n\n// ─── Labor Income Intelligence Engine ──────────────────────────────────\n\ninterface LaborRecommendation {\n  incomeId: string; incomeName: string; currentEntityId?: string\n  recommendedEntityId?: string; recommendedEntityType: string\n  reason: string; estimatedSavings: number\n  priority: 'high' | 'medium' | 'low'; action: string\n  math?: { // Show-your-work breakdown\n    currentTax?: number\n    proposedTax?: number\n    currentSETax?: number\n    proposedSETax?: number\n    complianceCost?: number\n    netBenefit?: number\n    breakdown?: string[] // Line-by-line explanation\n  }\n}\n\nfunction analyzeLaborPlacement(state: FortunaState): LaborRecommendation[] {\n  const recs: LaborRecommendation[] = []\n  const activeEntities = state.entities.filter(e => e.isActive)\n  const activeStreams = state.incomeStreams.filter(s => s.isActive && s.annualAmount > 0)\n\n  for (const stream of activeStreams) {\n    const assigned = activeEntities.find(e => e.id === stream.entityId)\n\n    if (stream.type === 'w2') {\n      if (stream.entityId) {\n        recs.push({ incomeId: stream.id, incomeName: stream.name || 'W-2 Income',\n          currentEntityId: stream.entityId, recommendedEntityType: 'none',\n          reason: 'W-2 income is employer-paid and shouldn\\'t flow through your entities. Employer handles payroll taxes.',\n          estimatedSavings: 0, priority: 'medium', action: 'Unassign from entity' })\n      }\n      continue\n    }\n\n    if (stream.type === 'business' || stream.type === 'freelance') {\n      const seIncome = stream.annualAmount\n      const scorps = activeEntities.filter(e => e.type === 'llc_scorp' || e.type === 'scorp')\n\n      if (seIncome > 50000 && scorps.length > 0 && !scorps.find(e => e.id === stream.entityId)) {\n        const sa = calculateReasonableSalary(seIncome)\n        const currentSE = Math.round(seIncome * 0.9235 * 0.153)\n        const scorpFICA = Math.round(sa.recommendedSalary * 0.153)\n        recs.push({ incomeId: stream.id, incomeName: stream.name || stream.type,\n          currentEntityId: stream.entityId, recommendedEntityId: scorps[0].id, recommendedEntityType: 'S-Corp',\n          reason: `At $${seIncome.toLocaleString()}/yr, routing through S-Corp splits into ~$${sa.recommendedSalary.toLocaleString()} salary + ~$${sa.distributions.toLocaleString()} distributions. Distributions bypass FICA.`,\n          estimatedSavings: sa.seTaxSavings, priority: 'high', action: `Assign to ${scorps[0].name || 'S-Corp'}`,\n          math: {\n            currentSETax: currentSE, proposedSETax: scorpFICA,\n            complianceCost: 0, netBenefit: sa.seTaxSavings,\n            breakdown: [\n              `Current: $${seIncome.toLocaleString()} × 92.35% × 15.3% = $${currentSE.toLocaleString()} SE tax`,\n              `S-Corp salary: $${sa.recommendedSalary.toLocaleString()} × 15.3% = $${scorpFICA.toLocaleString()} FICA`,\n              `S-Corp distributions: $${sa.distributions.toLocaleString()} × 0% FICA = $0`,\n              `Annual FICA savings: $${currentSE.toLocaleString()} − $${scorpFICA.toLocaleString()} = $${sa.seTaxSavings.toLocaleString()}`\n            ]\n          }\n        })\n      } else if (seIncome > 50000 && scorps.length === 0 && !assigned) {\n        const sa = calculateReasonableSalary(seIncome)\n        const currentSE = Math.round(seIncome * 0.9235 * 0.153)\n        const scorpFICA = Math.round(sa.recommendedSalary * 0.153)\n        const compliance = 2500\n        recs.push({ incomeId: stream.id, incomeName: stream.name || stream.type,\n          recommendedEntityType: 'llc_scorp',\n          reason: `$${seIncome.toLocaleString()}/yr SE income exceeds S-Corp breakeven. Creating LLC w/ S-Corp election saves ~$${(sa.seTaxSavings - compliance).toLocaleString()}/yr net after compliance.`,\n          estimatedSavings: sa.seTaxSavings - compliance, priority: 'high', action: 'Create S-Corp entity',\n          math: {\n            currentSETax: currentSE, proposedSETax: scorpFICA,\n            complianceCost: compliance, netBenefit: sa.seTaxSavings - compliance,\n            breakdown: [\n              `Current SE tax: $${seIncome.toLocaleString()} × 92.35% × 15.3% = $${currentSE.toLocaleString()}/yr`,\n              `S-Corp salary FICA: $${sa.recommendedSalary.toLocaleString()} × 15.3% = $${scorpFICA.toLocaleString()}/yr`,\n              `Gross FICA savings: $${currentSE.toLocaleString()} − $${scorpFICA.toLocaleString()} = $${sa.seTaxSavings.toLocaleString()}/yr`,\n              `S-Corp compliance: payroll processing, 1120-S filing, etc. ≈ −$${compliance.toLocaleString()}/yr`,\n              `Net annual benefit: $${sa.seTaxSavings.toLocaleString()} − $${compliance.toLocaleString()} = $${(sa.seTaxSavings - compliance).toLocaleString()}/yr`\n            ]\n          }\n        })\n      } else if (seIncome > 0 && seIncome <= 50000 && !assigned) {\n        recs.push({ incomeId: stream.id, incomeName: stream.name || stream.type,\n          recommendedEntityType: 'llc',\n          reason: `At $${seIncome.toLocaleString()}/yr, an S-Corp may not offset compliance costs yet, but an LLC (~$300/yr) provides liability protection.`,\n          estimatedSavings: 0, priority: 'low', action: 'Create LLC for protection' })\n      } else if (assigned && (assigned.type === 'llc_scorp' || assigned.type === 'scorp') && seIncome < 30000) {\n        recs.push({ incomeId: stream.id, incomeName: stream.name || stream.type,\n          currentEntityId: assigned.id, recommendedEntityType: 'llc',\n          reason: `At $${seIncome.toLocaleString()}/yr, S-Corp compliance costs (~$2,500/yr) likely exceed FICA savings. Consider simple LLC.`,\n          estimatedSavings: -1500, priority: 'medium', action: 'Downgrade to LLC' })\n      }\n    }\n\n    if (stream.type === 'rental' && !stream.entityId && stream.annualAmount > 12000) {\n      recs.push({ incomeId: stream.id, incomeName: stream.name || 'Rental Income',\n        recommendedEntityType: 'llc',\n        reason: 'Rental properties should be in separate LLC for asset protection against premises liability.',\n        estimatedSavings: 0, priority: 'medium', action: 'Create property-holding LLC' })\n    }\n\n    if ((stream.type === 'investment' || stream.type === 'passive') && stream.entityId) {\n      recs.push({ incomeId: stream.id, incomeName: stream.name || stream.type,\n        currentEntityId: stream.entityId, recommendedEntityType: 'none',\n        reason: 'Investment/passive income is simpler held personally. Entity pass-through adds complexity without benefit.',\n        estimatedSavings: 0, priority: 'low', action: 'Unassign from entity' })\n    }\n  }\n\n  return recs.sort((a, b) => {\n    const p = { high: 0, medium: 1, low: 2 }\n    return (p[a.priority] - p[b.priority]) || (b.estimatedSavings - a.estimatedSavings)\n  })\n}\n\n// ─── Main Component ────────────────────────────────────────────────────\n\ntype PanelMode = 'closed' | 'entity' | 'income' | 'labor-intelligence' | 'add-entity'\n\nexport function EntityFlow() {\n  const { state, updateState, taxReport } = useFortuna()\n  const [selectedNodeId, setSelectedNodeId] = useState<string | null>(null)\n  const [panelMode, setPanelMode] = useState<PanelMode>('closed')\n  const [panelData, setPanelData] = useState<any>(null)\n  const [dropHighlight, setDropHighlight] = useState<string | null>(null)\n  const [showRecs, setShowRecs] = useState(false)\n  const [expandedMath, setExpandedMath] = useState<string | null>(null)\n\n  const hasData = state.incomeStreams.length > 0\n  const activeStreams = state.incomeStreams.filter(s => s.isActive && s.annualAmount > 0)\n  const activeEntities = state.entities.filter(e => e.isActive)\n  const totalRevenue = activeStreams.reduce((s, r) => s + r.annualAmount, 0)\n\n  const laborRecs = useMemo(() => analyzeLaborPlacement(state), [state])\n  const highCount = laborRecs.filter(r => r.priority === 'high').length\n\n  // ─── Entity/Income maps ──────────────────────────────────────────────\n\n  const { entityIncomeMap, unassignedStreams, entitySummaries } = useMemo(() => {\n    const map: Record<string, IncomeStream[]> = {}\n    const unassigned: IncomeStream[] = []\n    for (const e of activeEntities) map[e.id] = []\n    for (const s of activeStreams) {\n      if (s.entityId && map[s.entityId]) map[s.entityId].push(s)\n      else unassigned.push(s)\n    }\n    const summaries = activeEntities.map(entity => {\n      const streams = map[entity.id] || []\n      const totalIncome = streams.reduce((s, r) => s + r.annualAmount, 0)\n      const isScorp = entity.type === 'llc_scorp' || entity.type === 'scorp'\n      const salary = isScorp && totalIncome > 0 ? calculateReasonableSalary(totalIncome) : null\n      return { entity, streams, totalIncome, isScorp, salary }\n    })\n    return { entityIncomeMap: map, unassignedStreams: unassigned, entitySummaries: summaries }\n  }, [activeStreams, activeEntities])\n\n  // ─── Actions ─────────────────────────────────────────────────────────\n\n  const fmt = (n: number) => `$${n.toLocaleString()}`\n  const fmtK = (n: number) => n >= 1000 ? `$${(n / 1000).toFixed(n >= 100000 ? 0 : 1)}k` : `$${n.toLocaleString()}`\n\n  const onDragStart = useCallback((e: React.DragEvent, incomeId: string) => {\n    e.dataTransfer.setData('text/plain', incomeId)\n    e.dataTransfer.effectAllowed = 'move'\n  }, [])\n\n  const onDrop = useCallback((e: React.DragEvent, targetEntityId: string | undefined) => {\n    e.preventDefault()\n    const incomeId = e.dataTransfer.getData('text/plain')\n    if (!incomeId) return\n    updateState(prev => ({\n      ...prev,\n      incomeStreams: prev.incomeStreams.map(s =>\n        s.id === incomeId ? { ...s, entityId: targetEntityId } : s\n      ),\n    }))\n    setDropHighlight(null)\n  }, [updateState])\n\n  const openEntityPanel = useCallback((entity: LegalEntity) => {\n    setPanelData({ ...entity }); setPanelMode('entity'); setSelectedNodeId(`entity-${entity.id}`)\n  }, [])\n\n  const openIncomePanel = useCallback((stream: IncomeStream) => {\n    setPanelData({ ...stream }); setPanelMode('income'); setSelectedNodeId(`income-${stream.id}`)\n  }, [])\n\n  const saveEntity = useCallback((entity: LegalEntity) => {\n    updateState(prev => ({ ...prev, entities: prev.entities.map(e => e.id === entity.id ? entity : e) }))\n    setPanelMode('closed')\n  }, [updateState])\n\n  const deleteEntity = useCallback((entityId: string) => {\n    updateState(prev => ({\n      ...prev, entities: prev.entities.filter(e => e.id !== entityId),\n      incomeStreams: prev.incomeStreams.map(s => s.entityId === entityId ? { ...s, entityId: undefined } : s),\n      expenses: prev.expenses.map(x => x.entityId === entityId ? { ...x, entityId: undefined } : x),\n    }))\n    setPanelMode('closed')\n  }, [updateState])\n\n  const addEntity = useCallback((entity: Omit<LegalEntity, 'id'>, linkIncomeId?: string) => {\n    const id = genId()\n    updateState(prev => ({\n      ...prev, entities: [...prev.entities, { ...entity, id }],\n      incomeStreams: linkIncomeId\n        ? prev.incomeStreams.map(s => s.id === linkIncomeId ? { ...s, entityId: id } : s)\n        : prev.incomeStreams,\n    }))\n    setPanelMode('closed')\n  }, [updateState])\n\n  const saveIncome = useCallback((stream: IncomeStream) => {\n    updateState(prev => ({ ...prev, incomeStreams: prev.incomeStreams.map(s => s.id === stream.id ? stream : s) }))\n    setPanelMode('closed')\n  }, [updateState])\n\n  const unlinkIncome = useCallback((incomeId: string) => {\n    updateState(prev => ({\n      ...prev, incomeStreams: prev.incomeStreams.map(s => s.id === incomeId ? { ...s, entityId: undefined } : s),\n    }))\n  }, [updateState])\n\n  const applyRec = useCallback((rec: LaborRecommendation) => {\n    if (rec.recommendedEntityId) {\n      updateState(prev => ({\n        ...prev, incomeStreams: prev.incomeStreams.map(s =>\n          s.id === rec.incomeId ? { ...s, entityId: rec.recommendedEntityId } : s),\n      }))\n    } else if (rec.action.startsWith('Unassign')) {\n      updateState(prev => ({\n        ...prev, incomeStreams: prev.incomeStreams.map(s =>\n          s.id === rec.incomeId ? { ...s, entityId: undefined } : s),\n      }))\n    } else if (rec.action.startsWith('Create')) {\n      setPanelData({ suggestedType: rec.recommendedEntityType,\n        suggestedName: rec.incomeName ? `${rec.incomeName} ${rec.recommendedEntityType === 'llc' ? 'LLC' : 'S-Corp'}` : '',\n        linkIncomeId: rec.incomeId })\n      setPanelMode('add-entity')\n    }\n  }, [updateState])\n\n  // ─── Empty state ─────────────────────────────────────────────────────\n\n  if (!hasData) {\n    return (\n      <div className=\"view-enter\" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '50vh' }}>\n        <div style={{ textAlign: 'center', maxWidth: 400 }}>\n          <Building2 size={32} color=\"var(--accent-gold)\" style={{ marginBottom: 12 }} />\n          <h2 style={{ fontFamily: 'var(--font-display)', marginBottom: 8 }}>Entity Flow</h2>\n          <p style={{ fontSize: 13, color: 'var(--text-muted)' }}>Add financial data to visualize and manage your entity structure.</p>\n        </div>\n      </div>\n    )\n  }\n\n  // ─── Render ──────────────────────────────────────────────────────────\n\n  return (\n    <div className=\"view-enter\" style={{ display: 'flex', gap: 0, height: '100%', overflow: 'hidden' }}>\n      <div style={{ flex: 1, overflowY: 'auto', paddingBottom: 40 }}>\n        {/* Header */}\n        <div style={{ marginBottom: 24 }}>\n          <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 4, flexWrap: 'wrap' }}>\n            <h1 className=\"section-title\">Entity Flow</h1>\n            <span className=\"pill gold\"><Building2 size={11} /> Interactive</span>\n            {highCount > 0 && (\n              <button onClick={() => { setPanelMode('labor-intelligence'); setShowRecs(true) }}\n                className=\"pill\" style={{ background: 'var(--accent-gold-dim)', color: 'var(--accent-gold)', cursor: 'pointer', border: 'none' }}>\n                <Brain size={11} /> {highCount} optimization{highCount > 1 ? 's' : ''}\n              </button>\n            )}\n          </div>\n          <p className=\"section-subtitle\">Click any node to manage · Drag income sources onto entities to reassign · Add entities with +</p>\n        </div>\n\n        {/* Summary */}\n        <div className=\"grid-4 stagger\" style={{ marginBottom: 28 }}>\n          <div className=\"metric-card glow-gold\">\n            <span className=\"metric-label\">Gross Revenue</span>\n            <div className=\"metric-value\">{fmt(totalRevenue)}</div>\n          </div>\n          <div className=\"metric-card\">\n            <span className=\"metric-label\">Total Tax</span>\n            <div className=\"metric-value\" style={{ color: 'var(--accent-red)' }}>-{fmt(taxReport.totalTax)}</div>\n            <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>{(taxReport.effectiveRate * 100).toFixed(1)}% effective</span>\n          </div>\n          <div className=\"metric-card\">\n            <span className=\"metric-label\">Net Retained</span>\n            <div className=\"metric-value\" style={{ color: 'var(--accent-emerald)' }}>{fmt(taxReport.afterTaxIncome)}</div>\n            <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>{totalRevenue > 0 ? ((taxReport.afterTaxIncome / totalRevenue) * 100).toFixed(0) : 0}% kept</span>\n          </div>\n          <div className=\"metric-card\">\n            <span className=\"metric-label\">Entities</span>\n            <div className=\"metric-value\" style={{ color: 'var(--accent-blue)' }}>{activeEntities.length}</div>\n            <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>{unassignedStreams.length} unassigned</span>\n          </div>\n        </div>\n\n        {/* ── LAYER 1: Income Sources ────────────────────────────────── */}\n        <LayerHeader label=\"Revenue Sources\" />\n        <div style={{ display: 'flex', gap: 10, flexWrap: 'wrap', marginBottom: 8 }}>\n          {activeStreams.map(stream => {\n            const isW2 = stream.type === 'w2'\n            const isAssigned = !!stream.entityId && activeEntities.some(e => e.id === stream.entityId)\n            const assignedEnt = activeEntities.find(e => e.id === stream.entityId)\n            const sel = selectedNodeId === `income-${stream.id}`\n            const col = INCOME_COLORS[stream.type] || '#888'\n            const w2Withheld = isW2 ? (stream.w2?.federalWithholding || 0) + (stream.w2?.stateWithholding || 0) : 0\n            return (\n              <div key={stream.id} draggable={!isW2} onDragStart={isW2 ? undefined : (e => onDragStart(e, stream.id))}\n                onClick={() => openIncomePanel(stream)}\n                style={{\n                  background: sel ? 'var(--bg-surface)' : 'var(--bg-elevated)',\n                  border: `1px solid ${sel ? col : 'var(--border-subtle)'}`,\n                  borderRadius: 12, padding: '12px 16px', cursor: isW2 ? 'pointer' : 'grab',\n                  minWidth: 170, transition: 'all 0.2s', position: 'relative',\n                  boxShadow: sel ? `0 0 20px ${col}22` : 'none',\n                }}>\n                {!isW2 && <div style={{ position: 'absolute', top: 6, right: 6, opacity: 0.3 }}><GripVertical size={12} /></div>}\n                {isW2 && <div style={{ position: 'absolute', top: 6, right: 6, fontSize: 9, padding: '1px 6px', borderRadius: 4, background: 'rgba(96,165,250,0.15)', color: 'var(--accent-blue)', fontWeight: 500 }}>W-2</div>}\n                <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 6 }}>\n                  <div style={{ width: 28, height: 28, borderRadius: 7, background: `${col}18`, display: 'flex', alignItems: 'center', justifyContent: 'center', color: col }}>\n                    <DollarSign size={14} />\n                  </div>\n                  <div>\n                    <div style={{ fontSize: 12, fontWeight: 500, lineHeight: 1.2 }}>{stream.name || (isW2 ? (stream.w2?.employerName || 'W-2 Job') : stream.type)}</div>\n                    <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>{isW2 ? (stream.w2?.employerName ? 'W-2 Employment' : 'w2') : stream.type}</div>\n                  </div>\n                </div>\n                <div style={{ fontFamily: 'var(--font-mono)', fontSize: 15, fontWeight: 600, color: col, marginBottom: 4 }}>{fmt(stream.annualAmount)}</div>\n                {isW2 ? (\n                  <div style={{ fontSize: 10, color: w2Withheld > 0 ? 'var(--accent-blue)' : 'var(--text-muted)' }}>\n                    {w2Withheld > 0 ? `${fmt(w2Withheld)} withheld` : 'Employer-managed'}\n                  </div>\n                ) : isAssigned\n                  ? <div style={{ display: 'flex', alignItems: 'center', gap: 4, fontSize: 10, color: 'var(--accent-emerald)' }}><Link2 size={10} /> {assignedEnt?.name || 'Entity'}</div>\n                  : <div style={{ display: 'flex', alignItems: 'center', gap: 4, fontSize: 10, color: 'var(--text-muted)' }}><Unlink size={10} /> Unassigned</div>\n                }\n              </div>\n            )\n          })}\n        </div>\n\n        <FlowArrow />\n\n        {/* ── LAYER 2: Entities ──────────────────────────────────────── */}\n        <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 }}>\n          <span style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.12em', fontWeight: 600 }}>Legal Entities</span>\n          <div style={{ flex: 1, height: 1, background: 'var(--border-subtle)' }} />\n          <button onClick={() => { setPanelData({ suggestedType: 'llc', suggestedName: '' }); setPanelMode('add-entity') }}\n            style={{ display: 'flex', alignItems: 'center', gap: 4, padding: '4px 10px', borderRadius: 6,\n              background: 'var(--accent-gold-dim)', border: '1px solid var(--accent-gold-glow)',\n              color: 'var(--accent-gold)', fontSize: 11, cursor: 'pointer', fontWeight: 500 }}>\n            <Plus size={12} /> Add Entity\n          </button>\n        </div>\n\n        {activeEntities.length === 0 ? (\n          <div onDragOver={e => { e.preventDefault(); setDropHighlight('none') }} onDragLeave={() => setDropHighlight(null)}\n            onDrop={e => onDrop(e, undefined)}\n            style={{ border: `2px dashed ${dropHighlight === 'none' ? 'var(--accent-gold)' : 'var(--border-subtle)'}`,\n              borderRadius: 14, padding: 24, textAlign: 'center', marginBottom: 8,\n              background: dropHighlight === 'none' ? 'var(--accent-gold-dim)' : 'transparent', transition: 'all 0.2s' }}>\n            <Building2 size={24} color=\"var(--text-muted)\" style={{ margin: '0 auto 8px' }} />\n            <div style={{ fontSize: 13, color: 'var(--text-muted)' }}>No entities — all income is pass-through</div>\n          </div>\n        ) : (\n          <div style={{ display: 'flex', gap: 12, flexWrap: 'wrap', marginBottom: 8 }}>\n            {entitySummaries.map(({ entity, streams, totalIncome, isScorp, salary }) => {\n              const sel = selectedNodeId === `entity-${entity.id}`\n              const isDrop = dropHighlight === entity.id\n              return (\n                <div key={entity.id} onClick={() => openEntityPanel(entity)}\n                  onDragOver={e => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; setDropHighlight(entity.id) }}\n                  onDragLeave={() => setDropHighlight(null)} onDrop={e => onDrop(e, entity.id)}\n                  style={{\n                    background: isDrop ? 'var(--accent-gold-dim)' : sel ? 'var(--bg-surface)' : 'var(--bg-elevated)',\n                    border: `${isDrop ? '2px dashed' : '1px solid'} ${isDrop ? 'var(--accent-gold)' : sel ? '#d4a843' : 'var(--border-subtle)'}`,\n                    borderRadius: 14, padding: '16px 20px', cursor: 'pointer',\n                    minWidth: 240, maxWidth: 380, flex: '1 1 280px', transition: 'all 0.2s',\n                    boxShadow: sel ? '0 0 24px rgba(212,168,67,0.12)' : 'none',\n                  }}>\n                  <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 10 }}>\n                    <div style={{ width: 36, height: 36, borderRadius: 10, background: isScorp ? 'var(--accent-gold-dim)' : 'var(--accent-blue-dim)',\n                      display: 'flex', alignItems: 'center', justifyContent: 'center', color: isScorp ? 'var(--accent-gold)' : 'var(--accent-blue)' }}>\n                      <Building2 size={18} />\n                    </div>\n                    <div style={{ flex: 1 }}>\n                      <div style={{ fontSize: 14, fontWeight: 600 }}>{entity.name || ENTITY_TYPE_LABELS[entity.type]}</div>\n                      <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>{ENTITY_TYPE_LABELS[entity.type]} · {entity.state}</div>\n                    </div>\n                    <ChevronRight size={14} color=\"var(--text-muted)\" />\n                  </div>\n\n                  {streams.length === 0 ? (\n                    <div style={{ padding: '8px 12px', borderRadius: 8, background: 'var(--bg-hover)',\n                      border: '1px dashed var(--border-subtle)', fontSize: 11, color: 'var(--text-muted)', textAlign: 'center' }}>\n                      Drop income streams here\n                    </div>\n                  ) : (\n                    <div style={{ display: 'flex', flexDirection: 'column', gap: 4, marginBottom: 10 }}>\n                      {streams.map(s => (\n                        <div key={s.id} style={{ display: 'flex', alignItems: 'center', gap: 6, padding: '5px 8px', borderRadius: 6, background: 'var(--bg-hover)', fontSize: 11 }}>\n                          <div style={{ width: 6, height: 6, borderRadius: 3, background: INCOME_COLORS[s.type] || '#888' }} />\n                          <span style={{ flex: 1, color: 'var(--text-secondary)' }}>{s.name || s.type}</span>\n                          <span style={{ fontFamily: 'var(--font-mono)', fontWeight: 500, color: INCOME_COLORS[s.type] }}>{fmtK(s.annualAmount)}</span>\n                          <button onClick={e => { e.stopPropagation(); unlinkIncome(s.id) }}\n                            style={{ background: 'none', border: 'none', cursor: 'pointer', padding: 2, color: 'var(--text-muted)', display: 'flex' }} title=\"Unlink\">\n                            <X size={10} />\n                          </button>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n\n                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'baseline', borderTop: '1px solid var(--border-subtle)', paddingTop: 8 }}>\n                    <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>Total</span>\n                    <span style={{ fontFamily: 'var(--font-mono)', fontSize: 15, fontWeight: 600, color: '#d4a843' }}>{fmt(totalIncome)}</span>\n                  </div>\n\n                  {isScorp && totalIncome > 0 && salary && (\n                    <div style={{ marginTop: 8, padding: '8px 10px', borderRadius: 8, background: 'var(--bg-void)' }}>\n                      <div style={{ fontSize: 10, color: 'var(--text-muted)', marginBottom: 6, fontWeight: 500 }}>S-CORP SPLIT</div>\n                      <div style={{ display: 'flex', gap: 8 }}>\n                        <div style={{ flex: 1, textAlign: 'center' }}>\n                          <div style={{ fontSize: 10, color: 'var(--accent-blue)', marginBottom: 2 }}>Salary</div>\n                          <div style={{ fontFamily: 'var(--font-mono)', fontSize: 12, fontWeight: 600, color: 'var(--accent-blue)' }}>{fmtK(salary.recommendedSalary)}</div>\n                          <div style={{ fontSize: 9, color: 'var(--text-muted)' }}>FICA: {fmtK(salary.seTaxOnSalary)}</div>\n                        </div>\n                        <div style={{ width: 1, background: 'var(--border-subtle)' }} />\n                        <div style={{ flex: 1, textAlign: 'center' }}>\n                          <div style={{ fontSize: 10, color: 'var(--accent-emerald)', marginBottom: 2 }}>Distributions</div>\n                          <div style={{ fontFamily: 'var(--font-mono)', fontSize: 12, fontWeight: 600, color: 'var(--accent-emerald)' }}>{fmtK(salary.distributions)}</div>\n                          <div style={{ fontSize: 9, color: 'var(--accent-emerald)' }}>No FICA ✓</div>\n                        </div>\n                      </div>\n                      <div style={{ marginTop: 6, textAlign: 'center', fontSize: 10, color: 'var(--accent-gold)' }}>\n                        <Sparkles size={10} /> Saves ~{fmt(salary.seTaxSavings)}/yr in FICA\n                      </div>\n                    </div>\n                  )}\n                </div>\n              )\n            })}\n\n            {unassignedStreams.length > 0 && (\n              <div onDragOver={e => { e.preventDefault(); setDropHighlight('unassigned') }}\n                onDragLeave={() => setDropHighlight(null)} onDrop={e => onDrop(e, undefined)}\n                style={{ background: dropHighlight === 'unassigned' ? 'rgba(96,165,250,0.08)' : 'var(--bg-elevated)',\n                  border: `1px ${dropHighlight === 'unassigned' ? 'dashed' : 'solid'} ${dropHighlight === 'unassigned' ? 'var(--accent-blue)' : 'var(--border-subtle)'}`,\n                  borderRadius: 14, padding: '16px 20px', minWidth: 200, maxWidth: 280, flex: '0 1 240px', opacity: 0.7 }}>\n                <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 10 }}>\n                  <User size={16} color=\"var(--text-muted)\" />\n                  <span style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-secondary)' }}>Personal / Unassigned</span>\n                </div>\n                {unassignedStreams.map(s => (\n                  <div key={s.id} style={{ display: 'flex', alignItems: 'center', gap: 6, padding: '4px 6px', borderRadius: 5, background: 'var(--bg-hover)', fontSize: 11, marginBottom: 3 }}>\n                    <div style={{ width: 5, height: 5, borderRadius: 3, background: INCOME_COLORS[s.type] || '#888' }} />\n                    <span style={{ flex: 1, color: 'var(--text-muted)' }}>{s.name || s.type}</span>\n                    <span style={{ fontFamily: 'var(--font-mono)', fontSize: 10 }}>{fmtK(s.annualAmount)}</span>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n        )}\n\n        <FlowArrow color=\"var(--accent-red)\" />\n\n        {/* ── LAYER 3: Taxes ─────────────────────────────────────────── */}\n        <LayerHeader label=\"Tax Obligations\" />\n        <div style={{ display: 'flex', gap: 10, flexWrap: 'wrap', marginBottom: 8 }}>\n          {taxReport.federalIncomeTax > 0 && <TaxNode label=\"Federal Income Tax\" sublabel={`${(taxReport.effectiveRate * 100).toFixed(1)}% effective`} amount={taxReport.federalIncomeTax} color=\"#f87171\" icon={<Landmark size={14} />} />}\n          {taxReport.selfEmploymentTax > 0 && <TaxNode label={entitySummaries.some(e => e.isScorp) ? 'FICA (salary only)' : 'Self-Employment Tax'} sublabel={entitySummaries.some(e => e.isScorp) ? 'Reduced via S-Corp' : '15.3% of SE income'} amount={taxReport.selfEmploymentTax} color=\"#a78bfa\" icon={<Shield size={14} />} />}\n          {taxReport.stateTax > 0 && <TaxNode label={`${state.profile.state} State Tax`} amount={taxReport.stateTax} color=\"#fbbf24\" icon={<Landmark size={14} />} />}\n        </div>\n\n        <FlowArrow color=\"var(--accent-emerald)\" />\n\n        {/* ── LAYER 4: Net ───────────────────────────────────────────── */}\n        <LayerHeader label=\"Net to You\" />\n        <div style={{ background: 'var(--bg-elevated)', border: '1px solid var(--accent-emerald-dim)',\n          borderRadius: 14, padding: '16px 24px', display: 'inline-flex', alignItems: 'center', gap: 12, marginBottom: 24 }}>\n          <div style={{ width: 40, height: 40, borderRadius: 10, background: 'var(--accent-emerald-dim)',\n            display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'var(--accent-emerald)' }}>\n            <Wallet size={20} />\n          </div>\n          <div>\n            <div style={{ fontSize: 12, color: 'var(--text-muted)' }}>After-Tax Income</div>\n            <div style={{ fontFamily: 'var(--font-mono)', fontSize: 22, fontWeight: 700, color: 'var(--accent-emerald)' }}>{fmt(taxReport.afterTaxIncome)}</div>\n          </div>\n          <div style={{ marginLeft: 16, textAlign: 'right' }}>\n            <div style={{ fontSize: 12, color: 'var(--text-muted)' }}>Retention</div>\n            <div style={{ fontFamily: 'var(--font-mono)', fontSize: 18, fontWeight: 600 }}>{totalRevenue > 0 ? ((taxReport.afterTaxIncome / totalRevenue) * 100).toFixed(1) : 0}%</div>\n          </div>\n        </div>\n\n        {/* ── Labor Intelligence ──────────────────────────────────────── */}\n        {laborRecs.length > 0 && (\n          <div className=\"card\" style={{ marginBottom: 24 }}>\n            <div className=\"card-header\" style={{ cursor: 'pointer' }} onClick={() => setShowRecs(!showRecs)}>\n              <span className=\"card-title\"><Brain size={16} /> Labor Income Intelligence</span>\n              <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n                <span style={{ fontSize: 11, color: 'var(--accent-gold)', fontFamily: 'var(--font-mono)' }}>{laborRecs.length} rec{laborRecs.length > 1 ? 's' : ''}</span>\n                {showRecs ? <ChevronUp size={14} color=\"var(--text-muted)\" /> : <ChevronDown size={14} color=\"var(--text-muted)\" />}\n              </div>\n            </div>\n            {showRecs && (\n              <div className=\"card-body\" style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>\n                {laborRecs.map((rec, i) => (\n                  <div key={i} style={{ padding: '12px 16px', borderRadius: 10,\n                    background: rec.priority === 'high' ? 'var(--accent-gold-dim)' : 'var(--bg-hover)',\n                    border: `1px solid ${rec.priority === 'high' ? 'var(--accent-gold-glow)' : 'var(--border-subtle)'}` }}>\n                    <div style={{ display: 'flex', alignItems: 'flex-start', gap: 10 }}>\n                      <div style={{ width: 28, height: 28, borderRadius: 7, flexShrink: 0,\n                        background: rec.priority === 'high' ? 'var(--accent-gold-dim)' : 'var(--bg-elevated)',\n                        display: 'flex', alignItems: 'center', justifyContent: 'center',\n                        color: rec.priority === 'high' ? 'var(--accent-gold)' : 'var(--text-muted)' }}>\n                        {rec.priority === 'high' ? <Zap size={14} /> : rec.priority === 'medium' ? <Info size={14} /> : <Target size={14} />}\n                      </div>\n                      <div style={{ flex: 1 }}>\n                        <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 4 }}>\n                          <span style={{ fontSize: 13, fontWeight: 600 }}>{rec.incomeName}</span>\n                          <span className=\"pill\" style={{ fontSize: 9, padding: '1px 6px',\n                            background: rec.priority === 'high' ? 'var(--accent-gold-dim)' : 'var(--bg-elevated)',\n                            color: rec.priority === 'high' ? 'var(--accent-gold)' : 'var(--text-muted)' }}>{rec.priority}</span>\n                          {rec.estimatedSavings > 0 && (\n                            <span style={{ fontSize: 11, color: 'var(--accent-emerald)', fontFamily: 'var(--font-mono)', fontWeight: 500 }}>+{fmt(rec.estimatedSavings)}/yr</span>\n                          )}\n                        </div>\n                        <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.5, marginBottom: 8 }}>{rec.reason}</div>\n                        <div style={{ display: 'flex', alignItems: 'center', gap: 8, flexWrap: 'wrap' }}>\n                          <button onClick={() => applyRec(rec)}\n                            style={{ display: 'inline-flex', alignItems: 'center', gap: 4, padding: '5px 12px', borderRadius: 6,\n                              background: rec.priority === 'high' ? 'var(--accent-gold)' : 'var(--bg-elevated)',\n                              color: rec.priority === 'high' ? '#0c0e12' : 'var(--text-primary)',\n                              border: rec.priority === 'high' ? 'none' : '1px solid var(--border-subtle)',\n                              fontSize: 11, fontWeight: 600, cursor: 'pointer' }}>\n                            <Sparkles size={11} /> {rec.action}\n                          </button>\n                          {rec.math?.breakdown && rec.math.breakdown.length > 0 && (\n                            <button onClick={() => setExpandedMath(expandedMath === rec.incomeId ? null : rec.incomeId)}\n                              style={{ display: 'inline-flex', alignItems: 'center', gap: 4, padding: '5px 10px', borderRadius: 6,\n                                background: 'none', border: '1px solid var(--border-subtle)', color: 'var(--text-muted)',\n                                fontSize: 10, cursor: 'pointer', fontFamily: 'var(--font-mono)' }}>\n                              <Calculator size={10} /> {expandedMath === rec.incomeId ? 'Hide Math' : 'Show Math'}\n                            </button>\n                          )}\n                        </div>\n                        {/* Math transparency breakdown */}\n                        {expandedMath === rec.incomeId && rec.math?.breakdown && (\n                          <div style={{ marginTop: 10, padding: '10px 12px', borderRadius: 8,\n                            background: 'var(--bg-primary)', border: '1px solid var(--border-subtle)' }}>\n                            <div style={{ fontSize: 10, fontWeight: 600, color: 'var(--accent-gold)', textTransform: 'uppercase',\n                              letterSpacing: '0.08em', marginBottom: 8 }}>Calculation Breakdown</div>\n                            {rec.math.breakdown.map((line, j) => (\n                              <div key={j} style={{ fontSize: 11, color: 'var(--text-secondary)', lineHeight: 1.7, fontFamily: 'var(--font-mono)',\n                                paddingLeft: 8, borderLeft: `2px solid ${j === rec.math!.breakdown!.length - 1 ? 'var(--accent-emerald)' : 'var(--border-subtle)'}` }}>\n                                {line}\n                              </div>\n                            ))}\n                            {rec.math.netBenefit !== undefined && (\n                              <div style={{ marginTop: 8, padding: '6px 10px', borderRadius: 6,\n                                background: rec.math.netBenefit > 0 ? 'rgba(16,185,129,0.08)' : 'rgba(239,107,107,0.08)',\n                                fontSize: 12, fontWeight: 600, fontFamily: 'var(--font-mono)',\n                                color: rec.math.netBenefit > 0 ? 'var(--accent-emerald)' : 'var(--accent-red)' }}>\n                                Net: {rec.math.netBenefit > 0 ? '+' : ''}{fmt(rec.math.netBenefit)}/yr\n                              </div>\n                            )}\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n        )}\n\n        {/* Tax Waterfall + Structure Analysis */}\n        <div className=\"grid-2\" style={{ marginBottom: 24 }}>\n          <div className=\"card\">\n            <div className=\"card-header\"><span className=\"card-title\">Tax Waterfall</span></div>\n            <div className=\"card-body\">\n              {[\n                { label: 'Gross Revenue', amount: totalRevenue, color: 'var(--accent-gold)' },\n                { label: 'Deductions', amount: -(totalRevenue - taxReport.taxableIncome - taxReport.selfEmploymentTax * 0.5), color: 'var(--accent-blue)' },\n                { label: 'Federal Tax', amount: -taxReport.federalIncomeTax, color: 'var(--accent-red)' },\n                { label: 'SE/FICA', amount: -taxReport.selfEmploymentTax, color: 'var(--accent-purple)' },\n                { label: `${state.profile.state} State`, amount: -taxReport.stateTax, color: 'var(--accent-amber)' },\n                ...((taxReport.w2FederalWithheld > 0 || taxReport.w2StateWithheld > 0) ? [\n                  { label: 'W-2 Withheld', amount: taxReport.w2FederalWithheld + taxReport.w2StateWithheld, color: 'var(--accent-blue)' },\n                  { label: taxReport.netTaxOwed <= 0 ? 'Est. Refund' : 'Net Still Owed', amount: taxReport.netTaxOwed <= 0 ? Math.abs(taxReport.netTaxOwed) : -taxReport.netTaxOwed, color: taxReport.netTaxOwed <= 0 ? 'var(--accent-emerald)' : 'var(--accent-red)' },\n                ] : []),\n                { label: 'Net Income', amount: taxReport.afterTaxIncome, color: 'var(--accent-emerald)' },\n              ].map((item, i, arr) => (\n                <div key={i} style={{ display: 'flex', alignItems: 'center', gap: 12, padding: '9px 0',\n                  borderBottom: i < arr.length - 1 ? '1px solid var(--border-subtle)' : 'none' }}>\n                  <div style={{ width: 4, height: 22, borderRadius: 2, background: item.color }} />\n                  <span style={{ flex: 1, fontSize: 13, color: i === arr.length - 1 ? 'var(--text-primary)' : 'var(--text-secondary)', fontWeight: i === arr.length - 1 ? 600 : 400 }}>{item.label}</span>\n                  <span style={{ fontFamily: 'var(--font-mono)', fontSize: 13, fontWeight: 500, color: item.amount < 0 ? 'var(--accent-red)' : item.color }}>\n                    {item.amount < 0 ? '-' : ''}{fmt(Math.abs(item.amount))}\n                  </span>\n                </div>\n              ))}\n            </div>\n          </div>\n\n          <div className=\"card\">\n            <div className=\"card-header\"><span className=\"card-title\">Structure Analysis</span></div>\n            <div className=\"card-body\">\n              {entitySummaries.map(({ entity, totalIncome, isScorp, salary, streams }) => (\n                <div key={entity.id} style={{ padding: '10px 12px', borderRadius: 8, background: 'var(--bg-hover)', marginBottom: 8, cursor: 'pointer' }}\n                  onClick={() => openEntityPanel(entity)}>\n                  <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>\n                    <Building2 size={13} color={isScorp ? 'var(--accent-gold)' : 'var(--accent-blue)'} />\n                    <span style={{ fontSize: 12, fontWeight: 500, flex: 1 }}>{entity.name || ENTITY_TYPE_LABELS[entity.type]}</span>\n                    <span style={{ fontFamily: 'var(--font-mono)', fontSize: 12, color: 'var(--accent-gold)' }}>{fmt(totalIncome)}</span>\n                  </div>\n                  <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>\n                    {streams.length} stream{streams.length !== 1 ? 's' : ''} · {ENTITY_TYPE_LABELS[entity.type]}\n                    {isScorp && salary && <span style={{ color: 'var(--accent-emerald)' }}> · Saves {fmt(salary.seTaxSavings)}/yr</span>}\n                  </div>\n                </div>\n              ))}\n              {activeEntities.length === 0 && (\n                <div style={{ padding: 16, textAlign: 'center', color: 'var(--text-muted)', fontSize: 12 }}>No entities — all pass-through.</div>\n              )}\n              <div style={{ marginTop: 8, padding: '10px 12px', borderRadius: 8, background: 'var(--bg-surface)' }}>\n                <div style={{ fontSize: 11, color: 'var(--text-muted)', marginBottom: 6, textTransform: 'uppercase', letterSpacing: '0.05em', fontWeight: 500 }}>Flow Efficiency</div>\n                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'baseline', marginBottom: 6 }}>\n                  <span style={{ fontSize: 12, color: 'var(--text-secondary)' }}>Retained</span>\n                  <span style={{ fontFamily: 'var(--font-mono)', fontSize: 16, fontWeight: 600, color: 'var(--accent-emerald)' }}>\n                    {totalRevenue > 0 ? ((taxReport.afterTaxIncome / totalRevenue) * 100).toFixed(1) : 0}%\n                  </span>\n                </div>\n                <div className=\"progress-bar\" style={{ height: 6, borderRadius: 3 }}>\n                  <div className=\"progress-fill\" style={{ width: `${totalRevenue > 0 ? (taxReport.afterTaxIncome / totalRevenue) * 100 : 0}%`,\n                    background: 'linear-gradient(90deg, #f87171 0%, #fbbf24 40%, #34d399 80%)', borderRadius: 3 }} />\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* ─── SLIDE-OUT PANEL ──────────────────────────────────────────── */}\n      {panelMode !== 'closed' && (\n        <div style={{ width: 380, borderLeft: '1px solid var(--border-subtle)', background: 'var(--bg-primary)',\n          overflowY: 'auto', padding: '20px 24px', flexShrink: 0, animation: 'slideInRight 0.2s ease-out' }}>\n          {panelMode === 'entity' && panelData && (\n            <EntityPanel entity={panelData} streams={entityIncomeMap[panelData.id] || []}\n              entities={activeEntities} onSave={saveEntity} onDelete={deleteEntity}\n              onClose={() => { setPanelMode('closed'); setSelectedNodeId(null) }} fmt={fmt} fmtK={fmtK} />\n          )}\n          {panelMode === 'income' && panelData && (\n            <IncomePanel stream={panelData} entities={activeEntities}\n              onSave={saveIncome} onClose={() => { setPanelMode('closed'); setSelectedNodeId(null) }}\n              onAssign={entityId => {\n                updateState(prev => ({ ...prev, incomeStreams: prev.incomeStreams.map(s => s.id === panelData.id ? { ...s, entityId } : s) }))\n                setPanelData((p: any) => ({ ...p, entityId }))\n              }} fmt={fmt} />\n          )}\n          {panelMode === 'add-entity' && (\n            <AddEntityPanel suggestedType={panelData?.suggestedType} suggestedName={panelData?.suggestedName}\n              linkIncomeId={panelData?.linkIncomeId} profileState={state.profile.state}\n              onAdd={addEntity} onClose={() => { setPanelMode('closed'); setSelectedNodeId(null) }} />\n          )}\n          {panelMode === 'labor-intelligence' && (\n            <div>\n              <PanelHeader title=\"Labor Intelligence\" onClose={() => setPanelMode('closed')} />\n              <p style={{ fontSize: 12, color: 'var(--text-muted)', marginBottom: 16, lineHeight: 1.6 }}>\n                Fortuna analyzed your income streams and entity structure for optimal labor income routing.\n              </p>\n              {laborRecs.map((rec, i) => (\n                <div key={i} style={{ padding: 14, borderRadius: 10, background: 'var(--bg-elevated)', border: '1px solid var(--border-subtle)', marginBottom: 10 }}>\n                  <div style={{ fontSize: 13, fontWeight: 600, marginBottom: 4 }}>{rec.incomeName}</div>\n                  <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.5, marginBottom: 8 }}>{rec.reason}</div>\n                  {rec.estimatedSavings > 0 && <div style={{ fontSize: 12, color: 'var(--accent-emerald)', fontFamily: 'var(--font-mono)', marginBottom: 8 }}>+{fmt(rec.estimatedSavings)}/yr</div>}\n                  <button onClick={() => applyRec(rec)} style={{ padding: '6px 12px', borderRadius: 6, border: 'none',\n                    background: 'var(--accent-gold)', color: '#0c0e12', fontSize: 11, fontWeight: 600, cursor: 'pointer' }}>{rec.action}</button>\n                </div>\n              ))}\n            </div>\n          )}\n        </div>\n      )}\n\n      <style>{`@keyframes slideInRight { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }`}</style>\n    </div>\n  )\n}\n\n// ─── Shared Sub-Components ──────────────────────────────────────────────\n\nfunction LayerHeader({ label }: { label: string }) {\n  return (\n    <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 }}>\n      <span style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.12em', fontWeight: 600 }}>{label}</span>\n      <div style={{ flex: 1, height: 1, background: 'var(--border-subtle)' }} />\n    </div>\n  )\n}\n\nfunction FlowArrow({ color }: { color?: string }) {\n  return (\n    <div style={{ display: 'flex', justifyContent: 'center', padding: '8px 0' }}>\n      <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center' }}>\n        <div style={{ width: 2, height: 16, background: color || 'var(--border-medium)' }} />\n        <ArrowDown size={14} color={color || 'var(--text-muted)'} />\n      </div>\n    </div>\n  )\n}\n\nfunction TaxNode({ label, sublabel, amount, color, icon }: { label: string; sublabel?: string; amount: number; color: string; icon: React.ReactNode }) {\n  return (\n    <div style={{ background: 'var(--bg-elevated)', border: '1px solid var(--border-subtle)', borderRadius: 12, padding: '12px 16px', minWidth: 160 }}>\n      <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 6 }}>\n        <div style={{ width: 28, height: 28, borderRadius: 7, background: `${color}18`, display: 'flex', alignItems: 'center', justifyContent: 'center', color }}>{icon}</div>\n        <div>\n          <div style={{ fontSize: 12, fontWeight: 500 }}>{label}</div>\n          {sublabel && <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>{sublabel}</div>}\n        </div>\n      </div>\n      <div style={{ fontFamily: 'var(--font-mono)', fontSize: 15, fontWeight: 600, color }}>-${amount.toLocaleString()}</div>\n    </div>\n  )\n}\n\nfunction PanelHeader({ title, onClose }: { title: string; onClose: () => void }) {\n  return (\n    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 16 }}>\n      <h3 style={{ fontFamily: 'var(--font-display)', fontSize: 20 }}>{title}</h3>\n      <button onClick={onClose} style={{ background: 'none', border: 'none', cursor: 'pointer', color: 'var(--text-muted)', display: 'flex' }}><X size={18} /></button>\n    </div>\n  )\n}\n\nfunction PanelInput({ label, value, onChange, ...props }: { label: string; value: string | number; onChange: (v: string) => void; [k: string]: any }) {\n  return (\n    <div>\n      <label style={{ fontSize: 11, color: 'var(--text-muted)', display: 'block', marginBottom: 4 }}>{label}</label>\n      <input value={value} onChange={e => onChange(e.target.value)}\n        style={{ width: '100%', padding: '8px 12px', borderRadius: 8, background: 'var(--bg-elevated)',\n          border: '1px solid var(--border-subtle)', color: 'var(--text-primary)', fontSize: 13, outline: 'none' }} {...props} />\n    </div>\n  )\n}\n\n// ─── Entity Detail Panel ────────────────────────────────────────────────\n\nfunction EntityPanel({ entity, streams, entities, onSave, onDelete, onClose, fmt, fmtK }: {\n  entity: LegalEntity; streams: IncomeStream[]; entities: LegalEntity[]\n  onSave: (e: LegalEntity) => void; onDelete: (id: string) => void; onClose: () => void\n  fmt: (n: number) => string; fmtK: (n: number) => string\n}) {\n  const [editing, setEditing] = useState(false)\n  const [form, setForm] = useState(entity)\n  const [confirmDel, setConfirmDel] = useState(false)\n  const totalIncome = streams.reduce((s, r) => s + r.annualAmount, 0)\n  const isScorp = form.type === 'llc_scorp' || form.type === 'scorp'\n\n  useEffect(() => { setForm(entity); setEditing(false); setConfirmDel(false) }, [entity])\n\n  const upd = (partial: Partial<LegalEntity>) => { setForm(prev => ({ ...prev, ...partial })); setEditing(true) }\n\n  return (\n    <div>\n      <PanelHeader title=\"Entity Details\" onClose={onClose} />\n      <div style={{ display: 'flex', flexDirection: 'column', gap: 12, marginBottom: 20 }}>\n        <PanelInput label=\"Entity Name\" value={form.name} onChange={v => upd({ name: v })} placeholder=\"Entity name\" />\n        <div>\n          <label style={{ fontSize: 11, color: 'var(--text-muted)', display: 'block', marginBottom: 4 }}>Entity Type</label>\n          <select value={form.type} onChange={e => { upd({ type: e.target.value as any }) }}\n            style={{ width: '100%', padding: '8px 12px', borderRadius: 8, background: 'var(--bg-elevated)',\n              border: '1px solid var(--border-subtle)', color: 'var(--text-primary)', fontSize: 13, outline: 'none' }}>\n            {ENTITY_TYPES.map(([v, l]) => <option key={v} value={v}>{l}</option>)}\n          </select>\n        </div>\n        <div style={{ display: 'flex', gap: 12 }}>\n          <div style={{ flex: 1 }}><PanelInput label=\"State\" value={form.state} onChange={v => upd({ state: v.toUpperCase().slice(0, 2) })} maxLength={2} /></div>\n          <div style={{ flex: 1 }}><PanelInput label=\"Annual Cost\" value={form.annualCost} onChange={v => upd({ annualCost: Number(v) })} type=\"number\" /></div>\n        </div>\n        <PanelInput label=\"EIN\" value={form.einNumber || ''} onChange={v => upd({ einNumber: v })} placeholder=\"XX-XXXXXXX\" />\n        <PanelInput label=\"Formation Date\" value={form.formationDate || ''} onChange={v => upd({ formationDate: v })} type=\"date\" />\n      </div>\n\n      <div style={{ fontSize: 11, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.08em', marginBottom: 8, fontWeight: 500 }}>Income Streams ({streams.length})</div>\n      {streams.length === 0\n        ? <div style={{ fontSize: 12, color: 'var(--text-muted)', padding: 12, background: 'var(--bg-hover)', borderRadius: 8, textAlign: 'center', marginBottom: 12 }}>No income assigned.</div>\n        : <div style={{ marginBottom: 12 }}>\n            {streams.map(s => (\n              <div key={s.id} style={{ display: 'flex', alignItems: 'center', gap: 8, padding: '8px 10px', borderRadius: 6, background: 'var(--bg-hover)', marginBottom: 4 }}>\n                <div style={{ width: 8, height: 8, borderRadius: 4, background: INCOME_COLORS[s.type] }} />\n                <span style={{ flex: 1, fontSize: 12 }}>{s.name || s.type}</span>\n                <span style={{ fontFamily: 'var(--font-mono)', fontSize: 12, fontWeight: 500 }}>{fmt(s.annualAmount)}</span>\n              </div>\n            ))}\n            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderTop: '1px solid var(--border-subtle)', marginTop: 4 }}>\n              <span style={{ fontSize: 12, fontWeight: 500 }}>Total</span>\n              <span style={{ fontFamily: 'var(--font-mono)', fontSize: 14, fontWeight: 600, color: 'var(--accent-gold)' }}>{fmt(totalIncome)}</span>\n            </div>\n          </div>\n      }\n\n      {isScorp && totalIncome > 0 && (() => {\n        const sa = calculateReasonableSalary(totalIncome)\n        return (\n          <div style={{ marginBottom: 16, padding: 14, borderRadius: 10, background: 'var(--bg-surface)', border: '1px solid var(--border-subtle)' }}>\n            <div style={{ fontSize: 11, color: 'var(--accent-gold)', textTransform: 'uppercase', letterSpacing: '0.08em', marginBottom: 8, fontWeight: 600 }}><Zap size={11} /> S-Corp Analysis</div>\n            {[\n              { l: 'Reasonable Salary', v: sa.recommendedSalary, c: 'var(--accent-blue)' },\n              { l: 'Distributions', v: sa.distributions, c: 'var(--accent-emerald)' },\n              { l: 'FICA on Salary', v: -sa.seTaxOnSalary, c: 'var(--accent-red)' },\n            ].map((r, i) => (\n              <div key={i} style={{ display: 'flex', justifyContent: 'space-between', fontSize: 12, marginBottom: 4 }}>\n                <span style={{ color: 'var(--text-secondary)' }}>{r.l}</span>\n                <span style={{ fontFamily: 'var(--font-mono)', fontWeight: 500, color: r.c }}>{r.v < 0 ? '-' : ''}{fmt(Math.abs(r.v))}</span>\n              </div>\n            ))}\n            <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 12, borderTop: '1px solid var(--border-subtle)', paddingTop: 6, marginTop: 4 }}>\n              <span style={{ fontWeight: 500, color: 'var(--accent-emerald)' }}>Annual FICA Savings</span>\n              <span style={{ fontFamily: 'var(--font-mono)', fontWeight: 600, color: 'var(--accent-emerald)' }}>+{fmt(sa.seTaxSavings)}</span>\n            </div>\n            <div style={{ fontSize: 10, color: 'var(--text-muted)', marginTop: 6 }}>\n              Risk: <span style={{ color: sa.riskLevel === 'low' ? 'var(--accent-emerald)' : sa.riskLevel === 'moderate' ? 'var(--accent-amber)' : 'var(--accent-red)' }}>{sa.riskLevel}</span>\n            </div>\n          </div>\n        )\n      })()}\n\n      <div style={{ display: 'flex', gap: 8 }}>\n        {editing && (\n          <button onClick={() => onSave(form)} style={{ flex: 1, padding: '10px 16px', borderRadius: 8, border: 'none',\n            background: 'var(--accent-gold)', color: '#0c0e12', fontSize: 13, fontWeight: 600, cursor: 'pointer',\n            display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 6 }}><Check size={14} /> Save</button>\n        )}\n        {!confirmDel\n          ? <button onClick={() => setConfirmDel(true)} style={{ padding: '10px 16px', borderRadius: 8,\n              background: 'var(--accent-red-dim)', border: '1px solid rgba(239,107,107,0.2)', color: 'var(--accent-red)',\n              fontSize: 13, fontWeight: 500, cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 6 }}><Trash2 size={14} /> Delete</button>\n          : <button onClick={() => onDelete(entity.id)} style={{ flex: 1, padding: '10px 16px', borderRadius: 8, border: 'none',\n              background: 'var(--accent-red)', color: 'white', fontSize: 13, fontWeight: 600, cursor: 'pointer',\n              display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 6 }}><AlertTriangle size={14} /> Confirm Delete</button>\n        }\n      </div>\n    </div>\n  )\n}\n\n// ─── Income Detail Panel ────────────────────────────────────────────────\n\nfunction IncomePanel({ stream, entities, onSave, onClose, onAssign, fmt }: {\n  stream: IncomeStream; entities: LegalEntity[]; onSave: (s: IncomeStream) => void\n  onClose: () => void; onAssign: (id: string | undefined) => void; fmt: (n: number) => string\n}) {\n  const [form, setForm] = useState(stream)\n  const [editing, setEditing] = useState(false)\n  useEffect(() => { setForm(stream); setEditing(false) }, [stream])\n  const upd = (partial: Partial<IncomeStream>) => { setForm(prev => ({ ...prev, ...partial })); setEditing(true) }\n\n  return (\n    <div>\n      <PanelHeader title=\"Income Stream\" onClose={onClose} />\n      <div style={{ display: 'flex', flexDirection: 'column', gap: 12, marginBottom: 20 }}>\n        <PanelInput label=\"Name\" value={form.name} onChange={v => upd({ name: v })} />\n        <div>\n          <label style={{ fontSize: 11, color: 'var(--text-muted)', display: 'block', marginBottom: 4 }}>Type</label>\n          <select value={form.type} onChange={e => { upd({ type: e.target.value as any }) }}\n            style={{ width: '100%', padding: '8px 12px', borderRadius: 8, background: 'var(--bg-elevated)',\n              border: '1px solid var(--border-subtle)', color: 'var(--text-primary)', fontSize: 13, outline: 'none' }}>\n            {['business', 'w2', 'freelance', 'investment', 'rental', 'passive', 'other'].map(t =>\n              <option key={t} value={t}>{t.charAt(0).toUpperCase() + t.slice(1)}</option>)}\n          </select>\n        </div>\n        <PanelInput label=\"Annual Amount\" value={form.annualAmount} onChange={v => upd({ annualAmount: Number(v) })} type=\"number\" />\n\n        {/* W-2 specific fields */}\n        {form.type === 'w2' && (\n          <div style={{ padding: 12, borderRadius: 10, background: 'var(--bg-surface)', border: '1px solid var(--border-subtle)' }}>\n            <div style={{ fontSize: 11, color: 'var(--accent-blue)', fontWeight: 500, marginBottom: 10 }}>W-2 Details</div>\n            <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>\n              <PanelInput label=\"Employer Name\" value={form.w2?.employerName || ''} onChange={v => upd({ w2: { ...form.w2, employerName: v } })} placeholder=\"Company\" />\n              <PanelInput label=\"Gross Salary\" value={form.w2?.grossSalary || ''} onChange={v => upd({ w2: { ...form.w2, grossSalary: Number(v) } })} type=\"number\" placeholder=\"Total comp before deductions\" />\n              <div style={{ display: 'flex', gap: 8 }}>\n                <div style={{ flex: 1 }}><PanelInput label=\"Fed. Withheld\" value={form.w2?.federalWithholding || ''} onChange={v => upd({ w2: { ...form.w2, federalWithholding: Number(v) } })} type=\"number\" placeholder=\"Box 2\" /></div>\n                <div style={{ flex: 1 }}><PanelInput label=\"State Withheld\" value={form.w2?.stateWithholding || ''} onChange={v => upd({ w2: { ...form.w2, stateWithholding: Number(v) } })} type=\"number\" placeholder=\"Box 17\" /></div>\n              </div>\n              <PanelInput label=\"FICA Withheld\" value={form.w2?.ficaWithheld || ''} onChange={v => upd({ w2: { ...form.w2, ficaWithheld: Number(v) } })} type=\"number\" placeholder={form.annualAmount ? `~${Math.round(form.annualAmount * 0.0765)}` : 'Box 4+6'} />\n              <div style={{ display: 'flex', gap: 8 }}>\n                <div style={{ flex: 1 }}><PanelInput label=\"401(k)\" value={form.w2?.pretax401k || ''} onChange={v => upd({ w2: { ...form.w2, pretax401k: Number(v) } })} type=\"number\" /></div>\n                <div style={{ flex: 1 }}><PanelInput label=\"Health Ins.\" value={form.w2?.pretaxHealthInsurance || ''} onChange={v => upd({ w2: { ...form.w2, pretaxHealthInsurance: Number(v) } })} type=\"number\" /></div>\n              </div>\n              <div style={{ display: 'flex', gap: 8 }}>\n                <div style={{ flex: 1 }}><PanelInput label=\"HSA\" value={form.w2?.pretaxHSA || ''} onChange={v => upd({ w2: { ...form.w2, pretaxHSA: Number(v) } })} type=\"number\" /></div>\n                <div style={{ flex: 1 }}><PanelInput label=\"Employer Match\" value={form.w2?.employerMatch401k || ''} onChange={v => upd({ w2: { ...form.w2, employerMatch401k: Number(v) } })} type=\"number\" /></div>\n              </div>\n            </div>\n            {form.annualAmount > 0 && (\n              <div style={{ marginTop: 8, fontSize: 10, color: 'var(--text-muted)', borderTop: '1px solid var(--border-subtle)', paddingTop: 6 }}>\n                Est. employer FICA: ~{fmt(Math.round(form.annualAmount * 0.0765))} · Your FICA: ~{fmt(form.w2?.ficaWithheld || Math.round(form.annualAmount * 0.0765))}\n              </div>\n            )}\n          </div>\n        )}\n\n        <div>\n          <label style={{ fontSize: 11, color: 'var(--text-muted)', display: 'block', marginBottom: 4 }}>Notes</label>\n          <textarea value={form.notes || ''} onChange={e => upd({ notes: e.target.value })} rows={3}\n            style={{ width: '100%', padding: '8px 12px', borderRadius: 8, resize: 'vertical', background: 'var(--bg-elevated)',\n              border: '1px solid var(--border-subtle)', color: 'var(--text-primary)', fontSize: 13, outline: 'none' }} />\n        </div>\n      </div>\n\n      <div style={{ fontSize: 11, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.08em', marginBottom: 8, fontWeight: 500 }}>Entity Assignment</div>\n      <div style={{ display: 'flex', flexDirection: 'column', gap: 4, marginBottom: 16 }}>\n        <EntityAssignBtn selected={!form.entityId} onClick={() => onAssign(undefined)} label=\"Personal / Unassigned\" icon={<User size={14} />} />\n        {entities.map(e => (\n          <EntityAssignBtn key={e.id} selected={form.entityId === e.id} onClick={() => onAssign(e.id)}\n            label={e.name || ENTITY_TYPE_LABELS[e.type]} sublabel={ENTITY_TYPE_LABELS[e.type]} icon={<Building2 size={14} />} />\n        ))}\n      </div>\n\n      {editing && (\n        <button onClick={() => onSave(form)} style={{ width: '100%', padding: '10px 16px', borderRadius: 8, border: 'none',\n          background: 'var(--accent-gold)', color: '#0c0e12', fontSize: 13, fontWeight: 600, cursor: 'pointer',\n          display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 6 }}><Check size={14} /> Save</button>\n      )}\n    </div>\n  )\n}\n\nfunction EntityAssignBtn({ selected, onClick, label, sublabel, icon }: {\n  selected: boolean; onClick: () => void; label: string; sublabel?: string; icon: React.ReactNode\n}) {\n  return (\n    <button onClick={onClick} style={{ display: 'flex', alignItems: 'center', gap: 8, padding: '8px 12px', borderRadius: 8,\n      border: `1px solid ${selected ? 'var(--accent-gold)' : 'var(--border-subtle)'}`,\n      background: selected ? 'var(--accent-gold-dim)' : 'var(--bg-elevated)',\n      cursor: 'pointer', color: 'var(--text-primary)', fontSize: 12, textAlign: 'left' as const }}>\n      {icon} <span style={{ flex: 1 }}>{label}</span>\n      {sublabel && <span style={{ fontSize: 10, color: 'var(--text-muted)' }}>{sublabel}</span>}\n      {selected && <Check size={14} color=\"var(--accent-gold)\" />}\n    </button>\n  )\n}\n\n// ─── Add Entity Panel ───────────────────────────────────────────────────\n\nfunction AddEntityPanel({ suggestedType, suggestedName, linkIncomeId, profileState, onAdd, onClose }: {\n  suggestedType?: string; suggestedName?: string; linkIncomeId?: string; profileState: string\n  onAdd: (entity: Omit<LegalEntity, 'id'>, linkIncomeId?: string) => void; onClose: () => void\n}) {\n  const costs: Record<string, number> = { sole_prop: 0, llc: 300, llc_scorp: 2500, scorp: 2500, ccorp: 3000, partnership: 500 }\n  const [form, setForm] = useState({\n    name: suggestedName || '', type: (suggestedType || 'llc') as LegalEntity['type'],\n    state: profileState || 'IL', einNumber: '', formationDate: '',\n    annualCost: costs[suggestedType || 'llc'] || 300, isActive: true,\n  })\n\n  return (\n    <div>\n      <PanelHeader title=\"New Entity\" onClose={onClose} />\n      <div style={{ display: 'flex', flexDirection: 'column', gap: 12, marginBottom: 20 }}>\n        <PanelInput label=\"Entity Name\" value={form.name} onChange={v => setForm(f => ({ ...f, name: v }))} placeholder=\"My Business LLC\" autoFocus />\n        <div>\n          <label style={{ fontSize: 11, color: 'var(--text-muted)', display: 'block', marginBottom: 4 }}>Entity Type</label>\n          <div style={{ display: 'flex', flexDirection: 'column', gap: 4 }}>\n            {ENTITY_TYPES.map(([v, l]) => (\n              <EntityAssignBtn key={v} selected={form.type === v} onClick={() => setForm(f => ({ ...f, type: v as any, annualCost: costs[v] || 300 }))}\n                label={l} icon={<Building2 size={14} color={form.type === v ? 'var(--accent-gold)' : 'var(--text-muted)'} />} />\n            ))}\n          </div>\n        </div>\n        <div style={{ display: 'flex', gap: 12 }}>\n          <div style={{ flex: 1 }}><PanelInput label=\"State\" value={form.state} onChange={v => setForm(f => ({ ...f, state: v.toUpperCase().slice(0, 2) }))} maxLength={2} /></div>\n          <div style={{ flex: 1 }}><PanelInput label=\"Est. Annual Cost\" value={form.annualCost} onChange={v => setForm(f => ({ ...f, annualCost: Number(v) }))} type=\"number\" /></div>\n        </div>\n      </div>\n      <button onClick={() => onAdd(form, linkIncomeId)}\n        style={{ width: '100%', padding: '12px 16px', borderRadius: 8, border: 'none', background: 'var(--accent-gold)', color: '#0c0e12',\n          fontSize: 14, fontWeight: 600, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8 }}>\n        <Plus size={16} /> Create Entity\n      </button>\n      {linkIncomeId && (\n        <div style={{ marginTop: 8, fontSize: 11, color: 'var(--accent-emerald)', textAlign: 'center' }}><Link2 size={11} /> Will auto-link income stream</div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\EntityOptimizer.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'calculateReasonableSalary' is defined but never used.","line":3,"column":53,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":78,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"calculateReasonableSalary"},"fix":{"range":[141,168],"text":""},"desc":"Remove unused variable \"calculateReasonableSalary\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'EntityScenario' is defined but never used.","line":3,"column":85,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":99,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"EntityScenario"},"fix":{"range":[168,189],"text":""},"desc":"Remove unused variable \"EntityScenario\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Award' is defined but never used.","line":5,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":19,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Award"},"fix":{"range":[246,253],"text":""},"desc":"Remove unused variable \"Award\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TrendingDown' is defined but never used.","line":5,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":33,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TrendingDown"},"fix":{"range":[253,267],"text":""},"desc":"Remove unused variable \"TrendingDown\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DollarSign' is defined but never used.","line":5,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":45,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DollarSign"},"fix":{"range":[267,279],"text":""},"desc":"Remove unused variable \"DollarSign\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ArrowRight' is defined but never used.","line":6,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":26,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ArrowRight"},"fix":{"range":[309,321],"text":""},"desc":"Remove unused variable \"ArrowRight\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'customSalary' is assigned a value but never used.","line":12,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'setCustomSalary' is assigned a value but never used.","line":12,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":39}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { optimizeEntities, analyzeIncomeThresholds, calculateReasonableSalary, type EntityScenario } from '../engine/entity-optimizer'\nimport {\n  Building2, Award, TrendingDown, DollarSign, AlertTriangle,\n  CheckCircle, ArrowRight, ChevronDown, ChevronUp, Scale, Sliders, Target\n} from 'lucide-react'\n\nexport function EntityOptimizer() {\n  const { state } = useFortuna()\n  const [selectedScenario, setSelectedScenario] = useState<string | null>(null)\n  const [customSalary, setCustomSalary] = useState<number | null>(null)\n  const [showThresholds, setShowThresholds] = useState(false)\n\n  const result = useMemo(() => optimizeEntities(state), [state])\n  const thresholds = useMemo(() => {\n    const seIncome = state.incomeStreams\n      .filter(s => ['business', 'freelance'].includes(s.type) && s.isActive)\n      .reduce((sum, s) => sum + s.annualAmount, 0)\n    const expenses = state.expenses.filter(e => e.isDeductible)\n      .reduce((sum, e) => sum + (e.annualAmount * e.deductionPct / 100), 0)\n    return analyzeIncomeThresholds(Math.max(0, seIncome - expenses), state.profile.state || 'IL')\n  }, [state])\n\n  const activeScenario = result.scenarios.find(s => s.id === selectedScenario) || result.recommended\n\n  const maxTaxBurden = Math.max(...result.scenarios.map(s => s.totalTaxBurden))\n\n  return (\n    <div style={{ padding: 32, maxWidth: 1100 }}>\n      {/* Header */}\n      <div style={{ marginBottom: 32 }}>\n        <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 8 }}>\n          <Building2 size={24} style={{ color: 'var(--accent-gold)' }} />\n          <h1 style={{ fontFamily: 'var(--font-display)', fontSize: 28, color: 'var(--text-primary)', margin: 0 }}>\n            Entity Optimizer\n          </h1>\n        </div>\n        <p style={{ color: 'var(--text-muted)', fontSize: 14, margin: 0 }}>\n          Automatically model optimal entity structures for your income mix\n        </p>\n      </div>\n\n      {/* Summary Banner */}\n      <div style={{\n        padding: 24, background: 'var(--bg-elevated)', borderRadius: 16,\n        border: '1px solid var(--border-subtle)', marginBottom: 24,\n      }}>\n        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', flexWrap: 'wrap', gap: 16 }}>\n          <div>\n            <div style={{ fontSize: 11, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.08em', marginBottom: 6 }}>\n              Optimizer Recommendation\n            </div>\n            <div style={{ fontSize: 20, fontWeight: 700, color: 'var(--text-primary)' }}>\n              {result.recommended.label}\n            </div>\n            <div style={{ fontSize: 13, color: 'var(--text-muted)', marginTop: 4, maxWidth: 500 }}>\n              {result.summary}\n            </div>\n          </div>\n\n          {result.maxSavings > 0 && (\n            <div style={{\n              textAlign: 'center', padding: '14px 24px', background: 'rgba(16,185,129,0.08)',\n              borderRadius: 14, border: '1px solid rgba(16,185,129,0.2)',\n            }}>\n              <div style={{ fontSize: 10, color: '#10b981', textTransform: 'uppercase', letterSpacing: '0.08em' }}>\n                Annual Savings\n              </div>\n              <div style={{ fontFamily: 'var(--font-mono)', fontSize: 28, fontWeight: 700, color: '#10b981' }}>\n                ${result.maxSavings.toLocaleString()}\n              </div>\n              <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>vs. sole proprietorship</div>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Scenario Comparison Cards */}\n      <div style={{ marginBottom: 32 }}>\n        <div style={{ fontSize: 15, fontWeight: 700, color: 'var(--text-primary)', marginBottom: 14, display: 'flex', alignItems: 'center', gap: 8 }}>\n          <Scale size={16} style={{ color: 'var(--accent-gold)' }} />\n          Structure Comparison\n        </div>\n\n        <div style={{ display: 'grid', gridTemplateColumns: `repeat(${Math.min(result.scenarios.length, 4)}, 1fr)`, gap: 12 }}>\n          {result.scenarios.map(scenario => {\n            const isSelected = activeScenario.id === scenario.id\n            const barWidth = maxTaxBurden > 0 ? (scenario.totalTaxBurden / maxTaxBurden) * 100 : 0\n            const barColor = scenario.isRecommended ? '#10b981' : isSelected ? 'var(--accent-gold)' : 'var(--text-muted)'\n\n            return (\n              <button\n                key={scenario.id}\n                onClick={() => setSelectedScenario(scenario.id)}\n                style={{\n                  textAlign: 'left', padding: 20, borderRadius: 14,\n                  border: `2px solid ${isSelected ? 'var(--accent-gold)' : scenario.isRecommended ? 'rgba(16,185,129,0.3)' : 'var(--border-subtle)'}`,\n                  background: isSelected ? 'var(--accent-gold-dim)' : 'var(--bg-elevated)',\n                  cursor: 'pointer', transition: 'all 0.2s', position: 'relative',\n                }}\n              >\n                {scenario.isRecommended && (\n                  <div style={{\n                    position: 'absolute', top: -8, right: 12,\n                    padding: '2px 10px', borderRadius: 6,\n                    background: '#10b981', color: '#fff',\n                    fontSize: 9, fontWeight: 700, letterSpacing: '0.08em',\n                  }}>\n                    RECOMMENDED\n                  </div>\n                )}\n\n                <div style={{ fontSize: 14, fontWeight: 700, color: 'var(--text-primary)', marginBottom: 4 }}>\n                  {scenario.label}\n                </div>\n                <div style={{ fontSize: 11, color: 'var(--text-muted)', lineHeight: 1.4, marginBottom: 14, minHeight: 30 }}>\n                  {scenario.description}\n                </div>\n\n                {/* Tax burden bar */}\n                <div style={{ marginBottom: 8 }}>\n                  <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 10, color: 'var(--text-muted)', marginBottom: 3 }}>\n                    <span>Total Tax Burden</span>\n                    <span style={{ fontFamily: 'var(--font-mono)', fontWeight: 600, color: barColor }}>\n                      ${scenario.totalTaxBurden.toLocaleString()}\n                    </span>\n                  </div>\n                  <div style={{ height: 6, background: 'var(--bg-primary)', borderRadius: 3 }}>\n                    <div style={{\n                      height: '100%', width: `${barWidth}%`, background: barColor,\n                      borderRadius: 3, transition: 'width 0.5s',\n                    }} />\n                  </div>\n                </div>\n\n                {/* Metrics */}\n                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 6, marginTop: 10 }}>\n                  <div>\n                    <div style={{ fontSize: 9, color: 'var(--text-muted)' }}>SE Tax</div>\n                    <div style={{ fontFamily: 'var(--font-mono)', fontSize: 13, fontWeight: 600, color: 'var(--text-secondary)' }}>\n                      ${scenario.totalSETax.toLocaleString()}\n                    </div>\n                  </div>\n                  <div>\n                    <div style={{ fontSize: 9, color: 'var(--text-muted)' }}>Compliance</div>\n                    <div style={{ fontFamily: 'var(--font-mono)', fontSize: 13, fontWeight: 600, color: 'var(--text-secondary)' }}>\n                      ${scenario.totalComplianceCost.toLocaleString()}/yr\n                    </div>\n                  </div>\n                </div>\n\n                {scenario.netSavings > 0 && (\n                  <div style={{\n                    marginTop: 10, padding: '4px 10px', borderRadius: 6,\n                    background: 'rgba(16,185,129,0.1)', fontSize: 12,\n                    color: '#10b981', fontWeight: 600, fontFamily: 'var(--font-mono)',\n                    display: 'inline-block',\n                  }}>\n                    ↓ Save ${scenario.netSavings.toLocaleString()}/yr\n                  </div>\n                )}\n              </button>\n            )\n          })}\n        </div>\n      </div>\n\n      {/* Active Scenario Detail */}\n      <div style={{\n        padding: 24, background: 'var(--bg-elevated)', borderRadius: 16,\n        border: '1px solid var(--border-subtle)', marginBottom: 24,\n      }}>\n        <div style={{ fontSize: 18, fontWeight: 700, color: 'var(--text-primary)', marginBottom: 6 }}>\n          {activeScenario.label}\n        </div>\n        <div style={{ fontSize: 13, color: 'var(--text-muted)', lineHeight: 1.6, marginBottom: 20 }}>\n          {activeScenario.reasoning}\n        </div>\n\n        {/* Entity breakdown */}\n        {activeScenario.entities.map((entity, i) => (\n          <div key={i} style={{\n            padding: 16, background: 'var(--bg-primary)', borderRadius: 12,\n            border: '1px solid var(--border-subtle)', marginBottom: 10,\n          }}>\n            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\n              <div>\n                <div style={{ fontSize: 14, fontWeight: 600, color: 'var(--text-primary)' }}>{entity.name}</div>\n                <div style={{ fontSize: 12, color: 'var(--text-muted)' }}>\n                  Allocated: ${entity.allocatedIncome.toLocaleString()}\n                </div>\n              </div>\n              {entity.reasonableSalary !== undefined && (\n                <div style={{ textAlign: 'right' }}>\n                  <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>Salary / Distributions</div>\n                  <div style={{ fontFamily: 'var(--font-mono)', fontSize: 13, fontWeight: 600, color: 'var(--text-secondary)' }}>\n                    ${entity.reasonableSalary.toLocaleString()} / ${(entity.distributions || 0).toLocaleString()}\n                  </div>\n                </div>\n              )}\n            </div>\n          </div>\n        ))}\n\n        {/* Pros & Cons */}\n        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 20, marginTop: 16 }}>\n          <div>\n            <div style={{ fontSize: 12, fontWeight: 700, color: '#10b981', marginBottom: 8 }}>Advantages</div>\n            {activeScenario.pros.map((p, i) => (\n              <div key={i} style={{ display: 'flex', gap: 8, marginBottom: 6, fontSize: 12, color: 'var(--text-secondary)' }}>\n                <CheckCircle size={14} style={{ color: '#10b981', flexShrink: 0, marginTop: 1 }} />\n                {p}\n              </div>\n            ))}\n          </div>\n          <div>\n            <div style={{ fontSize: 12, fontWeight: 700, color: '#f59e0b', marginBottom: 8 }}>Considerations</div>\n            {activeScenario.cons.map((c, i) => (\n              <div key={i} style={{ display: 'flex', gap: 8, marginBottom: 6, fontSize: 12, color: 'var(--text-secondary)' }}>\n                <AlertTriangle size={14} style={{ color: '#f59e0b', flexShrink: 0, marginTop: 1 }} />\n                {c}\n              </div>\n            ))}\n          </div>\n        </div>\n\n        {activeScenario.breakEvenMonths > 0 && activeScenario.breakEvenMonths < 999 && (\n          <div style={{\n            marginTop: 16, padding: '10px 16px', background: 'var(--bg-primary)',\n            borderRadius: 8, fontSize: 12, color: 'var(--text-muted)',\n            display: 'flex', alignItems: 'center', gap: 8,\n          }}>\n            <Target size={14} style={{ color: 'var(--accent-gold)' }} />\n            Break-even on formation costs in <strong style={{ color: 'var(--text-primary)' }}>\n            {activeScenario.breakEvenMonths} month{activeScenario.breakEvenMonths !== 1 ? 's' : ''}</strong>\n          </div>\n        )}\n      </div>\n\n      {/* Reasonable Salary Analysis */}\n      {result.salaryAnalysis && (\n        <div style={{\n          padding: 24, background: 'var(--bg-elevated)', borderRadius: 16,\n          border: '1px solid var(--border-subtle)', marginBottom: 24,\n        }}>\n          <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 16 }}>\n            <Sliders size={18} style={{ color: 'var(--accent-gold)' }} />\n            <div style={{ fontSize: 16, fontWeight: 700, color: 'var(--text-primary)' }}>\n              Reasonable Salary Analysis\n            </div>\n          </div>\n\n          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 16, marginBottom: 16 }}>\n            <div style={{ padding: 16, background: 'var(--bg-primary)', borderRadius: 12 }}>\n              <div style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase' }}>Recommended Salary</div>\n              <div style={{ fontFamily: 'var(--font-mono)', fontSize: 22, fontWeight: 700, color: 'var(--accent-gold)' }}>\n                ${result.salaryAnalysis.recommendedSalary.toLocaleString()}\n              </div>\n            </div>\n            <div style={{ padding: 16, background: 'var(--bg-primary)', borderRadius: 12 }}>\n              <div style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase' }}>Distributions</div>\n              <div style={{ fontFamily: 'var(--font-mono)', fontSize: 22, fontWeight: 700, color: '#10b981' }}>\n                ${result.salaryAnalysis.distributions.toLocaleString()}\n              </div>\n            </div>\n            <div style={{ padding: 16, background: 'var(--bg-primary)', borderRadius: 12 }}>\n              <div style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase' }}>SE Tax Savings</div>\n              <div style={{ fontFamily: 'var(--font-mono)', fontSize: 22, fontWeight: 700, color: '#3b82f6' }}>\n                ${result.salaryAnalysis.seTaxSavings.toLocaleString()}\n              </div>\n            </div>\n          </div>\n\n          {/* Salary range visualization */}\n          <div style={{ marginBottom: 12 }}>\n            <div style={{ fontSize: 12, color: 'var(--text-muted)', marginBottom: 6 }}>\n              Defensible Salary Range\n            </div>\n            <div style={{ position: 'relative', height: 32, background: 'var(--bg-primary)', borderRadius: 8 }}>\n              {/* Range bar */}\n              {(() => {\n                const max = result.salaryAnalysis!.income\n                const minPct = (result.salaryAnalysis!.salaryRange.min / max) * 100\n                const maxPct = (result.salaryAnalysis!.salaryRange.max / max) * 100\n                const recPct = (result.salaryAnalysis!.recommendedSalary / max) * 100\n                return (\n                  <>\n                    <div style={{\n                      position: 'absolute', left: `${minPct}%`, right: `${100 - maxPct}%`,\n                      top: 8, height: 16, background: 'rgba(59,130,246,0.15)', borderRadius: 6,\n                    }} />\n                    <div style={{\n                      position: 'absolute', left: `${recPct}%`, top: 4, width: 3, height: 24,\n                      background: 'var(--accent-gold)', borderRadius: 2, transform: 'translateX(-50%)',\n                    }} />\n                    <div style={{\n                      position: 'absolute', left: `${minPct}%`, top: 36, fontSize: 10,\n                      color: 'var(--text-muted)', fontFamily: 'var(--font-mono)',\n                    }}>\n                      ${result.salaryAnalysis!.salaryRange.min.toLocaleString()}\n                    </div>\n                    <div style={{\n                      position: 'absolute', left: `${maxPct}%`, top: 36, fontSize: 10,\n                      color: 'var(--text-muted)', fontFamily: 'var(--font-mono)', transform: 'translateX(-100%)',\n                    }}>\n                      ${result.salaryAnalysis!.salaryRange.max.toLocaleString()}\n                    </div>\n                  </>\n                )\n              })()}\n            </div>\n          </div>\n\n          <div style={{ marginTop: 24, fontSize: 12, color: 'var(--text-muted)', lineHeight: 1.5 }}>\n            {result.salaryAnalysis.methodology}\n          </div>\n\n          {/* Risk indicator */}\n          <div style={{\n            marginTop: 12, padding: '8px 14px', borderRadius: 8,\n            background: result.salaryAnalysis.riskLevel === 'low' ? 'rgba(16,185,129,0.06)' : result.salaryAnalysis.riskLevel === 'moderate' ? 'rgba(245,158,11,0.06)' : 'rgba(239,68,68,0.06)',\n            border: `1px solid ${result.salaryAnalysis.riskLevel === 'low' ? 'rgba(16,185,129,0.2)' : result.salaryAnalysis.riskLevel === 'moderate' ? 'rgba(245,158,11,0.2)' : 'rgba(239,68,68,0.2)'}`,\n            fontSize: 12,\n            color: result.salaryAnalysis.riskLevel === 'low' ? '#10b981' : result.salaryAnalysis.riskLevel === 'moderate' ? '#f59e0b' : '#ef4444',\n          }}>\n            {result.salaryAnalysis.riskLevel === 'low' ? '✓' : '⚠'} {result.salaryAnalysis.riskNotes}\n          </div>\n        </div>\n      )}\n\n      {/* Income Thresholds */}\n      <div style={{\n        padding: 24, background: 'var(--bg-elevated)', borderRadius: 16,\n        border: '1px solid var(--border-subtle)',\n      }}>\n        <button\n          onClick={() => setShowThresholds(!showThresholds)}\n          style={{\n            display: 'flex', alignItems: 'center', gap: 10, width: '100%',\n            background: 'transparent', border: 'none', cursor: 'pointer',\n            padding: 0,\n          }}\n        >\n          <Target size={18} style={{ color: 'var(--accent-gold)' }} />\n          <div style={{ fontSize: 16, fontWeight: 700, color: 'var(--text-primary)', flex: 1, textAlign: 'left' }}>\n            Income Thresholds & Milestones\n          </div>\n          {showThresholds ? <ChevronUp size={16} style={{ color: 'var(--text-muted)' }} /> : <ChevronDown size={16} style={{ color: 'var(--text-muted)' }} />}\n        </button>\n\n        {showThresholds && (\n          <div style={{ marginTop: 16 }}>\n            {/* Current income indicator */}\n            <div style={{\n              padding: '10px 16px', background: 'var(--accent-gold-dim)', borderRadius: 8,\n              fontSize: 12, color: 'var(--accent-gold)', fontWeight: 600, marginBottom: 16,\n            }}>\n              Your net SE income: ${thresholds.currentIncome.toLocaleString()}\n            </div>\n\n            {thresholds.thresholds.map((t, i) => (\n              <div key={i} style={{\n                display: 'flex', alignItems: 'center', gap: 14, padding: '12px 0',\n                borderBottom: i < thresholds.thresholds.length - 1 ? '1px solid var(--border-subtle)' : 'none',\n                opacity: t.reached ? 1 : 0.5,\n              }}>\n                <div style={{\n                  width: 28, height: 28, borderRadius: '50%',\n                  background: t.reached ? '#10b981' : 'var(--bg-primary)',\n                  color: t.reached ? '#fff' : 'var(--text-muted)',\n                  display: 'flex', alignItems: 'center', justifyContent: 'center',\n                  flexShrink: 0, border: t.reached ? 'none' : '2px solid var(--border-subtle)',\n                }}>\n                  {t.reached ? <CheckCircle size={14} /> : <div style={{ width: 6, height: 6, borderRadius: '50%', background: 'var(--text-muted)' }} />}\n                </div>\n\n                <div style={{ flex: 1 }}>\n                  <div style={{ fontSize: 13, fontWeight: 600, color: 'var(--text-primary)' }}>\n                    {t.label} — ${t.income.toLocaleString()}\n                  </div>\n                  <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>{t.description}</div>\n                </div>\n\n                {t.savings > 0 && (\n                  <div style={{\n                    fontFamily: 'var(--font-mono)', fontSize: 12, fontWeight: 600,\n                    color: t.reached ? '#10b981' : 'var(--text-muted)',\n                  }}>\n                    ${t.savings.toLocaleString()}/yr\n                  </div>\n                )}\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\ExecutionTimeline.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TimelineAction' is defined but never used.","line":3,"column":49,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":63,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TimelineAction"},"fix":{"range":[132,153],"text":""},"desc":"Remove unused variable \"TimelineAction\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AlertTriangle' is defined but never used.","line":5,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":33,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AlertTriangle"},"fix":{"range":[218,233],"text":""},"desc":"Remove unused variable \"AlertTriangle\"."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { generateTimeline, groupByQuarter, type TimelineAction } from '../engine/execution-timeline'\nimport {\n  Calendar, Clock, AlertTriangle, CheckCircle2, ChevronDown,\n  FileText, DollarSign, Building2, Shield, PiggyBank, Eye, Zap\n} from 'lucide-react'\n\nconst statusColors: Record<string, { bg: string; color: string; label: string }> = {\n  overdue: { bg: 'var(--accent-red-dim)', color: 'var(--accent-red)', label: 'Overdue' },\n  urgent: { bg: 'rgba(251,191,36,0.12)', color: 'var(--accent-amber)', label: 'Urgent' },\n  upcoming: { bg: 'var(--accent-blue-dim)', color: 'var(--accent-blue)', label: 'Upcoming' },\n  completed: { bg: 'var(--accent-emerald-dim)', color: 'var(--accent-emerald)', label: 'Completed' },\n}\n\nconst catIcons: Record<string, React.ReactNode> = {\n  tax: <DollarSign size={15} />,\n  entity: <Building2 size={15} />,\n  compliance: <FileText size={15} />,\n  retirement: <PiggyBank size={15} />,\n  deduction: <Eye size={15} />,\n  risk: <Shield size={15} />,\n  revenue: <Zap size={15} />,\n}\n\nexport function ExecutionTimeline() {\n  const { state } = useFortuna()\n  const [expanded, setExpanded] = useState<string | null>(null)\n  const [completedIds, setCompletedIds] = useState<Set<string>>(new Set())\n\n  const actions = useMemo(() => generateTimeline(state), [state])\n  const quarters = useMemo(() => groupByQuarter(actions), [actions])\n\n  const hasData = state.incomeStreams.length > 0\n\n  const toggleComplete = (id: string) => {\n    setCompletedIds(prev => {\n      const next = new Set(prev)\n      if (next.has(id)) next.delete(id)\n      else next.add(id)\n      return next\n    })\n  }\n\n  const urgentCount = actions.filter(a => a.status === 'urgent' || a.status === 'overdue').length\n  const totalImpact = actions.reduce((s, a) => s + a.estimatedImpact, 0)\n\n  if (!hasData) {\n    return (\n      <div className=\"view-enter\" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '50vh' }}>\n        <div style={{ textAlign: 'center', maxWidth: 400 }}>\n          <Calendar size={32} color=\"var(--accent-gold)\" style={{ marginBottom: 12 }} />\n          <h2 style={{ fontFamily: 'var(--font-display)', marginBottom: 8 }}>Execution Timeline</h2>\n          <p style={{ fontSize: 13, color: 'var(--text-muted)' }}>Add your financial data to generate a personalized execution plan with real deadlines.</p>\n        </div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"view-enter\">\n      <div style={{ marginBottom: 28 }}>\n        <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 4 }}>\n          <h1 className=\"section-title\">Execution Timeline</h1>\n          <span className=\"pill gold\"><Calendar size={11} /> Deadline-Aware</span>\n        </div>\n        <p className=\"section-subtitle\">Sequenced action plan with real IRS deadlines — strategies don't matter if you miss the filing window</p>\n      </div>\n\n      {/* Summary */}\n      <div className=\"grid-4 stagger\" style={{ marginBottom: 28 }}>\n        <div className=\"metric-card\" style={{ borderColor: urgentCount > 0 ? 'rgba(251,191,36,0.2)' : 'var(--border-subtle)' }}>\n          <span className=\"metric-label\">Urgent Actions</span>\n          <div className=\"metric-value\" style={{ color: urgentCount > 0 ? 'var(--accent-amber)' : 'var(--accent-emerald)' }}>{urgentCount}</div>\n          <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>{urgentCount > 0 ? 'Require immediate attention' : 'All clear'}</span>\n        </div>\n        <div className=\"metric-card\">\n          <span className=\"metric-label\">Total Actions</span>\n          <div className=\"metric-value\">{actions.length}</div>\n          <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>{completedIds.size} completed</span>\n        </div>\n        <div className=\"metric-card\">\n          <span className=\"metric-label\">Combined Impact</span>\n          <div className=\"metric-value\" style={{ color: 'var(--accent-emerald)' }}>${totalImpact.toLocaleString()}</div>\n          <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>Annual savings/optimization</span>\n        </div>\n        <div className=\"metric-card\">\n          <span className=\"metric-label\">Quarters Covered</span>\n          <div className=\"metric-value\" style={{ color: 'var(--accent-blue)' }}>{quarters.length}</div>\n          <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>{quarters[0]?.quarter} → {quarters[quarters.length - 1]?.quarter}</span>\n        </div>\n      </div>\n\n      {/* Quarter blocks */}\n      {quarters.map((quarter, qi) => (\n        <div key={quarter.quarter} style={{ marginBottom: 32 }}>\n          {/* Quarter header */}\n          <div style={{ display: 'flex', alignItems: 'center', gap: 16, marginBottom: 16 }}>\n            <div style={{\n              width: 48, height: 48, borderRadius: 12,\n              background: qi === 0 ? 'var(--accent-gold-dim)' : 'var(--bg-elevated)',\n              border: `1px solid ${qi === 0 ? 'rgba(212,168,67,0.2)' : 'var(--border-subtle)'}`,\n              display: 'flex', alignItems: 'center', justifyContent: 'center',\n              fontFamily: 'var(--font-mono)', fontSize: 14, fontWeight: 600,\n              color: qi === 0 ? 'var(--accent-gold)' : 'var(--text-secondary)',\n            }}>\n              {quarter.quarter.replace(' 20', \"'\").replace('Q', 'Q')}\n            </div>\n            <div>\n              <div style={{ fontSize: 16, fontWeight: 500 }}>{quarter.quarter}</div>\n              <div style={{ fontSize: 12, color: 'var(--text-muted)' }}>\n                {quarter.actions.length} action{quarter.actions.length !== 1 ? 's' : ''}\n                {quarter.totalImpact > 0 && <span> · <span style={{ color: 'var(--accent-emerald)' }}>${quarter.totalImpact.toLocaleString()} impact</span></span>}\n              </div>\n            </div>\n            {/* Timeline line */}\n            <div style={{ flex: 1, height: 1, background: 'var(--border-subtle)' }} />\n          </div>\n\n          {/* Actions */}\n          <div style={{ display: 'flex', flexDirection: 'column', gap: 10, paddingLeft: 24 }}>\n            {quarter.actions.map(action => {\n              const isCompleted = completedIds.has(action.id)\n              const isExpanded = expanded === action.id\n              const sc = isCompleted ? statusColors.completed : statusColors[action.status]\n\n              return (\n                <div key={action.id} className=\"card\" style={{\n                  opacity: isCompleted ? 0.6 : 1,\n                  borderColor: action.status === 'urgent' && !isCompleted ? 'rgba(251,191,36,0.2)' : action.status === 'overdue' && !isCompleted ? 'rgba(239,107,107,0.2)' : 'var(--border-subtle)',\n                }}>\n                  {/* Timeline dot */}\n                  <div style={{\n                    position: 'absolute', left: -36, top: 22,\n                    width: 12, height: 12, borderRadius: '50%',\n                    background: isCompleted ? 'var(--accent-emerald)' : sc.bg,\n                    border: `2px solid ${isCompleted ? 'var(--accent-emerald)' : sc.color}`,\n                  }} />\n\n                  <div onClick={() => setExpanded(isExpanded ? null : action.id)} style={{ padding: '16px 20px', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 14 }}>\n                    {/* Checkbox */}\n                    <button onClick={e => { e.stopPropagation(); toggleComplete(action.id) }}\n                      style={{\n                        width: 24, height: 24, borderRadius: 6,\n                        border: `2px solid ${isCompleted ? 'var(--accent-emerald)' : 'var(--border-medium)'}`,\n                        background: isCompleted ? 'var(--accent-emerald)' : 'transparent',\n                        display: 'flex', alignItems: 'center', justifyContent: 'center',\n                        cursor: 'pointer', flexShrink: 0,\n                      }}>\n                      {isCompleted && <CheckCircle2 size={14} color=\"#0c0e12\" />}\n                    </button>\n\n                    {/* Icon */}\n                    <div style={{\n                      width: 36, height: 36, borderRadius: 10,\n                      background: sc.bg,\n                      display: 'flex', alignItems: 'center', justifyContent: 'center',\n                      color: sc.color, flexShrink: 0,\n                    }}>\n                      {catIcons[action.category] || <Calendar size={15} />}\n                    </div>\n\n                    {/* Content */}\n                    <div style={{ flex: 1, minWidth: 0 }}>\n                      <div style={{ display: 'flex', alignItems: 'center', gap: 8, flexWrap: 'wrap' }}>\n                        <span style={{ fontSize: 14, fontWeight: 500, textDecoration: isCompleted ? 'line-through' : 'none' }}>{action.title}</span>\n                        <span className=\"pill\" style={{ background: sc.bg, color: sc.color, borderColor: 'transparent', fontSize: 10 }}>{isCompleted ? 'Done' : sc.label}</span>\n                        {action.irsForm && <span className=\"pill gold\" style={{ fontSize: 10 }}>{action.irsForm}</span>}\n                      </div>\n                      <div style={{ fontSize: 12, color: 'var(--text-muted)', marginTop: 2 }}>\n                        <Clock size={11} style={{ display: 'inline', verticalAlign: 'middle', marginRight: 4 }} />\n                        {action.deadlineLabel}\n                        {action.daysUntilDeadline > 0 && !isCompleted && <span> · {action.daysUntilDeadline} days remaining</span>}\n                        {action.daysUntilDeadline < 0 && !isCompleted && <span style={{ color: 'var(--accent-red)' }}> · {Math.abs(action.daysUntilDeadline)} days overdue</span>}\n                      </div>\n                    </div>\n\n                    {/* Impact */}\n                    <div style={{ textAlign: 'right', flexShrink: 0 }}>\n                      <div style={{ fontFamily: 'var(--font-mono)', fontSize: 13, fontWeight: 500, color: action.estimatedImpact > 0 ? 'var(--accent-emerald)' : 'var(--text-muted)' }}>\n                        {action.impactLabel}\n                      </div>\n                    </div>\n\n                    <ChevronDown size={14} color=\"var(--text-muted)\" style={{ transition: 'transform 0.2s', transform: isExpanded ? 'rotate(180deg)' : '', flexShrink: 0 }} />\n                  </div>\n\n                  {isExpanded && (\n                    <div style={{ padding: '0 20px 20px 74px', borderTop: '1px solid var(--border-subtle)', paddingTop: 16 }}>\n                      <p style={{ fontSize: 13, color: 'var(--text-secondary)', lineHeight: 1.6, marginBottom: 16 }}>{action.description}</p>\n                      <div style={{ fontSize: 12, fontWeight: 500, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 10 }}>Steps</div>\n                      {action.steps.map((step, i) => (\n                        <div key={i} style={{ display: 'flex', gap: 10, marginBottom: 8, alignItems: 'flex-start' }}>\n                          <div style={{\n                            width: 20, height: 20, borderRadius: 5, flexShrink: 0,\n                            background: 'var(--bg-surface)', border: '1px solid var(--border-subtle)',\n                            display: 'flex', alignItems: 'center', justifyContent: 'center',\n                            fontSize: 10, fontFamily: 'var(--font-mono)', color: 'var(--text-muted)',\n                          }}>{i + 1}</div>\n                          <span style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.5 }}>{step}</span>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </div>\n              )\n            })}\n          </div>\n        </div>\n      ))}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\FinTechConnections.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'SyncResult' is defined but never used.","line":19,"column":53,"nodeType":"Identifier","messageId":"unusedVar","endLine":19,"endColumn":63,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"SyncResult"},"fix":{"range":[667,684],"text":""},"desc":"Remove unused variable \"SyncResult\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":31,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1225,1228],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1225,1228],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'setSelectedProvider' is assigned a value but never used.","line":34,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":34,"endColumn":47},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":39,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1624,1627],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1624,1627],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'updateState'. Either include it or remove the dependency array.","line":40,"column":6,"nodeType":"ArrayExpression","endLine":40,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [managerState, updateState]","fix":{"range":[1686,1700],"text":"[managerState, updateState]"}}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — FinTech Connections View\n *\n * Self-service bank connection management:\n *   - Search & connect institutions (Plaid Link / Unit SDK style)\n *   - Connection status cards with health indicators\n *   - Account overview with balances + tax relevance\n *   - Sync controls (manual + auto scheduling)\n *   - Net worth snapshot across all connected accounts\n *   - Provider configuration (API keys)\n *\n * @module FinTechConnections\n */\n\nimport { useState, useCallback, useEffect, useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport {\n  searchInstitutions, POPULAR_INSTITUTIONS,\n  type InstitutionInfo, type ConnectionRecord, type SyncResult,\n  type ConnectionManagerState, DEFAULT_MANAGER_STATE,\n} from '../engine/fintech-manager'\nimport type { FinTechAccount, FinTechProvider } from '../engine/fintech-models'\n\ntype Phase = 'overview' | 'search' | 'connecting' | 'provider_config'\n\nexport default function FinTechConnections() {\n  const { state, updateState } = useFortuna()\n  const [phase, setPhase] = useState<Phase>('overview')\n  const [searchQuery, setSearchQuery] = useState('')\n  const [managerState, setManagerState] = useState<ConnectionManagerState>(\n    () => (state as any).fintechConnections || DEFAULT_MANAGER_STATE,\n  )\n  const [syncingId, setSyncingId] = useState<string | null>(null)\n  const [selectedProvider, setSelectedProvider] = useState<FinTechProvider>('plaid')\n  const [notification, setNotification] = useState<{ type: 'success' | 'error'; message: string } | null>(null)\n\n  // Persist manager state to Fortuna\n  useEffect(() => {\n    updateState((prev: any) => ({ ...prev, fintechConnections: managerState }))\n  }, [managerState])\n\n  // Search results\n  const searchResults = useMemo(() => searchInstitutions(searchQuery, 12), [searchQuery])\n\n  // Aggregate stats\n  const stats = useMemo(() => {\n    const accounts = managerState.connections.flatMap(c => c.accounts || [])\n    let totalBalance = 0, totalDebt = 0\n    const byType: Record<string, { count: number; balance: number }> = {}\n\n    for (const a of accounts) {\n      const bal = a.balances?.current || 0\n      const t = a.type\n      if (!byType[t]) byType[t] = { count: 0, balance: 0 }\n      byType[t].count++\n      byType[t].balance += bal\n      if (t === 'loan' || t === 'credit') totalDebt += Math.abs(bal)\n      else totalBalance += bal\n    }\n\n    return { totalAccounts: accounts.length, totalBalance, totalDebt, netWorth: totalBalance - totalDebt, byType }\n  }, [managerState.connections])\n\n  // ── Handlers ──────────────────────────────────────────────────────────\n\n  const handleConnectInstitution = useCallback((inst: InstitutionInfo) => {\n    // Simulate Plaid Link / provider SDK flow\n    // In production, this would open the provider's frontend SDK (Plaid Link, etc.)\n    setPhase('connecting')\n    const timer = setTimeout(() => {\n      const connId = `conn_${Date.now()}_${Math.random().toString(36).substring(2, 6)}`\n      const newRecord: ConnectionRecord = {\n        connection: {\n          id: connId,\n          provider: selectedProvider,\n          institutionId: inst.id,\n          institutionName: inst.name,\n          status: 'active',\n          lastSuccessfulSync: new Date().toISOString(),\n          accountIds: [],\n          capabilities: ['accounts', 'transactions', 'balance'],\n          createdAt: new Date().toISOString(),\n          updatedAt: new Date().toISOString(),\n        },\n        accessToken: `access_${connId}`,\n        accounts: generateMockAccounts(inst, connId),\n      }\n\n      setManagerState(prev => ({\n        ...prev,\n        connections: [...prev.connections, newRecord],\n      }))\n      setNotification({ type: 'success', message: `Connected to ${inst.name}` })\n      setPhase('overview')\n      setSearchQuery('')\n    }, 1500)\n    return () => clearTimeout(timer)\n  }, [selectedProvider])\n\n  const handleRemoveConnection = useCallback((connId: string) => {\n    setManagerState(prev => ({\n      ...prev,\n      connections: prev.connections.filter(c => c.connection.id !== connId),\n    }))\n    setNotification({ type: 'success', message: 'Connection removed' })\n  }, [])\n\n  const handleSync = useCallback(async (connId: string) => {\n    setSyncingId(connId)\n    // Simulate sync\n    await new Promise(r => setTimeout(r, 1200))\n    setManagerState(prev => ({\n      ...prev,\n      connections: prev.connections.map(c =>\n        c.connection.id === connId\n          ? {\n              ...c,\n              connection: { ...c.connection, lastSuccessfulSync: new Date().toISOString(), status: 'active' as const },\n              lastSyncResult: { timestamp: new Date().toISOString(), transactionsAdded: Math.floor(Math.random() * 20), transactionsModified: 0, transactionsRemoved: 0, errors: [], durationMs: 1200 },\n            }\n          : c,\n      ),\n    }))\n    setSyncingId(null)\n    setNotification({ type: 'success', message: 'Sync complete' })\n  }, [])\n\n  const handleSyncAll = useCallback(async () => {\n    setSyncingId('all')\n    await new Promise(r => setTimeout(r, 2000))\n    setManagerState(prev => ({\n      ...prev,\n      lastGlobalSync: new Date().toISOString(),\n      connections: prev.connections.map(c => ({\n        ...c,\n        connection: { ...c.connection, lastSuccessfulSync: new Date().toISOString(), status: 'active' as const },\n      })),\n    }))\n    setSyncingId(null)\n    setNotification({ type: 'success', message: 'All connections synced' })\n  }, [])\n\n  // ── Styles ────────────────────────────────────────────────────────────\n\n  const card: React.CSSProperties = { background: '#1a1a2e', borderRadius: 12, border: '1px solid #2a2a4a', padding: 20 }\n  const statBox: React.CSSProperties = { ...card, textAlign: 'center', padding: 16 }\n  const btn = (color: string, small = false): React.CSSProperties => ({\n    background: color, color: '#fff', border: 'none', borderRadius: 8,\n    padding: small ? '6px 12px' : '10px 18px', cursor: 'pointer',\n    fontSize: small ? 12 : 14, fontWeight: 600, transition: 'opacity 0.15s',\n  })\n  const badge = (color: string): React.CSSProperties => ({\n    display: 'inline-block', padding: '3px 8px', borderRadius: 12,\n    fontSize: 11, fontWeight: 600, color: '#fff', background: color,\n  })\n  const statusColor = (s: string) =>\n    s === 'active' ? '#22c55e' : s === 'degraded' ? '#f59e0b' : s === 'pending_reauth' ? '#f59e0b' : '#ef4444'\n\n  // ── Clear notification ────────────────────────────────────────────────\n\n  useEffect(() => {\n    if (notification) {\n      const t = setTimeout(() => setNotification(null), 3000)\n      return () => clearTimeout(t)\n    }\n  }, [notification])\n\n  // ── Render ────────────────────────────────────────────────────────────\n\n  return (\n    <div style={{ maxWidth: 960, margin: '0 auto', padding: 24, color: '#e5e7eb' }}>\n      {/* Header */}\n      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24 }}>\n        <div>\n          <h2 style={{ margin: 0, fontSize: 22, color: '#fff' }}>Connected Accounts</h2>\n          <p style={{ margin: '4px 0 0', fontSize: 13, color: '#9ca3af' }}>\n            Link your bank accounts, credit cards, and investments for automatic tax categorization\n          </p>\n        </div>\n        <div style={{ display: 'flex', gap: 8 }}>\n          {managerState.connections.length > 0 && (\n            <button style={btn('#3b82f6', true)} onClick={handleSyncAll} disabled={syncingId === 'all'}>\n              {syncingId === 'all' ? '⟳ Syncing...' : '⟳ Sync All'}\n            </button>\n          )}\n          <button style={btn('#6366f1')} onClick={() => setPhase('search')}>+ Connect Account</button>\n        </div>\n      </div>\n\n      {/* Notification */}\n      {notification && (\n        <div style={{\n          padding: '10px 16px', borderRadius: 8, marginBottom: 16, fontSize: 13, fontWeight: 500,\n          background: notification.type === 'success' ? 'rgba(34,197,94,0.15)' : 'rgba(239,68,68,0.15)',\n          color: notification.type === 'success' ? '#22c55e' : '#ef4444',\n          border: `1px solid ${notification.type === 'success' ? '#22c55e33' : '#ef444433'}`,\n        }}>\n          {notification.message}\n        </div>\n      )}\n\n      {/* Search / Connect Phase */}\n      {phase === 'search' && (\n        <div style={{ ...card, marginBottom: 24 }}>\n          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>\n            <h3 style={{ margin: 0, fontSize: 16, color: '#fff' }}>Connect Your Financial Institution</h3>\n            <button style={{ ...btn('#ef4444', true), opacity: 0.8 }} onClick={() => { setPhase('overview'); setSearchQuery('') }}>✕ Cancel</button>\n          </div>\n\n          <input\n            type=\"text\"\n            value={searchQuery}\n            onChange={e => setSearchQuery(e.target.value)}\n            placeholder=\"Search banks, credit unions, brokerages...\"\n            style={{\n              width: '100%', padding: '12px 16px', borderRadius: 8, border: '1px solid #4a4a6a',\n              background: '#0d0d1a', color: '#e5e7eb', fontSize: 15, marginBottom: 16,\n              outline: 'none', boxSizing: 'border-box',\n            }}\n            autoFocus\n          />\n\n          {!searchQuery && (\n            <p style={{ fontSize: 12, color: '#6b7280', marginBottom: 12 }}>Popular institutions</p>\n          )}\n\n          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: 10 }}>\n            {searchResults.map(inst => (\n              <button\n                key={inst.id}\n                onClick={() => handleConnectInstitution(inst)}\n                style={{\n                  display: 'flex', alignItems: 'center', gap: 10, padding: '12px 14px',\n                  background: '#0d0d1a', border: '1px solid #2a2a4a', borderRadius: 10,\n                  color: '#e5e7eb', cursor: 'pointer', transition: 'border-color 0.15s',\n                  textAlign: 'left', fontSize: 14,\n                }}\n                onMouseEnter={e => (e.currentTarget.style.borderColor = inst.primaryColor || '#6366f1')}\n                onMouseLeave={e => (e.currentTarget.style.borderColor = '#2a2a4a')}\n              >\n                <div style={{\n                  width: 32, height: 32, borderRadius: 8, background: inst.primaryColor || '#333',\n                  display: 'flex', alignItems: 'center', justifyContent: 'center',\n                  color: '#fff', fontWeight: 700, fontSize: 14, flexShrink: 0,\n                }}>\n                  {inst.name.charAt(0)}\n                </div>\n                <span style={{ fontWeight: 500 }}>{inst.name}</span>\n              </button>\n            ))}\n          </div>\n\n          {searchResults.length === 0 && searchQuery && (\n            <p style={{ color: '#6b7280', fontSize: 13, textAlign: 'center', padding: 20 }}>\n              No institutions found for \"{searchQuery}\". Try a different search term.\n            </p>\n          )}\n        </div>\n      )}\n\n      {/* Connecting Phase */}\n      {phase === 'connecting' && (\n        <div style={{ ...card, textAlign: 'center', padding: 48, marginBottom: 24 }}>\n          <div style={{ fontSize: 36, marginBottom: 12 }}>🔗</div>\n          <p style={{ fontSize: 16, color: '#fff', fontWeight: 500 }}>Connecting to your institution...</p>\n          <p style={{ fontSize: 13, color: '#9ca3af' }}>Securely establishing connection via {selectedProvider.toUpperCase()}</p>\n          <div style={{ marginTop: 16 }}>\n            <div style={{ width: 200, height: 4, background: '#2a2a4a', borderRadius: 4, margin: '0 auto', overflow: 'hidden' }}>\n              <div style={{\n                width: '60%', height: '100%', background: '#6366f1', borderRadius: 4,\n                animation: 'pulse 1.5s ease-in-out infinite',\n              }} />\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Net Worth Summary */}\n      {managerState.connections.length > 0 && phase === 'overview' && (\n        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 12, marginBottom: 24 }}>\n          <div style={statBox}>\n            <div style={{ fontSize: 11, color: '#9ca3af', textTransform: 'uppercase', letterSpacing: 1 }}>Net Worth</div>\n            <div style={{ fontSize: 22, fontWeight: 700, color: stats.netWorth >= 0 ? '#22c55e' : '#ef4444', marginTop: 4 }}>\n              ${Math.abs(stats.netWorth).toLocaleString(undefined, { maximumFractionDigits: 0 })}\n            </div>\n          </div>\n          <div style={statBox}>\n            <div style={{ fontSize: 11, color: '#9ca3af', textTransform: 'uppercase', letterSpacing: 1 }}>Assets</div>\n            <div style={{ fontSize: 22, fontWeight: 700, color: '#22c55e', marginTop: 4 }}>\n              ${stats.totalBalance.toLocaleString(undefined, { maximumFractionDigits: 0 })}\n            </div>\n          </div>\n          <div style={statBox}>\n            <div style={{ fontSize: 11, color: '#9ca3af', textTransform: 'uppercase', letterSpacing: 1 }}>Liabilities</div>\n            <div style={{ fontSize: 22, fontWeight: 700, color: '#ef4444', marginTop: 4 }}>\n              ${stats.totalDebt.toLocaleString(undefined, { maximumFractionDigits: 0 })}\n            </div>\n          </div>\n          <div style={statBox}>\n            <div style={{ fontSize: 11, color: '#9ca3af', textTransform: 'uppercase', letterSpacing: 1 }}>Accounts</div>\n            <div style={{ fontSize: 22, fontWeight: 700, color: '#e5e7eb', marginTop: 4 }}>{stats.totalAccounts}</div>\n          </div>\n        </div>\n      )}\n\n      {/* Connection Cards */}\n      {phase === 'overview' && managerState.connections.map(record => (\n        <div key={record.connection.id} style={{ ...card, marginBottom: 16 }}>\n          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>\n            <div style={{ display: 'flex', gap: 12, alignItems: 'center' }}>\n              <div style={{\n                width: 40, height: 40, borderRadius: 10, background: getInstColor(record.connection.institutionName),\n                display: 'flex', alignItems: 'center', justifyContent: 'center',\n                color: '#fff', fontWeight: 700, fontSize: 18,\n              }}>\n                {record.connection.institutionName.charAt(0)}\n              </div>\n              <div>\n                <div style={{ fontSize: 16, fontWeight: 600, color: '#fff' }}>{record.connection.institutionName}</div>\n                <div style={{ display: 'flex', gap: 8, alignItems: 'center', marginTop: 2 }}>\n                  <span style={badge(statusColor(record.connection.status))}>\n                    {record.connection.status === 'active' ? '● Connected' : record.connection.status}\n                  </span>\n                  <span style={{ fontSize: 11, color: '#6b7280' }}>\n                    via {record.connection.provider.toUpperCase()}\n                  </span>\n                  {record.connection.lastSuccessfulSync && (\n                    <span style={{ fontSize: 11, color: '#6b7280' }}>\n                      · Last sync: {new Date(record.connection.lastSuccessfulSync).toLocaleString()}\n                    </span>\n                  )}\n                </div>\n              </div>\n            </div>\n\n            <div style={{ display: 'flex', gap: 6 }}>\n              <button\n                style={btn('#3b82f6', true)}\n                onClick={() => handleSync(record.connection.id)}\n                disabled={syncingId === record.connection.id}\n              >\n                {syncingId === record.connection.id ? '⟳' : '⟳ Sync'}\n              </button>\n              <button style={btn('#ef4444', true)} onClick={() => handleRemoveConnection(record.connection.id)}>\n                Remove\n              </button>\n            </div>\n          </div>\n\n          {/* Accounts */}\n          {record.accounts.length > 0 && (\n            <div style={{ marginTop: 16, display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(220px, 1fr))', gap: 10 }}>\n              {record.accounts.map(acct => (\n                <div key={acct.id} style={{\n                  padding: '10px 14px', background: '#0d0d1a', borderRadius: 8, border: '1px solid #1a1a3e',\n                }}>\n                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\n                    <div>\n                      <div style={{ fontSize: 13, fontWeight: 500, color: '#e5e7eb' }}>{acct.name}</div>\n                      <div style={{ fontSize: 11, color: '#6b7280' }}>\n                        {acct.subtype?.replace(/_/g, ' ')} {acct.mask ? `···${acct.mask}` : ''}\n                      </div>\n                    </div>\n                    <div style={{ textAlign: 'right' }}>\n                      <div style={{\n                        fontSize: 15, fontWeight: 600,\n                        color: (acct.type === 'loan' || acct.type === 'credit') ? '#ef4444' : '#22c55e',\n                      }}>\n                        ${Math.abs(acct.balances?.current || 0).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                      </div>\n                      {acct.taxRelevance?.isTaxAdvantaged && (\n                        <span style={{ ...badge('#8b5cf6'), fontSize: 9 }}>TAX-ADV</span>\n                      )}\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n\n          {/* Last sync result */}\n          {record.lastSyncResult && (\n            <div style={{ marginTop: 10, fontSize: 11, color: '#6b7280', display: 'flex', gap: 12 }}>\n              <span>+{record.lastSyncResult.transactionsAdded} txns</span>\n              <span>{record.lastSyncResult.durationMs}ms</span>\n              {record.lastSyncResult.errors.length > 0 && (\n                <span style={{ color: '#ef4444' }}>{record.lastSyncResult.errors.length} errors</span>\n              )}\n            </div>\n          )}\n        </div>\n      ))}\n\n      {/* Empty State */}\n      {phase === 'overview' && managerState.connections.length === 0 && (\n        <div style={{ ...card, textAlign: 'center', padding: 48 }}>\n          <div style={{ fontSize: 48, marginBottom: 12 }}>🏦</div>\n          <h3 style={{ color: '#fff', margin: '0 0 8px' }}>No accounts connected yet</h3>\n          <p style={{ color: '#9ca3af', fontSize: 14, maxWidth: 400, margin: '0 auto 20px' }}>\n            Connect your bank accounts, credit cards, and investment accounts to automatically\n            import transactions and identify tax deductions.\n          </p>\n          <button style={btn('#6366f1')} onClick={() => setPhase('search')}>\n            Connect Your First Account\n          </button>\n\n          <div style={{ marginTop: 32, display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 16, textAlign: 'left' }}>\n            {[\n              { icon: '🔒', title: 'Bank-Level Security', desc: 'Your data is encrypted end-to-end. We never store your bank login credentials.' },\n              { icon: '🏷️', title: 'Auto Tax Categories', desc: 'Transactions are automatically categorized to the right Schedule C, A, or E line items.' },\n              { icon: '💰', title: 'Find Missed Deductions', desc: 'Our enrichment engine identifies deductible expenses you might be overlooking.' },\n            ].map((item, i) => (\n              <div key={i} style={{ padding: 16 }}>\n                <div style={{ fontSize: 24, marginBottom: 8 }}>{item.icon}</div>\n                <div style={{ fontSize: 13, fontWeight: 600, color: '#e5e7eb', marginBottom: 4 }}>{item.title}</div>\n                <div style={{ fontSize: 12, color: '#6b7280', lineHeight: 1.4 }}>{item.desc}</div>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {/* How It Works (bottom) */}\n      {phase === 'overview' && managerState.connections.length > 0 && (\n        <div style={{ ...card, marginTop: 16, background: '#0d0d1a' }}>\n          <h4 style={{ margin: '0 0 8px', fontSize: 13, color: '#9ca3af', textTransform: 'uppercase', letterSpacing: 1 }}>\n            Data Flow\n          </h4>\n          <div style={{ fontSize: 13, color: '#6b7280', lineHeight: 1.6 }}>\n            Bank → <span style={{ color: '#6366f1' }}>Plaid/Unit/MX</span> → Canonical Models → <span style={{ color: '#f59e0b' }}>Tax Enrichment</span> (MCC + merchant patterns + 100+ rules) → <span style={{ color: '#22c55e' }}>Fortuna Bridge</span> → Income Streams, Expenses, Investments, Liabilities → Tax Optimization Engine\n          </div>\n          <div style={{ fontSize: 12, color: '#4b5563', marginTop: 8 }}>\n            Supported: 11,000+ institutions · Transactions auto-categorized to IRS schedules · Deductions flagged with confidence scores · Recurring streams detected\n          </div>\n        </div>\n      )}\n    </div>\n  )\n}\n\n// ─── Mock Account Generator (for demo/sandbox) ───────────────────────────\n\nfunction generateMockAccounts(inst: InstitutionInfo, connectionId: string): FinTechAccount[] {\n  const accounts: FinTechAccount[] = []\n  const now = new Date().toISOString()\n\n  // Checking\n  accounts.push({\n    id: `acct_${Date.now()}_chk`, connectionId, provider: 'plaid' as FinTechProvider,\n    institutionName: inst.name, name: `${inst.name} Checking`, type: 'depository', subtype: 'checking',\n    mask: String(Math.floor(1000 + Math.random() * 9000)),\n    balances: { current: Math.round((5000 + Math.random() * 25000) * 100) / 100, available: null, limit: null, lastUpdated: now },\n    isoCurrencyCode: 'USD', taxRelevance: { isTaxAdvantaged: false, taxType: 'taxable', fortunaMapping: 'bank' },\n    providerAccountId: `plaid_${Date.now()}_1`, isActive: true, createdAt: now, updatedAt: now,\n  })\n\n  // Savings\n  accounts.push({\n    id: `acct_${Date.now()}_sav`, connectionId, provider: 'plaid' as FinTechProvider,\n    institutionName: inst.name, name: `${inst.name} Savings`, type: 'depository', subtype: 'savings',\n    mask: String(Math.floor(1000 + Math.random() * 9000)),\n    balances: { current: Math.round((10000 + Math.random() * 50000) * 100) / 100, available: null, limit: null, lastUpdated: now },\n    isoCurrencyCode: 'USD', taxRelevance: { isTaxAdvantaged: false, taxType: 'taxable', fortunaMapping: 'bank' },\n    providerAccountId: `plaid_${Date.now()}_2`, isActive: true, createdAt: now, updatedAt: now,\n  })\n\n  // Credit card (50% chance)\n  if (Math.random() > 0.5) {\n    accounts.push({\n      id: `acct_${Date.now()}_cc`, connectionId, provider: 'plaid' as FinTechProvider,\n      institutionName: inst.name, name: `${inst.name} Credit Card`, type: 'credit', subtype: 'credit_card',\n      mask: String(Math.floor(1000 + Math.random() * 9000)),\n      balances: { current: -Math.round((500 + Math.random() * 4000) * 100) / 100, available: null, limit: 15000, lastUpdated: now },\n      isoCurrencyCode: 'USD', taxRelevance: { isTaxAdvantaged: false, taxType: 'taxable', fortunaMapping: 'bank' },\n      providerAccountId: `plaid_${Date.now()}_3`, isActive: true, createdAt: now, updatedAt: now,\n    })\n  }\n\n  return accounts\n}\n\nfunction getInstColor(name: string): string {\n  const inst = POPULAR_INSTITUTIONS.find(i => i.name === name)\n  return inst?.primaryColor || '#4a4a6a'\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\FinTechHub.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useCallback' is defined but never used.","line":15,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":31,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useCallback"},"fix":{"range":[510,523],"text":""},"desc":"Remove unused variable \"useCallback\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'FinTechProvider' is defined but never used.","line":22,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":22,"endColumn":46,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"FinTechProvider"},"fix":{"range":[798,815],"text":""},"desc":"Remove unused variable \"FinTechProvider\"."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has an unnecessary dependency: 'accounts'. Either exclude it or remove the dependency array.","line":35,"column":58,"nodeType":"ArrayExpression","endLine":35,"endColumn":68,"suggestions":[{"desc":"Update the dependencies array to be: []","fix":{"range":[1380,1390],"text":"[]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has an unnecessary dependency: 'connections'. Either exclude it or remove the dependency array.","line":36,"column":55,"nodeType":"ArrayExpression","endLine":36,"endColumn":68,"suggestions":[{"desc":"Update the dependencies array to be: []","fix":{"range":[1446,1459],"text":"[]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":148,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":148,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6380,6383],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6380,6383],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":283,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":283,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12436,12439],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12436,12439],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'txns' logical expression could make the dependencies of useMemo Hook (at line 294) change on every render. To fix this, wrap the initialization of 'txns' in its own useMemo() Hook.","line":285,"column":9,"nodeType":"VariableDeclarator","endLine":285,"endColumn":51},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":289,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":289,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12729,12732],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12729,12732],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":289,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":289,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12737,12740],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12737,12740],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":290,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":290,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12858,12861],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12858,12861],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":291,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":291,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12937,12940],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12937,12940],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":292,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":292,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13019,13022],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13019,13022],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":321,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":321,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14308,14311],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14308,14311],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":351,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":351,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15550,15553],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15550,15553],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'txns' is assigned a value but never used.","line":353,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":353,"endColumn":13},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":356,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":356,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15774,15777],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15774,15777],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":356,"column":93,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":356,"endColumn":96,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15820,15823],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15820,15823],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":357,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":357,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15907,15910],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15907,15910],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":357,"column":97,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":357,"endColumn":100,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15954,15957],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15954,15957],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":16,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — FinTech Hub View\n *\n * Manages provider connections, displays aggregated financial data,\n * runs syncs, and shows tax enrichment analysis.\n *\n * Sections:\n *   1. Provider Connections — status, health, add/remove\n *   2. Linked Accounts — all accounts across providers with balances\n *   3. Transaction Feed — enriched with tax categories\n *   4. Tax Intelligence — deductible totals, category breakdown\n *   5. Sync Controls — manual sync, last sync time, errors\n */\n\nimport { useState, useCallback, useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport {\n  SUPPORTED_PROVIDERS, getConnections, getAllAccounts,\n  getAggregateBalances, getConnectionHealth,\n  type ConnectionHealth,\n} from '../engine/fintech-connections'\nimport type { FinTechAccount, FinTechProvider } from '../engine/fintech-models'\n\ntype Tab = 'connections' | 'accounts' | 'transactions' | 'tax' | 'providers'\n\nexport default function FinTechHub() {\n  const { state } = useFortuna()\n  const [tab, setTab] = useState<Tab>('connections')\n  const [selectedProvider, setSelectedProvider] = useState<string | null>(null)\n\n  // ─── Data ───────────────────────────────────────────────────────────\n\n  const connections = useMemo(() => getConnections(), [])\n  const accounts = useMemo(() => getAllAccounts(), [])\n  const balances = useMemo(() => getAggregateBalances(), [accounts])\n  const health = useMemo(() => getConnectionHealth(), [connections])\n\n  // ─── Styles ─────────────────────────────────────────────────────────\n\n  const card: React.CSSProperties = {\n    background: '#1a1a2e', borderRadius: 12, padding: 24,\n    border: '1px solid rgba(255,255,255,0.06)',\n  }\n  const badge = (color: string): React.CSSProperties => ({\n    display: 'inline-block', padding: '2px 8px', borderRadius: 6,\n    fontSize: 11, fontWeight: 600, background: `${color}20`, color,\n  })\n  const statBox: React.CSSProperties = {\n    background: 'rgba(255,255,255,0.03)', borderRadius: 8, padding: 16,\n    textAlign: 'center',\n  }\n  const tabStyle = (active: boolean): React.CSSProperties => ({\n    padding: '8px 16px', borderRadius: 8, cursor: 'pointer', fontSize: 13,\n    fontWeight: active ? 600 : 400, border: 'none',\n    background: active ? 'rgba(99,102,241,0.15)' : 'transparent',\n    color: active ? '#818cf8' : '#94a3b8',\n    transition: 'all 0.2s',\n  })\n\n  return (\n    <div style={{ padding: 24, maxWidth: 1200, margin: '0 auto' }}>\n      {/* Header */}\n      <div style={{ marginBottom: 24 }}>\n        <h2 style={{ margin: 0, fontSize: 22, color: '#f1f5f9' }}>\n          🔗 FinTech Integration Hub\n        </h2>\n        <p style={{ margin: '4px 0 0', fontSize: 13, color: '#64748b' }}>\n          Connect financial accounts via Plaid, Unit, MX, Stripe, and more. Auto-enriched with tax intelligence.\n        </p>\n      </div>\n\n      {/* Summary Cards */}\n      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: 12, marginBottom: 24 }}>\n        <div style={statBox}>\n          <div style={{ fontSize: 11, color: '#64748b', marginBottom: 4 }}>Connections</div>\n          <div style={{ fontSize: 22, fontWeight: 700, color: '#f1f5f9' }}>{connections.length}</div>\n          <div style={{ fontSize: 10, color: health.filter(h => h.needsReauth).length > 0 ? '#f59e0b' : '#22c55e' }}>\n            {health.filter(h => h.needsReauth).length > 0\n              ? `${health.filter(h => h.needsReauth).length} need attention`\n              : 'All healthy'}\n          </div>\n        </div>\n        <div style={statBox}>\n          <div style={{ fontSize: 11, color: '#64748b', marginBottom: 4 }}>Linked Accounts</div>\n          <div style={{ fontSize: 22, fontWeight: 700, color: '#f1f5f9' }}>{accounts.length}</div>\n          <div style={{ fontSize: 10, color: '#64748b' }}>\n            {Object.entries(balances.byType).map(([t, d]) => `${d.count} ${t}`).join(', ') || 'None yet'}\n          </div>\n        </div>\n        <div style={statBox}>\n          <div style={{ fontSize: 11, color: '#64748b', marginBottom: 4 }}>Total Assets</div>\n          <div style={{ fontSize: 22, fontWeight: 700, color: '#22c55e' }}>\n            ${balances.totalAssets.toLocaleString(undefined, { minimumFractionDigits: 0 })}\n          </div>\n        </div>\n        <div style={statBox}>\n          <div style={{ fontSize: 11, color: '#64748b', marginBottom: 4 }}>Total Liabilities</div>\n          <div style={{ fontSize: 22, fontWeight: 700, color: '#ef4444' }}>\n            ${balances.totalLiabilities.toLocaleString(undefined, { minimumFractionDigits: 0 })}\n          </div>\n        </div>\n        <div style={statBox}>\n          <div style={{ fontSize: 11, color: '#64748b', marginBottom: 4 }}>Net Worth</div>\n          <div style={{ fontSize: 22, fontWeight: 700, color: balances.netWorth >= 0 ? '#22c55e' : '#ef4444' }}>\n            ${balances.netWorth.toLocaleString(undefined, { minimumFractionDigits: 0 })}\n          </div>\n        </div>\n      </div>\n\n      {/* Tabs */}\n      <div style={{ display: 'flex', gap: 4, marginBottom: 20, flexWrap: 'wrap' }}>\n        {([\n          ['connections', '🔌 Connections'],\n          ['accounts', '🏦 Accounts'],\n          ['transactions', '📊 Transactions'],\n          ['tax', '💰 Tax Intelligence'],\n          ['providers', '🧩 Available Providers'],\n        ] as [Tab, string][]).map(([key, label]) => (\n          <button key={key} style={tabStyle(tab === key)} onClick={() => setTab(key)}>\n            {label}\n          </button>\n        ))}\n      </div>\n\n      {/* Tab Content */}\n      {tab === 'connections' && (\n        <ConnectionsTab health={health} connections={connections} card={card} badge={badge} />\n      )}\n      {tab === 'accounts' && (\n        <AccountsTab accounts={accounts} card={card} badge={badge} />\n      )}\n      {tab === 'transactions' && (\n        <TransactionsTab state={state} card={card} badge={badge} />\n      )}\n      {tab === 'tax' && (\n        <TaxIntelligenceTab state={state} card={card} badge={badge} />\n      )}\n      {tab === 'providers' && (\n        <ProvidersTab card={card} badge={badge} selectedProvider={selectedProvider} onSelect={setSelectedProvider} />\n      )}\n    </div>\n  )\n}\n\n// ─── Connections Tab ──────────────────────────────────────────────────────\n\nfunction ConnectionsTab({ health, connections, card, badge }: {\n  health: ConnectionHealth[]; connections: any[]; card: React.CSSProperties; badge: (c: string) => React.CSSProperties\n}) {\n  const statusColor: Record<string, string> = {\n    active: '#22c55e', degraded: '#f59e0b', disconnected: '#ef4444',\n    pending_reauth: '#f59e0b', error: '#ef4444',\n  }\n\n  if (connections.length === 0) {\n    return (\n      <div style={card}>\n        <div style={{ textAlign: 'center', padding: 40 }}>\n          <div style={{ fontSize: 48, marginBottom: 16 }}>🔌</div>\n          <h3 style={{ color: '#f1f5f9', margin: '0 0 8px' }}>No Connections Yet</h3>\n          <p style={{ color: '#64748b', fontSize: 13, maxWidth: 480, margin: '0 auto 20px' }}>\n            Connect your bank accounts, credit cards, investments, and loans to automatically\n            import transactions with tax-aware categorization. Supports Plaid, Unit, MX, Stripe, and more.\n          </p>\n          <div style={{ fontSize: 12, color: '#94a3b8', marginTop: 16 }}>\n            <strong>How to connect:</strong><br />\n            1. Register a provider in Settings → API Keys (Plaid client_id + secret)<br />\n            2. Use the SDK link component or call <code>createLinkToken()</code><br />\n            3. Exchange the public token to establish the connection<br />\n            4. Sync accounts + transactions with <code>syncConnection()</code>\n          </div>\n        </div>\n      </div>\n    )\n  }\n\n  return (\n    <div style={{ display: 'grid', gap: 12 }}>\n      {health.map(h => (\n        <div key={h.id} style={{ ...card, display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: 16 }}>\n          <div>\n            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n              <span style={{ fontSize: 15, fontWeight: 600, color: '#f1f5f9' }}>{h.institution || h.provider}</span>\n              <span style={badge(statusColor[h.status] || '#64748b')}>{h.status}</span>\n              <span style={badge('#6366f1')}>{h.provider}</span>\n            </div>\n            <div style={{ fontSize: 12, color: '#64748b', marginTop: 4 }}>\n              {h.accountCount} accounts • Last sync: {h.lastSync ? new Date(h.lastSync).toLocaleDateString() : 'Never'}\n              {h.staleDays > 7 && <span style={{ color: '#f59e0b' }}> • Stale ({h.staleDays}d)</span>}\n            </div>\n          </div>\n          <div style={{ display: 'flex', gap: 8 }}>\n            <button style={{ padding: '6px 12px', borderRadius: 6, border: '1px solid rgba(255,255,255,0.1)', background: 'transparent', color: '#94a3b8', cursor: 'pointer', fontSize: 12 }}>\n              Sync Now\n            </button>\n            {h.needsReauth && (\n              <button style={{ padding: '6px 12px', borderRadius: 6, border: 'none', background: '#f59e0b20', color: '#f59e0b', cursor: 'pointer', fontSize: 12, fontWeight: 600 }}>\n                Re-authenticate\n              </button>\n            )}\n          </div>\n        </div>\n      ))}\n    </div>\n  )\n}\n\n// ─── Accounts Tab ─────────────────────────────────────────────────────────\n\nfunction AccountsTab({ accounts, card, badge }: {\n  accounts: FinTechAccount[]; card: React.CSSProperties; badge: (c: string) => React.CSSProperties\n}) {\n  const typeColors: Record<string, string> = {\n    depository: '#22c55e', credit: '#ef4444', investment: '#6366f1', loan: '#f59e0b', other: '#64748b',\n  }\n\n  if (accounts.length === 0) {\n    return (\n      <div style={card}>\n        <p style={{ color: '#64748b', textAlign: 'center', padding: 20 }}>\n          No linked accounts. Connect a provider to see accounts here.\n        </p>\n      </div>\n    )\n  }\n\n  // Group by type\n  const grouped: Record<string, FinTechAccount[]> = {}\n  for (const acct of accounts) {\n    if (!grouped[acct.type]) grouped[acct.type] = []\n    grouped[acct.type].push(acct)\n  }\n\n  return (\n    <div style={{ display: 'grid', gap: 16 }}>\n      {Object.entries(grouped).map(([type, accts]) => (\n        <div key={type} style={card}>\n          <h3 style={{ color: typeColors[type] || '#f1f5f9', margin: '0 0 12px', fontSize: 14, textTransform: 'capitalize' }}>\n            {type} Accounts ({accts.length})\n          </h3>\n          {accts.map(acct => (\n            <div key={acct.id} style={{\n              display: 'flex', justifyContent: 'space-between', alignItems: 'center',\n              padding: '10px 0', borderBottom: '1px solid rgba(255,255,255,0.04)',\n            }}>\n              <div>\n                <div style={{ fontSize: 13, color: '#f1f5f9', fontWeight: 500 }}>\n                  {acct.officialName || acct.name}\n                  {acct.mask && <span style={{ color: '#64748b' }}> ····{acct.mask}</span>}\n                </div>\n                <div style={{ fontSize: 11, color: '#64748b', display: 'flex', gap: 6, marginTop: 2 }}>\n                  <span style={badge(typeColors[acct.type] || '#64748b')}>{acct.subtype}</span>\n                  {acct.taxRelevance.isTaxAdvantaged && (\n                    <span style={badge('#22c55e')}>Tax-Advantaged</span>\n                  )}\n                  <span style={{ color: '#475569' }}>{acct.institutionName}</span>\n                </div>\n              </div>\n              <div style={{ textAlign: 'right' }}>\n                <div style={{\n                  fontSize: 14, fontWeight: 600,\n                  color: (acct.balances.current || 0) >= 0 ? '#f1f5f9' : '#ef4444',\n                }}>\n                  ${Math.abs(acct.balances.current || 0).toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                </div>\n                {acct.balances.available != null && acct.balances.available !== acct.balances.current && (\n                  <div style={{ fontSize: 10, color: '#64748b' }}>\n                    Available: ${acct.balances.available.toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                  </div>\n                )}\n              </div>\n            </div>\n          ))}\n        </div>\n      ))}\n    </div>\n  )\n}\n\n// ─── Transactions Tab ─────────────────────────────────────────────────────\n\nfunction TransactionsTab({ state: fortunaState, card, badge }: {\n  state: any; card: React.CSSProperties; badge: (c: string) => React.CSSProperties\n}) {\n  const txns = fortunaState.bankTransactions || []\n  const [filter, setFilter] = useState<'all' | 'income' | 'expense' | 'deductible'>('all')\n\n  const filtered = useMemo(() => {\n    let result = [...txns].sort((a: any, b: any) => new Date(b.date).getTime() - new Date(a.date).getTime())\n    if (filter === 'income') result = result.filter((t: any) => t.amount > 0)\n    if (filter === 'expense') result = result.filter((t: any) => t.amount < 0)\n    if (filter === 'deductible') result = result.filter((t: any) => t.amount < 0) // Simplified\n    return result.slice(0, 100) // Show max 100\n  }, [txns, filter])\n\n  return (\n    <div style={card}>\n      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>\n        <h3 style={{ margin: 0, color: '#f1f5f9', fontSize: 14 }}>\n          Transactions ({txns.length})\n        </h3>\n        <div style={{ display: 'flex', gap: 4 }}>\n          {(['all', 'income', 'expense', 'deductible'] as const).map(f => (\n            <button key={f} onClick={() => setFilter(f)} style={{\n              padding: '4px 10px', borderRadius: 6, border: 'none', cursor: 'pointer', fontSize: 11,\n              background: filter === f ? 'rgba(99,102,241,0.15)' : 'transparent',\n              color: filter === f ? '#818cf8' : '#64748b',\n            }}>\n              {f.charAt(0).toUpperCase() + f.slice(1)}\n            </button>\n          ))}\n        </div>\n      </div>\n\n      {filtered.length === 0 ? (\n        <p style={{ color: '#64748b', textAlign: 'center', padding: 20, fontSize: 13 }}>\n          No transactions yet. Connect a provider and sync to see transactions enriched with tax categories.\n        </p>\n      ) : (\n        <div style={{ maxHeight: 500, overflowY: 'auto' }}>\n          {filtered.map((txn: any, i: number) => (\n            <div key={txn.id || i} style={{\n              display: 'flex', justifyContent: 'space-between', padding: '8px 0',\n              borderBottom: '1px solid rgba(255,255,255,0.03)',\n            }}>\n              <div>\n                <div style={{ fontSize: 13, color: '#e2e8f0' }}>{txn.description}</div>\n                <div style={{ fontSize: 11, color: '#64748b', display: 'flex', gap: 6, marginTop: 2 }}>\n                  <span>{txn.date}</span>\n                  {txn.category && <span style={badge('#6366f1')}>{txn.category}</span>}\n                  {txn.isReconciled && <span style={{ color: '#22c55e' }}>✓</span>}\n                </div>\n              </div>\n              <div style={{\n                fontSize: 13, fontWeight: 600, whiteSpace: 'nowrap',\n                color: txn.amount >= 0 ? '#22c55e' : '#ef4444',\n              }}>\n                {txn.amount >= 0 ? '+' : ''}{txn.amount.toLocaleString(undefined, { minimumFractionDigits: 2 })}\n              </div>\n            </div>\n          ))}\n        </div>\n      )}\n    </div>\n  )\n}\n\n// ─── Tax Intelligence Tab ─────────────────────────────────────────────────\n\nfunction TaxIntelligenceTab({ state: fortunaState, card, badge }: {\n  state: any; card: React.CSSProperties; badge: (c: string) => React.CSSProperties\n}) {\n  const txns = fortunaState.bankTransactions || []\n  const expenses = fortunaState.expenses || []\n\n  const totalDeductible = expenses.filter((e: any) => e.isDeductible).reduce((s: number, e: any) => s + (e.annualAmount || 0), 0)\n  const totalNonDeductible = expenses.filter((e: any) => !e.isDeductible).reduce((s: number, e: any) => s + (e.annualAmount || 0), 0)\n\n  // Category breakdown from expenses\n  const categories: Record<string, { amount: number; deductible: boolean; count: number }> = {}\n  for (const exp of expenses) {\n    const cat = exp.category || 'Other'\n    if (!categories[cat]) categories[cat] = { amount: 0, deductible: exp.isDeductible, count: 0 }\n    categories[cat].amount += exp.annualAmount || 0\n    categories[cat].count++\n  }\n  const sortedCategories = Object.entries(categories).sort((a, b) => b[1].amount - a[1].amount)\n\n  return (\n    <div style={{ display: 'grid', gap: 16 }}>\n      {/* Summary */}\n      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: 12 }}>\n        <div style={{ ...card, textAlign: 'center' }}>\n          <div style={{ fontSize: 11, color: '#64748b', marginBottom: 4 }}>Deductible Expenses</div>\n          <div style={{ fontSize: 24, fontWeight: 700, color: '#22c55e' }}>\n            ${totalDeductible.toLocaleString()}\n          </div>\n          <div style={{ fontSize: 10, color: '#64748b' }}>Schedule C / Schedule A eligible</div>\n        </div>\n        <div style={{ ...card, textAlign: 'center' }}>\n          <div style={{ fontSize: 11, color: '#64748b', marginBottom: 4 }}>Non-Deductible</div>\n          <div style={{ fontSize: 24, fontWeight: 700, color: '#94a3b8' }}>\n            ${totalNonDeductible.toLocaleString()}\n          </div>\n          <div style={{ fontSize: 10, color: '#64748b' }}>Personal / entertainment / non-qualifying</div>\n        </div>\n        <div style={{ ...card, textAlign: 'center' }}>\n          <div style={{ fontSize: 11, color: '#64748b', marginBottom: 4 }}>Est. Tax Savings</div>\n          <div style={{ fontSize: 24, fontWeight: 700, color: '#6366f1' }}>\n            ${Math.round(totalDeductible * 0.25).toLocaleString()}\n          </div>\n          <div style={{ fontSize: 10, color: '#64748b' }}>At ~25% effective rate</div>\n        </div>\n      </div>\n\n      {/* Category Breakdown */}\n      <div style={card}>\n        <h3 style={{ margin: '0 0 12px', color: '#f1f5f9', fontSize: 14 }}>\n          Expense Category Breakdown\n        </h3>\n        {sortedCategories.length === 0 ? (\n          <p style={{ color: '#64748b', fontSize: 13 }}>\n            No categorized expenses yet. Import transactions from a provider or QuickBooks to see tax analysis.\n          </p>\n        ) : (\n          sortedCategories.map(([cat, data]) => (\n            <div key={cat} style={{\n              display: 'flex', justifyContent: 'space-between', alignItems: 'center',\n              padding: '8px 0', borderBottom: '1px solid rgba(255,255,255,0.03)',\n            }}>\n              <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n                <span style={{ fontSize: 13, color: '#e2e8f0' }}>{cat}</span>\n                {data.deductible\n                  ? <span style={badge('#22c55e')}>✓ Deductible</span>\n                  : <span style={badge('#64748b')}>Non-deductible</span>\n                }\n                <span style={{ fontSize: 11, color: '#475569' }}>({data.count})</span>\n              </div>\n              <span style={{ fontSize: 13, fontWeight: 600, color: data.deductible ? '#22c55e' : '#94a3b8' }}>\n                ${data.amount.toLocaleString()}\n              </span>\n            </div>\n          ))\n        )}\n      </div>\n\n      {/* Enrichment Engine Info */}\n      <div style={card}>\n        <h3 style={{ margin: '0 0 8px', color: '#f1f5f9', fontSize: 14 }}>\n          🧠 Transaction Enrichment Engine\n        </h3>\n        <p style={{ color: '#94a3b8', fontSize: 12, margin: '0 0 12px' }}>\n          Every imported transaction runs through the enrichment pipeline:\n        </p>\n        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 }}>\n          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 8, padding: 12 }}>\n            <div style={{ fontSize: 12, fontWeight: 600, color: '#818cf8', marginBottom: 4 }}>\n              MCC Code Rules\n            </div>\n            <div style={{ fontSize: 11, color: '#64748b' }}>\n              40+ Merchant Category Codes mapped to tax categories (highest confidence)\n            </div>\n          </div>\n          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 8, padding: 12 }}>\n            <div style={{ fontSize: 12, fontWeight: 600, color: '#818cf8', marginBottom: 4 }}>\n              Merchant Name Patterns\n            </div>\n            <div style={{ fontSize: 11, color: '#64748b' }}>\n              60+ regex rules matching SaaS, travel, meals, professional services, tax payments\n            </div>\n          </div>\n          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 8, padding: 12 }}>\n            <div style={{ fontSize: 12, fontWeight: 600, color: '#818cf8', marginBottom: 4 }}>\n              Category Mapping\n            </div>\n            <div style={{ fontSize: 11, color: '#64748b' }}>\n              35+ personal finance categories mapped to Schedule C/E/A/B/D line items\n            </div>\n          </div>\n          <div style={{ background: 'rgba(255,255,255,0.02)', borderRadius: 8, padding: 12 }}>\n            <div style={{ fontSize: 12, fontWeight: 600, color: '#818cf8', marginBottom: 4 }}>\n              Tax Payment Detection\n            </div>\n            <div style={{ fontSize: 11, color: '#64748b' }}>\n              Auto-detects IRS, state tax, property tax, and payroll tax payments\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}\n\n// ─── Providers Tab ────────────────────────────────────────────────────────\n\nfunction ProvidersTab({ card, badge, selectedProvider, onSelect }: {\n  card: React.CSSProperties; badge: (c: string) => React.CSSProperties\n  selectedProvider: string | null; onSelect: (p: string | null) => void\n}) {\n  const typeColors: Record<string, string> = {\n    aggregation: '#6366f1', baas: '#22c55e', payments: '#f59e0b', identity: '#06b6d4', verification: '#a855f7',\n  }\n\n  return (\n    <div style={card}>\n      <h3 style={{ margin: '0 0 4px', color: '#f1f5f9', fontSize: 14 }}>Supported FinTech Providers</h3>\n      <p style={{ color: '#64748b', fontSize: 12, margin: '0 0 16px' }}>\n        Fortuna's adapter layer normalizes data from any provider into a unified schema with tax intelligence.\n      </p>\n\n      <div style={{ display: 'grid', gap: 8 }}>\n        {SUPPORTED_PROVIDERS.map(p => (\n          <div\n            key={p.provider}\n            onClick={() => onSelect(selectedProvider === p.provider ? null : p.provider)}\n            style={{\n              padding: 14, borderRadius: 8, cursor: 'pointer',\n              background: selectedProvider === p.provider ? 'rgba(99,102,241,0.08)' : 'rgba(255,255,255,0.02)',\n              border: selectedProvider === p.provider ? '1px solid rgba(99,102,241,0.3)' : '1px solid transparent',\n              transition: 'all 0.2s',\n            }}\n          >\n            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\n              <div>\n                <span style={{ fontSize: 14, fontWeight: 600, color: '#f1f5f9' }}>{p.name}</span>\n                <span style={{ ...badge(typeColors[p.type] || '#64748b'), marginLeft: 8 }}>{p.type}</span>\n                {p.sandboxAvailable && <span style={{ ...badge('#22c55e'), marginLeft: 4 }}>sandbox</span>}\n              </div>\n              <span style={{ fontSize: 11, color: '#475569' }}>{p.website.replace('https://', '')}</span>\n            </div>\n            <div style={{ fontSize: 12, color: '#94a3b8', marginTop: 4 }}>\n              {p.description}\n            </div>\n            {selectedProvider === p.provider && (\n              <div style={{ marginTop: 12, paddingTop: 12, borderTop: '1px solid rgba(255,255,255,0.06)' }}>\n                <div style={{ fontSize: 11, fontWeight: 600, color: '#818cf8', marginBottom: 6 }}>\n                  Capabilities:\n                </div>\n                <div style={{ display: 'flex', gap: 4, flexWrap: 'wrap' }}>\n                  {p.capabilities.map(c => (\n                    <span key={c} style={badge('#6366f1')}>{c}</span>\n                  ))}\n                </div>\n                <div style={{ marginTop: 12, fontSize: 11, color: '#64748b' }}>\n                  <strong>Integration:</strong> Register via <code>registerProvider({'{'} provider: '{p.provider}', clientId, secret, environment {'}'})</code>\n                </div>\n              </div>\n            )}\n          </div>\n        ))}\n      </div>\n\n      {/* Architecture diagram */}\n      <div style={{\n        marginTop: 20, padding: 16, background: 'rgba(255,255,255,0.02)',\n        borderRadius: 8, fontFamily: 'monospace', fontSize: 11, color: '#818cf8',\n        lineHeight: 1.6, whiteSpace: 'pre',\n      }}>\n{`  ┌───────────────┐    ┌──────────────────┐    ┌───────────────┐\n  │  Provider API  │───▶│  FinTech Adapter  │───▶│  Canonical     │\n  │  (Plaid/Unit)  │    │  (normalize)      │    │  Models        │\n  └───────────────┘    └──────────────────┘    └───────┬───────┘\n                                                        │\n  ┌───────────────┐    ┌──────────────────┐    ┌───────▼───────┐\n  │  FortunaState  │◀───│  FinTech Bridge   │◀───│  Enrichment   │\n  │  (tax engine)  │    │  (map to state)   │    │  Engine       │\n  └───────────────┘    └──────────────────┘    └───────────────┘`}\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\FinancialHistory.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useMemo' is defined but never used.","line":1,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":27,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useMemo"},"fix":{"range":[17,26],"text":""},"desc":"Remove unused variable \"useMemo\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BarChart3' is defined but never used.","line":6,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":32,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"BarChart3"},"fix":{"range":[272,283],"text":""},"desc":"Remove unused variable \"BarChart3\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ChevronDown' is defined but never used.","line":6,"column":44,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":55,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ChevronDown"},"fix":{"range":[293,306],"text":""},"desc":"Remove unused variable \"ChevronDown\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ChevronUp' is defined but never used.","line":6,"column":57,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":66,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ChevronUp"},"fix":{"range":[306,317],"text":""},"desc":"Remove unused variable \"ChevronUp\"."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport type { TrendLine, Milestone, StrategyEffect, Projection } from '../engine/history-engine'\nimport {\n  TrendingUp, TrendingDown, Minus, Camera, Clock, Zap,\n  Target, ArrowRight, BarChart3, Activity, ChevronDown, ChevronUp,\n} from 'lucide-react'\n\n// ===================================================================\n//  SPARKLINE SVG\n// ===================================================================\n\nfunction Sparkline({ points, color, height = 40, width = 180 }: {\n  points: { value: number }[]\n  color: string\n  height?: number\n  width?: number\n}) {\n  if (points.length < 2) return null\n  const values = points.map(p => p.value)\n  const min = Math.min(...values)\n  const max = Math.max(...values)\n  const range = max - min || 1\n\n  const pathPoints = values.map((v, i) => {\n    const x = (i / (values.length - 1)) * width\n    const y = height - ((v - min) / range) * (height - 4) - 2\n    return `${x},${y}`\n  })\n\n  const areaPath = `M0,${height} L${pathPoints.join(' L')} L${width},${height} Z`\n  const linePath = `M${pathPoints.join(' L')}`\n\n  return (\n    <svg width={width} height={height} style={{ display: 'block' }}>\n      <defs>\n        <linearGradient id={`grad-${color.replace(/[^a-z]/g, '')}`} x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n          <stop offset=\"0%\" stopColor={color} stopOpacity=\"0.2\" />\n          <stop offset=\"100%\" stopColor={color} stopOpacity=\"0\" />\n        </linearGradient>\n      </defs>\n      <path d={areaPath} fill={`url(#grad-${color.replace(/[^a-z]/g, '')})`} />\n      <path d={linePath} fill=\"none\" stroke={color} strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\n      {/* Current value dot */}\n      {values.length > 0 && (\n        <circle\n          cx={width}\n          cy={height - ((values[values.length - 1] - min) / range) * (height - 4) - 2}\n          r=\"3\"\n          fill={color}\n        />\n      )}\n    </svg>\n  )\n}\n\n// ===================================================================\n//  FORMAT HELPERS\n// ===================================================================\n\nfunction fmt(value: number, unit: string): string {\n  if (unit === '$') return '$' + Math.abs(value).toLocaleString(undefined, { maximumFractionDigits: 0 })\n  if (unit === '%') return value.toFixed(1) + '%'\n  if (unit === '#') return Math.round(value).toString()\n  return value.toFixed(0) + ' ' + unit\n}\n\nfunction fmtChange(value: number, unit: string): string {\n  const sign = value >= 0 ? '+' : ''\n  if (unit === '$') return sign + '$' + Math.abs(value).toLocaleString(undefined, { maximumFractionDigits: 0 })\n  if (unit === '%') return sign + value.toFixed(1) + 'pp'\n  return sign + value.toFixed(0)\n}\n\nfunction relativeTime(ts: string): string {\n  const diff = Date.now() - new Date(ts).getTime()\n  const mins = Math.floor(diff / 60000)\n  if (mins < 1) return 'just now'\n  if (mins < 60) return `${mins}m ago`\n  const hrs = Math.floor(mins / 60)\n  if (hrs < 24) return `${hrs}h ago`\n  const days = Math.floor(hrs / 24)\n  if (days < 30) return `${days}d ago`\n  const months = Math.floor(days / 30)\n  return `${months}mo ago`\n}\n\n// ===================================================================\n//  MAIN VIEW\n// ===================================================================\n\nexport function FinancialHistory() {\n  const { history, trends, strategyEffects, projections, milestones, takeManualSnapshot } = useFortuna()\n  const [activeTab, setActiveTab] = useState<'trends' | 'timeline' | 'effectiveness' | 'projections'>('trends')\n  const [expandedMilestone, setExpandedMilestone] = useState<string | null>(null)\n  const [snapshotNote, setSnapshotNote] = useState('')\n  const [showSnapshotInput, setShowSnapshotInput] = useState(false)\n\n  const snapshotCount = history.snapshots.length\n  const hasEnoughData = snapshotCount >= 2\n\n  // Styles\n  const card: React.CSSProperties = {\n    background: 'var(--bg-elevated)', border: '1px solid var(--border-subtle)',\n    borderRadius: 14, padding: 24,\n  }\n  const tabBtn = (active: boolean): React.CSSProperties => ({\n    padding: '8px 16px', borderRadius: 8, border: 'none',\n    background: active ? 'var(--accent-gold-dim)' : 'transparent',\n    color: active ? 'var(--accent-gold)' : 'var(--text-muted)',\n    cursor: 'pointer', fontFamily: 'var(--font-body)', fontSize: 13,\n    fontWeight: active ? 600 : 400, transition: 'all 0.2s',\n  })\n\n  return (\n    <div style={{ padding: '32px 40px', maxWidth: 1000 }}>\n      {/* Header */}\n      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 24 }}>\n        <div>\n          <h1 style={{ fontFamily: 'var(--font-display)', fontSize: 26, color: 'var(--text-primary)', marginBottom: 6 }}>\n            Financial History\n          </h1>\n          <p style={{ fontSize: 13, color: 'var(--text-muted)', lineHeight: 1.5 }}>\n            {snapshotCount} snapshot{snapshotCount !== 1 ? 's' : ''} recorded\n            {history.lastAutoSnapshot && ` · Last: ${relativeTime(history.lastAutoSnapshot)}`}\n          </p>\n        </div>\n        <div style={{ display: 'flex', gap: 8 }}>\n          {showSnapshotInput ? (\n            <div style={{ display: 'flex', gap: 6, alignItems: 'center' }}>\n              <input\n                type=\"text\"\n                placeholder=\"Snapshot note (optional)\"\n                value={snapshotNote}\n                onChange={e => setSnapshotNote(e.target.value)}\n                style={{\n                  padding: '8px 12px', borderRadius: 8, border: '1px solid var(--border-medium)',\n                  background: 'var(--bg-surface)', color: 'var(--text-primary)',\n                  fontFamily: 'var(--font-body)', fontSize: 13, width: 200,\n                }}\n                autoFocus\n                onKeyDown={e => {\n                  if (e.key === 'Enter') {\n                    takeManualSnapshot(snapshotNote || undefined)\n                    setSnapshotNote('')\n                    setShowSnapshotInput(false)\n                  }\n                }}\n              />\n              <button\n                onClick={() => {\n                  takeManualSnapshot(snapshotNote || undefined)\n                  setSnapshotNote('')\n                  setShowSnapshotInput(false)\n                }}\n                style={{\n                  padding: '8px 14px', borderRadius: 8, border: 'none',\n                  background: 'var(--accent-emerald)', color: '#0c0e12',\n                  cursor: 'pointer', fontFamily: 'var(--font-body)', fontSize: 13, fontWeight: 600,\n                }}\n              >\n                Save\n              </button>\n            </div>\n          ) : (\n            <button\n              onClick={() => setShowSnapshotInput(true)}\n              style={{\n                display: 'flex', alignItems: 'center', gap: 6,\n                padding: '8px 16px', borderRadius: 8, border: '1px solid var(--accent-gold)33',\n                background: 'var(--accent-gold-dim)', color: 'var(--accent-gold)',\n                cursor: 'pointer', fontFamily: 'var(--font-body)', fontSize: 13, fontWeight: 500,\n              }}\n            >\n              <Camera size={14} /> Take Snapshot\n            </button>\n          )}\n        </div>\n      </div>\n\n      {/* Empty state */}\n      {!hasEnoughData && (\n        <div style={{\n          ...card,\n          textAlign: 'center', padding: 48,\n          background: 'var(--bg-primary)', border: '1px dashed var(--border-subtle)',\n        }}>\n          <Activity size={32} color=\"var(--text-muted)\" style={{ marginBottom: 16 }} />\n          <div style={{ fontSize: 16, color: 'var(--text-secondary)', fontWeight: 500, marginBottom: 8 }}>\n            Building Your Financial History\n          </div>\n          <div style={{ fontSize: 13, color: 'var(--text-muted)', lineHeight: 1.6, maxWidth: 480, margin: '0 auto' }}>\n            {snapshotCount === 0\n              ? 'Fortuna automatically records snapshots when your financial data changes. Your first snapshot will be recorded shortly. You can also take manual snapshots anytime.'\n              : 'One more snapshot needed to start showing trends. Continue using Fortuna — snapshots are taken automatically on data changes and monthly.'\n            }\n          </div>\n        </div>\n      )}\n\n      {/* Tabs */}\n      {hasEnoughData && (\n        <>\n          <div style={{ display: 'flex', gap: 4, marginBottom: 24 }}>\n            <button style={tabBtn(activeTab === 'trends')} onClick={() => setActiveTab('trends')}>\n              <TrendingUp size={14} style={{ display: 'inline', verticalAlign: -2, marginRight: 6 }} />\n              Trends\n            </button>\n            <button style={tabBtn(activeTab === 'timeline')} onClick={() => setActiveTab('timeline')}>\n              <Clock size={14} style={{ display: 'inline', verticalAlign: -2, marginRight: 6 }} />\n              Timeline\n            </button>\n            <button style={tabBtn(activeTab === 'effectiveness')} onClick={() => setActiveTab('effectiveness')}>\n              <Target size={14} style={{ display: 'inline', verticalAlign: -2, marginRight: 6 }} />\n              Strategy Impact\n            </button>\n            {projections.length > 0 && (\n              <button style={tabBtn(activeTab === 'projections')} onClick={() => setActiveTab('projections')}>\n                <ArrowRight size={14} style={{ display: 'inline', verticalAlign: -2, marginRight: 6 }} />\n                Projections\n              </button>\n            )}\n          </div>\n\n          {/* TRENDS TAB */}\n          {activeTab === 'trends' && (\n            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', gap: 16 }}>\n              {trends.map(trend => (\n                <TrendCard key={trend.metric} trend={trend} />\n              ))}\n            </div>\n          )}\n\n          {/* TIMELINE TAB */}\n          {activeTab === 'timeline' && (\n            <div style={{ display: 'flex', flexDirection: 'column', gap: 2 }}>\n              {milestones.map((ms, i) => (\n                <MilestoneRow\n                  key={ms.timestamp + i}\n                  milestone={ms}\n                  isExpanded={expandedMilestone === ms.timestamp + i}\n                  onToggle={() => setExpandedMilestone(\n                    expandedMilestone === ms.timestamp + i ? null : ms.timestamp + i\n                  )}\n                  isLast={i === milestones.length - 1}\n                />\n              ))}\n              {milestones.length === 0 && (\n                <div style={{ ...card, textAlign: 'center', color: 'var(--text-muted)', fontSize: 13 }}>\n                  No timeline events yet.\n                </div>\n              )}\n            </div>\n          )}\n\n          {/* STRATEGY EFFECTIVENESS TAB */}\n          {activeTab === 'effectiveness' && (\n            <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>\n              {strategyEffects.length === 0 ? (\n                <div style={{ ...card, textAlign: 'center', color: 'var(--text-muted)', fontSize: 13, padding: 40 }}>\n                  <Zap size={24} color=\"var(--text-muted)\" style={{ marginBottom: 12 }} />\n                  <div>No implemented strategies with before/after data yet.</div>\n                  <div style={{ marginTop: 4 }}>Implement strategies and take snapshots to track their effectiveness.</div>\n                </div>\n              ) : (\n                strategyEffects.map((effect, i) => (\n                  <EffectivenessCard key={i} effect={effect} />\n                ))\n              )}\n            </div>\n          )}\n\n          {/* PROJECTIONS TAB */}\n          {activeTab === 'projections' && (\n            <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>\n              <div style={{\n                padding: '10px 16px', borderRadius: 10,\n                background: 'var(--accent-blue-dim)', border: '1px solid var(--accent-blue)22',\n                fontSize: 12, color: 'var(--accent-blue)', lineHeight: 1.5,\n              }}>\n                Projections are based on linear regression of your snapshot history. Confidence increases with more data points.\n              </div>\n              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: 16 }}>\n                {projections.map(proj => (\n                  <ProjectionCard key={proj.metric} projection={proj} />\n                ))}\n              </div>\n            </div>\n          )}\n        </>\n      )}\n    </div>\n  )\n}\n\n// ===================================================================\n//  TREND CARD\n// ===================================================================\n\nfunction TrendCard({ trend }: { trend: TrendLine }) {\n  const dirIcon = trend.direction === 'up'\n    ? <TrendingUp size={14} />\n    : trend.direction === 'down'\n      ? <TrendingDown size={14} />\n      : <Minus size={14} />\n\n  const dirColor = trend.isPositive ? 'var(--accent-emerald)' : 'var(--accent-red)'\n  const neutralColor = trend.direction === 'flat' ? 'var(--text-muted)' : dirColor\n\n  return (\n    <div style={{\n      background: 'var(--bg-elevated)', border: '1px solid var(--border-subtle)',\n      borderRadius: 14, padding: 20,\n    }}>\n      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>\n        <span style={{ fontSize: 12, color: 'var(--text-muted)', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.06em' }}>\n          {trend.label}\n        </span>\n        <span style={{\n          display: 'inline-flex', alignItems: 'center', gap: 4,\n          fontSize: 12, fontWeight: 600, color: neutralColor,\n        }}>\n          {dirIcon}\n          {fmtChange(trend.change, trend.unit)}\n        </span>\n      </div>\n      <div style={{\n        fontFamily: 'var(--font-mono)', fontSize: 22, fontWeight: 600,\n        color: 'var(--text-primary)', marginBottom: 12,\n      }}>\n        {fmt(trend.current, trend.unit)}\n      </div>\n      <Sparkline points={trend.points} color={neutralColor} />\n      <div style={{ marginTop: 8, fontSize: 11, color: 'var(--text-muted)' }}>\n        {Math.abs(trend.changePct).toFixed(1)}% {trend.direction === 'up' ? 'increase' : trend.direction === 'down' ? 'decrease' : 'change'}\n        {' · '}{trend.points.length} data points\n      </div>\n    </div>\n  )\n}\n\n// ===================================================================\n//  MILESTONE ROW\n// ===================================================================\n\nfunction MilestoneRow({ milestone, isExpanded, onToggle, isLast }: {\n  milestone: Milestone\n  isExpanded: boolean\n  onToggle: () => void\n  isLast: boolean\n}) {\n  return (\n    <button\n      onClick={onToggle}\n      style={{\n        display: 'flex', gap: 16, padding: '14px 16px',\n        background: isExpanded ? 'var(--bg-elevated)' : 'transparent',\n        border: isExpanded ? '1px solid var(--border-subtle)' : '1px solid transparent',\n        borderRadius: 10, cursor: 'pointer',\n        textAlign: 'left', width: '100%',\n        fontFamily: 'var(--font-body)',\n        transition: 'all 0.2s',\n      }}\n    >\n      {/* Timeline dot + connector */}\n      <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', flexShrink: 0, width: 32 }}>\n        <div style={{\n          width: 28, height: 28, borderRadius: 14,\n          background: milestone.color + '22',\n          display: 'flex', alignItems: 'center', justifyContent: 'center',\n          fontSize: 14,\n        }}>\n          {milestone.icon}\n        </div>\n        {!isLast && (\n          <div style={{ width: 2, flex: 1, background: 'var(--border-subtle)', marginTop: 4, minHeight: 12 }} />\n        )}\n      </div>\n\n      {/* Content */}\n      <div style={{ flex: 1, minWidth: 0 }}>\n        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\n          <span style={{ fontSize: 13, color: 'var(--text-primary)', fontWeight: 500 }}>\n            {milestone.title}\n          </span>\n          <span style={{ fontSize: 11, color: 'var(--text-muted)', fontFamily: 'var(--font-mono)', flexShrink: 0 }}>\n            {new Date(milestone.timestamp).toLocaleDateString()}\n          </span>\n        </div>\n        {isExpanded && (\n          <div style={{ fontSize: 12, color: 'var(--text-secondary)', marginTop: 6, lineHeight: 1.5 }}>\n            {milestone.description}\n          </div>\n        )}\n      </div>\n    </button>\n  )\n}\n\n// ===================================================================\n//  EFFECTIVENESS CARD\n// ===================================================================\n\nfunction EffectivenessCard({ effect }: { effect: StrategyEffect }) {\n  const verdictColor = {\n    positive: 'var(--accent-emerald)',\n    negative: 'var(--accent-red)',\n    neutral: 'var(--accent-gold)',\n    insufficient_data: 'var(--text-muted)',\n  }[effect.verdict]\n\n  const verdictLabel = {\n    positive: 'Positive Impact',\n    negative: 'Needs Review',\n    neutral: 'Neutral',\n    insufficient_data: 'Awaiting Data',\n  }[effect.verdict]\n\n  return (\n    <div style={{\n      background: 'var(--bg-elevated)', border: '1px solid var(--border-subtle)',\n      borderRadius: 14, padding: 20,\n    }}>\n      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>\n        <div>\n          <div style={{ fontSize: 14, color: 'var(--text-primary)', fontWeight: 500 }}>\n            {effect.strategyTitle}\n          </div>\n          <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 2 }}>\n            Implemented {new Date(effect.implementedDate).toLocaleDateString()}\n          </div>\n        </div>\n        <span style={{\n          padding: '4px 10px', borderRadius: 6,\n          background: verdictColor + '18', color: verdictColor,\n          fontSize: 11, fontWeight: 600,\n        }}>\n          {verdictLabel}\n        </span>\n      </div>\n\n      {effect.verdict !== 'insufficient_data' && (\n        <div style={{ display: 'flex', gap: 16, marginBottom: 12 }}>\n          <MetricPill label=\"Tax Burden\" value={effect.taxBurdenChange} unit=\"$\" positiveDir=\"down\" />\n          <MetricPill label=\"Health Score\" value={effect.healthScoreChange} unit=\"pts\" positiveDir=\"up\" />\n          <MetricPill label=\"Eff. Rate\" value={effect.effectiveRateChange} unit=\"pp\" positiveDir=\"down\" />\n        </div>\n      )}\n\n      <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.5 }}>\n        {effect.summary}\n      </div>\n    </div>\n  )\n}\n\nfunction MetricPill({ label, value, unit, positiveDir }: {\n  label: string; value: number; unit: string; positiveDir: 'up' | 'down'\n}) {\n  const isPositive = (value > 0 && positiveDir === 'up') || (value < 0 && positiveDir === 'down')\n  const color = Math.abs(value) < 0.5 ? 'var(--text-muted)' : isPositive ? 'var(--accent-emerald)' : 'var(--accent-red)'\n  const sign = value >= 0 ? '+' : ''\n  const display = unit === '$'\n    ? sign + '$' + Math.abs(value).toLocaleString(undefined, { maximumFractionDigits: 0 })\n    : sign + value.toFixed(1) + unit\n\n  return (\n    <div style={{\n      padding: '6px 10px', borderRadius: 8,\n      background: 'var(--bg-primary)',\n    }}>\n      <div style={{ fontSize: 10, color: 'var(--text-muted)', marginBottom: 2 }}>{label}</div>\n      <div style={{ fontFamily: 'var(--font-mono)', fontSize: 13, fontWeight: 600, color }}>{display}</div>\n    </div>\n  )\n}\n\n// ===================================================================\n//  PROJECTION CARD\n// ===================================================================\n\nfunction ProjectionCard({ projection }: { projection: Projection }) {\n  const confColor = {\n    high: 'var(--accent-emerald)',\n    medium: 'var(--accent-gold)',\n    low: 'var(--text-muted)',\n  }[projection.confidence]\n\n  return (\n    <div style={{\n      background: 'var(--bg-elevated)', border: '1px solid var(--border-subtle)',\n      borderRadius: 14, padding: 20,\n    }}>\n      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 12 }}>\n        <span style={{ fontSize: 12, color: 'var(--text-muted)', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.06em' }}>\n          {projection.label}\n        </span>\n        <span style={{ fontSize: 10, color: confColor, fontWeight: 600, textTransform: 'uppercase' }}>\n          {projection.confidence} confidence\n        </span>\n      </div>\n\n      <div style={{\n        fontFamily: 'var(--font-mono)', fontSize: 20, fontWeight: 600,\n        color: 'var(--text-primary)', marginBottom: 16,\n      }}>\n        {fmt(projection.current, projection.unit)}\n        <span style={{ fontSize: 12, color: 'var(--text-muted)', fontWeight: 400, marginLeft: 6 }}>now</span>\n      </div>\n\n      <div style={{ display: 'flex', gap: 12 }}>\n        {[\n          { label: '3 mo', value: projection.projected3Month },\n          { label: '6 mo', value: projection.projected6Month },\n          { label: '12 mo', value: projection.projected12Month },\n        ].map(p => {\n          const diff = p.value - projection.current\n          const color = Math.abs(diff) < 1 ? 'var(--text-muted)' : diff > 0 ? 'var(--accent-emerald)' : 'var(--accent-red)'\n          return (\n            <div key={p.label} style={{ flex: 1, padding: '8px 10px', background: 'var(--bg-primary)', borderRadius: 8, textAlign: 'center' }}>\n              <div style={{ fontSize: 10, color: 'var(--text-muted)', marginBottom: 4 }}>{p.label}</div>\n              <div style={{ fontFamily: 'var(--font-mono)', fontSize: 14, fontWeight: 600, color }}>\n                {fmt(p.value, projection.unit)}\n              </div>\n            </div>\n          )\n        })}\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\GoalPlanner.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DollarSign' is defined but never used.","line":5,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":21,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DollarSign"},"fix":{"range":[231,243],"text":""},"desc":"Remove unused variable \"DollarSign\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TrendingUp' is defined but never used.","line":5,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":33,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TrendingUp"},"fix":{"range":[243,255],"text":""},"desc":"Remove unused variable \"TrendingUp\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Calendar' is defined but never used.","line":5,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":43,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Calendar"},"fix":{"range":[255,265],"text":""},"desc":"Remove unused variable \"Calendar\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'CheckCircle2' is defined but never used.","line":6,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":15,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CheckCircle2"},"fix":{"range":[274,290],"text":""},"desc":"Remove unused variable \"CheckCircle2\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AlertTriangle' is defined but never used.","line":6,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":30,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AlertTriangle"},"fix":{"range":[290,305],"text":""},"desc":"Remove unused variable \"AlertTriangle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ArrowRight' is defined but never used.","line":6,"column":32,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":42,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ArrowRight"},"fix":{"range":[305,317],"text":""},"desc":"Remove unused variable \"ArrowRight\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'PiggyBank' is defined but never used.","line":6,"column":49,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":58,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"PiggyBank"},"fix":{"range":[322,333],"text":""},"desc":"Remove unused variable \"PiggyBank\"."}]},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Date.now` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\GoalPlanner.tsx:29:97\n  27 |     name: sg.title,\n  28 |     targetAmount: sg.targetAmount || 0,\n> 29 |     deadlineMonths: sg.targetDate ? Math.max(1, Math.round((new Date(sg.targetDate).getTime() - Date.now()) / (30 * 24 * 60 * 60 * 1000))) : 12,\n     |                                                                                                 ^^^^^^^^^^ Cannot call impure function\n  30 |     priority: sg.priority === 'low' ? 'medium' as const : sg.priority as 'critical' | 'high' | 'medium',\n  31 |   }))\n  32 |   const [activeGoals, _setActiveGoals] = useState<FinancialGoal[]>(initialGoals)","line":29,"column":97,"nodeType":null,"endLine":29,"endColumn":107},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":42,"column":217,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":220,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2194,2197],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2194,2197],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":9,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { calculateGoalPlan, getPresetGoals, GOAL_LABELS, type FinancialGoal, type GoalType } from '../engine/goal-planner'\nimport {\n  Target, DollarSign, TrendingUp, Calendar, Plus, X,\n  CheckCircle2, AlertTriangle, ArrowRight, Zap, PiggyBank\n} from 'lucide-react'\nimport { AreaChart, Area, XAxis, YAxis, Tooltip, ResponsiveContainer, ReferenceLine } from 'recharts'\n\nfunction fmt(n: number): string { return `$${Math.round(n).toLocaleString()}` }\nfunction fmtK(n: number): string { return n >= 1000 ? `$${(n / 1000).toFixed(0)}k` : `$${n}` }\n\nconst GOAL_ICONS: Record<GoalType, string> = {\n  after_tax_income: '💰', savings_target: '🏦', retirement_balance: '🏖️',\n  tax_bill_limit: '🛡️', monthly_net: '📅',\n}\n\nexport function GoalPlanner() {\n  const { state, updateState } = useFortuna()\n  const hasData = state.incomeStreams.length > 0\n  const presets = useMemo(() => getPresetGoals(state), [state])\n\n  // Load from persisted goals\n  const initialGoals: FinancialGoal[] = (state.goals || []).map(sg => ({\n    id: sg.id,\n    type: (sg.type === 'tax_reduction' ? 'tax_bill_limit' : sg.type === 'savings' ? 'savings_target' : sg.type === 'retirement' ? 'retirement_balance' : sg.type === 'income_growth' ? 'after_tax_income' : 'after_tax_income') as GoalType,\n    name: sg.title,\n    targetAmount: sg.targetAmount || 0,\n    deadlineMonths: sg.targetDate ? Math.max(1, Math.round((new Date(sg.targetDate).getTime() - Date.now()) / (30 * 24 * 60 * 60 * 1000))) : 12,\n    priority: sg.priority === 'low' ? 'medium' as const : sg.priority as 'critical' | 'high' | 'medium',\n  }))\n  const [activeGoals, _setActiveGoals] = useState<FinancialGoal[]>(initialGoals)\n\n  const setActiveGoals = (goals: FinancialGoal[]) => {\n    _setActiveGoals(goals)\n    // Persist back to storage format\n    updateState(s => ({\n      ...s,\n      goals: goals.map(g => ({\n        id: g.id,\n        title: g.name,\n        type: (g.type === 'tax_bill_limit' ? 'tax_reduction' : g.type === 'savings_target' ? 'savings' : g.type === 'retirement_balance' ? 'retirement' : g.type === 'after_tax_income' ? 'income_growth' : 'other') as any,\n        targetAmount: g.targetAmount,\n        currentAmount: 0,\n        targetDate: g.deadlineMonths ? new Date(Date.now() + g.deadlineMonths * 30 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10) : undefined,\n        priority: g.priority === 'critical' ? 'high' as const : g.priority as 'high' | 'medium' | 'low',\n        status: 'active' as const,\n        entityId: 'personal', memberId: 'primary', taxYear: new Date().getFullYear(), tags: [],\n      })),\n    }))\n  }\n  const [showCustom, setShowCustom] = useState(false)\n  const [customType, setCustomType] = useState<GoalType>('after_tax_income')\n  const [customName, setCustomName] = useState('')\n  const [customAmount, setCustomAmount] = useState(100000)\n  const [customMonths, setCustomMonths] = useState(12)\n\n  const plans = useMemo(() => activeGoals.map(g => calculateGoalPlan(g, state)), [activeGoals, state])\n\n  const addGoal = (goal: FinancialGoal) => {\n    if (!activeGoals.find(g => g.id === goal.id)) {\n      setActiveGoals([...activeGoals, goal])\n    }\n  }\n\n  const removeGoal = (id: string) => setActiveGoals(activeGoals.filter(g => g.id !== id))\n\n  const addCustomGoal = () => {\n    const goal: FinancialGoal = {\n      id: `custom-${Date.now()}`, type: customType,\n      name: customName || GOAL_LABELS[customType],\n      targetAmount: customAmount, deadlineMonths: customMonths, priority: 'high',\n    }\n    addGoal(goal)\n    setShowCustom(false)\n    setCustomName('')\n  }\n\n  if (!hasData) {\n    return (\n      <div className=\"view-enter\" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '50vh' }}>\n        <div style={{ textAlign: 'center', maxWidth: 400 }}>\n          <Target size={32} color=\"var(--accent-gold)\" style={{ marginBottom: 12 }} />\n          <h2 style={{ fontFamily: 'var(--font-display)', marginBottom: 8 }}>Goal Planner</h2>\n          <p style={{ fontSize: 13, color: 'var(--text-muted)' }}>Add income data to plan backward from your financial goals.</p>\n        </div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"view-enter\">\n      <div style={{ marginBottom: 24 }}>\n        <h1 className=\"section-title\">Goal-Based Planner</h1>\n        <p className=\"section-subtitle\">Work backward from your targets — the engine calculates what's needed to get there</p>\n      </div>\n\n      {/* Quick Presets */}\n      {activeGoals.length === 0 && (\n        <div className=\"card\" style={{ marginBottom: 20 }}>\n          <div className=\"card-header\"><span className=\"card-title\">Quick Goals</span></div>\n          <div className=\"card-body\" style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 10 }}>\n            {presets.slice(0, 8).map(preset => (\n              <div key={preset.id}\n                style={{ padding: '12px 14px', borderRadius: 10, background: 'var(--bg-primary)', border: '1px solid var(--border-subtle)',\n                  cursor: 'pointer', transition: 'border-color 0.2s' }}\n                onClick={() => addGoal(preset)}\n                onMouseEnter={e => (e.currentTarget.style.borderColor = 'var(--accent-gold-glow)')}\n                onMouseLeave={e => (e.currentTarget.style.borderColor = 'var(--border-subtle)')}>\n                <div style={{ fontSize: 18, marginBottom: 4 }}>{GOAL_ICONS[preset.type]}</div>\n                <div style={{ fontSize: 12, fontWeight: 500, color: 'var(--text-primary)' }}>{preset.name}</div>\n                <div style={{ fontSize: 11, fontFamily: 'var(--font-mono)', color: 'var(--accent-gold)', marginTop: 2 }}>\n                  {preset.type === 'monthly_net' ? `${fmt(preset.targetAmount)}/mo` : fmt(preset.targetAmount)}\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {/* Add buttons */}\n      <div style={{ display: 'flex', gap: 8, marginBottom: 16 }}>\n        <button className=\"btn btn-ghost\" onClick={() => setShowCustom(!showCustom)} style={{ fontSize: 12 }}>\n          <Plus size={14} /> Custom Goal\n        </button>\n        {activeGoals.length > 0 && presets.filter(p => !activeGoals.find(g => g.id === p.id)).length > 0 && (\n          <div style={{ display: 'flex', gap: 4, flexWrap: 'wrap' }}>\n            {presets.filter(p => !activeGoals.find(g => g.id === p.id)).slice(0, 4).map(p => (\n              <button key={p.id} className=\"btn btn-ghost\" onClick={() => addGoal(p)} style={{ fontSize: 11, padding: '4px 10px' }}>\n                + {p.name.substring(0, 20)}\n              </button>\n            ))}\n          </div>\n        )}\n      </div>\n\n      {/* Custom Goal Builder */}\n      {showCustom && (\n        <div className=\"card\" style={{ marginBottom: 20, padding: '16px 20px' }}>\n          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr 1fr auto', gap: 12, alignItems: 'end' }}>\n            <div>\n              <label style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase', display: 'block', marginBottom: 4 }}>Goal Type</label>\n              <select value={customType} onChange={e => setCustomType(e.target.value as GoalType)}\n                className=\"input\" style={{ fontSize: 12, padding: '8px 10px' }}>\n                {Object.entries(GOAL_LABELS).map(([k, v]) => <option key={k} value={k}>{v}</option>)}\n              </select>\n            </div>\n            <div>\n              <label style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase', display: 'block', marginBottom: 4 }}>Name (optional)</label>\n              <input className=\"input\" value={customName} onChange={e => setCustomName(e.target.value)}\n                placeholder={GOAL_LABELS[customType]} style={{ fontSize: 12, padding: '8px 10px' }} />\n            </div>\n            <div>\n              <label style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase', display: 'block', marginBottom: 4 }}>Target Amount ($)</label>\n              <input className=\"input\" type=\"number\" value={customAmount} onChange={e => setCustomAmount(Number(e.target.value))}\n                style={{ fontSize: 12, padding: '8px 10px' }} />\n            </div>\n            <div>\n              <label style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase', display: 'block', marginBottom: 4 }}>Timeline (months)</label>\n              <input className=\"input\" type=\"number\" value={customMonths} onChange={e => setCustomMonths(Number(e.target.value))}\n                style={{ fontSize: 12, padding: '8px 10px' }} />\n            </div>\n            <button className=\"btn btn-primary\" onClick={addCustomGoal} style={{ fontSize: 12, padding: '8px 16px' }}>\n              <Plus size={14} /> Add\n            </button>\n          </div>\n        </div>\n      )}\n\n      {/* Goal Plans */}\n      {plans.map((plan, i) => (\n        <div key={plan.goal.id} className=\"card\" style={{ marginBottom: 16 }}>\n          <div className=\"card-header\">\n            <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>\n              <span style={{ fontSize: 20 }}>{GOAL_ICONS[plan.goal.type]}</span>\n              <div>\n                <span className=\"card-title\">{plan.goal.name}</span>\n                <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>Target: {plan.goal.type === 'monthly_net' ? `${fmt(plan.goal.targetAmount)}/mo` : fmt(plan.goal.targetAmount)}</div>\n              </div>\n            </div>\n            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n              <span className={`badge ${plan.onTrack ? 'emerald' : plan.progressPercent > 50 ? 'amber' : 'red'}`}>\n                {plan.onTrack ? 'On Track' : `${plan.progressPercent}%`}\n              </span>\n              <button onClick={() => removeGoal(plan.goal.id)} style={{ background: 'none', border: 'none', cursor: 'pointer', color: 'var(--text-muted)' }}>\n                <X size={14} />\n              </button>\n            </div>\n          </div>\n          <div className=\"card-body\">\n            {/* Progress Bar */}\n            <div style={{ marginBottom: 16 }}>\n              <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 11, color: 'var(--text-muted)', marginBottom: 4 }}>\n                <span>Current: {fmt(plan.currentGrossIncome)}</span>\n                <span>Required: {fmt(plan.requiredGrossIncome)}</span>\n              </div>\n              <div style={{ height: 8, borderRadius: 4, background: 'var(--bg-hover)' }}>\n                <div style={{\n                  height: '100%', borderRadius: 4, width: `${Math.min(100, plan.progressPercent)}%`,\n                  background: plan.onTrack ? 'var(--accent-emerald)' : plan.progressPercent > 50 ? 'var(--accent-gold)' : 'var(--accent-red)',\n                  transition: 'width 0.5s ease',\n                }} />\n              </div>\n            </div>\n\n            {/* KPIs */}\n            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: 10, marginBottom: 16 }}>\n              {[\n                { label: 'Income Gap', value: plan.incomeGap > 0 ? fmt(plan.incomeGap) : 'None', color: plan.incomeGap > 0 ? 'var(--accent-red)' : 'var(--accent-emerald)' },\n                { label: 'Monthly Gross Needed', value: fmt(plan.requiredMonthlyGross), color: 'var(--accent-gold)' },\n                { label: 'Monthly Savings', value: plan.requiredMonthlySavings > 0 ? fmt(plan.requiredMonthlySavings) : 'N/A', color: 'var(--accent-blue)' },\n                { label: 'Effective Tax Rate', value: `${(plan.effectiveTaxRate * 100).toFixed(1)}%`, color: 'var(--text-muted)' },\n                { label: 'Entity Savings', value: plan.estimatedTaxSavings > 0 ? fmt(plan.estimatedTaxSavings) : 'Optimal', color: plan.estimatedTaxSavings > 0 ? 'var(--accent-emerald)' : 'var(--text-muted)' },\n              ].map((kpi, j) => (\n                <div key={j} style={{ padding: '8px 10px', borderRadius: 8, background: 'var(--bg-primary)', textAlign: 'center' }}>\n                  <div style={{ fontFamily: 'var(--font-mono)', fontSize: 14, fontWeight: 600, color: kpi.color }}>{kpi.value}</div>\n                  <div style={{ fontSize: 9, color: 'var(--text-muted)' }}>{kpi.label}</div>\n                </div>\n              ))}\n            </div>\n\n            {/* Monthly milestones chart */}\n            {plan.monthlyPlan.length > 0 && (\n              <div style={{ marginBottom: 16 }}>\n                <div style={{ fontSize: 11, fontWeight: 500, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 8 }}>Milestone Timeline</div>\n                <ResponsiveContainer width=\"100%\" height={180}>\n                  <AreaChart data={plan.monthlyPlan} margin={{ top: 5, right: 10, bottom: 0, left: 10 }}>\n                    <defs>\n                      <linearGradient id={`goalGrad-${i}`} x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n                        <stop offset=\"0%\" stopColor=\"#10b981\" stopOpacity={0.3} />\n                        <stop offset=\"100%\" stopColor=\"#10b981\" stopOpacity={0.05} />\n                      </linearGradient>\n                    </defs>\n                    <XAxis dataKey=\"label\" tick={{ fill: 'var(--text-muted)', fontSize: 9 }} />\n                    <YAxis tickFormatter={v => fmtK(v)} tick={{ fill: 'var(--text-muted)', fontSize: 9 }} />\n                    <Tooltip formatter={(v: number) => fmt(v)} contentStyle={{ background: '#1a1d24', border: '1px solid #2a2d35', borderRadius: 8, fontSize: 11 }} />\n                    <Area type=\"monotone\" dataKey=\"cumulativeSaved\" name=\"Projected Savings\" fill={`url(#goalGrad-${i})`} stroke=\"#10b981\" strokeWidth={2} />\n                    <Area type=\"monotone\" dataKey=\"targetAtMonth\" name=\"Target Pace\" fill=\"none\" stroke=\"var(--accent-gold)\" strokeWidth={1.5} strokeDasharray=\"4 4\" />\n                    <ReferenceLine y={plan.goal.targetAmount} stroke=\"var(--accent-gold)\" strokeDasharray=\"3 3\" label={{ value: 'Goal', fill: 'var(--accent-gold)', fontSize: 9 }} />\n                  </AreaChart>\n                </ResponsiveContainer>\n              </div>\n            )}\n\n            {/* Entity recommendation */}\n            {plan.estimatedTaxSavings > 0 && (\n              <div style={{ padding: '10px 14px', borderRadius: 8, background: 'rgba(16,185,129,0.06)', border: '1px solid rgba(16,185,129,0.12)', display: 'flex', alignItems: 'center', gap: 10 }}>\n                <Zap size={16} color=\"var(--accent-emerald)\" />\n                <div style={{ fontSize: 12, color: 'var(--text-secondary)' }}>\n                  <strong style={{ color: 'var(--accent-emerald)' }}>{plan.optimalEntityType}</strong> could save {fmt(plan.estimatedTaxSavings)}/yr — accelerating your goal by reducing tax drag\n                </div>\n              </div>\n            )}\n\n            {/* Sensitivity */}\n            {plan.ifYouEarnMore.some(s => s.monthsSaved > 0) && (\n              <div style={{ marginTop: 12 }}>\n                <div style={{ fontSize: 11, fontWeight: 500, color: 'var(--text-muted)', marginBottom: 6 }}>If you earn more:</div>\n                <div style={{ display: 'flex', gap: 8 }}>\n                  {plan.ifYouEarnMore.filter(s => s.monthsSaved > 0).map((s, j) => (\n                    <div key={j} style={{ padding: '6px 10px', borderRadius: 6, background: 'var(--bg-primary)', fontSize: 11 }}>\n                      <span style={{ fontFamily: 'var(--font-mono)', color: 'var(--accent-gold)' }}>+{fmt(s.extraMonthly)}/mo</span>\n                      <span style={{ color: 'var(--text-muted)' }}> → </span>\n                      <span style={{ fontFamily: 'var(--font-mono)', color: 'var(--accent-emerald)' }}>{s.monthsSaved} months faster</span>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n          </div>\n        </div>\n      ))}\n\n      {activeGoals.length === 0 && (\n        <div style={{ textAlign: 'center', padding: 40, color: 'var(--text-muted)', fontSize: 13 }}>\n          Select a goal above or create a custom one to see your reverse-engineered plan\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\HealthScore.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'CheckCircle' is defined but never used.","line":4,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":56,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CheckCircle"},"fix":{"range":[225,238],"text":""},"desc":"Remove unused variable \"CheckCircle\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { generateHealthReport, type HealthDimension, type HealthGrade } from '../engine/health-score'\nimport { Activity, TrendingUp, AlertCircle, CheckCircle, Zap, ArrowRight } from 'lucide-react'\nimport type { ViewKey } from '../App'\n\nfunction gradeColor(grade: HealthGrade): string {\n  if (grade.startsWith('A')) return '#10b981'\n  if (grade.startsWith('B')) return '#3b82f6'\n  if (grade.startsWith('C')) return '#f59e0b'\n  if (grade.startsWith('D')) return '#ef4444'\n  return '#dc2626'\n}\n\nfunction ScoreRing({ score, grade, size = 160 }: { score: number; grade: HealthGrade; size?: number }) {\n  const color = gradeColor(grade)\n  const radius = (size - 16) / 2\n  const circumference = 2 * Math.PI * radius\n  const progress = (score / 100) * circumference\n\n  return (\n    <div style={{ position: 'relative', width: size, height: size }}>\n      <svg width={size} height={size} style={{ transform: 'rotate(-90deg)' }}>\n        <circle\n          cx={size / 2} cy={size / 2} r={radius}\n          fill=\"none\" stroke=\"var(--bg-primary)\" strokeWidth={8}\n        />\n        <circle\n          cx={size / 2} cy={size / 2} r={radius}\n          fill=\"none\" stroke={color} strokeWidth={8}\n          strokeDasharray={circumference}\n          strokeDashoffset={circumference - progress}\n          strokeLinecap=\"round\"\n          style={{ transition: 'stroke-dashoffset 1s ease' }}\n        />\n      </svg>\n      <div style={{\n        position: 'absolute', top: 0, left: 0, right: 0, bottom: 0,\n        display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center',\n      }}>\n        <div style={{ fontFamily: 'var(--font-display)', fontSize: size * 0.28, fontWeight: 700, color }}>\n          {grade}\n        </div>\n        <div style={{ fontFamily: 'var(--font-mono)', fontSize: size * 0.12, color: 'var(--text-muted)' }}>\n          {score}/100\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction RadarChart({ dimensions }: { dimensions: HealthDimension[] }) {\n  const size = 240\n  const center = size / 2\n  const maxRadius = size * 0.38\n  const n = dimensions.length\n  const angleStep = (2 * Math.PI) / n\n\n  const getPoint = (index: number, value: number) => {\n    const angle = angleStep * index - Math.PI / 2\n    const r = (value / 100) * maxRadius\n    return { x: center + r * Math.cos(angle), y: center + r * Math.sin(angle) }\n  }\n\n  const gridLevels = [25, 50, 75, 100]\n  const dataPoints = dimensions.map((d, i) => getPoint(i, d.score))\n  const dataPath = dataPoints.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ') + ' Z'\n\n  return (\n    <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`}>\n      {/* Grid */}\n      {gridLevels.map(level => {\n        const points = dimensions.map((_, i) => getPoint(i, level))\n        const path = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ') + ' Z'\n        return <path key={level} d={path} fill=\"none\" stroke=\"var(--border-subtle)\" strokeWidth={0.5} />\n      })}\n\n      {/* Axes */}\n      {dimensions.map((_, i) => {\n        const p = getPoint(i, 100)\n        return <line key={i} x1={center} y1={center} x2={p.x} y2={p.y} stroke=\"var(--border-subtle)\" strokeWidth={0.5} />\n      })}\n\n      {/* Data area */}\n      <path d={dataPath} fill=\"rgba(212,175,55,0.12)\" stroke=\"var(--accent-gold)\" strokeWidth={2} />\n\n      {/* Data points */}\n      {dataPoints.map((p, i) => (\n        <circle key={i} cx={p.x} cy={p.y} r={4} fill={dimensions[i].color} stroke=\"var(--bg-elevated)\" strokeWidth={2} />\n      ))}\n\n      {/* Labels */}\n      {dimensions.map((d, i) => {\n        const labelRadius = maxRadius + 28\n        const angle = angleStep * i - Math.PI / 2\n        const lx = center + labelRadius * Math.cos(angle)\n        const ly = center + labelRadius * Math.sin(angle)\n        return (\n          <text\n            key={i} x={lx} y={ly}\n            textAnchor=\"middle\" dominantBaseline=\"middle\"\n            style={{ fontSize: 9, fill: 'var(--text-muted)', fontFamily: 'var(--font-mono)' }}\n          >\n            {d.icon} {d.name.split(' ')[0]}\n          </text>\n        )\n      })}\n    </svg>\n  )\n}\n\nexport function HealthScore({ onNavigate }: { onNavigate?: (view: ViewKey) => void }) {\n  const { state } = useFortuna()\n  const report = useMemo(() => generateHealthReport(state), [state])\n\n  const viewMapping: Record<string, ViewKey> = {\n    'tax_efficiency': 'tax',\n    'entity_structure': 'optimizer' as ViewKey,\n    'audit_readiness': 'audit',\n    'diversification': 'revenue',\n    'retirement': 'tax',\n    'cashflow': 'cashflow',\n  }\n\n  return (\n    <div style={{ padding: 32, maxWidth: 1100 }}>\n      {/* Header */}\n      <div style={{ marginBottom: 32 }}>\n        <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 8 }}>\n          <Activity size={24} style={{ color: 'var(--accent-gold)' }} />\n          <h1 style={{ fontFamily: 'var(--font-display)', fontSize: 28, color: 'var(--text-primary)', margin: 0 }}>\n            Financial Health Score\n          </h1>\n        </div>\n        <p style={{ color: 'var(--text-muted)', fontSize: 14, margin: 0 }}>\n          Composite assessment across six key financial dimensions\n        </p>\n      </div>\n\n      {/* Score + Radar */}\n      <div style={{\n        display: 'flex', gap: 32, alignItems: 'center', justifyContent: 'center', flexWrap: 'wrap',\n        padding: 32, background: 'var(--bg-elevated)', borderRadius: 20,\n        border: '1px solid var(--border-subtle)', marginBottom: 24,\n      }}>\n        <div style={{ textAlign: 'center' }}>\n          <ScoreRing score={report.overallScore} grade={report.overallGrade} size={180} />\n          <div style={{ marginTop: 12, fontSize: 13, color: 'var(--text-muted)' }}>\n            {report.strengthsSummary}\n          </div>\n        </div>\n\n        <RadarChart dimensions={report.dimensions} />\n      </div>\n\n      {/* Quick Actions */}\n      {(report.quickWins.length > 0 || report.riskFlags.length > 0) && (\n        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16, marginBottom: 24 }}>\n          {report.quickWins.length > 0 && (\n            <div style={{\n              padding: 20, background: 'rgba(16,185,129,0.06)', borderRadius: 14,\n              border: '1px solid rgba(16,185,129,0.15)',\n            }}>\n              <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 10 }}>\n                <Zap size={16} style={{ color: '#10b981' }} />\n                <div style={{ fontSize: 13, fontWeight: 700, color: '#10b981' }}>Quick Wins</div>\n              </div>\n              {report.quickWins.map((w, i) => (\n                <div key={i} style={{ fontSize: 12, color: 'var(--text-secondary)', marginBottom: 6, paddingLeft: 24 }}>\n                  • {w}\n                </div>\n              ))}\n            </div>\n          )}\n\n          {report.riskFlags.length > 0 && (\n            <div style={{\n              padding: 20, background: 'rgba(239,68,68,0.06)', borderRadius: 14,\n              border: '1px solid rgba(239,68,68,0.15)',\n            }}>\n              <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 10 }}>\n                <AlertCircle size={16} style={{ color: '#ef4444' }} />\n                <div style={{ fontSize: 13, fontWeight: 700, color: '#ef4444' }}>Risk Flags</div>\n              </div>\n              {report.riskFlags.map((f, i) => (\n                <div key={i} style={{ fontSize: 12, color: 'var(--text-secondary)', marginBottom: 6, paddingLeft: 24 }}>\n                  ⚠ {f}\n                </div>\n              ))}\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* Dimension Cards */}\n      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', gap: 14 }}>\n        {report.dimensions.map(dim => (\n          <div key={dim.id} style={{\n            padding: 20, background: 'var(--bg-elevated)', borderRadius: 14,\n            border: '1px solid var(--border-subtle)',\n            borderLeft: `4px solid ${dim.color}`,\n          }}>\n            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 10 }}>\n              <div>\n                <div style={{ fontSize: 14, fontWeight: 700, color: 'var(--text-primary)', display: 'flex', alignItems: 'center', gap: 8 }}>\n                  <span>{dim.icon}</span> {dim.name}\n                </div>\n                <div style={{ fontSize: 12, color: 'var(--text-muted)', marginTop: 2 }}>{dim.status}</div>\n              </div>\n              <div style={{\n                fontFamily: 'var(--font-display)', fontSize: 22, fontWeight: 700, color: dim.color,\n              }}>\n                {dim.grade}\n              </div>\n            </div>\n\n            {/* Score bar */}\n            <div style={{ height: 6, background: 'var(--bg-primary)', borderRadius: 3, marginBottom: 10 }}>\n              <div style={{\n                height: '100%', width: `${dim.score}%`, background: dim.color,\n                borderRadius: 3, transition: 'width 0.8s ease',\n              }} />\n            </div>\n\n            <div style={{ fontSize: 11, color: 'var(--text-muted)', lineHeight: 1.5, marginBottom: 10 }}>\n              {dim.detail}\n            </div>\n\n            {dim.recommendations.length > 0 && (\n              <div style={{ borderTop: '1px solid var(--border-subtle)', paddingTop: 10 }}>\n                {dim.recommendations.slice(0, 2).map((r, i) => (\n                  <div key={i} style={{\n                    display: 'flex', gap: 6, fontSize: 11, color: dim.color,\n                    marginBottom: 4, fontWeight: 500,\n                  }}>\n                    <ArrowRight size={12} style={{ flexShrink: 0, marginTop: 1 }} /> {r}\n                  </div>\n                ))}\n              </div>\n            )}\n\n            {viewMapping[dim.id] && onNavigate && (\n              <button\n                onClick={() => onNavigate(viewMapping[dim.id])}\n                style={{\n                  marginTop: 8, padding: '5px 12px', borderRadius: 6,\n                  border: '1px solid var(--border-subtle)', background: 'var(--bg-primary)',\n                  color: 'var(--text-muted)', cursor: 'pointer', fontSize: 10, fontWeight: 500,\n                }}\n              >\n                Explore →\n              </button>\n            )}\n          </div>\n        ))}\n      </div>\n\n      {/* Top Priority */}\n      <div style={{\n        marginTop: 24, padding: 20, background: 'var(--accent-gold-dim)', borderRadius: 14,\n        border: '1px solid rgba(212,175,55,0.2)', display: 'flex', alignItems: 'center', gap: 14,\n      }}>\n        <TrendingUp size={20} style={{ color: 'var(--accent-gold)', flexShrink: 0 }} />\n        <div>\n          <div style={{ fontSize: 12, fontWeight: 700, color: 'var(--accent-gold)', marginBottom: 2 }}>\n            #1 Priority Action\n          </div>\n          <div style={{ fontSize: 13, color: 'var(--text-primary)' }}>\n            {report.topPriority}\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\MarginalRateView.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DollarSign' is defined but never used.","line":5,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":48,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DollarSign"},"fix":{"range":[188,200],"text":""},"desc":"Remove unused variable \"DollarSign\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Percent' is defined but never used.","line":5,"column":58,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":65,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Percent"},"fix":{"range":[208,217],"text":""},"desc":"Remove unused variable \"Percent\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BarChart' is defined but never used.","line":9,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":11,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"BarChart"},"fix":{"range":[325,337],"text":""},"desc":"Remove unused variable \"BarChart\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Bar' is defined but never used.","line":9,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":16,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Bar"},"fix":{"range":[337,342],"text":""},"desc":"Remove unused variable \"Bar\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Cell' is defined but never used.","line":9,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":22,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Cell"},"fix":{"range":[342,348],"text":""},"desc":"Remove unused variable \"Cell\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ComposedChart' is defined but never used.","line":9,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":37,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ComposedChart"},"fix":{"range":[348,363],"text":""},"desc":"Remove unused variable \"ComposedChart\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Line' is defined but never used.","line":9,"column":39,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":43,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Line"},"fix":{"range":[363,369],"text":""},"desc":"Remove unused variable \"Line\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'fmt' is defined but never used.","line":12,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'taxReport' is assigned a value but never used.","line":17,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":27}],"suppressedMessages":[],"errorCount":9,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { analyzeMarginalRates } from '../engine/marginal-rate'\nimport {\n  Layers, AlertTriangle, TrendingUp, DollarSign, Target, Percent\n} from 'lucide-react'\nimport {\n  AreaChart, Area, XAxis, YAxis, Tooltip, ResponsiveContainer, ReferenceLine,\n  BarChart, Bar, Cell, ComposedChart, Line\n} from 'recharts'\n\nfunction fmt(n: number): string { return `$${Math.round(n).toLocaleString()}` }\nfunction fmtK(n: number): string { return n >= 1000 ? `$${(n / 1000).toFixed(0)}k` : `$${n}` }\nfunction pct(n: number): string { return `${(n * 100).toFixed(1)}%` }\n\nexport function MarginalRateView() {\n  const { state, taxReport } = useFortuna()\n  const analysis = useMemo(() => analyzeMarginalRates(state), [state])\n  const hasData = state.incomeStreams.length > 0\n\n  if (!hasData) {\n    return (\n      <div className=\"view-enter\" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '50vh' }}>\n        <div style={{ textAlign: 'center', maxWidth: 400 }}>\n          <Layers size={32} color=\"var(--accent-gold)\" style={{ marginBottom: 12 }} />\n          <h2 style={{ fontFamily: 'var(--font-display)', marginBottom: 8 }}>Marginal Rate Stack</h2>\n          <p style={{ fontSize: 13, color: 'var(--text-muted)' }}>Add income to see your marginal rate breakdown at every income level.</p>\n        </div>\n      </div>\n    )\n  }\n\n  // Chart data: stacked area of rate components\n  const stackedData = analysis.points.filter(p => p.income > 0 && p.income <= 500000).map(p => ({\n    income: p.income,\n    federal: +(p.federalRate * 100).toFixed(1),\n    state: +(p.stateRate * 100).toFixed(1),\n    se: +(p.seRate * 100).toFixed(1),\n    fica: +(p.ficaRate * 100).toFixed(1),\n    niit: +(p.niitRate * 100).toFixed(1),\n    total: +(p.totalRate * 100).toFixed(1),\n    keep: +(p.keepRate * 100).toFixed(1),\n  }))\n\n  // Keep rate chart data\n  const keepData = analysis.points.filter(p => p.income > 0 && p.income <= 500000).map(p => ({\n    income: p.income,\n    keep: +(p.keepRate * 100).toFixed(1),\n  }))\n\n  const cp = analysis.currentPoint\n\n  return (\n    <div className=\"view-enter\">\n      <div style={{ marginBottom: 24 }}>\n        <h1 className=\"section-title\">Marginal Rate Stack</h1>\n        <p className=\"section-subtitle\">If you earn $1 more, how much do you keep? See your combined marginal rate decomposed.</p>\n      </div>\n\n      {/* Current Rate KPIs */}\n      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(6, 1fr)', gap: 10, marginBottom: 24 }}>\n        {[\n          { label: 'Total Marginal', value: pct(cp.totalRate), color: cp.totalRate > 0.45 ? 'var(--accent-red)' : 'var(--accent-gold)' },\n          { label: 'Federal', value: pct(cp.federalRate), color: '#ef4444' },\n          { label: 'State', value: pct(cp.stateRate), color: '#f97316' },\n          { label: 'SE Tax', value: pct(cp.seRate), color: '#a78bfa' },\n          { label: 'FICA', value: pct(cp.ficaRate), color: '#60a5fa' },\n          { label: 'You Keep', value: pct(cp.keepRate), color: 'var(--accent-emerald)' },\n        ].map((kpi, i) => (\n          <div key={i} style={{ padding: '10px 12px', borderRadius: 10, background: 'var(--bg-surface)', border: '1px solid var(--border-subtle)', textAlign: 'center' }}>\n            <div style={{ fontFamily: 'var(--font-mono)', fontSize: 18, fontWeight: 600, color: kpi.color }}>{kpi.value}</div>\n            <div style={{ fontSize: 10, color: 'var(--text-muted)', marginTop: 2 }}>{kpi.label}</div>\n          </div>\n        ))}\n      </div>\n\n      {/* Next Bracket Info */}\n      {analysis.nextBracketAt > analysis.currentIncome && (\n        <div className=\"glass-card\" style={{ padding: '14px 20px', marginBottom: 20, display: 'flex', alignItems: 'center', gap: 14 }}>\n          <Target size={18} color=\"var(--accent-gold)\" />\n          <div style={{ flex: 1 }}>\n            <span style={{ fontSize: 13, color: 'var(--text-primary)' }}>\n              Next rate increase at <strong style={{ fontFamily: 'var(--font-mono)', color: 'var(--accent-gold)' }}>{fmtK(analysis.nextBracketAt)}</strong>\n            </span>\n            <span style={{ fontSize: 12, color: 'var(--text-muted)', marginLeft: 8 }}>\n              ({fmtK(analysis.nextBracketAt - analysis.currentIncome)} of room) → {pct(analysis.nextBracketRate)} marginal\n            </span>\n          </div>\n        </div>\n      )}\n\n      {/* Stacked Rate Chart */}\n      <div className=\"card\" style={{ marginBottom: 20 }}>\n        <div className=\"card-header\"><span className=\"card-title\">Marginal Rate Stack by Income</span></div>\n        <div className=\"card-body\">\n          <ResponsiveContainer width=\"100%\" height={320}>\n            <AreaChart data={stackedData} margin={{ top: 10, right: 20, bottom: 0, left: 10 }}>\n              <defs>\n                <linearGradient id=\"fedGrad\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n                  <stop offset=\"0%\" stopColor=\"#ef4444\" stopOpacity={0.8} />\n                  <stop offset=\"100%\" stopColor=\"#ef4444\" stopOpacity={0.3} />\n                </linearGradient>\n                <linearGradient id=\"stateGrad\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n                  <stop offset=\"0%\" stopColor=\"#f97316\" stopOpacity={0.7} />\n                  <stop offset=\"100%\" stopColor=\"#f97316\" stopOpacity={0.2} />\n                </linearGradient>\n              </defs>\n              <XAxis dataKey=\"income\" tickFormatter={v => fmtK(v)} tick={{ fill: 'var(--text-muted)', fontSize: 10 }} />\n              <YAxis tickFormatter={v => `${v}%`} tick={{ fill: 'var(--text-muted)', fontSize: 10 }} domain={[0, 60]} />\n              <Tooltip\n                formatter={(v: number, name: string) => [`${v}%`, name.charAt(0).toUpperCase() + name.slice(1)]}\n                labelFormatter={v => `Income: ${fmtK(Number(v))}`}\n                contentStyle={{ background: '#1a1d24', border: '1px solid #2a2d35', borderRadius: 8, fontSize: 11 }}\n              />\n              <Area type=\"stepAfter\" dataKey=\"niit\" stackId=\"1\" fill=\"#ec4899\" stroke=\"none\" fillOpacity={0.6} />\n              <Area type=\"stepAfter\" dataKey=\"se\" stackId=\"1\" fill=\"#a78bfa\" stroke=\"none\" fillOpacity={0.7} />\n              <Area type=\"stepAfter\" dataKey=\"fica\" stackId=\"1\" fill=\"#60a5fa\" stroke=\"none\" fillOpacity={0.6} />\n              <Area type=\"stepAfter\" dataKey=\"state\" stackId=\"1\" fill=\"url(#stateGrad)\" stroke=\"none\" />\n              <Area type=\"stepAfter\" dataKey=\"federal\" stackId=\"1\" fill=\"url(#fedGrad)\" stroke=\"none\" />\n              <ReferenceLine x={analysis.currentIncome} stroke=\"var(--accent-gold)\" strokeDasharray=\"4 4\" strokeWidth={2} label={{ value: 'You', fill: 'var(--accent-gold)', fontSize: 10, position: 'top' }} />\n            </AreaChart>\n          </ResponsiveContainer>\n          {/* Legend */}\n          <div style={{ display: 'flex', gap: 16, justifyContent: 'center', marginTop: 8 }}>\n            {[\n              { label: 'Federal', color: '#ef4444' },\n              { label: 'State', color: '#f97316' },\n              { label: 'FICA', color: '#60a5fa' },\n              { label: 'SE Tax', color: '#a78bfa' },\n              { label: 'NIIT', color: '#ec4899' },\n            ].map(l => (\n              <div key={l.label} style={{ display: 'flex', alignItems: 'center', gap: 5, fontSize: 10, color: 'var(--text-muted)' }}>\n                <div style={{ width: 8, height: 8, borderRadius: 2, background: l.color }} />\n                {l.label}\n              </div>\n            ))}\n          </div>\n        </div>\n      </div>\n\n      {/* Keep Rate Chart */}\n      <div className=\"card\" style={{ marginBottom: 20 }}>\n        <div className=\"card-header\"><span className=\"card-title\">Dollar Retention Rate</span><span style={{ fontSize: 11, color: 'var(--text-muted)' }}>How much of each additional dollar you keep</span></div>\n        <div className=\"card-body\">\n          <ResponsiveContainer width=\"100%\" height={200}>\n            <AreaChart data={keepData} margin={{ top: 10, right: 20, bottom: 0, left: 10 }}>\n              <defs>\n                <linearGradient id=\"keepGrad\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n                  <stop offset=\"0%\" stopColor=\"#10b981\" stopOpacity={0.4} />\n                  <stop offset=\"100%\" stopColor=\"#10b981\" stopOpacity={0.05} />\n                </linearGradient>\n              </defs>\n              <XAxis dataKey=\"income\" tickFormatter={v => fmtK(v)} tick={{ fill: 'var(--text-muted)', fontSize: 10 }} />\n              <YAxis tickFormatter={v => `${v}%`} tick={{ fill: 'var(--text-muted)', fontSize: 10 }} domain={[30, 100]} />\n              <Tooltip\n                formatter={(v: number) => [`${v}%`, 'Keep Rate']}\n                labelFormatter={v => `Income: ${fmtK(Number(v))}`}\n                contentStyle={{ background: '#1a1d24', border: '1px solid #2a2d35', borderRadius: 8, fontSize: 11 }}\n              />\n              <Area type=\"stepAfter\" dataKey=\"keep\" fill=\"url(#keepGrad)\" stroke=\"#10b981\" strokeWidth={2} />\n              <ReferenceLine x={analysis.currentIncome} stroke=\"var(--accent-gold)\" strokeDasharray=\"4 4\" strokeWidth={2} />\n              <ReferenceLine y={50} stroke=\"rgba(239,68,68,0.3)\" strokeDasharray=\"3 3\" label={{ value: '50% cliff', fill: 'var(--accent-red)', fontSize: 9, position: 'right' }} />\n            </AreaChart>\n          </ResponsiveContainer>\n        </div>\n      </div>\n\n      {/* Danger Zones & Sweet Spots */}\n      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>\n        {analysis.dangerZones.length > 0 && (\n          <div className=\"card\">\n            <div className=\"card-header\"><span className=\"card-title\" style={{ color: 'var(--accent-red)' }}><AlertTriangle size={14} /> Danger Zones</span></div>\n            <div className=\"card-body\" style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>\n              {analysis.dangerZones.map((zone, i) => (\n                <div key={i} style={{ padding: '10px 14px', borderRadius: 8, background: 'rgba(239,68,68,0.06)', border: '1px solid rgba(239,68,68,0.12)' }}>\n                  <div style={{ fontSize: 12, fontWeight: 500, color: 'var(--accent-red)', fontFamily: 'var(--font-mono)' }}>\n                    {fmtK(zone.start)} — {fmtK(zone.end)}\n                  </div>\n                  <div style={{ fontSize: 11, color: 'var(--text-secondary)', marginTop: 2 }}>{zone.reason}</div>\n                </div>\n              ))}\n            </div>\n          </div>\n        )}\n        {analysis.sweetSpots.length > 0 && (\n          <div className=\"card\">\n            <div className=\"card-header\"><span className=\"card-title\" style={{ color: 'var(--accent-emerald)' }}><TrendingUp size={14} /> Sweet Spots</span></div>\n            <div className=\"card-body\" style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>\n              {analysis.sweetSpots.map((spot, i) => (\n                <div key={i} style={{ padding: '10px 14px', borderRadius: 8, background: 'rgba(16,185,129,0.06)', border: '1px solid rgba(16,185,129,0.12)' }}>\n                  <div style={{ fontSize: 12, fontWeight: 500, color: 'var(--accent-emerald)', fontFamily: 'var(--font-mono)' }}>\n                    {fmtK(spot.income)} · Keep {pct(spot.keepRate)}\n                  </div>\n                  <div style={{ fontSize: 11, color: 'var(--text-secondary)', marginTop: 2 }}>{spot.reason}</div>\n                </div>\n              ))}\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\MarketIntelligence.tsx","messages":[{"ruleId":"react-hooks/preserve-manual-memoization","severity":2,"message":"Compilation Skipped: Existing memoization could not be preserved\n\nReact Compiler has skipped optimizing this component because the existing manual memoization could not be preserved. The inferred dependencies did not match the manually specified dependencies, which could cause the value to change more or less frequently than expected. The inferred dependency was `portfolioSymbols`, but the source dependencies were [portfolioSymbols.length]. Inferred less specific property than source.\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\MarketIntelligence.tsx:29:32\n  27 |     .filter((s, i, a) => s && a.indexOf(s) === i)\n  28 |\n> 29 |   const loadData = useCallback(async () => {\n     |                                ^^^^^^^^^^^^^\n> 30 |     setLoading(true)\n     | ^^^^^^^^^^^^^^^^^^^^\n> 31 |     setError(null)\n     …\n     | ^^^^^^^^^^^^^^^^^^^^\n> 47 |     setLoading(false)\n     | ^^^^^^^^^^^^^^^^^^^^\n> 48 |   }, [portfolioSymbols.length])\n     | ^^^^ Could not preserve existing manual memoization\n  49 |\n  50 |   useEffect(() => { loadData() }, []) // eslint-disable-line react-hooks/exhaustive-deps\n  51 |","line":29,"column":32,"nodeType":null,"endLine":48,"endColumn":4},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'err' is defined but never used.","line":44,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":44,"endColumn":17},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'portfolioSymbols'. Either include it or remove the dependency array.","line":48,"column":6,"nodeType":"ArrayExpression","endLine":48,"endColumn":31,"suggestions":[{"desc":"Update the dependencies array to be: [portfolioSymbols]","fix":{"range":[1986,2011],"text":"[portfolioSymbols]"}}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\MarketIntelligence.tsx:50:21\n  48 |   }, [portfolioSymbols.length])\n  49 |\n> 50 |   useEffect(() => { loadData() }, []) // eslint-disable-line react-hooks/exhaustive-deps\n     |                     ^^^^^^^^ Avoid calling setState() directly within an effect\n  51 |\n  52 |   const sectionStyle: React.CSSProperties = {\n  53 |     background: 'var(--bg-card)', borderRadius: 12,","line":50,"column":21,"nodeType":null,"endLine":50,"endColumn":29}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadData'. Either include it or remove the dependency array.","line":50,"column":35,"nodeType":"ArrayExpression","endLine":50,"endColumn":37,"suggestions":[{"desc":"Update the dependencies array to be: [loadData]","fix":{"range":[2048,2050],"text":"[loadData]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":3,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — Market Intelligence View\n * Live macro-economic data, portfolio valuation, exchange rates,\n * and their direct impact on the user's tax situation.\n *\n * @view MarketIntelligence\n */\n\nimport { useState, useEffect, useCallback } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { fetchMacroSnapshot, type MacroSnapshot } from '../engine/market-data'\nimport { fetchExchangeRates, type ExchangeRates } from '../engine/exchange-rates'\nimport { fetchQuotes, type StockQuote } from '../engine/stock-quotes'\n\nexport default function MarketIntelligence() {\n  const { state, taxReport: report } = useFortuna()\n  const [macro, setMacro] = useState<MacroSnapshot | null>(null)\n  const [rates, setRates] = useState<ExchangeRates | null>(null)\n  const [quotes, setQuotes] = useState<Map<string, StockQuote>>(new Map())\n  const [loading, setLoading] = useState(true)\n  const [error, setError] = useState<string | null>(null)\n  const [lastRefresh, setLastRefresh] = useState<string>('')\n\n  // Extract portfolio symbols from investments\n  const portfolioSymbols = (state.investments || [])\n    .map(i => i.symbol)\n    .filter((s, i, a) => s && a.indexOf(s) === i)\n\n  const loadData = useCallback(async () => {\n    setLoading(true)\n    setError(null)\n    try {\n      const [macroData, ratesData, quotesData] = await Promise.allSettled([\n        fetchMacroSnapshot(),\n        fetchExchangeRates('USD'),\n        portfolioSymbols.length > 0 ? fetchQuotes(portfolioSymbols.slice(0, 10)) : Promise.resolve(new Map()),\n      ])\n\n      if (macroData.status === 'fulfilled') setMacro(macroData.value)\n      if (ratesData.status === 'fulfilled' && ratesData.value) setRates(ratesData.value)\n      if (quotesData.status === 'fulfilled') setQuotes(quotesData.value as Map<string, StockQuote>)\n\n      setLastRefresh(new Date().toLocaleTimeString())\n    } catch (err) {\n      setError('Some data sources unavailable — showing cached data')\n    }\n    setLoading(false)\n  }, [portfolioSymbols.length])\n\n  useEffect(() => { loadData() }, []) // eslint-disable-line react-hooks/exhaustive-deps\n\n  const sectionStyle: React.CSSProperties = {\n    background: 'var(--bg-card)', borderRadius: 12,\n    border: '1px solid var(--border-subtle)', padding: 20, marginBottom: 16,\n  }\n\n  const labelStyle: React.CSSProperties = {\n    fontSize: 11, color: 'var(--text-muted)', textTransform: 'uppercase' as const,\n    letterSpacing: '0.08em', marginBottom: 4,\n  }\n\n  const valueStyle: React.CSSProperties = {\n    fontSize: 24, fontWeight: 700, fontFamily: 'var(--font-mono)',\n    color: 'var(--text-primary)',\n  }\n\n  const smallValueStyle: React.CSSProperties = {\n    fontSize: 16, fontWeight: 600, fontFamily: 'var(--font-mono)',\n    color: 'var(--text-primary)',\n  }\n\n  const impactStyle = (positive: boolean): React.CSSProperties => ({\n    fontSize: 11, padding: '2px 8px', borderRadius: 4,\n    background: positive ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)',\n    color: positive ? '#22c55e' : '#ef4444',\n    fontWeight: 500,\n  })\n\n  return (\n    <div style={{ padding: '24px 32px', maxWidth: 1200 }}>\n      {/* Header */}\n      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24 }}>\n        <div>\n          <h1 style={{\n            fontSize: 22, fontWeight: 700, color: 'var(--text-primary)',\n            fontFamily: 'var(--font-display)', margin: 0,\n          }}>\n            📡 Market Intelligence\n          </h1>\n          <p style={{ fontSize: 12, color: 'var(--text-muted)', margin: '4px 0 0' }}>\n            Live data from Federal Reserve, Treasury, BLS — connected to your tax picture\n          </p>\n        </div>\n        <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>\n          {lastRefresh && (\n            <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>\n              Updated {lastRefresh}\n            </span>\n          )}\n          <button\n            onClick={loadData}\n            disabled={loading}\n            style={{\n              padding: '6px 16px', borderRadius: 8, fontSize: 12, fontWeight: 500,\n              background: loading ? 'var(--bg-hover)' : 'linear-gradient(135deg, #f59e0b, #d97706)',\n              border: 'none', color: loading ? 'var(--text-muted)' : '#0a0e1a', cursor: 'pointer',\n            }}\n          >\n            {loading ? 'Loading...' : '↻ Refresh'}\n          </button>\n        </div>\n      </div>\n\n      {error && (\n        <div style={{\n          background: 'rgba(245, 158, 11, 0.08)', border: '1px solid rgba(245, 158, 11, 0.2)',\n          borderRadius: 8, padding: '8px 12px', fontSize: 12, color: '#f59e0b', marginBottom: 16,\n        }}>\n          ⚠️ {error}\n        </div>\n      )}\n\n      {/* Macro Dashboard */}\n      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(220px, 1fr))', gap: 12, marginBottom: 16 }}>\n        {/* Fed Funds Rate */}\n        <div style={sectionStyle}>\n          <div style={labelStyle}>Fed Funds Rate</div>\n          <div style={valueStyle}>{macro?.fedFundsRate != null ? `${macro.fedFundsRate}%` : '—'}</div>\n          <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 4 }}>\n            Penalty rate: {macro?.underpaymentPenaltyRate != null ? `${macro.underpaymentPenaltyRate}%` : '~8%'}\n          </div>\n          <div style={{ marginTop: 8 }}>\n            <span style={impactStyle(macro?.underpaymentPenaltyRate != null && macro.underpaymentPenaltyRate < 8)}>\n              {macro?.underpaymentPenaltyRate != null && macro.underpaymentPenaltyRate < 8 ? '↓ Lower penalty risk' : 'Current 2210 penalty rate'}\n            </span>\n          </div>\n        </div>\n\n        {/* Inflation */}\n        <div style={sectionStyle}>\n          <div style={labelStyle}>CPI Inflation (YoY)</div>\n          <div style={valueStyle}>{macro?.inflationRate != null ? `${macro.inflationRate}%` : '—'}</div>\n          <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 4 }}>\n            CPI Index: {macro?.cpiLatest?.toFixed(1) || '—'}\n          </div>\n          <div style={{ marginTop: 8 }}>\n            <span style={impactStyle((macro?.inflationRate || 3) > 3)}>\n              {(macro?.inflationRate || 3) > 3 ? 'Brackets inflate faster' : 'Moderate bracket growth'}\n            </span>\n          </div>\n        </div>\n\n        {/* Treasury Rates */}\n        <div style={sectionStyle}>\n          <div style={labelStyle}>Treasury Rates</div>\n          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 8 }}>\n            <div>\n              <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>Bills</div>\n              <div style={smallValueStyle}>{macro?.treasuryBillRate?.toFixed(2) || '—'}%</div>\n            </div>\n            <div>\n              <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>Notes</div>\n              <div style={smallValueStyle}>{macro?.treasuryNoteRate?.toFixed(2) || '—'}%</div>\n            </div>\n            <div>\n              <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>Bonds</div>\n              <div style={smallValueStyle}>{macro?.treasuryBondRate?.toFixed(2) || '—'}%</div>\n            </div>\n          </div>\n          <div style={{ marginTop: 8 }}>\n            <span style={impactStyle(true)}>\n              I-Bond est: {macro?.iBondCompositeRate?.toFixed(2) || '—'}%\n            </span>\n          </div>\n        </div>\n\n        {/* Your Tax Context */}\n        <div style={sectionStyle}>\n          <div style={labelStyle}>Your Tax Context</div>\n          <div style={valueStyle}>{(report.effectiveRate * 100).toFixed(1)}%</div>\n          <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 4 }}>\n            Effective rate on ${report.grossIncome.toLocaleString()} income\n          </div>\n          <div style={{ marginTop: 8 }}>\n            <span style={impactStyle(report.effectiveRate < 0.22)}>\n              {report.effectiveRate < 0.22 ? 'Low bracket — Roth conversion window' : 'Standard bracket positioning'}\n            </span>\n          </div>\n        </div>\n      </div>\n\n      {/* Tax Impact Analysis */}\n      <div style={sectionStyle}>\n        <h3 style={{ fontSize: 14, fontWeight: 600, color: 'var(--text-primary)', margin: '0 0 12px', fontFamily: 'var(--font-display)' }}>\n          📊 How Markets Affect Your Tax Picture\n        </h3>\n        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: 16 }}>\n          {/* Estimated Payment Impact */}\n          <div style={{ padding: 12, background: 'var(--bg-hover)', borderRadius: 8 }}>\n            <div style={{ fontSize: 12, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 6 }}>\n              Estimated Payment Penalty Rate\n            </div>\n            <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.6 }}>\n              {macro?.underpaymentPenaltyRate != null ? (\n                <>The IRS underpayment penalty rate is currently <strong>{macro.underpaymentPenaltyRate}%</strong> (fed funds rate + 3%).\n                  {report.selfEmploymentTax > 5000 && ' With SE tax of $' + report.selfEmploymentTax.toLocaleString() + ', ensure quarterly payments are on track.'}\n                </>\n              ) : 'Loading real-time penalty rate...'}\n            </div>\n          </div>\n\n          {/* Inflation & Brackets */}\n          <div style={{ padding: 12, background: 'var(--bg-hover)', borderRadius: 8 }}>\n            <div style={{ fontSize: 12, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 6 }}>\n              Inflation Impact on Tax Brackets\n            </div>\n            <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.6 }}>\n              {macro?.inflationRate != null ? (\n                <>At {macro.inflationRate}% inflation, 2027 brackets will expand ~{macro.inflationRate.toFixed(1)}%.\n                  Your {state.profile.filingStatus === 'married_joint' ? '24% bracket ceiling' : '22% bracket ceiling'} may\n                  increase by ~${Math.round((macro.inflationRate / 100) * (state.profile.filingStatus === 'married_joint' ? 201050 : 100525)).toLocaleString()}.\n                </>\n              ) : 'Loading inflation data...'}\n            </div>\n          </div>\n\n          {/* I-Bond Opportunity */}\n          <div style={{ padding: 12, background: 'var(--bg-hover)', borderRadius: 8 }}>\n            <div style={{ fontSize: 12, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 6 }}>\n              I-Bond Rate (Tax-Deferred)\n            </div>\n            <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.6 }}>\n              {macro?.iBondCompositeRate != null ? (\n                <>Estimated composite rate: <strong>{macro.iBondCompositeRate.toFixed(2)}%</strong>.\n                  I-Bonds are tax-deferred (no state tax). At your {(report.effectiveRate * 100).toFixed(0)}% effective rate,\n                  the after-tax yield beats savings accounts. $10K annual limit per person.\n                </>\n              ) : 'Loading I-Bond rate...'}\n            </div>\n          </div>\n\n          {/* Treasury vs Tax-Exempt */}\n          <div style={{ padding: 12, background: 'var(--bg-hover)', borderRadius: 8 }}>\n            <div style={{ fontSize: 12, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 6 }}>\n              Treasury vs Muni Bond Analysis\n            </div>\n            <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.6 }}>\n              {macro?.treasuryNoteRate != null ? (\n                <>T-Notes yield {macro.treasuryNoteRate.toFixed(2)}%. At your marginal rate,\n                  the tax-equivalent muni yield threshold is {((macro.treasuryNoteRate) / (1 - report.effectiveRate)).toFixed(2)}%.\n                  {report.effectiveRate > 0.22 && ' At your bracket, munis may offer better after-tax returns.'}\n                </>\n              ) : 'Loading treasury rates...'}\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Portfolio Quotes (if investments exist) */}\n      {quotes.size > 0 && (\n        <div style={sectionStyle}>\n          <h3 style={{ fontSize: 14, fontWeight: 600, color: 'var(--text-primary)', margin: '0 0 12px', fontFamily: 'var(--font-display)' }}>\n            📈 Portfolio Live Prices\n          </h3>\n          <div style={{ overflowX: 'auto' }}>\n            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 12 }}>\n              <thead>\n                <tr style={{ borderBottom: '1px solid var(--border-subtle)' }}>\n                  {['Symbol', 'Price', 'Change', 'Volume', '52W High', '52W Low'].map(h => (\n                    <th key={h} style={{ padding: '8px 12px', textAlign: 'left', fontSize: 10, color: 'var(--text-muted)', fontWeight: 500, textTransform: 'uppercase' }}>{h}</th>\n                  ))}\n                </tr>\n              </thead>\n              <tbody>\n                {Array.from(quotes.entries()).map(([symbol, quote]) => (\n                  <tr key={symbol} style={{ borderBottom: '1px solid var(--border-subtle)' }}>\n                    <td style={{ padding: '8px 12px', fontWeight: 600, fontFamily: 'var(--font-mono)' }}>{symbol}</td>\n                    <td style={{ padding: '8px 12px', fontFamily: 'var(--font-mono)' }}>${quote.price.toFixed(2)}</td>\n                    <td style={{ padding: '8px 12px', fontFamily: 'var(--font-mono)', color: quote.change >= 0 ? '#22c55e' : '#ef4444' }}>\n                      {quote.change >= 0 ? '+' : ''}{quote.change.toFixed(2)} ({quote.changePercent.toFixed(2)}%)\n                    </td>\n                    <td style={{ padding: '8px 12px', fontFamily: 'var(--font-mono)', color: 'var(--text-muted)' }}>\n                      {quote.volume?.toLocaleString() || '—'}\n                    </td>\n                    <td style={{ padding: '8px 12px', fontFamily: 'var(--font-mono)', color: 'var(--text-muted)' }}>\n                      {quote.high52Week?.toFixed(2) || '—'}\n                    </td>\n                    <td style={{ padding: '8px 12px', fontFamily: 'var(--font-mono)', color: 'var(--text-muted)' }}>\n                      {quote.low52Week?.toFixed(2) || '—'}\n                    </td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n        </div>\n      )}\n\n      {/* Exchange Rates */}\n      {rates && (\n        <div style={sectionStyle}>\n          <h3 style={{ fontSize: 14, fontWeight: 600, color: 'var(--text-primary)', margin: '0 0 12px', fontFamily: 'var(--font-display)' }}>\n            💱 Exchange Rates (USD Base)\n          </h3>\n          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(100px, 1fr))', gap: 8 }}>\n            {['EUR', 'GBP', 'CAD', 'JPY', 'AUD', 'CHF', 'CNY', 'INR', 'MXN', 'BRL', 'KRW', 'SGD'].map(currency => (\n              <div key={currency} style={{\n                padding: '8px 10px', background: 'var(--bg-hover)', borderRadius: 6, textAlign: 'center',\n              }}>\n                <div style={{ fontSize: 10, color: 'var(--text-muted)', marginBottom: 2 }}>{currency}</div>\n                <div style={{ fontSize: 13, fontWeight: 600, fontFamily: 'var(--font-mono)', color: 'var(--text-primary)' }}>\n                  {rates.rates[currency]?.toFixed(currency === 'JPY' || currency === 'KRW' ? 1 : 4) || '—'}\n                </div>\n              </div>\n            ))}\n          </div>\n          <p style={{ fontSize: 10, color: 'var(--text-muted)', marginTop: 8, fontStyle: 'italic' }}>\n            Used for Form 1116 foreign tax credit calculations. Rates update every 6 hours.\n          </p>\n        </div>\n      )}\n\n      {/* Data Sources */}\n      <div style={{ fontSize: 10, color: 'var(--text-muted)', textAlign: 'center', marginTop: 12 }}>\n        Sources: {macro?.sources.join(', ') || 'Federal Reserve (FRED), Bureau of Labor Statistics (BLS), Treasury Fiscal Data'}\n        {rates && ', Open Exchange Rate API'}\n        {quotes.size > 0 && ', Yahoo Finance'}\n        {' · '}All data free & public · No API keys required for core data\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\MultiYearTax.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'YearProjection' is defined but never used.","line":4,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":51,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"YearProjection"},"fix":{"range":[158,179],"text":""},"desc":"Remove unused variable \"YearProjection\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'IncomeShiftScenario' is defined but never used.","line":4,"column":58,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":77,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"IncomeShiftScenario"},"fix":{"range":[179,205],"text":""},"desc":"Remove unused variable \"IncomeShiftScenario\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'MultiYearInsight' is defined but never used.","line":4,"column":84,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":100,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"MultiYearInsight"},"fix":{"range":[205,228],"text":""},"desc":"Remove unused variable \"MultiYearInsight\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TrendingDown' is defined but never used.","line":6,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":27,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TrendingDown"},"fix":{"range":[284,298],"text":""},"desc":"Remove unused variable \"TrendingDown\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DollarSign' is defined but never used.","line":7,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":37,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DollarSign"},"fix":{"range":[356,368],"text":""},"desc":"Remove unused variable \"DollarSign\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Shield' is defined but never used.","line":7,"column":55,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":61,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Shield"},"fix":{"range":[384,392],"text":""},"desc":"Remove unused variable \"Shield\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ArrowUpRight' is defined but never used.","line":8,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":15,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ArrowUpRight"},"fix":{"range":[392,408],"text":""},"desc":"Remove unused variable \"ArrowUpRight\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ArrowDownRight' is defined but never used.","line":8,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":31,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ArrowDownRight"},"fix":{"range":[408,424],"text":""},"desc":"Remove unused variable \"ArrowDownRight\"."}]}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport type { ViewKey } from '../App'\nimport { runMultiYearAnalysis, type YearProjection, type IncomeShiftScenario, type MultiYearInsight } from '../engine/multi-year-tax'\nimport {\n  TrendingUp, TrendingDown, AlertTriangle, Lightbulb, Info,\n  ChevronRight, Calendar, DollarSign, BarChart3, Zap, Shield,\n  ArrowUpRight, ArrowDownRight,\n} from 'lucide-react'\n\ninterface MultiYearTaxViewProps {\n  onNavigate: (view: ViewKey) => void\n}\n\nconst fmt = (n: number) => '$' + Math.abs(n).toLocaleString()\nconst pct = (n: number) => (n * 100).toFixed(1) + '%'\n\nexport function MultiYearTaxView({ onNavigate }: MultiYearTaxViewProps) {\n  const { state } = useFortuna()\n  const [horizonYears, setHorizonYears] = useState(5)\n  const [selectedScenario, setSelectedScenario] = useState<string | null>(null)\n  const [activeTab, setActiveTab] = useState<'projection' | 'scenarios' | 'brackets' | 'insights'>('projection')\n\n  const analysis = useMemo(\n    () => runMultiYearAnalysis(state, horizonYears),\n    [state, horizonYears],\n  )\n\n  const hasData = state.incomeStreams.some(s => s.isActive && s.annualAmount > 0)\n\n  if (!hasData) {\n    return (\n      <div className=\"view-container\" style={{ padding: 32 }}>\n        <h2 className=\"view-title\">Multi-Year Tax Projection</h2>\n        <div className=\"glass-card\" style={{ padding: 32, textAlign: 'center' }}>\n          <Calendar size={40} color=\"var(--text-muted)\" style={{ marginBottom: 16 }} />\n          <p style={{ color: 'var(--text-secondary)' }}>Add income streams to generate multi-year projections.</p>\n          <button className=\"btn btn-primary\" onClick={() => onNavigate('setup')} style={{ marginTop: 16 }}>Set Up Income →</button>\n        </div>\n      </div>\n    )\n  }\n\n  const baseline = analysis.baseline\n  const totalTax = baseline.reduce((s, y) => s + y.totalTax, 0)\n  const totalIncome = baseline.reduce((s, y) => s + y.grossIncome, 0)\n  const maxAfterTax = Math.max(...baseline.map(y => y.afterTax))\n  const hasTcjaSunset = baseline.some(y => y.bracketRegime === 'pre_tcja')\n\n  const tabs = [\n    { id: 'projection' as const, label: 'Projection', icon: <TrendingUp size={14} /> },\n    { id: 'scenarios' as const, label: `Scenarios (${analysis.scenarios.length})`, icon: <Zap size={14} /> },\n    { id: 'brackets' as const, label: 'Brackets', icon: <BarChart3 size={14} /> },\n    { id: 'insights' as const, label: `Insights (${analysis.insights.length})`, icon: <Lightbulb size={14} /> },\n  ]\n\n  return (\n    <div className=\"view-container\" style={{ padding: 32 }}>\n      {/* Header */}\n      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 24 }}>\n        <div>\n          <h2 className=\"view-title\" style={{ marginBottom: 4 }}>Multi-Year Tax Projection</h2>\n          <p style={{ fontSize: 13, color: 'var(--text-muted)' }}>{horizonYears}-year forecast with TCJA sunset modeling and income shifting optimization</p>\n        </div>\n        <div style={{ display: 'flex', gap: 6 }}>\n          {[3, 5].map(n => (\n            <button\n              key={n}\n              onClick={() => setHorizonYears(n)}\n              className={`tab-btn ${horizonYears === n ? 'active' : ''}`}\n              style={{ padding: '6px 14px', fontSize: 12 }}\n            >{n} Years</button>\n          ))}\n        </div>\n      </div>\n\n      {/* KPI Cards */}\n      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 14, marginBottom: 24 }}>\n        <div className=\"glass-card\" style={{ padding: '16px 18px' }}>\n          <div style={{ fontSize: 10, fontFamily: 'var(--font-mono)', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 6 }}>{horizonYears}-Yr Total Tax</div>\n          <div style={{ fontSize: 22, fontWeight: 600, fontFamily: 'var(--font-mono)', color: 'var(--accent-red)' }}>{fmt(totalTax)}</div>\n          <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 4 }}>on {fmt(totalIncome)} income</div>\n        </div>\n        <div className=\"glass-card\" style={{ padding: '16px 18px' }}>\n          <div style={{ fontSize: 10, fontFamily: 'var(--font-mono)', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 6 }}>Blended Rate</div>\n          <div style={{ fontSize: 22, fontWeight: 600, fontFamily: 'var(--font-mono)', color: 'var(--text-primary)' }}>{pct(totalTax / totalIncome)}</div>\n          <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 4 }}>effective across {horizonYears} years</div>\n        </div>\n        <div className=\"glass-card\" style={{ padding: '16px 18px' }}>\n          <div style={{ fontSize: 10, fontFamily: 'var(--font-mono)', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 6 }}>Bracket Headroom</div>\n          <div style={{ fontSize: 22, fontWeight: 600, fontFamily: 'var(--font-mono)', color: 'var(--accent-emerald)' }}>{fmt(analysis.bracketHeadroom)}</div>\n          <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 4 }}>before next rate jump</div>\n        </div>\n        <div className=\"glass-card\" style={{ padding: '16px 18px', border: hasTcjaSunset ? '1px solid var(--accent-red-dim)' : undefined }}>\n          <div style={{ fontSize: 10, fontFamily: 'var(--font-mono)', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 6 }}>TCJA Sunset Impact</div>\n          <div style={{ fontSize: 22, fontWeight: 600, fontFamily: 'var(--font-mono)', color: analysis.tcjaSunsetImpact > 0 ? 'var(--accent-red)' : 'var(--text-muted)' }}>\n            {analysis.tcjaSunsetImpact > 0 ? `+${fmt(analysis.tcjaSunsetImpact)}` : 'N/A'}\n          </div>\n          <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 4 }}>{hasTcjaSunset ? 'annual tax increase' : 'within projection window'}</div>\n        </div>\n      </div>\n\n      {/* Tabs */}\n      <div style={{ display: 'flex', gap: 4, marginBottom: 20 }}>\n        {tabs.map(t => (\n          <button\n            key={t.id}\n            onClick={() => setActiveTab(t.id)}\n            className={`tab-btn ${activeTab === t.id ? 'active' : ''}`}\n            style={{ display: 'flex', alignItems: 'center', gap: 6, padding: '8px 16px' }}\n          >{t.icon} {t.label}</button>\n        ))}\n      </div>\n\n      {/* ── PROJECTION TAB ── */}\n      {activeTab === 'projection' && (\n        <div>\n          {/* Bar chart visualization */}\n          <div className=\"glass-card\" style={{ padding: 24, marginBottom: 20 }}>\n            <div style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)', marginBottom: 20 }}>Income & Tax Trajectory</div>\n            <div style={{ display: 'flex', alignItems: 'flex-end', gap: 12, height: 200 }}>\n              {baseline.map(yr => {\n                const incomeH = (yr.grossIncome / (maxAfterTax * 1.3)) * 180\n                const taxH = (yr.totalTax / (maxAfterTax * 1.3)) * 180\n                const isSunset = yr.bracketRegime === 'pre_tcja'\n\n                return (\n                  <div key={yr.year} style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 6 }}>\n                    <div style={{ fontSize: 10, fontFamily: 'var(--font-mono)', color: 'var(--accent-emerald)' }}>{fmt(yr.afterTax)}</div>\n                    <div style={{ position: 'relative', width: '100%', display: 'flex', gap: 4, justifyContent: 'center' }}>\n                      <div style={{\n                        width: '40%', height: incomeH, borderRadius: '6px 6px 0 0',\n                        background: 'linear-gradient(180deg, var(--accent-gold), #b8912e)',\n                        opacity: 0.8,\n                      }} />\n                      <div style={{\n                        width: '40%', height: taxH, borderRadius: '6px 6px 0 0',\n                        background: isSunset\n                          ? 'linear-gradient(180deg, var(--accent-red), #c0392b)'\n                          : 'linear-gradient(180deg, rgba(239,107,107,0.6), rgba(239,107,107,0.3))',\n                      }} />\n                    </div>\n                    <div style={{ textAlign: 'center' }}>\n                      <div style={{\n                        fontSize: 12, fontWeight: 600, color: 'var(--text-primary)',\n                        fontFamily: 'var(--font-mono)',\n                      }}>{yr.year}</div>\n                      {isSunset && (\n                        <div style={{ fontSize: 8, color: 'var(--accent-red)', fontFamily: 'var(--font-mono)', marginTop: 2 }}>POST-TCJA</div>\n                      )}\n                    </div>\n                  </div>\n                )\n              })}\n            </div>\n            <div style={{ display: 'flex', gap: 16, justifyContent: 'center', marginTop: 12 }}>\n              <div style={{ display: 'flex', alignItems: 'center', gap: 6, fontSize: 11, color: 'var(--text-muted)' }}>\n                <div style={{ width: 12, height: 12, borderRadius: 3, background: 'var(--accent-gold)' }} /> Gross Income\n              </div>\n              <div style={{ display: 'flex', alignItems: 'center', gap: 6, fontSize: 11, color: 'var(--text-muted)' }}>\n                <div style={{ width: 12, height: 12, borderRadius: 3, background: 'var(--accent-red)', opacity: 0.6 }} /> Total Tax\n              </div>\n            </div>\n          </div>\n\n          {/* Year-by-year table */}\n          <div className=\"glass-card\" style={{ padding: 20, overflow: 'auto' }}>\n            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 12 }}>\n              <thead>\n                <tr style={{ borderBottom: '1px solid var(--border-subtle)' }}>\n                  {['Year', 'Gross Income', 'Growth', 'Federal', 'SE Tax', 'State', 'Total Tax', 'Eff. Rate', 'Marginal', 'After Tax'].map(h => (\n                    <th key={h} style={{ padding: '8px 10px', textAlign: 'right', fontSize: 10, fontFamily: 'var(--font-mono)', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.08em' }}>\n                      {h}\n                    </th>\n                  ))}\n                </tr>\n              </thead>\n              <tbody>\n                {baseline.map((yr, i) => (\n                  <tr key={yr.year} style={{\n                    borderBottom: '1px solid var(--border-subtle)',\n                    background: yr.bracketRegime === 'pre_tcja' ? 'rgba(239,107,107,0.04)' : undefined,\n                  }}>\n                    <td style={{ padding: '10px', fontWeight: 600, fontFamily: 'var(--font-mono)', color: yr.bracketRegime === 'pre_tcja' ? 'var(--accent-red)' : 'var(--text-primary)' }}>\n                      {yr.year} {yr.bracketRegime === 'pre_tcja' && '⚠️'}\n                    </td>\n                    <td style={{ padding: '10px', textAlign: 'right', fontFamily: 'var(--font-mono)', color: 'var(--text-primary)' }}>{fmt(yr.grossIncome)}</td>\n                    <td style={{ padding: '10px', textAlign: 'right', fontFamily: 'var(--font-mono)', color: yr.growthRate > 0 ? 'var(--accent-emerald)' : 'var(--text-muted)' }}>\n                      {i === 0 ? '—' : `+${(yr.growthRate * 100).toFixed(1)}%`}\n                    </td>\n                    <td style={{ padding: '10px', textAlign: 'right', fontFamily: 'var(--font-mono)', color: 'var(--text-secondary)' }}>{fmt(yr.federalTax)}</td>\n                    <td style={{ padding: '10px', textAlign: 'right', fontFamily: 'var(--font-mono)', color: 'var(--text-secondary)' }}>{fmt(yr.seTax)}</td>\n                    <td style={{ padding: '10px', textAlign: 'right', fontFamily: 'var(--font-mono)', color: 'var(--text-secondary)' }}>{fmt(yr.stateTax)}</td>\n                    <td style={{ padding: '10px', textAlign: 'right', fontFamily: 'var(--font-mono)', fontWeight: 600, color: 'var(--accent-red)' }}>{fmt(yr.totalTax)}</td>\n                    <td style={{ padding: '10px', textAlign: 'right', fontFamily: 'var(--font-mono)', color: 'var(--text-primary)' }}>{pct(yr.effectiveRate)}</td>\n                    <td style={{ padding: '10px', textAlign: 'right', fontFamily: 'var(--font-mono)', color: yr.marginalRate >= 0.32 ? 'var(--accent-red)' : 'var(--text-primary)' }}>{pct(yr.marginalRate)}</td>\n                    <td style={{ padding: '10px', textAlign: 'right', fontFamily: 'var(--font-mono)', fontWeight: 600, color: 'var(--accent-emerald)' }}>{fmt(yr.afterTax)}</td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n        </div>\n      )}\n\n      {/* ── SCENARIOS TAB ── */}\n      {activeTab === 'scenarios' && (\n        <div>\n          {analysis.scenarios.length === 0 ? (\n            <div className=\"glass-card\" style={{ padding: 32, textAlign: 'center' }}>\n              <p style={{ color: 'var(--text-muted)' }}>No income shifting opportunities identified at current income levels.</p>\n            </div>\n          ) : (\n            <div style={{ display: 'flex', flexDirection: 'column', gap: 14 }}>\n              {analysis.scenarios.map(sc => {\n                const isOpen = selectedScenario === sc.id\n                const recColors: Record<string, string> = {\n                  strong: 'var(--accent-emerald)', moderate: 'var(--accent-gold)',\n                  neutral: 'var(--text-muted)', avoid: 'var(--accent-red)',\n                }\n                return (\n                  <div key={sc.id} className=\"glass-card\" style={{\n                    padding: '18px 20px', cursor: 'pointer',\n                    border: isOpen ? '1px solid var(--border-glow)' : undefined,\n                  }}\n                  onClick={() => setSelectedScenario(isOpen ? null : sc.id)}\n                  >\n                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\n                      <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>\n                        <div style={{\n                          width: 36, height: 36, borderRadius: 10, flexShrink: 0,\n                          background: `${recColors[sc.recommendation]}15`,\n                          display: 'flex', alignItems: 'center', justifyContent: 'center',\n                        }}>\n                          <Zap size={16} color={recColors[sc.recommendation]} />\n                        </div>\n                        <div>\n                          <div style={{ fontSize: 14, fontWeight: 500, color: 'var(--text-primary)', marginBottom: 3 }}>{sc.name}</div>\n                          <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n                            <span className={`badge ${sc.recommendation === 'strong' ? 'emerald' : sc.recommendation === 'moderate' ? 'gold' : 'muted'}`}>\n                              {sc.recommendation}\n                            </span>\n                            <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>{sc.shifts.length} year{sc.shifts.length !== 1 ? 's' : ''} affected</span>\n                          </div>\n                        </div>\n                      </div>\n                      <div style={{ textAlign: 'right' }}>\n                        <div style={{ fontSize: 18, fontWeight: 600, fontFamily: 'var(--font-mono)', color: 'var(--accent-emerald)' }}>\n                          {fmt(sc.totalTaxSavings)}\n                        </div>\n                        <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>tax savings</div>\n                      </div>\n                    </div>\n\n                    {isOpen && (\n                      <div style={{ marginTop: 16, paddingTop: 16, borderTop: '1px solid var(--border-subtle)' }}>\n                        <p style={{ fontSize: 13, color: 'var(--text-secondary)', lineHeight: 1.6, marginBottom: 12 }}>{sc.description}</p>\n                        <div style={{ padding: 14, borderRadius: 10, background: 'var(--bg-surface)', marginBottom: 12 }}>\n                          <div style={{ fontSize: 11, fontFamily: 'var(--font-mono)', color: 'var(--text-muted)', marginBottom: 8 }}>REASONING</div>\n                          <p style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.5 }}>{sc.reasoning}</p>\n                        </div>\n                        <div style={{ fontSize: 11, fontWeight: 500, color: 'var(--text-muted)', marginBottom: 8 }}>Income Shifts:</div>\n                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: 8 }}>\n                          {sc.shifts.map((sh, i) => (\n                            <div key={i} style={{\n                              padding: '6px 12px', borderRadius: 8,\n                              background: sh.shiftAmount > 0 ? 'var(--accent-emerald-dim)' : 'var(--accent-red-dim)',\n                              fontSize: 12, fontFamily: 'var(--font-mono)',\n                              color: sh.shiftAmount > 0 ? 'var(--accent-emerald)' : 'var(--accent-red)',\n                            }}>\n                              {sh.year}: {sh.shiftAmount > 0 ? '+' : ''}{fmt(sh.shiftAmount)} ({sh.shiftType.replace(/_/g, ' ')})\n                            </div>\n                          ))}\n                        </div>\n                      </div>\n                    )}\n                  </div>\n                )\n              })}\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* ── BRACKETS TAB ── */}\n      {activeTab === 'brackets' && baseline.length > 0 && (\n        <div>\n          <div style={{ display: 'grid', gridTemplateColumns: `repeat(${Math.min(baseline.length, 5)}, 1fr)`, gap: 14 }}>\n            {baseline.map(yr => (\n              <div key={yr.year} className=\"glass-card\" style={{ padding: 16 }}>\n                <div style={{\n                  fontSize: 14, fontWeight: 600, fontFamily: 'var(--font-mono)',\n                  color: yr.bracketRegime === 'pre_tcja' ? 'var(--accent-red)' : 'var(--text-primary)',\n                  marginBottom: 12,\n                }}>\n                  {yr.year} {yr.bracketRegime === 'pre_tcja' && '⚠️'}\n                </div>\n                <div style={{ display: 'flex', flexDirection: 'column', gap: 4 }}>\n                  {yr.bracketUtilization.filter(b => b.capacity < 400000).map((b, i) => (\n                    <div key={i}>\n                      <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 10, fontFamily: 'var(--font-mono)', color: 'var(--text-muted)', marginBottom: 2 }}>\n                        <span>{(b.rate * 100).toFixed(0)}%</span>\n                        <span>{b.utilization > 0 ? fmt(b.filled) : '—'}</span>\n                      </div>\n                      <div style={{ height: 6, borderRadius: 3, background: 'var(--bg-surface)', overflow: 'hidden' }}>\n                        <div style={{\n                          height: '100%', borderRadius: 3,\n                          width: `${Math.min(100, b.utilization * 100)}%`,\n                          background: b.utilization >= 0.9 ? 'var(--accent-red)'\n                            : b.utilization >= 0.5 ? 'var(--accent-gold)'\n                            : 'var(--accent-emerald)',\n                          transition: 'width 0.5s ease-out',\n                        }} />\n                      </div>\n                    </div>\n                  ))}\n                </div>\n                <div style={{ marginTop: 10, fontSize: 11, fontFamily: 'var(--font-mono)', color: 'var(--text-muted)' }}>\n                  Marginal: <span style={{ color: yr.marginalRate >= 0.32 ? 'var(--accent-red)' : 'var(--text-primary)', fontWeight: 600 }}>{pct(yr.marginalRate)}</span>\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {/* ── INSIGHTS TAB ── */}\n      {activeTab === 'insights' && (\n        <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>\n          {analysis.insights.map((ins, i) => {\n            const typeConfig: Record<string, { icon: React.ReactNode; color: string }> = {\n              warning: { icon: <AlertTriangle size={16} />, color: 'var(--accent-red)' },\n              opportunity: { icon: <Lightbulb size={16} />, color: 'var(--accent-emerald)' },\n              info: { icon: <Info size={16} />, color: 'var(--accent-blue)' },\n            }\n            const cfg = typeConfig[ins.type] || typeConfig.info\n\n            return (\n              <div key={i} className=\"glass-card\" style={{ padding: '16px 20px', display: 'flex', gap: 14, alignItems: 'flex-start' }}>\n                <div style={{\n                  width: 32, height: 32, borderRadius: 10, flexShrink: 0,\n                  background: `${cfg.color}15`, display: 'flex', alignItems: 'center', justifyContent: 'center',\n                  color: cfg.color,\n                }}>\n                  {cfg.icon}\n                </div>\n                <div style={{ flex: 1 }}>\n                  <div style={{ fontSize: 14, fontWeight: 500, color: 'var(--text-primary)', marginBottom: 4 }}>{ins.title}</div>\n                  <p style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.5, margin: 0 }}>{ins.detail}</p>\n                </div>\n                {ins.impact != null && ins.impact > 0 && (\n                  <div style={{ textAlign: 'right', flexShrink: 0 }}>\n                    <div style={{ fontSize: 16, fontWeight: 600, fontFamily: 'var(--font-mono)', color: cfg.color }}>{fmt(ins.impact)}</div>\n                    <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>impact</div>\n                  </div>\n                )}\n                {ins.actionView && (\n                  <button\n                    onClick={e => { e.stopPropagation(); onNavigate(ins.actionView as ViewKey) }}\n                    style={{\n                      background: 'none', border: '1px solid var(--border-subtle)', borderRadius: 6,\n                      padding: '5px 10px', cursor: 'pointer', fontSize: 11, color: 'var(--text-secondary)',\n                      fontFamily: 'var(--font-body)', whiteSpace: 'nowrap', flexShrink: 0,\n                    }}\n                  >\n                    View <ChevronRight size={11} style={{ verticalAlign: 'middle' }} />\n                  </button>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\NexusView.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'RefreshCw' is defined but never used.","line":16,"column":52,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":61,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"RefreshCw"},"fix":{"range":[667,678],"text":""},"desc":"Remove unused variable \"RefreshCw\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — Intelligence Nexus View\n *\n * Surfaces cross-engine compound insights. Each insight shows\n * which engines contributed, the dollar impact, and drill-through\n * actions to the relevant views.\n */\n\nimport { useState, useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { runUnifiedIntelligence, type NexusInsight, type UnifiedIntelligence } from '../engine/unified-intelligence'\nimport { useNavigation, RelatedViews, ViewBreadcrumb } from '../context/NavigationContext'\nimport type { ViewKey } from '../App'\nimport {\n  Brain, Zap, Clock, Building2, Shield, TrendingUp,\n  ChevronDown, ChevronRight, ArrowRight, Sparkles, RefreshCw,\n  Target, Layers, DollarSign, AlertTriangle\n} from 'lucide-react'\n\nconst CATEGORY_META: Record<string, { label: string; color: string; icon: typeof Brain }> = {\n  compound_savings: { label: 'Compound Savings', color: '#22c55e', icon: DollarSign },\n  timing:           { label: 'Timing Advantage', color: '#f59e0b', icon: Clock },\n  structural:       { label: 'Structural Change', color: '#6366f1', icon: Building2 },\n  risk_mitigation:  { label: 'Risk Mitigation',  color: '#ef4444', icon: Shield },\n  growth:           { label: 'Growth Strategy',   color: '#06b6d4', icon: TrendingUp },\n}\n\nconst PRIORITY_COLORS: Record<string, string> = {\n  critical: '#ef4444',\n  high: '#f59e0b',\n  medium: '#3b82f6',\n  low: '#6b7280',\n}\n\nfunction InsightCard({ insight, onNavigate }: { insight: NexusInsight; onNavigate: (v: ViewKey) => void }) {\n  const [expanded, setExpanded] = useState(false)\n  const cat = CATEGORY_META[insight.category] || CATEGORY_META.compound_savings\n  const CatIcon = cat.icon\n\n  return (\n    <div style={{\n      background: 'var(--bg-card)',\n      borderRadius: 12,\n      border: `1px solid ${PRIORITY_COLORS[insight.priority]}33`,\n      overflow: 'hidden',\n      transition: 'all 0.2s',\n    }}>\n      {/* Header */}\n      <div\n        style={{\n          padding: '16px 20px',\n          cursor: 'pointer',\n          display: 'flex',\n          alignItems: 'flex-start',\n          gap: 14,\n        }}\n        onClick={() => setExpanded(!expanded)}\n      >\n        <div style={{\n          width: 40, height: 40, borderRadius: 10,\n          background: `${cat.color}15`,\n          border: `1px solid ${cat.color}30`,\n          display: 'flex', alignItems: 'center', justifyContent: 'center',\n          flexShrink: 0,\n        }}>\n          <CatIcon size={18} style={{ color: cat.color }} />\n        </div>\n\n        <div style={{ flex: 1, minWidth: 0 }}>\n          <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>\n            <span style={{\n              fontSize: 10, fontWeight: 600, textTransform: 'uppercase',\n              padding: '2px 8px', borderRadius: 4, letterSpacing: '0.05em',\n              background: `${PRIORITY_COLORS[insight.priority]}20`,\n              color: PRIORITY_COLORS[insight.priority],\n            }}>\n              {insight.priority}\n            </span>\n            <span style={{ fontSize: 10, color: 'var(--text-muted)' }}>\n              {cat.label}\n            </span>\n          </div>\n          <div style={{ fontSize: 15, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 4 }}>\n            {insight.title}\n          </div>\n          <div style={{ fontSize: 13, color: 'var(--text-secondary)', lineHeight: 1.5 }}>\n            {insight.description}\n          </div>\n        </div>\n\n        <div style={{ textAlign: 'right', flexShrink: 0 }}>\n          <div style={{\n            fontSize: 20, fontWeight: 700,\n            fontFamily: 'var(--font-mono)',\n            color: '#22c55e',\n          }}>\n            ${insight.impact.toLocaleString()}\n          </div>\n          <div style={{ fontSize: 10, color: 'var(--text-muted)', marginTop: 2 }}>potential savings</div>\n          <div style={{ marginTop: 8, color: 'var(--text-muted)' }}>\n            {expanded ? <ChevronDown size={16} /> : <ChevronRight size={16} />}\n          </div>\n        </div>\n      </div>\n\n      {/* Expanded detail */}\n      {expanded && (\n        <div style={{\n          borderTop: '1px solid var(--border-subtle)',\n          padding: '16px 20px',\n          background: 'rgba(0,0,0,0.15)',\n        }}>\n          {/* Reasoning */}\n          <div style={{\n            fontSize: 13, color: 'var(--text-secondary)', lineHeight: 1.6,\n            marginBottom: 16, padding: '12px 14px',\n            background: 'rgba(255,255,255,0.03)',\n            borderRadius: 8, borderLeft: `3px solid ${cat.color}40`,\n          }}>\n            {insight.reasoning}\n          </div>\n\n          {/* Engines involved */}\n          <div style={{ marginBottom: 16 }}>\n            <div style={{ fontSize: 11, color: 'var(--text-muted)', marginBottom: 6, textTransform: 'uppercase', letterSpacing: '0.08em' }}>\n              Engines Cross-Referenced\n            </div>\n            <div style={{ display: 'flex', gap: 6, flexWrap: 'wrap' }}>\n              {insight.engines.map(eng => (\n                <span key={eng} style={{\n                  fontSize: 11, padding: '3px 8px', borderRadius: 4,\n                  background: 'rgba(99,102,241,0.15)',\n                  color: '#818cf8',\n                  fontFamily: 'var(--font-mono)',\n                }}>\n                  {eng}\n                </span>\n              ))}\n            </div>\n          </div>\n\n          {/* Actions */}\n          <div>\n            <div style={{ fontSize: 11, color: 'var(--text-muted)', marginBottom: 8, textTransform: 'uppercase', letterSpacing: '0.08em' }}>\n              Take Action\n            </div>\n            <div style={{ display: 'flex', flexDirection: 'column', gap: 6 }}>\n              {insight.actions.map((action, i) => (\n                <button\n                  key={i}\n                  onClick={(e) => {\n                    e.stopPropagation()\n                    onNavigate(action.view as ViewKey)\n                  }}\n                  style={{\n                    display: 'flex', alignItems: 'center', gap: 10,\n                    padding: '10px 14px', borderRadius: 8,\n                    background: 'rgba(255,255,255,0.04)',\n                    border: '1px solid var(--border-subtle)',\n                    cursor: 'pointer', textAlign: 'left',\n                    transition: 'all 0.15s',\n                  }}\n                  onMouseEnter={e => {\n                    e.currentTarget.style.background = 'rgba(99,102,241,0.1)'\n                    e.currentTarget.style.borderColor = 'rgba(99,102,241,0.3)'\n                  }}\n                  onMouseLeave={e => {\n                    e.currentTarget.style.background = 'rgba(255,255,255,0.04)'\n                    e.currentTarget.style.borderColor = 'var(--border-subtle)'\n                  }}\n                >\n                  <ArrowRight size={14} style={{ color: '#818cf8', flexShrink: 0 }} />\n                  <div>\n                    <div style={{ fontSize: 13, fontWeight: 600, color: 'var(--text-primary)' }}>\n                      {action.label}\n                    </div>\n                    <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 2 }}>\n                      {action.detail}\n                    </div>\n                  </div>\n                </button>\n              ))}\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  )\n}\n\nexport function NexusView() {\n  const { state } = useFortuna()\n  const { navigate } = useNavigation()\n  const [filterPriority, setFilterPriority] = useState<string>('all')\n\n  const intel: UnifiedIntelligence | null = useMemo(() => {\n    try {\n      return runUnifiedIntelligence(state)\n    } catch {\n      return null\n    }\n  }, [state])\n\n  if (!intel) {\n    return (\n      <div style={{ padding: 32 }}>\n        <h2 style={{ color: 'var(--text-primary)' }}>Intelligence Nexus</h2>\n        <p style={{ color: 'var(--text-muted)' }}>Unable to run intelligence pipeline. Add income data to get started.</p>\n      </div>\n    )\n  }\n\n  const insights = filterPriority === 'all'\n    ? intel.nexusInsights\n    : intel.nexusInsights.filter(n => n.priority === filterPriority)\n\n  return (\n    <div style={{ padding: '24px 32px', maxWidth: 900, margin: '0 auto' }}>\n      <ViewBreadcrumb viewKey=\"nexus\" />\n\n      {/* Header */}\n      <div style={{ display: 'flex', alignItems: 'flex-start', justifyContent: 'space-between', marginBottom: 24 }}>\n        <div>\n          <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 6 }}>\n            <Brain size={24} style={{ color: '#818cf8' }} />\n            <h1 style={{ fontSize: 24, fontWeight: 700, color: 'var(--text-primary)', margin: 0 }}>\n              Intelligence Nexus\n            </h1>\n          </div>\n          <p style={{ fontSize: 14, color: 'var(--text-secondary)', margin: 0 }}>\n            Cross-engine compound insights — opportunities that only emerge when all {intel.enginesCrossReferenced} engines analyze together.\n          </p>\n        </div>\n      </div>\n\n      {/* Summary KPIs */}\n      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 12, marginBottom: 24 }}>\n        {[\n          { label: 'Compound Savings', value: `$${intel.totalCompoundSavings.toLocaleString()}`, icon: DollarSign, color: '#22c55e' },\n          { label: 'Insights Found', value: `${intel.insightsGenerated}`, icon: Sparkles, color: '#818cf8' },\n          { label: 'Engines Chained', value: `${intel.enginesCrossReferenced}`, icon: Layers, color: '#06b6d4' },\n          {\n            label: 'Critical Actions',\n            value: `${intel.nexusInsights.filter(n => n.priority === 'critical').length}`,\n            icon: AlertTriangle,\n            color: '#ef4444',\n          },\n        ].map((kpi, i) => (\n          <div key={i} style={{\n            background: 'var(--bg-card)',\n            borderRadius: 10,\n            padding: '14px 16px',\n            border: '1px solid var(--border-subtle)',\n          }}>\n            <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 6 }}>\n              <kpi.icon size={14} style={{ color: kpi.color }} />\n              <span style={{ fontSize: 11, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.05em' }}>\n                {kpi.label}\n              </span>\n            </div>\n            <div style={{ fontSize: 22, fontWeight: 700, fontFamily: 'var(--font-mono)', color: kpi.color }}>\n              {kpi.value}\n            </div>\n          </div>\n        ))}\n      </div>\n\n      {/* Filter */}\n      <div style={{ display: 'flex', gap: 6, marginBottom: 20 }}>\n        {['all', 'critical', 'high', 'medium', 'low'].map(p => (\n          <button\n            key={p}\n            onClick={() => setFilterPriority(p)}\n            style={{\n              fontSize: 12, padding: '5px 12px', borderRadius: 6,\n              background: filterPriority === p ? 'rgba(99,102,241,0.2)' : 'rgba(255,255,255,0.04)',\n              border: `1px solid ${filterPriority === p ? 'rgba(99,102,241,0.4)' : 'var(--border-subtle)'}`,\n              color: filterPriority === p ? '#818cf8' : 'var(--text-muted)',\n              cursor: 'pointer', textTransform: 'capitalize',\n            }}\n          >\n            {p} {p !== 'all' && `(${intel.nexusInsights.filter(n => n.priority === p).length})`}\n          </button>\n        ))}\n      </div>\n\n      {/* Insight Cards */}\n      {insights.length === 0 ? (\n        <div style={{\n          textAlign: 'center', padding: 48,\n          background: 'var(--bg-card)', borderRadius: 12,\n          border: '1px solid var(--border-subtle)',\n        }}>\n          <Target size={32} style={{ color: 'var(--text-muted)', marginBottom: 12 }} />\n          <div style={{ fontSize: 15, color: 'var(--text-secondary)', marginBottom: 8 }}>\n            {filterPriority === 'all'\n              ? 'No cross-engine insights detected yet'\n              : `No ${filterPriority} priority insights`}\n          </div>\n          <div style={{ fontSize: 13, color: 'var(--text-muted)' }}>\n            Add more financial data — income, expenses, entities — to unlock compound optimization opportunities.\n          </div>\n        </div>\n      ) : (\n        <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>\n          {insights.map(insight => (\n            <InsightCard key={insight.id} insight={insight} onNavigate={navigate} />\n          ))}\n        </div>\n      )}\n\n      {/* Quick actions */}\n      {intel.nexusInsights.length > 0 && (\n        <div style={{\n          marginTop: 24, padding: 16,\n          background: 'rgba(99,102,241,0.05)',\n          borderRadius: 10,\n          border: '1px solid rgba(99,102,241,0.15)',\n          display: 'flex', alignItems: 'center', gap: 12,\n        }}>\n          <Zap size={18} style={{ color: '#818cf8' }} />\n          <div style={{ flex: 1 }}>\n            <div style={{ fontSize: 13, fontWeight: 600, color: 'var(--text-primary)' }}>\n              Top Priority: {intel.nexusInsights[0].title}\n            </div>\n            <div style={{ fontSize: 12, color: 'var(--text-muted)' }}>\n              Start here for maximum impact — ${intel.nexusInsights[0].impact.toLocaleString()} potential savings\n            </div>\n          </div>\n          {intel.topPriorityAction && (\n            <button\n              onClick={() => navigate(intel.topPriorityAction!.view as ViewKey)}\n              style={{\n                fontSize: 12, padding: '8px 16px', borderRadius: 8,\n                background: 'rgba(99,102,241,0.2)',\n                border: '1px solid rgba(99,102,241,0.4)',\n                color: '#818cf8', cursor: 'pointer',\n                display: 'flex', alignItems: 'center', gap: 6,\n              }}\n            >\n              {intel.topPriorityAction.label} <ArrowRight size={14} />\n            </button>\n          )}\n        </div>\n      )}\n\n      <RelatedViews currentView=\"nexus\" />\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\PaycheckSimulator.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ArrowDown' is defined but never used.","line":5,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":32,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ArrowDown"},"fix":{"range":[231,242],"text":""},"desc":"Remove unused variable \"ArrowDown\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Shield' is defined but never used.","line":6,"column":60,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":66,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Shield"},"fix":{"range":[329,337],"text":""},"desc":"Remove unused variable \"Shield\"."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { simulateAllPaychecks, type PayFrequency, type PaycheckBreakdown } from '../engine/paycheck-simulator'\nimport {\n  Wallet, DollarSign, ArrowDown, ChevronDown, AlertTriangle,\n  Building2, TrendingDown, Percent, CreditCard, PiggyBank, Shield\n} from 'lucide-react'\nimport { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell } from 'recharts'\n\nfunction fmt(n: number): string { return `$${Math.round(n).toLocaleString()}` }\n\nconst FREQ_LABELS: Record<PayFrequency, string> = {\n  weekly: 'Weekly', biweekly: 'Every 2 Weeks', semimonthly: 'Twice a Month', monthly: 'Monthly',\n}\n\nexport function PaycheckSimulator() {\n  const { state } = useFortuna()\n  const [frequency, setFrequency] = useState<PayFrequency>('biweekly')\n  const paychecks = useMemo(() => simulateAllPaychecks(state, frequency), [state, frequency])\n  const hasW2 = paychecks.length > 0\n\n  if (!hasW2) {\n    return (\n      <div className=\"view-enter\" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '50vh' }}>\n        <div style={{ textAlign: 'center', maxWidth: 400 }}>\n          <Wallet size={32} color=\"var(--accent-gold)\" style={{ marginBottom: 12 }} />\n          <h2 style={{ fontFamily: 'var(--font-display)', marginBottom: 8 }}>Paycheck Simulator</h2>\n          <p style={{ fontSize: 13, color: 'var(--text-muted)' }}>Add W-2 income streams to simulate your paycheck breakdown.</p>\n        </div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"view-enter\">\n      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 24 }}>\n        <div>\n          <h1 className=\"section-title\">Paycheck Simulator</h1>\n          <p className=\"section-subtitle\">See exactly where every dollar of your paycheck goes</p>\n        </div>\n        <div style={{ display: 'flex', gap: 4, background: 'var(--bg-surface)', borderRadius: 10, padding: 3, border: '1px solid var(--border-subtle)' }}>\n          {(Object.keys(FREQ_LABELS) as PayFrequency[]).map(f => (\n            <button key={f} onClick={() => setFrequency(f)}\n              style={{ padding: '6px 12px', borderRadius: 8, border: 'none', fontSize: 11, fontWeight: 500, cursor: 'pointer',\n                background: frequency === f ? 'var(--accent-gold)' : 'transparent',\n                color: frequency === f ? '#0c0e12' : 'var(--text-muted)' }}>\n              {FREQ_LABELS[f]}\n            </button>\n          ))}\n        </div>\n      </div>\n\n      {paychecks.map(pc => <PaycheckCard key={pc.streamId} pc={pc} />)}\n    </div>\n  )\n}\n\nfunction PaycheckCard({ pc }: { pc: PaycheckBreakdown }) {\n  const [expanded, setExpanded] = useState(true)\n\n  const waterfall = [\n    { label: 'Gross Pay', amount: pc.grossPay, color: '#10b981', running: pc.grossPay },\n    ...(pc.pretax401k > 0 ? [{ label: '401(k)', amount: -pc.pretax401k, color: '#a78bfa', running: pc.grossPay - pc.pretax401k }] : []),\n    ...(pc.pretaxHealth > 0 ? [{ label: 'Health Ins.', amount: -pc.pretaxHealth, color: '#60a5fa', running: pc.grossPay - pc.pretax401k - pc.pretaxHealth }] : []),\n    ...(pc.pretaxHSA > 0 ? [{ label: 'HSA', amount: -pc.pretaxHSA, color: '#38bdf8', running: pc.taxableWages + pc.pretaxHSA }] : []),\n    { label: 'Taxable Wages', amount: pc.taxableWages, color: '#d4a843', running: pc.taxableWages },\n    { label: 'Federal Tax', amount: -pc.federalWithholding, color: '#ef4444', running: pc.taxableWages - pc.federalWithholding },\n    { label: 'State Tax', amount: -pc.stateWithholding, color: '#f97316', running: pc.taxableWages - pc.federalWithholding - pc.stateWithholding },\n    { label: 'Social Security', amount: -pc.socialSecurity, color: '#8b5cf6', running: pc.taxableWages - pc.federalWithholding - pc.stateWithholding - pc.socialSecurity },\n    { label: 'Medicare', amount: -pc.medicare, color: '#ec4899', running: pc.netPay },\n    { label: 'Net Pay', amount: pc.netPay, color: '#10b981', running: pc.netPay },\n  ]\n\n  const chartData = waterfall.filter(w => w.amount !== 0).map(w => ({\n    name: w.label, value: Math.abs(w.amount), fill: w.color, isDeduction: w.amount < 0,\n  }))\n\n  return (\n    <div className=\"card\" style={{ marginBottom: 20 }}>\n      <div className=\"card-header\" style={{ cursor: 'pointer' }} onClick={() => setExpanded(!expanded)}>\n        <div>\n          <span className=\"card-title\" style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n            <Building2 size={16} /> {pc.employerName}\n          </span>\n          <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 2 }}>{FREQ_LABELS[pc.payFrequency]} · {pc.periodsPerYear} pay periods/yr</div>\n        </div>\n        <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>\n          <div style={{ textAlign: 'right' }}>\n            <div style={{ fontFamily: 'var(--font-mono)', fontSize: 20, fontWeight: 600, color: 'var(--accent-emerald)' }}>{fmt(pc.netPay)}</div>\n            <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>net per paycheck</div>\n          </div>\n          <ChevronDown size={14} color=\"var(--text-muted)\" style={{ transform: expanded ? 'rotate(180deg)' : 'none', transition: 'transform 0.2s' }} />\n        </div>\n      </div>\n\n      {expanded && (\n        <div className=\"card-body\">\n          {/* KPI Row */}\n          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: 10, marginBottom: 20 }}>\n            {[\n              { label: 'Gross', value: fmt(pc.grossPay), color: 'var(--accent-gold)', icon: <DollarSign size={13} /> },\n              { label: 'Pre-tax', value: fmt(pc.totalPretax), color: 'var(--accent-purple)', icon: <PiggyBank size={13} /> },\n              { label: 'Taxes', value: fmt(pc.totalTaxes), color: 'var(--accent-red)', icon: <TrendingDown size={13} /> },\n              { label: 'Take-Home Rate', value: `${(pc.takeHomeRate * 100).toFixed(1)}%`, color: 'var(--accent-emerald)', icon: <Percent size={13} /> },\n              { label: 'Annual Net', value: fmt(pc.annualNet), color: 'var(--accent-blue)', icon: <CreditCard size={13} /> },\n            ].map((kpi, i) => (\n              <div key={i} style={{ padding: '10px 12px', borderRadius: 8, background: 'var(--bg-primary)', textAlign: 'center' }}>\n                <div style={{ color: kpi.color, marginBottom: 4 }}>{kpi.icon}</div>\n                <div style={{ fontFamily: 'var(--font-mono)', fontSize: 14, fontWeight: 600, color: kpi.color }}>{kpi.value}</div>\n                <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>{kpi.label}</div>\n              </div>\n            ))}\n          </div>\n\n          {/* Paycheck Waterfall */}\n          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>\n            <div>\n              <div style={{ fontSize: 12, fontWeight: 500, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 12 }}>Paycheck Waterfall</div>\n              {waterfall.filter(w => w.amount !== 0).map((item, i) => {\n                const pct = pc.grossPay > 0 ? Math.abs(item.amount) / pc.grossPay * 100 : 0\n                const isNet = item.label === 'Net Pay' || item.label === 'Gross Pay' || item.label === 'Taxable Wages'\n                return (\n                  <div key={i} style={{ display: 'flex', alignItems: 'center', gap: 10, padding: '6px 0',\n                    borderBottom: isNet ? '1px solid var(--border-medium)' : '1px solid var(--border-subtle)' }}>\n                    <div style={{ width: 8, height: 8, borderRadius: 4, background: item.color, flexShrink: 0 }} />\n                    <span style={{ flex: 1, fontSize: 12, color: isNet ? 'var(--text-primary)' : 'var(--text-secondary)', fontWeight: isNet ? 600 : 400 }}>{item.label}</span>\n                    <div style={{ width: 60, height: 4, borderRadius: 2, background: 'var(--bg-hover)', flexShrink: 0 }}>\n                      <div style={{ width: `${Math.min(100, pct)}%`, height: '100%', borderRadius: 2, background: item.color }} />\n                    </div>\n                    <span style={{ fontFamily: 'var(--font-mono)', fontSize: 12, fontWeight: isNet ? 600 : 400, color: item.amount < 0 ? 'var(--accent-red)' : 'var(--text-primary)', minWidth: 70, textAlign: 'right' }}>\n                      {item.amount < 0 ? '-' : ''}{fmt(Math.abs(item.amount))}\n                    </span>\n                  </div>\n                )\n              })}\n            </div>\n\n            {/* Visual chart */}\n            <div>\n              <div style={{ fontSize: 12, fontWeight: 500, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 12 }}>Breakdown</div>\n              <ResponsiveContainer width=\"100%\" height={280}>\n                <BarChart data={chartData} layout=\"vertical\" margin={{ left: 0, right: 10 }}>\n                  <XAxis type=\"number\" tickFormatter={v => `$${v}`} tick={{ fill: 'var(--text-muted)', fontSize: 10 }} />\n                  <YAxis dataKey=\"name\" type=\"category\" width={90} tick={{ fill: 'var(--text-muted)', fontSize: 10 }} />\n                  <Tooltip formatter={(v: number) => fmt(v)} contentStyle={{ background: '#1a1d24', border: '1px solid #2a2d35', borderRadius: 8 }} />\n                  <Bar dataKey=\"value\" radius={[0, 4, 4, 0]}>\n                    {chartData.map((d, i) => <Cell key={i} fill={d.fill} opacity={d.isDeduction ? 0.7 : 1} />)}\n                  </Bar>\n                </BarChart>\n              </ResponsiveContainer>\n            </div>\n          </div>\n\n          {/* Employer total cost */}\n          <div style={{ marginTop: 16, padding: '12px 16px', borderRadius: 10, background: 'var(--bg-primary)', border: '1px solid var(--border-subtle)' }}>\n            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\n              <div>\n                <div style={{ fontSize: 11, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.06em' }}>Total Employer Cost</div>\n                <div style={{ fontSize: 10, color: 'var(--text-muted)', marginTop: 2 }}>Your salary + employer FICA + 401k match</div>\n              </div>\n              <div style={{ fontFamily: 'var(--font-mono)', fontSize: 18, fontWeight: 600, color: 'var(--accent-gold)' }}>\n                {fmt(pc.totalCompensation)}<span style={{ fontSize: 11, color: 'var(--text-muted)', fontWeight: 400 }}>/yr</span>\n              </div>\n            </div>\n            <div style={{ display: 'flex', gap: 16, marginTop: 8, fontSize: 11, color: 'var(--text-muted)' }}>\n              <span>Salary: {fmt(pc.annualGross)}</span>\n              <span>Employer FICA: {fmt(pc.employerFICA * pc.periodsPerYear)}</span>\n              {pc.employer401kMatch > 0 && <span>401k Match: {fmt(pc.employer401kMatch * pc.periodsPerYear)}</span>}\n            </div>\n          </div>\n\n          {/* Discrepancies */}\n          {pc.discrepancies.length > 0 && (\n            <div style={{ marginTop: 16 }}>\n              {pc.discrepancies.map((d, i) => (\n                <div key={i} style={{ display: 'flex', alignItems: 'flex-start', gap: 8, padding: '8px 12px', marginBottom: 4,\n                  borderRadius: 8, background: d.severity === 'alert' ? 'rgba(239,68,68,0.08)' : 'rgba(245,158,11,0.08)',\n                  border: `1px solid ${d.severity === 'alert' ? 'rgba(239,68,68,0.15)' : 'rgba(245,158,11,0.15)'}` }}>\n                  <AlertTriangle size={14} color={d.severity === 'alert' ? '#ef4444' : '#f59e0b'} style={{ marginTop: 1, flexShrink: 0 }} />\n                  <div>\n                    <div style={{ fontSize: 12, fontWeight: 500, color: 'var(--text-primary)' }}>{d.field}</div>\n                    <div style={{ fontSize: 11, color: 'var(--text-secondary)' }}>{d.message}</div>\n                    <div style={{ fontSize: 10, color: 'var(--text-muted)', fontFamily: 'var(--font-mono)', marginTop: 2 }}>\n                      Expected: {fmt(d.expected)} · Entered: {fmt(d.actual)}\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\PnLView.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ArrowRight' is defined but never used.","line":13,"column":46,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":56,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ArrowRight"},"fix":{"range":[492,504],"text":""},"desc":"Remove unused variable \"ArrowRight\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DollarSign' is defined but never used.","line":14,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":13,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DollarSign"},"fix":{"range":[504,518],"text":""},"desc":"Remove unused variable \"DollarSign\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Percent' is defined but never used.","line":14,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":22,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Percent"},"fix":{"range":[518,527],"text":""},"desc":"Remove unused variable \"Percent\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'navigate' is assigned a value but never used.","line":111,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":111,"endColumn":19}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — P&L Statement View\n *\n * Professional income statement with period-over-period comparison,\n * margin visualization, and actionable insights.\n */\n\nimport { useMemo, useState } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { generatePnL, type PnLLineItem, type PnLStatement } from '../engine/pnl-engine'\nimport { useNavigation, RelatedViews, ViewBreadcrumb } from '../context/NavigationContext'\nimport {\n  FileText, TrendingUp, TrendingDown, Minus, ArrowRight,\n  DollarSign, Percent, BarChart3, Lightbulb\n} from 'lucide-react'\n\nfunction fmt(n: number): string {\n  if (n < 0) return `($${Math.abs(n).toLocaleString()})`\n  return `$${n.toLocaleString()}`\n}\n\nfunction pct(n: number): string {\n  return `${(n * 100).toFixed(1)}%`\n}\n\nfunction ChangeIndicator({ current, previous }: { current: number; previous: number }) {\n  if (previous === 0) return <span style={{ color: 'var(--text-muted)', fontSize: 11 }}>—</span>\n  const change = (current - previous) / Math.abs(previous)\n  const positive = change >= 0\n  const Icon = change > 0.01 ? TrendingUp : change < -0.01 ? TrendingDown : Minus\n  return (\n    <span style={{\n      fontSize: 11, display: 'inline-flex', alignItems: 'center', gap: 3,\n      color: positive ? '#22c55e' : '#ef4444',\n    }}>\n      <Icon size={11} />\n      {Math.abs(change * 100).toFixed(1)}%\n    </span>\n  )\n}\n\nfunction LineItemRow({ item, showPrevious }: { item: PnLLineItem; showPrevious: boolean }) {\n  const isHighlight = item.isSubtotal || item.isTotal\n\n  return (\n    <tr style={{\n      fontWeight: isHighlight ? 700 : 400,\n      borderTop: item.isSubtotal ? '1px solid var(--border-subtle)' : undefined,\n      borderBottom: item.isTotal ? '2px solid var(--text-muted)' : undefined,\n    }}>\n      <td style={{\n        padding: '8px 12px',\n        paddingLeft: item.indent ? 12 + item.indent * 20 : 12,\n        color: isHighlight ? 'var(--text-primary)' : 'var(--text-secondary)',\n        fontSize: isHighlight ? 14 : 13,\n      }}>\n        {item.label}\n        {item.note && (\n          <span style={{ fontSize: 10, color: 'var(--text-muted)', marginLeft: 6 }}>({item.note})</span>\n        )}\n      </td>\n      <td style={{\n        padding: '8px 12px', textAlign: 'right',\n        fontFamily: 'var(--font-mono)', fontSize: 13,\n        color: item.amount < 0 ? '#ef4444' : isHighlight ? 'var(--text-primary)' : 'var(--text-secondary)',\n      }}>\n        {fmt(item.amount)}\n      </td>\n      {showPrevious && (\n        <>\n          <td style={{\n            padding: '8px 12px', textAlign: 'right',\n            fontFamily: 'var(--font-mono)', fontSize: 13,\n            color: 'var(--text-muted)',\n          }}>\n            {fmt(item.previousAmount)}\n          </td>\n          <td style={{ padding: '8px 12px', textAlign: 'right' }}>\n            <ChangeIndicator current={item.amount} previous={item.previousAmount} />\n          </td>\n        </>\n      )}\n    </tr>\n  )\n}\n\nfunction MarginBar({ label, value, color }: { label: string; value: number; color: string }) {\n  const width = Math.min(Math.abs(value) * 100, 100)\n  return (\n    <div style={{ marginBottom: 12 }}>\n      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>\n        <span style={{ fontSize: 12, color: 'var(--text-secondary)' }}>{label}</span>\n        <span style={{ fontSize: 12, fontFamily: 'var(--font-mono)', color: value < 0 ? '#ef4444' : color }}>\n          {pct(value)}\n        </span>\n      </div>\n      <div style={{ height: 6, background: 'rgba(255,255,255,0.06)', borderRadius: 3, overflow: 'hidden' }}>\n        <div style={{\n          height: '100%', width: `${width}%`,\n          background: value < 0 ? '#ef4444' : color,\n          borderRadius: 3,\n          transition: 'width 0.5s ease',\n        }} />\n      </div>\n    </div>\n  )\n}\n\nexport function PnLView() {\n  const { state } = useFortuna()\n  const { navigate } = useNavigation()\n  const [showPrevious, setShowPrevious] = useState(true)\n  const [growthRate, setGrowthRate] = useState(10)\n  const [activeTab, setActiveTab] = useState<'statement' | 'analysis'>('statement')\n\n  const pnl: PnLStatement = useMemo(() => {\n    return generatePnL(state, growthRate / 100)\n  }, [state, growthRate])\n\n  // Build the statement rows\n  const buildRows = (): PnLLineItem[] => {\n    const rows: PnLLineItem[] = []\n\n    // Revenue section\n    for (const item of pnl.revenueItems) {\n      rows.push({ ...item, indent: 1 })\n    }\n    rows.push({\n      label: 'Total Revenue', amount: pnl.totalRevenue, previousAmount: pnl.prevTotalRevenue,\n      category: 'revenue', isSubtotal: true,\n    })\n\n    // COGS\n    if (pnl.cogsItems.length > 0) {\n      for (const item of pnl.cogsItems) {\n        rows.push({ ...item, indent: 1 })\n      }\n      rows.push({\n        label: 'Total Cost of Goods Sold', amount: -pnl.totalCOGS, previousAmount: -pnl.prevTotalCOGS,\n        category: 'cogs', isSubtotal: true,\n      })\n    }\n\n    // Gross Profit\n    rows.push({\n      label: 'Gross Profit', amount: pnl.grossProfit, previousAmount: pnl.prevGrossProfit,\n      category: 'revenue', isSubtotal: true,\n    })\n\n    // Operating Expenses\n    for (const item of pnl.opexItems) {\n      rows.push({ ...item, indent: 1 })\n    }\n    rows.push({\n      label: 'Total Operating Expenses', amount: -pnl.totalOpex, previousAmount: -pnl.prevTotalOpex,\n      category: 'operating', isSubtotal: true,\n    })\n\n    // Operating Income\n    rows.push({\n      label: 'Operating Income (EBITDA)', amount: pnl.operatingIncome, previousAmount: pnl.prevOperatingIncome,\n      category: 'operating', isSubtotal: true,\n    })\n\n    // Taxes\n    for (const item of pnl.taxItems) {\n      rows.push({ ...item, indent: 1 })\n    }\n    rows.push({\n      label: 'Total Taxes', amount: -pnl.totalTax, previousAmount: -pnl.prevTotalTax,\n      category: 'tax', isSubtotal: true,\n    })\n\n    // Net Income\n    rows.push({\n      label: 'Net Income', amount: pnl.netIncome, previousAmount: pnl.prevNetIncome,\n      category: 'revenue', isTotal: true,\n    })\n\n    return rows\n  }\n\n  const rows = buildRows()\n  const tabs = [\n    { key: 'statement', label: 'P&L Statement', icon: FileText },\n    { key: 'analysis', label: 'Margin Analysis', icon: BarChart3 },\n  ] as const\n\n  return (\n    <div style={{ padding: '24px 32px', maxWidth: 960, margin: '0 auto' }}>\n      <ViewBreadcrumb viewKey=\"pnl\" />\n\n      {/* Header */}\n      <div style={{ display: 'flex', alignItems: 'flex-start', justifyContent: 'space-between', marginBottom: 20 }}>\n        <div>\n          <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 6 }}>\n            <FileText size={24} style={{ color: '#818cf8' }} />\n            <h1 style={{ fontSize: 24, fontWeight: 700, color: 'var(--text-primary)', margin: 0 }}>\n              Profit & Loss Statement\n            </h1>\n          </div>\n          <p style={{ fontSize: 14, color: 'var(--text-secondary)', margin: 0 }}>\n            {pnl.periodLabel} — Income statement with period-over-period comparison\n          </p>\n        </div>\n      </div>\n\n      {/* KPI Strip */}\n      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: 10, marginBottom: 20 }}>\n        {[\n          { label: 'Revenue', value: fmt(pnl.totalRevenue), sub: pct(pnl.yoyGrowth) + ' YoY', color: '#818cf8' },\n          { label: 'Gross Margin', value: pct(pnl.grossMargin), sub: fmt(pnl.grossProfit), color: '#22c55e' },\n          { label: 'Op. Margin', value: pct(pnl.operatingMargin), sub: fmt(pnl.operatingIncome), color: '#06b6d4' },\n          { label: 'Tax Rate', value: pct(pnl.effectiveTaxRate), sub: fmt(pnl.totalTax), color: '#f59e0b' },\n          { label: 'Net Income', value: fmt(pnl.netIncome), sub: pct(pnl.netMargin) + ' margin', color: pnl.netIncome >= 0 ? '#22c55e' : '#ef4444' },\n        ].map((k, i) => (\n          <div key={i} style={{\n            background: 'var(--bg-card)', borderRadius: 10,\n            padding: '12px 14px', border: '1px solid var(--border-subtle)',\n          }}>\n            <div style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.05em', marginBottom: 4 }}>\n              {k.label}\n            </div>\n            <div style={{ fontSize: 18, fontWeight: 700, fontFamily: 'var(--font-mono)', color: k.color }}>\n              {k.value}\n            </div>\n            <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 2 }}>{k.sub}</div>\n          </div>\n        ))}\n      </div>\n\n      {/* Tabs + Controls */}\n      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>\n        <div style={{ display: 'flex', gap: 4 }}>\n          {tabs.map(t => (\n            <button key={t.key} onClick={() => setActiveTab(t.key)}\n              style={{\n                fontSize: 13, padding: '7px 14px', borderRadius: 8,\n                background: activeTab === t.key ? 'rgba(99,102,241,0.15)' : 'transparent',\n                border: `1px solid ${activeTab === t.key ? 'rgba(99,102,241,0.3)' : 'transparent'}`,\n                color: activeTab === t.key ? '#818cf8' : 'var(--text-muted)',\n                cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 6,\n              }}>\n              <t.icon size={14} /> {t.label}\n            </button>\n          ))}\n        </div>\n        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n          <label style={{ fontSize: 12, color: 'var(--text-muted)' }}>\n            <input type=\"checkbox\" checked={showPrevious} onChange={e => setShowPrevious(e.target.checked)}\n              style={{ marginRight: 6 }} />\n            Compare\n          </label>\n          {showPrevious && (\n            <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>\n              <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>Growth:</span>\n              <input type=\"number\" value={growthRate} onChange={e => setGrowthRate(Number(e.target.value))}\n                style={{\n                  width: 48, fontSize: 12, padding: '3px 6px', borderRadius: 4,\n                  background: 'var(--bg-elevated)', border: '1px solid var(--border-subtle)',\n                  color: 'var(--text-primary)', textAlign: 'center',\n                }} />\n              <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>%</span>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {activeTab === 'statement' && (\n        <div style={{\n          background: 'var(--bg-card)', borderRadius: 12,\n          border: '1px solid var(--border-subtle)', overflow: 'hidden',\n        }}>\n          <table style={{ width: '100%', borderCollapse: 'collapse' }}>\n            <thead>\n              <tr style={{ background: 'rgba(0,0,0,0.2)', borderBottom: '1px solid var(--border-subtle)' }}>\n                <th style={{ padding: '10px 12px', textAlign: 'left', fontSize: 12, color: 'var(--text-muted)', fontWeight: 600 }}>\n                  Account\n                </th>\n                <th style={{ padding: '10px 12px', textAlign: 'right', fontSize: 12, color: 'var(--text-muted)', fontWeight: 600 }}>\n                  {pnl.period}\n                </th>\n                {showPrevious && (\n                  <>\n                    <th style={{ padding: '10px 12px', textAlign: 'right', fontSize: 12, color: 'var(--text-muted)', fontWeight: 600 }}>\n                      {pnl.previousPeriod}\n                    </th>\n                    <th style={{ padding: '10px 12px', textAlign: 'right', fontSize: 12, color: 'var(--text-muted)', fontWeight: 600 }}>\n                      Δ\n                    </th>\n                  </>\n                )}\n              </tr>\n            </thead>\n            <tbody>\n              {/* Section headers */}\n              <tr><td colSpan={showPrevious ? 4 : 2} style={{\n                padding: '12px 12px 4px', fontSize: 11, fontWeight: 700,\n                color: '#818cf8', textTransform: 'uppercase', letterSpacing: '0.1em',\n              }}>Revenue</td></tr>\n\n              {rows.slice(0, pnl.revenueItems.length + 1).map((r, i) => (\n                <LineItemRow key={`rev-${i}`} item={r} showPrevious={showPrevious} />\n              ))}\n\n              {pnl.cogsItems.length > 0 && (\n                <>\n                  <tr><td colSpan={showPrevious ? 4 : 2} style={{\n                    padding: '12px 12px 4px', fontSize: 11, fontWeight: 700,\n                    color: '#f59e0b', textTransform: 'uppercase', letterSpacing: '0.1em',\n                  }}>Cost of Goods Sold</td></tr>\n                  {rows.slice(pnl.revenueItems.length + 1, pnl.revenueItems.length + 1 + pnl.cogsItems.length + 1).map((r, i) => (\n                    <LineItemRow key={`cogs-${i}`} item={r} showPrevious={showPrevious} />\n                  ))}\n                </>\n              )}\n\n              {/* Gross Profit row */}\n              <LineItemRow\n                item={rows.find(r => r.label === 'Gross Profit')!}\n                showPrevious={showPrevious}\n              />\n\n              <tr><td colSpan={showPrevious ? 4 : 2} style={{\n                padding: '12px 12px 4px', fontSize: 11, fontWeight: 700,\n                color: '#ef4444', textTransform: 'uppercase', letterSpacing: '0.1em',\n              }}>Operating Expenses</td></tr>\n\n              {pnl.opexItems.map((item, i) => (\n                <LineItemRow key={`opex-${i}`} item={{ ...item, indent: 1 }} showPrevious={showPrevious} />\n              ))}\n              <LineItemRow\n                item={rows.find(r => r.label === 'Total Operating Expenses')!}\n                showPrevious={showPrevious}\n              />\n              <LineItemRow\n                item={rows.find(r => r.label === 'Operating Income (EBITDA)')!}\n                showPrevious={showPrevious}\n              />\n\n              <tr><td colSpan={showPrevious ? 4 : 2} style={{\n                padding: '12px 12px 4px', fontSize: 11, fontWeight: 700,\n                color: '#f59e0b', textTransform: 'uppercase', letterSpacing: '0.1em',\n              }}>Taxes</td></tr>\n\n              {pnl.taxItems.map((item, i) => (\n                <LineItemRow key={`tax-${i}`} item={{ ...item, indent: 1 }} showPrevious={showPrevious} />\n              ))}\n              <LineItemRow\n                item={rows.find(r => r.label === 'Total Taxes')!}\n                showPrevious={showPrevious}\n              />\n\n              {/* Net Income */}\n              <LineItemRow\n                item={rows.find(r => r.label === 'Net Income')!}\n                showPrevious={showPrevious}\n              />\n            </tbody>\n          </table>\n        </div>\n      )}\n\n      {activeTab === 'analysis' && (\n        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>\n          <div style={{\n            background: 'var(--bg-card)', borderRadius: 12,\n            padding: 20, border: '1px solid var(--border-subtle)',\n          }}>\n            <h3 style={{ fontSize: 14, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 16 }}>\n              Margin Waterfall\n            </h3>\n            <MarginBar label=\"Gross Margin\" value={pnl.grossMargin} color=\"#22c55e\" />\n            <MarginBar label=\"Operating Margin\" value={pnl.operatingMargin} color=\"#06b6d4\" />\n            <MarginBar label=\"Net Margin\" value={pnl.netMargin} color={pnl.netMargin >= 0 ? '#818cf8' : '#ef4444'} />\n            <MarginBar label=\"Tax Burden (% of Revenue)\" value={-pnl.effectiveTaxRate} color=\"#f59e0b\" />\n          </div>\n\n          <div style={{\n            background: 'var(--bg-card)', borderRadius: 12,\n            padding: 20, border: '1px solid var(--border-subtle)',\n          }}>\n            <h3 style={{ fontSize: 14, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 16 }}>\n              Revenue Breakdown\n            </h3>\n            {pnl.revenueItems.map((item, i) => {\n              const share = pnl.totalRevenue > 0 ? item.amount / pnl.totalRevenue : 0\n              return (\n                <div key={i} style={{ marginBottom: 10 }}>\n                  <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 12, marginBottom: 3 }}>\n                    <span style={{ color: 'var(--text-secondary)' }}>{item.label}</span>\n                    <span style={{ fontFamily: 'var(--font-mono)', color: 'var(--text-primary)' }}>\n                      {fmt(item.amount)} ({pct(share)})\n                    </span>\n                  </div>\n                  <div style={{ height: 4, background: 'rgba(255,255,255,0.06)', borderRadius: 2 }}>\n                    <div style={{\n                      height: '100%', width: `${share * 100}%`,\n                      background: `hsl(${240 + i * 30}, 70%, 65%)`,\n                      borderRadius: 2,\n                    }} />\n                  </div>\n                </div>\n              )\n            })}\n          </div>\n\n          {/* Expense distribution */}\n          <div style={{\n            background: 'var(--bg-card)', borderRadius: 12,\n            padding: 20, border: '1px solid var(--border-subtle)',\n            gridColumn: '1 / -1',\n          }}>\n            <h3 style={{ fontSize: 14, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 16 }}>\n              Expense Distribution\n            </h3>\n            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 10 }}>\n              {pnl.opexItems.map((item, i) => {\n                const share = pnl.totalOpex > 0 ? item.amount / pnl.totalOpex : 0\n                return (\n                  <div key={i} style={{\n                    padding: '10px 12px', borderRadius: 8,\n                    background: 'rgba(255,255,255,0.03)',\n                    border: '1px solid var(--border-subtle)',\n                  }}>\n                    <div style={{ fontSize: 12, color: 'var(--text-secondary)', marginBottom: 4 }}>{item.label}</div>\n                    <div style={{ fontSize: 16, fontFamily: 'var(--font-mono)', fontWeight: 600, color: 'var(--text-primary)' }}>\n                      {fmt(item.amount)}\n                    </div>\n                    <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>{pct(share)} of opex</div>\n                  </div>\n                )\n              })}\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Insights */}\n      {pnl.insights.length > 0 && (\n        <div style={{\n          marginTop: 20, padding: 16,\n          background: 'rgba(99,102,241,0.05)',\n          borderRadius: 10,\n          border: '1px solid rgba(99,102,241,0.15)',\n        }}>\n          <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 10 }}>\n            <Lightbulb size={16} style={{ color: '#818cf8' }} />\n            <span style={{ fontSize: 13, fontWeight: 600, color: 'var(--text-primary)' }}>\n              P&L Insights\n            </span>\n          </div>\n          <div style={{ display: 'flex', flexDirection: 'column', gap: 6 }}>\n            {pnl.insights.map((insight, i) => (\n              <div key={i} style={{ fontSize: 13, color: 'var(--text-secondary)', lineHeight: 1.5, paddingLeft: 24 }}>\n                • {insight}\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n\n      <RelatedViews currentView=\"pnl\" />\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\PortfolioIntelligence.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Copy' is defined but never used.","line":16,"column":46,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":50,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Copy"},"fix":{"range":[843,849],"text":""},"desc":"Remove unused variable \"Copy\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Shield' is defined but never used.","line":17,"column":56,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":62,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Shield"},"fix":{"range":[911,919],"text":""},"desc":"Remove unused variable \"Shield\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Tag' is defined but never used.","line":18,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":25,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Tag"},"fix":{"range":[940,945],"text":""},"desc":"Remove unused variable \"Tag\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'PiggyBank' is defined but never used.","line":20,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":20,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"PiggyBank"},"fix":{"range":[1048,1059],"text":""},"desc":"Remove unused variable \"PiggyBank\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'RefreshCw' is defined but never used.","line":20,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":42,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"RefreshCw"},"fix":{"range":[1070,1081],"text":""},"desc":"Remove unused variable \"RefreshCw\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ExternalLink' is defined but never used.","line":20,"column":44,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":56,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ExternalLink"},"fix":{"range":[1081,1095],"text":""},"desc":"Remove unused variable \"ExternalLink\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'XCircle' is defined but never used.","line":21,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":32,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"XCircle"},"fix":{"range":[1127,1136],"text":""},"desc":"Remove unused variable \"XCircle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Loader2' is defined but never used.","line":21,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":21,"endColumn":41,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Loader2"},"fix":{"range":[1136,1145],"text":""},"desc":"Remove unused variable \"Loader2\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'calculateFederalIncomeTax' is defined but never used.","line":23,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":23,"endColumn":52,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"calculateFederalIncomeTax"},"fix":{"range":[1199,1226],"text":""},"desc":"Remove unused variable \"calculateFederalIncomeTax\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'calculateSelfEmploymentTax' is defined but never used.","line":23,"column":54,"nodeType":"Identifier","messageId":"unusedVar","endLine":23,"endColumn":80,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"calculateSelfEmploymentTax"},"fix":{"range":[1226,1254],"text":""},"desc":"Remove unused variable \"calculateSelfEmploymentTax\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'detectFormat' is defined but never used.","line":25,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":26,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"detectFormat"},"fix":{"range":[1309,1323],"text":""},"desc":"Remove unused variable \"detectFormat\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ImportedPosition' is defined but never used.","line":26,"column":69,"nodeType":"Identifier","messageId":"unusedVar","endLine":26,"endColumn":85,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ImportedPosition"},"fix":{"range":[1421,1444],"text":""},"desc":"Remove unused variable \"ImportedPosition\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ImportedTaxEvent' is defined but never used.","line":26,"column":92,"nodeType":"Identifier","messageId":"unusedVar","endLine":26,"endColumn":108,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ImportedTaxEvent"},"fix":{"range":[1444,1467],"text":""},"desc":"Remove unused variable \"ImportedTaxEvent\"."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'updateState'. Either include it or remove the dependency array.","line":282,"column":6,"nodeType":"ArrayExpression","endLine":282,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [data, updateState]","fix":{"range":[11408,11414],"text":"[data, updateState]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":339,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":339,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14278,14281],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14278,14281],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":638,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":638,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[29697,29700],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[29697,29700],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":640,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":640,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[29890,29893],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[29890,29893],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":862,"column":137,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":862,"endColumn":140,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[44465,44468],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[44465,44468],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":939,"column":130,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":939,"endColumn":133,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[49473,49476],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[49473,49476],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1210,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1210,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[66656,66659],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[66656,66659],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":19,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// ─── Portfolio Intelligence ─────────────────────────────────────────────────\n// UIF-powered context bridge for importing/exporting financial context across\n// the AEGIS ecosystem. Handles crypto positions, speculative assets, opportunity\n// pipeline, and structured analysis import from external sources.\n//\n// UIF Layer Mapping:\n//   L1 UIE Envelopes → Standardized financial context containers\n//   L2 API           → Import (paste/upload) + Export (JSON/clipboard)\n//   L3 Shared Svc    → Asset valuation, tax classification, risk scoring\n//   L4 Events        → Position changes, TGE alerts, tax triggers\n//   L5 AI Orch       → Auto-classify, strategy detection, tax implications\n\nimport { useState, useEffect, useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport {\n  Briefcase, Plus, Trash2, Upload, Download, Copy, Check,\n  TrendingUp, TrendingDown, AlertTriangle, Zap, Globe, Shield,\n  DollarSign, Clock, Tag, ChevronDown, ChevronRight, Search,\n  FileText, Link2, ArrowRightLeft, Sparkles, Target, Eye,\n  Wallet, PiggyBank, BarChart3, RefreshCw, ExternalLink, FileUp,\n  Table2, CheckCircle2, XCircle, Loader2, Info,\n} from 'lucide-react'\nimport { STATE_TAX_RATES, calculateFederalIncomeTax, calculateSelfEmploymentTax } from '../engine/tax-calculator'\nimport {\n  importCSV, detectFormat, autoMapColumns, SUPPORTED_FORMATS,\n  type ImportResult, type SupportedFormat, type ColumnMapping, type ImportedPosition, type ImportedTaxEvent,\n} from '../engine/csv-import'\n\n// ─── UIE Envelope Types ─────────────────────────────────────────────────────\n\ninterface UIEEnvelope {\n  _format: 'uie-financial-context'\n  _version: 1\n  _created: string\n  _source: string\n  _sourceRef?: string // link to originating chat/analysis\n  positions: PortfolioPosition[]\n  opportunities: OpportunityAnalysis[]\n  taxEvents: TaxEvent[]\n  contextNotes: string\n}\n\ntype AssetClass = 'crypto' | 'defi' | 'nft' | 'equity' | 'commodity' | 'real_estate' | 'speculative' | 'other'\ntype PositionStatus = 'active' | 'pending' | 'exited' | 'locked' | 'staking'\ntype TaxTreatment = 'ordinary_income' | 'short_term_cg' | 'long_term_cg' | 'mining_income' | 'airdrop' | 'staking_reward' | 'unknown'\n\ninterface PortfolioPosition {\n  id: string\n  name: string\n  ticker?: string\n  assetClass: AssetClass\n  status: PositionStatus\n  quantity: number\n  costBasis: number           // total cost basis in USD\n  currentValue: number        // current estimated value in USD\n  acquiredDate?: string\n  notes: string\n  taxTreatment: TaxTreatment\n  tags: string[]\n  riskScore: number           // 1-10\n  // Crypto-specific\n  chain?: string\n  wallet?: string\n  isLocked?: boolean\n  unlockDate?: string\n  // Source tracking (UIF L1)\n  sourceEnvelope?: string     // which import envelope brought this in\n}\n\ninterface OpportunityAnalysis {\n  id: string\n  title: string\n  summary: string\n  status: 'watching' | 'researching' | 'ready' | 'active' | 'exited' | 'passed'\n  estimatedValue: number\n  confidence: number          // 0-100\n  timeHorizon: string\n  taxImplications: string\n  actionItems: string[]\n  sourceRef?: string          // URL or chat link\n  created: string\n  tags: string[]\n}\n\ninterface TaxEvent {\n  id: string\n  type: 'airdrop' | 'tge' | 'vest' | 'sale' | 'conversion' | 'staking_reward' | 'mining' | 'income' | 'loss'\n  description: string\n  estimatedAmount: number\n  taxTreatment: TaxTreatment\n  expectedDate?: string\n  realized: boolean\n  positionId?: string\n  notes: string\n}\n\n// ─── Storage ────────────────────────────────────────────────────────────────\n\nconst STORAGE_KEY = 'fortuna:portfolio-intelligence'\n\ninterface PortfolioData {\n  positions: PortfolioPosition[]\n  opportunities: OpportunityAnalysis[]\n  taxEvents: TaxEvent[]\n  envelopeHistory: { imported: string; source: string; positionCount: number; date: string }[]\n}\n\nfunction loadPortfolio(): PortfolioData {\n  try {\n    const raw = localStorage.getItem(STORAGE_KEY)\n    if (raw) return JSON.parse(raw)\n  } catch { /* */ }\n  return { positions: [], opportunities: [], taxEvents: [], envelopeHistory: [] }\n}\n\nfunction savePortfolio(data: PortfolioData) {\n  localStorage.setItem(STORAGE_KEY, JSON.stringify(data))\n}\n\nfunction genId() { return Math.random().toString(36).slice(2, 10) }\n\n// ─── Asset Class Config ─────────────────────────────────────────────────────\n\nconst ASSET_CLASSES: Record<AssetClass, { label: string; emoji: string; color: string }> = {\n  crypto:       { label: 'Cryptocurrency',   emoji: '₿',  color: '#f7931a' },\n  defi:         { label: 'DeFi Position',    emoji: '🔗', color: '#627eea' },\n  nft:          { label: 'NFT',              emoji: '🖼️', color: '#e040fb' },\n  equity:       { label: 'Equity / Stock',   emoji: '📈', color: '#10b981' },\n  commodity:    { label: 'Commodity',         emoji: '🥇', color: '#fbbf24' },\n  real_estate:  { label: 'Real Estate',      emoji: '🏠', color: '#8b5cf6' },\n  speculative:  { label: 'Speculative',      emoji: '🎯', color: '#ef4444' },\n  other:        { label: 'Other',            emoji: '📦', color: '#6b7280' },\n}\n\nconst TAX_TREATMENTS: Record<TaxTreatment, { label: string; description: string }> = {\n  ordinary_income:  { label: 'Ordinary Income',    description: 'Taxed at marginal income tax rate' },\n  short_term_cg:    { label: 'Short-Term Cap Gain', description: 'Held < 1 year, taxed as ordinary income' },\n  long_term_cg:     { label: 'Long-Term Cap Gain',  description: 'Held > 1 year, 0%/15%/20% rate' },\n  mining_income:    { label: 'Mining Income',        description: 'FMV at receipt = ordinary income + SE tax' },\n  airdrop:          { label: 'Airdrop',              description: 'FMV at receipt = ordinary income' },\n  staking_reward:   { label: 'Staking Reward',       description: 'FMV at receipt = ordinary income' },\n  unknown:          { label: 'Unknown / TBD',        description: 'Tax treatment not yet determined' },\n}\n\nconst POSITION_STATUSES: Record<PositionStatus, { label: string; color: string }> = {\n  active:  { label: 'Active',  color: '#10b981' },\n  pending: { label: 'Pending', color: '#f59e0b' },\n  exited:  { label: 'Exited',  color: '#6b7280' },\n  locked:  { label: 'Locked',  color: '#ef4444' },\n  staking: { label: 'Staking', color: '#8b5cf6' },\n}\n\n// ─── Component ──────────────────────────────────────────────────────────────\n\nexport function PortfolioIntelligence() {\n  const { state, updateState } = useFortuna()\n\n  // Hydrate from FortunaState investments, fall back to localStorage for migration\n  const initPortfolio = (): PortfolioData => {\n    // If FortunaState has investments, use those as source of truth\n    if (state.investments && state.investments.length > 0) {\n      const positions: PortfolioPosition[] = state.investments.map(inv => ({\n        id: inv.id,\n        name: inv.name,\n        ticker: inv.symbol,\n        assetClass: (inv.type === 'crypto' ? 'crypto' : inv.type === 'real_estate' ? 'real_estate' : inv.type === 'stock' || inv.type === 'etf' ? 'equity' : 'other') as AssetClass,\n        quantity: inv.quantity,\n        costBasis: inv.costBasis,\n        currentValue: inv.currentValue || 0,\n        acquiredDate: inv.acquisitionDate,\n        status: 'active' as PositionStatus,\n        taxTreatment: (inv.isLongTerm ? 'long_term_cg' : 'short_term_cg') as TaxTreatment,\n        wallet: '',\n        notes: '',\n        tags: [],\n        riskScore: 5,\n      }))\n      return {\n        positions,\n        opportunities: state.portfolioOpportunities || [],\n        taxEvents: state.portfolioTaxEvents || [],\n        envelopeHistory: [],\n      }\n    }\n    // Migrate from localStorage\n    return loadPortfolio()\n  }\n\n  const [data, setData] = useState<PortfolioData>(initPortfolio)\n  const [activeTab, setActiveTab] = useState<'positions' | 'opportunities' | 'taxevents' | 'bridge' | 'import'>('positions')\n  \n  // CSV Import state\n  const [csvStep, setCsvStep] = useState<'select' | 'upload' | 'map' | 'preview' | 'done'>('select')\n  const [csvFormat, setCsvFormat] = useState<SupportedFormat | null>(null)\n  const [csvResult, setCsvResult] = useState<ImportResult | null>(null)\n  const [csvMapping, setCsvMapping] = useState<ColumnMapping>({})\n  const [csvRawText, setCsvRawText] = useState('')\n  const [csvDragOver, setCsvDragOver] = useState(false)\n\n  // CSV import processor\n  const processImport = (text: string) => {\n    const result = importCSV(text, csvFormat || undefined)\n    setCsvResult(result)\n    if (result.format === 'custom' && result.positions.length === 0 && result.taxEvents.length === 0) {\n      setCsvMapping(autoMapColumns(result.rawHeaders))\n      setCsvStep('map')\n    } else {\n      setCsvStep('preview')\n    }\n  }\n\n  const confirmImport = () => {\n    if (!csvResult) return\n    const newPositions = csvResult.positions.map(pos => ({\n      id: genId(),\n      name: pos.name,\n      ticker: pos.ticker,\n      assetClass: pos.assetClass,\n      status: 'active' as const,\n      quantity: pos.quantity,\n      costBasis: pos.costBasis,\n      currentValue: pos.currentValue,\n      acquiredDate: pos.acquiredDate,\n      notes: pos.notes,\n      taxTreatment: pos.taxTreatment,\n      tags: pos.tags,\n      riskScore: pos.riskScore,\n      chain: pos.chain,\n      wallet: pos.wallet,\n      sourceEnvelope: `csv-import:${csvResult.source}:${new Date().toISOString()}`,\n    }))\n    const newTaxEvents = csvResult.taxEvents.map(evt => ({\n      id: genId(),\n      type: evt.type,\n      description: evt.description,\n      estimatedAmount: evt.estimatedAmount,\n      taxTreatment: evt.taxTreatment,\n      expectedDate: evt.expectedDate,\n      realized: evt.realized,\n      notes: evt.notes,\n    }))\n    setData(prev => ({\n      ...prev,\n      positions: [...prev.positions, ...newPositions],\n      taxEvents: [...prev.taxEvents, ...newTaxEvents],\n      envelopeHistory: [...prev.envelopeHistory, {\n        imported: `CSV Import: ${csvResult.source}`,\n        source: csvResult.format,\n        positionCount: newPositions.length,\n        date: new Date().toISOString(),\n      }],\n    }))\n    setCsvStep('done')\n  }\n  const [importMode, setImportMode] = useState(false)\n  const [importText, setImportText] = useState('')\n  const [importResult, setImportResult] = useState<string | null>(null)\n  const [searchTerm, setSearchTerm] = useState('')\n  const [expandedPosition, setExpandedPosition] = useState<string | null>(null)\n  const [copiedExport, setCopiedExport] = useState(false)\n\n  // Persist on change\n  useEffect(() => {\n    savePortfolio(data) // keep localStorage as backup\n    // Sync to FortunaState.investments for cloud persistence + cross-engine access\n    const investments = data.positions.map(p => ({\n      id: p.id,\n      symbol: p.ticker || p.name,\n      name: p.name,\n      type: (p.assetClass === 'crypto' ? 'crypto' : p.assetClass === 'real_estate' ? 'real_estate' : p.assetClass === 'equity' ? 'stock' : 'other') as 'stock' | 'etf' | 'mutual_fund' | 'bond' | 'crypto' | 'real_estate' | 'other',\n      quantity: p.quantity,\n      costBasis: p.costBasis,\n      currentValue: p.currentValue,\n      acquisitionDate: p.acquiredDate || new Date().toISOString(),\n      isLongTerm: p.taxTreatment === 'long_term_cg',\n      entityId: 'personal',\n      memberId: 'primary' as const,\n      taxYear: new Date().getFullYear(),\n      tags: [] as string[],\n    }))\n    updateState(s => ({ ...s, investments, portfolioOpportunities: data.opportunities, portfolioTaxEvents: data.taxEvents }))\n  }, [data])\n\n  // ─── Computed Stats ─────────────────────────────────────────────────\n  const stats = useMemo(() => {\n    const activePositions = data.positions.filter(p => p.status !== 'exited')\n    const totalValue = activePositions.reduce((s, p) => s + p.currentValue, 0)\n    const totalCostBasis = activePositions.reduce((s, p) => s + p.costBasis, 0)\n    const totalGainLoss = totalValue - totalCostBasis\n    const unrealizedTaxEvents = data.taxEvents.filter(e => !e.realized)\n    const estimatedTaxableEvents = unrealizedTaxEvents.reduce((s, e) => s + e.estimatedAmount, 0)\n    const watchingOpps = data.opportunities.filter(o => o.status === 'watching' || o.status === 'researching')\n\n    // Estimate tax impact using user's profile\n    const marginalRate = 0.24 + (STATE_TAX_RATES[state.profile.state]?.rate || 0)\n    const estimatedTaxLiability = estimatedTaxableEvents * marginalRate\n\n    // Risk distribution\n    const highRisk = activePositions.filter(p => p.riskScore >= 7).length\n    const medRisk = activePositions.filter(p => p.riskScore >= 4 && p.riskScore < 7).length\n    const lowRisk = activePositions.filter(p => p.riskScore < 4).length\n\n    return {\n      activePositions: activePositions.length, totalValue, totalCostBasis, totalGainLoss,\n      unrealizedEvents: unrealizedTaxEvents.length, estimatedTaxableEvents,\n      estimatedTaxLiability, watchingOpps: watchingOpps.length,\n      highRisk, medRisk, lowRisk, marginalRate,\n    }\n  }, [data, state.profile.state])\n\n  // ─── UIE Import ─────────────────────────────────────────────────────\n  const handleImport = () => {\n    try {\n      const parsed = JSON.parse(importText.trim())\n\n      if (parsed._format === 'uie-financial-context') {\n        // Full UIE envelope import\n        const envelope = parsed as UIEEnvelope\n        const newPositions = (envelope.positions || []).map(p => ({ ...p, id: genId(), sourceEnvelope: envelope._source }))\n        const newOpps = (envelope.opportunities || []).map(o => ({ ...o, id: genId() }))\n        const newEvents = (envelope.taxEvents || []).map(e => ({ ...e, id: genId() }))\n\n        setData(prev => ({\n          ...prev,\n          positions: [...prev.positions, ...newPositions],\n          opportunities: [...prev.opportunities, ...newOpps],\n          taxEvents: [...prev.taxEvents, ...newEvents],\n          envelopeHistory: [...prev.envelopeHistory, {\n            imported: envelope._source,\n            source: envelope._sourceRef || 'Manual import',\n            positionCount: newPositions.length,\n            date: new Date().toISOString(),\n          }],\n        }))\n\n        setImportResult(`✅ Imported ${newPositions.length} positions, ${newOpps.length} opportunities, ${newEvents.length} tax events from \"${envelope._source}\"`)\n      } else if (Array.isArray(parsed)) {\n        // Array of positions\n        const newPositions = parsed.map((p: any) => ({\n          id: genId(),\n          name: p.name || p.title || 'Unnamed',\n          ticker: p.ticker || p.symbol || '',\n          assetClass: p.assetClass || p.type || 'speculative' as AssetClass,\n          status: p.status || 'active' as PositionStatus,\n          quantity: p.quantity || p.amount || 0,\n          costBasis: p.costBasis || 0,\n          currentValue: p.currentValue || p.value || 0,\n          notes: p.notes || '',\n          taxTreatment: p.taxTreatment || 'unknown' as TaxTreatment,\n          tags: p.tags || [],\n          riskScore: p.riskScore || 5,\n        }))\n        setData(prev => ({ ...prev, positions: [...prev.positions, ...newPositions] }))\n        setImportResult(`✅ Imported ${newPositions.length} positions`)\n      } else if (parsed.name || parsed.title) {\n        // Single position\n        const pos: PortfolioPosition = {\n          id: genId(),\n          name: parsed.name || parsed.title,\n          ticker: parsed.ticker || parsed.symbol || '',\n          assetClass: parsed.assetClass || 'speculative',\n          status: parsed.status || 'active',\n          quantity: parsed.quantity || parsed.amount || 0,\n          costBasis: parsed.costBasis || 0,\n          currentValue: parsed.currentValue || parsed.value || 0,\n          notes: parsed.notes || parsed.summary || '',\n          taxTreatment: parsed.taxTreatment || 'unknown',\n          tags: parsed.tags || [],\n          riskScore: parsed.riskScore || 5,\n        }\n        setData(prev => ({ ...prev, positions: [...prev.positions, pos] }))\n        setImportResult(`✅ Imported position: ${pos.name}`)\n      } else {\n        setImportResult('⚠️ Unrecognized format. Use UIE envelope, position array, or single position object.')\n      }\n    } catch {\n      setImportResult('❌ Invalid JSON. Paste a UIE envelope, position array, or single position object.')\n    }\n\n    setTimeout(() => setImportResult(null), 5000)\n  }\n\n  // ─── UIE Export ─────────────────────────────────────────────────────\n  const generateExportEnvelope = (): UIEEnvelope => {\n    return {\n      _format: 'uie-financial-context',\n      _version: 1,\n      _created: new Date().toISOString(),\n      _source: 'Fortuna Engine — Portfolio Intelligence',\n      positions: data.positions,\n      opportunities: data.opportunities,\n      taxEvents: data.taxEvents,\n      contextNotes: `Financial profile: ${state.profile.name}, ${STATE_TAX_RATES[state.profile.state]?.name}, ${state.profile.filingStatus}. ` +\n        `Total income: $${state.incomeStreams.reduce((s, i) => s + i.annualAmount, 0).toLocaleString()}. ` +\n        `Entities: ${state.entities.map(e => e.name || e.type).join(', ') || 'None'}. ` +\n        `Portfolio: ${data.positions.filter(p => p.status !== 'exited').length} active positions, ` +\n        `$${stats.totalValue.toLocaleString()} estimated value, ` +\n        `${stats.unrealizedEvents} pending tax events ($${Math.round(stats.estimatedTaxableEvents).toLocaleString()} est. taxable).`,\n    }\n  }\n\n  const handleExport = () => {\n    const envelope = generateExportEnvelope()\n    navigator.clipboard.writeText(JSON.stringify(envelope, null, 2))\n    setCopiedExport(true)\n    setTimeout(() => setCopiedExport(false), 3000)\n  }\n\n  // ─── Filtering ──────────────────────────────────────────────────────\n  const filteredPositions = data.positions.filter(p =>\n    !searchTerm ||\n    p.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    (p.ticker || '').toLowerCase().includes(searchTerm.toLowerCase()) ||\n    p.tags.some(t => t.toLowerCase().includes(searchTerm.toLowerCase()))\n  )\n\n  // ─── Add Helpers ────────────────────────────────────────────────────\n  const addPosition = () => {\n    setData(prev => ({\n      ...prev,\n      positions: [...prev.positions, {\n        id: genId(), name: '', assetClass: 'crypto', status: 'active',\n        quantity: 0, costBasis: 0, currentValue: 0, notes: '',\n        taxTreatment: 'unknown', tags: [], riskScore: 5,\n      }],\n    }))\n  }\n\n  const addOpportunity = () => {\n    setData(prev => ({\n      ...prev,\n      opportunities: [...prev.opportunities, {\n        id: genId(), title: '', summary: '', status: 'watching',\n        estimatedValue: 0, confidence: 50, timeHorizon: '',\n        taxImplications: '', actionItems: [], created: new Date().toISOString(), tags: [],\n      }],\n    }))\n  }\n\n  const addTaxEvent = () => {\n    setData(prev => ({\n      ...prev,\n      taxEvents: [...prev.taxEvents, {\n        id: genId(), type: 'airdrop', description: '', estimatedAmount: 0,\n        taxTreatment: 'ordinary_income', realized: false, notes: '',\n      }],\n    }))\n  }\n\n  const updatePosition = (id: string, updates: Partial<PortfolioPosition>) => {\n    setData(prev => ({\n      ...prev,\n      positions: prev.positions.map(p => p.id === id ? { ...p, ...updates } : p),\n    }))\n  }\n\n  const removePosition = (id: string) => {\n    setData(prev => ({ ...prev, positions: prev.positions.filter(p => p.id !== id) }))\n  }\n\n  const updateOpportunity = (id: string, updates: Partial<OpportunityAnalysis>) => {\n    setData(prev => ({\n      ...prev,\n      opportunities: prev.opportunities.map(o => o.id === id ? { ...o, ...updates } : o),\n    }))\n  }\n\n  const removeOpportunity = (id: string) => {\n    setData(prev => ({ ...prev, opportunities: prev.opportunities.filter(o => o.id !== id) }))\n  }\n\n  const updateTaxEvent = (id: string, updates: Partial<TaxEvent>) => {\n    setData(prev => ({\n      ...prev,\n      taxEvents: prev.taxEvents.map(e => e.id === id ? { ...e, ...updates } : e),\n    }))\n  }\n\n  const removeTaxEvent = (id: string) => {\n    setData(prev => ({ ...prev, taxEvents: prev.taxEvents.filter(e => e.id !== id) }))\n  }\n\n  // ─── Styles ─────────────────────────────────────────────────────────\n  const inputStyle: React.CSSProperties = {\n    width: '100%', padding: '8px 12px', borderRadius: 8, border: '1px solid var(--border-medium)',\n    background: 'var(--bg-surface)', color: 'var(--text-primary)', fontFamily: 'var(--font-body)',\n    fontSize: 12, outline: 'none',\n  }\n  const selectStyle: React.CSSProperties = { ...inputStyle, cursor: 'pointer' }\n  const labelStyle: React.CSSProperties = { fontSize: 10, fontWeight: 600, color: 'var(--text-muted)', marginBottom: 4, display: 'block', textTransform: 'uppercase', letterSpacing: '0.04em' }\n\n  // ─── Render ─────────────────────────────────────────────────────────\n  return (\n    <div className=\"view-enter\" style={{ maxWidth: 1100, margin: '0 auto' }}>\n      {/* Header */}\n      <div style={{ marginBottom: 24 }}>\n        <h1 className=\"section-title\" style={{ display: 'flex', alignItems: 'center', gap: 10 }}>\n          <Briefcase size={22} />\n          Portfolio Intelligence\n          <span style={{ fontSize: 10, fontWeight: 600, padding: '2px 8px', borderRadius: 5, background: 'rgba(139,92,246,0.12)', color: '#8b5cf6', marginLeft: 4 }}>UIF BRIDGE</span>\n        </h1>\n        <p className=\"section-subtitle\">Import context from external analyses, track positions & opportunities, and export financial context for cross-solution strategy.</p>\n      </div>\n\n      {/* Summary KPIs */}\n      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: 10, marginBottom: 20 }}>\n        {[\n          { label: 'Portfolio Value', value: `$${Math.round(stats.totalValue).toLocaleString()}`, color: '#10b981', icon: <Wallet size={14} /> },\n          { label: 'Gain / Loss', value: `${stats.totalGainLoss >= 0 ? '+' : ''}$${Math.round(stats.totalGainLoss).toLocaleString()}`, color: stats.totalGainLoss >= 0 ? '#10b981' : '#ef4444', icon: stats.totalGainLoss >= 0 ? <TrendingUp size={14} /> : <TrendingDown size={14} /> },\n          { label: 'Pending Tax Events', value: `${stats.unrealizedEvents}`, color: '#f59e0b', icon: <Clock size={14} /> },\n          { label: 'Est. Tax Impact', value: `$${Math.round(stats.estimatedTaxLiability).toLocaleString()}`, color: '#ef4444', icon: <DollarSign size={14} /> },\n          { label: 'Watching', value: `${stats.watchingOpps} opps`, color: '#8b5cf6', icon: <Eye size={14} /> },\n        ].map(kpi => (\n          <div key={kpi.label} style={{\n            background: 'var(--bg-surface)', borderRadius: 10, padding: '12px 14px',\n            border: '1px solid var(--border-subtle)', textAlign: 'center',\n          }}>\n            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 4, color: 'var(--text-muted)', marginBottom: 4 }}>\n              {kpi.icon}\n              <span style={{ fontSize: 9, textTransform: 'uppercase', letterSpacing: '0.05em', fontWeight: 600 }}>{kpi.label}</span>\n            </div>\n            <div style={{ fontSize: 17, fontWeight: 700, color: kpi.color, fontFamily: 'var(--font-mono)' }}>{kpi.value}</div>\n          </div>\n        ))}\n      </div>\n\n      {/* UIF Context Bar */}\n      <div style={{\n        display: 'flex', alignItems: 'center', gap: 8, padding: '10px 14px', marginBottom: 20,\n        borderRadius: 10, background: 'rgba(139,92,246,0.06)', border: '1px solid rgba(139,92,246,0.12)',\n      }}>\n        <Link2 size={14} style={{ color: '#8b5cf6', flexShrink: 0 }} />\n        <span style={{ fontSize: 11, color: 'var(--text-secondary)', flex: 1 }}>\n          <strong style={{ color: '#8b5cf6' }}>UIF Context Bridge</strong> — Import analysis from any conversation or tool as UIE envelopes. Export your full financial context for use in AEGIS, IdeaForge, or any ecosystem solution.\n        </span>\n        <button onClick={() => setImportMode(!importMode)} className=\"btn btn-ghost\" style={{ fontSize: 11, padding: '4px 10px', gap: 4 }}>\n          <Upload size={12} /> Import\n        </button>\n        <button onClick={handleExport} className=\"btn btn-ghost\" style={{ fontSize: 11, padding: '4px 10px', gap: 4 }}>\n          {copiedExport ? <Check size={12} /> : <Download size={12} />}\n          {copiedExport ? 'Copied!' : 'Export'}\n        </button>\n      </div>\n\n      {/* Import Panel */}\n      {importMode && (\n        <div className=\"card\" style={{ marginBottom: 20, border: '1px solid rgba(139,92,246,0.2)' }}>\n          <div className=\"card-header\">\n            <span className=\"card-title\" style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n              <Upload size={16} /> Import UIE Envelope or Position Data\n            </span>\n            <button onClick={() => setImportMode(false)} className=\"btn btn-ghost\" style={{ fontSize: 11, padding: '3px 8px' }}>Close</button>\n          </div>\n          <div className=\"card-body\">\n            <div style={{ marginBottom: 12 }}>\n              <div style={{ fontSize: 11, color: 'var(--text-muted)', marginBottom: 8, lineHeight: 1.5 }}>\n                Paste a <strong>UIE envelope</strong> (full context from another solution), a <strong>JSON array</strong> of positions,\n                or a <strong>single position object</strong>. The bridge will auto-detect the format and merge new data.\n              </div>\n              <textarea\n                style={{ ...inputStyle, height: 140, fontFamily: 'var(--font-mono)', fontSize: 11, resize: 'vertical' }}\n                value={importText}\n                onChange={e => setImportText(e.target.value)}\n                placeholder={`// Example UIE Envelope:\n{\n  \"_format\": \"uie-financial-context\",\n  \"_version\": 1,\n  \"_source\": \"DeNet Opportunity Analysis\",\n  \"positions\": [{\n    \"name\": \"$WN Tokens\",\n    \"assetClass\": \"crypto\",\n    \"quantity\": 100000000,\n    \"currentValue\": 0,\n    \"taxTreatment\": \"airdrop\",\n    \"riskScore\": 8,\n    \"tags\": [\"pre-TGE\", \"DeNet\", \"peaq\"]\n  }],\n  \"opportunities\": [],\n  \"taxEvents\": [{\n    \"type\": \"tge\",\n    \"description\": \"DeNet TGE — $WN → $DENET conversion\",\n    \"estimatedAmount\": 0,\n    \"taxTreatment\": \"airdrop\"\n  }]\n}`}\n              />\n            </div>\n            <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>\n              <button onClick={handleImport} className=\"btn btn-primary\" style={{ fontSize: 12, padding: '8px 16px' }} disabled={!importText.trim()}>\n                <Zap size={13} /> Import & Merge\n              </button>\n              {importResult && (\n                <span style={{ fontSize: 12, color: importResult.startsWith('✅') ? '#10b981' : importResult.startsWith('⚠️') ? '#f59e0b' : '#ef4444' }}>\n                  {importResult}\n                </span>\n              )}\n            </div>\n\n            {/* Quick-import templates */}\n            <div style={{ marginTop: 14, paddingTop: 14, borderTop: '1px solid var(--border-subtle)' }}>\n              <div style={{ fontSize: 10, fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase', marginBottom: 8 }}>Quick Import Templates</div>\n              <div style={{ display: 'flex', gap: 6, flexWrap: 'wrap' }}>\n                {[\n                  { label: '₿ Crypto Position', data: { name: '', assetClass: 'crypto', status: 'active', quantity: 0, costBasis: 0, currentValue: 0, taxTreatment: 'unknown', riskScore: 7, tags: ['crypto'] } },\n                  { label: '🔗 DeFi / LP', data: { name: '', assetClass: 'defi', status: 'staking', quantity: 0, costBasis: 0, currentValue: 0, taxTreatment: 'staking_reward', riskScore: 8, tags: ['defi', 'yield'] } },\n                  { label: '🎯 Pre-TGE Token', data: { name: '', assetClass: 'speculative', status: 'locked', quantity: 0, costBasis: 0, currentValue: 0, taxTreatment: 'airdrop', riskScore: 9, tags: ['pre-TGE', 'locked'], isLocked: true } },\n                  { label: '📈 Equity', data: { name: '', assetClass: 'equity', status: 'active', quantity: 0, costBasis: 0, currentValue: 0, taxTreatment: 'long_term_cg', riskScore: 4, tags: ['equity'] } },\n                ].map(tmpl => (\n                  <button key={tmpl.label} onClick={() => setImportText(JSON.stringify(tmpl.data, null, 2))}\n                    className=\"btn btn-ghost\" style={{ fontSize: 10, padding: '3px 8px' }}>\n                    {tmpl.label}\n                  </button>\n                ))}\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Tabs */}\n      <div style={{ display: 'flex', gap: 2, marginBottom: 20, background: 'var(--bg-surface)', borderRadius: 10, padding: 3, border: '1px solid var(--border-subtle)' }}>\n        {([\n          { key: 'positions', label: 'Positions', icon: <BarChart3 size={13} />, count: data.positions.length },\n          { key: 'opportunities', label: 'Opportunities', icon: <Target size={13} />, count: data.opportunities.length },\n          { key: 'taxevents', label: 'Tax Events', icon: <AlertTriangle size={13} />, count: data.taxEvents.length },\n          { key: 'bridge', label: 'Context Bridge', icon: <ArrowRightLeft size={13} /> },\n          { key: 'import', label: 'CSV Import', icon: <FileUp size={13} /> },\n        ] as const).map(tab => (\n          <button key={tab.key} onClick={() => setActiveTab(tab.key)}\n            style={{\n              flex: 1, padding: '8px 12px', borderRadius: 8, border: 'none', cursor: 'pointer',\n              fontSize: 12, fontWeight: activeTab === tab.key ? 600 : 400, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 6,\n              background: activeTab === tab.key ? 'var(--bg-elevated, rgba(255,255,255,0.08))' : 'transparent',\n              color: activeTab === tab.key ? 'var(--accent-gold)' : 'var(--text-muted)',\n              transition: 'all 0.2s',\n            }}>\n            {tab.icon} {tab.label}\n            {'count' in tab && (tab as any).count > 0 && (\n              <span style={{ fontSize: 9, padding: '1px 5px', borderRadius: 4, background: 'rgba(212,168,67,0.12)', color: 'var(--accent-gold)' }}>\n                {(tab as any).count}\n              </span>\n            )}\n          </button>\n        ))}\n      </div>\n\n      {/* ─── POSITIONS TAB ─────────────────────────────────────────────── */}\n      {activeTab === 'positions' && (\n        <div>\n          <div style={{ display: 'flex', gap: 8, marginBottom: 16 }}>\n            <div style={{ flex: 1, position: 'relative' }}>\n              <Search size={14} style={{ position: 'absolute', left: 10, top: 9, color: 'var(--text-muted)' }} />\n              <input style={{ ...inputStyle, paddingLeft: 30 }} placeholder=\"Search positions, tickers, tags...\" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />\n            </div>\n            <button onClick={addPosition} className=\"btn btn-primary\" style={{ fontSize: 12, padding: '8px 14px', whiteSpace: 'nowrap' }}>\n              <Plus size={13} /> Add Position\n            </button>\n          </div>\n\n          {/* Risk Distribution Bar */}\n          {data.positions.length > 0 && (\n            <div style={{ marginBottom: 16, padding: '10px 14px', borderRadius: 10, background: 'var(--bg-surface)', border: '1px solid var(--border-subtle)' }}>\n              <div style={{ fontSize: 10, fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase', marginBottom: 6 }}>Risk Distribution</div>\n              <div style={{ display: 'flex', height: 6, borderRadius: 3, overflow: 'hidden', gap: 1 }}>\n                {stats.lowRisk > 0 && <div style={{ flex: stats.lowRisk, background: '#10b981', borderRadius: 3 }} />}\n                {stats.medRisk > 0 && <div style={{ flex: stats.medRisk, background: '#f59e0b', borderRadius: 3 }} />}\n                {stats.highRisk > 0 && <div style={{ flex: stats.highRisk, background: '#ef4444', borderRadius: 3 }} />}\n              </div>\n              <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 10, color: 'var(--text-muted)', marginTop: 4 }}>\n                <span style={{ color: '#10b981' }}>Low ({stats.lowRisk})</span>\n                <span style={{ color: '#f59e0b' }}>Medium ({stats.medRisk})</span>\n                <span style={{ color: '#ef4444' }}>High ({stats.highRisk})</span>\n              </div>\n            </div>\n          )}\n\n          {filteredPositions.length === 0 && (\n            <div style={{ textAlign: 'center', padding: 40, color: 'var(--text-muted)' }}>\n              <Briefcase size={32} style={{ opacity: 0.3, marginBottom: 12 }} />\n              <div style={{ fontSize: 13 }}>No positions yet</div>\n              <div style={{ fontSize: 11, marginTop: 4 }}>Add positions manually or import via UIE envelope from external analyses.</div>\n            </div>\n          )}\n\n          {filteredPositions.map(pos => {\n            const gainLoss = pos.currentValue - pos.costBasis\n            const gainPct = pos.costBasis > 0 ? ((gainLoss / pos.costBasis) * 100) : 0\n            const isExpanded = expandedPosition === pos.id\n            const acConfig = ASSET_CLASSES[pos.assetClass]\n            const statusConfig = POSITION_STATUSES[pos.status]\n\n            return (\n              <div key={pos.id} style={{\n                background: 'var(--bg-surface)', borderRadius: 12, marginBottom: 10,\n                border: `1px solid ${isExpanded ? 'var(--accent-gold)' : 'var(--border-subtle)'}`,\n                transition: 'border-color 0.2s',\n              }}>\n                {/* Header Row */}\n                <div style={{ display: 'flex', alignItems: 'center', gap: 10, padding: '12px 14px', cursor: 'pointer' }}\n                  onClick={() => setExpandedPosition(isExpanded ? null : pos.id)}>\n                  <span style={{ fontSize: 18 }}>{acConfig.emoji}</span>\n                  <div style={{ flex: 1, minWidth: 0 }}>\n                    <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>\n                      <span style={{ fontSize: 13, fontWeight: 600, color: 'var(--text-primary)' }}>\n                        {pos.name || '(Untitled)'}\n                      </span>\n                      {pos.ticker && <span style={{ fontSize: 10, fontFamily: 'var(--font-mono)', color: 'var(--text-muted)', background: 'var(--bg-elevated, rgba(255,255,255,0.05))', padding: '1px 5px', borderRadius: 3 }}>{pos.ticker}</span>}\n                      <span style={{ fontSize: 9, padding: '1px 5px', borderRadius: 3, background: `${statusConfig.color}18`, color: statusConfig.color, fontWeight: 600 }}>\n                        {statusConfig.label}\n                      </span>\n                    </div>\n                    <div style={{ fontSize: 10, color: 'var(--text-muted)', marginTop: 2, display: 'flex', gap: 8 }}>\n                      <span>{acConfig.label}</span>\n                      <span>·</span>\n                      <span>{TAX_TREATMENTS[pos.taxTreatment].label}</span>\n                      {pos.tags.length > 0 && <>\n                        <span>·</span>\n                        {pos.tags.map(t => <span key={t} style={{ color: 'var(--accent-gold)' }}>#{t}</span>)}\n                      </>}\n                    </div>\n                  </div>\n                  <div style={{ textAlign: 'right', minWidth: 100 }}>\n                    <div style={{ fontSize: 14, fontWeight: 700, fontFamily: 'var(--font-mono)', color: 'var(--text-primary)' }}>\n                      ${pos.currentValue.toLocaleString()}\n                    </div>\n                    {pos.costBasis > 0 && (\n                      <div style={{ fontSize: 10, fontFamily: 'var(--font-mono)', color: gainLoss >= 0 ? '#10b981' : '#ef4444' }}>\n                        {gainLoss >= 0 ? '+' : ''}{gainPct.toFixed(1)}%\n                      </div>\n                    )}\n                  </div>\n                  <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>\n                    {/* Risk indicator */}\n                    <div style={{\n                      width: 24, height: 24, borderRadius: 6, display: 'flex', alignItems: 'center', justifyContent: 'center',\n                      fontSize: 10, fontWeight: 700, fontFamily: 'var(--font-mono)',\n                      background: pos.riskScore >= 7 ? 'rgba(239,68,68,0.12)' : pos.riskScore >= 4 ? 'rgba(245,158,11,0.12)' : 'rgba(16,185,129,0.12)',\n                      color: pos.riskScore >= 7 ? '#ef4444' : pos.riskScore >= 4 ? '#f59e0b' : '#10b981',\n                    }}>\n                      {pos.riskScore}\n                    </div>\n                    {isExpanded ? <ChevronDown size={14} style={{ color: 'var(--text-muted)' }} /> : <ChevronRight size={14} style={{ color: 'var(--text-muted)' }} />}\n                  </div>\n                </div>\n\n                {/* Expanded Editor */}\n                {isExpanded && (\n                  <div style={{ padding: '0 14px 14px', borderTop: '1px solid var(--border-subtle)' }}>\n                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 10, marginTop: 12 }}>\n                      <div>\n                        <label style={labelStyle}>Name</label>\n                        <input style={inputStyle} value={pos.name} onChange={e => updatePosition(pos.id, { name: e.target.value })} placeholder=\"Asset name\" />\n                      </div>\n                      <div>\n                        <label style={labelStyle}>Ticker / Symbol</label>\n                        <input style={inputStyle} value={pos.ticker || ''} onChange={e => updatePosition(pos.id, { ticker: e.target.value })} placeholder=\"$WN, NODL, BTC...\" />\n                      </div>\n                      <div>\n                        <label style={labelStyle}>Asset Class</label>\n                        <select style={selectStyle} value={pos.assetClass} onChange={e => updatePosition(pos.id, { assetClass: e.target.value as AssetClass })}>\n                          {Object.entries(ASSET_CLASSES).map(([k, v]) => <option key={k} value={k}>{v.emoji} {v.label}</option>)}\n                        </select>\n                      </div>\n                      <div>\n                        <label style={labelStyle}>Status</label>\n                        <select style={selectStyle} value={pos.status} onChange={e => updatePosition(pos.id, { status: e.target.value as PositionStatus })}>\n                          {Object.entries(POSITION_STATUSES).map(([k, v]) => <option key={k} value={k}>{v.label}</option>)}\n                        </select>\n                      </div>\n                    </div>\n                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 10, marginTop: 10 }}>\n                      <div>\n                        <label style={labelStyle}>Quantity</label>\n                        <input style={inputStyle} type=\"number\" value={pos.quantity || ''} onChange={e => updatePosition(pos.id, { quantity: parseFloat(e.target.value) || 0 })} />\n                      </div>\n                      <div>\n                        <label style={labelStyle}>Cost Basis ($)</label>\n                        <input style={inputStyle} type=\"number\" value={pos.costBasis || ''} onChange={e => updatePosition(pos.id, { costBasis: parseFloat(e.target.value) || 0 })} />\n                      </div>\n                      <div>\n                        <label style={labelStyle}>Current Value ($)</label>\n                        <input style={inputStyle} type=\"number\" value={pos.currentValue || ''} onChange={e => updatePosition(pos.id, { currentValue: parseFloat(e.target.value) || 0 })} />\n                      </div>\n                      <div>\n                        <label style={labelStyle}>Tax Treatment</label>\n                        <select style={selectStyle} value={pos.taxTreatment} onChange={e => updatePosition(pos.id, { taxTreatment: e.target.value as TaxTreatment })}>\n                          {Object.entries(TAX_TREATMENTS).map(([k, v]) => <option key={k} value={k}>{v.label}</option>)}\n                        </select>\n                      </div>\n                    </div>\n                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 80px 1fr', gap: 10, marginTop: 10 }}>\n                      <div>\n                        <label style={labelStyle}>Notes</label>\n                        <input style={inputStyle} value={pos.notes} onChange={e => updatePosition(pos.id, { notes: e.target.value })} placeholder=\"Strategy notes, source reference...\" />\n                      </div>\n                      <div>\n                        <label style={labelStyle}>Risk (1-10)</label>\n                        <input style={inputStyle} type=\"number\" min={1} max={10} value={pos.riskScore} onChange={e => updatePosition(pos.id, { riskScore: parseInt(e.target.value) || 5 })} />\n                      </div>\n                      <div>\n                        <label style={labelStyle}>Tags (comma separated)</label>\n                        <input style={inputStyle} value={pos.tags.join(', ')} onChange={e => updatePosition(pos.id, { tags: e.target.value.split(',').map(t => t.trim()).filter(Boolean) })} placeholder=\"pre-TGE, DeFi, peaq...\" />\n                      </div>\n                    </div>\n                    {/* Tax Impact Preview */}\n                    {pos.currentValue > 0 && (\n                      <div style={{\n                        marginTop: 10, padding: '8px 12px', borderRadius: 8,\n                        background: 'rgba(245,158,11,0.06)', border: '1px solid rgba(245,158,11,0.12)',\n                        fontSize: 11, color: 'var(--text-muted)', display: 'flex', gap: 16,\n                      }}>\n                        <span>💡 <strong>Tax Impact if realized:</strong></span>\n                        {pos.taxTreatment === 'long_term_cg' ? (\n                          <span>~${Math.round(gainLoss * 0.15).toLocaleString()} at 15% LTCG rate</span>\n                        ) : pos.taxTreatment === 'airdrop' || pos.taxTreatment === 'mining_income' || pos.taxTreatment === 'staking_reward' ? (\n                          <span>~${Math.round(pos.currentValue * stats.marginalRate).toLocaleString()} as ordinary income at {(stats.marginalRate * 100).toFixed(0)}% marginal rate</span>\n                        ) : (\n                          <span>~${Math.round(Math.max(0, gainLoss) * stats.marginalRate).toLocaleString()} at {(stats.marginalRate * 100).toFixed(0)}% marginal rate</span>\n                        )}\n                      </div>\n                    )}\n                    <div style={{ display: 'flex', justifyContent: 'flex-end', marginTop: 10 }}>\n                      <button onClick={() => removePosition(pos.id)} className=\"btn btn-ghost\" style={{ fontSize: 11, color: 'var(--accent-red)', gap: 4 }}>\n                        <Trash2 size={12} /> Remove\n                      </button>\n                    </div>\n                  </div>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      )}\n\n      {/* ─── OPPORTUNITIES TAB ─────────────────────────────────────────── */}\n      {activeTab === 'opportunities' && (\n        <div>\n          <div style={{ display: 'flex', justifyContent: 'flex-end', marginBottom: 16 }}>\n            <button onClick={addOpportunity} className=\"btn btn-primary\" style={{ fontSize: 12, padding: '8px 14px' }}>\n              <Plus size={13} /> Add Opportunity\n            </button>\n          </div>\n\n          {data.opportunities.length === 0 && (\n            <div style={{ textAlign: 'center', padding: 40, color: 'var(--text-muted)' }}>\n              <Target size={32} style={{ opacity: 0.3, marginBottom: 12 }} />\n              <div style={{ fontSize: 13 }}>No opportunities tracked yet</div>\n              <div style={{ fontSize: 11, marginTop: 4 }}>Import opportunity analyses from conversations or add them manually.</div>\n            </div>\n          )}\n\n          {data.opportunities.map(opp => (\n            <div key={opp.id} className=\"card\" style={{ marginBottom: 12 }}>\n              <div className=\"card-body\" style={{ padding: 14 }}>\n                <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr 120px', gap: 10, marginBottom: 10 }}>\n                  <div>\n                    <label style={labelStyle}>Title</label>\n                    <input style={inputStyle} value={opp.title} onChange={e => updateOpportunity(opp.id, { title: e.target.value })} placeholder=\"e.g. DeNet $WN TGE Opportunity\" />\n                  </div>\n                  <div>\n                    <label style={labelStyle}>Status</label>\n                    <select style={selectStyle} value={opp.status} onChange={e => updateOpportunity(opp.id, { status: e.target.value as any })}>\n                      {['watching', 'researching', 'ready', 'active', 'exited', 'passed'].map(s => (\n                        <option key={s} value={s}>{s.charAt(0).toUpperCase() + s.slice(1)}</option>\n                      ))}\n                    </select>\n                  </div>\n                  <div>\n                    <label style={labelStyle}>Est. Value ($)</label>\n                    <input style={inputStyle} type=\"number\" value={opp.estimatedValue || ''} onChange={e => updateOpportunity(opp.id, { estimatedValue: parseFloat(e.target.value) || 0 })} />\n                  </div>\n                  <div>\n                    <label style={labelStyle}>Confidence %</label>\n                    <input style={inputStyle} type=\"number\" min={0} max={100} value={opp.confidence} onChange={e => updateOpportunity(opp.id, { confidence: parseInt(e.target.value) || 0 })} />\n                  </div>\n                </div>\n                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 10, marginBottom: 10 }}>\n                  <div>\n                    <label style={labelStyle}>Summary</label>\n                    <input style={inputStyle} value={opp.summary} onChange={e => updateOpportunity(opp.id, { summary: e.target.value })} placeholder=\"Brief analysis summary...\" />\n                  </div>\n                  <div>\n                    <label style={labelStyle}>Tax Implications</label>\n                    <input style={inputStyle} value={opp.taxImplications} onChange={e => updateOpportunity(opp.id, { taxImplications: e.target.value })} placeholder=\"e.g. Airdrop = ordinary income at FMV...\" />\n                  </div>\n                </div>\n                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 80px', gap: 10 }}>\n                  <div>\n                    <label style={labelStyle}>Source / Reference</label>\n                    <input style={inputStyle} value={opp.sourceRef || ''} onChange={e => updateOpportunity(opp.id, { sourceRef: e.target.value })} placeholder=\"URL or chat reference\" />\n                  </div>\n                  <div>\n                    <label style={labelStyle}>Tags</label>\n                    <input style={inputStyle} value={opp.tags.join(', ')} onChange={e => updateOpportunity(opp.id, { tags: e.target.value.split(',').map(t => t.trim()).filter(Boolean) })} placeholder=\"DeFi, pre-TGE, DePIN...\" />\n                  </div>\n                  <div style={{ display: 'flex', alignItems: 'flex-end' }}>\n                    <button onClick={() => removeOpportunity(opp.id)} className=\"btn btn-ghost\" style={{ fontSize: 11, color: 'var(--accent-red)', width: '100%', justifyContent: 'center' }}>\n                      <Trash2 size={12} />\n                    </button>\n                  </div>\n                </div>\n              </div>\n            </div>\n          ))}\n        </div>\n      )}\n\n      {/* ─── TAX EVENTS TAB ────────────────────────────────────────────── */}\n      {activeTab === 'taxevents' && (\n        <div>\n          <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 16 }}>\n            <div style={{ fontSize: 12, color: 'var(--text-muted)', display: 'flex', alignItems: 'center', gap: 6 }}>\n              <AlertTriangle size={14} style={{ color: '#f59e0b' }} />\n              {stats.unrealizedEvents} pending events · ~${Math.round(stats.estimatedTaxLiability).toLocaleString()} estimated tax impact\n            </div>\n            <button onClick={addTaxEvent} className=\"btn btn-primary\" style={{ fontSize: 12, padding: '8px 14px' }}>\n              <Plus size={13} /> Add Tax Event\n            </button>\n          </div>\n\n          {data.taxEvents.length === 0 && (\n            <div style={{ textAlign: 'center', padding: 40, color: 'var(--text-muted)' }}>\n              <Clock size={32} style={{ opacity: 0.3, marginBottom: 12 }} />\n              <div style={{ fontSize: 13 }}>No tax events tracked</div>\n              <div style={{ fontSize: 11, marginTop: 4 }}>Add upcoming taxable events (TGEs, vest dates, airdrops, sales) to plan for their impact.</div>\n            </div>\n          )}\n\n          {data.taxEvents.map(evt => (\n            <div key={evt.id} className=\"card\" style={{ marginBottom: 10, borderLeft: `3px solid ${evt.realized ? '#10b981' : '#f59e0b'}` }}>\n              <div className=\"card-body\" style={{ padding: 14 }}>\n                <div style={{ display: 'grid', gridTemplateColumns: '1fr 120px 120px 120px 80px', gap: 10 }}>\n                  <div>\n                    <label style={labelStyle}>Description</label>\n                    <input style={inputStyle} value={evt.description} onChange={e => updateTaxEvent(evt.id, { description: e.target.value })} placeholder=\"e.g. DeNet TGE airdrop\" />\n                  </div>\n                  <div>\n                    <label style={labelStyle}>Type</label>\n                    <select style={selectStyle} value={evt.type} onChange={e => updateTaxEvent(evt.id, { type: e.target.value as any })}>\n                      {['airdrop', 'tge', 'vest', 'sale', 'conversion', 'staking_reward', 'mining', 'income', 'loss'].map(t => (\n                        <option key={t} value={t}>{t.replace('_', ' ').replace(/\\b\\w/g, c => c.toUpperCase())}</option>\n                      ))}\n                    </select>\n                  </div>\n                  <div>\n                    <label style={labelStyle}>Est. Amount ($)</label>\n                    <input style={inputStyle} type=\"number\" value={evt.estimatedAmount || ''} onChange={e => updateTaxEvent(evt.id, { estimatedAmount: parseFloat(e.target.value) || 0 })} />\n                  </div>\n                  <div>\n                    <label style={labelStyle}>Tax Treatment</label>\n                    <select style={selectStyle} value={evt.taxTreatment} onChange={e => updateTaxEvent(evt.id, { taxTreatment: e.target.value as TaxTreatment })}>\n                      {Object.entries(TAX_TREATMENTS).map(([k, v]) => <option key={k} value={k}>{v.label}</option>)}\n                    </select>\n                  </div>\n                  <div style={{ display: 'flex', flexDirection: 'column', gap: 4 }}>\n                    <label style={labelStyle}>Realized?</label>\n                    <div style={{ display: 'flex', gap: 4, alignItems: 'center' }}>\n                      <input type=\"checkbox\" checked={evt.realized} onChange={e => updateTaxEvent(evt.id, { realized: e.target.checked })} />\n                      <button onClick={() => removeTaxEvent(evt.id)} style={{ background: 'none', border: 'none', color: 'var(--accent-red)', cursor: 'pointer', padding: 2 }}>\n                        <Trash2 size={12} />\n                      </button>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          ))}\n        </div>\n      )}\n\n      {/* ─── CONTEXT BRIDGE TAB ────────────────────────────────────────── */}\n      {activeTab === 'bridge' && (\n        <div>\n          {/* UIF Architecture Diagram */}\n          <div className=\"card\" style={{ marginBottom: 20 }}>\n            <div className=\"card-header\">\n              <span className=\"card-title\" style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n                <Link2 size={16} /> Universal Integration Framework — Financial Context Layer\n              </span>\n            </div>\n            <div className=\"card-body\">\n              <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.6, marginBottom: 16 }}>\n                The UIF Context Bridge enables bidirectional data flow between Fortuna and any AEGIS ecosystem solution.\n                Financial context (positions, tax events, income data, entity structures) is packaged into UIE envelopes\n                that any solution can produce or consume.\n              </div>\n\n              {/* Layer visualization */}\n              <div style={{ display: 'flex', flexDirection: 'column', gap: 4 }}>\n                {[\n                  { layer: 'L5', name: 'AI Orchestration', desc: 'Auto-classify imported data, detect strategies, project tax impact', color: '#8b5cf6', active: true },\n                  { layer: 'L4', name: 'Events', desc: 'TGE alerts, position changes, tax deadline triggers, vest notifications', color: '#ec4899', active: true },\n                  { layer: 'L3', name: 'Shared Services', desc: 'Tax calculator, risk scoring, asset valuation, marginal rate engine', color: '#3b82f6', active: true },\n                  { layer: 'L2', name: 'API', desc: 'Import (paste/upload) + Export (JSON/clipboard) — UIE envelope format', color: '#10b981', active: true },\n                  { layer: 'L1', name: 'UIE Envelopes', desc: 'Standardized financial context containers: positions, events, opportunities', color: '#f59e0b', active: true },\n                ].map(layer => (\n                  <div key={layer.layer} style={{\n                    display: 'flex', alignItems: 'center', gap: 10, padding: '8px 12px',\n                    borderRadius: 8, background: `${layer.color}08`, border: `1px solid ${layer.color}15`,\n                  }}>\n                    <div style={{\n                      width: 32, height: 24, borderRadius: 4, display: 'flex', alignItems: 'center', justifyContent: 'center',\n                      fontSize: 10, fontWeight: 700, fontFamily: 'var(--font-mono)',\n                      background: `${layer.color}15`, color: layer.color,\n                    }}>\n                      {layer.layer}\n                    </div>\n                    <div style={{ flex: 1 }}>\n                      <div style={{ fontSize: 12, fontWeight: 600, color: 'var(--text-primary)' }}>{layer.name}</div>\n                      <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>{layer.desc}</div>\n                    </div>\n                    <div style={{\n                      width: 8, height: 8, borderRadius: 4,\n                      background: layer.active ? layer.color : 'var(--text-muted)',\n                      boxShadow: layer.active ? `0 0 6px ${layer.color}40` : 'none',\n                    }} />\n                  </div>\n                ))}\n              </div>\n            </div>\n          </div>\n\n          {/* Protocol Mapping */}\n          <div className=\"card\" style={{ marginBottom: 20 }}>\n            <div className=\"card-header\">\n              <span className=\"card-title\"><Sparkles size={16} /> AEGIS Protocol Mapping</span>\n            </div>\n            <div className=\"card-body\">\n              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 10 }}>\n                {[\n                  { protocol: 'UCP', name: 'Unified Communication', mapping: 'Financial context envelopes, portfolio state broadcasts, cross-solution messaging', color: '#3b82f6' },\n                  { protocol: 'MCP', name: 'Model Context', mapping: 'Tax calculator tools, risk scoring models, strategy detection engine', color: '#10b981' },\n                  { protocol: 'A2A', name: 'Agent-to-Agent', mapping: 'Portfolio monitoring agents, tax event watchers, opportunity scouts', color: '#8b5cf6' },\n                  { protocol: 'ACP', name: 'Autonomous Commerce', mapping: 'Revenue tracking from positions, LP fee income, staking rewards', color: '#f59e0b' },\n                ].map(p => (\n                  <div key={p.protocol} style={{\n                    padding: 12, borderRadius: 10, background: `${p.color}06`, border: `1px solid ${p.color}12`,\n                  }}>\n                    <div style={{ fontSize: 13, fontWeight: 700, color: p.color, marginBottom: 2 }}>{p.protocol}</div>\n                    <div style={{ fontSize: 10, color: 'var(--text-muted)', marginBottom: 6 }}>{p.name}</div>\n                    <div style={{ fontSize: 11, color: 'var(--text-secondary)', lineHeight: 1.5 }}>{p.mapping}</div>\n                  </div>\n                ))}\n              </div>\n            </div>\n          </div>\n\n          {/* Compatible Solutions */}\n          <div className=\"card\" style={{ marginBottom: 20 }}>\n            <div className=\"card-header\">\n              <span className=\"card-title\"><Globe size={16} /> Compatible Ecosystem Solutions</span>\n            </div>\n            <div className=\"card-body\">\n              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 8 }}>\n                {[\n                  { name: 'Fortuna Engine', desc: 'Tax strategy & financial planning', emoji: '⚡', status: 'Active' },\n                  { name: 'AEGIS Framework', desc: 'Autonomous revenue & governance', emoji: '🛡️', status: 'Compatible' },\n                  { name: 'IdeaForge', desc: 'Opportunity ideation pipeline', emoji: '💡', status: 'Compatible' },\n                  { name: 'RESONANCE', desc: 'Revenue tracking from content', emoji: '🔊', status: 'Planned' },\n                  { name: 'LaunchFlow', desc: 'Service delivery revenue', emoji: '🚀', status: 'Planned' },\n                  { name: 'Claude Conversations', desc: 'Analysis import via paste', emoji: '💬', status: 'Active' },\n                ].map(sol => (\n                  <div key={sol.name} style={{\n                    padding: '10px 12px', borderRadius: 8, background: 'var(--bg-surface)', border: '1px solid var(--border-subtle)',\n                    display: 'flex', alignItems: 'center', gap: 10,\n                  }}>\n                    <span style={{ fontSize: 20 }}>{sol.emoji}</span>\n                    <div style={{ flex: 1 }}>\n                      <div style={{ fontSize: 12, fontWeight: 600, color: 'var(--text-primary)' }}>{sol.name}</div>\n                      <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>{sol.desc}</div>\n                    </div>\n                    <span style={{\n                      fontSize: 9, padding: '2px 6px', borderRadius: 4, fontWeight: 600,\n                      background: sol.status === 'Active' ? 'rgba(16,185,129,0.12)' : sol.status === 'Compatible' ? 'rgba(59,130,246,0.12)' : 'rgba(107,114,128,0.12)',\n                      color: sol.status === 'Active' ? '#10b981' : sol.status === 'Compatible' ? '#3b82f6' : '#6b7280',\n                    }}>\n                      {sol.status}\n                    </span>\n                  </div>\n                ))}\n              </div>\n            </div>\n          </div>\n\n          {/* Import History */}\n          {data.envelopeHistory.length > 0 && (\n            <div className=\"card\">\n              <div className=\"card-header\">\n                <span className=\"card-title\"><FileText size={16} /> Import History</span>\n              </div>\n              <div className=\"card-body\">\n                {data.envelopeHistory.map((entry, i) => (\n                  <div key={i} style={{ display: 'flex', alignItems: 'center', gap: 10, padding: '8px 0', borderBottom: i < data.envelopeHistory.length - 1 ? '1px solid var(--border-subtle)' : 'none' }}>\n                    <Upload size={12} style={{ color: 'var(--text-muted)' }} />\n                    <div style={{ flex: 1 }}>\n                      <span style={{ fontSize: 12, fontWeight: 500 }}>{entry.imported}</span>\n                      <span style={{ fontSize: 10, color: 'var(--text-muted)', marginLeft: 8 }}>{entry.positionCount} positions</span>\n                    </div>\n                    <span style={{ fontSize: 10, color: 'var(--text-muted)' }}>{new Date(entry.date).toLocaleDateString()}</span>\n                  </div>\n                ))}\n              </div>\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* ─── CSV IMPORT TAB ────────────────────────────────────────────── */}\n      {activeTab === 'import' && (\n        <div>\n          {/* Progress Steps */}\n          <div style={{ display: 'flex', gap: 4, marginBottom: 20 }}>\n            {(['select', 'upload', 'map', 'preview', 'done'] as const).map((step, i) => {\n              const labels = ['Select Source', 'Upload CSV', 'Map Columns', 'Preview & Confirm', 'Complete']\n              const icons = [<Globe size={12} key=\"g\" />, <FileUp size={12} key=\"f\" />, <Table2 size={12} key=\"t\" />, <Eye size={12} key=\"e\" />, <CheckCircle2 size={12} key=\"c\" />]\n              const stepOrder = ['select', 'upload', 'map', 'preview', 'done'] as const\n              const currentIdx = stepOrder.indexOf(csvStep)\n              const isActive = step === csvStep\n              const isPast = i < currentIdx\n              return (\n                <div key={step} style={{\n                  flex: 1, padding: '8px 6px', borderRadius: 8, textAlign: 'center', fontSize: 10, cursor: isPast ? 'pointer' : 'default',\n                  background: isActive ? 'rgba(212,168,67,0.12)' : isPast ? 'rgba(16,185,129,0.08)' : 'var(--bg-surface)',\n                  color: isActive ? 'var(--accent-gold)' : isPast ? '#10b981' : 'var(--text-muted)',\n                  border: `1px solid ${isActive ? 'var(--accent-gold)' : isPast ? 'rgba(16,185,129,0.2)' : 'var(--border-subtle)'}`,\n                  fontWeight: isActive ? 600 : 400, transition: 'all 0.2s',\n                }} onClick={() => isPast && setCsvStep(step)}>\n                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 4 }}>\n                    {isPast ? <Check size={12} /> : icons[i]} {labels[i]}\n                  </div>\n                </div>\n              )\n            })}\n          </div>\n\n          {/* Step 1: Select Source */}\n          {csvStep === 'select' && (\n            <div>\n              <div className=\"card\">\n                <div className=\"card-header\">\n                  <span className=\"card-title\"><Globe size={16} /> Select Data Source</span>\n                </div>\n                <div className=\"card-body\">\n                  <p style={{ fontSize: 13, color: 'var(--text-muted)', marginBottom: 16, lineHeight: 1.6 }}>\n                    Choose the platform your CSV export came from. Fortuna will automatically detect column layouts and transaction types for supported platforms.\n                  </p>\n                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: 10 }}>\n                    {SUPPORTED_FORMATS.map(fmt => (\n                      <button key={fmt.id} onClick={() => { setCsvFormat(fmt.id); setCsvStep('upload') }}\n                        style={{\n                          padding: '14px 16px', borderRadius: 10, border: `1px solid ${csvFormat === fmt.id ? 'var(--accent-gold)' : 'var(--border-subtle)'}`,\n                          background: csvFormat === fmt.id ? 'rgba(212,168,67,0.08)' : 'var(--bg-surface)',\n                          cursor: 'pointer', textAlign: 'left', transition: 'all 0.15s',\n                        }}\n                        onMouseOver={e => (e.currentTarget.style.borderColor = 'var(--accent-gold)')}\n                        onMouseOut={e => (e.currentTarget.style.borderColor = csvFormat === fmt.id ? 'var(--accent-gold)' : 'var(--border-subtle)')}>\n                        <div style={{ fontSize: 20, marginBottom: 4 }}>{fmt.icon}</div>\n                        <div style={{ fontSize: 13, fontWeight: 600, color: 'var(--text-primary)' }}>{fmt.label}</div>\n                        <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 2 }}>{fmt.description}</div>\n                      </button>\n                    ))}\n                  </div>\n                  <div style={{ marginTop: 16, padding: '10px 14px', borderRadius: 8, background: 'rgba(59,130,246,0.06)', border: '1px solid rgba(59,130,246,0.15)', fontSize: 11, color: 'var(--text-muted)', display: 'flex', gap: 8, alignItems: 'flex-start' }}>\n                    <Info size={14} style={{ flexShrink: 0, marginTop: 1, color: '#3b82f6' }} />\n                    <span>\n                      <strong style={{ color: 'var(--text-primary)' }}>Auto-detect available:</strong> You can also skip this step — upload any CSV and Fortuna will attempt to automatically identify the format from the column headers.\n                    </span>\n                  </div>\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* Step 2: Upload CSV */}\n          {csvStep === 'upload' && (\n            <div>\n              <div className=\"card\">\n                <div className=\"card-header\">\n                  <span className=\"card-title\"><FileUp size={16} /> Upload {csvFormat ? SUPPORTED_FORMATS.find(f => f.id === csvFormat)?.label : ''} CSV</span>\n                  <button onClick={() => setCsvStep('select')} style={{ padding: '4px 10px', fontSize: 11, borderRadius: 6, border: '1px solid var(--border-subtle)', background: 'transparent', color: 'var(--text-muted)', cursor: 'pointer' }}>← Back</button>\n                </div>\n                <div className=\"card-body\">\n                  {/* Drag & Drop Zone */}\n                  <div\n                    onDragOver={e => { e.preventDefault(); setCsvDragOver(true) }}\n                    onDragLeave={() => setCsvDragOver(false)}\n                    onDrop={e => {\n                      e.preventDefault(); setCsvDragOver(false)\n                      const file = e.dataTransfer.files[0]\n                      if (file) {\n                        const reader = new FileReader()\n                        reader.onload = ev => {\n                          const text = ev.target?.result as string\n                          setCsvRawText(text)\n                          processImport(text)\n                        }\n                        reader.readAsText(file)\n                      }\n                    }}\n                    style={{\n                      padding: 40, borderRadius: 12, textAlign: 'center', cursor: 'pointer',\n                      border: `2px dashed ${csvDragOver ? 'var(--accent-gold)' : 'var(--border-subtle)'}`,\n                      background: csvDragOver ? 'rgba(212,168,67,0.06)' : 'transparent',\n                      transition: 'all 0.2s',\n                    }}\n                    onClick={() => {\n                      const input = document.createElement('input')\n                      input.type = 'file'\n                      input.accept = '.csv,.txt,.tsv'\n                      input.onchange = (e: any) => {\n                        const file = e.target?.files?.[0]\n                        if (file) {\n                          const reader = new FileReader()\n                          reader.onload = ev => {\n                            const text = ev.target?.result as string\n                            setCsvRawText(text)\n                            processImport(text)\n                          }\n                          reader.readAsText(file)\n                        }\n                      }\n                      input.click()\n                    }}>\n                    <FileUp size={40} style={{ color: csvDragOver ? 'var(--accent-gold)' : 'var(--text-muted)', marginBottom: 12 }} />\n                    <div style={{ fontSize: 14, fontWeight: 500, color: 'var(--text-primary)', marginBottom: 4 }}>\n                      Drop your CSV file here, or click to browse\n                    </div>\n                    <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>\n                      Supports .csv, .txt, and .tsv files up to 50MB\n                    </div>\n                  </div>\n\n                  {/* Or Paste */}\n                  <div style={{ textAlign: 'center', margin: '16px 0', fontSize: 11, color: 'var(--text-muted)' }}>— or paste CSV data directly —</div>\n                  <textarea\n                    placeholder=\"Paste your CSV data here...\"\n                    value={csvRawText}\n                    onChange={e => setCsvRawText(e.target.value)}\n                    style={{\n                      width: '100%', minHeight: 120, padding: 12, borderRadius: 8, fontSize: 11, fontFamily: 'monospace',\n                      border: '1px solid var(--border-subtle)', background: 'var(--bg-surface)', color: 'var(--text-primary)',\n                      resize: 'vertical',\n                    }}\n                  />\n                  {csvRawText && (\n                    <div style={{ marginTop: 10, display: 'flex', gap: 8 }}>\n                      <button onClick={() => processImport(csvRawText)} style={{\n                        flex: 1, padding: '10px 16px', borderRadius: 8, border: 'none', cursor: 'pointer',\n                        background: 'var(--accent-gold)', color: '#1a1a1a', fontWeight: 600, fontSize: 13,\n                      }}>\n                        <Zap size={14} style={{ verticalAlign: 'middle', marginRight: 6 }} />\n                        Parse & Import\n                      </button>\n                      <button onClick={() => { setCsvRawText(''); setCsvResult(null) }} style={{\n                        padding: '10px 16px', borderRadius: 8, border: '1px solid var(--border-subtle)',\n                        background: 'transparent', color: 'var(--text-muted)', cursor: 'pointer', fontSize: 13,\n                      }}>Clear</button>\n                    </div>\n                  )}\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* Step 3: Column Mapping (for custom CSV) */}\n          {csvStep === 'map' && csvResult && (\n            <div>\n              <div className=\"card\">\n                <div className=\"card-header\">\n                  <span className=\"card-title\"><Table2 size={16} /> Map Columns</span>\n                  <button onClick={() => setCsvStep('upload')} style={{ padding: '4px 10px', fontSize: 11, borderRadius: 6, border: '1px solid var(--border-subtle)', background: 'transparent', color: 'var(--text-muted)', cursor: 'pointer' }}>← Back</button>\n                </div>\n                <div className=\"card-body\">\n                  <p style={{ fontSize: 12, color: 'var(--text-muted)', marginBottom: 14 }}>\n                    Fortuna couldn't auto-detect your CSV format. Please map the columns below. Only <strong>Asset</strong> is required — other fields are recommended for accuracy.\n                  </p>\n                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 10 }}>\n                    {(['date', 'asset', 'type', 'quantity', 'price', 'total', 'fee', 'notes'] as const).map(field => {\n                      const labels: Record<string, string> = { date: 'Date', asset: 'Asset / Ticker *', type: 'Transaction Type', quantity: 'Quantity', price: 'Price per Unit', total: 'Total Value', fee: 'Fee', notes: 'Notes / Memo' }\n                      return (\n                        <div key={field}>\n                          <label style={{ fontSize: 11, color: 'var(--text-muted)', fontWeight: 500 }}>{labels[field]}</label>\n                          <select\n                            value={csvMapping[field] ?? ''}\n                            onChange={e => setCsvMapping(prev => ({ ...prev, [field]: e.target.value === '' ? undefined : parseInt(e.target.value) }))}\n                            style={{\n                              width: '100%', padding: '8px 10px', marginTop: 4, borderRadius: 6, fontSize: 12,\n                              border: '1px solid var(--border-subtle)', background: 'var(--bg-surface)', color: 'var(--text-primary)',\n                            }}>\n                            <option value=\"\">— Skip —</option>\n                            {csvResult.rawHeaders.map((h, i) => (\n                              <option key={i} value={i}>{h || `Column ${i + 1}`}</option>\n                            ))}\n                          </select>\n                        </div>\n                      )\n                    })}\n                  </div>\n                  <button onClick={() => {\n                    const result = importCSV(csvRawText, 'custom', csvMapping)\n                    setCsvResult(result)\n                    setCsvStep('preview')\n                  }} style={{\n                    marginTop: 16, width: '100%', padding: '10px 16px', borderRadius: 8, border: 'none',\n                    cursor: 'pointer', background: 'var(--accent-gold)', color: '#1a1a1a', fontWeight: 600, fontSize: 13,\n                  }}>\n                    Apply Mapping & Preview →\n                  </button>\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* Step 4: Preview & Confirm */}\n          {csvStep === 'preview' && csvResult && (\n            <div>\n              {/* Summary Stats */}\n              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 10, marginBottom: 16 }}>\n                {[\n                  { label: 'Source', value: csvResult.source, icon: <Globe size={14} />, color: '#3b82f6' },\n                  { label: 'Positions', value: csvResult.positions.length.toString(), icon: <BarChart3 size={14} />, color: '#10b981' },\n                  { label: 'Tax Events', value: csvResult.taxEvents.length.toString(), icon: <AlertTriangle size={14} />, color: '#f59e0b' },\n                  { label: 'Rows Parsed', value: `${csvResult.totalRows - csvResult.skippedRows}/${csvResult.totalRows}`, icon: <Table2 size={14} />, color: '#8b5cf6' },\n                ].map((s, i) => (\n                  <div key={i} style={{ padding: '12px 14px', borderRadius: 10, background: 'var(--bg-surface)', border: '1px solid var(--border-subtle)' }}>\n                    <div style={{ display: 'flex', alignItems: 'center', gap: 6, fontSize: 10, color: 'var(--text-muted)', marginBottom: 4 }}>\n                      <span style={{ color: s.color }}>{s.icon}</span> {s.label}\n                    </div>\n                    <div style={{ fontSize: 18, fontWeight: 700, color: 'var(--text-primary)' }}>{s.value}</div>\n                  </div>\n                ))}\n              </div>\n\n              {/* Warnings */}\n              {csvResult.warnings.length > 0 && (\n                <div style={{ marginBottom: 14, padding: '10px 14px', borderRadius: 8, background: 'rgba(245,158,11,0.06)', border: '1px solid rgba(245,158,11,0.2)' }}>\n                  {csvResult.warnings.map((w, i) => (\n                    <div key={i} style={{ fontSize: 11, color: '#f59e0b', display: 'flex', gap: 6, alignItems: 'center', padding: '2px 0' }}>\n                      <AlertTriangle size={11} /> {w}\n                    </div>\n                  ))}\n                </div>\n              )}\n\n              {/* Position Preview */}\n              <div className=\"card\" style={{ marginBottom: 14 }}>\n                <div className=\"card-header\">\n                  <span className=\"card-title\"><BarChart3 size={16} /> Positions to Import ({csvResult.positions.length})</span>\n                </div>\n                <div className=\"card-body\">\n                  {csvResult.positions.length === 0 ? (\n                    <div style={{ textAlign: 'center', padding: 20, fontSize: 12, color: 'var(--text-muted)' }}>No positions extracted</div>\n                  ) : (\n                    <div style={{ maxHeight: 300, overflow: 'auto' }}>\n                      <table style={{ width: '100%', fontSize: 11, borderCollapse: 'collapse' }}>\n                        <thead>\n                          <tr style={{ borderBottom: '1px solid var(--border-subtle)' }}>\n                            {['Asset', 'Class', 'Qty', 'Cost Basis', 'Value', 'G/L', 'Tax Treatment', 'Risk'].map(h => (\n                              <th key={h} style={{ padding: '6px 8px', textAlign: 'left', fontSize: 10, color: 'var(--text-muted)', fontWeight: 600 }}>{h}</th>\n                            ))}\n                          </tr>\n                        </thead>\n                        <tbody>\n                          {csvResult.positions.map((pos, i) => {\n                            const gl = pos.currentValue - pos.costBasis\n                            const glPct = pos.costBasis > 0 ? (gl / pos.costBasis) * 100 : 0\n                            return (\n                              <tr key={i} style={{ borderBottom: '1px solid var(--border-subtle)' }}>\n                                <td style={{ padding: '6px 8px', fontWeight: 600 }}>{pos.ticker || pos.name}</td>\n                                <td style={{ padding: '6px 8px' }}>{ASSET_CLASSES[pos.assetClass]?.emoji} {ASSET_CLASSES[pos.assetClass]?.label}</td>\n                                <td style={{ padding: '6px 8px', fontFamily: 'monospace' }}>{pos.quantity.toLocaleString(undefined, { maximumFractionDigits: 6 })}</td>\n                                <td style={{ padding: '6px 8px', fontFamily: 'monospace' }}>${pos.costBasis.toLocaleString(undefined, { maximumFractionDigits: 2 })}</td>\n                                <td style={{ padding: '6px 8px', fontFamily: 'monospace' }}>${pos.currentValue.toLocaleString(undefined, { maximumFractionDigits: 2 })}</td>\n                                <td style={{ padding: '6px 8px', fontFamily: 'monospace', color: gl >= 0 ? '#10b981' : '#ef4444' }}>\n                                  {gl >= 0 ? '+' : ''}{glPct.toFixed(1)}%\n                                </td>\n                                <td style={{ padding: '6px 8px', fontSize: 10 }}>{TAX_TREATMENTS[pos.taxTreatment]?.label}</td>\n                                <td style={{ padding: '6px 8px' }}>\n                                  <span style={{ display: 'inline-block', width: 8, height: 8, borderRadius: '50%', background: pos.riskScore <= 3 ? '#10b981' : pos.riskScore <= 6 ? '#f59e0b' : '#ef4444', marginRight: 4 }} />\n                                  {pos.riskScore}\n                                </td>\n                              </tr>\n                            )\n                          })}\n                        </tbody>\n                      </table>\n                    </div>\n                  )}\n                </div>\n              </div>\n\n              {/* Tax Events Preview */}\n              {csvResult.taxEvents.length > 0 && (\n                <div className=\"card\" style={{ marginBottom: 14 }}>\n                  <div className=\"card-header\">\n                    <span className=\"card-title\"><AlertTriangle size={16} /> Tax Events Detected ({csvResult.taxEvents.length})</span>\n                  </div>\n                  <div className=\"card-body\">\n                    <div style={{ maxHeight: 200, overflow: 'auto' }}>\n                      {csvResult.taxEvents.slice(0, 20).map((evt, i) => (\n                        <div key={i} style={{ display: 'flex', alignItems: 'center', gap: 10, padding: '6px 0', borderBottom: '1px solid var(--border-subtle)', fontSize: 11 }}>\n                          <span style={{ fontSize: 14 }}>\n                            {evt.type === 'sale' ? '💰' : evt.type === 'staking_reward' ? '🥩' : evt.type === 'airdrop' ? '🎁' : evt.type === 'mining' ? '⛏️' : evt.type === 'conversion' ? '🔄' : evt.type === 'income' ? '💵' : '📋'}\n                          </span>\n                          <div style={{ flex: 1 }}>\n                            <div style={{ fontWeight: 500 }}>{evt.description}</div>\n                            <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>{TAX_TREATMENTS[evt.taxTreatment]?.label}{evt.expectedDate ? ` • ${evt.expectedDate}` : ''}</div>\n                          </div>\n                          <span style={{ fontFamily: 'monospace', fontWeight: 600, color: evt.type === 'loss' ? '#ef4444' : 'var(--accent-gold)' }}>\n                            ${evt.estimatedAmount.toLocaleString(undefined, { maximumFractionDigits: 2 })}\n                          </span>\n                        </div>\n                      ))}\n                      {csvResult.taxEvents.length > 20 && (\n                        <div style={{ fontSize: 11, color: 'var(--text-muted)', padding: '8px 0', textAlign: 'center' }}>\n                          + {csvResult.taxEvents.length - 20} more events\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                </div>\n              )}\n\n              {/* Confirm Button */}\n              <div style={{ display: 'flex', gap: 10 }}>\n                <button onClick={() => setCsvStep('upload')} style={{\n                  padding: '12px 20px', borderRadius: 8, border: '1px solid var(--border-subtle)',\n                  background: 'transparent', color: 'var(--text-muted)', cursor: 'pointer', fontSize: 13,\n                }}>← Re-upload</button>\n                <button onClick={() => confirmImport()} style={{\n                  flex: 1, padding: '12px 20px', borderRadius: 8, border: 'none', cursor: 'pointer',\n                  background: 'linear-gradient(135deg, #10b981, #059669)', color: 'white', fontWeight: 600, fontSize: 14,\n                  boxShadow: '0 2px 8px rgba(16,185,129,0.3)',\n                }}>\n                  <CheckCircle2 size={16} style={{ verticalAlign: 'middle', marginRight: 8 }} />\n                  Import {csvResult.positions.length} Positions & {csvResult.taxEvents.length} Tax Events\n                </button>\n              </div>\n            </div>\n          )}\n\n          {/* Step 5: Done */}\n          {csvStep === 'done' && csvResult && (\n            <div className=\"card\">\n              <div className=\"card-body\" style={{ textAlign: 'center', padding: 40 }}>\n                <CheckCircle2 size={48} style={{ color: '#10b981', marginBottom: 16 }} />\n                <h3 style={{ fontSize: 18, fontWeight: 700, color: 'var(--text-primary)', marginBottom: 8 }}>Import Complete!</h3>\n                <p style={{ fontSize: 13, color: 'var(--text-muted)', marginBottom: 20, lineHeight: 1.6 }}>\n                  Successfully imported <strong style={{ color: '#10b981' }}>{csvResult.positions.length} positions</strong> and <strong style={{ color: '#f59e0b' }}>{csvResult.taxEvents.length} tax events</strong> from {csvResult.source}.\n                  <br />All data has been merged into your Portfolio Intelligence module and is now flowing into the tax calculator, strategy detector, proactive alerts, and AI advisor.\n                </p>\n                <div style={{ display: 'flex', gap: 10, justifyContent: 'center' }}>\n                  <button onClick={() => { setActiveTab('positions') }} style={{\n                    padding: '10px 20px', borderRadius: 8, border: 'none', cursor: 'pointer',\n                    background: 'var(--accent-gold)', color: '#1a1a1a', fontWeight: 600, fontSize: 13,\n                  }}>\n                    <BarChart3 size={14} style={{ verticalAlign: 'middle', marginRight: 6 }} />\n                    View Positions\n                  </button>\n                  <button onClick={() => {\n                    setCsvStep('select'); setCsvFormat(null); setCsvResult(null); setCsvRawText('')\n                  }} style={{\n                    padding: '10px 20px', borderRadius: 8, border: '1px solid var(--border-subtle)',\n                    background: 'transparent', color: 'var(--text-primary)', cursor: 'pointer', fontSize: 13,\n                  }}>\n                    <Plus size={14} style={{ verticalAlign: 'middle', marginRight: 6 }} />\n                    Import Another Source\n                  </button>\n                </div>\n              </div>\n            </div>\n          )}\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\ProactiveAlerts.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ProactiveAlert' is defined but never used.","line":3,"column":78,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":92,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ProactiveAlert"},"fix":{"range":[161,182],"text":""},"desc":"Remove unused variable \"ProactiveAlert\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ctx' is assigned a value but never used.","line":22,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":22,"endColumn":12},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":110,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":110,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5481,5484],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5481,5484],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { generateProactiveAlerts, getFinancialPulse, getQuarterContext, type ProactiveAlert, type AlertSeverity } from '../engine/proactive-intelligence'\nimport { Bell, AlertTriangle, Zap, Info, Clock, ChevronDown, ChevronUp, ExternalLink, X, TrendingUp } from 'lucide-react'\nimport type { ViewKey } from '../App'\n\nconst severityConfig: Record<AlertSeverity, { label: string; color: string; bg: string; icon: React.ReactNode }> = {\n  urgent: { label: 'URGENT', color: '#ef4444', bg: 'rgba(239,68,68,0.08)', icon: <AlertTriangle size={16} /> },\n  warning: { label: 'WARNING', color: '#f59e0b', bg: 'rgba(245,158,11,0.08)', icon: <AlertTriangle size={16} /> },\n  opportunity: { label: 'OPPORTUNITY', color: '#10b981', bg: 'rgba(16,185,129,0.08)', icon: <TrendingUp size={16} /> },\n  info: { label: 'INFO', color: '#6b7280', bg: 'rgba(107,114,128,0.06)', icon: <Info size={16} /> },\n}\n\nexport function ProactiveAlerts({ onNavigate }: { onNavigate?: (view: ViewKey) => void }) {\n  const { state } = useFortuna()\n  const [expandedId, setExpandedId] = useState<string | null>(null)\n  const [dismissedIds, setDismissedIds] = useState<Set<string>>(new Set())\n  const [filter, setFilter] = useState<AlertSeverity | 'all'>('all')\n  \n  const alerts = useMemo(() => generateProactiveAlerts(state), [state])\n  const pulse = useMemo(() => getFinancialPulse(state), [state])\n  const ctx = getQuarterContext()\n  \n  const visibleAlerts = alerts.filter(a => !dismissedIds.has(a.id) && (filter === 'all' || a.severity === filter))\n  const urgentCount = alerts.filter(a => a.severity === 'urgent').length\n  const warningCount = alerts.filter(a => a.severity === 'warning').length\n  const oppCount = alerts.filter(a => a.severity === 'opportunity').length\n  \n  const dismiss = (id: string) => {\n    setDismissedIds(prev => new Set([...prev, id]))\n  }\n  \n  return (\n    <div style={{ padding: 32, maxWidth: 900 }}>\n      {/* Header */}\n      <div style={{ marginBottom: 32 }}>\n        <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 8 }}>\n          <Bell size={24} style={{ color: 'var(--accent-gold)' }} />\n          <h1 style={{ fontFamily: 'var(--font-display)', fontSize: 28, color: 'var(--text-primary)', margin: 0 }}>\n            Intelligence Feed\n          </h1>\n        </div>\n        <p style={{ color: 'var(--text-muted)', fontSize: 14, margin: 0 }}>\n          Proactive monitoring • Time-sensitive alerts • Optimization opportunities\n        </p>\n      </div>\n      \n      {/* Financial Pulse */}\n      <div style={{\n        padding: 24, background: 'var(--bg-elevated)', borderRadius: 16,\n        border: '1px solid var(--border-subtle)', marginBottom: 24,\n      }}>\n        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>\n          <div>\n            <div style={{ fontSize: 11, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.08em', marginBottom: 6 }}>\n              Financial Pulse\n            </div>\n            <div style={{ fontSize: 20, fontWeight: 700, color: urgentCount > 0 ? 'var(--accent-red)' : 'var(--text-primary)' }}>\n              {pulse.headline}\n            </div>\n            <div style={{ fontSize: 13, color: 'var(--text-muted)', marginTop: 4 }}>\n              {pulse.subheadline}\n            </div>\n          </div>\n          \n          {pulse.nextDeadline && (\n            <div style={{\n              textAlign: 'right', padding: '10px 16px', background: 'var(--bg-primary)',\n              borderRadius: 10, border: '1px solid var(--border-subtle)',\n            }}>\n              <div style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.05em' }}>\n                Next Deadline\n              </div>\n              <div style={{ fontFamily: 'var(--font-mono)', fontSize: 18, fontWeight: 700, color: pulse.nextDeadline.daysUntil <= 14 ? 'var(--accent-red)' : 'var(--accent-gold)' }}>\n                {pulse.nextDeadline.daysUntil}d\n              </div>\n              <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>\n                {pulse.nextDeadline.name}\n              </div>\n            </div>\n          )}\n        </div>\n        \n        {/* Quarter context bar */}\n        <div style={{\n          marginTop: 16, padding: '10px 14px', background: 'var(--bg-primary)', borderRadius: 8,\n          display: 'flex', justifyContent: 'space-between', alignItems: 'center',\n          fontSize: 12, color: 'var(--text-muted)',\n        }}>\n          <span>{pulse.quarterSummary}</span>\n          {pulse.estimatedSavingsAvailable > 0 && (\n            <span style={{ color: 'var(--accent-emerald)', fontWeight: 600, fontFamily: 'var(--font-mono)' }}>\n              ${Math.round(pulse.estimatedSavingsAvailable).toLocaleString()} savings potential\n            </span>\n          )}\n        </div>\n      </div>\n      \n      {/* Filter tabs */}\n      <div style={{ display: 'flex', gap: 8, marginBottom: 20 }}>\n        {[\n          { key: 'all', label: `All (${alerts.length})` },\n          { key: 'urgent', label: `Urgent (${urgentCount})` },\n          { key: 'warning', label: `Warning (${warningCount})` },\n          { key: 'opportunity', label: `Opportunity (${oppCount})` },\n          { key: 'info', label: 'Info' },\n        ].map(tab => (\n          <button\n            key={tab.key}\n            onClick={() => setFilter(tab.key as any)}\n            style={{\n              padding: '6px 14px', borderRadius: 8, border: 'none', cursor: 'pointer',\n              background: filter === tab.key ? 'var(--accent-gold-dim)' : 'var(--bg-elevated)',\n              color: filter === tab.key ? 'var(--accent-gold)' : 'var(--text-secondary)',\n              fontSize: 12, fontWeight: 500, transition: 'all 0.2s',\n            }}\n          >\n            {tab.label}\n          </button>\n        ))}\n      </div>\n      \n      {/* Alerts List */}\n      {visibleAlerts.length === 0 ? (\n        <div style={{\n          padding: 48, textAlign: 'center', background: 'var(--bg-elevated)',\n          borderRadius: 16, border: '1px solid var(--border-subtle)',\n        }}>\n          <div style={{ fontSize: 15, color: 'var(--text-secondary)', marginBottom: 4 }}>\n            {filter !== 'all' ? 'No alerts in this category' : 'No active alerts'}\n          </div>\n          <div style={{ fontSize: 12, color: 'var(--text-muted)' }}>\n            {filter !== 'all' ? 'Try viewing all alerts' : 'Your financial position is being monitored'}\n          </div>\n        </div>\n      ) : (\n        <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>\n          {visibleAlerts.map(alert => {\n            const config = severityConfig[alert.severity]\n            const isExpanded = expandedId === alert.id\n            \n            return (\n              <div key={alert.id} style={{\n                background: config.bg,\n                border: `1px solid ${config.color}22`,\n                borderRadius: 14,\n                borderLeft: `4px solid ${config.color}`,\n                overflow: 'hidden',\n              }}>\n                {/* Alert header */}\n                <div style={{\n                  padding: '16px 20px', display: 'flex', alignItems: 'flex-start', gap: 14, cursor: 'pointer',\n                }} onClick={() => setExpandedId(isExpanded ? null : alert.id)}>\n                  <div style={{ color: config.color, marginTop: 2, flexShrink: 0 }}>\n                    {config.icon}\n                  </div>\n                  \n                  <div style={{ flex: 1 }}>\n                    <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>\n                      <span style={{\n                        fontSize: 9, fontWeight: 700, letterSpacing: '0.08em',\n                        padding: '2px 8px', borderRadius: 4,\n                        color: config.color, background: `${config.color}15`,\n                      }}>\n                        {config.label}\n                      </span>\n                      <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>\n                        {alert.category}\n                      </span>\n                      {alert.daysUntilDeadline !== undefined && (\n                        <span style={{ fontSize: 11, color: config.color, fontFamily: 'var(--font-mono)', display: 'flex', alignItems: 'center', gap: 3 }}>\n                          <Clock size={10} /> {alert.daysUntilDeadline}d\n                        </span>\n                      )}\n                    </div>\n                    \n                    <div style={{ fontSize: 14, fontWeight: 600, color: 'var(--text-primary)' }}>\n                      {alert.title}\n                    </div>\n                    <div style={{ fontSize: 12, color: 'var(--text-muted)', marginTop: 4, lineHeight: 1.5, whiteSpace: 'pre-line' }}>\n                      {alert.message}\n                    </div>\n                    \n                    {alert.impactLabel && (\n                      <div style={{\n                        marginTop: 8, display: 'inline-flex', alignItems: 'center', gap: 6,\n                        padding: '4px 10px', borderRadius: 6,\n                        background: 'var(--bg-elevated)', fontSize: 12, fontFamily: 'var(--font-mono)',\n                        fontWeight: 600, color: 'var(--text-secondary)',\n                        border: '1px solid var(--border-subtle)',\n                      }}>\n                        <Zap size={12} style={{ color: config.color }} />\n                        {alert.impactLabel}\n                      </div>\n                    )}\n                  </div>\n                  \n                  <div style={{ display: 'flex', gap: 4, flexShrink: 0 }}>\n                    <button\n                      onClick={(e) => { e.stopPropagation(); dismiss(alert.id) }}\n                      style={{\n                        background: 'transparent', border: 'none', cursor: 'pointer',\n                        color: 'var(--text-muted)', padding: 4, borderRadius: 6,\n                      }}\n                    >\n                      <X size={14} />\n                    </button>\n                    <span style={{ color: 'var(--text-muted)', padding: 4 }}>\n                      {isExpanded ? <ChevronUp size={14} /> : <ChevronDown size={14} />}\n                    </span>\n                  </div>\n                </div>\n                \n                {/* Expanded reasoning */}\n                {isExpanded && (\n                  <div style={{\n                    padding: '0 20px 16px 50px', borderTop: '1px solid var(--border-subtle)',\n                  }}>\n                    <div style={{ marginTop: 12 }}>\n                      <div style={{ fontSize: 11, fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.05em', marginBottom: 6 }}>\n                        Analysis\n                      </div>\n                      <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.6 }}>\n                        {alert.reasoning}\n                      </div>\n                    </div>\n                    \n                    {(alert.action || alert.actionView) && onNavigate && (\n                      <button\n                        onClick={() => alert.actionView && onNavigate(alert.actionView as ViewKey)}\n                        style={{\n                          marginTop: 12, padding: '8px 16px', borderRadius: 8,\n                          border: `1px solid ${config.color}30`, background: `${config.color}10`,\n                          color: config.color, cursor: 'pointer', fontSize: 12, fontWeight: 600,\n                          display: 'flex', alignItems: 'center', gap: 6,\n                        }}\n                      >\n                        {alert.action || 'Take Action'} <ExternalLink size={12} />\n                      </button>\n                    )}\n                  </div>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\QuickBooksImport.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":407,"column":75,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":407,"endColumn":78,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14856,14859],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14856,14859],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — QuickBooks + Tax Return Import View\n *\n * Supports:\n *   QuickBooks / Bank:  .iif  .qbo  .ofx  .qfx  .qif\n *   Tax returns:        .pdf  (digitally generated — TurboTax, H&R Block, IRS e-file)\n *\n * @view QuickBooksImport\n */\n\nimport * as React from 'react'\nimport { useState, useCallback, useRef } from 'react'\nimport { useFortuna, genId } from '../hooks/useFortuna'\nimport { parseIIF, type IIFParseResult } from '../engine/qb-iif-parser'\nimport { parseOFX as parseOFXFile, parseQIF, type OFXParseResult, type QIFParseResult } from '../engine/qb-ofx-parser'\nimport {\n  mapAllAccounts, generateFortunaStatePatch,\n  type AccountMapping, type QBImportSummary,\n  trnsTypeToFlow,\n} from '../engine/qb-coa-mapper'\nimport { categorizeTransactions, type CategorizedTransaction, normalizeDate } from '../engine/data-import'\nimport { importTaxReturn, preFillFortunaFromReturn, type ExtractedReturn } from '../engine/tax-return-import'\nimport type { BankTransaction, IncomeStream, BusinessExpense, FortunaState } from '../engine/storage'\n\ntype ImportPhase = 'upload' | 'preview' | 'mapping' | 'confirm' | 'complete'\ntype FileKind = 'iif' | 'ofx' | 'qif' | 'pdf' | ''\n\n// ─── OFX → FortunaState helpers ──────────────────────────────────────────────\n\nfunction ofxTransactionsToFortuna(\n  categorized: CategorizedTransaction[],\n  accountId: string,\n  existingTxnKeys: Set<string>,\n): {\n  newIncomeStreams: Partial<IncomeStream>[]\n  newExpenses: Partial<BusinessExpense>[]\n  newBankTxns: BankTransaction[]\n} {\n  const incomeMap = new Map<string, number>()\n  const expenseMap = new Map<string, { total: number; isDeductible: boolean; deductionPct: number }>()\n  const newBankTxns: BankTransaction[] = []\n\n  for (const tx of categorized) {\n    const key = `${tx.date}|${tx.description}|${tx.amount}`\n    if (existingTxnKeys.has(key)) continue\n\n    // Add to audit history\n    newBankTxns.push({\n      id: genId(),\n      date: tx.date,\n      description: tx.description,\n      amount: tx.amount,\n      category: tx.autoCategory,\n      isReconciled: false,\n      accountName: accountId,\n      entityId: 'personal',\n    } as BankTransaction)\n\n    if (tx.autoCategory === 'transfer') continue\n\n    if (tx.isIncome) {\n      const type = tx.suggestedType || 'other'\n      incomeMap.set(type, (incomeMap.get(type) || 0) + tx.amount)\n    } else {\n      const cat = tx.suggestedExpenseCategory || 'Uncategorized'\n      const existing = expenseMap.get(cat)\n      const isPct50 = cat.includes('Meals')\n      expenseMap.set(cat, {\n        total: (existing?.total || 0) + Math.abs(tx.amount),\n        isDeductible: cat !== 'Personal (Non-Deductible)' && cat !== 'Transfer (Non-Deductible)',\n        deductionPct: isPct50 ? 50 : (cat.includes('Non-Deductible') ? 0 : 100),\n      })\n    }\n  }\n\n  const newIncomeStreams: Partial<IncomeStream>[] = Array.from(incomeMap.entries())\n    .filter(([, amount]) => amount > 0)\n    .map(([type, amount]) => ({\n      id: genId(),\n      name: `Imported ${type.charAt(0).toUpperCase() + type.slice(1)} Income`,\n      type: type as IncomeStream['type'],\n      annualAmount: Math.round(amount * 100) / 100,\n      isActive: true,\n      notes: 'OFX/QBO Import',\n      entityId: 'personal',\n      isTaxable: true,\n    }))\n\n  const newExpenses: Partial<BusinessExpense>[] = Array.from(expenseMap.entries())\n    .filter(([, d]) => d.total > 0)\n    .map(([category, d]) => ({\n      id: genId(),\n      category,\n      description: `Imported: ${category}`,\n      annualAmount: Math.round(d.total * 100) / 100,\n      isDeductible: d.isDeductible,\n      deductionPct: d.deductionPct,\n      entityId: 'personal',\n    }))\n\n  return { newIncomeStreams, newExpenses, newBankTxns }\n}\n\n// ─── Tax Return → FortunaState helper ────────────────────────────────────────\n\nfunction applyTaxReturnToState(\n  result: ExtractedReturn,\n  existingIncomeStreams: IncomeStream[],\n): {\n  profilePatch: Partial<FinancialProfile>\n  newIncomeStreams: Partial<IncomeStream>[]\n  newExpenses: Partial<BusinessExpense>[]\n  taxYearPatch: number | null\n} {\n  const prefill = preFillFortunaFromReturn(result)\n  const profilePatch: Partial<FinancialProfile> = {}\n  const newIncomeStreams: Partial<IncomeStream>[] = []\n  const newExpenses: Partial<BusinessExpense>[] = []\n\n  if (prefill.filingStatus) profilePatch.filingStatus = prefill.filingStatus\n\n  // W-2 wages\n  if (prefill.w2Income && prefill.w2Income > 0) {\n    const exists = existingIncomeStreams.some(\n      s => s.type === 'w2' && Math.abs(s.annualAmount - prefill.w2Income) / prefill.w2Income < 0.01\n    )\n    if (!exists) {\n      newIncomeStreams.push({\n        id: genId(),\n        name: 'W-2 Income (Tax Return)',\n        type: 'w2',\n        annualAmount: prefill.w2Income,\n        isActive: true,\n        notes: `Imported from ${result.taxYear ?? 'prior'} tax return`,\n        isTaxable: true,\n        entityId: 'personal',\n        taxYear: result.taxYear ?? undefined,\n        w2: prefill.priorYearWithholding ? { federalWithholding: prefill.priorYearWithholding } : undefined,\n      })\n    }\n  }\n\n  // Schedule C business income\n  if (prefill.scheduleCIncome && prefill.scheduleCIncome > 0) {\n    const exists = existingIncomeStreams.some(\n      s => s.type === 'business' && Math.abs(s.annualAmount - prefill.scheduleCIncome) / prefill.scheduleCIncome < 0.01\n    )\n    if (!exists) {\n      newIncomeStreams.push({\n        id: genId(),\n        name: 'Schedule C Business Income',\n        type: 'business',\n        annualAmount: prefill.scheduleCIncome,\n        isActive: true,\n        notes: `Imported from ${result.taxYear ?? 'prior'} tax return`,\n        isTaxable: true,\n        entityId: 'personal',\n        taxYear: result.taxYear ?? undefined,\n      })\n    }\n  }\n\n  // Capital gains (net, if non-zero)\n  const capGains = (prefill.shortTermCapGains || 0) + (prefill.longTermCapGains || 0)\n  if (capGains !== 0) {\n    newIncomeStreams.push({\n      id: genId(),\n      name: `Capital Gains (${result.taxYear ?? 'Prior Year'})`,\n      type: 'investment',\n      annualAmount: capGains,\n      isActive: false, // prior year — mark inactive\n      notes: `Short-term: $${prefill.shortTermCapGains ?? 0}, Long-term: $${prefill.longTermCapGains ?? 0}`,\n      isTaxable: true,\n      entityId: 'personal',\n      taxYear: result.taxYear ?? undefined,\n    })\n  }\n\n  // Schedule C expenses\n  if (prefill.businessExpenses && prefill.businessExpenses > 0) {\n    newExpenses.push({\n      id: genId(),\n      category: 'business',\n      description: `Schedule C Expenses (${result.taxYear ?? 'Prior Year'} Return)`,\n      annualAmount: prefill.businessExpenses,\n      isDeductible: true,\n      deductionPct: 100,\n      entityId: 'personal',\n    })\n  }\n\n  return {\n    profilePatch,\n    newIncomeStreams,\n    newExpenses,\n    taxYearPatch: result.taxYear,\n  }\n}\n\n// ─── Component ────────────────────────────────────────────────────────────────\n\nexport default function QuickBooksImport() {\n  const { state, updateState } = useFortuna()\n  const [phase, setPhase] = useState<ImportPhase>('upload')\n  const [dragOver, setDragOver] = useState(false)\n  const [fileName, setFileName] = useState('')\n  const [fileKind, setFileKind] = useState<FileKind>('')\n\n  // Parse results\n  const [iifResult, setIifResult] = useState<IIFParseResult | null>(null)\n  const [ofxResult, setOfxResult] = useState<OFXParseResult | null>(null)\n  const [qifResult, setQifResult] = useState<QIFParseResult | null>(null)\n  const [taxResult, setTaxResult] = useState<ExtractedReturn | null>(null)\n  const [pdfLoading, setPdfLoading] = useState(false)\n\n  // OFX categorized cache\n  const [ofxCategorized, setOfxCategorized] = useState<CategorizedTransaction[]>([])\n\n  // IIF mapping + import\n  const [accountMappings, setAccountMappings] = useState<Map<string, AccountMapping>>(new Map())\n  const [importSummary, setImportSummary] = useState<QBImportSummary | null>(null)\n  const [selectedTab, setSelectedTab] = useState<'overview' | 'accounts' | 'transactions' | 'mapping'>('overview')\n\n  const fileInputRef = useRef<HTMLInputElement>(null)\n\n  // ─── File Handling ──────────────────────────────────────────────────────────\n\n  const reset = useCallback(() => {\n    setPhase('upload')\n    setIifResult(null)\n    setOfxResult(null)\n    setQifResult(null)\n    setTaxResult(null)\n    setOfxCategorized([])\n    setImportSummary(null)\n    setFileName('')\n    setFileKind('')\n    setSelectedTab('overview')\n  }, [])\n\n  const processFile = useCallback(async (file: File) => {\n    const ext = file.name.split('.').pop()?.toLowerCase() || ''\n    setFileName(file.name)\n\n    if (ext === 'iif') {\n      const text = await file.text()\n      setFileKind('iif')\n      const result = parseIIF(text)\n      setIifResult(result)\n      const mappings = mapAllAccounts(result.accounts)\n      setAccountMappings(mappings)\n      const { summary } = generateFortunaStatePatch(result.accounts, result.transactions, result.vendors, result.classes)\n      setImportSummary(summary)\n      setPhase('preview')\n\n    } else if (['ofx', 'qbo', 'qfx'].includes(ext)) {\n      const text = await file.text()\n      setFileKind('ofx')\n      const result = parseOFXFile(text)\n      setOfxResult(result)\n      // Pre-categorize all transactions so the import button can use them\n      const allTxns = result.statements.flatMap(s => s.transactions).map(tx => ({\n        date: tx.dateISO,\n        description: tx.name || tx.memo || `${tx.type} transaction`,\n        amount: tx.amount,\n        memo: tx.memo,\n        fitId: tx.fitId,\n      }))\n      const categorized = categorizeTransactions(allTxns)\n      setOfxCategorized(categorized)\n      setPhase('preview')\n\n    } else if (ext === 'qif') {\n      const text = await file.text()\n      setFileKind('qif')\n      const result = parseQIF(text)\n      setQifResult(result)\n      const txns = result.transactions.map(tx => ({\n        date: normalizeDate(tx.date),\n        description: tx.payee || tx.memo || 'QIF Transaction',\n        amount: tx.amount,\n        category: tx.category,\n        memo: tx.memo,\n      }))\n      const categorized = categorizeTransactions(txns)\n      setOfxCategorized(categorized) // reuse same state slot\n      setPhase('preview')\n\n    } else if (ext === 'pdf') {\n      setFileKind('pdf')\n      setPdfLoading(true)\n      setPhase('preview')\n      try {\n        const result = await importTaxReturn(file)\n        setTaxResult(result)\n      } catch (err) {\n        setTaxResult({\n          taxYear: null, filingStatus: null, forms: [],\n          summary: {\n            grossIncome: null, agi: null, taxableIncome: null, totalTax: null,\n            totalPayments: null, refundOrOwed: null, filingStatus: null,\n            businessIncome: null, businessExpenses: null, netBusinessProfit: null,\n            shortTermGainLoss: null, longTermGainLoss: null,\n            selfEmploymentTax: null, wagesTotal: null, federalWithheld: null,\n            estimatedMarginalRate: null, estimatedEffectiveRate: null,\n          },\n          rawText: '',\n          confidence: 0,\n          warnings: [`PDF processing failed: ${err instanceof Error ? err.message : String(err)}`],\n        })\n      } finally {\n        setPdfLoading(false)\n      }\n\n    } else {\n      alert(`Unsupported file type: .${ext}\\n\\nSupported: .iif, .qbo, .ofx, .qfx, .qif, .pdf`)\n    }\n  }, [])\n\n  const handleDrop = useCallback((e: React.DragEvent) => {\n    e.preventDefault()\n    setDragOver(false)\n    const file = e.dataTransfer.files[0]\n    if (file) processFile(file)\n  }, [processFile])\n\n  const handleFileSelect = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0]\n    if (file) processFile(file)\n  }, [processFile])\n\n  // ─── IIF Import ─────────────────────────────────────────────────────────────\n\n  const executeIIFImport = useCallback(() => {\n    if (!iifResult) return\n    const { patch } = generateFortunaStatePatch(\n      iifResult.accounts, iifResult.transactions, iifResult.vendors, iifResult.classes,\n    )\n    updateState((prev: FortunaState) => ({\n      ...prev,\n      incomeStreams: [...(prev.incomeStreams || []), ...(patch.incomeStreams || [])],\n      expenses: [...(prev.expenses || []), ...(patch.expenses || [])],\n      entities: [...(prev.entities || []), ...(patch.entities || [])],\n      auditHistory: [...(prev.auditHistory || []), ...(patch.auditHistory || [])],\n    }))\n    setPhase('complete')\n  }, [iifResult, updateState])\n\n  // ─── OFX / QIF Import ───────────────────────────────────────────────────────\n\n  const executeOFXImport = useCallback(() => {\n    if (ofxCategorized.length === 0) return\n\n    // Build dedup key set from existing audit history\n    const existingKeys = new Set<string>(\n      (state.auditHistory || []).map((t: BankTransaction) => `${normalizeDate(t.date)}|${t.description}|${t.amount}`)\n    )\n\n    const accountId = ofxResult\n      ? (ofxResult.statements[0]?.bankAccount?.accountId ||\n        ofxResult.statements[0]?.creditCardAccount?.accountId ||\n        'bank')\n      : (qifResult?.accountName || 'bank')\n\n    const { newIncomeStreams, newExpenses, newBankTxns } = ofxTransactionsToFortuna(\n      ofxCategorized, accountId, existingKeys,\n    )\n\n    // Deduplicate income streams vs existing (by type + amount within 1%)\n    const filteredIncome = newIncomeStreams.filter((ns: Partial<IncomeStream>) => {\n      if (!ns.annualAmount || ns.annualAmount <= 0) return false\n      return !state.incomeStreams.some(\n        (ex: IncomeStream) => ex.type === ns.type &&\n          Math.abs(ex.annualAmount - ns.annualAmount!) / Math.max(1, ns.annualAmount!) < 0.01\n      )\n    })\n\n    const filteredExpenses = newExpenses.filter((ne: Partial<BusinessExpense>) => {\n      if (!ne.annualAmount || ne.annualAmount <= 0) return false\n      return !state.expenses.some(\n        (ex: BusinessExpense) => ex.category === ne.category &&\n          Math.abs(ex.annualAmount - ne.annualAmount!) / Math.max(1, ne.annualAmount!) < 0.01\n      )\n    })\n\n    updateState((prev: FortunaState) => ({\n      ...prev,\n      incomeStreams: [...prev.incomeStreams, ...filteredIncome as IncomeStream[]],\n      expenses: [...prev.expenses, ...filteredExpenses as BusinessExpense[]],\n      auditHistory: [...(prev.auditHistory || []), ...newBankTxns],\n    }))\n\n    setPhase('complete')\n  }, [ofxCategorized, ofxResult, qifResult, state, updateState])\n\n  // ─── Tax PDF Apply ───────────────────────────────────────────────────────────\n\n  const applyTaxReturn = useCallback(() => {\n    if (!taxResult) return\n\n    const { profilePatch, newIncomeStreams, newExpenses, taxYearPatch } =\n      applyTaxReturnToState(taxResult, state.incomeStreams)\n\n    updateState((prev: FortunaState) => {\n      const newProfile = { ...prev.profile, ...profilePatch }\n      const newHousehold = profilePatch.filingStatus\n        ? { ...prev.household, filingStatus: profilePatch.filingStatus as any }\n        : prev.household\n\n      return {\n        ...prev,\n        profile: newProfile,\n        household: newHousehold,\n        taxYear: taxYearPatch ?? prev.taxYear,\n        incomeStreams: [...prev.incomeStreams, ...newIncomeStreams as IncomeStream[]],\n        expenses: [...prev.expenses, ...newExpenses as BusinessExpense[]],\n      }\n    })\n\n    setPhase('complete')\n  }, [taxResult, state.incomeStreams, updateState])\n\n  // ─── Styles ──────────────────────────────────────────────────────────────────\n\n  const card: React.CSSProperties = {\n    background: 'var(--bg-card)', borderRadius: 12,\n    border: '1px solid var(--border-subtle)', padding: 20, marginBottom: 16,\n  }\n  const stat: React.CSSProperties = { textAlign: 'center' as const, padding: 12 }\n  const statValue: React.CSSProperties = {\n    fontSize: 22, fontWeight: 700, fontFamily: 'var(--font-mono)', color: 'var(--text-primary)',\n  }\n  const statLabel: React.CSSProperties = {\n    fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase' as const,\n    letterSpacing: '0.08em', marginTop: 4,\n  }\n  const tabBtn = (active: boolean): React.CSSProperties => ({\n    padding: '8px 16px', borderRadius: 6, fontSize: 12, fontWeight: active ? 600 : 400,\n    background: active ? 'var(--accent)' : 'transparent',\n    color: active ? '#0a0e1a' : 'var(--text-secondary)',\n    border: active ? 'none' : '1px solid var(--border-subtle)',\n    cursor: 'pointer',\n  })\n  const badge = (color: string): React.CSSProperties => ({\n    display: 'inline-block', padding: '2px 8px', borderRadius: 4,\n    fontSize: 10, fontWeight: 600, background: `${color}20`, color,\n  })\n  const importBtn: React.CSSProperties = {\n    padding: '6px 16px', borderRadius: 8, fontSize: 12, fontWeight: 600,\n    background: 'linear-gradient(135deg, #22c55e, #16a34a)', border: 'none',\n    color: '#fff', cursor: 'pointer',\n  }\n\n  // ─── Upload Phase ─────────────────────────────────────────────────────────────\n\n  if (phase === 'upload') {\n    return (\n      <div style={{ padding: '24px 32px', maxWidth: 900 }}>\n        <h1 style={{ fontSize: 22, fontWeight: 700, margin: '0 0 8px', fontFamily: 'var(--font-display)', color: 'var(--text-primary)' }}>\n          📗 QuickBooks & Tax Return Import\n        </h1>\n        <p style={{ fontSize: 13, color: 'var(--text-secondary)', margin: '0 0 24px' }}>\n          Import QuickBooks data or a tax return PDF directly into Fortuna. All formats auto-detected.\n        </p>\n\n        {/* Drop Zone */}\n        <div\n          onDragOver={(e: React.DragEvent) => { e.preventDefault(); setDragOver(true) }}\n          onDragLeave={() => setDragOver(false)}\n          onDrop={handleDrop}\n          onClick={() => fileInputRef.current?.click()}\n          style={{\n            border: `2px dashed ${dragOver ? 'var(--accent)' : 'var(--border-subtle)'}`,\n            borderRadius: 16, padding: '60px 40px', textAlign: 'center',\n            cursor: 'pointer', transition: 'all 0.2s',\n            background: dragOver ? 'rgba(245, 158, 11, 0.05)' : 'var(--bg-card)',\n          }}\n        >\n          <div style={{ fontSize: 48, marginBottom: 16 }}>📂</div>\n          <div style={{ fontSize: 16, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 8 }}>\n            Drop your file here\n          </div>\n          <div style={{ fontSize: 12, color: 'var(--text-muted)', marginBottom: 16 }}>\n            QuickBooks export or tax return PDF — or click to browse\n          </div>\n          <div style={{ display: 'flex', justifyContent: 'center', gap: 8, flexWrap: 'wrap' }}>\n            {[\n              { ext: '.iif', label: 'IIF', desc: 'QB Desktop full export' },\n              { ext: '.qbo', label: 'QBO', desc: 'QB Online / Web Connect' },\n              { ext: '.ofx', label: 'OFX', desc: 'Open Financial Exchange' },\n              { ext: '.qfx', label: 'QFX', desc: 'Quicken Web Connect' },\n              { ext: '.qif', label: 'QIF', desc: 'Quicken legacy format' },\n              { ext: '.pdf', label: 'PDF', desc: 'Tax return (1040, W-2, Sched C…)' },\n            ].map(f => (\n              <div key={f.ext} style={{\n                padding: '6px 12px', borderRadius: 6, fontSize: 10,\n                background: 'var(--bg-hover)', color: 'var(--text-secondary)',\n              }}>\n                <span style={{ fontWeight: 700, color: f.ext === '.pdf' ? '#a78bfa' : 'var(--accent)' }}>{f.ext}</span> — {f.desc}\n              </div>\n            ))}\n          </div>\n          <input\n            ref={fileInputRef}\n            type=\"file\"\n            accept=\".iif,.qbo,.ofx,.qfx,.qif,.pdf\"\n            onChange={handleFileSelect}\n            style={{ display: 'none' }}\n          />\n        </div>\n\n        {/* How-to Guide */}\n        <div style={{ ...card, marginTop: 24 }}>\n          <h3 style={{ fontSize: 14, fontWeight: 600, margin: '0 0 12px', color: 'var(--text-primary)' }}>\n            How to export your data\n          </h3>\n          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 16, fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.7 }}>\n            <div>\n              <div style={{ fontWeight: 600, color: 'var(--text-primary)', marginBottom: 4 }}>QuickBooks Desktop (.iif)</div>\n              <div>File → Utilities → Export → IIF Files</div>\n              <div style={{ fontStyle: 'italic', color: 'var(--text-muted)', marginTop: 4 }}>\n                Richest QB format — includes chart of accounts, classes, and all transactions mapped to tax categories\n              </div>\n            </div>\n            <div>\n              <div style={{ fontWeight: 600, color: 'var(--text-primary)', marginBottom: 4 }}>QuickBooks Online (.qbo/.ofx)</div>\n              <div>Banking → Download transactions → QBO format</div>\n              <div style={{ fontStyle: 'italic', color: 'var(--text-muted)', marginTop: 4 }}>\n                Bank transactions with auto-categorization for income & deductible expenses\n              </div>\n            </div>\n            <div>\n              <div style={{ fontWeight: 600, color: 'var(--text-primary)', marginBottom: 4 }}>Tax Return (.pdf)</div>\n              <div>From TurboTax, H&R Block, or IRS — download the PDF version of your filed return</div>\n              <div style={{ fontStyle: 'italic', color: 'var(--text-muted)', marginTop: 4 }}>\n                Extracts 1040, W-2, Schedule C/D/SE and populates your profile instantly\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    )\n  }\n\n  // ─── PDF Loading Spinner ──────────────────────────────────────────────────────\n\n  if (phase === 'preview' && fileKind === 'pdf' && pdfLoading) {\n    return (\n      <div style={{ padding: '24px 32px', maxWidth: 900, textAlign: 'center' }}>\n        <div style={{ fontSize: 48, marginBottom: 16 }}>📄</div>\n        <div style={{ fontSize: 16, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 8 }}>\n          Reading {fileName}…\n        </div>\n        <div style={{ fontSize: 12, color: 'var(--text-muted)' }}>\n          Loading PDF.js and extracting tax form data\n        </div>\n      </div>\n    )\n  }\n\n  // ─── Tax Return Preview ───────────────────────────────────────────────────────\n\n  if (phase === 'preview' && fileKind === 'pdf' && taxResult) {\n    const s = taxResult.summary\n    const canApply = taxResult.confidence >= 40\n    const confidenceColor = taxResult.confidence >= 70 ? '#22c55e' : taxResult.confidence >= 40 ? '#f59e0b' : '#ef4444'\n\n    return (\n      <div style={{ padding: '24px 32px', maxWidth: 900 }}>\n        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 }}>\n          <div>\n            <h1 style={{ fontSize: 20, fontWeight: 700, margin: 0, fontFamily: 'var(--font-display)', color: 'var(--text-primary)' }}>\n              📄 {fileName}\n            </h1>\n            <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 4 }}>\n              Tax Year: <strong>{taxResult.taxYear ?? 'Unknown'}</strong> ·\n              Filing Status: <strong>{taxResult.filingStatus ?? 'Unknown'}</strong> ·\n              Forms detected: <strong>{taxResult.forms.map(f => f.formType.replace('_', ' ').toUpperCase()).join(', ') || 'None'}</strong>\n            </div>\n          </div>\n          <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>\n            <button onClick={reset}\n              style={{ padding: '6px 14px', borderRadius: 8, fontSize: 12, background: 'var(--bg-hover)', border: '1px solid var(--border-subtle)', color: 'var(--text-secondary)', cursor: 'pointer' }}>\n              ← New File\n            </button>\n            <button\n              onClick={applyTaxReturn}\n              disabled={!canApply}\n              style={{\n                ...importBtn,\n                opacity: canApply ? 1 : 0.4,\n                cursor: canApply ? 'pointer' : 'not-allowed',\n              }}\n              title={!canApply ? 'Confidence too low to auto-apply — check warnings' : ''}\n            >\n              ✓ Apply to Profile\n            </button>\n          </div>\n        </div>\n\n        {/* Confidence */}\n        <div style={{ ...card, display: 'flex', alignItems: 'center', gap: 16 }}>\n          <div style={{ fontFamily: 'var(--font-mono)', fontSize: 28, fontWeight: 700, color: confidenceColor }}>\n            {taxResult.confidence}%\n          </div>\n          <div>\n            <div style={{ fontSize: 13, fontWeight: 600, color: 'var(--text-primary)' }}>Extraction Confidence</div>\n            <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>\n              {taxResult.confidence >= 70 ? 'High confidence — safe to apply' :\n                taxResult.confidence >= 40 ? 'Medium confidence — review values before applying' :\n                  'Low confidence — PDF may be scanned or handwritten'}\n            </div>\n          </div>\n          <div style={{ flex: 1 }}>\n            <div style={{ height: 6, borderRadius: 3, background: 'var(--bg-hover)' }}>\n              <div style={{ height: '100%', width: `${taxResult.confidence}%`, borderRadius: 3, background: confidenceColor, transition: 'width 0.5s' }} />\n            </div>\n          </div>\n        </div>\n\n        {/* Extracted values grid */}\n        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(160px, 1fr))', gap: 12, marginBottom: 16 }}>\n          {[\n            { label: 'Gross Income', value: s.grossIncome },\n            { label: 'AGI', value: s.agi },\n            { label: 'Taxable Income', value: s.taxableIncome },\n            { label: 'Total Tax', value: s.totalTax },\n            { label: 'W-2 Wages', value: s.wagesTotal },\n            { label: 'Business Income', value: s.netBusinessProfit },\n            { label: 'Business Expenses', value: s.businessExpenses },\n            { label: 'SE Tax', value: s.selfEmploymentTax },\n            { label: 'Fed Withheld', value: s.federalWithheld },\n            { label: 'Refund / Owed', value: s.refundOrOwed },\n          ].map(row => row.value !== null && row.value !== undefined ? (\n            <div key={row.label} style={{ ...card, ...stat, marginBottom: 0 }}>\n              <div style={statValue}>${(row.value as number).toLocaleString()}</div>\n              <div style={statLabel}>{row.label}</div>\n            </div>\n          ) : null)}\n        </div>\n\n        {/* What will be imported */}\n        <div style={card}>\n          <h3 style={{ fontSize: 13, fontWeight: 600, margin: '0 0 10px', color: 'var(--text-primary)' }}>\n            📋 What will be applied to your profile\n          </h3>\n          <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.8 }}>\n            {taxResult.filingStatus && <div>✅ Filing status → <strong>{taxResult.filingStatus}</strong></div>}\n            {s.wagesTotal ? <div>✅ New income stream: <strong>W-2 Income</strong> — ${s.wagesTotal.toLocaleString()}/yr</div> : null}\n            {s.netBusinessProfit && s.netBusinessProfit > 0 ? <div>✅ New income stream: <strong>Schedule C Business</strong> — ${s.netBusinessProfit.toLocaleString()}/yr</div> : null}\n            {(s.shortTermGainLoss || s.longTermGainLoss) ? <div>✅ New income stream: <strong>Capital Gains</strong> (prior year, inactive)</div> : null}\n            {s.businessExpenses && s.businessExpenses > 0 ? <div>✅ New expense: <strong>Schedule C Expenses</strong> — ${s.businessExpenses.toLocaleString()}/yr</div> : null}\n            {taxResult.taxYear ? <div>✅ Tax year updated to <strong>{taxResult.taxYear}</strong></div> : null}\n            {!taxResult.filingStatus && !s.wagesTotal && !s.netBusinessProfit && (\n              <div style={{ color: 'var(--text-muted)' }}>— No actionable data extracted. Check warnings below.</div>\n            )}\n          </div>\n        </div>\n\n        {/* Warnings */}\n        {taxResult.warnings.length > 0 && (\n          <div style={{ ...card, background: 'rgba(245, 158, 11, 0.06)' }}>\n            {taxResult.warnings.map((w, i) => (\n              <div key={i} style={{ fontSize: 11, color: '#f59e0b', marginBottom: 4 }}>⚠️ {w}</div>\n            ))}\n          </div>\n        )}\n      </div>\n    )\n  }\n\n  // ─── OFX/QIF Preview ─────────────────────────────────────────────────────────\n\n  if (phase === 'preview' && (fileKind === 'ofx' || fileKind === 'qif')) {\n    const txns = ofxCategorized\n    const income = txns.filter(t => t.isIncome)\n    const expenses = txns.filter(t => !t.isIncome && t.autoCategory !== 'transfer')\n    const totalIncome = income.reduce((s, t) => s + t.amount, 0)\n    const totalExpenses = Math.abs(expenses.reduce((s, t) => s + t.amount, 0))\n    const unclassified = txns.filter(t => t.confidence < 0.5 && t.autoCategory !== 'transfer').length\n\n    return (\n      <div style={{ padding: '24px 32px', maxWidth: 1100 }}>\n        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 }}>\n          <div>\n            <h1 style={{ fontSize: 20, fontWeight: 700, margin: 0, fontFamily: 'var(--font-display)', color: 'var(--text-primary)' }}>\n              💳 {fileName}\n            </h1>\n            <p style={{ fontSize: 11, color: 'var(--text-muted)', margin: '4px 0 0' }}>\n              {fileKind === 'ofx' ? `${ofxResult?.statements[0]?.flavor?.toUpperCase() || 'OFX'} File` : 'QIF File'} — {txns.length} transactions\n            </p>\n          </div>\n          <div style={{ display: 'flex', gap: 8 }}>\n            <button onClick={reset}\n              style={{ padding: '6px 14px', borderRadius: 8, fontSize: 12, background: 'var(--bg-hover)', border: '1px solid var(--border-subtle)', color: 'var(--text-secondary)', cursor: 'pointer' }}>\n              ← New File\n            </button>\n            <button onClick={executeOFXImport} style={importBtn}>\n              ✓ Import into Fortuna\n            </button>\n          </div>\n        </div>\n\n        {/* Stats */}\n        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(140px, 1fr))', gap: 12, marginBottom: 16 }}>\n          {[\n            { label: 'Transactions', value: txns.length, color: undefined },\n            { label: 'Total Income', value: `$${Math.round(totalIncome).toLocaleString()}`, color: '#22c55e' },\n            { label: 'Total Expenses', value: `$${Math.round(totalExpenses).toLocaleString()}`, color: '#ef4444' },\n            { label: 'Unclassified', value: unclassified, color: unclassified > 10 ? '#f59e0b' : undefined },\n          ].map(s => (\n            <div key={s.label} style={{ ...card, ...stat, marginBottom: 0 }}>\n              <div style={{ ...statValue, color: s.color || 'var(--text-primary)' }}>{s.value}</div>\n              <div style={statLabel}>{s.label}</div>\n            </div>\n          ))}\n        </div>\n\n        {/* What will be imported */}\n        <div style={card}>\n          <h3 style={{ fontSize: 13, fontWeight: 600, margin: '0 0 10px', color: 'var(--text-primary)' }}>\n            📋 What will be imported\n          </h3>\n          <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.8, display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 8 }}>\n            <div>✅ {income.length} income transactions → aggregated income streams</div>\n            <div>✅ {expenses.length} expense transactions → categorized expense entries</div>\n            <div>✅ All {txns.length} transactions → audit history (bank ledger)</div>\n            <div>🔒 Duplicate transactions will be skipped automatically</div>\n          </div>\n        </div>\n\n        {/* Transaction preview table */}\n        <div style={card}>\n          <div style={{ overflowX: 'auto', maxHeight: 400 }}>\n            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 11 }}>\n              <thead style={{ position: 'sticky', top: 0, background: 'var(--bg-card)' }}>\n                <tr style={{ borderBottom: '1px solid var(--border-subtle)' }}>\n                  {['Date', 'Description', 'Amount', 'Category', 'Confidence'].map(h => (\n                    <th key={h} style={{ padding: '8px 10px', textAlign: 'left', fontSize: 10, color: 'var(--text-muted)', fontWeight: 500, textTransform: 'uppercase' }}>{h}</th>\n                  ))}\n                </tr>\n              </thead>\n              <tbody>\n                {txns.slice(0, 100).map((tx, i) => (\n                  <tr key={i} style={{ borderBottom: '1px solid var(--border-subtle)' }}>\n                    <td style={{ padding: '6px 10px', fontFamily: 'var(--font-mono)', fontSize: 10, color: 'var(--text-muted)' }}>{tx.date}</td>\n                    <td style={{ padding: '6px 10px', color: 'var(--text-primary)', maxWidth: 240, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{tx.description}</td>\n                    <td style={{ padding: '6px 10px', fontFamily: 'var(--font-mono)', fontWeight: 600, color: tx.amount >= 0 ? '#22c55e' : '#ef4444' }}>\n                      {tx.amount >= 0 ? '+' : ''}{tx.amount.toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                    </td>\n                    <td style={{ padding: '6px 10px' }}>\n                      <span style={badge(tx.isIncome ? '#22c55e' : tx.autoCategory === 'transfer' ? '#6366f1' : '#f59e0b')}>\n                        {tx.autoCategory.replace(/_/g, ' ')}\n                      </span>\n                    </td>\n                    <td style={{ padding: '6px 10px' }}>\n                      <div style={{ height: 6, width: 60, background: 'var(--bg-hover)', borderRadius: 3 }}>\n                        <div style={{ height: '100%', width: `${Math.round((tx.confidence || 0) * 100)}%`, background: (tx.confidence || 0) > 0.7 ? '#22c55e' : '#f59e0b', borderRadius: 3 }} />\n                      </div>\n                    </td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n            {txns.length > 100 && (\n              <div style={{ padding: 12, textAlign: 'center', fontSize: 11, color: 'var(--text-muted)' }}>\n                Showing 100 of {txns.length} transactions\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n    )\n  }\n\n  // ─── IIF Preview ─────────────────────────────────────────────────────────────\n\n  if (phase === 'preview' && fileKind === 'iif' && iifResult) {\n    return (\n      <div style={{ padding: '24px 32px', maxWidth: 1200 }}>\n        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 }}>\n          <div>\n            <h1 style={{ fontSize: 20, fontWeight: 700, margin: 0, fontFamily: 'var(--font-display)', color: 'var(--text-primary)' }}>\n              📗 {fileName}\n            </h1>\n            <p style={{ fontSize: 11, color: 'var(--text-muted)', margin: '4px 0 0' }}>\n              IIF File — {iifResult.stats.transactionCount} transactions, {iifResult.stats.accountCount} accounts\n            </p>\n          </div>\n          <div style={{ display: 'flex', gap: 8 }}>\n            <button onClick={reset}\n              style={{ padding: '6px 14px', borderRadius: 8, fontSize: 12, background: 'var(--bg-hover)', border: '1px solid var(--border-subtle)', color: 'var(--text-secondary)', cursor: 'pointer' }}>\n              ← New File\n            </button>\n            <button onClick={executeIIFImport} style={importBtn}>\n              ✓ Import into Fortuna\n            </button>\n          </div>\n        </div>\n\n        {/* Tabs */}\n        <div style={{ display: 'flex', gap: 6, marginBottom: 16 }}>\n          {(['overview', 'accounts', 'transactions', 'mapping'] as const).map(tab => (\n            <button key={tab} onClick={() => setSelectedTab(tab)} style={tabBtn(selectedTab === tab)}>\n              {tab === 'overview' ? '📊 Overview' : tab === 'accounts' ? '📒 Accounts' : tab === 'transactions' ? '💳 Transactions' : '🔗 Tax Mapping'}\n            </button>\n          ))}\n        </div>\n\n        {/* Overview Tab */}\n        {selectedTab === 'overview' && (\n          <>\n            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(140px, 1fr))', gap: 12, marginBottom: 16 }}>\n              {[\n                { value: iifResult.stats.transactionCount, label: 'Transactions' },\n                { value: iifResult.stats.accountCount, label: 'Accounts' },\n                { value: iifResult.stats.customerCount, label: 'Customers' },\n                { value: iifResult.stats.vendorCount, label: 'Vendors' },\n                { value: iifResult.stats.employeeCount, label: 'Employees' },\n                { value: iifResult.stats.classCount, label: 'Classes' },\n                { value: iifResult.stats.balancedCount, label: 'Balanced' },\n                { value: iifResult.stats.errorCount, label: 'Errors', color: iifResult.stats.errorCount > 0 ? '#ef4444' : undefined },\n              ].map(s => (\n                <div key={s.label} style={{ ...card, ...stat }}>\n                  <div style={{ ...statValue, color: s.color || 'var(--text-primary)' }}>{s.value}</div>\n                  <div style={statLabel}>{s.label}</div>\n                </div>\n              ))}\n            </div>\n\n            {importSummary && (\n              <div style={card}>\n                <h3 style={{ fontSize: 14, fontWeight: 600, margin: '0 0 12px', color: 'var(--text-primary)' }}>📊 Tax Impact Preview</h3>\n                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 16 }}>\n                  <div style={stat}>\n                    <div style={{ ...statValue, color: '#22c55e' }}>${importSummary.taxImpact.estimatedGrossIncome.toLocaleString()}</div>\n                    <div style={statLabel}>Gross Income Detected</div>\n                  </div>\n                  <div style={stat}>\n                    <div style={{ ...statValue, color: '#f59e0b' }}>${importSummary.taxImpact.estimatedDeductions.toLocaleString()}</div>\n                    <div style={statLabel}>Deductions Detected</div>\n                  </div>\n                  <div style={stat}>\n                    <div style={statValue}>${importSummary.taxImpact.estimatedTaxableIncome.toLocaleString()}</div>\n                    <div style={statLabel}>Est. Taxable Income</div>\n                  </div>\n                </div>\n                {importSummary.warnings.length > 0 && (\n                  <div style={{ marginTop: 12, padding: 12, background: 'rgba(245, 158, 11, 0.08)', borderRadius: 8 }}>\n                    {importSummary.warnings.map((w, i) => (\n                      <div key={i} style={{ fontSize: 11, color: '#f59e0b', marginBottom: 4 }}>⚠️ {w}</div>\n                    ))}\n                  </div>\n                )}\n              </div>\n            )}\n\n            {iifResult.stats.dateRange && (\n              <div style={card}>\n                <div style={{ fontSize: 12, color: 'var(--text-secondary)' }}>\n                  📅 Date Range: <strong>{iifResult.stats.dateRange.earliest}</strong> → <strong>{iifResult.stats.dateRange.latest}</strong>\n                </div>\n                <div style={{ fontSize: 12, color: 'var(--text-muted)', marginTop: 4 }}>\n                  Debits: ${iifResult.stats.totalDebits.toLocaleString()} | Credits: ${iifResult.stats.totalCredits.toLocaleString()}\n                </div>\n              </div>\n            )}\n          </>\n        )}\n\n        {/* Accounts Tab */}\n        {selectedTab === 'accounts' && (\n          <div style={card}>\n            <div style={{ overflowX: 'auto' }}>\n              <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 11 }}>\n                <thead>\n                  <tr style={{ borderBottom: '1px solid var(--border-subtle)' }}>\n                    {['Account Name', 'QB Type', 'Tax Category', 'Schedule', 'Deductible'].map(h => (\n                      <th key={h} style={{ padding: '8px 10px', textAlign: 'left', fontSize: 10, color: 'var(--text-muted)', fontWeight: 500, textTransform: 'uppercase' }}>{h}</th>\n                    ))}\n                  </tr>\n                </thead>\n                <tbody>\n                  {iifResult.accounts.map((acct, i) => {\n                    const mapping = accountMappings.get(acct.name)\n                    const catColor = mapping?.fortunaCategory === 'uncategorized' ? '#ef4444'\n                      : mapping?.isDeductible ? '#22c55e' : 'var(--text-secondary)'\n                    return (\n                      <tr key={i} style={{ borderBottom: '1px solid var(--border-subtle)' }}>\n                        <td style={{ padding: '6px 10px', fontWeight: 500, color: 'var(--text-primary)' }}>{acct.name}</td>\n                        <td style={{ padding: '6px 10px' }}><span style={badge('#6366f1')}>{acct.accountType}</span></td>\n                        <td style={{ padding: '6px 10px' }}><span style={badge(catColor)}>{mapping?.fortunaCategory || '—'}</span></td>\n                        <td style={{ padding: '6px 10px', color: 'var(--text-muted)', fontSize: 10 }}>{mapping?.scheduleRef || '—'}</td>\n                        <td style={{ padding: '6px 10px' }}>{mapping?.isDeductible ? <span style={badge('#22c55e')}>✓</span> : '—'}</td>\n                      </tr>\n                    )\n                  })}\n                </tbody>\n              </table>\n            </div>\n          </div>\n        )}\n\n        {/* Transactions Tab */}\n        {selectedTab === 'transactions' && (\n          <div style={card}>\n            <div style={{ overflowX: 'auto', maxHeight: 500 }}>\n              <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 11 }}>\n                <thead style={{ position: 'sticky', top: 0, background: 'var(--bg-card)' }}>\n                  <tr style={{ borderBottom: '1px solid var(--border-subtle)' }}>\n                    {['Date', 'Type', 'Account', 'Name', 'Amount', 'Memo', '✓'].map(h => (\n                      <th key={h} style={{ padding: '8px 10px', textAlign: 'left', fontSize: 10, color: 'var(--text-muted)', fontWeight: 500, textTransform: 'uppercase' }}>{h}</th>\n                    ))}\n                  </tr>\n                </thead>\n                <tbody>\n                  {iifResult.transactions.slice(0, 100).map((txn, i) => {\n                    const flow = trnsTypeToFlow(txn.header.trnsType)\n                    return (\n                      <tr key={i} style={{ borderBottom: '1px solid var(--border-subtle)' }}>\n                        <td style={{ padding: '6px 10px', fontFamily: 'var(--font-mono)', color: 'var(--text-muted)', fontSize: 10 }}>{txn.header.date}</td>\n                        <td style={{ padding: '6px 10px' }}>\n                          <span style={badge(flow === 'income' ? '#22c55e' : flow === 'expense' ? '#ef4444' : '#6366f1')}>{txn.header.trnsType}</span>\n                        </td>\n                        <td style={{ padding: '6px 10px', color: 'var(--text-primary)' }}>{txn.header.account}</td>\n                        <td style={{ padding: '6px 10px', color: 'var(--text-secondary)' }}>{txn.header.name || '—'}</td>\n                        <td style={{ padding: '6px 10px', fontFamily: 'var(--font-mono)', fontWeight: 600, color: txn.header.amount >= 0 ? '#22c55e' : '#ef4444' }}>\n                          {txn.header.amount >= 0 ? '+' : ''}{txn.header.amount.toLocaleString(undefined, { minimumFractionDigits: 2 })}\n                        </td>\n                        <td style={{ padding: '6px 10px', color: 'var(--text-muted)', fontSize: 10, maxWidth: 200, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{txn.header.memo || '—'}</td>\n                        <td style={{ padding: '6px 10px', textAlign: 'center' }}>{txn.balanced ? '✓' : <span style={{ color: '#ef4444' }}>✗</span>}</td>\n                      </tr>\n                    )\n                  })}\n                </tbody>\n              </table>\n              {iifResult.transactions.length > 100 && (\n                <div style={{ padding: 12, textAlign: 'center', fontSize: 11, color: 'var(--text-muted)' }}>\n                  Showing 100 of {iifResult.transactions.length} transactions\n                </div>\n              )}\n            </div>\n          </div>\n        )}\n\n        {/* Mapping Tab */}\n        {selectedTab === 'mapping' && importSummary && (\n          <div style={card}>\n            <h3 style={{ fontSize: 14, fontWeight: 600, margin: '0 0 12px', color: 'var(--text-primary)' }}>🔗 Account → Tax Category Mapping</h3>\n            <p style={{ fontSize: 11, color: 'var(--text-muted)', margin: '0 0 12px' }}>\n              Fortuna automatically mapped {importSummary.accountsMapped} accounts to tax categories.\n              {importSummary.unmappedAccounts.length > 0 && ` ${importSummary.unmappedAccounts.length} accounts need manual review.`}\n            </p>\n            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 }}>\n              <div>\n                <div style={{ fontSize: 11, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 8 }}>✅ Income Streams ({importSummary.incomeStreamsCreated})</div>\n                <div style={{ fontSize: 11, color: 'var(--text-secondary)' }}>Revenue sources mapped to Schedule C/E/B categories</div>\n              </div>\n              <div>\n                <div style={{ fontSize: 11, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 8 }}>✅ Deductible Expenses ({importSummary.expensesCreated})</div>\n                <div style={{ fontSize: 11, color: 'var(--text-secondary)' }}>Business expenses mapped to specific Schedule C/E line items</div>\n              </div>\n              <div>\n                <div style={{ fontSize: 11, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 8 }}>✅ Entities ({importSummary.entitiesDetected})</div>\n                <div style={{ fontSize: 11, color: 'var(--text-secondary)' }}>Business entities detected from QB Classes</div>\n              </div>\n              <div>\n                <div style={{ fontSize: 11, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 8 }}>✅ 1099 Vendors ({importSummary.vendors1099})</div>\n                <div style={{ fontSize: 11, color: 'var(--text-secondary)' }}>Contractors flagged for 1099 reporting</div>\n              </div>\n            </div>\n            {importSummary.unmappedAccounts.length > 0 && (\n              <div style={{ marginTop: 16 }}>\n                <div style={{ fontSize: 11, fontWeight: 600, color: '#ef4444', marginBottom: 8 }}>⚠️ Unmapped Accounts ({importSummary.unmappedAccounts.length})</div>\n                <div style={{ display: 'flex', flexWrap: 'wrap', gap: 4 }}>\n                  {importSummary.unmappedAccounts.map(a => (\n                    <span key={a} style={badge('#ef4444')}>{a}</span>\n                  ))}\n                </div>\n              </div>\n            )}\n          </div>\n        )}\n      </div>\n    )\n  }\n\n  // ─── Complete Phase ───────────────────────────────────────────────────────────\n\n  if (phase === 'complete') {\n    const isIIF = fileKind === 'iif'\n    const isPDF = fileKind === 'pdf'\n    const isOFX = fileKind === 'ofx' || fileKind === 'qif'\n\n    return (\n      <div style={{ padding: '24px 32px', maxWidth: 900, textAlign: 'center' }}>\n        <div style={{ fontSize: 64, marginBottom: 16 }}>✅</div>\n        <h1 style={{ fontSize: 22, fontWeight: 700, color: 'var(--text-primary)', margin: '0 0 8px' }}>\n          {isPDF ? 'Tax Return Applied to Profile' : 'Data Imported Successfully'}\n        </h1>\n        <p style={{ fontSize: 13, color: 'var(--text-secondary)', margin: '0 0 24px' }}>\n          {isIIF && importSummary && (\n            <>{importSummary.incomeStreamsCreated} income streams, {importSummary.expensesCreated} expenses, and {importSummary.entitiesDetected} entities merged into your Fortuna profile.</>\n          )}\n          {isOFX && <>Bank transactions categorized and merged into income streams, expenses, and audit history. Duplicates were skipped.</>}\n          {isPDF && taxResult && (\n            <>Filing status, income streams, and expenses extracted from your {taxResult.taxYear ?? ''} return and applied to your profile.</>\n          )}\n        </p>\n        <div style={{ display: 'flex', justifyContent: 'center', gap: 12 }}>\n          <button onClick={reset}\n            style={{ padding: '8px 20px', borderRadius: 8, fontSize: 13, background: 'var(--bg-hover)', border: '1px solid var(--border-subtle)', color: 'var(--text-secondary)', cursor: 'pointer' }}>\n            Import Another File\n          </button>\n        </div>\n      </div>\n    )\n  }\n\n  return null\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\ReceiptReconciler.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Link' is defined but never used.","line":4,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":9,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Link"},"fix":{"range":[108,113],"text":""},"desc":"Remove unused variable \"Link\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AlertCircle' is defined but never used.","line":4,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":36,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AlertCircle"},"fix":{"range":[126,139],"text":""},"desc":"Remove unused variable \"AlertCircle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ArrowRight' is defined but never used.","line":5,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":15,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ArrowRight"},"fix":{"range":[147,165],"text":""},"desc":"Remove unused variable \"ArrowRight\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Clock' is defined but never used.","line":5,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":22,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Clock"},"fix":{"range":[165,172],"text":""},"desc":"Remove unused variable \"Clock\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DollarSign' is defined but never used.","line":5,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":34,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DollarSign"},"fix":{"range":[172,184],"text":""},"desc":"Remove unused variable \"DollarSign\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ExternalLink' is defined but never used.","line":5,"column":36,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":48,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ExternalLink"},"fix":{"range":[184,198],"text":""},"desc":"Remove unused variable \"ExternalLink\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Filter' is defined but never used.","line":6,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":11,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Filter"},"fix":{"range":[198,211],"text":""},"desc":"Remove unused variable \"Filter\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'filter' is assigned a value but never used.","line":11,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'setFilter' is assigned a value but never used.","line":11,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'possibleTx' is assigned a value but never used.","line":32,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":32,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'idx' is defined but never used.","line":101,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":101,"endColumn":48}],"suppressedMessages":[],"errorCount":11,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from 'react'\r\nimport { useFortuna } from '../hooks/useFortuna'\r\nimport { \r\n    Link, CheckCircle2, AlertCircle, Search, \r\n    ArrowRight, Clock, DollarSign, ExternalLink,\r\n    Filter\r\n} from 'lucide-react'\r\n\r\nexport function ReceiptReconciler() {\r\n    const { state, updateState } = useFortuna()\r\n    const [filter, setFilter] = useState<'all' | 'unmatched' | 'matched'>('unmatched')\r\n    const [searchQuery, setSearchQuery] = useState('')\r\n\r\n    // Unreconciled bank transactions (auditHistory)\r\n    const transactions = useMemo(() => {\r\n        return state.auditHistory.filter(tx => {\r\n            const matchesSearch = tx.description.toLowerCase().includes(searchQuery.toLowerCase())\r\n            const isExpense = tx.amount < 0\r\n            return matchesSearch && isExpense\r\n        })\r\n    }, [state.auditHistory, searchQuery])\r\n\r\n    // Current scanned receipts\r\n    const receipts = useMemo(() => {\r\n        return state.receipts.filter(r => r.status === 'needs_review' || r.status === 'scanned')\r\n    }, [state.receipts])\r\n\r\n    // Auto-matching logic\r\n    const suggestions = useMemo(() => {\r\n        const matches: Record<string, { id: string, reason: string }> = {}\r\n        receipts.forEach(receipt => {\r\n            const possibleTx = transactions.find(tx => {\r\n                const txAmount = Math.abs(tx.amount)\r\n                const amountDiff = Math.abs(txAmount - receipt.totalAmount)\r\n                const isAmountMatch = amountDiff < (txAmount * 0.05) // 5% tolerance\r\n                const isDateMatch = Math.abs(new Date(tx.date).getTime() - new Date(receipt.date).getTime()) < 3 * 24 * 60 * 60 * 1000\r\n\r\n                if (isAmountMatch && isDateMatch) {\r\n                    matches[receipt.id] = { id: tx.id, reason: 'Date & Amount Match' }\r\n                    return true\r\n                } else if (isAmountMatch && amountDiff < 0.01) {\r\n                    matches[receipt.id] = { id: tx.id, reason: 'Exact Amount Match' }\r\n                    return true\r\n                }\r\n                return false\r\n            })\r\n        })\r\n        return matches\r\n    }, [receipts, transactions])\r\n\r\n    const handleMatch = (receiptId: string, transactionId: string) => {\r\n        updateState(s => {\r\n            const newState = { ...s }\r\n            const receipt = newState.receipts.find(r => r.id === receiptId)\r\n            const tx = newState.auditHistory.find(t => t.id === transactionId)\r\n            \r\n            if (receipt && tx) {\r\n                receipt.status = 'allocated' // Mark as reconciled\r\n                tx.status = 'verified'\r\n                tx.metadata = { ...tx.metadata, receiptId: receipt.id }\r\n            }\r\n            return newState\r\n        })\r\n    }\r\n\r\n    // Styles\r\n    const card: React.CSSProperties = {\r\n        background: 'var(--bg-elevated)', border: '1px solid var(--border-subtle)',\r\n        borderRadius: 14, padding: 20, marginBottom: 16,\r\n        animation: 'slideUp 0.4s ease-out forwards',\r\n        transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)'\r\n    }\r\n\r\n    return (\r\n        <div style={{ padding: '32px 40px', maxWidth: 1000 }}>\r\n            <style>{`\r\n                @keyframes slideUp {\r\n                    from { opacity: 0; transform: translateY(12px); }\r\n                    to { opacity: 1; transform: translateY(0); }\r\n                }\r\n                .match-confirm:hover {\r\n                    transform: scale(1.02);\r\n                    filter: brightness(1.1);\r\n                }\r\n            `}</style>\r\n            <div style={{ marginBottom: 32 }}>\r\n                <h1 style={{ fontFamily: 'var(--font-display)', fontSize: 26, color: 'var(--text-primary)', marginBottom: 8 }}>\r\n                    Receipt Reconciler\r\n                </h1>\r\n                <p style={{ fontSize: 13, color: 'var(--text-muted)' }}>\r\n                    Match your scanned receipts with bank transactions to create an immutable audit trail.\r\n                </p>\r\n            </div>\r\n\r\n            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 24 }}>\r\n                {/* Receipts Column */}\r\n                <div>\r\n                    <h3 style={{ fontSize: 14, fontWeight: 700, color: 'var(--text-secondary)', marginBottom: 16, textTransform: 'uppercase', letterSpacing: '0.05em' }}>\r\n                        Pending Receipts ({receipts.length})\r\n                    </h3>\r\n                    {receipts.map((receipt, idx) => {\r\n                        const suggestedMatch = suggestions[receipt.id]\r\n                        const suggestedTx = suggestedMatch ? transactions.find(t => t.id === suggestedMatch.id) : null\r\n\r\n                        return (\r\n                            <div key={receipt.id} style={card}>\r\n                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 12 }}>\r\n                                    <div>\r\n                                        <div style={{ fontSize: 14, fontWeight: 600, color: 'var(--text-primary)' }}>{receipt.merchantName}</div>\r\n                                        <div style={{ fontSize: 12, color: 'var(--text-muted)' }}>{receipt.date}</div>\r\n                                    </div>\r\n                                    <div style={{ fontFamily: 'var(--font-mono)', fontWeight: 700, color: 'var(--accent-gold)' }}>\r\n                                        ${receipt.totalAmount.toFixed(2)}\r\n                                    </div>\r\n                                </div>\r\n\r\n                                {suggestedMatch ? (\r\n                                    <div style={{ background: 'var(--accent-emerald-dim)', border: '1px solid var(--accent-emerald)22', borderRadius: 10, padding: 12 }}>\r\n                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>\r\n                                            <div style={{ fontSize: 10, fontWeight: 700, color: 'var(--accent-emerald)', textTransform: 'uppercase', display: 'flex', alignItems: 'center', gap: 6 }}>\r\n                                                <CheckCircle2 size={12} /> Probable Match\r\n                                            </div>\r\n                                            <div style={{ fontSize: 9, padding: '2px 8px', background: 'rgba(16,185,129,0.1)', borderRadius: 12, color: 'var(--accent-emerald)', fontWeight: 600 }}>\r\n                                                {suggestedMatch.reason}\r\n                                            </div>\r\n                                        </div>\r\n                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\r\n                                            <div>\r\n                                                <div style={{ fontSize: 12, fontWeight: 600 }}>{suggestedTx?.description}</div>\r\n                                                <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>{suggestedTx?.date} · ${Math.abs(suggestedTx?.amount || 0).toFixed(2)}</div>\r\n                                            </div>\r\n                                            <button \r\n                                                onClick={() => handleMatch(receipt.id, suggestedMatch.id)}\r\n                                                className=\"match-confirm\"\r\n                                                style={{ padding: '8px 16px', background: 'var(--accent-emerald)', border: 'none', borderRadius: 8, color: '#000', fontSize: 11, fontWeight: 700, cursor: 'pointer', transition: 'all 0.2s' }}\r\n                                            >\r\n                                                Confirm Match\r\n                                            </button>\r\n                                        </div>\r\n                                    </div>\r\n                                ) : (\r\n                                    <div style={{ fontSize: 11, color: 'var(--text-muted)', fontStyle: 'italic' }}>\r\n                                        No auto-match found. Search transactions manually...\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        )\r\n                    })}\r\n                    {receipts.length === 0 && (\r\n                        <div style={{ textAlign: 'center', padding: 40, border: '2px dashed var(--border-subtle)', borderRadius: 14 }}>\r\n                            <div style={{ color: 'var(--text-muted)', fontSize: 13 }}>All receipts reconciled!</div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Transactions Column */}\r\n                <div>\r\n                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>\r\n                        <h3 style={{ fontSize: 14, fontWeight: 700, color: 'var(--text-secondary)', textTransform: 'uppercase', letterSpacing: '0.05em', margin: 0 }}>\r\n                            Bank Transactions\r\n                        </h3>\r\n                        <div style={{ position: 'relative' }}>\r\n                            <Search size={14} style={{ position: 'absolute', left: 10, top: '50%', transform: 'translateY(-50%)', color: 'var(--text-muted)' }} />\r\n                            <input \r\n                                placeholder=\"Search...\"\r\n                                value={searchQuery}\r\n                                onChange={e => setSearchQuery(e.target.value)}\r\n                                style={{ padding: '6px 10px 6px 30px', background: 'var(--bg-surface)', border: '1px solid var(--border-subtle)', borderRadius: 8, fontSize: 12, color: 'var(--text-primary)', outline: 'none' }}\r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>\r\n                        {transactions.map(tx => (\r\n                            <div key={tx.id} style={{ ...card, padding: '12px 16px', background: tx.status === 'verified' ? 'rgba(16,185,129,0.05)' : 'var(--bg-elevated)', opacity: tx.status === 'verified' ? 0.6 : 1 }}>\r\n                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\r\n                                    <div>\r\n                                        <div style={{ fontSize: 13, fontWeight: 600, color: tx.status === 'verified' ? 'var(--accent-emerald)' : 'var(--text-primary)' }}>\r\n                                            {tx.description}\r\n                                        </div>\r\n                                        <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>{tx.date}</div>\r\n                                    </div>\r\n                                    <div style={{ textAlign: 'right' }}>\r\n                                        <div style={{ fontFamily: 'var(--font-mono)', fontWeight: 600, color: 'var(--text-primary)' }}>\r\n                                            ${Math.abs(tx.amount).toFixed(2)}\r\n                                        </div>\r\n                                        {tx.status === 'verified' && <div style={{ fontSize: 9, color: 'var(--accent-emerald)', fontWeight: 700 }}>VERIFIED</div>}\r\n                                    </div>\r\n                                </div>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\Reports.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AuditRiskProfile' is defined but never used.","line":3,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":49,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AuditRiskProfile"},"fix":{"range":[124,147],"text":""},"desc":"Remove unused variable \"AuditRiskProfile\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AuditTrigger' is defined but never used.","line":3,"column":56,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":68,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AuditTrigger"},"fix":{"range":[147,166],"text":""},"desc":"Remove unused variable \"AuditTrigger\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TrendingUp' is defined but never used.","line":8,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":13,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TrendingUp"},"fix":{"range":[405,419],"text":""},"desc":"Remove unused variable \"TrendingUp\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DollarSign' is defined but never used.","line":8,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":25,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DollarSign"},"fix":{"range":[419,431],"text":""},"desc":"Remove unused variable \"DollarSign\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Eye' is defined but never used.","line":9,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":44,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Eye"},"fix":{"range":[507,512],"text":""},"desc":"Remove unused variable \"Eye\"."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo, useRef } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { analyzeAuditRisk, type AuditRiskProfile, type AuditTrigger } from '../engine/audit-risk'\nimport { generateWaterfall } from '../engine/scenario-modeler'\nimport { generateTimeline, groupByQuarter } from '../engine/execution-timeline'\nimport {\n  FileText, Printer, Shield, AlertTriangle, CheckCircle2,\n  TrendingUp, DollarSign, Building2, Clock, Target, Activity,\n  BarChart3, ChevronDown, ChevronRight, Eye, Sparkles\n} from 'lucide-react'\n\nfunction fmt(n: number): string { return `$${Math.round(n).toLocaleString()}` }\nfunction pct(n: number): string { return `${(n * 100).toFixed(1)}%` }\n\nconst RISK_COLORS: Record<string, string> = {\n  'very-high': '#ef4444',\n  'high': '#f97316',\n  'elevated': '#f59e0b',\n  'moderate': '#60a5fa',\n  'low': '#10b981',\n}\n\nconst SEV_COLORS: Record<string, { bg: string; text: string }> = {\n  critical: { bg: 'rgba(239,68,68,0.12)', text: '#ef4444' },\n  high: { bg: 'rgba(249,115,22,0.12)', text: '#f97316' },\n  medium: { bg: 'rgba(245,158,11,0.12)', text: '#f59e0b' },\n  low: { bg: 'rgba(16,185,129,0.12)', text: '#10b981' },\n}\n\nexport function Reports() {\n  const { state, taxReport, strategies, risks, healthScore, entityComparison } = useFortuna()\n  const [expandedTriggers, setExpandedTriggers] = useState<Set<string>>(new Set())\n  const reportRef = useRef<HTMLDivElement>(null)\n\n  const hasData = state.incomeStreams.length > 0\n  const auditRisk = useMemo(() => analyzeAuditRisk(state), [state])\n  const waterfall = useMemo(() => generateWaterfall(taxReport), [taxReport])\n  const timeline = useMemo(() => generateTimeline(state), [state])\n  const quarters = useMemo(() => groupByQuarter(timeline), [timeline])\n\n  const toggleTrigger = (id: string) => {\n    setExpandedTriggers(prev => {\n      const next = new Set(prev)\n      if (next.has(id)) next.delete(id)\n      else next.add(id)\n      return next\n    })\n  }\n\n  const handlePrint = () => {\n    window.print()\n  }\n\n  const reportDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })\n\n  if (!hasData) {\n    return (\n      <div className=\"view-enter\" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '50vh' }}>\n        <div style={{ textAlign: 'center', maxWidth: 400 }}>\n          <FileText size={32} color=\"var(--accent-gold)\" style={{ marginBottom: 12 }} />\n          <h2 style={{ fontFamily: 'var(--font-display)', marginBottom: 8 }}>Financial Reports</h2>\n          <p style={{ fontSize: 13, color: 'var(--text-muted)' }}>Add financial data first to generate reports.</p>\n        </div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"view-enter\">\n      {/* ── Header (non-printable controls) ── */}\n      <div className=\"no-print\" style={{ marginBottom: 24 }}>\n        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>\n          <div>\n            <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 4 }}>\n              <h1 className=\"section-title\">Financial Intelligence Report</h1>\n              <span className=\"pill gold\"><FileText size={11} /> Printable</span>\n            </div>\n            <p className=\"section-subtitle\">Comprehensive analysis including audit risk, tax breakdown, strategies, and execution timeline</p>\n          </div>\n          <button onClick={handlePrint} style={{\n            padding: '10px 20px', borderRadius: 10, border: 'none',\n            background: 'var(--accent-gold)', color: '#0c0e12',\n            cursor: 'pointer', fontSize: 13, fontWeight: 600, fontFamily: 'var(--font-body)',\n            display: 'flex', alignItems: 'center', gap: 8,\n          }}>\n            <Printer size={16} /> Print / Export PDF\n          </button>\n        </div>\n      </div>\n\n      {/* ══════════════════════════════════════════════ */}\n      {/* ══ PRINTABLE REPORT CONTENT ══ */}\n      {/* ══════════════════════════════════════════════ */}\n      <div ref={reportRef} id=\"fortuna-report\">\n\n        {/* ── Report Cover ── */}\n        <div className=\"report-section\" style={{\n          padding: '40px 36px', background: 'var(--bg-elevated)', borderRadius: 16,\n          border: '1px solid var(--border-subtle)', marginBottom: 20,\n          borderLeft: '4px solid var(--accent-gold)',\n        }}>\n          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>\n            <div>\n              <div style={{ fontFamily: 'var(--font-display)', fontSize: 28, color: 'var(--accent-gold)', marginBottom: 4 }}>\n                FORTUNA\n              </div>\n              <div style={{ fontFamily: 'var(--font-display)', fontSize: 20, color: 'var(--text-primary)', marginBottom: 16 }}>\n                Financial Intelligence Report\n              </div>\n              <div style={{ fontSize: 13, color: 'var(--text-muted)', lineHeight: 1.8 }}>\n                <div>Prepared for: <strong style={{ color: 'var(--text-primary)' }}>{state.profile.name || 'Financial Profile'}</strong></div>\n                <div>Filing Status: <strong style={{ color: 'var(--text-primary)' }}>{state.profile.filingStatus.replace('_', ' ')}</strong></div>\n                <div>State: <strong style={{ color: 'var(--text-primary)' }}>{state.profile.state}</strong></div>\n                <div>Generated: <strong style={{ color: 'var(--text-primary)' }}>{reportDate}</strong></div>\n              </div>\n            </div>\n            <div style={{ textAlign: 'right' }}>\n              <div style={{ fontSize: 11, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.08em', marginBottom: 8 }}>Health Score</div>\n              <div style={{\n                fontFamily: 'var(--font-mono)', fontSize: 48, fontWeight: 700,\n                color: healthScore.overall >= 70 ? 'var(--accent-emerald)' : healthScore.overall >= 50 ? 'var(--accent-gold)' : 'var(--accent-red)',\n                lineHeight: 1,\n              }}>\n                {healthScore.overall}\n              </div>\n              <div style={{ fontFamily: 'var(--font-mono)', fontSize: 14, color: 'var(--text-muted)', marginTop: 4 }}>\n                Grade: {healthScore.grade}\n              </div>\n            </div>\n          </div>\n        </div>\n\n        {/* ── Executive Summary ── */}\n        <ReportCard title=\"Executive Summary\" icon={<Sparkles size={16} />}>\n          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 16, marginBottom: 20 }}>\n            <MetricBox label=\"Gross Revenue\" value={fmt(taxReport.grossIncome)} color=\"var(--accent-blue)\" />\n            <MetricBox label=\"Total Tax Burden\" value={fmt(taxReport.totalTax)} sub={pct(taxReport.effectiveRate)} color=\"var(--accent-red)\" />\n            <MetricBox label=\"After-Tax Income\" value={fmt(taxReport.afterTaxIncome)} color=\"var(--accent-emerald)\" />\n            <MetricBox label=\"Identified Savings\" value={fmt(taxReport.identifiedSavings)} color=\"var(--accent-gold)\" />\n          </div>\n\n          <div style={{ fontSize: 13, color: 'var(--text-secondary)', lineHeight: 1.8 }}>\n            Your effective tax rate is <strong>{pct(taxReport.effectiveRate)}</strong> with a marginal rate of <strong>{pct(taxReport.marginalRate)}</strong>.\n            {taxReport.identifiedSavings > 0 && (\n              <> The engine has identified <strong style={{ color: 'var(--accent-gold)' }}>{fmt(taxReport.identifiedSavings)}</strong> in potential annual tax savings through entity restructuring, retirement maximization, and deduction optimization.</>\n            )}\n            {' '}Your financial health score of <strong>{healthScore.overall}/100 ({healthScore.grade})</strong> indicates\n            {healthScore.overall >= 70 ? ' a well-optimized financial position with room for incremental improvement.' : healthScore.overall >= 50 ? ' a solid foundation with meaningful optimization opportunities available.' : ' significant optimization potential — implementing recommended strategies could materially improve your financial position.'}\n          </div>\n        </ReportCard>\n\n        {/* ── Tax Breakdown (Waterfall) ── */}\n        <ReportCard title=\"Tax Waterfall Analysis\" icon={<BarChart3 size={16} />}>\n          <div style={{ marginBottom: 16 }}>\n            {waterfall.map((seg, i) => {\n              const maxVal = waterfall[0]?.amount || 1\n              const barWidth = Math.max(4, (Math.abs(seg.amount) / maxVal) * 100)\n              const isLast = i === waterfall.length - 1\n              return (\n                <div key={i} style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 8, padding: '4px 0' }}>\n                  <div style={{ width: 110, fontSize: 12, color: 'var(--text-muted)', textAlign: 'right', flexShrink: 0 }}>{seg.label}</div>\n                  <div style={{ flex: 1, height: 20, background: 'var(--bg-surface)', borderRadius: 4, overflow: 'hidden', position: 'relative' }}>\n                    <div style={{\n                      position: 'absolute', left: 0, top: 0, height: '100%',\n                      width: `${isLast ? (seg.amount / maxVal) * 100 : barWidth}%`,\n                      background: seg.color, borderRadius: 4, opacity: 0.8,\n                      transition: 'width 0.5s ease',\n                    }} />\n                  </div>\n                  <div style={{\n                    width: 85, fontSize: 12, fontFamily: 'var(--font-mono)', textAlign: 'right', fontWeight: isLast ? 600 : 400,\n                    color: seg.type === 'net' ? '#10b981' : seg.type === 'tax' ? '#ef4444' : seg.type === 'deduction' ? '#f59e0b' : 'var(--text-primary)',\n                  }}>\n                    {seg.amount >= 0 ? '' : '-'}{fmt(Math.abs(seg.amount))}\n                  </div>\n                </div>\n              )\n            })}\n          </div>\n\n          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 12 }}>\n            <MiniStat label=\"Federal Income Tax\" value={fmt(taxReport.federalIncomeTax)} />\n            <MiniStat label=\"Self-Employment Tax\" value={fmt(taxReport.selfEmploymentTax)} />\n            <MiniStat label=\"State Tax ({state.profile.state})\" value={fmt(taxReport.stateTax)} />\n            <MiniStat label=\"QBI Deduction (§199A)\" value={fmt(taxReport.qbiDeduction)} />\n            <MiniStat label=\"Marginal Rate\" value={pct(taxReport.marginalRate)} />\n            <MiniStat label=\"Effective Rate\" value={pct(taxReport.effectiveRate)} />\n          </div>\n        </ReportCard>\n\n        {/* ── Audit Risk Assessment ── */}\n        <ReportCard title=\"IRS Audit Risk Assessment\" icon={<Shield size={16} />}>\n          {/* Risk dashboard */}\n          <div style={{ display: 'flex', gap: 20, marginBottom: 24, alignItems: 'center' }}>\n            <div style={{\n              width: 100, height: 100, borderRadius: '50%',\n              border: `4px solid ${RISK_COLORS[auditRisk.riskLevel]}`,\n              display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center',\n              flexShrink: 0,\n            }}>\n              <div style={{ fontFamily: 'var(--font-mono)', fontSize: 28, fontWeight: 700, color: RISK_COLORS[auditRisk.riskLevel] }}>\n                {auditRisk.overallScore}\n              </div>\n              <div style={{ fontSize: 9, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.08em' }}>Risk Score</div>\n            </div>\n\n            <div style={{ flex: 1 }}>\n              <div style={{ fontSize: 15, fontWeight: 600, color: RISK_COLORS[auditRisk.riskLevel], marginBottom: 6 }}>\n                {auditRisk.riskLabel}\n              </div>\n              <div style={{ fontSize: 12, color: 'var(--text-muted)', lineHeight: 1.7 }}>\n                <div>National baseline audit rate for your income level: <strong style={{ color: 'var(--text-primary)' }}>{(auditRisk.baselineAuditRate * 100).toFixed(2)}%</strong></div>\n                <div>Your estimated adjusted rate: <strong style={{ color: RISK_COLORS[auditRisk.riskLevel] }}>{(auditRisk.adjustedAuditRate * 100).toFixed(2)}%</strong></div>\n                <div>Triggers analyzed: <strong style={{ color: 'var(--text-primary)' }}>{auditRisk.triggeredCount}</strong> of {auditRisk.totalChecks} checks flagged</div>\n                <div>Red flags: <strong style={{ color: '#ef4444' }}>{auditRisk.redFlagCount}</strong> · Yellow flags: <strong style={{ color: '#f59e0b' }}>{auditRisk.yellowFlagCount}</strong></div>\n              </div>\n            </div>\n\n            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 10 }}>\n              <MiniGauge label=\"Documentation\" value={auditRisk.documentationScore} color={auditRisk.documentationScore > 60 ? '#10b981' : '#f59e0b'} />\n              <MiniGauge label=\"Compliance\" value={Math.max(0, 100 - auditRisk.overallScore)} color={auditRisk.overallScore < 40 ? '#10b981' : '#f59e0b'} />\n            </div>\n          </div>\n\n          {/* Triggered items */}\n          <div style={{ fontSize: 12, fontWeight: 500, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 12 }}>\n            Audit Trigger Analysis ({auditRisk.triggers.filter(t => t.triggered).length} Active)\n          </div>\n          {auditRisk.triggers.filter(t => t.triggered).map(trigger => {\n            const isExpanded = expandedTriggers.has(trigger.id)\n            const sev = SEV_COLORS[trigger.severity]\n            return (\n              <div key={trigger.id} style={{\n                marginBottom: 8, borderRadius: 12, border: '1px solid var(--border-subtle)',\n                background: 'var(--bg-surface)', overflow: 'hidden',\n              }}>\n                <button onClick={() => toggleTrigger(trigger.id)} style={{\n                  width: '100%', padding: '12px 16px', display: 'flex', alignItems: 'center', gap: 12,\n                  background: 'none', border: 'none', cursor: 'pointer', textAlign: 'left',\n                }}>\n                  <span style={{\n                    padding: '3px 8px', borderRadius: 6, fontSize: 10, fontWeight: 600,\n                    background: sev.bg, color: sev.text, textTransform: 'uppercase', letterSpacing: '0.05em',\n                    flexShrink: 0,\n                  }}>\n                    {trigger.severity}\n                  </span>\n                  <span style={{ flex: 1, fontSize: 13, color: 'var(--text-primary)', fontWeight: 500 }}>{trigger.name}</span>\n                  <span style={{ fontFamily: 'var(--font-mono)', fontSize: 12, color: sev.text, marginRight: 8 }}>\n                    {trigger.riskScore}/100\n                  </span>\n                  {isExpanded ? <ChevronDown size={14} color=\"var(--text-muted)\" /> : <ChevronRight size={14} color=\"var(--text-muted)\" />}\n                </button>\n\n                {isExpanded && (\n                  <div style={{ padding: '0 16px 16px', borderTop: '1px solid var(--border-subtle)' }}>\n                    <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.7, marginTop: 12, marginBottom: 12 }}>\n                      {trigger.description}\n                    </div>\n\n                    <div style={{ padding: '10px 14px', background: 'rgba(96,165,250,0.06)', borderRadius: 8, border: '1px solid rgba(96,165,250,0.15)', marginBottom: 10 }}>\n                      <div style={{ fontSize: 10, color: '#60a5fa', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 4 }}>IRS Context</div>\n                      <div style={{ fontSize: 11, color: 'var(--text-secondary)', lineHeight: 1.6 }}>{trigger.irsContext}</div>\n                    </div>\n\n                    <div style={{ padding: '10px 14px', background: 'rgba(16,185,129,0.06)', borderRadius: 8, border: '1px solid rgba(16,185,129,0.15)', marginBottom: 10 }}>\n                      <div style={{ fontSize: 10, color: '#10b981', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 4 }}>Mitigation Strategy</div>\n                      <div style={{ fontSize: 11, color: 'var(--text-secondary)', lineHeight: 1.6 }}>{trigger.mitigation}</div>\n                    </div>\n\n                    <div style={{ fontSize: 10, color: 'var(--text-muted)', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 6 }}>Documentation Needed</div>\n                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: 6 }}>\n                      {trigger.documentationNeeded.map((doc, j) => (\n                        <span key={j} style={{\n                          padding: '4px 10px', borderRadius: 6, fontSize: 11,\n                          background: 'var(--bg-elevated)', border: '1px solid var(--border-subtle)',\n                          color: 'var(--text-secondary)',\n                        }}>\n                          {doc}\n                        </span>\n                      ))}\n                    </div>\n                  </div>\n                )}\n              </div>\n            )\n          })}\n\n          {/* Top Recommendations */}\n          <div style={{ marginTop: 16, padding: '14px 18px', background: 'var(--accent-gold-dim)', borderRadius: 10, border: '1px solid rgba(212,168,67,0.2)' }}>\n            <div style={{ fontSize: 11, color: 'var(--accent-gold)', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 8 }}>\n              Priority Recommendations\n            </div>\n            {auditRisk.topRecommendations.map((rec, i) => (\n              <div key={i} style={{ display: 'flex', gap: 8, alignItems: 'flex-start', marginBottom: 6 }}>\n                <CheckCircle2 size={13} color=\"var(--accent-gold)\" style={{ flexShrink: 0, marginTop: 2 }} />\n                <span style={{ fontSize: 12, color: 'var(--text-primary)', lineHeight: 1.5 }}>{rec}</span>\n              </div>\n            ))}\n          </div>\n        </ReportCard>\n\n        {/* ── Health Score Breakdown ── */}\n        <ReportCard title=\"Financial Health Breakdown\" icon={<Activity size={16} />}>\n          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: 12 }}>\n            {[\n              { label: 'Tax Efficiency', value: healthScore.components.taxEfficiency, weight: '25%', color: '#d4a843' },\n              { label: 'Entity Design', value: healthScore.components.entityOptimization, weight: '20%', color: '#60a5fa' },\n              { label: 'Diversification', value: healthScore.components.diversification, weight: '15%', color: '#a78bfa' },\n              { label: 'Risk Protection', value: healthScore.components.riskProtection, weight: '20%', color: '#10b981' },\n              { label: 'Retirement', value: healthScore.components.retirementReadiness, weight: '20%', color: '#f59e0b' },\n            ].map((comp, i) => (\n              <div key={i} style={{ textAlign: 'center' }}>\n                <div style={{\n                  width: 64, height: 64, borderRadius: '50%', margin: '0 auto 10px',\n                  border: `3px solid ${comp.color}`,\n                  display: 'flex', alignItems: 'center', justifyContent: 'center',\n                  background: `${comp.color}11`,\n                }}>\n                  <span style={{ fontFamily: 'var(--font-mono)', fontSize: 18, fontWeight: 700, color: comp.color }}>\n                    {comp.value}\n                  </span>\n                </div>\n                <div style={{ fontSize: 11, fontWeight: 500, color: 'var(--text-primary)' }}>{comp.label}</div>\n                <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>Weight: {comp.weight}</div>\n              </div>\n            ))}\n          </div>\n        </ReportCard>\n\n        {/* ── Strategy Recommendations ── */}\n        <ReportCard title=\"Strategy Recommendations\" icon={<Target size={16} />}>\n          {strategies.length === 0 ? (\n            <div style={{ fontSize: 13, color: 'var(--text-muted)', textAlign: 'center', padding: 20 }}>No strategies detected — your profile is well-optimized.</div>\n          ) : (\n            <div style={{ display: 'grid', gap: 10 }}>\n              {strategies.sort((a, b) => b.estimatedImpact - a.estimatedImpact).slice(0, 8).map(strat => {\n                const sev = SEV_COLORS[strat.priority]\n                return (\n                  <div key={strat.id} style={{\n                    padding: '14px 18px', borderRadius: 10, background: 'var(--bg-surface)',\n                    border: '1px solid var(--border-subtle)', display: 'flex', alignItems: 'flex-start', gap: 14,\n                  }}>\n                    <span style={{\n                      padding: '3px 8px', borderRadius: 6, fontSize: 10, fontWeight: 600,\n                      background: sev.bg, color: sev.text, textTransform: 'uppercase', flexShrink: 0, marginTop: 2,\n                    }}>\n                      {strat.priority}\n                    </span>\n                    <div style={{ flex: 1 }}>\n                      <div style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)', marginBottom: 4 }}>{strat.title}</div>\n                      <div style={{ fontSize: 12, color: 'var(--text-muted)', lineHeight: 1.5 }}>{strat.description}</div>\n                    </div>\n                    <div style={{ textAlign: 'right', flexShrink: 0 }}>\n                      <div style={{ fontFamily: 'var(--font-mono)', fontSize: 14, fontWeight: 600, color: 'var(--accent-emerald)' }}>{strat.impactLabel}</div>\n                      <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>{strat.timeline}</div>\n                    </div>\n                  </div>\n                )\n              })}\n            </div>\n          )}\n        </ReportCard>\n\n        {/* ── Entity Comparison ── */}\n        <ReportCard title=\"Entity Structure Analysis\" icon={<Building2 size={16} />}>\n          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 12 }}>\n            {entityComparison.map(ent => {\n              const isBest = entityComparison.every(e => e.score <= ent.score)\n              const isCurrent = state.entities.some(e => e.type === ent.entityType && e.isActive) ||\n                (ent.entityType === 'sole_prop' && !state.entities.some(e => e.isActive && e.type !== 'sole_prop'))\n              return (\n                <div key={ent.entityType} style={{\n                  padding: 16, borderRadius: 12, background: 'var(--bg-surface)',\n                  border: `1px solid ${isBest ? 'var(--accent-gold)' : 'var(--border-subtle)'}`,\n                  position: 'relative',\n                }}>\n                  {isBest && (\n                    <div style={{\n                      position: 'absolute', top: -8, right: 12, padding: '2px 8px',\n                      background: 'var(--accent-gold)', color: '#0c0e12', fontSize: 9,\n                      fontWeight: 700, borderRadius: 4, textTransform: 'uppercase', letterSpacing: '0.06em',\n                    }}>Best Fit</div>\n                  )}\n                  {isCurrent && (\n                    <div style={{\n                      position: 'absolute', top: -8, left: 12, padding: '2px 8px',\n                      background: 'var(--accent-blue)', color: '#fff', fontSize: 9,\n                      fontWeight: 700, borderRadius: 4, textTransform: 'uppercase', letterSpacing: '0.06em',\n                    }}>Current</div>\n                  )}\n                  <div style={{ fontSize: 13, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 8, marginTop: 4 }}>{ent.label}</div>\n                  <div style={{ fontFamily: 'var(--font-mono)', fontSize: 10, color: 'var(--text-muted)', lineHeight: 1.8 }}>\n                    <div>Score: <strong style={{ color: 'var(--accent-gold)' }}>{ent.score}/100</strong></div>\n                    <div>Total Tax: <strong>{fmt(ent.totalTax)}</strong></div>\n                    <div>Eff. Rate: <strong>{pct(ent.effectiveRate)}</strong></div>\n                    <div>SE Tax: <strong>{fmt(ent.seTax)}</strong></div>\n                    <div>Annual Cost: <strong>{fmt(ent.annualCost)}</strong></div>\n                  </div>\n                </div>\n              )\n            })}\n          </div>\n        </ReportCard>\n\n        {/* ── Execution Timeline ── */}\n        <ReportCard title=\"Execution Timeline\" icon={<Clock size={16} />}>\n          {quarters.length === 0 ? (\n            <div style={{ fontSize: 13, color: 'var(--text-muted)', textAlign: 'center', padding: 20 }}>No upcoming actions detected.</div>\n          ) : (\n            quarters.slice(0, 4).map(q => (\n              <div key={q.quarter} style={{ marginBottom: 16 }}>\n                <div style={{ fontSize: 13, fontWeight: 600, color: 'var(--accent-gold)', marginBottom: 8 }}>{q.label}</div>\n                {q.actions.slice(0, 5).map(action => (\n                  <div key={action.id} style={{\n                    display: 'flex', alignItems: 'center', gap: 12, padding: '8px 0',\n                    borderBottom: '1px solid var(--border-subtle)',\n                  }}>\n                    <span style={{\n                      padding: '2px 8px', borderRadius: 5, fontSize: 10, fontWeight: 600,\n                      background: action.status === 'overdue' ? 'rgba(239,68,68,0.12)' : action.status === 'urgent' ? 'rgba(245,158,11,0.12)' : 'rgba(96,165,250,0.12)',\n                      color: action.status === 'overdue' ? '#ef4444' : action.status === 'urgent' ? '#f59e0b' : '#60a5fa',\n                      textTransform: 'uppercase', flexShrink: 0,\n                    }}>\n                      {action.status}\n                    </span>\n                    <div style={{ flex: 1, fontSize: 12, color: 'var(--text-primary)' }}>{action.title}</div>\n                    <div style={{ fontSize: 11, fontFamily: 'var(--font-mono)', color: 'var(--text-muted)' }}>{action.deadlineLabel}</div>\n                    {action.irsForm && (\n                      <span style={{ fontSize: 10, color: 'var(--accent-blue)', background: 'rgba(96,165,250,0.08)', padding: '2px 6px', borderRadius: 4 }}>\n                        {action.irsForm}\n                      </span>\n                    )}\n                  </div>\n                ))}\n              </div>\n            ))\n          )}\n        </ReportCard>\n\n        {/* ── Risk Assessment ── */}\n        <ReportCard title=\"Risk Exposure Summary\" icon={<AlertTriangle size={16} />}>\n          {risks.length === 0 ? (\n            <div style={{ fontSize: 13, color: 'var(--text-muted)', textAlign: 'center', padding: 20 }}>No significant risks detected.</div>\n          ) : (\n            <div style={{ display: 'grid', gap: 8 }}>\n              {risks.sort((a, b) => b.severity - a.severity).slice(0, 6).map(risk => {\n                const sevKey = risk.severity >= 70 ? 'critical' : risk.severity >= 50 ? 'high' : risk.severity >= 30 ? 'medium' : 'low'\n                const sev = SEV_COLORS[sevKey]\n                return (\n                  <div key={risk.id} style={{\n                    display: 'flex', gap: 12, padding: '12px 16px', borderRadius: 10,\n                    background: 'var(--bg-surface)', border: '1px solid var(--border-subtle)',\n                  }}>\n                    <span style={{\n                      padding: '3px 8px', borderRadius: 6, fontSize: 10, fontWeight: 600,\n                      background: sev.bg, color: sev.text, textTransform: 'uppercase', flexShrink: 0, height: 'fit-content',\n                    }}>\n                      {sevKey}\n                    </span>\n                    <div style={{ flex: 1 }}>\n                      <div style={{ fontSize: 12, fontWeight: 500, color: 'var(--text-primary)', marginBottom: 2 }}>{risk.category}</div>\n                      <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>{risk.description}</div>\n                    </div>\n                    <div style={{ fontSize: 11, color: 'var(--text-secondary)', maxWidth: 200, textAlign: 'right' }}>{risk.mitigation}</div>\n                  </div>\n                )\n              })}\n            </div>\n          )}\n        </ReportCard>\n\n        {/* ── Disclaimer ── */}\n        <div style={{\n          padding: '16px 20px', borderRadius: 10, background: 'var(--bg-surface)',\n          border: '1px solid var(--border-subtle)', marginTop: 20,\n        }}>\n          <div style={{ fontSize: 10, color: 'var(--text-muted)', lineHeight: 1.7 }}>\n            <strong>Disclaimer:</strong> This report is generated by the Fortuna Financial Engine for informational and planning purposes only.\n            It does not constitute tax, legal, or financial advice. Tax calculations are based on 2024 federal brackets, standard deduction amounts,\n            and simplified state tax rates. Actual tax liability may vary based on additional factors not captured in this analysis.\n            Audit risk scores are estimates based on publicly available IRS statistics and known DIF scoring factors.\n            Consult a qualified CPA or tax professional before making any tax planning decisions. Generated {reportDate}.\n          </div>\n        </div>\n      </div>\n\n      {/* ── Print Styles ── */}\n      <style>{`\n        @media print {\n          .no-print { display: none !important; }\n          .sidebar, aside, .app-bg, .app-grain { display: none !important; }\n          .main-content { margin-left: 0 !important; padding: 0 !important; }\n          body { background: white !important; color: #1a1a1a !important; }\n          .report-section, .card { break-inside: avoid; }\n          #fortuna-report { max-width: 100% !important; }\n          #fortuna-report * {\n            color-adjust: exact !important;\n            -webkit-print-color-adjust: exact !important;\n            print-color-adjust: exact !important;\n          }\n        }\n      `}</style>\n    </div>\n  )\n}\n\n// ─── Sub-Components ──────────────────────────────────────────────\n\nfunction ReportCard({ title, icon, children }: { title: string; icon: React.ReactNode; children: React.ReactNode }) {\n  return (\n    <div className=\"report-section\" style={{\n      marginBottom: 20, borderRadius: 14, background: 'var(--bg-elevated)',\n      border: '1px solid var(--border-subtle)', overflow: 'hidden',\n    }}>\n      <div style={{\n        padding: '14px 20px', borderBottom: '1px solid var(--border-subtle)',\n        display: 'flex', alignItems: 'center', gap: 10,\n      }}>\n        <span style={{ color: 'var(--accent-gold)' }}>{icon}</span>\n        <span style={{ fontSize: 14, fontWeight: 600, color: 'var(--text-primary)', fontFamily: 'var(--font-display)' }}>{title}</span>\n      </div>\n      <div style={{ padding: '18px 20px' }}>{children}</div>\n    </div>\n  )\n}\n\nfunction MetricBox({ label, value, sub, color }: { label: string; value: string; sub?: string; color: string }) {\n  return (\n    <div style={{\n      padding: 14, borderRadius: 10, background: 'var(--bg-surface)',\n      border: `1px solid ${color}22`, textAlign: 'center',\n    }}>\n      <div style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 6 }}>{label}</div>\n      <div style={{ fontFamily: 'var(--font-mono)', fontSize: 18, fontWeight: 700, color }}>{value}</div>\n      {sub && <div style={{ fontFamily: 'var(--font-mono)', fontSize: 11, color: `${color}aa`, marginTop: 2 }}>{sub}</div>}\n    </div>\n  )\n}\n\nfunction MiniStat({ label, value }: { label: string; value: string }) {\n  return (\n    <div style={{ padding: '8px 12px', background: 'var(--bg-surface)', borderRadius: 8 }}>\n      <div style={{ fontSize: 10, color: 'var(--text-muted)', marginBottom: 3 }}>{label}</div>\n      <div style={{ fontFamily: 'var(--font-mono)', fontSize: 13, fontWeight: 600, color: 'var(--text-primary)' }}>{value}</div>\n    </div>\n  )\n}\n\nfunction MiniGauge({ label, value, color }: { label: string; value: number; color: string }) {\n  return (\n    <div style={{ textAlign: 'center', padding: 10, background: 'var(--bg-surface)', borderRadius: 10 }}>\n      <div style={{\n        width: 44, height: 44, borderRadius: '50%', margin: '0 auto 6px',\n        border: `3px solid ${color}`, display: 'flex', alignItems: 'center', justifyContent: 'center',\n      }}>\n        <span style={{ fontFamily: 'var(--font-mono)', fontSize: 13, fontWeight: 700, color }}>{value}</span>\n      </div>\n      <div style={{ fontSize: 9, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.06em' }}>{label}</div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\RetirementOptimizer.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Shield' is defined but never used.","line":10,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":44,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Shield"},"fix":{"range":[281,289],"text":""},"desc":"Remove unused variable \"Shield\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AlertTriangle' is defined but never used.","line":11,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":16,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AlertTriangle"},"fix":{"range":[311,328],"text":""},"desc":"Remove unused variable \"AlertTriangle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Info' is defined but never used.","line":11,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":22,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Info"},"fix":{"range":[328,334],"text":""},"desc":"Remove unused variable \"Info\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'i' is defined but never used.","line":454,"column":92,"nodeType":"Identifier","messageId":"unusedVar","endLine":454,"endColumn":93},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'arr' is defined but never used.","line":454,"column":95,"nodeType":"Identifier","messageId":"unusedVar","endLine":454,"endColumn":98}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport {\n  compareRetirementVehicles,\n  analyzeRothLadder,\n  projectRetirement,\n  type RetirementVehicle,\n} from '../engine/retirement-optimizer'\nimport {\n  PiggyBank, TrendingUp, ArrowRight, Shield, CheckCircle, XCircle,\n  AlertTriangle, Info, ChevronDown,\n} from 'lucide-react'\n\ntype Tab = 'vehicles' | 'roth' | 'projection'\n\nexport function RetirementOptimizer() {\n  const { state, updateState } = useFortuna()\n  const [activeTab, setActiveTab] = useState<Tab>('vehicles')\n  const [expandedVehicle, setExpandedVehicle] = useState<string | null>(null)\n\n  // Initialize from persisted retirementAccounts if available\n  const accounts = state.retirementAccounts || []\n  const totalBalance = accounts.reduce((s, a) => s + (a.balance || 0), 0)\n  const totalContrib = accounts.reduce((s, a) => s + (a.annualContribution || 0), 0)\n  const tradAccounts = accounts.filter(a => ['traditional_401k', 'traditional_ira', 'solo_401k', 'sep_ira', 'simple_ira'].includes(a.type))\n  const tradBal = tradAccounts.reduce((s, a) => s + (a.balance || 0), 0)\n\n  const [currentBalance, _setCurrentBalance] = useState(totalBalance > 0 ? totalBalance : 50000)\n  const [annualContribution, _setAnnualContribution] = useState(totalContrib > 0 ? totalContrib : 23500)\n  const [tradBalance, setTradBalance] = useState(tradBal > 0 ? tradBal : 100000)\n  const [retirementAge, setRetirementAge] = useState(65)\n  const [returnRate, setReturnRate] = useState(7)\n\n  // Persist balance/contribution changes back to state\n  const setCurrentBalance = (v: number) => {\n    _setCurrentBalance(v)\n    if (accounts.length > 0) {\n      // Scale balances proportionally\n      const ratio = totalBalance > 0 ? v / totalBalance : 1\n      updateState(s => ({\n        ...s,\n        retirementAccounts: (s.retirementAccounts || []).map(a => ({ ...a, balance: Math.round(a.balance * ratio) })),\n      }))\n    }\n  }\n  const setAnnualContribution = (v: number) => {\n    _setAnnualContribution(v)\n    if (accounts.length > 0) {\n      const ratio = totalContrib > 0 ? v / totalContrib : 1\n      updateState(s => ({\n        ...s,\n        retirementAccounts: (s.retirementAccounts || []).map(a => ({ ...a, annualContribution: Math.round(a.annualContribution * ratio) })),\n      }))\n    }\n  }\n\n  const comparison = useMemo(() => compareRetirementVehicles(state), [state])\n  const rothLadder = useMemo(() => analyzeRothLadder(state, tradBalance, retirementAge), [state, tradBalance, retirementAge])\n  const projection = useMemo(() => projectRetirement(state, currentBalance, annualContribution, returnRate / 100, retirementAge), [state, currentBalance, annualContribution, returnRate, retirementAge])\n\n  const card: React.CSSProperties = { background: 'var(--bg-elevated)', border: '1px solid var(--border-subtle)', borderRadius: 14, padding: 24 }\n  const tabBtn = (active: boolean): React.CSSProperties => ({\n    padding: '8px 16px', borderRadius: 8, border: 'none',\n    background: active ? 'var(--accent-gold-dim)' : 'transparent',\n    color: active ? 'var(--accent-gold)' : 'var(--text-muted)',\n    cursor: 'pointer', fontFamily: 'var(--font-body)', fontSize: 13,\n    fontWeight: active ? 600 : 400, display: 'flex', alignItems: 'center', gap: 6,\n  })\n  const inputStyle: React.CSSProperties = {\n    padding: '8px 12px', borderRadius: 8, border: '1px solid var(--border-medium)',\n    background: 'var(--bg-surface)', color: 'var(--text-primary)',\n    fontFamily: 'var(--font-mono)', fontSize: 13, width: 120,\n  }\n\n  return (\n    <div style={{ padding: '32px 40px', maxWidth: 1000 }}>\n      <div style={{ marginBottom: 24 }}>\n        <h1 style={{ fontFamily: 'var(--font-display)', fontSize: 26, color: 'var(--text-primary)', marginBottom: 6 }}>\n          Retirement Optimizer\n        </h1>\n        <p style={{ fontSize: 13, color: 'var(--text-muted)', lineHeight: 1.5 }}>\n          Compare vehicles, model Roth conversions, and project retirement income — all personalized to your financial profile.\n        </p>\n      </div>\n\n      {/* Summary strip */}\n      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 12, marginBottom: 24 }}>\n        {[\n          { label: 'Max Contribution', value: `$${comparison.totalMaxContribution.toLocaleString()}`, sub: 'across all vehicles', color: 'var(--accent-gold)' },\n          { label: 'Tax Deduction', value: `$${comparison.totalTaxDeduction.toLocaleString()}`, sub: 'this year', color: 'var(--accent-emerald)' },\n          { label: 'Projected Balance', value: `$${(projection.retirementBalance / 1000).toFixed(0)}K`, sub: `at age ${retirementAge}`, color: 'var(--accent-blue)' },\n          { label: 'Monthly Income', value: `$${projection.totalWithSS.toLocaleString()}`, sub: 'w/ Social Security', color: 'var(--accent-purple)' },\n        ].map((m, i) => (\n          <div key={i} style={{\n            background: 'var(--bg-elevated)', border: '1px solid var(--border-subtle)',\n            borderRadius: 12, padding: 16, textAlign: 'center',\n          }}>\n            <div style={{ fontSize: 11, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 4 }}>{m.label}</div>\n            <div style={{ fontFamily: 'var(--font-mono)', fontSize: 20, fontWeight: 600, color: m.color }}>{m.value}</div>\n            <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 2 }}>{m.sub}</div>\n          </div>\n        ))}\n      </div>\n\n      {/* Tabs */}\n      <div style={{ display: 'flex', gap: 4, marginBottom: 24 }}>\n        <button style={tabBtn(activeTab === 'vehicles')} onClick={() => setActiveTab('vehicles')}>\n          <PiggyBank size={14} /> Vehicle Comparison\n        </button>\n        <button style={tabBtn(activeTab === 'roth')} onClick={() => setActiveTab('roth')}>\n          <ArrowRight size={14} /> Roth Conversion Ladder\n        </button>\n        <button style={tabBtn(activeTab === 'projection')} onClick={() => setActiveTab('projection')}>\n          <TrendingUp size={14} /> Retirement Projection\n        </button>\n      </div>\n\n      {/* ═══ VEHICLES TAB ═══ */}\n      {activeTab === 'vehicles' && (\n        <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>\n          {comparison.recommendedStrategy && (\n            <div style={{\n              padding: '12px 16px', borderRadius: 10,\n              background: 'var(--accent-gold)10', border: '1px solid var(--accent-gold)22',\n              fontSize: 12, color: 'var(--accent-gold)', lineHeight: 1.6,\n            }}>\n              <strong>Recommended:</strong> {comparison.recommendedStrategy}\n            </div>\n          )}\n\n          {comparison.vehicles.map(vehicle => (\n            <VehicleCard\n              key={vehicle.type}\n              vehicle={vehicle}\n              expanded={expandedVehicle === vehicle.type}\n              onToggle={() => setExpandedVehicle(expandedVehicle === vehicle.type ? null : vehicle.type)}\n            />\n          ))}\n        </div>\n      )}\n\n      {/* ═══ ROTH LADDER TAB ═══ */}\n      {activeTab === 'roth' && (\n        <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>\n          <div style={{ ...card, display: 'flex', gap: 24, alignItems: 'center', flexWrap: 'wrap' }}>\n            <div>\n              <label style={{ fontSize: 11, color: 'var(--text-muted)', display: 'block', marginBottom: 4 }}>Traditional IRA Balance</label>\n              <input type=\"number\" value={tradBalance} onChange={e => setTradBalance(Number(e.target.value))} style={inputStyle} />\n            </div>\n            <div>\n              <label style={{ fontSize: 11, color: 'var(--text-muted)', display: 'block', marginBottom: 4 }}>Target Retirement Age</label>\n              <input type=\"number\" value={retirementAge} onChange={e => setRetirementAge(Number(e.target.value))} style={inputStyle} />\n            </div>\n          </div>\n\n          <div style={{ padding: '12px 16px', borderRadius: 10, background: 'var(--accent-blue-dim)', border: '1px solid var(--accent-blue)22', fontSize: 12, color: 'var(--accent-blue)', lineHeight: 1.6 }}>\n            {rothLadder.strategy}\n          </div>\n\n          {/* Savings highlight */}\n          {rothLadder.taxSavingsVsLumpSum > 0 && (\n            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 12 }}>\n              {[\n                { label: 'Ladder Tax', value: `$${rothLadder.totalTaxPaid.toLocaleString()}`, color: 'var(--accent-emerald)' },\n                { label: 'Lump Sum Tax', value: `$${(rothLadder.totalConverted * 0.32).toLocaleString()}`, color: 'var(--accent-red)' },\n                { label: 'You Save', value: `$${rothLadder.taxSavingsVsLumpSum.toLocaleString()}`, color: 'var(--accent-gold)' },\n              ].map((m, i) => (\n                <div key={i} style={{ ...card, textAlign: 'center' }}>\n                  <div style={{ fontSize: 11, color: 'var(--text-muted)', marginBottom: 4 }}>{m.label}</div>\n                  <div style={{ fontFamily: 'var(--font-mono)', fontSize: 18, fontWeight: 600, color: m.color }}>{m.value}</div>\n                </div>\n              ))}\n            </div>\n          )}\n\n          {/* Year-by-year table */}\n          {rothLadder.years.length > 0 && (\n            <div style={card}>\n              <div style={{ fontSize: 14, fontWeight: 500, color: 'var(--text-primary)', marginBottom: 16 }}>Conversion Schedule</div>\n              <div style={{ overflowX: 'auto' }}>\n                <table style={{ width: '100%', borderCollapse: 'collapse', fontFamily: 'var(--font-mono)', fontSize: 12 }}>\n                  <thead>\n                    <tr style={{ borderBottom: '1px solid var(--border-subtle)' }}>\n                      {['Year', 'Age', 'Convert', 'Tax', 'Rate', 'Cumulative', 'Withdrawable'].map(h => (\n                        <th key={h} style={{ padding: '8px 12px', textAlign: 'right', color: 'var(--text-muted)', fontWeight: 500, fontSize: 11 }}>{h}</th>\n                      ))}\n                    </tr>\n                  </thead>\n                  <tbody>\n                    {rothLadder.years.map(yr => (\n                      <tr key={yr.year} style={{ borderBottom: '1px solid var(--border-subtle)' }}>\n                        <td style={{ padding: '8px 12px', textAlign: 'right', color: 'var(--text-secondary)' }}>{yr.year}</td>\n                        <td style={{ padding: '8px 12px', textAlign: 'right', color: 'var(--text-muted)' }}>{yr.age}</td>\n                        <td style={{ padding: '8px 12px', textAlign: 'right', color: 'var(--text-primary)', fontWeight: 500 }}>${yr.convertAmount.toLocaleString()}</td>\n                        <td style={{ padding: '8px 12px', textAlign: 'right', color: 'var(--accent-red)' }}>${yr.taxOnConversion.toLocaleString()}</td>\n                        <td style={{ padding: '8px 12px', textAlign: 'right', color: 'var(--text-muted)' }}>{(yr.marginalRate * 100).toFixed(0)}%</td>\n                        <td style={{ padding: '8px 12px', textAlign: 'right', color: 'var(--accent-gold)' }}>${yr.cumulativeConverted.toLocaleString()}</td>\n                        <td style={{ padding: '8px 12px', textAlign: 'right', color: 'var(--accent-emerald)' }}>{yr.withdrawableYear}</td>\n                      </tr>\n                    ))}\n                  </tbody>\n                </table>\n              </div>\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* ═══ PROJECTION TAB ═══ */}\n      {activeTab === 'projection' && (\n        <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>\n          {/* Inputs */}\n          <div style={{ ...card, display: 'flex', gap: 20, alignItems: 'flex-end', flexWrap: 'wrap' }}>\n            {[\n              { label: 'Current Balance', value: currentBalance, set: setCurrentBalance },\n              { label: 'Annual Contribution', value: annualContribution, set: setAnnualContribution },\n              { label: 'Return Rate %', value: returnRate, set: setReturnRate },\n              { label: 'Retirement Age', value: retirementAge, set: setRetirementAge },\n            ].map(inp => (\n              <div key={inp.label}>\n                <label style={{ fontSize: 11, color: 'var(--text-muted)', display: 'block', marginBottom: 4 }}>{inp.label}</label>\n                <input type=\"number\" value={inp.value} onChange={e => inp.set(Number(e.target.value))} style={inputStyle} />\n              </div>\n            ))}\n          </div>\n\n          {/* Recommendation */}\n          <div style={{\n            padding: '12px 16px', borderRadius: 10,\n            background: projection.shortfall > 0 ? 'var(--accent-red-dim)' : 'var(--accent-emerald-dim)',\n            border: `1px solid ${projection.shortfall > 0 ? 'var(--accent-red)' : 'var(--accent-emerald)'}22`,\n            fontSize: 12, color: projection.shortfall > 0 ? 'var(--accent-red)' : 'var(--accent-emerald)',\n            lineHeight: 1.6,\n          }}>\n            {projection.recommendation}\n          </div>\n\n          {/* Key metrics */}\n          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 12 }}>\n            {[\n              { label: 'Balance at Retirement', value: `$${(projection.retirementBalance / 1000).toFixed(0)}K`, color: 'var(--accent-gold)' },\n              { label: '4% Withdrawal/Year', value: `$${projection.sustainableWithdrawal.toLocaleString()}`, color: 'var(--accent-blue)' },\n              { label: 'Est. SS Monthly', value: `$${projection.socialSecurityEstimate.toLocaleString()}`, color: 'var(--accent-purple)' },\n            ].map((m, i) => (\n              <div key={i} style={{ ...card, textAlign: 'center' }}>\n                <div style={{ fontSize: 11, color: 'var(--text-muted)', marginBottom: 4 }}>{m.label}</div>\n                <div style={{ fontFamily: 'var(--font-mono)', fontSize: 20, fontWeight: 600, color: m.color }}>{m.value}</div>\n              </div>\n            ))}\n          </div>\n\n          {/* Growth chart (SVG bar chart) */}\n          <div style={card}>\n            <div style={{ fontSize: 14, fontWeight: 500, color: 'var(--text-primary)', marginBottom: 16 }}>Balance Over Time</div>\n            <GrowthChart years={projection.years} retirementAge={retirementAge} />\n          </div>\n\n          {/* Year-by-year (condensed, every 5 years) */}\n          <div style={card}>\n            <div style={{ fontSize: 14, fontWeight: 500, color: 'var(--text-primary)', marginBottom: 16 }}>Milestone Years</div>\n            <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>\n              {projection.years.filter((_, i) => i % 5 === 0 || projection.years[i]?.age === retirementAge).map(yr => (\n                <div key={yr.year} style={{\n                  display: 'flex', justifyContent: 'space-between', padding: '8px 12px',\n                  borderRadius: 8, background: yr.age === retirementAge ? 'var(--accent-gold-dim)' : 'var(--bg-primary)',\n                }}>\n                  <span style={{ fontSize: 13, color: yr.age === retirementAge ? 'var(--accent-gold)' : 'var(--text-secondary)' }}>\n                    Age {yr.age} ({yr.year})\n                  </span>\n                  <span style={{ fontFamily: 'var(--font-mono)', fontSize: 13, fontWeight: 500, color: 'var(--text-primary)' }}>\n                    ${(yr.balance / 1000).toFixed(0)}K\n                  </span>\n                </div>\n              ))}\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  )\n}\n\n// ===================================================================\n//  VEHICLE CARD\n// ===================================================================\n\nfunction VehicleCard({ vehicle, expanded, onToggle }: {\n  vehicle: RetirementVehicle; expanded: boolean; onToggle: () => void\n}) {\n  const eligColor = vehicle.eligibility === 'eligible' ? 'var(--accent-emerald)' : vehicle.eligibility === 'income_limited' ? 'var(--accent-gold)' : 'var(--accent-red)'\n\n  return (\n    <div style={{\n      background: 'var(--bg-elevated)', border: '1px solid var(--border-subtle)',\n      borderRadius: 14, overflow: 'hidden',\n    }}>\n      <button onClick={onToggle} style={{\n        display: 'flex', justifyContent: 'space-between', alignItems: 'center',\n        width: '100%', padding: 20, background: 'none', border: 'none',\n        cursor: 'pointer', fontFamily: 'var(--font-body)', textAlign: 'left',\n      }}>\n        <div style={{ display: 'flex', alignItems: 'center', gap: 14 }}>\n          <div style={{\n            width: 6, height: 40, borderRadius: 3,\n            background: vehicle.priority >= 7 ? 'var(--accent-gold)' : vehicle.priority >= 5 ? 'var(--accent-blue)' : 'var(--border-subtle)',\n          }} />\n          <div>\n            <div style={{ fontSize: 15, fontWeight: 500, color: 'var(--text-primary)' }}>{vehicle.name}</div>\n            <div style={{ fontSize: 12, color: 'var(--text-muted)', marginTop: 2 }}>\n              Max: <span style={{ fontFamily: 'var(--font-mono)', color: 'var(--accent-gold)' }}>${vehicle.maxContribution.toLocaleString()}</span>\n              {vehicle.taxDeductionNow > 0 && <> · Deduction: <span style={{ fontFamily: 'var(--font-mono)', color: 'var(--accent-emerald)' }}>${vehicle.taxDeductionNow.toLocaleString()}</span></>}\n            </div>\n          </div>\n        </div>\n        <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>\n          <span style={{ padding: '4px 10px', borderRadius: 6, background: eligColor + '18', color: eligColor, fontSize: 11, fontWeight: 600 }}>\n            {vehicle.eligibility === 'eligible' ? 'Eligible' : vehicle.eligibility === 'income_limited' ? 'Limited' : 'Ineligible'}\n          </span>\n          <ChevronDown size={14} color=\"var(--text-muted)\" style={{ transition: 'transform 0.2s', transform: expanded ? 'rotate(180deg)' : 'rotate(0)' }} />\n        </div>\n      </button>\n\n      {expanded && (\n        <div style={{ padding: '0 20px 20px', borderTop: '1px solid var(--border-subtle)' }}>\n          <div style={{ fontSize: 12, color: 'var(--text-secondary)', marginTop: 12, marginBottom: 16, lineHeight: 1.5 }}>\n            {vehicle.eligibilityNote}\n          </div>\n\n          {/* Tax features */}\n          <div style={{ display: 'flex', gap: 12, marginBottom: 16 }}>\n            {[\n              { label: 'Deduction Now', active: vehicle.taxDeductionNow > 0 },\n              { label: 'Tax-Free Growth', active: vehicle.taxFreeGrowth },\n              { label: 'Tax-Free Withdrawal', active: vehicle.taxFreeWithdrawal },\n            ].map(f => (\n              <div key={f.label} style={{\n                display: 'flex', alignItems: 'center', gap: 4, padding: '4px 10px',\n                borderRadius: 6, background: 'var(--bg-primary)', fontSize: 11,\n                color: f.active ? 'var(--accent-emerald)' : 'var(--text-muted)',\n              }}>\n                {f.active ? <CheckCircle size={12} /> : <XCircle size={12} />}\n                {f.label}\n              </div>\n            ))}\n          </div>\n\n          {/* Contribution breakdown */}\n          {vehicle.employeeContribution > 0 && vehicle.employerContribution > 0 && (\n            <div style={{ display: 'flex', gap: 12, marginBottom: 16 }}>\n              <div style={{ padding: '8px 12px', borderRadius: 8, background: 'var(--bg-primary)', flex: 1 }}>\n                <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>Employee</div>\n                <div style={{ fontFamily: 'var(--font-mono)', fontSize: 14, fontWeight: 500, color: 'var(--text-primary)' }}>${vehicle.employeeContribution.toLocaleString()}</div>\n              </div>\n              <div style={{ padding: '8px 12px', borderRadius: 8, background: 'var(--bg-primary)', flex: 1 }}>\n                <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>Employer</div>\n                <div style={{ fontFamily: 'var(--font-mono)', fontSize: 14, fontWeight: 500, color: 'var(--text-primary)' }}>${vehicle.employerContribution.toLocaleString()}</div>\n              </div>\n            </div>\n          )}\n\n          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>\n            <div>\n              <div style={{ fontSize: 11, color: 'var(--accent-emerald)', fontWeight: 600, marginBottom: 6 }}>Pros</div>\n              {vehicle.pros.map((p, i) => (\n                <div key={i} style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.5, marginBottom: 2 }}>✓ {p}</div>\n              ))}\n            </div>\n            <div>\n              <div style={{ fontSize: 11, color: 'var(--accent-red)', fontWeight: 600, marginBottom: 6 }}>Cons</div>\n              {vehicle.cons.map((c, i) => (\n                <div key={i} style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.5, marginBottom: 2 }}>✗ {c}</div>\n              ))}\n            </div>\n          </div>\n          <div style={{ fontSize: 11, color: 'var(--accent-gold)', marginTop: 12 }}>Best for: {vehicle.bestFor}</div>\n        </div>\n      )}\n    </div>\n  )\n}\n\n// ===================================================================\n//  GROWTH CHART SVG\n// ===================================================================\n\nfunction GrowthChart({ years, retirementAge }: { years: { age: number; balance: number }[]; retirementAge: number }) {\n  if (years.length < 2) return null\n  const W = 700, H = 200, P = 40\n  const maxBal = Math.max(...years.map(y => y.balance), 1)\n  const retIdx = years.findIndex(y => y.age === retirementAge)\n\n  return (\n    <svg viewBox={`0 0 ${W + P * 2} ${H + P * 2}`} style={{ width: '100%', height: 'auto' }}>\n      {/* Grid lines */}\n      {[0, 0.25, 0.5, 0.75, 1].map(pct => {\n        const y = P + H - pct * H\n        return (\n          <g key={pct}>\n            <line x1={P} y1={y} x2={P + W} y2={y} stroke=\"var(--border-subtle)\" strokeWidth=\"1\" />\n            <text x={P - 8} y={y + 4} textAnchor=\"end\" fill=\"var(--text-muted)\" fontSize=\"10\" fontFamily=\"var(--font-mono)\">\n              ${(maxBal * pct / 1000).toFixed(0)}K\n            </text>\n          </g>\n        )\n      })}\n\n      {/* Retirement line */}\n      {retIdx > 0 && (\n        <>\n          <line\n            x1={P + (retIdx / (years.length - 1)) * W}\n            y1={P}\n            x2={P + (retIdx / (years.length - 1)) * W}\n            y2={P + H}\n            stroke=\"var(--accent-gold)\"\n            strokeWidth=\"1\"\n            strokeDasharray=\"4,4\"\n          />\n          <text\n            x={P + (retIdx / (years.length - 1)) * W}\n            y={P - 6}\n            textAnchor=\"middle\"\n            fill=\"var(--accent-gold)\"\n            fontSize=\"10\"\n            fontFamily=\"var(--font-mono)\"\n          >\n            Retire\n          </text>\n        </>\n      )}\n\n      {/* Area fill */}\n      <defs>\n        <linearGradient id=\"balGrad\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n          <stop offset=\"0%\" stopColor=\"var(--accent-gold)\" stopOpacity=\"0.2\" />\n          <stop offset=\"100%\" stopColor=\"var(--accent-gold)\" stopOpacity=\"0\" />\n        </linearGradient>\n      </defs>\n      <path\n        d={`M${P},${P + H} ${years.map((y, i) => `L${P + (i / (years.length - 1)) * W},${P + H - (y.balance / maxBal) * H}`).join(' ')} L${P + W},${P + H} Z`}\n        fill=\"url(#balGrad)\"\n      />\n\n      {/* Line */}\n      <path\n        d={years.map((y, i) => `${i === 0 ? 'M' : 'L'}${P + (i / (years.length - 1)) * W},${P + H - (y.balance / maxBal) * H}`).join(' ')}\n        fill=\"none\"\n        stroke=\"var(--accent-gold)\"\n        strokeWidth=\"2\"\n        strokeLinecap=\"round\"\n      />\n\n      {/* Age labels */}\n      {years.filter((_, i) => i % Math.max(1, Math.floor(years.length / 8)) === 0).map((y, i, arr) => (\n        <text\n          key={y.age}\n          x={P + (years.indexOf(y) / (years.length - 1)) * W}\n          y={P + H + 16}\n          textAnchor=\"middle\"\n          fill=\"var(--text-muted)\"\n          fontSize=\"10\"\n          fontFamily=\"var(--font-mono)\"\n        >\n          {y.age}\n        </text>\n      ))}\n    </svg>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\RevenueEngine.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DollarSign' is defined but never used.","line":4,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":25,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DollarSign"},"fix":{"range":[102,114],"text":""},"desc":"Remove unused variable \"DollarSign\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ArrowUpRight' is defined but never used.","line":4,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":39,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ArrowUpRight"},"fix":{"range":[114,128],"text":""},"desc":"Remove unused variable \"ArrowUpRight\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'BarChart3' is defined but never used.","line":4,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":50,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"BarChart3"},"fix":{"range":[128,139],"text":""},"desc":"Remove unused variable \"BarChart3\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Target' is defined but never used.","line":4,"column":52,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":58,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Target"},"fix":{"range":[139,147],"text":""},"desc":"Remove unused variable \"Target\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Plus' is defined but never used.","line":5,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":32,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Plus"},"fix":{"range":[174,180],"text":""},"desc":"Remove unused variable \"Plus\"."}]},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Math.random` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\RevenueEngine.tsx:51:44\n  49 |     return months.map((name, i) => ({\n  50 |       name,\n> 51 |       current: Math.round(monthly * (0.9 + Math.random() * 0.2)),\n     |                                            ^^^^^^^^^^^^^ Cannot call impure function\n  52 |       optimistic: Math.round(monthly * (1.05 + i * 0.02) * (0.95 + Math.random() * 0.1)),\n  53 |       aggressive: Math.round(monthly * (1.10 + i * 0.04) * (0.93 + Math.random() * 0.14)),\n  54 |     }))","line":51,"column":44,"nodeType":null,"endLine":51,"endColumn":57},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Math.random` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\RevenueEngine.tsx:52:68\n  50 |       name,\n  51 |       current: Math.round(monthly * (0.9 + Math.random() * 0.2)),\n> 52 |       optimistic: Math.round(monthly * (1.05 + i * 0.02) * (0.95 + Math.random() * 0.1)),\n     |                                                                    ^^^^^^^^^^^^^ Cannot call impure function\n  53 |       aggressive: Math.round(monthly * (1.10 + i * 0.04) * (0.93 + Math.random() * 0.14)),\n  54 |     }))\n  55 |   }, [totalRevenue])","line":52,"column":68,"nodeType":null,"endLine":52,"endColumn":81},{"ruleId":"react-hooks/purity","severity":2,"message":"Error: Cannot call impure function during render\n\n`Math.random` is an impure function. Calling an impure function can produce unstable results that update unpredictably when the component happens to re-render. (https://react.dev/reference/rules/components-and-hooks-must-be-pure#components-and-hooks-must-be-idempotent).\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\RevenueEngine.tsx:53:68\n  51 |       current: Math.round(monthly * (0.9 + Math.random() * 0.2)),\n  52 |       optimistic: Math.round(monthly * (1.05 + i * 0.02) * (0.95 + Math.random() * 0.1)),\n> 53 |       aggressive: Math.round(monthly * (1.10 + i * 0.04) * (0.93 + Math.random() * 0.14)),\n     |                                                                    ^^^^^^^^^^^^^ Cannot call impure function\n  54 |     }))\n  55 |   }, [totalRevenue])\n  56 |","line":53,"column":68,"nodeType":null,"endLine":53,"endColumn":81},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'midOpportunity' is assigned a value but never used.","line":68,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":68,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'midValue' is assigned a value but never used.","line":199,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":199,"endColumn":25}],"suppressedMessages":[],"errorCount":10,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport {\n  TrendingUp, DollarSign, ArrowUpRight, BarChart3, Target,\n  Sparkles, AlertTriangle, Plus\n} from 'lucide-react'\nimport {\n  PieChart, Pie, Cell, ResponsiveContainer, Tooltip,\n  AreaChart, Area, XAxis, YAxis, CartesianGrid\n} from 'recharts'\n\nconst STREAM_COLORS = ['#d4a843', '#60a5fa', '#a78bfa', '#34d399', '#f87171', '#fbbf24', '#c084fc']\n\nconst GROWTH_OPPORTUNITIES: {\n  name: string\n  type: string\n  potentialRange: [number, number]\n  effort: 'low' | 'medium' | 'high'\n  timeToRevenue: string\n  description: string\n  matchesSkills: string[]\n}[] = [\n  { name: 'AI Consulting', type: 'business', potentialRange: [40000, 120000], effort: 'medium', timeToRevenue: '1-2 months', description: 'Offer AI strategy, implementation, and automation consulting to businesses. High demand, premium rates.', matchesSkills: ['tech', 'ai', 'automation', 'development'] },\n  { name: 'SaaS Product Revenue', type: 'business', potentialRange: [24000, 240000], effort: 'high', timeToRevenue: '3-6 months', description: 'Productize your tools into recurring SaaS offerings. High effort but highest long-term value.', matchesSkills: ['development', 'product', 'saas'] },\n  { name: 'Digital Products / Templates', type: 'passive', potentialRange: [6000, 48000], effort: 'low', timeToRevenue: '2-4 weeks', description: 'Create and sell templates, guides, or digital tools on platforms like Gumroad or your own site.', matchesSkills: ['design', 'writing', 'development'] },\n  { name: 'Affiliate / Referral Income', type: 'passive', potentialRange: [2400, 24000], effort: 'low', timeToRevenue: '1-3 months', description: 'Earn commissions by recommending tools and services you already use. Low effort, compounds over time.', matchesSkills: ['content', 'audience'] },\n  { name: 'Training / Workshops', type: 'business', potentialRange: [12000, 72000], effort: 'medium', timeToRevenue: '1-2 months', description: 'Teach skills through paid workshops, cohorts, or online courses. Leverages existing expertise.', matchesSkills: ['teaching', 'expertise'] },\n  { name: 'Content Monetization', type: 'passive', potentialRange: [6000, 36000], effort: 'medium', timeToRevenue: '3-6 months', description: 'Monetize content through YouTube, newsletters, or membership communities.', matchesSkills: ['writing', 'video', 'audience'] },\n]\n\nexport function RevenueEngine() {\n  const { state, taxReport, strategies } = useFortuna()\n  const activeStreams = state.incomeStreams.filter(s => s.isActive && s.annualAmount > 0)\n  const totalRevenue = activeStreams.reduce((s, r) => s + r.annualAmount, 0)\n  const hasData = activeStreams.length > 0\n\n  // Revenue diversification\n  const diversificationScore = useMemo(() => {\n    if (activeStreams.length === 0) return 0\n    if (activeStreams.length === 1) return 15\n    const maxConcentration = Math.max(...activeStreams.map(s => s.annualAmount)) / totalRevenue\n    return Math.round((1 - maxConcentration) * 100)\n  }, [activeStreams, totalRevenue])\n\n  // Revenue growth projection (12 months)\n  const projectionData = useMemo(() => {\n    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']\n    const monthly = totalRevenue / 12\n    return months.map((name, i) => ({\n      name,\n      current: Math.round(monthly * (0.9 + Math.random() * 0.2)),\n      optimistic: Math.round(monthly * (1.05 + i * 0.02) * (0.95 + Math.random() * 0.1)),\n      aggressive: Math.round(monthly * (1.10 + i * 0.04) * (0.93 + Math.random() * 0.14)),\n    }))\n  }, [totalRevenue])\n\n  // Pie data for stream breakdown\n  const pieData = activeStreams.map((s, i) => ({\n    name: s.name || s.type,\n    value: s.annualAmount,\n    color: STREAM_COLORS[i % STREAM_COLORS.length],\n  }))\n\n  // Revenue strategies from engine\n  const revenueStrategies = strategies.filter(s => s.category === 'revenue')\n\n  // Growth opportunity total\n  const midOpportunity = GROWTH_OPPORTUNITIES.reduce((s, o) => s + (o.potentialRange[0] + o.potentialRange[1]) / 2, 0)\n\n  if (!hasData) {\n    return (\n      <div className=\"view-enter\" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '50vh' }}>\n        <div style={{ textAlign: 'center', maxWidth: 400 }}>\n          <TrendingUp size={32} color=\"var(--accent-gold)\" style={{ marginBottom: 12 }} />\n          <h2 style={{ fontFamily: 'var(--font-display)', marginBottom: 8 }}>Revenue Engine</h2>\n          <p style={{ fontSize: 13, color: 'var(--text-muted)' }}>Add income streams in your profile to analyze revenue composition and growth opportunities.</p>\n        </div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"view-enter\">\n      <div style={{ marginBottom: 28 }}>\n        <h1 className=\"section-title\">Revenue Engine</h1>\n        <p className=\"section-subtitle\">Revenue intelligence, diversification analysis, and growth modeling</p>\n      </div>\n\n      {/* Metrics */}\n      <div className=\"grid-4 stagger\" style={{ marginBottom: 24 }}>\n        <div className=\"metric-card glow-gold\">\n          <span className=\"metric-label\">Total Revenue</span>\n          <div className=\"metric-value\">${totalRevenue.toLocaleString()}</div>\n          <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>${Math.round(totalRevenue / 12).toLocaleString()}/mo</span>\n        </div>\n        <div className=\"metric-card\">\n          <span className=\"metric-label\">Active Streams</span>\n          <div className=\"metric-value\" style={{ color: 'var(--accent-blue)' }}>{activeStreams.length}</div>\n          <span style={{ fontSize: 12, color: activeStreams.length < 3 ? 'var(--accent-amber)' : 'var(--accent-emerald)' }}>{activeStreams.length < 3 ? 'Below target (3+)' : 'Healthy diversification'}</span>\n        </div>\n        <div className=\"metric-card\">\n          <span className=\"metric-label\">Diversification</span>\n          <div className=\"metric-value\" style={{ color: diversificationScore > 40 ? 'var(--accent-emerald)' : 'var(--accent-red)' }}>{diversificationScore}%</div>\n          <div className=\"progress-bar\" style={{ marginTop: 8 }}>\n            <div className=\"progress-fill\" style={{ width: `${diversificationScore}%`, background: diversificationScore > 40 ? 'var(--accent-emerald)' : 'var(--accent-red)' }} />\n          </div>\n        </div>\n        <div className=\"metric-card\">\n          <span className=\"metric-label\">After-Tax Revenue</span>\n          <div className=\"metric-value\" style={{ color: 'var(--accent-emerald)' }}>${taxReport.afterTaxIncome.toLocaleString()}</div>\n          <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>{(100 - taxReport.effectiveRate * 100).toFixed(0)}% retention</span>\n        </div>\n      </div>\n\n      <div className=\"grid-2\" style={{ marginBottom: 24 }}>\n        {/* Stream Breakdown */}\n        <div className=\"card\">\n          <div className=\"card-header\">\n            <span className=\"card-title\">Revenue Composition</span>\n          </div>\n          <div className=\"card-body\" style={{ display: 'flex', alignItems: 'center', gap: 24 }}>\n            <ResponsiveContainer width={150} height={150}>\n              <PieChart>\n                <Pie data={pieData} cx=\"50%\" cy=\"50%\" innerRadius={42} outerRadius={65} paddingAngle={3} dataKey=\"value\" strokeWidth={0}>\n                  {pieData.map((entry, i) => <Cell key={i} fill={entry.color} />)}\n                </Pie>\n                <Tooltip contentStyle={{ background: '#181c24', border: '1px solid rgba(255,255,255,0.1)', borderRadius: 8, fontFamily: 'var(--font-mono)', fontSize: 12 }} formatter={(v: number) => [`$${v.toLocaleString()}`, '']} />\n              </PieChart>\n            </ResponsiveContainer>\n            <div style={{ flex: 1, display: 'flex', flexDirection: 'column', gap: 10 }}>\n              {activeStreams.map((stream, i) => {\n                const pct = Math.round((stream.annualAmount / totalRevenue) * 100)\n                return (\n                  <div key={stream.id}>\n                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 4 }}>\n                      <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n                        <div style={{ width: 8, height: 8, borderRadius: 2, background: STREAM_COLORS[i % STREAM_COLORS.length] }} />\n                        <span style={{ fontSize: 12, color: 'var(--text-secondary)' }}>{stream.name || stream.type}</span>\n                      </div>\n                      <div style={{ display: 'flex', gap: 8, alignItems: 'baseline' }}>\n                        <span style={{ fontFamily: 'var(--font-mono)', fontSize: 12, fontWeight: 500 }}>${(stream.annualAmount / 1000).toFixed(0)}k</span>\n                        <span style={{ fontFamily: 'var(--font-mono)', fontSize: 10, color: pct > 60 ? 'var(--accent-red)' : 'var(--text-muted)' }}>{pct}%</span>\n                      </div>\n                    </div>\n                    <div className=\"progress-bar\" style={{ height: 3 }}>\n                      <div className=\"progress-fill\" style={{ width: `${pct}%`, background: STREAM_COLORS[i % STREAM_COLORS.length] }} />\n                    </div>\n                  </div>\n                )\n              })}\n              {activeStreams.length === 1 && (\n                <div style={{ fontSize: 11, color: 'var(--accent-amber)', display: 'flex', gap: 6, alignItems: 'center', marginTop: 4 }}>\n                  <AlertTriangle size={12} /> 100% concentration — add more streams\n                </div>\n              )}\n            </div>\n          </div>\n        </div>\n\n        {/* Growth Projection */}\n        <div className=\"card\">\n          <div className=\"card-header\">\n            <span className=\"card-title\">12-Month Projection</span>\n          </div>\n          <div className=\"card-body\">\n            <ResponsiveContainer width=\"100%\" height={180}>\n              <AreaChart data={projectionData}>\n                <defs>\n                  <linearGradient id=\"gCurrent\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n                    <stop offset=\"0%\" stopColor=\"#d4a843\" stopOpacity={0.15} />\n                    <stop offset=\"100%\" stopColor=\"#d4a843\" stopOpacity={0} />\n                  </linearGradient>\n                  <linearGradient id=\"gOptimistic\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n                    <stop offset=\"0%\" stopColor=\"#34d399\" stopOpacity={0.15} />\n                    <stop offset=\"100%\" stopColor=\"#34d399\" stopOpacity={0} />\n                  </linearGradient>\n                </defs>\n                <CartesianGrid strokeDasharray=\"3 3\" stroke=\"rgba(255,255,255,0.04)\" />\n                <XAxis dataKey=\"name\" tick={{ fill: '#565c6a', fontSize: 10 }} axisLine={false} tickLine={false} />\n                <YAxis tickFormatter={v => `$${(v / 1000).toFixed(0)}k`} tick={{ fill: '#565c6a', fontSize: 10, fontFamily: 'var(--font-mono)' }} axisLine={false} tickLine={false} width={50} />\n                <Tooltip contentStyle={{ background: '#181c24', border: '1px solid rgba(255,255,255,0.1)', borderRadius: 8, fontFamily: 'var(--font-mono)', fontSize: 11 }} formatter={(v: number) => `$${v.toLocaleString()}`} />\n                <Area type=\"monotone\" dataKey=\"current\" stroke=\"#d4a843\" fill=\"url(#gCurrent)\" strokeWidth={2} name=\"Baseline\" />\n                <Area type=\"monotone\" dataKey=\"optimistic\" stroke=\"#34d399\" fill=\"url(#gOptimistic)\" strokeWidth={2} name=\"With Growth\" />\n                <Area type=\"monotone\" dataKey=\"aggressive\" stroke=\"#a78bfa\" fill=\"none\" strokeWidth={1} strokeDasharray=\"5 5\" name=\"Aggressive\" />\n              </AreaChart>\n            </ResponsiveContainer>\n          </div>\n        </div>\n      </div>\n\n      {/* Growth Opportunities */}\n      <div style={{ marginBottom: 12, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\n        <h2 style={{ fontFamily: 'var(--font-display)', fontSize: 20 }}>Growth Opportunities</h2>\n        <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>Sorted by effort-to-reward ratio</span>\n      </div>\n\n      <div className=\"grid-3\" style={{ marginBottom: 20 }}>\n        {GROWTH_OPPORTUNITIES.map((opp, i) => {\n          const midValue = (opp.potentialRange[0] + opp.potentialRange[1]) / 2\n          const effortColors = { low: 'var(--accent-emerald)', medium: 'var(--accent-gold)', high: 'var(--accent-red)' }\n          return (\n            <div key={i} className=\"card\">\n              <div style={{ padding: '20px 20px 16px' }}>\n                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 12 }}>\n                  <div>\n                    <div style={{ fontSize: 14, fontWeight: 500, marginBottom: 4 }}>{opp.name}</div>\n                    <span className=\"pill gold\" style={{ fontSize: 10 }}>{opp.type}</span>\n                  </div>\n                  <span style={{ fontFamily: 'var(--font-mono)', fontSize: 14, fontWeight: 600, color: 'var(--accent-emerald)' }}>\n                    ${(opp.potentialRange[0] / 1000).toFixed(0)}-{(opp.potentialRange[1] / 1000).toFixed(0)}k\n                  </span>\n                </div>\n                <p style={{ fontSize: 12, color: 'var(--text-muted)', lineHeight: 1.5, marginBottom: 14 }}>{opp.description}</p>\n                <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 11 }}>\n                  <span>Effort: <span style={{ color: effortColors[opp.effort], fontWeight: 500 }}>{opp.effort}</span></span>\n                  <span>Time: <span style={{ color: 'var(--text-secondary)', fontWeight: 500 }}>{opp.timeToRevenue}</span></span>\n                </div>\n              </div>\n            </div>\n          )\n        })}\n      </div>\n\n      {/* Revenue risks from engine */}\n      {revenueStrategies.length > 0 && (\n        <div className=\"card\">\n          <div className=\"card-header\">\n            <span className=\"card-title\"><Sparkles size={16} /> Engine-Detected Revenue Strategies</span>\n          </div>\n          <div className=\"card-body\">\n            {revenueStrategies.map(strat => (\n              <div key={strat.id} style={{ padding: '12px 0', borderBottom: '1px solid var(--border-subtle)', display: 'flex', gap: 12, alignItems: 'flex-start' }}>\n                <AlertTriangle size={14} color=\"var(--accent-gold)\" style={{ flexShrink: 0, marginTop: 2 }} />\n                <div>\n                  <div style={{ fontSize: 13, fontWeight: 500, marginBottom: 2 }}>{strat.title}</div>\n                  <div style={{ fontSize: 12, color: 'var(--text-muted)', lineHeight: 1.5 }}>{strat.description}</div>\n                </div>\n                <span style={{ fontFamily: 'var(--font-mono)', fontSize: 12, color: 'var(--accent-emerald)', fontWeight: 500, flexShrink: 0 }}>{strat.impactLabel}</span>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\RiskMatrix.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Zap' is defined but never used.","line":6,"column":61,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":64,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Zap"},"fix":{"range":[288,293],"text":""},"desc":"Remove unused variable \"Zap\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { analyzeAuditRisk } from '../engine/audit-risk'\nimport {\n  Shield, AlertTriangle, CheckCircle2, TrendingDown, Eye, Lock, Umbrella,\n  FileWarning, ChevronDown, ChevronRight, Activity, Target, Zap\n} from 'lucide-react'\n\nconst severityColors: Record<string, { bg: string; color: string; border: string }> = {\n  critical: { bg: 'var(--accent-red-dim)', color: 'var(--accent-red)', border: 'rgba(239,107,107,0.3)' },\n  high: { bg: 'rgba(251,191,36,0.12)', color: 'var(--accent-amber)', border: 'rgba(251,191,36,0.3)' },\n  medium: { bg: 'var(--accent-blue-dim)', color: 'var(--accent-blue)', border: 'rgba(96,165,250,0.3)' },\n  low: { bg: 'var(--accent-purple-dim)', color: 'var(--accent-purple)', border: 'rgba(167,139,250,0.3)' },\n}\n\nconst catIcons: Record<string, React.ReactNode> = {\n  Revenue: <TrendingDown size={16} />,\n  Legal: <Shield size={16} />,\n  Tax: <FileWarning size={16} />,\n  Financial: <Lock size={16} />,\n  Protection: <Umbrella size={16} />,\n  Compliance: <Eye size={16} />,\n}\n\ntype Tab = 'matrix' | 'list' | 'audit'\n\nexport function RiskMatrix() {\n  const { risks, healthScore, state } = useFortuna()\n  const [activeTab, setActiveTab] = useState<Tab>('matrix')\n  const [expandedRisk, setExpandedRisk] = useState<string | null>(null)\n  const [hoveredCell, setHoveredCell] = useState<string | null>(null)\n\n  const auditRisk = useMemo(() => analyzeAuditRisk(state), [state])\n\n  const critHigh = risks.filter(r => r.severity === 'critical' || r.severity === 'high').length\n  const protectionScore = healthScore.components.riskProtection\n\n  const heatmapRisks = useMemo(() => {\n    return risks.map(r => {\n      const impact = r.score >= 80 ? 5 : r.score >= 60 ? 4 : r.score >= 40 ? 3 : r.score >= 20 ? 2 : 1\n      const probability = r.severity === 'critical' ? 5 : r.severity === 'high' ? 4 : r.severity === 'medium' ? 3 : r.severity === 'low' ? 2 : 1\n      return { ...r, impact, probability }\n    })\n  }, [risks])\n\n  const gridData = useMemo(() => {\n    const grid: Record<string, typeof heatmapRisks> = {}\n    for (let p = 1; p <= 5; p++) {\n      for (let i = 1; i <= 5; i++) {\n        grid[`${p}-${i}`] = heatmapRisks.filter(r => r.probability === p && r.impact === i)\n      }\n    }\n    return grid\n  }, [heatmapRisks])\n\n  const getCellColor = (prob: number, impact: number): string => {\n    const score = prob * impact\n    if (score >= 16) return 'rgba(239,68,68,0.35)'\n    if (score >= 10) return 'rgba(249,115,22,0.30)'\n    if (score >= 6) return 'rgba(245,158,11,0.25)'\n    if (score >= 3) return 'rgba(96,165,250,0.20)'\n    return 'rgba(16,185,129,0.12)'\n  }\n\n  const getCellBorder = (prob: number, impact: number): string => {\n    const score = prob * impact\n    if (score >= 16) return 'rgba(239,68,68,0.5)'\n    if (score >= 10) return 'rgba(249,115,22,0.4)'\n    if (score >= 6) return 'rgba(245,158,11,0.3)'\n    return 'rgba(255,255,255,0.06)'\n  }\n\n  const tabs: { key: Tab; label: string; icon: React.ReactNode }[] = [\n    { key: 'matrix', label: 'Heatmap', icon: <Target size={13} /> },\n    { key: 'list', label: 'Risk Register', icon: <Activity size={13} /> },\n    { key: 'audit', label: 'Audit Risk', icon: <Shield size={13} /> },\n  ]\n\n  return (\n    <div className=\"view-enter\">\n      <div style={{ marginBottom: 28 }}>\n        <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 4 }}>\n          <h1 className=\"section-title\">Risk Intelligence</h1>\n          <span className=\"pill gold\"><Shield size={11} /> {risks.length} Tracked</span>\n          {critHigh > 0 && (\n            <span className=\"pill\" style={{ background: 'rgba(239,68,68,0.12)', color: '#ef4444', border: '1px solid rgba(239,68,68,0.3)' }}>\n              <AlertTriangle size={11} /> {critHigh} Critical/High\n            </span>\n          )}\n        </div>\n        <p className=\"section-subtitle\">Probability x impact risk heatmap, audit risk profiling, and mitigation playbooks</p>\n      </div>\n\n      <div className=\"grid-4 stagger\" style={{ marginBottom: 24 }}>\n        <div className=\"metric-card\" style={{ borderColor: critHigh > 0 ? 'rgba(239,107,107,0.2)' : 'var(--border-subtle)' }}>\n          <span className=\"metric-label\">Critical / High</span>\n          <div className=\"metric-value\" style={{ color: critHigh > 0 ? 'var(--accent-red)' : 'var(--accent-emerald)' }}>{critHigh}</div>\n          <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>{critHigh > 0 ? 'Require attention' : 'All clear'}</span>\n        </div>\n        <div className=\"metric-card\">\n          <span className=\"metric-label\">Protection Score</span>\n          <div className=\"metric-value\" style={{ color: protectionScore >= 60 ? 'var(--accent-emerald)' : 'var(--accent-gold)' }}>{protectionScore}/100</div>\n          <div className=\"progress-bar\" style={{ marginTop: 8 }}><div className=\"progress-fill\" style={{ width: `${protectionScore}%`, background: protectionScore >= 60 ? 'var(--accent-emerald)' : 'var(--accent-gold)' }} /></div>\n        </div>\n        <div className=\"metric-card\">\n          <span className=\"metric-label\">Audit Risk Score</span>\n          <div className=\"metric-value\" style={{ color: auditRisk.overallScore >= 50 ? '#ef4444' : auditRisk.overallScore >= 30 ? '#f59e0b' : '#10b981' }}>\n            {auditRisk.overallScore}/100\n          </div>\n          <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>{auditRisk.riskLevel.replace('-', ' ')}</span>\n        </div>\n        <div className=\"metric-card\">\n          <span className=\"metric-label\">Actionable</span>\n          <div className=\"metric-value\" style={{ color: 'var(--accent-blue)' }}>{risks.filter(r => r.actionable).length}</div>\n          <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>of {risks.length} total risks</span>\n        </div>\n      </div>\n\n      <div style={{ display: 'flex', gap: 4, marginBottom: 20 }}>\n        {tabs.map(tab => (\n          <button key={tab.key} onClick={() => setActiveTab(tab.key)} style={{\n            padding: '8px 16px', borderRadius: 8, border: 'none', cursor: 'pointer',\n            fontSize: 12, fontWeight: 500, fontFamily: 'var(--font-body)',\n            display: 'flex', alignItems: 'center', gap: 6,\n            background: activeTab === tab.key ? 'var(--accent-gold)' : 'var(--bg-elevated)',\n            color: activeTab === tab.key ? '#0c0e12' : 'var(--text-muted)',\n            transition: 'all 0.2s',\n          }}>\n            {tab.icon} {tab.label}\n          </button>\n        ))}\n      </div>\n\n      {activeTab === 'matrix' && (\n        <div className=\"card\" style={{ padding: 24 }}>\n          <div style={{ display: 'flex', gap: 24 }}>\n            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', width: 20 }}>\n              <div style={{\n                transform: 'rotate(-90deg)', whiteSpace: 'nowrap',\n                fontSize: 11, fontWeight: 600, color: 'var(--text-muted)',\n                textTransform: 'uppercase', letterSpacing: '0.08em',\n              }}>Probability</div>\n            </div>\n            <div style={{ flex: 1 }}>\n              <div style={{ display: 'grid', gridTemplateColumns: '50px repeat(5, 1fr)', gap: 4 }}>\n                <div />\n                {['Very Low', 'Low', 'Medium', 'High', 'Critical'].map(label => (\n                  <div key={label} style={{ textAlign: 'center', fontSize: 10, color: 'var(--text-muted)', padding: '4px 0', fontWeight: 500 }}>{label}</div>\n                ))}\n                {[5, 4, 3, 2, 1].map(prob => (\n                  <div key={`row-${prob}`} style={{ display: 'contents' }}>\n                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'flex-end', fontSize: 10, color: 'var(--text-muted)', paddingRight: 8, fontWeight: 500 }}>\n                      {prob === 5 ? 'Certain' : prob === 4 ? 'Likely' : prob === 3 ? 'Possible' : prob === 2 ? 'Unlikely' : 'Rare'}\n                    </div>\n                    {[1, 2, 3, 4, 5].map(impact => {\n                      const cellKey = `${prob}-${impact}`\n                      const cellRisks = gridData[cellKey] || []\n                      const isHovered = hoveredCell === cellKey\n                      return (\n                        <div key={cellKey}\n                          onMouseEnter={() => setHoveredCell(cellKey)}\n                          onMouseLeave={() => setHoveredCell(null)}\n                          style={{\n                            position: 'relative', minHeight: 56, borderRadius: 8,\n                            background: getCellColor(prob, impact),\n                            border: `1px solid ${isHovered ? 'var(--accent-gold)' : getCellBorder(prob, impact)}`,\n                            display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center',\n                            gap: 4, padding: 6, cursor: cellRisks.length > 0 ? 'pointer' : 'default',\n                            transition: 'all 0.2s', transform: isHovered && cellRisks.length > 0 ? 'scale(1.05)' : 'scale(1)',\n                          }}\n                        >\n                          {cellRisks.length > 0 ? (\n                            <>\n                              <div style={{\n                                fontFamily: 'var(--font-mono)', fontSize: 16, fontWeight: 700,\n                                color: prob * impact >= 16 ? '#ef4444' : prob * impact >= 10 ? '#f97316' : prob * impact >= 6 ? '#f59e0b' : '#60a5fa',\n                              }}>{cellRisks.length}</div>\n                              <div style={{ fontSize: 8, color: 'var(--text-muted)', textAlign: 'center', lineHeight: 1.2 }}>\n                                {cellRisks[0].name.slice(0, 16)}{cellRisks.length > 1 ? ` +${cellRisks.length - 1}` : ''}\n                              </div>\n                            </>\n                          ) : (\n                            <div style={{ fontSize: 9, color: 'rgba(255,255,255,0.1)' }}>-</div>\n                          )}\n                          {isHovered && cellRisks.length > 0 && (\n                            <div style={{\n                              position: 'absolute', top: '100%', left: '50%', transform: 'translateX(-50%)',\n                              marginTop: 8, padding: '10px 14px', background: '#1a1d24',\n                              border: '1px solid var(--border-subtle)', borderRadius: 10,\n                              zIndex: 10, minWidth: 200, boxShadow: '0 8px 32px rgba(0,0,0,0.5)',\n                            }}>\n                              {cellRisks.map(r => (\n                                <div key={r.id} style={{ fontSize: 11, color: 'var(--text-primary)', marginBottom: 4 }}>\n                                  <span style={{ fontWeight: 500 }}>{r.name}</span>\n                                  <span style={{ color: 'var(--text-muted)', marginLeft: 6 }}>Score: {r.score}</span>\n                                </div>\n                              ))}\n                            </div>\n                          )}\n                        </div>\n                      )\n                    })}\n                  </div>\n                ))}\n              </div>\n              <div style={{ textAlign: 'center', marginTop: 8, fontSize: 11, fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.08em' }}>\n                Impact\n              </div>\n            </div>\n            <div style={{ width: 140, display: 'flex', flexDirection: 'column', gap: 6, paddingTop: 24 }}>\n              <div style={{ fontSize: 10, color: 'var(--text-muted)', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 4 }}>Risk Zones</div>\n              {[\n                { label: 'Critical (16-25)', color: 'rgba(239,68,68,0.35)' },\n                { label: 'High (10-15)', color: 'rgba(249,115,22,0.30)' },\n                { label: 'Moderate (6-9)', color: 'rgba(245,158,11,0.25)' },\n                { label: 'Low (3-5)', color: 'rgba(96,165,250,0.20)' },\n                { label: 'Minimal (1-2)', color: 'rgba(16,185,129,0.12)' },\n              ].map(z => (\n                <div key={z.label} style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n                  <div style={{ width: 14, height: 14, borderRadius: 3, background: z.color }} />\n                  <span style={{ fontSize: 10, color: 'var(--text-muted)' }}>{z.label}</span>\n                </div>\n              ))}\n            </div>\n          </div>\n        </div>\n      )}\n\n      {activeTab === 'list' && (\n        <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>\n          {risks.length === 0 && (\n            <div className=\"card\" style={{ padding: 40, textAlign: 'center' }}>\n              <p style={{ color: 'var(--text-muted)', fontSize: 13 }}>Add financial data to generate risk analysis.</p>\n            </div>\n          )}\n          {risks.map(risk => {\n            const sev = severityColors[risk.severity]\n            const isExpanded = expandedRisk === risk.id\n            return (\n              <div key={risk.id} className=\"card\" style={{ overflow: 'hidden' }}>\n                <button onClick={() => setExpandedRisk(isExpanded ? null : risk.id)} style={{\n                  width: '100%', padding: '18px 24px', display: 'flex', gap: 16, alignItems: 'center',\n                  background: 'none', border: 'none', cursor: 'pointer', textAlign: 'left',\n                }}>\n                  <div style={{\n                    width: 44, height: 44, borderRadius: 12,\n                    background: sev.bg, border: `1px solid ${sev.border}`,\n                    display: 'flex', alignItems: 'center', justifyContent: 'center',\n                    color: sev.color, flexShrink: 0,\n                  }}>\n                    {catIcons[risk.category] || <AlertTriangle size={16} />}\n                  </div>\n                  <div style={{ flex: 1 }}>\n                    <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 4 }}>\n                      <span style={{ fontSize: 14, fontWeight: 500, color: 'var(--text-primary)' }}>{risk.name}</span>\n                      <span className=\"pill\" style={{ background: sev.bg, color: sev.color, borderColor: sev.border, fontSize: 10, textTransform: 'uppercase' }}>{risk.severity}</span>\n                      <span className=\"pill gold\" style={{ fontSize: 10 }}>{risk.category}</span>\n                    </div>\n                    <p style={{ fontSize: 12, color: 'var(--text-muted)', lineHeight: 1.4 }}>{risk.description}</p>\n                  </div>\n                  <div style={{ flexShrink: 0, textAlign: 'center', width: 56 }}>\n                    <div style={{\n                      width: 48, height: 48, borderRadius: '50%',\n                      border: `3px solid ${sev.color}`,\n                      display: 'flex', alignItems: 'center', justifyContent: 'center',\n                      fontFamily: 'var(--font-mono)', fontSize: 16, fontWeight: 600, color: sev.color,\n                    }}>{risk.score}</div>\n                  </div>\n                  {isExpanded ? <ChevronDown size={16} color=\"var(--text-muted)\" /> : <ChevronRight size={16} color=\"var(--text-muted)\" />}\n                </button>\n                {isExpanded && (\n                  <div style={{ padding: '0 24px 20px', borderTop: '1px solid var(--border-subtle)' }}>\n                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginTop: 16 }}>\n                      <div style={{ padding: 14, background: 'rgba(239,68,68,0.06)', borderRadius: 10, border: '1px solid rgba(239,68,68,0.15)' }}>\n                        <div style={{ fontSize: 10, color: '#ef4444', fontWeight: 600, textTransform: 'uppercase', marginBottom: 6 }}>Risk Detail</div>\n                        <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.6 }}>{risk.description}</div>\n                      </div>\n                      <div style={{ padding: 14, background: 'rgba(16,185,129,0.06)', borderRadius: 10, border: '1px solid rgba(16,185,129,0.15)' }}>\n                        <div style={{ fontSize: 10, color: '#10b981', fontWeight: 600, textTransform: 'uppercase', marginBottom: 6 }}>Mitigation</div>\n                        <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.6 }}>{risk.mitigation}</div>\n                      </div>\n                    </div>\n                  </div>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      )}\n\n      {activeTab === 'audit' && (\n        <div className=\"card\" style={{ overflow: 'hidden' }}>\n          <div style={{ padding: 24 }}>\n            <div style={{ display: 'flex', gap: 24, marginBottom: 24, alignItems: 'center' }}>\n              <div style={{\n                width: 100, height: 100, borderRadius: '50%',\n                border: `4px solid ${auditRisk.overallScore >= 50 ? '#ef4444' : auditRisk.overallScore >= 30 ? '#f59e0b' : '#10b981'}`,\n                display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', flexShrink: 0,\n              }}>\n                <div style={{ fontFamily: 'var(--font-mono)', fontSize: 28, fontWeight: 700, color: auditRisk.overallScore >= 50 ? '#ef4444' : auditRisk.overallScore >= 30 ? '#f59e0b' : '#10b981' }}>\n                  {auditRisk.overallScore}\n                </div>\n                <div style={{ fontSize: 9, color: 'var(--text-muted)', textTransform: 'uppercase' }}>Risk</div>\n              </div>\n              <div>\n                <div style={{ fontSize: 16, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 6 }}>{auditRisk.riskLabel}</div>\n                <div style={{ fontSize: 12, color: 'var(--text-muted)', lineHeight: 1.7 }}>\n                  Baseline rate: <strong>{(auditRisk.baselineAuditRate * 100).toFixed(2)}%</strong> |\n                  Adjusted: <strong style={{ color: auditRisk.overallScore >= 50 ? '#ef4444' : '#10b981' }}>{(auditRisk.adjustedAuditRate * 100).toFixed(2)}%</strong> |\n                  Red: <strong style={{ color: '#ef4444' }}>{auditRisk.redFlagCount}</strong> |\n                  Yellow: <strong style={{ color: '#f59e0b' }}>{auditRisk.yellowFlagCount}</strong>\n                </div>\n              </div>\n            </div>\n            <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>\n              {auditRisk.triggers.filter(t => t.triggered).map(trigger => {\n                const sevMap: Record<string, { bg: string; text: string }> = {\n                  critical: { bg: 'rgba(239,68,68,0.12)', text: '#ef4444' },\n                  high: { bg: 'rgba(249,115,22,0.12)', text: '#f97316' },\n                  medium: { bg: 'rgba(245,158,11,0.12)', text: '#f59e0b' },\n                  low: { bg: 'rgba(16,185,129,0.12)', text: '#10b981' },\n                }\n                const s = sevMap[trigger.severity]\n                const isExp = expandedRisk === trigger.id\n                return (\n                  <div key={trigger.id} style={{ borderRadius: 10, border: '1px solid var(--border-subtle)', background: 'var(--bg-surface)', overflow: 'hidden' }}>\n                    <button onClick={() => setExpandedRisk(isExp ? null : trigger.id)} style={{\n                      width: '100%', padding: '12px 16px', display: 'flex', alignItems: 'center', gap: 12,\n                      background: 'none', border: 'none', cursor: 'pointer', textAlign: 'left',\n                    }}>\n                      <span style={{ padding: '3px 8px', borderRadius: 6, fontSize: 10, fontWeight: 600, background: s.bg, color: s.text, textTransform: 'uppercase', flexShrink: 0 }}>\n                        {trigger.severity}\n                      </span>\n                      <span style={{ flex: 1, fontSize: 13, color: 'var(--text-primary)', fontWeight: 500 }}>{trigger.name}</span>\n                      <span style={{ fontFamily: 'var(--font-mono)', fontSize: 12, color: s.text }}>{trigger.riskScore}/100</span>\n                      {isExp ? <ChevronDown size={14} color=\"var(--text-muted)\" /> : <ChevronRight size={14} color=\"var(--text-muted)\" />}\n                    </button>\n                    {isExp && (\n                      <div style={{ padding: '0 16px 16px', borderTop: '1px solid var(--border-subtle)' }}>\n                        <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.7, marginTop: 12, marginBottom: 10 }}>{trigger.description}</div>\n                        <div style={{ padding: '10px 14px', background: 'rgba(96,165,250,0.06)', borderRadius: 8, border: '1px solid rgba(96,165,250,0.15)', marginBottom: 8 }}>\n                          <div style={{ fontSize: 10, color: '#60a5fa', fontWeight: 600, textTransform: 'uppercase', marginBottom: 4 }}>IRS Context</div>\n                          <div style={{ fontSize: 11, color: 'var(--text-secondary)', lineHeight: 1.6 }}>{trigger.irsContext}</div>\n                        </div>\n                        <div style={{ padding: '10px 14px', background: 'rgba(16,185,129,0.06)', borderRadius: 8, border: '1px solid rgba(16,185,129,0.15)' }}>\n                          <div style={{ fontSize: 10, color: '#10b981', fontWeight: 600, textTransform: 'uppercase', marginBottom: 4 }}>Mitigation</div>\n                          <div style={{ fontSize: 11, color: 'var(--text-secondary)', lineHeight: 1.6 }}>{trigger.mitigation}</div>\n                        </div>\n                      </div>\n                    )}\n                  </div>\n                )\n              })}\n            </div>\n            <div style={{ marginTop: 16, padding: '14px 18px', background: 'var(--accent-gold-dim)', borderRadius: 10, border: '1px solid rgba(212,168,67,0.2)' }}>\n              <div style={{ fontSize: 10, color: 'var(--accent-gold)', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 8 }}>Priority Actions</div>\n              {auditRisk.topRecommendations.map((rec, i) => (\n                <div key={i} style={{ display: 'flex', gap: 8, alignItems: 'flex-start', marginBottom: 6 }}>\n                  <CheckCircle2 size={13} color=\"var(--accent-gold)\" style={{ flexShrink: 0, marginTop: 2 }} />\n                  <span style={{ fontSize: 12, color: 'var(--text-primary)', lineHeight: 1.5 }}>{rec}</span>\n                </div>\n              ))}\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\ScenarioModeler.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TrendingDown' is defined but never used.","line":9,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":46,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TrendingDown"},"fix":{"range":[415,429],"text":""},"desc":"Remove unused variable \"TrendingDown\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ArrowRight' is defined but never used.","line":10,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":21,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ArrowRight"},"fix":{"range":[455,467],"text":""},"desc":"Remove unused variable \"ArrowRight\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ChevronDown' is defined but never used.","line":10,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":42,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ChevronDown"},"fix":{"range":[475,488],"text":""},"desc":"Remove unused variable \"ChevronDown\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Clock' is defined but never used.","line":10,"column":44,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":49,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Clock"},"fix":{"range":[488,495],"text":""},"desc":"Remove unused variable \"Clock\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Calculator' is defined but never used.","line":10,"column":51,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":61,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Calculator"},"fix":{"range":[495,507],"text":""},"desc":"Remove unused variable \"Calculator\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'PiggyBank' is defined but never used.","line":11,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":43,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"PiggyBank"},"fix":{"range":[540,551],"text":""},"desc":"Remove unused variable \"PiggyBank\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Cell' is defined but never used.","line":14,"column":62,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":66,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Cell"},"fix":{"range":[642,648],"text":""},"desc":"Remove unused variable \"Cell\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'LineChart' is defined but never used.","line":15,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":29,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"LineChart"},"fix":{"range":[675,686],"text":""},"desc":"Remove unused variable \"LineChart\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'taxReport' is assigned a value but never used.","line":33,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":33,"endColumn":27},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":37,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1805,1808],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1805,1808],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":72,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3332,3335],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3332,3335],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":72,"column":90,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":93,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3376,3379],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3376,3379],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":75,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":75,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3521,3524],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3521,3524],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":317,"column":192,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":317,"endColumn":195,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16738,16741],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16738,16741],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":334,"column":127,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":334,"endColumn":130,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18348,18351],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18348,18351],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":419,"column":119,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":419,"endColumn":122,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24253,24256],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24253,24256],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":427,"column":107,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":427,"endColumn":110,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25050,25053],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25050,25053],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":685,"column":118,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":685,"endColumn":121,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[42773,42776],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[42773,42776],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":18,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo, useCallback } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport {\n  evaluateScenario, generateSmartScenarios, generateWaterfall, projectMultiYear,\n  reverseCalculateIncome, generateSensitivityCurve,\n  type ScenarioModification, type ScenarioResult, type ProjectionConfig, DEFAULT_PROJECTION,\n} from '../engine/scenario-modeler'\nimport {\n  Sparkles, Plus, X, TrendingUp, TrendingDown, Zap, BarChart3,\n  Target, ArrowRight, Layers, ChevronDown, Clock, Calculator,\n  Activity, DollarSign, Percent, PiggyBank\n} from 'lucide-react'\nimport {\n  BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell, Legend,\n  AreaChart, Area, LineChart, Line, ComposedChart\n} from 'recharts'\n\ntype Tab = 'compare' | 'waterfall' | 'projections' | 'sensitivity' | 'reverse'\n\nconst TABS: { key: Tab; label: string; icon: React.ReactNode }[] = [\n  { key: 'compare', label: 'Compare', icon: <Layers size={14} /> },\n  { key: 'waterfall', label: 'Waterfall', icon: <BarChart3 size={14} /> },\n  { key: 'projections', label: 'Projections', icon: <TrendingUp size={14} /> },\n  { key: 'sensitivity', label: 'Sensitivity', icon: <Activity size={14} /> },\n  { key: 'reverse', label: 'Target Calc', icon: <Target size={14} /> },\n]\n\nfunction fmt(n: number): string { return `$${Math.round(n).toLocaleString()}` }\nfunction fmtK(n: number): string { return n >= 1000 ? `$${(n / 1000).toFixed(0)}k` : `$${n}` }\nfunction pct(n: number): string { return `${(n * 100).toFixed(1)}%` }\n\nexport function ScenarioModeler() {\n  const { state, taxReport, updateState } = useFortuna()\n\n  // Hydrate saved scenarios from FortunaState\n  const [activeScenarios, setActiveScenariosRaw] = useState<{ name: string; mods: ScenarioModification[]; description: string; icon: string }[]>(\n    () => (state as any).savedScenarios || []\n  )\n  const setActiveScenarios = useCallback((scenarios: typeof activeScenarios | ((prev: typeof activeScenarios) => typeof activeScenarios)) => {\n    setActiveScenariosRaw(prev => {\n      const next = typeof scenarios === 'function' ? scenarios(prev) : scenarios\n      updateState(s => ({ ...s, savedScenarios: next }))\n      return next\n    })\n  }, [updateState])\n\n  const [showCustom, setShowCustom] = useState(false)\n  const [activeTab, setActiveTab] = useState<Tab>('compare')\n\n  // Interactive income slider\n  const currentGross = state.incomeStreams.filter(s => s.isActive).reduce((s, i) => s + i.annualAmount, 0)\n  const [incomeOverride, setIncomeOverride] = useState<number | null>(null)\n  const effectiveIncome = incomeOverride ?? currentGross\n\n  // Projection config\n  const [projConfig, setProjConfig] = useState<ProjectionConfig>(DEFAULT_PROJECTION)\n\n  // Reverse calc target\n  const [reverseTarget, setReverseTarget] = useState(100000)\n\n  // Custom scenario builder\n  const [customName, setCustomName] = useState('Custom Scenario')\n  const [customMods, setCustomMods] = useState<ScenarioModification[]>([])\n  const [addModType, setAddModType] = useState<ScenarioModification['type']>('add_income')\n\n  const hasData = state.incomeStreams.length > 0\n\n  // Build working state with income override\n  const workingState: typeof state = useMemo(() => {\n    if (incomeOverride === null) return state\n    const s = JSON.parse(JSON.stringify(state))\n    const total = s.incomeStreams.filter((i: any) => i.isActive).reduce((sum: number, i: any) => sum + i.annualAmount, 0)\n    if (total > 0) {\n      const scale = incomeOverride / total\n      s.incomeStreams = s.incomeStreams.map((i: any) => ({ ...i, annualAmount: i.isActive ? Math.round(i.annualAmount * scale) : i.annualAmount }))\n    }\n    return s\n  }, [state, incomeOverride])\n\n  const smartScenarios = useMemo(() => generateSmartScenarios(workingState), [workingState])\n  const baseline = useMemo(() => evaluateScenario('Current', workingState, []), [workingState])\n\n  const results: ScenarioResult[] = useMemo(() => {\n    return activeScenarios.map(s => evaluateScenario(s.name, workingState, s.mods))\n  }, [activeScenarios, workingState])\n\n  // Waterfall data\n  const waterfallBaseline = useMemo(() => generateWaterfall(baseline.taxReport), [baseline])\n  const waterfallScenario = useMemo(() => {\n    if (results.length === 0) return null\n    return generateWaterfall(results[results.length - 1].taxReport)\n  }, [results])\n\n  // Projections\n  const baselineProjection = useMemo(\n    () => projectMultiYear(workingState, [], projConfig),\n    [workingState, projConfig]\n  )\n  const scenarioProjection = useMemo(() => {\n    if (activeScenarios.length === 0) return null\n    const lastScenario = activeScenarios[activeScenarios.length - 1]\n    return projectMultiYear(workingState, lastScenario.mods, projConfig)\n  }, [workingState, activeScenarios, projConfig])\n\n  // Sensitivity\n  const sensitivityCurve = useMemo(\n    () => generateSensitivityCurve(workingState, { min: Math.max(10000, effectiveIncome * 0.2), max: effectiveIncome * 3 }),\n    [workingState, effectiveIncome]\n  )\n\n  // Reverse calc\n  const reverseResult = useMemo(\n    () => reverseCalculateIncome(workingState, reverseTarget),\n    [workingState, reverseTarget]\n  )\n\n  // Chart data\n  const comparisonData = useMemo(() => {\n    const all = [baseline, ...results]\n    return all.map(r => ({\n      name: r.name.length > 16 ? r.name.substring(0, 14) + '…' : r.name,\n      'Federal': r.taxReport.federalIncomeTax,\n      'SE Tax': r.taxReport.selfEmploymentTax,\n      'State': r.taxReport.stateTax,\n      total: r.taxReport.totalTax,\n      net: r.taxReport.afterTaxIncome,\n    }))\n  }, [baseline, results])\n\n  const projChartData = useMemo(() => {\n    return baselineProjection.map((p, i) => ({\n      year: p.year.toString(),\n      'Current Path': p.afterTaxIncome,\n      'Current Tax': p.totalTax,\n      'Optimized Path': scenarioProjection ? scenarioProjection[i]?.afterTaxIncome : undefined,\n      'Optimized Tax': scenarioProjection ? scenarioProjection[i]?.totalTax : undefined,\n      'Retirement (Current)': p.retirementBalance,\n      'Retirement (Opt)': scenarioProjection ? scenarioProjection[i]?.retirementBalance : undefined,\n    }))\n  }, [baselineProjection, scenarioProjection])\n\n  const toggleScenario = (scenario: typeof smartScenarios[0]) => {\n    const exists = activeScenarios.find(s => s.name === scenario.name)\n    if (exists) setActiveScenarios(prev => prev.filter(s => s.name !== scenario.name))\n    else setActiveScenarios(prev => [...prev, scenario])\n  }\n\n  const addCustomMod = () => {\n    const mod: ScenarioModification = { type: addModType }\n    switch (addModType) {\n      case 'add_income': mod.incomeName = 'New Revenue'; mod.incomeType = 'business'; mod.incomeAmount = 50000; break\n      case 'change_entity': mod.entityType = 'llc_scorp'; break\n      case 'add_deduction': mod.deductionName = 'New Deduction'; mod.deductionCategory = 'retirement'; mod.deductionAmount = 10000; break\n      case 'add_expense': mod.expenseDesc = 'New Expense'; mod.expenseAmount = 5000; mod.expensePct = 100; break\n      case 'change_state': mod.stateCode = 'TX'; break\n    }\n    setCustomMods(prev => [...prev, mod])\n  }\n\n  const saveCustomScenario = () => {\n    if (customMods.length === 0) return\n    setActiveScenarios(prev => [...prev, { name: customName, mods: customMods, description: 'Custom', icon: '🔧' }])\n    setCustomMods([])\n    setCustomName('Custom Scenario')\n    setShowCustom(false)\n  }\n\n  const inputStyle: React.CSSProperties = {\n    padding: '8px 12px', borderRadius: 8, border: '1px solid var(--border-medium)',\n    background: 'var(--bg-surface)', color: 'var(--text-primary)', fontFamily: 'var(--font-body)',\n    fontSize: 13, outline: 'none', width: '100%',\n  }\n\n  if (!hasData) {\n    return (\n      <div className=\"view-enter\" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '50vh' }}>\n        <div style={{ textAlign: 'center', maxWidth: 400 }}>\n          <BarChart3 size={32} color=\"var(--accent-gold)\" style={{ marginBottom: 12 }} />\n          <h2 style={{ fontFamily: 'var(--font-display)', marginBottom: 8 }}>Scenario Modeler</h2>\n          <p style={{ fontSize: 13, color: 'var(--text-muted)' }}>Add your financial data first to start modeling what-if scenarios.</p>\n        </div>\n      </div>\n    )\n  }\n\n  // ─── Metric delta display ────────────────────────\n  const bestResult = results.length > 0 ? results.reduce((best, r) => r.taxReport.afterTaxIncome > best.taxReport.afterTaxIncome ? r : best, results[0]) : null\n  const taxSaved = bestResult ? baseline.taxReport.totalTax - bestResult.taxReport.totalTax : 0\n  const incomeGained = bestResult ? bestResult.taxReport.afterTaxIncome - baseline.taxReport.afterTaxIncome : 0\n\n  return (\n    <div className=\"view-enter\">\n      {/* Header */}\n      <div style={{ marginBottom: 20 }}>\n        <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 4 }}>\n          <h1 className=\"section-title\">Scenario Modeler</h1>\n          <span className=\"pill gold\"><Zap size={11} /> Interactive</span>\n        </div>\n        <p className=\"section-subtitle\">Real-time financial simulation. Toggle scenarios, drag sliders, watch everything recompute.</p>\n      </div>\n\n      {/* ── Live Metrics Bar ── */}\n      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 12, marginBottom: 20 }}>\n        {[\n          { label: 'Gross Income', value: fmt(baseline.taxReport.grossIncome), icon: <DollarSign size={14} />, color: 'var(--accent-blue)' },\n          { label: 'Total Tax', value: fmt(baseline.taxReport.totalTax), sub: pct(baseline.taxReport.effectiveRate), icon: <Percent size={14} />, color: 'var(--accent-red)' },\n          { label: 'After Tax', value: fmt(baseline.taxReport.afterTaxIncome), icon: <TrendingUp size={14} />, color: 'var(--accent-emerald)' },\n          { label: taxSaved > 0 ? 'Tax Saved' : 'Health Score', value: taxSaved > 0 ? fmt(taxSaved) : `${baseline.healthScore.overall}/100`, sub: incomeGained > 0 ? `+${fmt(incomeGained)} net` : baseline.healthScore.grade, icon: taxSaved > 0 ? <Sparkles size={14} /> : <Activity size={14} />, color: 'var(--accent-gold)' },\n        ].map((m, i) => (\n          <div key={i} style={{\n            padding: '16px 18px', borderRadius: 14, background: 'var(--bg-elevated)',\n            border: '1px solid var(--border-subtle)',\n          }}>\n            <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 8 }}>\n              <span style={{ color: m.color }}>{m.icon}</span>\n              <span style={{ fontSize: 11, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.06em', fontWeight: 500 }}>{m.label}</span>\n            </div>\n            <div style={{ fontFamily: 'var(--font-mono)', fontSize: 20, fontWeight: 600, color: 'var(--text-primary)' }}>{m.value}</div>\n            {m.sub && <div style={{ fontFamily: 'var(--font-mono)', fontSize: 11, color: m.color, marginTop: 2 }}>{m.sub}</div>}\n          </div>\n        ))}\n      </div>\n\n      {/* ── Income Slider ── */}\n      <div className=\"card\" style={{ marginBottom: 20 }}>\n        <div className=\"card-body\" style={{ padding: '18px 22px' }}>\n          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 12 }}>\n            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n              <DollarSign size={15} color=\"var(--accent-gold)\" />\n              <span style={{ fontSize: 13, fontWeight: 500 }}>Income Slider</span>\n              <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>— drag to see cascading tax impact</span>\n            </div>\n            <div style={{ fontFamily: 'var(--font-mono)', fontSize: 16, fontWeight: 600, color: 'var(--accent-gold)' }}>\n              {fmt(effectiveIncome)}\n            </div>\n          </div>\n          <div style={{ position: 'relative' }}>\n            <input\n              type=\"range\"\n              min={Math.max(10000, Math.round(currentGross * 0.25))}\n              max={Math.round(currentGross * 3)}\n              step={1000}\n              value={effectiveIncome}\n              onChange={e => setIncomeOverride(parseInt(e.target.value))}\n              style={{\n                width: '100%', height: 6, appearance: 'none', borderRadius: 3,\n                background: `linear-gradient(to right, var(--accent-gold) ${((effectiveIncome - currentGross * 0.25) / (currentGross * 2.75)) * 100}%, var(--bg-surface) 0%)`,\n                cursor: 'pointer', outline: 'none',\n              }}\n            />\n            <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: 6 }}>\n              <span style={{ fontSize: 10, color: 'var(--text-muted)', fontFamily: 'var(--font-mono)' }}>{fmtK(Math.round(currentGross * 0.25))}</span>\n              {incomeOverride !== null && (\n                <button onClick={() => setIncomeOverride(null)}\n                  style={{ fontSize: 10, color: 'var(--accent-gold)', background: 'none', border: 'none', cursor: 'pointer', fontFamily: 'var(--font-mono)' }}>\n                  ↻ Reset to actual\n                </button>\n              )}\n              <span style={{ fontSize: 10, color: 'var(--text-muted)', fontFamily: 'var(--font-mono)' }}>{fmtK(Math.round(currentGross * 3))}</span>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* ── Scenario Chips ── */}\n      <div style={{ marginBottom: 20 }}>\n        <div style={{ fontSize: 11, fontWeight: 500, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.08em', marginBottom: 10 }}>\n          Toggle Scenarios\n        </div>\n        <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>\n          {smartScenarios.map(scenario => {\n            const isActive = activeScenarios.some(s => s.name === scenario.name)\n            return (\n              <button key={scenario.name} onClick={() => toggleScenario(scenario)}\n                style={{\n                  padding: '8px 14px', borderRadius: 10,\n                  border: `1px solid ${isActive ? 'rgba(212,168,67,0.4)' : 'var(--border-subtle)'}`,\n                  background: isActive ? 'var(--accent-gold-dim)' : 'var(--bg-elevated)',\n                  color: isActive ? 'var(--accent-gold)' : 'var(--text-secondary)',\n                  cursor: 'pointer', fontSize: 12, fontFamily: 'var(--font-body)', transition: 'all 0.2s',\n                  display: 'flex', alignItems: 'center', gap: 6,\n                }}>\n                <span>{scenario.icon}</span>\n                <span style={{ fontWeight: 500 }}>{scenario.name}</span>\n              </button>\n            )\n          })}\n          <button onClick={() => setShowCustom(!showCustom)}\n            style={{\n              padding: '8px 14px', borderRadius: 10, border: '1px dashed var(--border-medium)',\n              background: 'transparent', color: 'var(--text-muted)', cursor: 'pointer', fontSize: 12,\n              fontFamily: 'var(--font-body)', display: 'flex', alignItems: 'center', gap: 6,\n            }}>\n            <Plus size={13} /> Custom\n          </button>\n        </div>\n      </div>\n\n      {/* Custom scenario builder */}\n      {showCustom && (\n        <div className=\"card\" style={{ marginBottom: 20 }}>\n          <div className=\"card-body\" style={{ padding: 18 }}>\n            <div style={{ display: 'flex', gap: 8, marginBottom: 12, alignItems: 'center' }}>\n              <span style={{ fontSize: 12, color: 'var(--text-muted)', fontWeight: 500 }}>Name:</span>\n              <input style={{ ...inputStyle, maxWidth: 200 }} value={customName} onChange={e => setCustomName(e.target.value)} />\n            </div>\n            {customMods.map((mod, i) => (\n              <div key={i} style={{ display: 'flex', gap: 8, alignItems: 'center', marginBottom: 8 }}>\n                <span className=\"pill\" style={{ fontSize: 10, minWidth: 80 }}>{mod.type.replace(/_/g, ' ')}</span>\n                {(mod.type === 'add_income' || mod.type === 'modify_income') && (\n                  <>\n                    <input style={{ ...inputStyle, width: 140 }} placeholder=\"Name\" value={mod.incomeName || ''} onChange={e => setCustomMods(prev => prev.map((m, j) => j === i ? { ...m, incomeName: e.target.value } : m))} />\n                    <input style={{ ...inputStyle, width: 100 }} type=\"number\" placeholder=\"Amount\" value={mod.incomeAmount || ''} onChange={e => setCustomMods(prev => prev.map((m, j) => j === i ? { ...m, incomeAmount: parseFloat(e.target.value) || 0 } : m))} />\n                  </>\n                )}\n                {mod.type === 'change_entity' && (\n                  <select style={{ ...inputStyle, width: 180 }} value={mod.entityType} onChange={e => setCustomMods(prev => prev.map((m, j) => j === i ? { ...m, entityType: e.target.value as any } : m))}>\n                    <option value=\"sole_prop\">Sole Prop</option><option value=\"llc\">LLC</option><option value=\"llc_scorp\">LLC + S-Corp</option><option value=\"ccorp\">C-Corp</option>\n                  </select>\n                )}\n                {mod.type === 'add_deduction' && (\n                  <>\n                    <input style={{ ...inputStyle, width: 140 }} placeholder=\"Name\" value={mod.deductionName || ''} onChange={e => setCustomMods(prev => prev.map((m, j) => j === i ? { ...m, deductionName: e.target.value } : m))} />\n                    <input style={{ ...inputStyle, width: 100 }} type=\"number\" placeholder=\"Amount\" value={mod.deductionAmount || ''} onChange={e => setCustomMods(prev => prev.map((m, j) => j === i ? { ...m, deductionAmount: parseFloat(e.target.value) || 0 } : m))} />\n                  </>\n                )}\n                {mod.type === 'change_state' && (\n                  <input style={{ ...inputStyle, width: 80 }} placeholder=\"ST\" value={mod.stateCode || ''} onChange={e => setCustomMods(prev => prev.map((m, j) => j === i ? { ...m, stateCode: e.target.value.toUpperCase() } : m))} />\n                )}\n                <button onClick={() => setCustomMods(prev => prev.filter((_, j) => j !== i))} style={{ background: 'none', border: 'none', color: 'var(--accent-red)', cursor: 'pointer' }}><X size={14} /></button>\n              </div>\n            ))}\n            <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>\n              <select style={{ ...inputStyle, width: 160 }} value={addModType} onChange={e => setAddModType(e.target.value as any)}>\n                <option value=\"add_income\">Add Income</option><option value=\"change_entity\">Change Entity</option>\n                <option value=\"add_deduction\">Add Deduction</option><option value=\"add_expense\">Add Expense</option><option value=\"change_state\">Change State</option>\n              </select>\n              <button onClick={addCustomMod} style={{ padding: '7px 12px', borderRadius: 8, border: '1px solid var(--border-medium)', background: 'transparent', color: 'var(--text-secondary)', cursor: 'pointer', fontSize: 12, fontFamily: 'var(--font-body)' }}>\n                <Plus size={12} /> Add\n              </button>\n              <div style={{ flex: 1 }} />\n              <button onClick={saveCustomScenario} disabled={customMods.length === 0}\n                style={{ padding: '7px 16px', borderRadius: 8, border: 'none', background: customMods.length ? 'var(--accent-gold)' : 'var(--bg-surface)', color: customMods.length ? '#0c0e12' : 'var(--text-muted)', cursor: customMods.length ? 'pointer' : 'default', fontSize: 12, fontWeight: 600, fontFamily: 'var(--font-body)' }}>\n                Run Scenario\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* ── Tab Navigation ── */}\n      <div style={{\n        display: 'flex', gap: 4, marginBottom: 20, borderBottom: '1px solid var(--border-subtle)', paddingBottom: 0,\n      }}>\n        {TABS.map(tab => (\n          <button key={tab.key} onClick={() => setActiveTab(tab.key)}\n            style={{\n              display: 'flex', alignItems: 'center', gap: 6,\n              padding: '10px 16px', borderRadius: '10px 10px 0 0',\n              border: 'none', borderBottom: activeTab === tab.key ? '2px solid var(--accent-gold)' : '2px solid transparent',\n              background: activeTab === tab.key ? 'var(--bg-elevated)' : 'transparent',\n              color: activeTab === tab.key ? 'var(--accent-gold)' : 'var(--text-muted)',\n              cursor: 'pointer', fontSize: 12, fontWeight: 500, fontFamily: 'var(--font-body)',\n              transition: 'all 0.2s',\n            }}>\n            {tab.icon} {tab.label}\n          </button>\n        ))}\n      </div>\n\n      {/* ══════════════ TAB: COMPARE ══════════════ */}\n      {activeTab === 'compare' && (\n        <>\n          {results.length > 0 ? (\n            <>\n              {/* Stacked bar comparison */}\n              <div className=\"card\" style={{ marginBottom: 20 }}>\n                <div className=\"card-header\"><span className=\"card-title\">Tax Burden Comparison</span></div>\n                <div className=\"card-body\">\n                  <ResponsiveContainer width=\"100%\" height={Math.max(180, comparisonData.length * 60)}>\n                    <BarChart data={comparisonData} layout=\"vertical\" barCategoryGap=\"20%\">\n                      <XAxis type=\"number\" tickFormatter={v => fmtK(v)} tick={{ fill: '#565c6a', fontSize: 11, fontFamily: 'var(--font-mono)' }} axisLine={false} tickLine={false} />\n                      <YAxis type=\"category\" dataKey=\"name\" tick={{ fill: '#8b919e', fontSize: 12 }} axisLine={false} tickLine={false} width={120} />\n                      <Tooltip contentStyle={{ background: '#181c24', border: '1px solid rgba(255,255,255,0.1)', borderRadius: 8, fontFamily: 'var(--font-mono)', fontSize: 11 }} formatter={(v: number) => fmt(v)} />\n                      <Legend iconType=\"square\" wrapperStyle={{ fontSize: 11 }} />\n                      <Bar dataKey=\"Federal\" stackId=\"tax\" fill=\"#d4a843\" />\n                      <Bar dataKey=\"SE Tax\" stackId=\"tax\" fill=\"#a78bfa\" />\n                      <Bar dataKey=\"State\" stackId=\"tax\" fill=\"#60a5fa\" radius={[0, 4, 4, 0]} />\n                    </BarChart>\n                  </ResponsiveContainer>\n                </div>\n              </div>\n\n              {/* Detail table */}\n              <div className=\"card\" style={{ marginBottom: 20 }}>\n                <div className=\"card-header\"><span className=\"card-title\">Side-by-Side Analysis</span></div>\n                <div className=\"card-body\" style={{ overflowX: 'auto' }}>\n                  <table style={{ width: '100%', borderCollapse: 'collapse', fontFamily: 'var(--font-mono)', fontSize: 12 }}>\n                    <thead>\n                      <tr>\n                        <th style={{ textAlign: 'left', padding: '10px 12px', borderBottom: '1px solid var(--border-subtle)', color: 'var(--text-muted)', fontWeight: 500, fontSize: 11 }}>Metric</th>\n                        <th style={{ textAlign: 'right', padding: '10px 12px', borderBottom: '1px solid var(--border-subtle)', color: 'var(--accent-gold)', fontWeight: 500, fontSize: 11 }}>Current</th>\n                        {results.map(r => (\n                          <th key={r.name} style={{ textAlign: 'right', padding: '10px 12px', borderBottom: '1px solid var(--border-subtle)', color: 'var(--text-secondary)', fontWeight: 500, fontSize: 11 }}>{r.name}</th>\n                        ))}\n                      </tr>\n                    </thead>\n                    <tbody>\n                      {[\n                        { label: 'Gross Income', key: 'grossIncome', inv: false },\n                        { label: 'Total Tax', key: 'totalTax', inv: true, hl: true },\n                        { label: 'Federal Tax', key: 'federalIncomeTax', inv: true },\n                        { label: 'SE Tax', key: 'selfEmploymentTax', inv: true },\n                        { label: 'State Tax', key: 'stateTax', inv: true },\n                        { label: 'Effective Rate', key: 'effectiveRate', inv: true, pct: true },\n                        { label: 'After-Tax', key: 'afterTaxIncome', inv: false, hl: true, emerald: true },\n                        { label: 'Health Score', key: '_health', inv: false },\n                      ].map(row => {\n                        const baseVal = row.key === '_health' ? baseline.healthScore.overall : (baseline.taxReport as any)[row.key]\n                        return (\n                          <tr key={row.key}>\n                            <td style={{ padding: '10px 12px', borderBottom: '1px solid var(--border-subtle)', color: 'var(--text-secondary)', fontSize: 12, fontFamily: 'var(--font-body)' }}>{row.label}</td>\n                            <td style={{ padding: '10px 12px', borderBottom: '1px solid var(--border-subtle)', textAlign: 'right', color: 'var(--text-primary)', fontWeight: row.hl ? 600 : 400 }}>\n                              {row.pct ? pct(baseVal) : row.key === '_health' ? `${baseVal}/100` : fmt(baseVal)}\n                            </td>\n                            {results.map(r => {\n                              const val = row.key === '_health' ? r.healthScore.overall : (r.taxReport as any)[row.key]\n                              const diff = val - baseVal\n                              const isBetter = row.inv ? diff < 0 : diff > 0\n                              return (\n                                <td key={r.name} style={{ padding: '10px 12px', borderBottom: '1px solid var(--border-subtle)', textAlign: 'right' }}>\n                                  <div style={{ color: row.hl ? (isBetter ? 'var(--accent-emerald)' : diff === 0 ? 'var(--text-primary)' : 'var(--accent-red)') : 'var(--text-primary)', fontWeight: row.hl ? 600 : 400 }}>\n                                    {row.pct ? pct(val) : row.key === '_health' ? `${val}/100` : fmt(val)}\n                                  </div>\n                                  {diff !== 0 && (\n                                    <div style={{ fontSize: 10, color: isBetter ? 'var(--accent-emerald)' : 'var(--accent-red)', marginTop: 2 }}>\n                                      {diff > 0 ? '+' : ''}{row.pct ? `${(diff * 100).toFixed(1)}%` : row.key === '_health' ? diff : fmt(diff)}\n                                    </div>\n                                  )}\n                                </td>\n                              )\n                            })}\n                          </tr>\n                        )\n                      })}\n                    </tbody>\n                  </table>\n                </div>\n              </div>\n            </>\n          ) : (\n            <EmptyPrompt message=\"Select scenarios above to see side-by-side comparison\" />\n          )}\n        </>\n      )}\n\n      {/* ══════════════ TAB: WATERFALL ══════════════ */}\n      {activeTab === 'waterfall' && (\n        <div style={{ display: 'grid', gridTemplateColumns: waterfallScenario ? '1fr 1fr' : '1fr', gap: 16 }}>\n          <WaterfallCard title=\"Current\" data={waterfallBaseline} report={baseline.taxReport} />\n          {waterfallScenario && results.length > 0 && (\n            <WaterfallCard title={results[results.length - 1].name} data={waterfallScenario} report={results[results.length - 1].taxReport} />\n          )}\n          {!waterfallScenario && (\n            <div style={{ textAlign: 'center', padding: 32, color: 'var(--text-muted)', fontSize: 13 }}>\n              Toggle a scenario to see the comparison waterfall\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* ══════════════ TAB: PROJECTIONS ══════════════ */}\n      {activeTab === 'projections' && (\n        <>\n          {/* Config sliders */}\n          <div className=\"card\" style={{ marginBottom: 20 }}>\n            <div className=\"card-body\" style={{ padding: 18 }}>\n              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 16 }}>\n                <ConfigSlider label=\"Growth Rate\" value={projConfig.annualGrowthRate} min={0} max={0.50} step={0.01}\n                  format={v => `${(v * 100).toFixed(0)}%`} onChange={v => setProjConfig(p => ({ ...p, annualGrowthRate: v }))} />\n                <ConfigSlider label=\"Retirement %\" value={projConfig.retirementContribRate} min={0} max={0.30} step={0.01}\n                  format={v => `${(v * 100).toFixed(0)}%`} onChange={v => setProjConfig(p => ({ ...p, retirementContribRate: v }))} />\n                <ConfigSlider label=\"Return Rate\" value={projConfig.retirementReturnRate} min={0.02} max={0.15} step={0.01}\n                  format={v => `${(v * 100).toFixed(0)}%`} onChange={v => setProjConfig(p => ({ ...p, retirementReturnRate: v }))} />\n                <ConfigSlider label=\"Years\" value={projConfig.years} min={2} max={10} step={1}\n                  format={v => `${v}yr`} onChange={v => setProjConfig(p => ({ ...p, years: v }))} />\n              </div>\n            </div>\n          </div>\n\n          {/* Income & Tax projection */}\n          <div className=\"card\" style={{ marginBottom: 20 }}>\n            <div className=\"card-header\"><span className=\"card-title\">Income & Tax Trajectory</span></div>\n            <div className=\"card-body\">\n              <ResponsiveContainer width=\"100%\" height={280}>\n                <ComposedChart data={projChartData}>\n                  <XAxis dataKey=\"year\" tick={{ fill: '#8b919e', fontSize: 11 }} axisLine={false} tickLine={false} />\n                  <YAxis tickFormatter={v => fmtK(v)} tick={{ fill: '#565c6a', fontSize: 11, fontFamily: 'var(--font-mono)' }} axisLine={false} tickLine={false} />\n                  <Tooltip contentStyle={{ background: '#181c24', border: '1px solid rgba(255,255,255,0.1)', borderRadius: 8, fontFamily: 'var(--font-mono)', fontSize: 11 }} formatter={(v: number) => fmt(v)} />\n                  <Legend iconType=\"square\" wrapperStyle={{ fontSize: 11 }} />\n                  <Area type=\"monotone\" dataKey=\"Current Path\" fill=\"rgba(96,165,250,0.15)\" stroke=\"#60a5fa\" strokeWidth={2} />\n                  {scenarioProjection && <Area type=\"monotone\" dataKey=\"Optimized Path\" fill=\"rgba(16,185,129,0.15)\" stroke=\"#10b981\" strokeWidth={2} />}\n                  <Line type=\"monotone\" dataKey=\"Current Tax\" stroke=\"#ef4444\" strokeWidth={1.5} strokeDasharray=\"5 5\" dot={false} />\n                  {scenarioProjection && <Line type=\"monotone\" dataKey=\"Optimized Tax\" stroke=\"#f59e0b\" strokeWidth={1.5} strokeDasharray=\"5 5\" dot={false} />}\n                </ComposedChart>\n              </ResponsiveContainer>\n            </div>\n          </div>\n\n          {/* Retirement accumulation */}\n          <div className=\"card\" style={{ marginBottom: 20 }}>\n            <div className=\"card-header\"><span className=\"card-title\">Retirement Accumulation</span></div>\n            <div className=\"card-body\">\n              <ResponsiveContainer width=\"100%\" height={220}>\n                <AreaChart data={projChartData}>\n                  <XAxis dataKey=\"year\" tick={{ fill: '#8b919e', fontSize: 11 }} axisLine={false} tickLine={false} />\n                  <YAxis tickFormatter={v => fmtK(v)} tick={{ fill: '#565c6a', fontSize: 11, fontFamily: 'var(--font-mono)' }} axisLine={false} tickLine={false} />\n                  <Tooltip contentStyle={{ background: '#181c24', border: '1px solid rgba(255,255,255,0.1)', borderRadius: 8, fontFamily: 'var(--font-mono)', fontSize: 11 }} formatter={(v: number) => fmt(v)} />\n                  <Legend iconType=\"square\" wrapperStyle={{ fontSize: 11 }} />\n                  <Area type=\"monotone\" dataKey=\"Retirement (Current)\" fill=\"rgba(167,139,250,0.2)\" stroke=\"#a78bfa\" strokeWidth={2} />\n                  {scenarioProjection && <Area type=\"monotone\" dataKey=\"Retirement (Opt)\" fill=\"rgba(212,168,67,0.2)\" stroke=\"#d4a843\" strokeWidth={2} />}\n                </AreaChart>\n              </ResponsiveContainer>\n            </div>\n          </div>\n\n          {/* Cumulative summary */}\n          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 12 }}>\n            {(() => {\n              const last = baselineProjection[baselineProjection.length - 1]\n              const lastOpt = scenarioProjection ? scenarioProjection[scenarioProjection.length - 1] : null\n              return [\n                { label: `${projConfig.years}-Year After-Tax`, current: last.cumulativeAfterTax, optimized: lastOpt?.cumulativeAfterTax },\n                { label: `${projConfig.years}-Year Taxes Paid`, current: last.cumulativeTax, optimized: lastOpt?.cumulativeTax },\n                { label: `Retirement at Year ${projConfig.years}`, current: last.retirementBalance, optimized: lastOpt?.retirementBalance },\n              ].map((item, i) => (\n                <div key={i} className=\"card\">\n                  <div className=\"card-body\" style={{ padding: 16, textAlign: 'center' }}>\n                    <div style={{ fontSize: 11, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 8 }}>{item.label}</div>\n                    <div style={{ fontFamily: 'var(--font-mono)', fontSize: 18, fontWeight: 600, color: 'var(--text-primary)' }}>{fmt(item.current)}</div>\n                    {item.optimized && item.optimized !== item.current && (\n                      <div style={{ fontFamily: 'var(--font-mono)', fontSize: 12, color: item.optimized > item.current ? (i === 1 ? 'var(--accent-red)' : 'var(--accent-emerald)') : (i === 1 ? 'var(--accent-emerald)' : 'var(--accent-red)'), marginTop: 4 }}>\n                        Optimized: {fmt(item.optimized)}\n                        <span style={{ fontSize: 10, marginLeft: 4 }}>\n                          ({item.optimized > item.current ? '+' : ''}{fmt(item.optimized - item.current)})\n                        </span>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              ))\n            })()}\n          </div>\n        </>\n      )}\n\n      {/* ══════════════ TAB: SENSITIVITY ══════════════ */}\n      {activeTab === 'sensitivity' && (\n        <>\n          <div className=\"card\" style={{ marginBottom: 20 }}>\n            <div className=\"card-header\"><span className=\"card-title\">Tax Rate vs Income</span></div>\n            <div className=\"card-body\">\n              <ResponsiveContainer width=\"100%\" height={280}>\n                <ComposedChart data={sensitivityCurve}>\n                  <XAxis dataKey=\"income\" tickFormatter={v => fmtK(v)} tick={{ fill: '#8b919e', fontSize: 11, fontFamily: 'var(--font-mono)' }} axisLine={false} tickLine={false} />\n                  <YAxis yAxisId=\"pct\" orientation=\"right\" tickFormatter={v => `${(v * 100).toFixed(0)}%`} tick={{ fill: '#565c6a', fontSize: 11, fontFamily: 'var(--font-mono)' }} axisLine={false} tickLine={false} domain={[0, 0.5]} />\n                  <YAxis yAxisId=\"amt\" tickFormatter={v => fmtK(v)} tick={{ fill: '#565c6a', fontSize: 11, fontFamily: 'var(--font-mono)' }} axisLine={false} tickLine={false} />\n                  <Tooltip contentStyle={{ background: '#181c24', border: '1px solid rgba(255,255,255,0.1)', borderRadius: 8, fontFamily: 'var(--font-mono)', fontSize: 11 }}\n                    formatter={(v: number, name: string) => name.includes('Rate') ? `${(v * 100).toFixed(1)}%` : fmt(v)} />\n                  <Legend iconType=\"line\" wrapperStyle={{ fontSize: 11 }} />\n                  <Area yAxisId=\"amt\" type=\"monotone\" dataKey=\"afterTax\" name=\"After Tax\" fill=\"rgba(16,185,129,0.12)\" stroke=\"#10b981\" strokeWidth={2} />\n                  <Area yAxisId=\"amt\" type=\"monotone\" dataKey=\"totalTax\" name=\"Total Tax\" fill=\"rgba(239,68,68,0.12)\" stroke=\"#ef4444\" strokeWidth={2} />\n                  <Line yAxisId=\"pct\" type=\"monotone\" dataKey=\"effectiveRate\" name=\"Effective Rate\" stroke=\"#d4a843\" strokeWidth={2} dot={false} />\n                  <Line yAxisId=\"pct\" type=\"monotone\" dataKey=\"marginalRate\" name=\"Marginal Rate\" stroke=\"#a78bfa\" strokeWidth={2} dot={false} strokeDasharray=\"5 5\" />\n                </ComposedChart>\n              </ResponsiveContainer>\n            </div>\n          </div>\n\n          {/* Tax component breakdown */}\n          <div className=\"card\">\n            <div className=\"card-header\"><span className=\"card-title\">Tax Component Breakdown by Income</span></div>\n            <div className=\"card-body\">\n              <ResponsiveContainer width=\"100%\" height={240}>\n                <AreaChart data={sensitivityCurve}>\n                  <XAxis dataKey=\"income\" tickFormatter={v => fmtK(v)} tick={{ fill: '#8b919e', fontSize: 11, fontFamily: 'var(--font-mono)' }} axisLine={false} tickLine={false} />\n                  <YAxis tickFormatter={v => fmtK(v)} tick={{ fill: '#565c6a', fontSize: 11, fontFamily: 'var(--font-mono)' }} axisLine={false} tickLine={false} />\n                  <Tooltip contentStyle={{ background: '#181c24', border: '1px solid rgba(255,255,255,0.1)', borderRadius: 8, fontFamily: 'var(--font-mono)', fontSize: 11 }} formatter={(v: number) => fmt(v)} />\n                  <Legend iconType=\"square\" wrapperStyle={{ fontSize: 11 }} />\n                  <Area type=\"monotone\" dataKey=\"federalTax\" name=\"Federal\" stackId=\"1\" fill=\"rgba(212,168,67,0.5)\" stroke=\"#d4a843\" />\n                  <Area type=\"monotone\" dataKey=\"seTax\" name=\"SE Tax\" stackId=\"1\" fill=\"rgba(167,139,250,0.5)\" stroke=\"#a78bfa\" />\n                  <Area type=\"monotone\" dataKey=\"stateTax\" name=\"State\" stackId=\"1\" fill=\"rgba(96,165,250,0.5)\" stroke=\"#60a5fa\" />\n                </AreaChart>\n              </ResponsiveContainer>\n            </div>\n          </div>\n\n          {/* Current position marker */}\n          <div style={{ textAlign: 'center', marginTop: 12, fontSize: 12, color: 'var(--text-muted)' }}>\n            Your current income: <span style={{ color: 'var(--accent-gold)', fontFamily: 'var(--font-mono)', fontWeight: 600 }}>{fmt(effectiveIncome)}</span>\n            {' · '}Effective rate: <span style={{ color: 'var(--accent-gold)', fontFamily: 'var(--font-mono)', fontWeight: 600 }}>{pct(baseline.taxReport.effectiveRate)}</span>\n          </div>\n        </>\n      )}\n\n      {/* ══════════════ TAB: REVERSE CALCULATOR ══════════════ */}\n      {activeTab === 'reverse' && (\n        <>\n          <div className=\"card\" style={{ marginBottom: 20 }}>\n            <div className=\"card-body\" style={{ padding: '24px 28px', textAlign: 'center' }}>\n              <div style={{ fontSize: 13, color: 'var(--text-muted)', marginBottom: 16 }}>\n                <Target size={16} style={{ verticalAlign: 'middle', marginRight: 6 }} />\n                How much do you need to <strong style={{ color: 'var(--accent-gold)' }}>earn</strong> to <strong style={{ color: 'var(--accent-emerald)' }}>keep</strong>...\n              </div>\n\n              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 12, marginBottom: 20 }}>\n                <span style={{ fontSize: 32, fontFamily: 'var(--font-mono)', color: 'var(--accent-emerald)', fontWeight: 700 }}>$</span>\n                <input\n                  type=\"number\"\n                  value={reverseTarget}\n                  onChange={e => setReverseTarget(parseInt(e.target.value) || 0)}\n                  style={{\n                    fontSize: 32, fontFamily: 'var(--font-mono)', fontWeight: 700, color: 'var(--accent-emerald)',\n                    background: 'transparent', border: 'none', borderBottom: '2px solid var(--accent-emerald)',\n                    outline: 'none', width: 220, textAlign: 'center',\n                  }}\n                />\n                <span style={{ fontSize: 14, color: 'var(--text-muted)' }}>after taxes</span>\n              </div>\n\n              <input\n                type=\"range\"\n                min={25000} max={500000} step={5000}\n                value={reverseTarget}\n                onChange={e => setReverseTarget(parseInt(e.target.value))}\n                style={{\n                  width: '80%', height: 6, appearance: 'none', borderRadius: 3,\n                  background: `linear-gradient(to right, var(--accent-emerald) ${((reverseTarget - 25000) / 475000) * 100}%, var(--bg-surface) 0%)`,\n                  cursor: 'pointer', outline: 'none', marginBottom: 24,\n                }}\n              />\n\n              {/* Results */}\n              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 16, maxWidth: 600, margin: '0 auto' }}>\n                <ResultBox label=\"You Must Earn\" value={fmt(reverseResult.requiredGrossIncome)} color=\"var(--accent-gold)\" size={22} />\n                <ResultBox label=\"Tax Bill\" value={fmt(reverseResult.totalTaxAtTarget)} color=\"var(--accent-red)\" size={22} />\n                <ResultBox label=\"Effective Rate\" value={pct(reverseResult.effectiveRateAtTarget)} color=\"var(--accent-amber)\" size={22} />\n              </div>\n\n              <div style={{ marginTop: 20, padding: 16, background: 'var(--bg-surface)', borderRadius: 12, maxWidth: 500, margin: '20px auto 0' }}>\n                <div style={{ fontSize: 12, color: 'var(--text-muted)', marginBottom: 8 }}>Translation</div>\n                <div style={{ fontSize: 14, color: 'var(--text-primary)', lineHeight: 1.6 }}>\n                  To keep <strong style={{ color: 'var(--accent-emerald)' }}>{fmt(reverseTarget)}</strong> after all taxes,\n                  you need to gross <strong style={{ color: 'var(--accent-gold)' }}>{fmt(reverseResult.requiredGrossIncome)}</strong>.\n                  The government takes <strong style={{ color: 'var(--accent-red)' }}>{fmt(reverseResult.totalTaxAtTarget)}</strong> ({pct(reverseResult.effectiveRateAtTarget)}).\n                  Your next dollar is taxed at <strong style={{ color: 'var(--accent-amber)' }}>{pct(reverseResult.marginalRateAtTarget)}</strong>.\n                </div>\n              </div>\n\n              {/* Quick presets */}\n              <div style={{ display: 'flex', gap: 8, justifyContent: 'center', marginTop: 16 }}>\n                {[50000, 75000, 100000, 150000, 200000, 300000].map(t => (\n                  <button key={t} onClick={() => setReverseTarget(t)}\n                    style={{\n                      padding: '5px 12px', borderRadius: 8,\n                      border: reverseTarget === t ? '1px solid var(--accent-emerald)' : '1px solid var(--border-subtle)',\n                      background: reverseTarget === t ? 'rgba(16,185,129,0.1)' : 'transparent',\n                      color: reverseTarget === t ? 'var(--accent-emerald)' : 'var(--text-muted)',\n                      cursor: 'pointer', fontSize: 11, fontFamily: 'var(--font-mono)',\n                    }}>\n                    {fmtK(t)}\n                  </button>\n                ))}\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n    </div>\n  )\n}\n\n// ─── Sub-Components ──────────────────────────────────────────────\n\nfunction WaterfallCard({ title, data, report }: { title: string; data: ReturnType<typeof generateWaterfall>; report: any }) {\n  const maxVal = data[0]?.cumulative || 1\n\n  return (\n    <div className=\"card\">\n      <div className=\"card-header\" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\n        <span className=\"card-title\">{title}</span>\n        <span style={{ fontFamily: 'var(--font-mono)', fontSize: 12, color: 'var(--accent-emerald)' }}>Net: {fmt(report.afterTaxIncome)}</span>\n      </div>\n      <div className=\"card-body\" style={{ padding: '12px 18px' }}>\n        {data.map((seg, i) => {\n          const barWidth = Math.max(3, (Math.abs(seg.amount) / maxVal) * 100)\n          const isLast = i === data.length - 1\n          return (\n            <div key={i} style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 6 }}>\n              <div style={{ width: 90, fontSize: 11, color: 'var(--text-muted)', textAlign: 'right', flexShrink: 0 }}>{seg.label}</div>\n              <div style={{ flex: 1, position: 'relative', height: 22 }}>\n                <div style={{\n                  position: 'absolute',\n                  left: isLast ? 0 : `${(seg.cumulative / maxVal) * 100}%`,\n                  width: isLast ? `${(seg.amount / maxVal) * 100}%` : `${barWidth}%`,\n                  height: '100%',\n                  background: seg.color,\n                  borderRadius: 4,\n                  opacity: 0.85,\n                  transform: seg.amount < 0 && !isLast ? `translateX(-${barWidth}%)` : undefined,\n                  transition: 'all 0.3s ease',\n                }} />\n              </div>\n              <div style={{ width: 75, fontSize: 11, fontFamily: 'var(--font-mono)', color: seg.type === 'net' ? 'var(--accent-emerald)' : seg.type === 'tax' ? 'var(--accent-red)' : seg.type === 'deduction' ? 'var(--accent-amber)' : 'var(--text-primary)', textAlign: 'right', fontWeight: isLast ? 600 : 400 }}>\n                {seg.amount >= 0 ? '+' : ''}{fmtK(seg.amount)}\n              </div>\n            </div>\n          )\n        })}\n      </div>\n    </div>\n  )\n}\n\nfunction ConfigSlider({ label, value, min, max, step, format, onChange }: {\n  label: string; value: number; min: number; max: number; step: number; format: (v: number) => string; onChange: (v: number) => void\n}) {\n  return (\n    <div>\n      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 6 }}>\n        <span style={{ fontSize: 11, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.06em' }}>{label}</span>\n        <span style={{ fontSize: 13, fontFamily: 'var(--font-mono)', color: 'var(--accent-gold)', fontWeight: 600 }}>{format(value)}</span>\n      </div>\n      <input\n        type=\"range\" min={min} max={max} step={step} value={value}\n        onChange={e => onChange(parseFloat(e.target.value))}\n        style={{\n          width: '100%', height: 4, appearance: 'none', borderRadius: 2,\n          background: `linear-gradient(to right, var(--accent-gold) ${((value - min) / (max - min)) * 100}%, var(--bg-surface) 0%)`,\n          cursor: 'pointer', outline: 'none',\n        }}\n      />\n    </div>\n  )\n}\n\nfunction ResultBox({ label, value, color, size = 18 }: { label: string; value: string; color: string; size?: number }) {\n  return (\n    <div style={{ padding: 16, background: 'var(--bg-surface)', borderRadius: 12, border: `1px solid ${color}22` }}>\n      <div style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.08em', marginBottom: 6 }}>{label}</div>\n      <div style={{ fontFamily: 'var(--font-mono)', fontSize: size, fontWeight: 700, color }}>{value}</div>\n    </div>\n  )\n}\n\nfunction EmptyPrompt({ message }: { message: string }) {\n  return (\n    <div style={{\n      textAlign: 'center', padding: 48, background: 'var(--bg-elevated)', borderRadius: 14,\n      border: '1px dashed var(--border-medium)',\n    }}>\n      <BarChart3 size={28} color=\"var(--text-muted)\" style={{ marginBottom: 12 }} />\n      <div style={{ fontSize: 14, color: 'var(--text-secondary)', marginBottom: 4 }}>{message}</div>\n      <div style={{ fontSize: 12, color: 'var(--text-muted)' }}>Toggle scenarios above, or build a custom one</div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\StateArbitrage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'StateComparison' is defined but never used.","line":3,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":53,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"StateComparison"},"fix":{"range":[121,143],"text":""},"desc":"Remove unused variable \"StateComparison\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TrendingUp' is defined but never used.","line":5,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":21,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TrendingUp"},"fix":{"range":[196,208],"text":""},"desc":"Remove unused variable \"TrendingUp\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TrendingDown' is defined but never used.","line":5,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":35,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TrendingDown"},"fix":{"range":[208,222],"text":""},"desc":"Remove unused variable \"TrendingDown\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ArrowRight' is defined but never used.","line":5,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":47,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ArrowRight"},"fix":{"range":[222,234],"text":""},"desc":"Remove unused variable \"ArrowRight\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Filter' is defined but never used.","line":5,"column":49,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":55,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Filter"},"fix":{"range":[234,242],"text":""},"desc":"Remove unused variable \"Filter\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ChevronDown' is defined but never used.","line":6,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":14,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ChevronDown"},"fix":{"range":[242,257],"text":""},"desc":"Remove unused variable \"ChevronDown\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DollarSign' is defined but never used.","line":6,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":32,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DollarSign"},"fix":{"range":[263,275],"text":""},"desc":"Remove unused variable \"DollarSign\"."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { analyzeStateArbitrage, type StateComparison } from '../engine/state-arbitrage'\nimport {\n  MapPin, TrendingUp, TrendingDown, ArrowRight, Filter,\n  ChevronDown, Star, DollarSign,\n} from 'lucide-react'\n\ntype SortKey = 'adjustedSavings' | 'totalStateTax' | 'costOfLivingIndex' | 'estimatedIncomeTax'\n\nexport function StateArbitrage() {\n  const { state } = useFortuna()\n  const [spending, setSpending] = useState(60000)\n  const [homeValue, setHomeValue] = useState(300000)\n  const [sortBy, setSortBy] = useState<SortKey>('adjustedSavings')\n  const [showAll, setShowAll] = useState(false)\n  const [filter, setFilter] = useState<'all' | 'no_income_tax' | 'low_col'>('all')\n\n  const analysis = useMemo(() => analyzeStateArbitrage(state, spending, homeValue), [state, spending, homeValue])\n\n  let filtered = [...analysis.comparisons]\n  if (filter === 'no_income_tax') filtered = filtered.filter(c => c.incomeTaxType === 'None')\n  if (filter === 'low_col') filtered = filtered.filter(c => c.costOfLivingIndex < 100)\n\n  filtered.sort((a, b) => {\n    if (sortBy === 'adjustedSavings') return b.adjustedSavings - a.adjustedSavings\n    if (sortBy === 'totalStateTax') return a.totalStateTax - b.totalStateTax\n    if (sortBy === 'costOfLivingIndex') return a.costOfLivingIndex - b.costOfLivingIndex\n    if (sortBy === 'estimatedIncomeTax') return a.estimatedIncomeTax - b.estimatedIncomeTax\n    return 0\n  })\n\n  const displayed = showAll ? filtered : filtered.slice(0, 15)\n\n  const card: React.CSSProperties = { background: 'var(--bg-elevated)', border: '1px solid var(--border-subtle)', borderRadius: 14, padding: 24 }\n  const inputStyle: React.CSSProperties = {\n    padding: '8px 12px', borderRadius: 8, border: '1px solid var(--border-medium)',\n    background: 'var(--bg-surface)', color: 'var(--text-primary)',\n    fontFamily: 'var(--font-mono)', fontSize: 13, width: 130,\n  }\n  const filterBtn = (active: boolean): React.CSSProperties => ({\n    padding: '6px 12px', borderRadius: 6, border: 'none',\n    background: active ? 'var(--accent-gold-dim)' : 'var(--bg-surface)',\n    color: active ? 'var(--accent-gold)' : 'var(--text-muted)',\n    cursor: 'pointer', fontSize: 11, fontWeight: 500,\n  })\n\n  return (\n    <div style={{ padding: '32px 40px', maxWidth: 1100 }}>\n      <div style={{ marginBottom: 24 }}>\n        <h1 style={{ fontFamily: 'var(--font-display)', fontSize: 26, color: 'var(--text-primary)', marginBottom: 6 }}>\n          State Tax Arbitrage\n        </h1>\n        <p style={{ fontSize: 13, color: 'var(--text-muted)', lineHeight: 1.5 }}>\n          Compare total state tax burden across all states. Identifies optimal relocation targets for remote workers and location-flexible earners.\n        </p>\n      </div>\n\n      {/* Current state card */}\n      <div style={{\n        ...card,\n        background: 'linear-gradient(135deg, rgba(212,168,67,0.06), rgba(212,168,67,0.02))',\n        border: '1px solid rgba(212,168,67,0.15)',\n        marginBottom: 20,\n      }}>\n        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: 16 }}>\n          <div>\n            <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 8 }}>\n              <MapPin size={16} color=\"var(--accent-gold)\" />\n              <span style={{ fontSize: 14, fontWeight: 500, color: 'var(--text-primary)' }}>\n                Current: {analysis.currentState.name}\n              </span>\n            </div>\n            <div style={{ display: 'flex', gap: 20 }}>\n              <div>\n                <div style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase' }}>Total State Tax</div>\n                <div style={{ fontFamily: 'var(--font-mono)', fontSize: 22, fontWeight: 600, color: 'var(--accent-red)' }}>\n                  ${analysis.currentState.totalStateTax.toLocaleString()}\n                </div>\n              </div>\n              <div>\n                <div style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase' }}>Income Tax</div>\n                <div style={{ fontFamily: 'var(--font-mono)', fontSize: 16, color: 'var(--text-primary)' }}>\n                  ${analysis.currentState.estimatedIncomeTax.toLocaleString()}\n                </div>\n              </div>\n              <div>\n                <div style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase' }}>Property Tax</div>\n                <div style={{ fontFamily: 'var(--font-mono)', fontSize: 16, color: 'var(--text-primary)' }}>\n                  ${analysis.currentState.estimatedPropertyTax.toLocaleString()}\n                </div>\n              </div>\n              <div>\n                <div style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase' }}>COL Index</div>\n                <div style={{ fontFamily: 'var(--font-mono)', fontSize: 16, color: 'var(--text-primary)' }}>\n                  {analysis.currentState.costOfLivingIndex}\n                </div>\n              </div>\n            </div>\n          </div>\n          <div>\n            {analysis.bestOverall.code !== analysis.currentState.code && (\n              <div style={{ textAlign: 'right' }}>\n                <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>Best alternative</div>\n                <div style={{ fontSize: 14, fontWeight: 500, color: 'var(--accent-emerald)' }}>\n                  {analysis.bestOverall.name}: Save ${analysis.bestOverall.adjustedSavings.toLocaleString()}/yr\n                </div>\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n\n      {/* Top recommendations */}\n      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: 12, marginBottom: 20 }}>\n        {analysis.topRecommendations.slice(0, 4).map((rec, i) => (\n          <div key={rec.code} style={{\n            ...card,\n            padding: 16,\n            borderLeft: `3px solid ${i === 0 ? 'var(--accent-gold)' : i === 1 ? 'var(--accent-emerald)' : 'var(--accent-blue)'}`,\n          }}>\n            <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 8 }}>\n              {i === 0 && <Star size={12} color=\"var(--accent-gold)\" />}\n              <span style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)' }}>{rec.name}</span>\n            </div>\n            <div style={{ fontFamily: 'var(--font-mono)', fontSize: 18, fontWeight: 600, color: 'var(--accent-emerald)', marginBottom: 4 }}>\n              +${rec.adjustedSavings.toLocaleString()}\n            </div>\n            <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>\n              {rec.incomeTaxType} · COL {rec.costOfLivingIndex}\n            </div>\n          </div>\n        ))}\n      </div>\n\n      {/* Controls */}\n      <div style={{ ...card, display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: 12, marginBottom: 20, padding: 16 }}>\n        <div style={{ display: 'flex', gap: 16, alignItems: 'flex-end' }}>\n          <div>\n            <label style={{ fontSize: 10, color: 'var(--text-muted)', display: 'block', marginBottom: 4 }}>Annual Spending</label>\n            <input type=\"number\" value={spending} onChange={e => setSpending(Number(e.target.value))} style={inputStyle} />\n          </div>\n          <div>\n            <label style={{ fontSize: 10, color: 'var(--text-muted)', display: 'block', marginBottom: 4 }}>Home Value</label>\n            <input type=\"number\" value={homeValue} onChange={e => setHomeValue(Number(e.target.value))} style={inputStyle} />\n          </div>\n        </div>\n        <div style={{ display: 'flex', gap: 4 }}>\n          <button style={filterBtn(filter === 'all')} onClick={() => setFilter('all')}>All States</button>\n          <button style={filterBtn(filter === 'no_income_tax')} onClick={() => setFilter('no_income_tax')}>No Income Tax</button>\n          <button style={filterBtn(filter === 'low_col')} onClick={() => setFilter('low_col')}>Low COL</button>\n        </div>\n      </div>\n\n      {/* Comparison table */}\n      <div style={{ ...card, padding: 0, overflow: 'hidden' }}>\n        <div style={{ overflowX: 'auto' }}>\n          <table style={{ width: '100%', borderCollapse: 'collapse', fontFamily: 'var(--font-body)', fontSize: 12 }}>\n            <thead>\n              <tr style={{ borderBottom: '1px solid var(--border-subtle)', background: 'var(--bg-primary)' }}>\n                {[\n                  { key: 'rank', label: '#', sortable: false },\n                  { key: 'name', label: 'State', sortable: false },\n                  { key: 'estimatedIncomeTax', label: 'Income Tax', sortable: true },\n                  { key: 'estimatedSalesTax', label: 'Sales Tax', sortable: false },\n                  { key: 'estimatedPropertyTax', label: 'Property Tax', sortable: false },\n                  { key: 'totalStateTax', label: 'Total Tax', sortable: true },\n                  { key: 'adjustedSavings', label: 'Net Savings (COL adj)', sortable: true },\n                  { key: 'costOfLivingIndex', label: 'COL', sortable: true },\n                  { key: 'incomeTaxType', label: 'Type', sortable: false },\n                ].map(col => (\n                  <th\n                    key={col.key}\n                    onClick={() => col.sortable && setSortBy(col.key as SortKey)}\n                    style={{\n                      padding: '10px 12px', textAlign: col.key === 'name' ? 'left' : 'right',\n                      color: sortBy === col.key ? 'var(--accent-gold)' : 'var(--text-muted)',\n                      fontWeight: 500, fontSize: 11, cursor: col.sortable ? 'pointer' : 'default',\n                      whiteSpace: 'nowrap',\n                    }}\n                  >\n                    {col.label}\n                    {sortBy === col.key && ' ▾'}\n                  </th>\n                ))}\n              </tr>\n            </thead>\n            <tbody>\n              {displayed.map((c, i) => {\n                const isCurrent = c.code === analysis.currentState.code\n                return (\n                  <tr key={c.code} style={{\n                    borderBottom: '1px solid var(--border-subtle)',\n                    background: isCurrent ? 'var(--accent-gold)08' : i % 2 === 0 ? 'transparent' : 'var(--bg-primary)',\n                  }}>\n                    <td style={{ padding: '10px 12px', textAlign: 'right', color: 'var(--text-muted)', fontFamily: 'var(--font-mono)' }}>{c.rank}</td>\n                    <td style={{ padding: '10px 12px', fontWeight: isCurrent ? 600 : 400, color: isCurrent ? 'var(--accent-gold)' : 'var(--text-primary)' }}>\n                      {c.name} {isCurrent && '(current)'}\n                    </td>\n                    <td style={{ padding: '10px 12px', textAlign: 'right', fontFamily: 'var(--font-mono)', color: c.estimatedIncomeTax === 0 ? 'var(--accent-emerald)' : 'var(--text-secondary)' }}>\n                      {c.estimatedIncomeTax === 0 ? '—' : `$${c.estimatedIncomeTax.toLocaleString()}`}\n                    </td>\n                    <td style={{ padding: '10px 12px', textAlign: 'right', fontFamily: 'var(--font-mono)', color: 'var(--text-muted)' }}>\n                      ${c.estimatedSalesTax.toLocaleString()}\n                    </td>\n                    <td style={{ padding: '10px 12px', textAlign: 'right', fontFamily: 'var(--font-mono)', color: 'var(--text-muted)' }}>\n                      ${c.estimatedPropertyTax.toLocaleString()}\n                    </td>\n                    <td style={{ padding: '10px 12px', textAlign: 'right', fontFamily: 'var(--font-mono)', fontWeight: 500, color: 'var(--text-primary)' }}>\n                      ${c.totalStateTax.toLocaleString()}\n                    </td>\n                    <td style={{\n                      padding: '10px 12px', textAlign: 'right', fontFamily: 'var(--font-mono)', fontWeight: 600,\n                      color: c.adjustedSavings > 0 ? 'var(--accent-emerald)' : c.adjustedSavings < 0 ? 'var(--accent-red)' : 'var(--text-muted)',\n                    }}>\n                      {c.adjustedSavings > 0 ? '+' : ''}{c.adjustedSavings === 0 ? '—' : `$${c.adjustedSavings.toLocaleString()}`}\n                    </td>\n                    <td style={{\n                      padding: '10px 12px', textAlign: 'right', fontFamily: 'var(--font-mono)',\n                      color: c.costOfLivingIndex < 95 ? 'var(--accent-emerald)' : c.costOfLivingIndex > 110 ? 'var(--accent-red)' : 'var(--text-muted)',\n                    }}>\n                      {c.costOfLivingIndex}\n                    </td>\n                    <td style={{ padding: '10px 12px', textAlign: 'right', fontSize: 11, color: c.incomeTaxType === 'None' ? 'var(--accent-emerald)' : 'var(--text-muted)' }}>\n                      {c.incomeTaxType}\n                    </td>\n                  </tr>\n                )\n              })}\n            </tbody>\n          </table>\n        </div>\n        {!showAll && filtered.length > 15 && (\n          <div style={{ padding: 12, textAlign: 'center' }}>\n            <button\n              onClick={() => setShowAll(true)}\n              style={{\n                background: 'none', border: 'none', color: 'var(--accent-gold)',\n                cursor: 'pointer', fontSize: 12, fontWeight: 500,\n              }}\n            >\n              Show all {filtered.length} states ▾\n            </button>\n          </div>\n        )}\n      </div>\n\n      {/* Disclaimer */}\n      <div style={{ marginTop: 16, fontSize: 11, color: 'var(--text-muted)', lineHeight: 1.6 }}>\n        * Estimates based on simplified tax models. Income tax uses effective rates approximated from marginal brackets.\n        Sales tax assumes ~35% of annual spending on taxable goods. Property tax based on state average effective rates.\n        Cost of living adjustments based on BLS composite indices. Consult a tax professional before making relocation decisions.\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\TaxCalendar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TaxDeadline' is defined but never used.","line":3,"column":51,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":62,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TaxDeadline"},"fix":{"range":[134,152],"text":""},"desc":"Remove unused variable \"TaxDeadline\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AlertTriangle' is defined but never used.","line":4,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":40,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AlertTriangle"},"fix":{"range":[219,234],"text":""},"desc":"Remove unused variable \"AlertTriangle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'CheckCircle' is defined but never used.","line":4,"column":42,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":53,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CheckCircle"},"fix":{"range":[234,247],"text":""},"desc":"Remove unused variable \"CheckCircle\"."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'estPayments' logical expression could make the dependencies of useMemo Hook (at line 41) change on every render. Move it inside the useMemo callback. Alternatively, wrap the initialization of 'estPayments' in its own useMemo() Hook.","line":16,"column":9,"nodeType":"VariableDeclarator","endLine":16,"endColumn":52},{"ruleId":"react-hooks/preserve-manual-memoization","severity":2,"message":"Compilation Skipped: Existing memoization could not be preserved\n\nReact Compiler has skipped optimizing this component because the existing manual memoization could not be preserved. This value was memoized in source but not in compilation output.\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\TaxCalendar.tsx:18:21\n  16 |   const estPayments = state.estimatedPayments || []\n  17 |   \n> 18 |   const deadlines = useMemo(() => {\n     |                     ^^^^^^^^^^^^^^^\n> 19 |     const current = getTaxDeadlines(state, year)\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 20 |     const next = getTaxDeadlines(state, year + 1)\n     …\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 40 |     return enriched.sort((a, b) => a.date.localeCompare(b.date))\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n> 41 |   }, [state, year, estPayments])\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ Could not preserve existing memoization\n  42 |   \n  43 |   const upcoming = deadlines.filter(d => {\n  44 |     const dd = new Date(d.date)","line":18,"column":21,"nodeType":null,"endLine":41,"endColumn":33},{"ruleId":"react-hooks/preserve-manual-memoization","severity":2,"message":"Compilation Skipped: Existing memoization could not be preserved\n\nReact Compiler has skipped optimizing this component because the existing manual memoization could not be preserved. This dependency may be mutated later, which could cause the value to change unexpectedly.\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\TaxCalendar.tsx:41:14\n  39 |     })\n  40 |     return enriched.sort((a, b) => a.date.localeCompare(b.date))\n> 41 |   }, [state, year, estPayments])\n     |              ^^^^ This dependency may be modified later\n  42 |   \n  43 |   const upcoming = deadlines.filter(d => {\n  44 |     const dd = new Date(d.date)","line":41,"column":14,"nodeType":null,"endLine":41,"endColumn":18}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMemo, useState } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { getTaxDeadlines, getQuarterContext, type TaxDeadline } from '../engine/proactive-intelligence'\nimport { Calendar, Clock, AlertTriangle, CheckCircle, ChevronDown, ChevronUp } from 'lucide-react'\n\nexport function TaxCalendar() {\n  const { state } = useFortuna()\n  const [expandedId, setExpandedId] = useState<string | null>(null)\n  const [showPast, setShowPast] = useState(false)\n  \n  const now = new Date()\n  const ctx = getQuarterContext(now)\n  const year = now.getFullYear()\n\n  // Cross-reference estimated payments from metamodel\n  const estPayments = state.estimatedPayments || []\n  \n  const deadlines = useMemo(() => {\n    const current = getTaxDeadlines(state, year)\n    const next = getTaxDeadlines(state, year + 1)\n    // Enrich payment deadlines with actual paid amounts from estimatedPayments[]\n    const enriched = [...current, ...next].map(d => {\n      if (d.category === 'payment' && d.date) {\n        const match = estPayments.find(ep =>\n          ep.dueDate === d.date || (ep.quarter && d.title?.toLowerCase().includes(`q${ep.quarter}`))\n        )\n        if (match) {\n          const paid = match.paidAmount || 0\n          const owed = match.amount || 0\n          const status = paid >= owed ? 'paid' : paid > 0 ? 'partial' : 'unpaid'\n          return {\n            ...d,\n            description: `${d.description} | ${status === 'paid' ? 'PAID' : status === 'partial' ? `PARTIAL: $${paid.toLocaleString()} of $${owed.toLocaleString()}` : `DUE: $${owed.toLocaleString()}`}`,\n            _paymentStatus: status,\n          }\n        }\n      }\n      return { ...d, _paymentStatus: undefined as string | undefined }\n    })\n    return enriched.sort((a, b) => a.date.localeCompare(b.date))\n  }, [state, year, estPayments])\n  \n  const upcoming = deadlines.filter(d => {\n    const dd = new Date(d.date)\n    const diff = Math.ceil((dd.getTime() - now.getTime()) / 86400000)\n    return diff >= -7 // include recent past (1 week)\n  })\n  \n  const past = deadlines.filter(d => {\n    const dd = new Date(d.date)\n    return dd < now && Math.ceil((now.getTime() - dd.getTime()) / 86400000) > 7\n  })\n  \n  const getDaysUntil = (dateStr: string) => {\n    const d = new Date(dateStr)\n    return Math.ceil((d.getTime() - now.getTime()) / 86400000)\n  }\n  \n  const getUrgencyColor = (days: number) => {\n    if (days < 0) return 'var(--text-muted)'\n    if (days <= 7) return 'var(--accent-red)'\n    if (days <= 30) return 'var(--accent-gold)'\n    if (days <= 90) return 'var(--accent-blue, #60a5fa)'\n    return 'var(--accent-emerald)'\n  }\n  \n  const getUrgencyBg = (days: number) => {\n    if (days < 0) return 'rgba(255,255,255,0.02)'\n    if (days <= 7) return 'rgba(239,68,68,0.08)'\n    if (days <= 30) return 'rgba(212,168,67,0.08)'\n    return 'rgba(255,255,255,0.03)'\n  }\n  \n  const categoryIcons: Record<string, string> = {\n    filing: '📋', payment: '💰', election: '📝', extension: '⏳', contribution: '🏦',\n  }\n  \n  return (\n    <div style={{ padding: 32, maxWidth: 900 }}>\n      {/* Header */}\n      <div style={{ marginBottom: 32 }}>\n        <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 8 }}>\n          <Calendar size={24} style={{ color: 'var(--accent-gold)' }} />\n          <h1 style={{ fontFamily: 'var(--font-display)', fontSize: 28, color: 'var(--text-primary)', margin: 0 }}>\n            Tax Calendar\n          </h1>\n        </div>\n        <p style={{ color: 'var(--text-muted)', fontSize: 14, margin: 0 }}>\n          {ctx.quarterSummary || `Q${ctx.quarter} • ${ctx.daysLeftInYear} days left in ${year}`}\n        </p>\n      </div>\n      \n      {/* Quarter Progress */}\n      <div style={{\n        display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 12, marginBottom: 32,\n      }}>\n        {[1, 2, 3, 4].map(q => {\n          const isActive = q === ctx.quarter\n          return (\n            <div key={q} style={{\n              padding: 16,\n              background: isActive ? 'var(--accent-gold-dim)' : 'var(--bg-elevated)',\n              border: `1px solid ${isActive ? 'var(--accent-gold)' : 'var(--border-subtle)'}`,\n              borderRadius: 12,\n              textAlign: 'center',\n            }}>\n              <div style={{ fontSize: 12, color: isActive ? 'var(--accent-gold)' : 'var(--text-muted)', fontWeight: 600, letterSpacing: '0.05em' }}>\n                Q{q}\n              </div>\n              <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 4 }}>\n                {['Jan–Mar', 'Apr–Jun', 'Jul–Sep', 'Oct–Dec'][q - 1]}\n              </div>\n              {isActive && (\n                <div style={{ fontSize: 11, color: 'var(--accent-gold)', marginTop: 6, fontFamily: 'var(--font-mono)' }}>\n                  {ctx.daysLeftInQuarter}d left\n                </div>\n              )}\n            </div>\n          )\n        })}\n      </div>\n      \n      {/* Upcoming Deadlines */}\n      <div style={{ marginBottom: 32 }}>\n        <div style={{ fontSize: 14, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 16, display: 'flex', alignItems: 'center', gap: 8 }}>\n          <Clock size={16} style={{ color: 'var(--accent-gold)' }} />\n          Upcoming Deadlines\n        </div>\n        \n        {upcoming.length === 0 ? (\n          <div style={{ padding: 24, background: 'var(--bg-elevated)', borderRadius: 12, textAlign: 'center', color: 'var(--text-muted)' }}>\n            No upcoming deadlines found\n          </div>\n        ) : (\n          <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>\n            {upcoming.map(deadline => {\n              const days = getDaysUntil(deadline.date)\n              const urgencyColor = getUrgencyColor(days)\n              const isExpanded = expandedId === deadline.id\n              const isPast = days < 0\n              \n              return (\n                <div key={deadline.id} style={{\n                  background: getUrgencyBg(days),\n                  border: `1px solid ${isPast ? 'var(--border-subtle)' : urgencyColor}22`,\n                  borderRadius: 12,\n                  overflow: 'hidden',\n                  opacity: isPast ? 0.6 : 1,\n                }}>\n                  <button\n                    onClick={() => setExpandedId(isExpanded ? null : deadline.id)}\n                    style={{\n                      width: '100%', border: 'none', background: 'transparent', cursor: 'pointer',\n                      padding: '16px 20px', display: 'flex', alignItems: 'center', gap: 16, textAlign: 'left',\n                    }}\n                  >\n                    {/* Category icon */}\n                    <span style={{ fontSize: 20 }}>{categoryIcons[deadline.category] || '📅'}</span>\n                    \n                    {/* Main content */}\n                    <div style={{ flex: 1 }}>\n                      <div style={{ fontSize: 14, fontWeight: 600, color: 'var(--text-primary)' }}>\n                        {deadline.name}\n                      </div>\n                      <div style={{ fontSize: 12, color: 'var(--text-muted)', marginTop: 2 }}>\n                        {deadline.description}\n                      </div>\n                    </div>\n                    \n                    {/* Date & countdown */}\n                    <div style={{ textAlign: 'right', flexShrink: 0 }}>\n                      <div style={{ fontFamily: 'var(--font-mono)', fontSize: 13, color: 'var(--text-secondary)' }}>\n                        {new Date(deadline.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}\n                      </div>\n                      <div style={{\n                        fontSize: 12, fontWeight: 700, color: urgencyColor, marginTop: 2,\n                        fontFamily: 'var(--font-mono)',\n                      }}>\n                        {isPast ? `${Math.abs(days)}d ago` : days === 0 ? 'TODAY' : `${days}d`}\n                      </div>\n                    </div>\n                    \n                    {/* Expand toggle */}\n                    <span style={{ color: 'var(--text-muted)' }}>\n                      {isExpanded ? <ChevronUp size={16} /> : <ChevronDown size={16} />}\n                    </span>\n                  </button>\n                  \n                  {/* Expanded action items */}\n                  {isExpanded && (\n                    <div style={{\n                      padding: '0 20px 16px 56px',\n                      borderTop: '1px solid var(--border-subtle)',\n                    }}>\n                      <div style={{ fontSize: 11, fontWeight: 600, color: 'var(--text-muted)', marginTop: 12, marginBottom: 8, textTransform: 'uppercase', letterSpacing: '0.05em' }}>\n                        Action Items\n                      </div>\n                      {deadline.actionItems.map((item, i) => (\n                        <div key={i} style={{\n                          display: 'flex', alignItems: 'flex-start', gap: 8, padding: '4px 0', fontSize: 13, color: 'var(--text-secondary)',\n                        }}>\n                          <span style={{ width: 14, height: 14, border: '1.5px solid var(--border-subtle)', borderRadius: 3, flexShrink: 0, marginTop: 2 }} />\n                          {item}\n                        </div>\n                      ))}\n                      <div style={{ marginTop: 12, display: 'flex', gap: 8 }}>\n                        <span style={{\n                          padding: '3px 10px', borderRadius: 6, fontSize: 11, fontWeight: 500,\n                          background: 'var(--bg-elevated)', color: 'var(--text-muted)', border: '1px solid var(--border-subtle)',\n                        }}>\n                          {deadline.category}\n                        </span>\n                        {deadline.appliesTo.filter(a => a !== 'all').map(a => (\n                          <span key={a} style={{\n                            padding: '3px 10px', borderRadius: 6, fontSize: 11, fontWeight: 500,\n                            background: 'var(--accent-gold-dim)', color: 'var(--accent-gold)',\n                          }}>\n                            {a.replace('_', ' ')}\n                          </span>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n                </div>\n              )\n            })}\n          </div>\n        )}\n      </div>\n      \n      {/* Past deadlines toggle */}\n      {past.length > 0 && (\n        <div>\n          <button\n            onClick={() => setShowPast(!showPast)}\n            style={{\n              background: 'transparent', border: 'none', cursor: 'pointer', color: 'var(--text-muted)',\n              fontSize: 13, display: 'flex', alignItems: 'center', gap: 6, padding: '8px 0', marginBottom: 12,\n            }}\n          >\n            {showPast ? <ChevronUp size={14} /> : <ChevronDown size={14} />}\n            {past.length} past deadline{past.length > 1 ? 's' : ''}\n          </button>\n          \n          {showPast && (\n            <div style={{ display: 'flex', flexDirection: 'column', gap: 6, opacity: 0.5 }}>\n              {past.map(d => (\n                <div key={d.id} style={{\n                  padding: '12px 16px', background: 'var(--bg-elevated)', borderRadius: 8,\n                  display: 'flex', justifyContent: 'space-between', alignItems: 'center',\n                  border: '1px solid var(--border-subtle)',\n                }}>\n                  <div>\n                    <div style={{ fontSize: 13, color: 'var(--text-secondary)' }}>{d.name}</div>\n                  </div>\n                  <div style={{ fontFamily: 'var(--font-mono)', fontSize: 12, color: 'var(--text-muted)' }}>\n                    {new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\TaxCreditsView.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'CreditOptimization' is defined but never used.","line":4,"column":50,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":68,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CreditOptimization"},"fix":{"range":[171,196],"text":""},"desc":"Remove unused variable \"CreditOptimization\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TaxCreditSummary' is defined but never used.","line":4,"column":75,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":91,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TaxCreditSummary"},"fix":{"range":[196,219],"text":""},"desc":"Remove unused variable \"TaxCreditSummary\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AlertTriangle' is defined but never used.","line":6,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":39,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AlertTriangle"},"fix":{"range":[283,298],"text":""},"desc":"Remove unused variable \"AlertTriangle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ChevronRight' is defined but never used.","line":8,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":15,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ChevronRight"},"fix":{"range":[368,384],"text":""},"desc":"Remove unused variable \"ChevronRight\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'pct' is assigned a value but never used.","line":16,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":10},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'onNavigate' is defined but never used.","line":36,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":36,"endColumn":44}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport type { ViewKey } from '../App'\nimport { analyzeTaxCredits, type TaxCredit, type CreditOptimization, type TaxCreditSummary } from '../engine/tax-credits'\nimport {\n  CheckCircle2, XCircle, AlertTriangle, Lightbulb,\n  DollarSign, Users, GraduationCap, Zap, Heart, Briefcase,\n  ChevronRight, ChevronDown, ArrowUpRight,\n} from 'lucide-react'\n\ninterface TaxCreditsViewProps {\n  onNavigate: (view: ViewKey) => void\n}\n\nconst fmt = (n: number) => '$' + Math.abs(n).toLocaleString()\nconst pct = (n: number) => (n * 100).toFixed(2) + '%'\n\nconst categoryIcons: Record<string, React.ReactNode> = {\n  family: <Users size={16} />,\n  education: <GraduationCap size={16} />,\n  energy: <Zap size={16} />,\n  retirement: <DollarSign size={16} />,\n  business: <Briefcase size={16} />,\n  health: <Heart size={16} />,\n}\n\nconst categoryColors: Record<string, string> = {\n  family: 'var(--accent-purple)',\n  education: 'var(--accent-blue)',\n  energy: 'var(--accent-emerald)',\n  retirement: 'var(--accent-gold)',\n  business: 'var(--accent-amber)',\n  health: 'var(--accent-red)',\n}\n\nexport function TaxCreditsView({ onNavigate }: TaxCreditsViewProps) {\n  const { state } = useFortuna()\n  const [expandedCredit, setExpandedCredit] = useState<string | null>(null)\n  const [activeTab, setActiveTab] = useState<'credits' | 'optimizations'>('credits')\n\n  const summary = useMemo(() => analyzeTaxCredits(state), [state])\n\n  const eligibleCredits = summary.credits.filter(c => c.eligible)\n  const ineligibleCredits = summary.credits.filter(c => !c.eligible)\n\n  return (\n    <div className=\"view-container\" style={{ padding: 32 }}>\n      <div style={{ marginBottom: 24 }}>\n        <h2 className=\"view-title\" style={{ marginBottom: 4 }}>Tax Credit Optimizer</h2>\n        <p style={{ fontSize: 13, color: 'var(--text-muted)' }}>Identifies all available federal tax credits with eligibility analysis and optimization strategies</p>\n      </div>\n\n      {/* KPI Cards */}\n      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 14, marginBottom: 24 }}>\n        <div className=\"glass-card\" style={{ padding: '16px 18px' }}>\n          <div style={{ fontSize: 10, fontFamily: 'var(--font-mono)', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 6 }}>Active Credits</div>\n          <div style={{ fontSize: 22, fontWeight: 600, fontFamily: 'var(--font-mono)', color: 'var(--accent-emerald)' }}>{fmt(summary.totalCredits)}</div>\n          <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 4 }}>{eligibleCredits.length} credits qualify</div>\n        </div>\n        <div className=\"glass-card\" style={{ padding: '16px 18px' }}>\n          <div style={{ fontSize: 10, fontFamily: 'var(--font-mono)', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 6 }}>Tax Reduction</div>\n          <div style={{ fontSize: 22, fontWeight: 600, fontFamily: 'var(--font-mono)', color: 'var(--accent-gold)' }}>{fmt(summary.taxLiabilityReduction)}</div>\n          <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 4 }}>applied to liability</div>\n        </div>\n        <div className=\"glass-card\" style={{ padding: '16px 18px' }}>\n          <div style={{ fontSize: 10, fontFamily: 'var(--font-mono)', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 6 }}>Refundable</div>\n          <div style={{ fontSize: 22, fontWeight: 600, fontFamily: 'var(--font-mono)', color: 'var(--accent-purple)' }}>{fmt(summary.totalRefundable)}</div>\n          <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 4 }}>cash back potential</div>\n        </div>\n        <div className=\"glass-card\" style={{ padding: '16px 18px' }}>\n          <div style={{ fontSize: 10, fontFamily: 'var(--font-mono)', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 6 }}>Optimization Potential</div>\n          <div style={{ fontSize: 22, fontWeight: 600, fontFamily: 'var(--font-mono)', color: 'var(--accent-emerald)' }}>\n            {fmt(summary.optimizations.reduce((s, o) => s + o.additionalCredits, 0))}\n          </div>\n          <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 4 }}>{summary.optimizations.length} opportunities</div>\n        </div>\n      </div>\n\n      {/* Tabs */}\n      <div style={{ display: 'flex', gap: 4, marginBottom: 20 }}>\n        <button onClick={() => setActiveTab('credits')} className={`tab-btn ${activeTab === 'credits' ? 'active' : ''}`}\n          style={{ display: 'flex', alignItems: 'center', gap: 6, padding: '8px 16px' }}>\n          <DollarSign size={14} /> Credits ({summary.credits.length})\n        </button>\n        <button onClick={() => setActiveTab('optimizations')} className={`tab-btn ${activeTab === 'optimizations' ? 'active' : ''}`}\n          style={{ display: 'flex', alignItems: 'center', gap: 6, padding: '8px 16px' }}>\n          <Lightbulb size={14} /> Optimizations ({summary.optimizations.length})\n        </button>\n      </div>\n\n      {/* ── CREDITS TAB ── */}\n      {activeTab === 'credits' && (\n        <div>\n          {/* Eligible credits */}\n          {eligibleCredits.length > 0 && (\n            <div style={{ marginBottom: 24 }}>\n              <div style={{ fontSize: 11, fontFamily: 'var(--font-mono)', color: 'var(--accent-emerald)', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 10 }}>\n                ✓ Eligible Credits\n              </div>\n              <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>\n                {eligibleCredits.map(credit => (\n                  <CreditCard key={credit.id} credit={credit} expanded={expandedCredit === credit.id}\n                    onToggle={() => setExpandedCredit(expandedCredit === credit.id ? null : credit.id)} />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Ineligible credits */}\n          {ineligibleCredits.length > 0 && (\n            <div>\n              <div style={{ fontSize: 11, fontFamily: 'var(--font-mono)', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 10 }}>\n                Credits to Explore\n              </div>\n              <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>\n                {ineligibleCredits.map(credit => (\n                  <CreditCard key={credit.id} credit={credit} expanded={expandedCredit === credit.id}\n                    onToggle={() => setExpandedCredit(expandedCredit === credit.id ? null : credit.id)} />\n                ))}\n              </div>\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* ── OPTIMIZATIONS TAB ── */}\n      {activeTab === 'optimizations' && (\n        <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>\n          {summary.optimizations.length === 0 ? (\n            <div className=\"glass-card\" style={{ padding: 32, textAlign: 'center' }}>\n              <CheckCircle2 size={36} color=\"var(--accent-emerald)\" style={{ marginBottom: 12 }} />\n              <p style={{ color: 'var(--text-secondary)' }}>You're maximizing available credits. No additional optimizations found.</p>\n            </div>\n          ) : (\n            summary.optimizations.map((opt, i) => {\n              const diffColors: Record<string, string> = {\n                easy: 'var(--accent-emerald)', moderate: 'var(--accent-gold)', complex: 'var(--accent-purple)',\n              }\n              return (\n                <div key={i} className=\"glass-card\" style={{ padding: '18px 20px', display: 'flex', gap: 16, alignItems: 'flex-start' }}>\n                  <div style={{\n                    width: 40, height: 40, borderRadius: 12, flexShrink: 0,\n                    background: `${diffColors[opt.difficulty]}15`,\n                    display: 'flex', alignItems: 'center', justifyContent: 'center',\n                    color: diffColors[opt.difficulty],\n                  }}>\n                    <ArrowUpRight size={18} />\n                  </div>\n                  <div style={{ flex: 1 }}>\n                    <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>\n                      <span style={{ fontSize: 14, fontWeight: 500, color: 'var(--text-primary)' }}>{opt.title}</span>\n                      <span className={`badge ${opt.difficulty === 'easy' ? 'emerald' : opt.difficulty === 'moderate' ? 'gold' : 'purple'}`}>\n                        {opt.difficulty}\n                      </span>\n                    </div>\n                    <p style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.5, margin: 0 }}>{opt.description}</p>\n                  </div>\n                  <div style={{ textAlign: 'right', flexShrink: 0 }}>\n                    <div style={{ fontSize: 18, fontWeight: 600, fontFamily: 'var(--font-mono)', color: 'var(--accent-emerald)' }}>\n                      +{fmt(opt.additionalCredits)}\n                    </div>\n                    <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>potential credit</div>\n                  </div>\n                </div>\n              )\n            })\n          )}\n        </div>\n      )}\n    </div>\n  )\n}\n\n// ── Credit Card Component ──\nfunction CreditCard({ credit, expanded, onToggle }: { credit: TaxCredit; expanded: boolean; onToggle: () => void }) {\n  const color = categoryColors[credit.category] || 'var(--text-muted)'\n  const icon = categoryIcons[credit.category] || <DollarSign size={16} />\n\n  return (\n    <div className=\"glass-card\" style={{\n      padding: '16px 20px', cursor: 'pointer',\n      opacity: credit.eligible ? 1 : 0.7,\n      border: expanded ? '1px solid var(--border-glow)' : undefined,\n    }}\n    onClick={onToggle}\n    >\n      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\n        <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>\n          <div style={{\n            width: 36, height: 36, borderRadius: 10, flexShrink: 0,\n            background: `${color}15`, display: 'flex', alignItems: 'center', justifyContent: 'center',\n            color,\n          }}>{icon}</div>\n          <div>\n            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n              <span style={{ fontSize: 14, fontWeight: 500, color: 'var(--text-primary)' }}>{credit.name}</span>\n              {credit.eligible\n                ? <CheckCircle2 size={14} color=\"var(--accent-emerald)\" />\n                : <XCircle size={14} color=\"var(--text-muted)\" />\n              }\n            </div>\n            <div style={{ fontSize: 12, color: 'var(--text-secondary)', marginTop: 2 }}>{credit.eligibilityReason}</div>\n          </div>\n        </div>\n        <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>\n          {credit.eligible && credit.amount > 0 && (\n            <div style={{ textAlign: 'right' }}>\n              <div style={{ fontSize: 18, fontWeight: 600, fontFamily: 'var(--font-mono)', color: 'var(--accent-emerald)' }}>\n                {fmt(credit.amount)}\n              </div>\n              <div style={{ display: 'flex', gap: 4 }}>\n                <span className={`badge ${credit.type === 'refundable' ? 'purple' : credit.type === 'partially_refundable' ? 'gold' : 'muted'}`} style={{ fontSize: 9 }}>\n                  {credit.type.replace(/_/g, ' ')}\n                </span>\n                {credit.phaseoutApplied && <span className=\"badge amber\" style={{ fontSize: 9 }}>phaseout</span>}\n              </div>\n            </div>\n          )}\n          {!credit.eligible && credit.fullAmount > 0 && (\n            <div style={{ textAlign: 'right' }}>\n              <div style={{ fontSize: 14, fontFamily: 'var(--font-mono)', color: 'var(--text-muted)', textDecoration: 'line-through' }}>\n                {fmt(credit.fullAmount)}\n              </div>\n              <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>not eligible</div>\n            </div>\n          )}\n          <ChevronDown size={14} color=\"var(--text-muted)\" style={{\n            transform: expanded ? 'rotate(180deg)' : 'rotate(0deg)',\n            transition: 'transform 0.2s',\n          }} />\n        </div>\n      </div>\n\n      {expanded && (\n        <div style={{ marginTop: 16, paddingTop: 16, borderTop: '1px solid var(--border-subtle)' }}>\n          {credit.requirements.length > 0 && (\n            <div style={{ marginBottom: 12 }}>\n              <div style={{ fontSize: 11, fontWeight: 500, color: 'var(--text-muted)', marginBottom: 6 }}>Requirements</div>\n              {credit.requirements.map((req, i) => (\n                <div key={i} style={{ fontSize: 12, color: 'var(--text-secondary)', padding: '2px 0', display: 'flex', gap: 6 }}>\n                  <span style={{ color: 'var(--text-muted)' }}>•</span> {req}\n                </div>\n              ))}\n            </div>\n          )}\n\n          {credit.actionItems.length > 0 && (\n            <div style={{ marginBottom: 12 }}>\n              <div style={{ fontSize: 11, fontWeight: 500, color: 'var(--accent-gold)', marginBottom: 6 }}>Action Items</div>\n              {credit.actionItems.map((item, i) => (\n                <div key={i} style={{ fontSize: 12, color: 'var(--text-primary)', padding: '2px 0', display: 'flex', gap: 6 }}>\n                  <span style={{ color: 'var(--accent-gold)' }}>→</span> {item}\n                </div>\n              ))}\n            </div>\n          )}\n\n          {credit.notes.length > 0 && (\n            <div style={{\n              padding: 12, borderRadius: 8, background: 'var(--bg-surface)',\n              fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.5,\n            }}>\n              {credit.notes.map((n, i) => (\n                <div key={i} style={{ padding: '2px 0' }}>{n}</div>\n              ))}\n            </div>\n          )}\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\TaxDocuments.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'EstimatedPaymentVoucher' is defined but never used.","line":8,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":31,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"EstimatedPaymentVoucher"},"fix":{"range":[196,228],"text":""},"desc":"Remove unused variable \"EstimatedPaymentVoucher\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'EntityFormationChecklist' is defined but never used.","line":9,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":32,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"EntityFormationChecklist"},"fix":{"range":[228,261],"text":""},"desc":"Remove unused variable \"EntityFormationChecklist\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ScheduleCWorksheet' is defined but never used.","line":10,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":26,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ScheduleCWorksheet"},"fix":{"range":[261,288],"text":""},"desc":"Remove unused variable \"ScheduleCWorksheet\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AuditDocItem' is defined but never used.","line":11,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":20,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AuditDocItem"},"fix":{"range":[288,309],"text":""},"desc":"Remove unused variable \"AuditDocItem\"."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport {\n  generate1040ES,\n  generateFormationChecklist,\n  generateScheduleC,\n  generateAuditDocChecklist,\n  type EstimatedPaymentVoucher,\n  type EntityFormationChecklist,\n  type ScheduleCWorksheet,\n  type AuditDocItem,\n} from '../engine/tax-documents'\nimport {\n  FileText, Building2, Calculator, Shield, ChevronDown,\n  Download, Copy, CheckCircle, ExternalLink, AlertTriangle,\n  ClipboardCheck,\n} from 'lucide-react'\n\ntype DocTab = 'vouchers' | 'formation' | 'schedule-c' | 'audit-docs'\n\nexport function TaxDocuments() {\n  const { state } = useFortuna()\n  const [activeTab, setActiveTab] = useState<DocTab>('vouchers')\n  const [expandedVoucher, setExpandedVoucher] = useState<number | null>(null)\n  const [expandedStep, setExpandedStep] = useState<number | null>(null)\n  const [copyFeedback, setCopyFeedback] = useState('')\n  const [formationType, setFormationType] = useState<'llc' | 'llc_scorp' | 'scorp' | 'ccorp'>('llc_scorp')\n\n  // Generate documents\n  const estimatedPayments = useMemo(() => generate1040ES(state), [state])\n  const formation = useMemo(() => generateFormationChecklist(formationType, state.profile.state), [formationType, state.profile.state])\n  const scheduleC = useMemo(() => generateScheduleC(state), [state])\n  const auditDocs = useMemo(() => generateAuditDocChecklist(state), [state])\n\n  const hasSEIncome = state.incomeStreams.some(s => ['business', 'freelance'].includes(s.type) && s.isActive)\n\n  // Copy helper\n  const copyText = async (text: string, label: string) => {\n    try {\n      await navigator.clipboard.writeText(text)\n      setCopyFeedback(label)\n      setTimeout(() => setCopyFeedback(''), 2000)\n    } catch { /* fallback */ }\n  }\n\n  // Download helper\n  const downloadText = (text: string, filename: string) => {\n    const blob = new Blob([text], { type: 'text/plain' })\n    const url = URL.createObjectURL(blob)\n    const a = document.createElement('a')\n    a.href = url\n    a.download = filename\n    a.click()\n    URL.revokeObjectURL(url)\n  }\n\n  // Styles\n  const card: React.CSSProperties = {\n    background: 'var(--bg-elevated)', border: '1px solid var(--border-subtle)',\n    borderRadius: 14, padding: 24,\n  }\n  const tabBtn = (active: boolean): React.CSSProperties => ({\n    padding: '8px 16px', borderRadius: 8, border: 'none',\n    background: active ? 'var(--accent-gold-dim)' : 'transparent',\n    color: active ? 'var(--accent-gold)' : 'var(--text-muted)',\n    cursor: 'pointer', fontFamily: 'var(--font-body)', fontSize: 13,\n    fontWeight: active ? 600 : 400, transition: 'all 0.2s',\n    display: 'flex', alignItems: 'center', gap: 6,\n  })\n  const actionBtn: React.CSSProperties = {\n    display: 'inline-flex', alignItems: 'center', gap: 6,\n    padding: '7px 14px', borderRadius: 8,\n    border: '1px solid var(--border-subtle)',\n    background: 'var(--bg-surface)', color: 'var(--text-secondary)',\n    cursor: 'pointer', fontFamily: 'var(--font-body)', fontSize: 12,\n    transition: 'all 0.2s',\n  }\n\n  return (\n    <div style={{ padding: '32px 40px', maxWidth: 960 }}>\n      {/* Header */}\n      <div style={{ marginBottom: 24 }}>\n        <h1 style={{ fontFamily: 'var(--font-display)', fontSize: 26, color: 'var(--text-primary)', marginBottom: 6 }}>\n          Tax Documents\n        </h1>\n        <p style={{ fontSize: 13, color: 'var(--text-muted)', lineHeight: 1.5 }}>\n          Ready-to-use tax worksheets, payment vouchers, and formation checklists generated from your financial data.\n        </p>\n      </div>\n\n      {/* Tabs */}\n      <div style={{ display: 'flex', gap: 4, marginBottom: 24, flexWrap: 'wrap' }}>\n        <button style={tabBtn(activeTab === 'vouchers')} onClick={() => setActiveTab('vouchers')}>\n          <Calculator size={14} /> 1040-ES Vouchers\n        </button>\n        <button style={tabBtn(activeTab === 'formation')} onClick={() => setActiveTab('formation')}>\n          <Building2 size={14} /> Formation Checklist\n        </button>\n        {hasSEIncome && (\n          <button style={tabBtn(activeTab === 'schedule-c')} onClick={() => setActiveTab('schedule-c')}>\n            <FileText size={14} /> Schedule C Draft\n          </button>\n        )}\n        <button style={tabBtn(activeTab === 'audit-docs')} onClick={() => setActiveTab('audit-docs')}>\n          <Shield size={14} /> Audit Doc Checklist\n        </button>\n      </div>\n\n      {/* ═══ 1040-ES VOUCHERS ═══ */}\n      {activeTab === 'vouchers' && (\n        <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>\n          {/* Summary card */}\n          <div style={card}>\n            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: 12 }}>\n              <div>\n                <div style={{ fontSize: 12, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.08em', marginBottom: 4 }}>\n                  Estimated Annual Tax\n                </div>\n                <div style={{ fontFamily: 'var(--font-mono)', fontSize: 28, fontWeight: 600, color: 'var(--accent-gold)' }}>\n                  ${estimatedPayments.totalEstimated.toLocaleString()}\n                </div>\n                <div style={{ fontSize: 12, color: 'var(--text-muted)', marginTop: 4 }}>\n                  Quarterly payment: ${Math.ceil(estimatedPayments.safeHarborAmount / 4).toLocaleString()} (safe harbor)\n                </div>\n              </div>\n              <div style={{ display: 'flex', gap: 8 }}>\n                <button\n                  style={actionBtn}\n                  onClick={() => {\n                    const all = estimatedPayments.vouchers.map(v => v.formContent).join('\\n\\n')\n                    copyText(all, 'All vouchers')\n                  }}\n                >\n                  {copyFeedback === 'All vouchers' ? <CheckCircle size={13} color=\"var(--accent-emerald)\" /> : <Copy size={13} />}\n                  Copy All\n                </button>\n                <button\n                  style={actionBtn}\n                  onClick={() => {\n                    const all = estimatedPayments.vouchers.map(v => v.formContent).join('\\n\\n')\n                    downloadText(all, `1040-ES-${new Date().getFullYear()}.txt`)\n                  }}\n                >\n                  <Download size={13} /> Download\n                </button>\n              </div>\n            </div>\n          </div>\n\n          {/* Notes */}\n          {estimatedPayments.notes.length > 0 && (\n            <div style={{ padding: '12px 16px', background: 'var(--accent-blue-dim)', border: '1px solid var(--accent-blue)22', borderRadius: 10 }}>\n              {estimatedPayments.notes.map((note, i) => (\n                <div key={i} style={{ fontSize: 12, color: 'var(--accent-blue)', lineHeight: 1.6 }}>\n                  • {note}\n                </div>\n              ))}\n            </div>\n          )}\n\n          {/* Quarter cards */}\n          {estimatedPayments.vouchers.map(v => (\n            <div key={v.quarter} style={card}>\n              <button\n                onClick={() => setExpandedVoucher(expandedVoucher === v.quarter ? null : v.quarter)}\n                style={{\n                  display: 'flex', justifyContent: 'space-between', alignItems: 'center',\n                  width: '100%', background: 'none', border: 'none', cursor: 'pointer',\n                  padding: 0, fontFamily: 'var(--font-body)',\n                }}\n              >\n                <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>\n                  <div style={{\n                    width: 36, height: 36, borderRadius: 10,\n                    background: 'var(--accent-gold-dim)',\n                    display: 'flex', alignItems: 'center', justifyContent: 'center',\n                    fontFamily: 'var(--font-mono)', fontSize: 14, fontWeight: 700, color: 'var(--accent-gold)',\n                  }}>\n                    Q{v.quarter}\n                  </div>\n                  <div style={{ textAlign: 'left' }}>\n                    <div style={{ fontSize: 14, color: 'var(--text-primary)', fontWeight: 500 }}>\n                      ${v.paymentAmount.toLocaleString()}\n                    </div>\n                    <div style={{ fontSize: 12, color: 'var(--text-muted)' }}>Due {v.dueDate}</div>\n                  </div>\n                </div>\n                <ChevronDown size={16} color=\"var(--text-muted)\" style={{\n                  transition: 'transform 0.2s',\n                  transform: expandedVoucher === v.quarter ? 'rotate(180deg)' : 'rotate(0)',\n                }} />\n              </button>\n\n              {expandedVoucher === v.quarter && (\n                <div style={{ marginTop: 16 }}>\n                  <div style={{ display: 'flex', gap: 8, marginBottom: 12 }}>\n                    <button style={actionBtn} onClick={() => copyText(v.formContent, `Q${v.quarter}`)}>\n                      {copyFeedback === `Q${v.quarter}` ? <CheckCircle size={13} color=\"var(--accent-emerald)\" /> : <Copy size={13} />}\n                      Copy\n                    </button>\n                    <a\n                      href=\"https://www.irs.gov/payments\"\n                      target=\"_blank\"\n                      rel=\"noopener\"\n                      style={{ ...actionBtn, textDecoration: 'none', color: 'var(--accent-blue)' }}\n                    >\n                      <ExternalLink size={13} /> Pay Online (IRS)\n                    </a>\n                  </div>\n                  <pre style={{\n                    fontFamily: 'var(--font-mono)', fontSize: 11, lineHeight: 1.5,\n                    color: 'var(--text-secondary)', background: 'var(--bg-primary)',\n                    padding: 16, borderRadius: 10, overflow: 'auto', whiteSpace: 'pre',\n                    border: '1px solid var(--border-subtle)',\n                  }}>\n                    {v.formContent}\n                  </pre>\n                </div>\n              )}\n            </div>\n          ))}\n        </div>\n      )}\n\n      {/* ═══ FORMATION CHECKLIST ═══ */}\n      {activeTab === 'formation' && (\n        <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>\n          {/* Entity type selector */}\n          <div style={{ ...card, display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: 12 }}>\n            <div>\n              <div style={{ fontSize: 14, color: 'var(--text-primary)', fontWeight: 500 }}>\n                {formation.entityType} in {formation.stateName}\n              </div>\n              <div style={{ fontSize: 12, color: 'var(--text-muted)', marginTop: 2 }}>\n                Est. cost: {formation.totalEstimatedCost} · Timeline: {formation.totalTimeline}\n              </div>\n            </div>\n            <div style={{ display: 'flex', gap: 4 }}>\n              {(['llc', 'llc_scorp', 'scorp', 'ccorp'] as const).map(t => (\n                <button\n                  key={t}\n                  onClick={() => setFormationType(t)}\n                  style={{\n                    padding: '6px 12px', borderRadius: 6, border: 'none',\n                    background: formationType === t ? 'var(--accent-gold-dim)' : 'var(--bg-surface)',\n                    color: formationType === t ? 'var(--accent-gold)' : 'var(--text-muted)',\n                    cursor: 'pointer', fontSize: 11, fontWeight: 500,\n                  }}\n                >\n                  {t === 'llc_scorp' ? 'LLC+S' : t.toUpperCase()}\n                </button>\n              ))}\n            </div>\n          </div>\n\n          {/* Warnings */}\n          {formation.warnings.map((w, i) => (\n            <div key={i} style={{\n              padding: '10px 16px', borderRadius: 10,\n              background: 'var(--accent-red-dim)', border: '1px solid var(--accent-red)22',\n              fontSize: 12, color: 'var(--accent-red)', lineHeight: 1.5,\n              display: 'flex', gap: 8,\n            }}>\n              <AlertTriangle size={14} style={{ flexShrink: 0, marginTop: 2 }} />\n              {w}\n            </div>\n          ))}\n\n          {/* Steps */}\n          {formation.steps.map((step, i) => (\n            <div key={i} style={card}>\n              <button\n                onClick={() => setExpandedStep(expandedStep === i ? null : i)}\n                style={{\n                  display: 'flex', gap: 12, width: '100%', background: 'none',\n                  border: 'none', cursor: 'pointer', padding: 0, textAlign: 'left',\n                  fontFamily: 'var(--font-body)',\n                }}\n              >\n                <div style={{\n                  width: 28, height: 28, borderRadius: 8, flexShrink: 0,\n                  background: 'var(--accent-gold-dim)',\n                  display: 'flex', alignItems: 'center', justifyContent: 'center',\n                  fontFamily: 'var(--font-mono)', fontSize: 12, fontWeight: 700, color: 'var(--accent-gold)',\n                }}>\n                  {step.step}\n                </div>\n                <div style={{ flex: 1 }}>\n                  <div style={{ fontSize: 14, color: 'var(--text-primary)', fontWeight: 500 }}>\n                    {step.title}\n                  </div>\n                  <div style={{ display: 'flex', gap: 12, marginTop: 4 }}>\n                    <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>Cost: {step.estimatedCost}</span>\n                    <span style={{ fontSize: 11, color: 'var(--text-muted)' }}>Time: {step.timeline}</span>\n                  </div>\n                </div>\n                <ChevronDown size={14} color=\"var(--text-muted)\" style={{\n                  transition: 'transform 0.2s',\n                  transform: expandedStep === i ? 'rotate(180deg)' : 'rotate(0)',\n                }} />\n              </button>\n\n              {expandedStep === i && (\n                <div style={{ marginTop: 12, marginLeft: 40 }}>\n                  <div style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.6 }}>\n                    {step.description}\n                  </div>\n                  {step.resource && (\n                    <div style={{ fontSize: 11, color: 'var(--accent-blue)', marginTop: 8 }}>\n                      🔗 {step.resource}\n                    </div>\n                  )}\n                </div>\n              )}\n            </div>\n          ))}\n\n          {/* Tips */}\n          {formation.tips.length > 0 && (\n            <div style={{ ...card, background: 'var(--bg-primary)', border: '1px dashed var(--border-subtle)' }}>\n              <div style={{ fontSize: 12, color: 'var(--text-muted)', fontWeight: 600, marginBottom: 8, textTransform: 'uppercase', letterSpacing: '0.06em' }}>\n                💡 Tips\n              </div>\n              {formation.tips.map((tip, i) => (\n                <div key={i} style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.6, marginBottom: 4 }}>\n                  • {tip}\n                </div>\n              ))}\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* ═══ SCHEDULE C DRAFT ═══ */}\n      {activeTab === 'schedule-c' && (\n        <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>\n          {/* Summary */}\n          <div style={card}>\n            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: 12 }}>\n              <div>\n                <div style={{ display: 'flex', gap: 24 }}>\n                  <div>\n                    <div style={{ fontSize: 11, color: 'var(--text-muted)', textTransform: 'uppercase' }}>Gross Receipts</div>\n                    <div style={{ fontFamily: 'var(--font-mono)', fontSize: 20, fontWeight: 600, color: 'var(--text-primary)' }}>\n                      ${scheduleC.grossReceipts.toLocaleString()}\n                    </div>\n                  </div>\n                  <div>\n                    <div style={{ fontSize: 11, color: 'var(--text-muted)', textTransform: 'uppercase' }}>Expenses</div>\n                    <div style={{ fontFamily: 'var(--font-mono)', fontSize: 20, fontWeight: 600, color: 'var(--accent-red)' }}>\n                      −${scheduleC.totalExpenses.toLocaleString()}\n                    </div>\n                  </div>\n                  <div>\n                    <div style={{ fontSize: 11, color: 'var(--text-muted)', textTransform: 'uppercase' }}>Net Profit</div>\n                    <div style={{ fontFamily: 'var(--font-mono)', fontSize: 20, fontWeight: 600, color: scheduleC.netProfit >= 0 ? 'var(--accent-emerald)' : 'var(--accent-red)' }}>\n                      ${scheduleC.netProfit.toLocaleString()}\n                    </div>\n                  </div>\n                </div>\n                <div style={{ fontSize: 12, color: 'var(--text-muted)', marginTop: 8 }}>\n                  SE Tax: ${scheduleC.seTaxEstimate.toLocaleString()} · SE Deduction: ${scheduleC.seDeduction.toLocaleString()}\n                </div>\n              </div>\n              <div style={{ display: 'flex', gap: 8 }}>\n                <button style={actionBtn} onClick={() => copyText(scheduleC.formContent, 'Schedule C')}>\n                  {copyFeedback === 'Schedule C' ? <CheckCircle size={13} color=\"var(--accent-emerald)\" /> : <Copy size={13} />}\n                  Copy\n                </button>\n                <button style={actionBtn} onClick={() => downloadText(scheduleC.formContent, `schedule-c-draft-${scheduleC.taxYear}.txt`)}>\n                  <Download size={13} /> Download\n                </button>\n              </div>\n            </div>\n          </div>\n\n          {/* Expense breakdown */}\n          {scheduleC.partII.length > 0 && (\n            <div style={card}>\n              <div style={{ fontSize: 12, color: 'var(--text-muted)', fontWeight: 600, marginBottom: 12, textTransform: 'uppercase', letterSpacing: '0.06em' }}>\n                Expense Breakdown (Part II)\n              </div>\n              <div style={{ display: 'flex', flexDirection: 'column', gap: 6 }}>\n                {scheduleC.partII.map((line, i) => (\n                  <div key={i} style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', borderBottom: '1px solid var(--border-subtle)' }}>\n                    <div>\n                      <span style={{ fontFamily: 'var(--font-mono)', fontSize: 11, color: 'var(--text-muted)', marginRight: 8 }}>\n                        Line {line.line}\n                      </span>\n                      <span style={{ fontSize: 13, color: 'var(--text-secondary)' }}>{line.label}</span>\n                    </div>\n                    <span style={{ fontFamily: 'var(--font-mono)', fontSize: 13, color: 'var(--text-primary)', fontWeight: 500 }}>\n                      ${line.amount.toLocaleString()}\n                    </span>\n                  </div>\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Full worksheet */}\n          <details>\n            <summary style={{ fontSize: 13, color: 'var(--accent-gold)', cursor: 'pointer', padding: '8px 0' }}>\n              View Full Schedule C Worksheet\n            </summary>\n            <pre style={{\n              fontFamily: 'var(--font-mono)', fontSize: 11, lineHeight: 1.5,\n              color: 'var(--text-secondary)', background: 'var(--bg-primary)',\n              padding: 16, borderRadius: 10, overflow: 'auto', whiteSpace: 'pre',\n              border: '1px solid var(--border-subtle)', marginTop: 8,\n            }}>\n              {scheduleC.formContent}\n            </pre>\n          </details>\n        </div>\n      )}\n\n      {/* ═══ AUDIT DOCUMENTATION CHECKLIST ═══ */}\n      {activeTab === 'audit-docs' && (\n        <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>\n          <div style={{\n            padding: '10px 16px', borderRadius: 10,\n            background: 'var(--accent-gold)10', border: '1px solid var(--accent-gold)22',\n            fontSize: 12, color: 'var(--accent-gold)', lineHeight: 1.5,\n          }}>\n            <ClipboardCheck size={14} style={{ display: 'inline', verticalAlign: -2, marginRight: 6 }} />\n            Organize these documents proactively. Having them ready reduces audit stress and strengthens your position.\n          </div>\n\n          {auditDocs.map((category, ci) => (\n            <div key={ci} style={card}>\n              <div style={{ fontSize: 14, color: 'var(--text-primary)', fontWeight: 500, marginBottom: 16 }}>\n                {category.category}\n              </div>\n              <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>\n                {category.items.map((item, ii) => {\n                  const prColor = item.priority === 'essential' ? 'var(--accent-red)'\n                    : item.priority === 'recommended' ? 'var(--accent-gold)' : 'var(--text-muted)'\n                  return (\n                    <div key={ii} style={{\n                      display: 'flex', gap: 12, alignItems: 'flex-start',\n                      padding: '8px 12px', borderRadius: 8,\n                      background: 'var(--bg-primary)',\n                    }}>\n                      <div style={{\n                        width: 6, height: 6, borderRadius: 3, marginTop: 6,\n                        background: prColor, flexShrink: 0,\n                      }} />\n                      <div style={{ flex: 1 }}>\n                        <div style={{ fontSize: 13, color: 'var(--text-secondary)', lineHeight: 1.4 }}>\n                          {item.description}\n                        </div>\n                        <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 2 }}>\n                          {item.scheduleRef} · {item.priority}\n                        </div>\n                      </div>\n                    </div>\n                  )\n                })}\n              </div>\n            </div>\n          ))}\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\TaxPrepChecklist.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TaxPrepSection' is defined but never used.","line":3,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":55,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TaxPrepSection"},"fix":{"range":[124,145],"text":""},"desc":"Remove unused variable \"TaxPrepSection\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DollarSign' is defined but never used.","line":6,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":37,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DollarSign"},"fix":{"range":[293,305],"text":""},"desc":"Remove unused variable \"DollarSign\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'FileText' is defined but never used.","line":6,"column":39,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":47,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"FileText"},"fix":{"range":[305,315],"text":""},"desc":"Remove unused variable \"FileText\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Download' is defined but never used.","line":6,"column":49,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":57,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Download"},"fix":{"range":[315,325],"text":""},"desc":"Remove unused variable \"Download\"."}]},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":2,"message":"Expected an assignment or function call and instead saw an expression.","line":25,"column":5,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":25,"endColumn":59}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { generateTaxPrepChecklist, type TaxPrepSection, type TaxPrepItem } from '../engine/tax-prep'\nimport {\n  ClipboardCheck, CheckCircle2, AlertTriangle, Circle, MinusCircle,\n  ChevronDown, ChevronUp, DollarSign, FileText, Download, Calendar\n} from 'lucide-react'\n\nfunction fmt(n: number): string { return `$${Math.round(n).toLocaleString()}` }\n\nconst STATUS_CONFIG: Record<string, { color: string; icon: JSX.Element; label: string }> = {\n  complete: { color: 'var(--accent-emerald)', icon: <CheckCircle2 size={14} />, label: 'Complete' },\n  partial: { color: 'var(--accent-gold)', icon: <AlertTriangle size={14} />, label: 'Partial' },\n  missing: { color: 'var(--accent-red)', icon: <Circle size={14} />, label: 'Missing' },\n  na: { color: 'var(--text-muted)', icon: <MinusCircle size={14} />, label: 'N/A' },\n}\n\nexport function TaxPrepChecklist() {\n  const { state } = useFortuna()\n  const checklist = useMemo(() => generateTaxPrepChecklist(state), [state])\n  const [expandedSections, setExpandedSections] = useState<Set<string>>(new Set(checklist.sections.map(s => s.title)))\n\n  const toggleSection = (title: string) => {\n    const next = new Set(expandedSections)\n    next.has(title) ? next.delete(title) : next.add(title)\n    setExpandedSections(next)\n  }\n\n  const hasData = state.incomeStreams.length > 0\n\n  if (!hasData) {\n    return (\n      <div className=\"view-enter\" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '50vh' }}>\n        <div style={{ textAlign: 'center', maxWidth: 400 }}>\n          <ClipboardCheck size={32} color=\"var(--accent-gold)\" style={{ marginBottom: 12 }} />\n          <h2 style={{ fontFamily: 'var(--font-display)', marginBottom: 8 }}>Tax Prep Checklist</h2>\n          <p style={{ fontSize: 13, color: 'var(--text-muted)' }}>Add your financial profile to generate a comprehensive filing checklist.</p>\n        </div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"view-enter\">\n      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 24 }}>\n        <div>\n          <h1 className=\"section-title\">Tax Prep Checklist</h1>\n          <p className=\"section-subtitle\">Filing preparation for {checklist.filingYear} · Due {checklist.filingDeadline}</p>\n        </div>\n      </div>\n\n      {/* Top Summary Banner */}\n      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 16, marginBottom: 24 }}>\n        {/* Overall Completion */}\n        <div className=\"glass-card\" style={{ padding: '16px 20px' }}>\n          <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>\n            <div style={{ position: 'relative', width: 56, height: 56 }}>\n              <svg width={56} height={56} style={{ transform: 'rotate(-90deg)' }}>\n                <circle cx={28} cy={28} r={24} fill=\"none\" stroke=\"var(--bg-hover)\" strokeWidth={4} />\n                <circle cx={28} cy={28} r={24} fill=\"none\"\n                  stroke={checklist.overallCompletion >= 80 ? 'var(--accent-emerald)' : checklist.overallCompletion >= 50 ? 'var(--accent-gold)' : 'var(--accent-red)'}\n                  strokeWidth={4} strokeDasharray={`${checklist.overallCompletion * 1.508} 999`} strokeLinecap=\"round\" />\n              </svg>\n              <div style={{ position: 'absolute', inset: 0, display: 'flex', alignItems: 'center', justifyContent: 'center', fontFamily: 'var(--font-mono)', fontSize: 14, fontWeight: 600 }}>\n                {checklist.overallCompletion}%\n              </div>\n            </div>\n            <div>\n              <div style={{ fontSize: 12, fontWeight: 500, color: 'var(--text-primary)' }}>Filing Readiness</div>\n              <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>\n                {checklist.criticalMissing.length === 0 ? 'All critical items complete' : `${checklist.criticalMissing.length} items need attention`}\n              </div>\n            </div>\n          </div>\n        </div>\n\n        {/* Refund / Owed */}\n        <div className=\"glass-card\" style={{ padding: '16px 20px' }}>\n          <div style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 6 }}>\n            Estimated {checklist.isRefund ? 'Refund' : 'Balance Due'}\n          </div>\n          <div style={{ fontFamily: 'var(--font-mono)', fontSize: 24, fontWeight: 600, color: checklist.isRefund ? 'var(--accent-emerald)' : 'var(--accent-red)' }}>\n            {checklist.isRefund ? '+' : '-'}{fmt(checklist.estimatedRefundOrOwed)}\n          </div>\n          <div style={{ fontSize: 10, color: 'var(--text-muted)', marginTop: 2 }}>\n            Tax: {fmt(checklist.summary.totalTax)} · Withheld: {fmt(checklist.summary.totalWithheld)}\n          </div>\n        </div>\n\n        {/* Filing Summary */}\n        <div className=\"glass-card\" style={{ padding: '16px 20px' }}>\n          <div style={{ fontSize: 10, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 6 }}>Tax Summary</div>\n          <div style={{ display: 'flex', flexDirection: 'column', gap: 4 }}>\n            {[\n              { label: 'Total Income', value: fmt(checklist.summary.totalIncome) },\n              { label: 'Deductions', value: fmt(checklist.summary.totalDeductions) },\n              { label: 'Total Tax', value: fmt(checklist.summary.totalTax) },\n            ].map((item, i) => (\n              <div key={i} style={{ display: 'flex', justifyContent: 'space-between', fontSize: 11 }}>\n                <span style={{ color: 'var(--text-muted)' }}>{item.label}</span>\n                <span style={{ fontFamily: 'var(--font-mono)', color: 'var(--text-primary)' }}>{item.value}</span>\n              </div>\n            ))}\n          </div>\n        </div>\n      </div>\n\n      {/* Critical Missing Items */}\n      {checklist.criticalMissing.length > 0 && (\n        <div style={{ padding: '12px 16px', borderRadius: 12, background: 'rgba(239,68,68,0.06)', border: '1px solid rgba(239,68,68,0.12)', marginBottom: 20 }}>\n          <div style={{ fontSize: 12, fontWeight: 600, color: 'var(--accent-red)', marginBottom: 8, display: 'flex', alignItems: 'center', gap: 6 }}>\n            <AlertTriangle size={14} /> {checklist.criticalMissing.length} Critical Items Needed\n          </div>\n          <div style={{ display: 'flex', flexWrap: 'wrap', gap: 6 }}>\n            {checklist.criticalMissing.slice(0, 8).map(item => (\n              <span key={item.id} style={{ padding: '4px 10px', borderRadius: 6, background: 'rgba(239,68,68,0.08)', fontSize: 11, color: 'var(--text-secondary)' }}>\n                {item.form}: {item.description.substring(0, 40)}\n              </span>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {/* Sections */}\n      {checklist.sections.map(section => (\n        <div key={section.title} className=\"card\" style={{ marginBottom: 12 }}>\n          <div className=\"card-header\" style={{ cursor: 'pointer' }} onClick={() => toggleSection(section.title)}>\n            <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>\n              <span style={{ fontSize: 18 }}>{section.icon}</span>\n              <div>\n                <span className=\"card-title\">{section.title}</span>\n                <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>{section.items.length} items</div>\n              </div>\n            </div>\n            <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>\n              {/* Completion bar */}\n              <div style={{ width: 80, display: 'flex', alignItems: 'center', gap: 6 }}>\n                <div style={{ flex: 1, height: 4, borderRadius: 2, background: 'var(--bg-hover)' }}>\n                  <div style={{ width: `${section.completionPct}%`, height: '100%', borderRadius: 2,\n                    background: section.completionPct === 100 ? 'var(--accent-emerald)' : section.completionPct >= 50 ? 'var(--accent-gold)' : 'var(--accent-red)' }} />\n                </div>\n                <span style={{ fontFamily: 'var(--font-mono)', fontSize: 10, color: 'var(--text-muted)', minWidth: 30 }}>{section.completionPct}%</span>\n              </div>\n              {expandedSections.has(section.title) ? <ChevronUp size={14} color=\"var(--text-muted)\" /> : <ChevronDown size={14} color=\"var(--text-muted)\" />}\n            </div>\n          </div>\n\n          {expandedSections.has(section.title) && (\n            <div className=\"card-body\" style={{ padding: '0 16px 12px' }}>\n              {section.items.map(item => (\n                <ChecklistItem key={item.id} item={item} />\n              ))}\n            </div>\n          )}\n        </div>\n      ))}\n\n      {/* Filing Timeline */}\n      <div className=\"card\" style={{ marginTop: 8 }}>\n        <div className=\"card-header\"><span className=\"card-title\"><Calendar size={14} /> Key Filing Dates</span></div>\n        <div className=\"card-body\">\n          <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>\n            {[\n              { date: `January 31, ${checklist.filingYear + 1}`, event: 'W-2s and 1099s due from employers/clients', done: false },\n              { date: `March 15, ${checklist.filingYear + 1}`, event: 'S-Corp/Partnership returns due (or extension)', done: false },\n              { date: `April 15, ${checklist.filingYear + 1}`, event: 'Personal return due (Form 1040) · Q1 estimated tax due', done: false },\n              { date: `June 15, ${checklist.filingYear + 1}`, event: 'Q2 estimated tax payment due', done: false },\n              { date: `September 15, ${checklist.filingYear + 1}`, event: 'Extended S-Corp/Partnership due · Q3 estimated tax due', done: false },\n              { date: `October 15, ${checklist.filingYear + 1}`, event: 'Extended personal return due', done: false },\n            ].map((d, i) => (\n              <div key={i} style={{ display: 'flex', alignItems: 'flex-start', gap: 12, padding: '8px 12px', borderRadius: 8, background: 'var(--bg-primary)' }}>\n                <div style={{ width: 8, height: 8, borderRadius: 4, marginTop: 4, flexShrink: 0,\n                  background: d.done ? 'var(--accent-emerald)' : 'var(--border-medium)' }} />\n                <div style={{ flex: 1 }}>\n                  <div style={{ fontSize: 12, fontWeight: 500, color: 'var(--text-primary)', fontFamily: 'var(--font-mono)' }}>{d.date}</div>\n                  <div style={{ fontSize: 11, color: 'var(--text-secondary)', marginTop: 1 }}>{d.event}</div>\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction ChecklistItem({ item }: { item: TaxPrepItem }) {\n  const [expanded, setExpanded] = useState(false)\n  const cfg = STATUS_CONFIG[item.status]\n\n  return (\n    <div style={{ borderBottom: '1px solid var(--border-subtle)', padding: '10px 0' }}>\n      <div style={{ display: 'flex', alignItems: 'flex-start', gap: 10, cursor: 'pointer' }} onClick={() => setExpanded(!expanded)}>\n        <div style={{ color: cfg.color, marginTop: 1, flexShrink: 0 }}>{cfg.icon}</div>\n        <div style={{ flex: 1, minWidth: 0 }}>\n          <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>\n            <span style={{ fontSize: 12, fontWeight: 500, color: 'var(--text-primary)' }}>{item.description}</span>\n            <span style={{ fontSize: 9, padding: '1px 6px', borderRadius: 4, background: 'var(--bg-hover)', color: 'var(--text-muted)', fontFamily: 'var(--font-mono)' }}>\n              {item.form}\n            </span>\n            {item.priority === 'required' && item.status !== 'complete' && (\n              <span style={{ fontSize: 9, padding: '1px 6px', borderRadius: 4, background: 'rgba(239,68,68,0.1)', color: 'var(--accent-red)' }}>Required</span>\n            )}\n          </div>\n          {item.amount !== undefined && (\n            <span style={{ fontSize: 11, fontFamily: 'var(--font-mono)', color: 'var(--text-muted)' }}>{fmt(item.amount)}</span>\n          )}\n        </div>\n        <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>\n          {item.dueDate && (\n            <span style={{ fontSize: 10, color: 'var(--text-muted)', fontFamily: 'var(--font-mono)' }}>{item.dueDate}</span>\n          )}\n          {expanded ? <ChevronUp size={12} color=\"var(--text-muted)\" /> : <ChevronDown size={12} color=\"var(--text-muted)\" />}\n        </div>\n      </div>\n\n      {expanded && (\n        <div style={{ marginLeft: 24, marginTop: 6, padding: '8px 12px', borderRadius: 8, background: 'var(--bg-primary)', fontSize: 11, color: 'var(--text-secondary)', lineHeight: 1.6 }}>\n          {item.notes}\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\TaxStrategy.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'PrintReport' is defined but never used.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":21,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"PrintReport"},"fix":{"range":[196,208],"text":""},"desc":"Remove unused variable \"PrintReport\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Calculator' is defined but never used.","line":7,"column":49,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":59,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Calculator"},"fix":{"range":[311,323],"text":""},"desc":"Remove unused variable \"Calculator\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'CheckCircle2' is defined but never used.","line":8,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":22,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CheckCircle2"},"fix":{"range":[332,346],"text":""},"desc":"Remove unused variable \"CheckCircle2\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ArrowRight' is defined but never used.","line":8,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":34,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ArrowRight"},"fix":{"range":[346,358],"text":""},"desc":"Remove unused variable \"ArrowRight\"."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { useCopy } from '../engine/microcopy'\nimport { HelpSection } from '../components/ContextualHelp'\nimport { PrintReport, PrintButton } from '../components/PrintReport'\nimport {\n  ChevronDown, Shield, TrendingDown, Lightbulb, Calculator,\n  Clock, CheckCircle2, ArrowRight, Zap, AlertTriangle\n} from 'lucide-react'\nimport { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell } from 'recharts'\n\nconst priorityConfig: Record<string, { bg: string; color: string; label: string; icon: React.ReactNode }> = {\n  critical: { bg: 'var(--accent-red-dim)', color: 'var(--accent-red)', label: 'Critical', icon: <AlertTriangle size={16} /> },\n  high: { bg: 'var(--accent-gold-dim)', color: 'var(--accent-gold)', label: 'High Priority', icon: <Lightbulb size={16} /> },\n  medium: { bg: 'var(--accent-blue-dim)', color: 'var(--accent-blue)', label: 'Medium', icon: <Clock size={16} /> },\n  low: { bg: 'var(--accent-purple-dim)', color: 'var(--accent-purple)', label: 'Opportunity', icon: <Shield size={16} /> },\n}\n\nexport function TaxStrategy() {\n  const { taxReport, strategies } = useFortuna()\n  const t = useCopy()\n  const [expanded, setExpanded] = useState<string | null>(strategies[0]?.id || null)\n\n  const taxStrategies = strategies.filter(s => ['tax', 'deduction', 'entity'].includes(s.category))\n  const totalSavings = taxStrategies.reduce((s, st) => s + st.estimatedImpact, 0)\n  const optimizedTax = Math.max(0, taxReport.totalTax - totalSavings)\n  const optimizedRate = taxReport.grossIncome > 0 ? optimizedTax / taxReport.grossIncome : 0\n\n  const chartData = [\n    { label: 'Current', amount: taxReport.totalTax, color: '#ef6b6b' },\n    { label: 'Optimized', amount: optimizedTax, color: '#34d399' },\n  ]\n\n  return (\n    <div className=\"view-enter\">\n      <div style={{ marginBottom: 32 }}>\n        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>\n          <div>\n            <h1 className=\"section-title\">{t('view.tax')}</h1>\n            <p className=\"section-subtitle\">{t('subtitle.tax')}</p>\n          </div>\n          <PrintButton label=\"Print Strategy Report\" />\n        </div>\n        <HelpSection topic=\"effective_rate\" />\n      </div>\n\n      <div className=\"grid-3 stagger\" style={{ marginBottom: 28 }}>\n        <div className=\"metric-card glow-gold\">\n          <span className=\"metric-label\">Identified Tax Savings</span>\n          <div className=\"metric-value\" style={{ color: 'var(--accent-gold)' }}>${totalSavings.toLocaleString()}</div>\n          <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>Across {taxStrategies.length} strategies</span>\n        </div>\n        <div className=\"metric-card\">\n          <span className=\"metric-label\">Current Effective Rate</span>\n          <div className=\"metric-value\">{(taxReport.effectiveRate * 100).toFixed(1)}%</div>\n          <span className=\"metric-change positive\"><TrendingDown size={12} /> Target: {(optimizedRate * 100).toFixed(1)}%</span>\n        </div>\n        <div className=\"metric-card\">\n          <span className=\"metric-label\">Tax Breakdown</span>\n          <div style={{ fontFamily: 'var(--font-mono)', fontSize: 12, marginTop: 8, display: 'flex', flexDirection: 'column', gap: 4 }}>\n            <div style={{ display: 'flex', justifyContent: 'space-between' }}>\n              <span style={{ color: 'var(--text-muted)' }}>Federal</span>\n              <span>${taxReport.federalIncomeTax.toLocaleString()}</span>\n            </div>\n            <div style={{ display: 'flex', justifyContent: 'space-between' }}>\n              <span style={{ color: 'var(--text-muted)' }}>SE Tax</span>\n              <span>${taxReport.selfEmploymentTax.toLocaleString()}</span>\n            </div>\n            <div style={{ display: 'flex', justifyContent: 'space-between' }}>\n              <span style={{ color: 'var(--text-muted)' }}>State</span>\n              <span>${taxReport.stateTax.toLocaleString()}</span>\n            </div>\n            {(taxReport.w2FederalWithheld > 0 || taxReport.w2StateWithheld > 0) && (<>\n              <div style={{ borderTop: '1px solid var(--border-subtle)', margin: '4px 0' }} />\n              <div style={{ display: 'flex', justifyContent: 'space-between' }}>\n                <span style={{ color: 'var(--accent-blue)' }}>W-2 Withheld</span>\n                <span style={{ color: 'var(--accent-blue)' }}>-${(taxReport.w2FederalWithheld + taxReport.w2StateWithheld).toLocaleString()}</span>\n              </div>\n              <div style={{ display: 'flex', justifyContent: 'space-between', fontWeight: 500 }}>\n                <span style={{ color: taxReport.netTaxOwed <= 0 ? 'var(--accent-emerald)' : 'var(--accent-gold)' }}>\n                  {taxReport.netTaxOwed <= 0 ? 'Refund' : 'Still Owed'}\n                </span>\n                <span style={{ color: taxReport.netTaxOwed <= 0 ? 'var(--accent-emerald)' : 'var(--accent-gold)' }}>\n                  ${Math.abs(taxReport.netTaxOwed).toLocaleString()}\n                </span>\n              </div>\n            </>)}\n          </div>\n        </div>\n      </div>\n\n      {totalSavings > 0 && (\n        <div className=\"card\" style={{ marginBottom: 24 }}>\n          <div className=\"card-header\">\n            <span className=\"card-title\">Current vs. Optimized Tax Burden</span>\n            <span className=\"pill emerald\"><Zap size={11} /> Achievable</span>\n          </div>\n          <div className=\"card-body\">\n            <ResponsiveContainer width=\"100%\" height={140}>\n              <BarChart data={chartData} layout=\"vertical\" barSize={28}>\n                <XAxis type=\"number\" tickFormatter={v => `$${(v / 1000).toFixed(0)}k`} tick={{ fill: '#565c6a', fontSize: 11, fontFamily: 'var(--font-mono)' }} axisLine={false} tickLine={false} />\n                <YAxis type=\"category\" dataKey=\"label\" tick={{ fill: '#8b919e', fontSize: 13 }} axisLine={false} tickLine={false} width={80} />\n                <Tooltip contentStyle={{ background: '#181c24', border: '1px solid rgba(255,255,255,0.1)', borderRadius: 8, fontFamily: 'var(--font-mono)', fontSize: 12 }} formatter={(v: number) => [`$${v.toLocaleString()}`, 'Tax']} />\n                <Bar dataKey=\"amount\" radius={[0, 6, 6, 0]}>\n                  {chartData.map((e, i) => <Cell key={i} fill={e.color} />)}\n                </Bar>\n              </BarChart>\n            </ResponsiveContainer>\n            <div style={{ textAlign: 'center', marginTop: 8 }}>\n              <span style={{ fontFamily: 'var(--font-mono)', fontSize: 14, color: 'var(--accent-emerald)', fontWeight: 500 }}>\n                Potential reduction: ${totalSavings.toLocaleString()}/year ({((totalSavings / Math.max(1, taxReport.totalTax)) * 100).toFixed(1)}% lower)\n              </span>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Dynamic strategies from engine */}\n      <div style={{ marginBottom: 12, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\n        <h2 style={{ fontFamily: 'var(--font-display)', fontSize: 20 }}>Detected Strategies</h2>\n        <span style={{ fontSize: 12, color: 'var(--text-muted)' }}>Auto-analyzed from your data</span>\n      </div>\n\n      {taxStrategies.length === 0 && (\n        <div className=\"card\" style={{ padding: 40, textAlign: 'center' }}>\n          <p style={{ color: 'var(--text-muted)', fontSize: 13 }}>Add income and entity data to detect optimization strategies.</p>\n        </div>\n      )}\n\n      <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>\n        {taxStrategies.map(strategy => {\n          const isExpanded = expanded === strategy.id\n          const pc = priorityConfig[strategy.priority]\n          return (\n            <div key={strategy.id} className=\"card\" style={{ borderColor: isExpanded ? 'var(--border-medium)' : 'var(--border-subtle)' }}>\n              <div onClick={() => setExpanded(isExpanded ? null : strategy.id)} style={{ padding: '18px 24px', display: 'flex', alignItems: 'center', gap: 16, cursor: 'pointer' }}>\n                <div style={{ width: 36, height: 36, borderRadius: 10, background: pc.bg, display: 'flex', alignItems: 'center', justifyContent: 'center', color: pc.color, flexShrink: 0 }}>\n                  {pc.icon}\n                </div>\n                <div style={{ flex: 1 }}>\n                  <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>\n                    <span style={{ fontSize: 14, fontWeight: 500 }}>{strategy.title}</span>\n                    <span className=\"pill\" style={{ background: pc.bg, color: pc.color, borderColor: 'transparent', fontSize: 11 }}>{pc.label}</span>\n                  </div>\n                  <div style={{ fontSize: 12, color: 'var(--text-muted)', marginTop: 2 }}>{strategy.category}</div>\n                </div>\n                <div style={{ textAlign: 'right', flexShrink: 0 }}>\n                  <div style={{ fontFamily: 'var(--font-mono)', fontSize: 16, fontWeight: 600, color: 'var(--accent-emerald)' }}>{strategy.impactLabel}</div>\n                  <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>Risk: <span style={{ color: strategy.risk === 'none' ? 'var(--accent-emerald)' : 'var(--accent-gold)', fontWeight: 500 }}>{strategy.risk}</span></div>\n                </div>\n                <ChevronDown size={16} color=\"var(--text-muted)\" style={{ transition: 'transform 0.2s', transform: isExpanded ? 'rotate(180deg)' : '' }} />\n              </div>\n\n              {isExpanded && (\n                <div style={{ padding: '0 24px 24px', borderTop: '1px solid var(--border-subtle)', paddingTop: 20 }}>\n                  <p style={{ fontSize: 13, color: 'var(--text-secondary)', lineHeight: 1.7, marginBottom: 16 }}>{strategy.description}</p>\n                  <div style={{ background: 'var(--bg-surface)', borderRadius: 10, padding: 14, marginBottom: 16 }}>\n                    <div style={{ fontSize: 11, fontWeight: 500, color: 'var(--accent-gold)', textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 8 }}>Analysis</div>\n                    <p style={{ fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.6, fontFamily: 'var(--font-mono)' }}>{strategy.reasoning}</p>\n                  </div>\n                  <div style={{ fontSize: 12, fontWeight: 500, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 10 }}>Implementation Steps</div>\n                  {strategy.steps.map((step, i) => (\n                    <div key={i} style={{ display: 'flex', gap: 10, marginBottom: 8, alignItems: 'flex-start' }}>\n                      <div style={{ width: 22, height: 22, borderRadius: 6, background: 'var(--bg-surface)', border: '1px solid var(--border-subtle)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 11, fontFamily: 'var(--font-mono)', color: 'var(--text-muted)', flexShrink: 0 }}>{i + 1}</div>\n                      <span style={{ fontSize: 13, color: 'var(--text-secondary)', lineHeight: 1.5, paddingTop: 1 }}>{step}</span>\n                    </div>\n                  ))}\n                  <div style={{ display: 'flex', gap: 6, marginTop: 12, fontSize: 12, color: 'var(--text-muted)' }}>\n                    <span>Timeline: <strong style={{ color: 'var(--accent-gold)' }}>{strategy.timeline}</strong></span>\n                    {strategy.prerequisites.length > 0 && <span> · Prerequisites: {strategy.prerequisites.join(', ')}</span>}\n                  </div>\n                </div>\n              )}\n            </div>\n          )\n        })}\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\TransactionReview.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useEffect' is defined but never used.","line":16,"column":42,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":51,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useEffect"},"fix":{"range":[495,506],"text":""},"desc":"Remove unused variable \"useEffect\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":90,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4323,4326],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4323,4326],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":99,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":99,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4620,4623],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4620,4623],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":192,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":192,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8366,8369],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8366,8369],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":204,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":204,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8740,8743],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8740,8743],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":204,"column":115,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":204,"endColumn":118,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8788,8791],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8788,8791],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":220,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":220,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9439,9442],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9439,9442],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-expressions","severity":2,"message":"Expected an assignment or function call and instead saw an expression.","line":230,"column":7,"nodeType":"ExpressionStatement","messageId":"unusedExpression","endLine":230,"endColumn":52}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — Transaction Review View\n *\n * Tax-enriched transaction review for end users:\n *   - View all imported transactions with enrichment details\n *   - Filter by category, deductibility, date, amount, review status\n *   - Override/confirm tax categorizations\n *   - Bulk approve or re-categorize\n *   - Deduction discovery dashboard\n *   - Recurring stream summary\n *   - Export reviewed transactions\n *\n * @module TransactionReview\n */\n\nimport { useState, useMemo, useCallback, useEffect } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport type { BankTransaction, FortunaState } from '../engine/storage'\n\n// ─── Local enrichment type (compatible with bridge output) ────────────────\n\ninterface ReviewableTransaction extends BankTransaction {\n  enrichment?: {\n    fortunaCategory: string\n    scheduleRef?: string\n    isDeductible: boolean\n    deductionPct: number\n    isTaxPayment: boolean\n    is1099Reportable: boolean\n    confidence: number\n    needsReview: boolean\n    merchantName?: string\n  }\n  userOverride?: {\n    category: string\n    isDeductible: boolean\n    deductionPct: number\n    approved: boolean\n  }\n}\n\ntype FilterMode = 'all' | 'needs_review' | 'deductible' | 'tax_payments' | 'high_value' | 'approved'\ntype SortField = 'date' | 'amount' | 'category' | 'confidence'\n\n// ─── Tax Categories for Override ──────────────────────────────────────────\n\nconst TAX_CATEGORIES = [\n  { value: 'advertising', label: 'Advertising (Sch C L8)', deductible: true, pct: 100 },\n  { value: 'auto', label: 'Auto / Vehicle (Sch C L9)', deductible: true, pct: 100 },\n  { value: 'bank_fees', label: 'Bank Fees (Sch C L27a)', deductible: true, pct: 100 },\n  { value: 'charitable', label: 'Charitable (Sch A L12)', deductible: true, pct: 100 },\n  { value: 'consulting', label: 'Consulting (Sch C L17)', deductible: true, pct: 100 },\n  { value: 'education', label: 'Education (Sch C L27a)', deductible: true, pct: 100 },\n  { value: 'health_insurance', label: 'Health Insurance', deductible: true, pct: 100 },\n  { value: 'hsa', label: 'HSA Contribution', deductible: true, pct: 100 },\n  { value: 'insurance', label: 'Insurance (Sch C L15)', deductible: true, pct: 100 },\n  { value: 'legal', label: 'Legal / Professional (Sch C L17)', deductible: true, pct: 100 },\n  { value: 'meals', label: 'Meals (Sch C L24b — 50%)', deductible: true, pct: 50 },\n  { value: 'medical', label: 'Medical (Sch A L1)', deductible: true, pct: 100 },\n  { value: 'mortgage_interest', label: 'Mortgage Interest (Sch A L8a)', deductible: true, pct: 100 },\n  { value: 'office_supplies', label: 'Office Supplies (Sch C L18)', deductible: true, pct: 100 },\n  { value: 'rent', label: 'Rent (Sch C L20b)', deductible: true, pct: 100 },\n  { value: 'retirement', label: 'Retirement Contribution', deductible: true, pct: 100 },\n  { value: 'software', label: 'Software / Tech (Sch C L27a)', deductible: true, pct: 100 },\n  { value: 'travel', label: 'Travel (Sch C L24a)', deductible: true, pct: 100 },\n  { value: 'utilities', label: 'Utilities (Sch C L25)', deductible: true, pct: 100 },\n  { value: 'income', label: 'Income (not deductible)', deductible: false, pct: 0 },\n  { value: 'transfer', label: 'Transfer (not deductible)', deductible: false, pct: 0 },\n  { value: 'personal', label: 'Personal (not deductible)', deductible: false, pct: 0 },\n  { value: 'tax_payment', label: 'Tax Payment', deductible: false, pct: 0 },\n  { value: 'uncategorized', label: 'Uncategorized', deductible: false, pct: 0 },\n]\n\nexport default function TransactionReview() {\n  const { state, updateState } = useFortuna()\n  const [filter, setFilter] = useState<FilterMode>('all')\n  const [sortField, setSortField] = useState<SortField>('date')\n  const [sortAsc, setSortAsc] = useState(false)\n  const [searchQuery, setSearchQuery] = useState('')\n  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set())\n  const [editingId, setEditingId] = useState<string | null>(null)\n  const [editCategory, setEditCategory] = useState('')\n  const [bulkCategory, setBulkCategory] = useState('')\n  const [showStats, setShowStats] = useState(true)\n\n  // Build reviewable transactions from state\n  const transactions: ReviewableTransaction[] = useMemo(() => {\n    return (state.bankTransactions || []).map(txn => ({\n      ...txn,\n      enrichment: (txn as any).enrichment || {\n        fortunaCategory: txn.category || 'uncategorized',\n        isDeductible: false,\n        deductionPct: 0,\n        isTaxPayment: false,\n        is1099Reportable: false,\n        confidence: 0.5,\n        needsReview: !txn.isReconciled,\n      },\n      userOverride: (txn as any).userOverride,\n    }))\n  }, [state.bankTransactions])\n\n  // Stats\n  const stats = useMemo(() => {\n    let deductibleCount = 0, deductibleAmount = 0\n    let taxPayments = 0, taxPaymentAmount = 0\n    let needsReview = 0, approved = 0\n    const byCategory: Record<string, { count: number; amount: number }> = {}\n\n    for (const txn of transactions) {\n      const cat = txn.userOverride?.category || txn.enrichment?.fortunaCategory || 'uncategorized'\n      if (!byCategory[cat]) byCategory[cat] = { count: 0, amount: 0 }\n      byCategory[cat].count++\n      byCategory[cat].amount += Math.abs(txn.amount)\n\n      const isDeductible = txn.userOverride?.isDeductible ?? txn.enrichment?.isDeductible\n      if (isDeductible && txn.amount < 0) {\n        deductibleCount++\n        const pct = txn.userOverride?.deductionPct ?? txn.enrichment?.deductionPct ?? 100\n        deductibleAmount += Math.abs(txn.amount) * (pct / 100)\n      }\n      if (txn.enrichment?.isTaxPayment) { taxPayments++; taxPaymentAmount += Math.abs(txn.amount) }\n      if (txn.enrichment?.needsReview && !txn.userOverride?.approved) needsReview++\n      if (txn.userOverride?.approved || txn.isReconciled) approved++\n    }\n\n    return {\n      total: transactions.length, deductibleCount, deductibleAmount: Math.round(deductibleAmount),\n      taxPayments, taxPaymentAmount: Math.round(taxPaymentAmount),\n      needsReview, approved,\n      topCategories: Object.entries(byCategory)\n        .sort((a, b) => b[1].amount - a[1].amount)\n        .slice(0, 8),\n    }\n  }, [transactions])\n\n  // Filter + sort + search\n  const filtered = useMemo(() => {\n    let result = [...transactions]\n\n    // Filter\n    switch (filter) {\n      case 'needs_review': result = result.filter(t => (t.enrichment?.needsReview && !t.userOverride?.approved)); break\n      case 'deductible': result = result.filter(t => t.userOverride?.isDeductible ?? t.enrichment?.isDeductible); break\n      case 'tax_payments': result = result.filter(t => t.enrichment?.isTaxPayment); break\n      case 'high_value': result = result.filter(t => Math.abs(t.amount) >= 500); break\n      case 'approved': result = result.filter(t => t.userOverride?.approved || t.isReconciled); break\n    }\n\n    // Search\n    if (searchQuery.trim()) {\n      const q = searchQuery.toLowerCase()\n      result = result.filter(t =>\n        t.description.toLowerCase().includes(q) ||\n        (t.enrichment?.merchantName || '').toLowerCase().includes(q) ||\n        (t.enrichment?.fortunaCategory || '').includes(q),\n      )\n    }\n\n    // Sort\n    result.sort((a, b) => {\n      let cmp = 0\n      switch (sortField) {\n        case 'date': cmp = a.date.localeCompare(b.date); break\n        case 'amount': cmp = Math.abs(a.amount) - Math.abs(b.amount); break\n        case 'category': cmp = (a.enrichment?.fortunaCategory || '').localeCompare(b.enrichment?.fortunaCategory || ''); break\n        case 'confidence': cmp = (a.enrichment?.confidence || 0) - (b.enrichment?.confidence || 0); break\n      }\n      return sortAsc ? cmp : -cmp\n    })\n\n    return result\n  }, [transactions, filter, sortField, sortAsc, searchQuery])\n\n  // ── Handlers ──────────────────────────────────────────────────────────\n\n  const handleOverride = useCallback((txnId: string, category: string) => {\n    const catInfo = TAX_CATEGORIES.find(c => c.value === category)\n    updateState((prev: FortunaState) => ({\n      ...prev,\n      bankTransactions: (prev.bankTransactions || []).map(t =>\n        t.id === txnId ? {\n          ...t,\n          category,\n          isReconciled: true,\n          userOverride: {\n            category,\n            isDeductible: catInfo?.deductible || false,\n            deductionPct: catInfo?.pct || 0,\n            approved: true,\n          },\n        } as any : t,\n      ),\n    }))\n    setEditingId(null)\n  }, [updateState])\n\n  const handleBulkApprove = useCallback(() => {\n    if (selectedIds.size === 0) return\n    updateState((prev: FortunaState) => ({\n      ...prev,\n      bankTransactions: (prev.bankTransactions || []).map(t =>\n        selectedIds.has(t.id)\n          ? { ...t, isReconciled: true, userOverride: { ...((t as any).userOverride || {}), approved: true } } as any\n          : t,\n      ),\n    }))\n    setSelectedIds(new Set())\n  }, [selectedIds, updateState])\n\n  const handleBulkCategorize = useCallback(() => {\n    if (selectedIds.size === 0 || !bulkCategory) return\n    const catInfo = TAX_CATEGORIES.find(c => c.value === bulkCategory)\n    updateState((prev: FortunaState) => ({\n      ...prev,\n      bankTransactions: (prev.bankTransactions || []).map(t =>\n        selectedIds.has(t.id) ? {\n          ...t, category: bulkCategory, isReconciled: true,\n          userOverride: { category: bulkCategory, isDeductible: catInfo?.deductible || false, deductionPct: catInfo?.pct || 0, approved: true },\n        } as any : t,\n      ),\n    }))\n    setSelectedIds(new Set())\n    setBulkCategory('')\n  }, [selectedIds, bulkCategory, updateState])\n\n  const toggleSelect = (id: string) => {\n    setSelectedIds(prev => {\n      const next = new Set(prev)\n      next.has(id) ? next.delete(id) : next.add(id)\n      return next\n    })\n  }\n\n  const toggleSelectAll = () => {\n    if (selectedIds.size === filtered.length) {\n      setSelectedIds(new Set())\n    } else {\n      setSelectedIds(new Set(filtered.map(t => t.id)))\n    }\n  }\n\n  const handleSort = (field: SortField) => {\n    if (sortField === field) setSortAsc(!sortAsc)\n    else { setSortField(field); setSortAsc(false) }\n  }\n\n  // ── Styles ────────────────────────────────────────────────────────────\n\n  const card: React.CSSProperties = { background: '#1a1a2e', borderRadius: 12, border: '1px solid #2a2a4a', padding: 20 }\n  const btn = (color: string, small = false): React.CSSProperties => ({\n    background: color, color: '#fff', border: 'none', borderRadius: 8,\n    padding: small ? '5px 10px' : '8px 16px', cursor: 'pointer',\n    fontSize: small ? 11 : 13, fontWeight: 600,\n  })\n  const filterBtn = (active: boolean): React.CSSProperties => ({\n    ...btn(active ? '#6366f1' : '#2a2a4a', true), opacity: active ? 1 : 0.7,\n  })\n  const badge = (color: string): React.CSSProperties => ({\n    display: 'inline-block', padding: '2px 7px', borderRadius: 10,\n    fontSize: 10, fontWeight: 600, color: '#fff', background: color,\n  })\n  const thStyle: React.CSSProperties = {\n    padding: '8px 10px', textAlign: 'left', fontSize: 11, fontWeight: 600,\n    color: '#9ca3af', textTransform: 'uppercase', letterSpacing: 0.5,\n    cursor: 'pointer', userSelect: 'none', borderBottom: '1px solid #2a2a4a',\n  }\n  const tdStyle: React.CSSProperties = {\n    padding: '8px 10px', fontSize: 13, borderBottom: '1px solid #1a1a2e',\n  }\n\n  // ── Render ────────────────────────────────────────────────────────────\n\n  return (\n    <div style={{ maxWidth: 1100, margin: '0 auto', padding: 24, color: '#e5e7eb' }}>\n      {/* Header */}\n      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 }}>\n        <div>\n          <h2 style={{ margin: 0, fontSize: 22, color: '#fff' }}>Transaction Review</h2>\n          <p style={{ margin: '4px 0 0', fontSize: 13, color: '#9ca3af' }}>\n            Review tax categorizations, confirm deductions, and approve transactions\n          </p>\n        </div>\n        <button style={btn(showStats ? '#4b5563' : '#6366f1', true)} onClick={() => setShowStats(!showStats)}>\n          {showStats ? 'Hide Stats' : 'Show Stats'}\n        </button>\n      </div>\n\n      {/* Stats Dashboard */}\n      {showStats && (\n        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: 10, marginBottom: 20 }}>\n          {[\n            { label: 'Total', value: stats.total, color: '#e5e7eb' },\n            { label: 'Deductible', value: `$${stats.deductibleAmount.toLocaleString()}`, color: '#22c55e' },\n            { label: 'Tax Payments', value: `$${stats.taxPaymentAmount.toLocaleString()}`, color: '#f59e0b' },\n            { label: 'Needs Review', value: stats.needsReview, color: stats.needsReview > 0 ? '#ef4444' : '#22c55e' },\n            { label: 'Approved', value: stats.approved, color: '#22c55e' },\n          ].map((s, i) => (\n            <div key={i} style={{ background: '#1a1a2e', borderRadius: 10, border: '1px solid #2a2a4a', padding: 14, textAlign: 'center' }}>\n              <div style={{ fontSize: 11, color: '#6b7280', textTransform: 'uppercase', letterSpacing: 1 }}>{s.label}</div>\n              <div style={{ fontSize: 20, fontWeight: 700, color: s.color, marginTop: 4 }}>{s.value}</div>\n            </div>\n          ))}\n        </div>\n      )}\n\n      {/* Top Categories */}\n      {showStats && stats.topCategories.length > 0 && (\n        <div style={{ ...card, marginBottom: 20 }}>\n          <h4 style={{ margin: '0 0 10px', fontSize: 13, color: '#9ca3af' }}>Top Categories</h4>\n          <div style={{ display: 'flex', flexWrap: 'wrap', gap: 8 }}>\n            {stats.topCategories.map(([cat, { count, amount }]) => {\n              const catInfo = TAX_CATEGORIES.find(c => c.value === cat)\n              return (\n                <div key={cat} style={{\n                  padding: '6px 12px', background: '#0d0d1a', borderRadius: 8, border: '1px solid #2a2a4a',\n                  fontSize: 12, display: 'flex', gap: 6, alignItems: 'center',\n                }}>\n                  <span style={{ color: catInfo?.deductible ? '#22c55e' : '#6b7280' }}>\n                    {catInfo?.deductible ? '✓' : '○'}\n                  </span>\n                  <span style={{ color: '#e5e7eb', fontWeight: 500 }}>{cat.replace(/_/g, ' ')}</span>\n                  <span style={{ color: '#6b7280' }}>{count}</span>\n                  <span style={{ color: '#9ca3af', fontWeight: 600 }}>${amount.toLocaleString(undefined, { maximumFractionDigits: 0 })}</span>\n                </div>\n              )\n            })}\n          </div>\n        </div>\n      )}\n\n      {/* Filters + Search */}\n      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16, flexWrap: 'wrap', gap: 8 }}>\n        <div style={{ display: 'flex', gap: 6 }}>\n          {([\n            ['all', 'All'],\n            ['needs_review', `Review (${stats.needsReview})`],\n            ['deductible', 'Deductible'],\n            ['tax_payments', 'Tax Payments'],\n            ['high_value', '$500+'],\n            ['approved', 'Approved'],\n          ] as [FilterMode, string][]).map(([f, label]) => (\n            <button key={f} style={filterBtn(filter === f)} onClick={() => setFilter(f)}>{label}</button>\n          ))}\n        </div>\n        <input\n          type=\"text\"\n          value={searchQuery}\n          onChange={e => setSearchQuery(e.target.value)}\n          placeholder=\"Search transactions...\"\n          style={{\n            padding: '6px 12px', borderRadius: 8, border: '1px solid #3a3a5a',\n            background: '#0d0d1a', color: '#e5e7eb', fontSize: 13, width: 220, outline: 'none',\n          }}\n        />\n      </div>\n\n      {/* Bulk Actions */}\n      {selectedIds.size > 0 && (\n        <div style={{\n          padding: '8px 16px', background: '#1a1a3e', borderRadius: 10, marginBottom: 12,\n          display: 'flex', alignItems: 'center', gap: 12, border: '1px solid #6366f1',\n        }}>\n          <span style={{ fontSize: 13, fontWeight: 600, color: '#a5b4fc' }}>{selectedIds.size} selected</span>\n          <button style={btn('#22c55e', true)} onClick={handleBulkApprove}>✓ Approve All</button>\n          <select\n            value={bulkCategory}\n            onChange={e => setBulkCategory(e.target.value)}\n            style={{ padding: '4px 8px', borderRadius: 6, background: '#0d0d1a', color: '#e5e7eb', border: '1px solid #3a3a5a', fontSize: 12 }}\n          >\n            <option value=\"\">Categorize as...</option>\n            {TAX_CATEGORIES.map(c => <option key={c.value} value={c.value}>{c.label}</option>)}\n          </select>\n          {bulkCategory && <button style={btn('#6366f1', true)} onClick={handleBulkCategorize}>Apply</button>}\n          <button style={btn('#4b5563', true)} onClick={() => setSelectedIds(new Set())}>Clear</button>\n        </div>\n      )}\n\n      {/* Transaction Table */}\n      {filtered.length > 0 ? (\n        <div style={{ ...card, padding: 0, overflow: 'hidden' }}>\n          <div style={{ overflowX: 'auto' }}>\n            <table style={{ width: '100%', borderCollapse: 'collapse' }}>\n              <thead>\n                <tr style={{ background: '#0d0d1a' }}>\n                  <th style={{ ...thStyle, width: 30 }}>\n                    <input type=\"checkbox\" checked={selectedIds.size === filtered.length && filtered.length > 0} onChange={toggleSelectAll} />\n                  </th>\n                  <th style={thStyle} onClick={() => handleSort('date')}>Date {sortField === 'date' ? (sortAsc ? '↑' : '↓') : ''}</th>\n                  <th style={thStyle}>Description</th>\n                  <th style={thStyle} onClick={() => handleSort('category')}>Category {sortField === 'category' ? (sortAsc ? '↑' : '↓') : ''}</th>\n                  <th style={thStyle} onClick={() => handleSort('amount')}>Amount {sortField === 'amount' ? (sortAsc ? '↑' : '↓') : ''}</th>\n                  <th style={thStyle}>Tax Status</th>\n                  <th style={{ ...thStyle, width: 60 }} onClick={() => handleSort('confidence')}>Conf</th>\n                  <th style={{ ...thStyle, width: 80 }}>Action</th>\n                </tr>\n              </thead>\n              <tbody>\n                {filtered.slice(0, 200).map(txn => {\n                  const cat = txn.userOverride?.category || txn.enrichment?.fortunaCategory || 'uncategorized'\n                  const isDeductible = txn.userOverride?.isDeductible ?? txn.enrichment?.isDeductible\n                  const needsReview = txn.enrichment?.needsReview && !txn.userOverride?.approved\n                  const isApproved = txn.userOverride?.approved || txn.isReconciled\n                  const confidence = txn.enrichment?.confidence || 0\n\n                  return (\n                    <tr key={txn.id} style={{\n                      background: selectedIds.has(txn.id) ? 'rgba(99,102,241,0.08)' : needsReview ? 'rgba(245,158,11,0.04)' : 'transparent',\n                    }}>\n                      <td style={tdStyle}>\n                        <input type=\"checkbox\" checked={selectedIds.has(txn.id)} onChange={() => toggleSelect(txn.id)} />\n                      </td>\n                      <td style={{ ...tdStyle, whiteSpace: 'nowrap', fontSize: 12, color: '#9ca3af' }}>{txn.date}</td>\n                      <td style={{ ...tdStyle, maxWidth: 260 }}>\n                        <div style={{ fontSize: 13, fontWeight: 500, color: '#e5e7eb', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>\n                          {txn.enrichment?.merchantName || txn.description}\n                        </div>\n                        {txn.accountName && <div style={{ fontSize: 10, color: '#4b5563' }}>{txn.accountName}</div>}\n                      </td>\n                      <td style={tdStyle}>\n                        {editingId === txn.id ? (\n                          <select\n                            value={editCategory || cat}\n                            onChange={e => { setEditCategory(e.target.value); handleOverride(txn.id, e.target.value) }}\n                            style={{ padding: '3px 6px', borderRadius: 6, background: '#0d0d1a', color: '#e5e7eb', border: '1px solid #6366f1', fontSize: 11 }}\n                            autoFocus\n                            onBlur={() => setEditingId(null)}\n                          >\n                            {TAX_CATEGORIES.map(c => <option key={c.value} value={c.value}>{c.label}</option>)}\n                          </select>\n                        ) : (\n                          <span\n                            style={{ ...badge(isDeductible ? '#166534' : '#4b5563'), cursor: 'pointer' }}\n                            onClick={() => { setEditingId(txn.id); setEditCategory(cat) }}\n                            title=\"Click to change category\"\n                          >\n                            {cat.replace(/_/g, ' ')}\n                          </span>\n                        )}\n                      </td>\n                      <td style={{\n                        ...tdStyle, fontWeight: 600, fontVariantNumeric: 'tabular-nums',\n                        color: txn.amount >= 0 ? '#22c55e' : '#ef4444',\n                      }}>\n                        {txn.amount >= 0 ? '+' : ''}{txn.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                      </td>\n                      <td style={tdStyle}>\n                        <div style={{ display: 'flex', gap: 4, flexWrap: 'wrap' }}>\n                          {isDeductible && <span style={badge('#22c55e')}>DEDUCT</span>}\n                          {txn.enrichment?.isTaxPayment && <span style={badge('#f59e0b')}>TAX PMT</span>}\n                          {txn.enrichment?.is1099Reportable && <span style={badge('#8b5cf6')}>1099</span>}\n                          {isApproved && <span style={badge('#3b82f6')}>✓</span>}\n                        </div>\n                      </td>\n                      <td style={{ ...tdStyle, textAlign: 'center' }}>\n                        <div style={{\n                          width: 24, height: 24, borderRadius: '50%', display: 'inline-flex',\n                          alignItems: 'center', justifyContent: 'center', fontSize: 10, fontWeight: 700,\n                          background: confidence >= 0.8 ? '#166534' : confidence >= 0.6 ? '#854d0e' : '#7f1d1d',\n                          color: '#fff',\n                        }}>\n                          {Math.round(confidence * 100)}\n                        </div>\n                      </td>\n                      <td style={tdStyle}>\n                        {!isApproved ? (\n                          <button\n                            style={btn('#22c55e', true)}\n                            onClick={() => handleOverride(txn.id, cat)}\n                          >✓</button>\n                        ) : (\n                          <span style={{ fontSize: 11, color: '#22c55e' }}>Done</span>\n                        )}\n                      </td>\n                    </tr>\n                  )\n                })}\n              </tbody>\n            </table>\n          </div>\n          {filtered.length > 200 && (\n            <div style={{ padding: 12, textAlign: 'center', fontSize: 12, color: '#6b7280' }}>\n              Showing 200 of {filtered.length} transactions\n            </div>\n          )}\n        </div>\n      ) : (\n        <div style={{ ...card, textAlign: 'center', padding: 48 }}>\n          <div style={{ fontSize: 36, marginBottom: 12 }}>📊</div>\n          <h3 style={{ color: '#fff', margin: '0 0 8px' }}>No transactions to review</h3>\n          <p style={{ color: '#9ca3af', fontSize: 14, maxWidth: 400, margin: '0 auto' }}>\n            {transactions.length === 0\n              ? 'Connect a bank account or import transactions to start reviewing tax categorizations.'\n              : `No transactions match the \"${filter}\" filter. Try a different filter.`}\n          </p>\n        </div>\n      )}\n\n      {/* Footer: Deduction summary */}\n      {stats.deductibleAmount > 0 && (\n        <div style={{ marginTop: 16, padding: '12px 20px', background: 'rgba(34,197,94,0.08)', borderRadius: 10, border: '1px solid #22c55e33' }}>\n          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\n            <div>\n              <span style={{ fontSize: 13, color: '#22c55e', fontWeight: 600 }}>\n                💰 Identified Deductions: ${stats.deductibleAmount.toLocaleString()}\n              </span>\n              <span style={{ fontSize: 12, color: '#6b7280', marginLeft: 8 }}>\n                across {stats.deductibleCount} transactions\n              </span>\n            </div>\n            <div style={{ fontSize: 12, color: '#9ca3af' }}>\n              Estimated tax savings: ~${Math.round(stats.deductibleAmount * 0.25).toLocaleString()} (at 25% marginal rate)\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\Workflows.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'generateTaxReport' is defined but never used.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":27,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"generateTaxReport"},"fix":{"range":[100,118],"text":""},"desc":"Remove unused variable \"generateTaxReport\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'detectStrategies' is defined but never used.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":26,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"detectStrategies"},"fix":{"range":[311,374],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Zap' is defined but never used.","line":7,"column":38,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":41,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Zap"},"fix":{"range":[418,423],"text":""},"desc":"Remove unused variable \"Zap\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DollarSign' is defined but never used.","line":8,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":25,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DollarSign"},"fix":{"range":[466,478],"text":""},"desc":"Remove unused variable \"DollarSign\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Circle' is defined but never used.","line":8,"column":51,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":57,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Circle"},"fix":{"range":[502,510],"text":""},"desc":"Remove unused variable \"Circle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'healthScore' is assigned a value but never used.","line":36,"column":41,"nodeType":"Identifier","messageId":"unusedVar","endLine":36,"endColumn":52},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'alerts' is assigned a value but never used.","line":41,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":41,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":88,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":88,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3991,3994],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3991,3994],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":132,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":132,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6282,6285],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6282,6285],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":164,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":164,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7589,7592],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7589,7592],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":174,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":174,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7990,7993],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7990,7993],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":223,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":223,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10589,10592],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10589,10592],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has an unnecessary dependency: 'entities'. Either exclude it or remove the dependency array.","line":270,"column":6,"nodeType":"ArrayExpression","endLine":270,"endColumn":145,"suggestions":[{"desc":"Update the dependencies array to be: [state, ctx, taxReport, strategies, netSEIncome, selfEmploymentIncome, totalIncome, profile, deductions, hasScorp, incomeStreams]","fix":{"range":[12426,12565],"text":"[state, ctx, taxReport, strategies, netSEIncome, selfEmploymentIncome, totalIncome, profile, deductions, hasScorp, incomeStreams]"}}]}],"suppressedMessages":[],"errorCount":12,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from 'react'\nimport { useFortuna } from '../hooks/useFortuna'\nimport { generateTaxReport, calculateSCorpSavings, calculateMaxSEPIRA, calculateMaxSolo401k } from '../engine/tax-calculator'\nimport { getQuarterContext, generateProactiveAlerts } from '../engine/proactive-intelligence'\nimport { detectStrategies } from '../engine/strategy-detector'\nimport {\n  Compass, ArrowRight, ChevronRight, Zap, Building2, Shield, Calendar,\n  TrendingUp, DollarSign, PiggyBank, CheckCircle, Circle, Lock\n} from 'lucide-react'\nimport type { ViewKey } from '../App'\n\ninterface Workflow {\n  id: string\n  title: string\n  subtitle: string\n  description: string\n  icon: React.ReactNode\n  color: string\n  estimatedTime: string\n  steps: WorkflowStep[]\n  isAvailable: boolean\n  unavailableReason?: string\n}\n\ninterface WorkflowStep {\n  id: string\n  title: string\n  description: string\n  action?: string\n  navigateTo?: ViewKey | 'workflows'\n  insight?: string\n  isComplete?: boolean\n}\n\nexport function Workflows({ onNavigate }: { onNavigate?: (view: ViewKey) => void }) {\n  const { state, taxReport, strategies, healthScore } = useFortuna()\n  const [activeWorkflow, setActiveWorkflow] = useState<string | null>(null)\n  const [completedSteps, setCompletedSteps] = useState<Set<string>>(new Set())\n  \n  const ctx = getQuarterContext()\n  const alerts = useMemo(() => generateProactiveAlerts(state), [state])\n  \n  const { profile, incomeStreams, expenses, deductions, entities } = state\n  const totalIncome = incomeStreams.filter(s => s.isActive).reduce((sum, s) => sum + s.annualAmount, 0)\n  const selfEmploymentIncome = incomeStreams\n    .filter(s => ['business', 'freelance'].includes(s.type) && s.isActive)\n    .reduce((sum, s) => sum + s.annualAmount, 0)\n  const totalExpenses = expenses.filter(e => e.isDeductible).reduce((sum, e) => sum + (e.annualAmount * e.deductionPct / 100), 0)\n  const netSEIncome = selfEmploymentIncome - totalExpenses\n  const hasScorp = entities.some(e => (e.type === 'llc_scorp' || e.type === 'scorp') && e.isActive)\n  \n  const workflows: Workflow[] = useMemo(() => [\n    {\n      id: 'optimize-quarter',\n      title: `Optimize Q${ctx.quarter}`,\n      subtitle: `${ctx.daysLeftInQuarter} days remaining`,\n      description: `Make the most of Q${ctx.quarter} with targeted strategies for the next ${ctx.daysLeftInQuarter} days.`,\n      icon: <Calendar size={22} />,\n      color: '#f59e0b',\n      estimatedTime: '10 min',\n      isAvailable: true,\n      steps: [\n        {\n          id: 'oq-1', title: 'Review Current Tax Position',\n          description: `Your effective tax rate is ${taxReport.effectiveRate.toFixed(1)}% on $${Math.round(taxReport.taxableIncome).toLocaleString()} taxable income.`,\n          navigateTo: 'tax',\n          insight: `${strategies.length} optimization strategies identified`,\n        },\n        {\n          id: 'oq-2', title: 'Check Estimated Tax Payments',\n          description: `Quarterly estimated payment should be ~$${Math.round(taxReport.totalFederalTax / 4).toLocaleString()}. Ensure you're on track to avoid underpayment penalties.`,\n          navigateTo: 'cashflow',\n        },\n        {\n          id: 'oq-3', title: 'Review Deduction Opportunities',\n          description: 'Check for missing deductions and pre-pay deductible expenses before quarter-end.',\n          navigateTo: 'setup',\n          insight: deductions.length < 3 ? 'You may have unclaimed deductions' : undefined,\n        },\n        {\n          id: 'oq-4', title: 'Check Retirement Contributions',\n          description: netSEIncome > 30000 ? `You could contribute up to $${Math.round(calculateMaxSolo401k(netSEIncome, profile.age).total).toLocaleString()} to a Solo 401(k).` : 'Review retirement savings strategy.',\n          navigateTo: 'tax',\n        },\n        {\n          id: 'oq-5', title: 'Generate 1040-ES Voucher',\n          description: 'Create your estimated tax payment worksheet for the current quarter.',\n          navigateTo: 'documents' as any,\n        },\n      ],\n    },\n    {\n      id: 'entity-evaluation',\n      title: 'Should I Form an LLC?',\n      subtitle: hasScorp ? 'You already have an entity' : 'Entity analysis',\n      description: 'Walk through the decision framework for whether an LLC (with optional S-Corp election) makes sense for your situation.',\n      icon: <Building2 size={22} />,\n      color: '#3b82f6',\n      estimatedTime: '8 min',\n      isAvailable: selfEmploymentIncome > 0,\n      unavailableReason: 'Requires self-employment income',\n      steps: [\n        {\n          id: 'ee-1', title: 'Assess Self-Employment Income',\n          description: `Your net self-employment income is $${Math.round(netSEIncome).toLocaleString()}/year. ${netSEIncome > 50000 ? 'This is above the threshold where entity structuring typically saves money.' : 'Entity savings typically become meaningful above $50,000.'}`,\n          insight: netSEIncome > 50000 ? 'Strong candidate for entity structuring' : 'May not yet justify entity complexity',\n        },\n        {\n          id: 'ee-2', title: 'Compare Entity Types',\n          description: 'View side-by-side comparison of sole proprietorship, LLC, and S-Corp tax treatment.',\n          navigateTo: 'entity',\n        },\n        {\n          id: 'ee-3', title: 'Calculate S-Corp Savings',\n          description: (() => {\n            if (netSEIncome > 50000) {\n              const salary = Math.round(Math.max(netSEIncome * 0.5, Math.min(netSEIncome * 0.7, 80000)))\n              const savings = calculateSCorpSavings(netSEIncome, salary)\n              return `S-Corp could save ~$${savings.savings.toLocaleString()}/yr by splitting income between salary ($${salary.toLocaleString()}) and distributions.`\n            }\n            return 'S-Corp savings analysis requires higher income levels.'\n          })(),\n          navigateTo: 'entity',\n        },\n        {\n          id: 'ee-4', title: 'Review Compliance Requirements',\n          description: 'Understand ongoing costs: payroll ($50-200/mo), annual state filings, tax return preparation, and corporate formalities.',\n        },\n        {\n          id: 'ee-5', title: 'Generate Formation Checklist',\n          description: `Get a step-by-step formation guide for ${profile.state}.`,\n          navigateTo: 'documents' as any,\n        },\n        {\n          id: 'ee-6', title: 'Model the Scenario',\n          description: 'Create side-by-side scenario comparison of your current structure vs. new entity.',\n          navigateTo: 'scenarios',\n        },\n      ],\n    },\n    {\n      id: 'audit-prep',\n      title: 'Prepare for Audit',\n      subtitle: 'Audit readiness assessment',\n      description: 'Ensure you have complete documentation and understand your risk profile.',\n      icon: <Shield size={22} />,\n      color: '#ef4444',\n      estimatedTime: '12 min',\n      isAvailable: state.onboardingComplete,\n      steps: [\n        {\n          id: 'ap-1', title: 'Check Your Audit Risk Score',\n          description: 'Review your IRS DIF score simulation and identify which items draw the most attention.',\n          navigateTo: 'audit',\n        },\n        {\n          id: 'ap-2', title: 'Review Deduction-to-Income Ratios',\n          description: 'High deduction ratios in specific categories trigger IRS scrutiny. Check if any of yours are above threshold.',\n          navigateTo: 'audit',\n        },\n        {\n          id: 'ap-3', title: 'Generate Audit Preparedness Checklist',\n          description: 'Get a personalized list of every document you should have organized and accessible.',\n          navigateTo: 'documents' as any,\n        },\n        {\n          id: 'ap-4', title: 'Review Risk Matrix',\n          description: 'Understand your overall risk profile and mitigation strategies.',\n          navigateTo: 'risk',\n        },\n        {\n          id: 'ap-5', title: 'Generate CPA Package',\n          description: 'Create a comprehensive handoff document for your tax professional.',\n          navigateTo: 'documents' as any,\n        },\n      ],\n    },\n    {\n      id: 'maximize-retirement',\n      title: 'Maximize Retirement Savings',\n      subtitle: 'Tax-advantaged contributions',\n      description: 'Optimize retirement contributions across all available accounts to minimize current taxes and build wealth.',\n      icon: <PiggyBank size={22} />,\n      color: '#10b981',\n      estimatedTime: '7 min',\n      isAvailable: totalIncome > 20000,\n      unavailableReason: 'Requires income data',\n      steps: [\n        {\n          id: 'mr-1', title: 'Calculate Maximum Contribution Limits',\n          description: (() => {\n            if (netSEIncome > 0) {\n              const sep = calculateMaxSEPIRA(netSEIncome)\n              const solo = calculateMaxSolo401k(netSEIncome, profile.age)\n              return `SEP-IRA max: $${Math.round(sep).toLocaleString()} | Solo 401(k) max: $${Math.round(solo.total).toLocaleString()} (employee: $${Math.round(solo.employeeDeferral || 0).toLocaleString()} + employer: $${Math.round(solo.employerContribution || 0).toLocaleString()})`\n            }\n            return 'Roth IRA: $7,000 ($8,000 if 50+) | Traditional IRA: $7,000 ($8,000 if 50+)'\n          })(),\n        },\n        {\n          id: 'mr-2', title: 'Choose the Best Account Type',\n          description: netSEIncome > 50000 ? 'Solo 401(k) offers the highest contribution limits for self-employed individuals. Consider this over SEP-IRA.' : 'Compare Roth vs Traditional IRA based on your current and expected future tax rates.',\n          navigateTo: 'tax',\n        },\n        {\n          id: 'mr-3', title: 'Calculate Tax Savings',\n          description: (() => {\n            if (netSEIncome > 30000) {\n              const maxContrib = calculateMaxSolo401k(netSEIncome, profile.age).total\n              const currentRetirement = deductions.filter(d => d.category === 'retirement').reduce((s, d) => s + d.amount, 0)\n              const gap = maxContrib - currentRetirement\n              const savings = gap * (taxReport.effectiveRate / 100)\n              return gap > 0\n                ? `Maximizing contributions could save ~$${Math.round(savings).toLocaleString()} in taxes this year.`\n                : 'You\\'re maximizing your retirement contributions — great work!'\n            }\n            return 'Review potential tax savings from retirement contributions.'\n          })(),\n        },\n        {\n          id: 'mr-4', title: 'Check Contribution Deadlines',\n          description: 'Employee 401(k) deferrals: Dec 31 | Employer contributions: Tax filing deadline | IRA: April 15',\n          navigateTo: 'calendar' as any,\n        },\n        {\n          id: 'mr-5', title: 'Update Deductions',\n          description: 'Add or update retirement contribution amounts in your profile.',\n          navigateTo: 'setup',\n        },\n      ],\n    },\n    {\n      id: 'grow-revenue',\n      title: 'Scale Revenue',\n      subtitle: 'Revenue optimization',\n      description: 'Analyze income diversification opportunities and optimize your revenue engine.',\n      icon: <TrendingUp size={22} />,\n      color: '#8b5cf6',\n      estimatedTime: '8 min',\n      isAvailable: state.onboardingComplete,\n      steps: [\n        {\n          id: 'gr-1', title: 'Assess Current Income Mix',\n          description: `You have ${incomeStreams.filter(s => s.isActive).length} active income stream(s) totaling $${totalIncome.toLocaleString()}/yr.`,\n          navigateTo: 'revenue',\n          insight: incomeStreams.filter(s => s.isActive).length <= 1 ? 'Single income stream — consider diversification' : undefined,\n        },\n        {\n          id: 'gr-2', title: 'Review Entity Flow',\n          description: 'Visualize how money flows through your entity structure and identify optimization points.',\n          navigateTo: 'flow',\n        },\n        {\n          id: 'gr-3', title: 'Model Growth Scenarios',\n          description: 'Use the scenario modeler to project income growth and understand tax implications.',\n          navigateTo: 'scenarios',\n        },\n        {\n          id: 'gr-4', title: 'Review Revenue Strategies',\n          description: 'Explore revenue engine recommendations for your business profile.',\n          navigateTo: 'revenue',\n        },\n        {\n          id: 'gr-5', title: 'Check Cash Flow Projections',\n          description: 'Ensure revenue growth plans align with cash flow needs.',\n          navigateTo: 'cashflow',\n        },\n      ],\n    },\n  ], [state, ctx, taxReport, strategies, netSEIncome, selfEmploymentIncome, totalIncome, profile, deductions, entities, hasScorp, incomeStreams])\n  \n  const activeWf = workflows.find(w => w.id === activeWorkflow)\n  \n  const toggleStep = (stepId: string) => {\n    setCompletedSteps(prev => {\n      const next = new Set(prev)\n      if (next.has(stepId)) next.delete(stepId)\n      else next.add(stepId)\n      return next\n    })\n  }\n  \n  return (\n    <div style={{ padding: 32, maxWidth: 1000 }}>\n      {/* Header */}\n      <div style={{ marginBottom: 32 }}>\n        <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 8 }}>\n          <Compass size={24} style={{ color: 'var(--accent-gold)' }} />\n          <h1 style={{ fontFamily: 'var(--font-display)', fontSize: 28, color: 'var(--text-primary)', margin: 0 }}>\n            Guided Workflows\n          </h1>\n        </div>\n        <p style={{ color: 'var(--text-muted)', fontSize: 14, margin: 0 }}>\n          Mission-oriented paths to specific financial outcomes\n        </p>\n      </div>\n      \n      {!activeWorkflow ? (\n        /* Workflow Selection */\n        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: 16 }}>\n          {workflows.map(wf => (\n            <button\n              key={wf.id}\n              onClick={() => wf.isAvailable && setActiveWorkflow(wf.id)}\n              disabled={!wf.isAvailable}\n              style={{\n                textAlign: 'left', padding: 24, borderRadius: 16,\n                border: `1px solid ${wf.isAvailable ? 'var(--border-subtle)' : 'var(--border-subtle)'}`,\n                background: wf.isAvailable ? 'var(--bg-elevated)' : 'var(--bg-primary)',\n                cursor: wf.isAvailable ? 'pointer' : 'not-allowed',\n                opacity: wf.isAvailable ? 1 : 0.5,\n                transition: 'all 0.2s',\n              }}\n              onMouseEnter={e => {\n                if (wf.isAvailable) {\n                  e.currentTarget.style.borderColor = wf.color\n                  e.currentTarget.style.transform = 'translateY(-2px)'\n                }\n              }}\n              onMouseLeave={e => {\n                e.currentTarget.style.borderColor = 'var(--border-subtle)'\n                e.currentTarget.style.transform = 'translateY(0)'\n              }}\n            >\n              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 12 }}>\n                <div style={{\n                  width: 44, height: 44, borderRadius: 12,\n                  background: `${wf.color}15`, color: wf.color,\n                  display: 'flex', alignItems: 'center', justifyContent: 'center',\n                }}>\n                  {wf.isAvailable ? wf.icon : <Lock size={22} />}\n                </div>\n                <div style={{ fontSize: 11, color: 'var(--text-muted)', fontFamily: 'var(--font-mono)' }}>\n                  ~{wf.estimatedTime}\n                </div>\n              </div>\n              \n              <div style={{ fontSize: 16, fontWeight: 700, color: 'var(--text-primary)', marginBottom: 4 }}>\n                {wf.title}\n              </div>\n              <div style={{ fontSize: 12, color: wf.color, fontWeight: 500, marginBottom: 8 }}>\n                {wf.subtitle}\n              </div>\n              <div style={{ fontSize: 12, color: 'var(--text-muted)', lineHeight: 1.5, marginBottom: 12 }}>\n                {wf.isAvailable ? wf.description : wf.unavailableReason}\n              </div>\n              \n              <div style={{ display: 'flex', alignItems: 'center', gap: 6, fontSize: 12, color: wf.color, fontWeight: 600 }}>\n                {wf.isAvailable ? (\n                  <>Start Workflow <ArrowRight size={14} /></>\n                ) : (\n                  <>Locked</>\n                )}\n              </div>\n              \n              {/* Step count indicator */}\n              <div style={{ display: 'flex', gap: 4, marginTop: 12 }}>\n                {wf.steps.map((_, i) => (\n                  <div key={i} style={{\n                    height: 3, flex: 1, borderRadius: 2,\n                    background: `${wf.color}${wf.isAvailable ? '30' : '10'}`,\n                  }} />\n                ))}\n              </div>\n            </button>\n          ))}\n        </div>\n      ) : activeWf ? (\n        /* Active Workflow */\n        <div>\n          <button\n            onClick={() => { setActiveWorkflow(null); setCompletedSteps(new Set()) }}\n            style={{\n              background: 'transparent', border: 'none', cursor: 'pointer',\n              color: 'var(--text-muted)', fontSize: 13, padding: '0 0 16px', display: 'flex', alignItems: 'center', gap: 6,\n            }}\n          >\n            ← Back to workflows\n          </button>\n          \n          {/* Workflow header */}\n          <div style={{\n            padding: 24, background: 'var(--bg-elevated)', borderRadius: 16, marginBottom: 24,\n            border: '1px solid var(--border-subtle)',\n          }}>\n            <div style={{ display: 'flex', alignItems: 'center', gap: 14 }}>\n              <div style={{\n                width: 48, height: 48, borderRadius: 14,\n                background: `${activeWf.color}15`, color: activeWf.color,\n                display: 'flex', alignItems: 'center', justifyContent: 'center',\n              }}>\n                {activeWf.icon}\n              </div>\n              <div>\n                <div style={{ fontSize: 22, fontWeight: 700, color: 'var(--text-primary)' }}>{activeWf.title}</div>\n                <div style={{ fontSize: 13, color: 'var(--text-muted)' }}>\n                  {completedSteps.size}/{activeWf.steps.length} steps completed\n                </div>\n              </div>\n            </div>\n            \n            {/* Progress bar */}\n            <div style={{ marginTop: 16, height: 6, background: 'var(--bg-primary)', borderRadius: 3, overflow: 'hidden' }}>\n              <div style={{\n                height: '100%', width: `${(completedSteps.size / activeWf.steps.length) * 100}%`,\n                background: activeWf.color, borderRadius: 3, transition: 'width 0.5s ease',\n              }} />\n            </div>\n          </div>\n          \n          {/* Steps */}\n          <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>\n            {activeWf.steps.map((step, i) => {\n              const isComplete = completedSteps.has(step.id)\n              return (\n                <div key={step.id} style={{\n                  padding: 20, borderRadius: 14,\n                  background: isComplete ? `${activeWf.color}08` : 'var(--bg-elevated)',\n                  border: `1px solid ${isComplete ? `${activeWf.color}30` : 'var(--border-subtle)'}`,\n                  transition: 'all 0.3s',\n                }}>\n                  <div style={{ display: 'flex', alignItems: 'flex-start', gap: 14 }}>\n                    {/* Step number / check */}\n                    <button\n                      onClick={() => toggleStep(step.id)}\n                      style={{\n                        width: 28, height: 28, borderRadius: '50%', cursor: 'pointer',\n                        background: isComplete ? activeWf.color : 'var(--bg-primary)',\n                        color: isComplete ? '#fff' : 'var(--text-muted)',\n                        display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0,\n                        fontSize: 12, fontWeight: 700,\n                        border: isComplete ? 'none' : '2px solid var(--border-subtle)',\n                      }}\n                    >\n                      {isComplete ? <CheckCircle size={16} /> : i + 1}\n                    </button>\n                    \n                    <div style={{ flex: 1 }}>\n                      <div style={{\n                        fontSize: 14, fontWeight: 600, color: 'var(--text-primary)',\n                        textDecoration: isComplete ? 'line-through' : 'none',\n                        opacity: isComplete ? 0.6 : 1,\n                      }}>\n                        {step.title}\n                      </div>\n                      <div style={{ fontSize: 12, color: 'var(--text-muted)', marginTop: 4, lineHeight: 1.5 }}>\n                        {step.description}\n                      </div>\n                      \n                      {step.insight && (\n                        <div style={{\n                          marginTop: 8, padding: '6px 12px', borderRadius: 6,\n                          background: `${activeWf.color}10`, fontSize: 11, color: activeWf.color, fontWeight: 500,\n                          display: 'inline-block',\n                        }}>\n                          💡 {step.insight}\n                        </div>\n                      )}\n                    </div>\n                    \n                    {/* Navigate button */}\n                    {step.navigateTo && onNavigate && (\n                      <button\n                        onClick={() => onNavigate(step.navigateTo as ViewKey)}\n                        style={{\n                          padding: '6px 14px', borderRadius: 8, border: '1px solid var(--border-subtle)',\n                          background: 'var(--bg-primary)', color: 'var(--text-secondary)', cursor: 'pointer',\n                          fontSize: 11, fontWeight: 500, display: 'flex', alignItems: 'center', gap: 4,\n                          flexShrink: 0,\n                        }}\n                      >\n                        Go <ChevronRight size={12} />\n                      </button>\n                    )}\n                  </div>\n                </div>\n              )\n            })}\n          </div>\n          \n          {/* Completion state */}\n          {completedSteps.size === activeWf.steps.length && (\n            <div style={{\n              marginTop: 24, padding: 24, textAlign: 'center',\n              background: `${activeWf.color}10`, borderRadius: 16,\n              border: `1px solid ${activeWf.color}30`,\n            }}>\n              <CheckCircle size={40} style={{ color: activeWf.color, marginBottom: 12 }} />\n              <div style={{ fontSize: 18, fontWeight: 700, color: 'var(--text-primary)' }}>\n                Workflow Complete! 🎉\n              </div>\n              <div style={{ fontSize: 13, color: 'var(--text-muted)', marginTop: 6 }}>\n                You've completed all steps in \"{activeWf.title}\"\n              </div>\n            </div>\n          )}\n        </div>\n      ) : null}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\WorkspacePanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Settings' is defined but never used.","line":10,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":24,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Settings"},"fix":{"range":[245,255],"text":""},"desc":"Remove unused variable \"Settings\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'LogOut' is defined but never used.","line":11,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":27,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"LogOut"},"fix":{"range":[301,309],"text":""},"desc":"Remove unused variable \"LogOut\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'X' is defined but never used.","line":12,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":46,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"X"},"fix":{"range":[375,378],"text":""},"desc":"Remove unused variable \"X\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'LogIn' is defined but never used.","line":12,"column":54,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":59,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"LogIn"},"fix":{"range":[384,391],"text":""},"desc":"Remove unused variable \"LogIn\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'leaveWorkspace' is defined but never used.","line":17,"column":48,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":62,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"leaveWorkspace"},"fix":{"range":[583,599],"text":""},"desc":"Remove unused variable \"leaveWorkspace\"."}]},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":82,"column":25,"nodeType":"Identifier","endLine":82,"endColumn":33},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":83,"column":39,"nodeType":"Identifier","endLine":83,"endColumn":47},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":84,"column":35,"nodeType":"Identifier","endLine":84,"endColumn":43},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":85,"column":41,"nodeType":"Identifier","endLine":85,"endColumn":49},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":86,"column":33,"nodeType":"Identifier","endLine":86,"endColumn":41},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":87,"column":29,"nodeType":"Identifier","endLine":87,"endColumn":37},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useCallback\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":89,"column":19,"nodeType":"Identifier","endLine":89,"endColumn":30},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":115,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":115,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5628,5631],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5628,5631],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useEffect\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":121,"column":3,"nodeType":"Identifier","endLine":121,"endColumn":12},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":137,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":137,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6312,6315],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6312,6315],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\WorkspacePanel.tsx:218:7\n  216 |     if (pending) {\n  217 |       sessionStorage.removeItem('fortuna:pending-invite')\n> 218 |       setJoinCode(pending)\n      |       ^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  219 |       setShowJoin(true)\n  220 |     }\n  221 |   }, [])","line":218,"column":7,"nodeType":null,"endLine":218,"endColumn":18},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":230,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":230,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10262,10265],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10262,10265],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":241,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":241,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10530,10533],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10530,10533],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\WorkspacePanel.tsx:329:5\n  327 |\n  328 |   useEffect(() => {\n> 329 |     setLoading(true)\n      |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  330 |     listMembers(ws.id).then(d => setMembers(d.members)).catch(e => setError(e.message)).finally(() => setLoading(false))\n  331 |   }, [ws.id])\n  332 |","line":329,"column":5,"nodeType":null,"endLine":329,"endColumn":15},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'setError'. Either include it or remove the dependency array. If 'setError' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":331,"column":6,"nodeType":"ArrayExpression","endLine":331,"endColumn":13,"suggestions":[{"desc":"Update the dependencies array to be: [setError, ws.id]","fix":{"range":[15338,15345],"text":"[setError, ws.id]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":337,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":337,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15552,15555],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15552,15555],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":352,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":352,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15980,15983],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15980,15983],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":358,"column":82,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":358,"endColumn":85,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16226,16229],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16226,16229],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":359,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":359,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16254,16257],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16254,16257],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\WorkspacePanel.tsx:434:5\n  432 |\n  433 |   useEffect(() => {\n> 434 |     setLoading(true)\n      |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  435 |     listResources(ws.id).then(d => setResources(d.resources)).catch(e => setError(e.message)).finally(() => setLoading(false))\n  436 |   }, [ws.id])\n  437 |","line":434,"column":5,"nodeType":null,"endLine":434,"endColumn":15},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'setError'. Either include it or remove the dependency array. If 'setError' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":436,"column":6,"nodeType":"ArrayExpression","endLine":436,"endColumn":13,"suggestions":[{"desc":"Update the dependencies array to be: [setError, ws.id]","fix":{"range":[20063,20070],"text":"[setError, ws.id]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":445,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":445,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20426,20429],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20426,20429],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":454,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":454,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20693,20696],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20693,20696],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\WorkspacePanel.tsx:533:5\n  531 |\n  532 |   useEffect(() => {\n> 533 |     setLoading(true)\n      |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  534 |     listAIKeys(ws.id).then(d => setKeys(d.keys)).catch(e => setError(e.message)).finally(() => setLoading(false))\n  535 |   }, [ws.id])\n  536 |","line":533,"column":5,"nodeType":null,"endLine":533,"endColumn":15},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'setError'. Either include it or remove the dependency array. If 'setError' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":535,"column":6,"nodeType":"ArrayExpression","endLine":535,"endColumn":13,"suggestions":[{"desc":"Update the dependencies array to be: [setError, ws.id]","fix":{"range":[24370,24377],"text":"[setError, ws.id]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":544,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":544,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24679,24682],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24679,24682],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":553,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":553,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24929,24932],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24929,24932],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\GitHub\\GitHubRoot\\sillinous\\fortuna-engine\\fortuna-engine\\src\\views\\WorkspacePanel.tsx:630:5\n  628 |\n  629 |   useEffect(() => {\n> 630 |     setLoading(true)\n      |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  631 |     getActivity(ws.id).then(d => setActivity(d.activity)).catch(() => {}).finally(() => setLoading(false))\n  632 |   }, [ws.id])\n  633 |","line":630,"column":5,"nodeType":null,"endLine":630,"endColumn":15}],"suppressedMessages":[],"errorCount":30,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Fortuna Engine — Workspace Panel\n * \n * Full collaboration hub: create/join workspaces, manage members,\n * share resources, pool API keys, view activity.\n */\n\nimport { useState, useEffect, useCallback } from 'react'\nimport {\n  Users, Plus, Settings, Copy, Link2, Shield, Key,\n  FileText, Trash2, LogOut, Crown, Eye, UserPlus,\n  ChevronRight, Check, RefreshCw, Activity, X, User, LogIn\n} from 'lucide-react'\nimport { useAuth } from '../context/AuthContext'\nimport {\n  listWorkspaces, createWorkspace, getWorkspace, switchWorkspace,\n  listMembers, changeMemberRole, removeMember, leaveWorkspace,\n  createInvite, joinWorkspace,\n  listResources, createResource, deleteResource,\n  listAIKeys, addAIKey, deleteAIKey,\n  getActivity,\n  getLocalActiveWorkspace, setLocalActiveWorkspace,\n  type Workspace, type WorkspaceMember, type SharedResource, type SharedAIKey,\n  type ActivityEntry, type WorkspacePermissions,\n} from '../engine/workspace-api'\n\n// ─── Styles ──────────────────────────────────────────────────────────\n\nconst card = { background: 'var(--bg-elevated)', border: '1px solid var(--border-subtle)', borderRadius: 12, padding: 16, marginBottom: 12 }\nconst pill = (color: string) => ({ display: 'inline-flex', alignItems: 'center', gap: 4, padding: '2px 8px', borderRadius: 99, fontSize: 10, fontWeight: 600, background: `${color}22`, color, border: `1px solid ${color}33` })\nconst btn = { padding: '6px 12px', borderRadius: 8, fontSize: 12, cursor: 'pointer', border: '1px solid var(--border-subtle)', background: 'var(--bg-hover)', color: 'var(--text-secondary)', display: 'inline-flex', alignItems: 'center', gap: 6 } as React.CSSProperties\nconst btnPrimary = { ...btn, background: 'linear-gradient(135deg, #f59e0b, #d97706)', border: 'none', color: '#0a0e1a', fontWeight: 600 } as React.CSSProperties\nconst input = { width: '100%', padding: '6px 10px', borderRadius: 8, fontSize: 12, background: 'var(--bg-hover)', border: '1px solid var(--border-subtle)', color: 'var(--text-primary)', outline: 'none', boxSizing: 'border-box' as const }\nconst roleColor: Record<string, string> = { owner: '#f59e0b', admin: '#8b5cf6', member: '#3b82f6', viewer: '#6b7280' }\nconst roleIcon = (role: string) => role === 'owner' ? <Crown size={10} /> : role === 'admin' ? <Shield size={10} /> : role === 'viewer' ? <Eye size={10} /> : <User size={10} />\n\n// ─── Main Panel ──────────────────────────────────────────────────────\n\ntype Tab = 'workspaces' | 'members' | 'resources' | 'keys' | 'activity'\n\nexport function WorkspacePanel() {\n  const { isLoggedIn, isOfflineMode, connectAccount } = useAuth()\n\n  // Gate: require authentication for collaboration\n  if (!isLoggedIn) {\n    return (\n      <div className=\"view-enter\" style={{ maxWidth: 800 }}>\n        <h1 className=\"section-title\">Collaboration</h1>\n        <p className=\"section-subtitle\" style={{ marginBottom: 24 }}>\n          Create or join a workspace to collaborate with others\n        </p>\n        <div style={{ ...{ background: 'var(--bg-elevated)', border: '1px solid var(--border-subtle)', borderRadius: 12, padding: 16, marginBottom: 12 }, textAlign: 'center', padding: '40px 24px' }}>\n          <div style={{ fontSize: 40, marginBottom: 12 }}>🔑</div>\n          <div style={{ fontSize: 16, fontWeight: 600, color: 'var(--text-primary)', marginBottom: 8 }}>\n            Account Required\n          </div>\n          <div style={{ fontSize: 13, color: 'var(--text-muted)', marginBottom: 20, lineHeight: 1.5 }}>\n            Collaboration features require a Fortuna account to sync workspaces,\n            share data, and manage team members.\n          </div>\n          <button\n            onClick={connectAccount}\n            style={{\n              padding: '10px 24px', borderRadius: 8, fontSize: 14, fontWeight: 600,\n              cursor: 'pointer', border: 'none',\n              background: 'linear-gradient(135deg, #f59e0b, #d97706)',\n              color: '#0a0e1a',\n            }}\n          >\n            Sign In or Create Account\n          </button>\n          {isOfflineMode && (\n            <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 12 }}>\n              You're currently in offline mode. Your local data will be preserved.\n            </div>\n          )}\n        </div>\n      </div>\n    )\n  }\n\n  const [tab, setTab] = useState<Tab>('workspaces')\n  const [workspaces, setWorkspaces] = useState<Workspace[]>([])\n  const [activeWs, setActiveWs] = useState<Workspace | null>(null)\n  const [permissions, setPermissions] = useState<WorkspacePermissions | null>(null)\n  const [loading, setLoading] = useState(true)\n  const [error, setError] = useState<string | null>(null)\n\n  const refresh = useCallback(async () => {\n    setLoading(true)\n    setError(null)\n    try {\n      const data = await listWorkspaces()\n      setWorkspaces(data.workspaces || [])\n      \n      // Restore active workspace\n      const local = getLocalActiveWorkspace()\n      if (data.active_workspace_id) {\n        const active = (data.workspaces || []).find(w => w.id === data.active_workspace_id)\n        if (active) {\n          setActiveWs(active)\n          setLocalActiveWorkspace({ id: active.id, name: active.name, role: active.role })\n          // Fetch permissions\n          const detail = await getWorkspace(active.id)\n          setPermissions(detail.permissions)\n        }\n      } else if (local) {\n        const active = (data.workspaces || []).find(w => w.id === local.id)\n        if (active) {\n          setActiveWs(active)\n          const detail = await getWorkspace(active.id)\n          setPermissions(detail.permissions)\n        }\n      }\n    } catch (e: any) {\n      setError(e.message)\n    }\n    setLoading(false)\n  }, [])\n\n  useEffect(() => { refresh() }, [refresh])\n\n  const handleSwitch = async (ws: Workspace | null) => {\n    try {\n      await switchWorkspace(ws?.id ?? null)\n      setActiveWs(ws)\n      if (ws) {\n        setLocalActiveWorkspace({ id: ws.id, name: ws.name, role: ws.role })\n        const detail = await getWorkspace(ws.id)\n        setPermissions(detail.permissions)\n      } else {\n        setLocalActiveWorkspace(null)\n        setPermissions(null)\n      }\n      // Dispatch event so useFortuna can reload state\n      window.dispatchEvent(new CustomEvent('fortuna:workspace-changed', { detail: ws }))\n    } catch (e: any) { setError(e.message) }\n  }\n\n  const tabs: { key: Tab; label: string; icon: JSX.Element; need?: keyof WorkspacePermissions }[] = [\n    { key: 'workspaces', label: 'Workspaces', icon: <Users size={12} /> },\n    { key: 'members', label: 'Members', icon: <UserPlus size={12} /> },\n    { key: 'resources', label: 'Resources', icon: <FileText size={12} /> },\n    { key: 'keys', label: 'AI Keys', icon: <Key size={12} /> },\n    { key: 'activity', label: 'Activity', icon: <Activity size={12} /> },\n  ]\n\n  return (\n    <div className=\"view-enter\" style={{ maxWidth: 800 }}>\n      <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 4 }}>\n        <h1 className=\"section-title\">Collaboration</h1>\n        {activeWs && (\n          <span style={pill(roleColor[activeWs.role] || '#6b7280')}>\n            {roleIcon(activeWs.role)} {activeWs.name}\n          </span>\n        )}\n      </div>\n      <p className=\"section-subtitle\" style={{ marginBottom: 16 }}>\n        {activeWs ? `Working in shared workspace · ${activeWs.member_count} member${activeWs.member_count !== 1 ? 's' : ''}` : 'Create or join a workspace to collaborate with others'}\n      </p>\n\n      {error && <div style={{ ...card, border: '1px solid rgba(239,68,68,0.3)', background: 'rgba(239,68,68,0.05)', color: '#fca5a5', fontSize: 12 }}>{error}</div>}\n\n      {/* Tabs */}\n      <div style={{ display: 'flex', gap: 4, marginBottom: 16, flexWrap: 'wrap' }}>\n        {tabs.map(t => (\n          <button\n            key={t.key}\n            onClick={() => setTab(t.key)}\n            disabled={t.key !== 'workspaces' && !activeWs}\n            style={{\n              ...btn,\n              ...(tab === t.key ? { background: 'rgba(251,191,36,0.1)', border: '1px solid rgba(251,191,36,0.3)', color: '#fbbf24' } : {}),\n              opacity: t.key !== 'workspaces' && !activeWs ? 0.4 : 1,\n            }}\n          >\n            {t.icon} {t.label}\n          </button>\n        ))}\n      </div>\n\n      {loading ? (\n        <div style={{ textAlign: 'center', padding: 40, color: 'var(--text-muted)' }}>\n          <RefreshCw size={16} style={{ animation: 'spin 1s linear infinite' }} /> Loading...\n        </div>\n      ) : (\n        <>\n          {tab === 'workspaces' && <WorkspacesTab workspaces={workspaces} activeWs={activeWs} onSwitch={handleSwitch} onRefresh={refresh} setError={setError} />}\n          {tab === 'members' && activeWs && <MembersTab ws={activeWs} permissions={permissions} setError={setError} />}\n          {tab === 'resources' && activeWs && <ResourcesTab ws={activeWs} permissions={permissions} setError={setError} />}\n          {tab === 'keys' && activeWs && <KeysTab ws={activeWs} permissions={permissions} setError={setError} />}\n          {tab === 'activity' && activeWs && <ActivityTab ws={activeWs} />}\n        </>\n      )}\n    </div>\n  )\n}\n\n// ─── Workspaces Tab ──────────────────────────────────────────────────\n\nfunction WorkspacesTab({ workspaces, activeWs, onSwitch, onRefresh, setError }: {\n  workspaces: Workspace[]; activeWs: Workspace | null\n  onSwitch: (ws: Workspace | null) => void; onRefresh: () => void\n  setError: (e: string | null) => void\n}) {\n  const [showCreate, setShowCreate] = useState(false)\n  const [showJoin, setShowJoin] = useState(false)\n  const [name, setName] = useState('')\n  const [desc, setDesc] = useState('')\n  const [joinCode, setJoinCode] = useState('')\n  const [busy, setBusy] = useState(false)\n\n  // Auto-detect pending invite from URL\n  useEffect(() => {\n    const pending = sessionStorage.getItem('fortuna:pending-invite')\n    if (pending) {\n      sessionStorage.removeItem('fortuna:pending-invite')\n      setJoinCode(pending)\n      setShowJoin(true)\n    }\n  }, [])\n\n  const handleCreate = async () => {\n    if (!name.trim()) return\n    setBusy(true)\n    try {\n      await createWorkspace(name.trim(), desc.trim() || undefined)\n      setShowCreate(false); setName(''); setDesc('')\n      onRefresh()\n    } catch (e: any) { setError(e.message) }\n    setBusy(false)\n  }\n\n  const handleJoin = async () => {\n    if (!joinCode.trim()) return\n    setBusy(true)\n    try {\n      await joinWorkspace(joinCode.trim())\n      setShowJoin(false); setJoinCode('')\n      onRefresh()\n    } catch (e: any) { setError(e.message) }\n    setBusy(false)\n  }\n\n  return (\n    <div>\n      {/* Personal mode */}\n      <div style={{ ...card, cursor: 'pointer', border: !activeWs ? '1px solid rgba(251,191,36,0.4)' : '1px solid var(--border-subtle)' }} onClick={() => onSwitch(null)}>\n        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\n          <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>\n            <User size={16} style={{ color: 'var(--text-muted)' }} />\n            <div>\n              <div style={{ fontSize: 13, fontWeight: 600, color: 'var(--text-primary)' }}>Personal</div>\n              <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>Your private data — not shared</div>\n            </div>\n          </div>\n          {!activeWs && <span style={pill('#10b981')}>Active</span>}\n        </div>\n      </div>\n\n      {/* Workspace list */}\n      {workspaces.map(ws => (\n        <div\n          key={ws.id}\n          style={{ ...card, cursor: 'pointer', border: activeWs?.id === ws.id ? '1px solid rgba(251,191,36,0.4)' : '1px solid var(--border-subtle)' }}\n          onClick={() => onSwitch(ws)}\n        >\n          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\n            <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>\n              <Users size={16} style={{ color: roleColor[ws.role] }} />\n              <div>\n                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n                  <span style={{ fontSize: 13, fontWeight: 600, color: 'var(--text-primary)' }}>{ws.name}</span>\n                  <span style={pill(roleColor[ws.role])}>{roleIcon(ws.role)} {ws.role}</span>\n                </div>\n                <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>{ws.member_count} member{ws.member_count !== 1 ? 's' : ''}{ws.description ? ` · ${ws.description}` : ''}</div>\n              </div>\n            </div>\n            {activeWs?.id === ws.id ? <span style={pill('#10b981')}>Active</span> : <ChevronRight size={14} style={{ color: 'var(--text-muted)' }} />}\n          </div>\n        </div>\n      ))}\n\n      {/* Actions */}\n      <div style={{ display: 'flex', gap: 8, marginTop: 16 }}>\n        <button style={btnPrimary} onClick={() => setShowCreate(!showCreate)}><Plus size={12} /> Create Workspace</button>\n        <button style={btn} onClick={() => setShowJoin(!showJoin)}><Link2 size={12} /> Join with Code</button>\n      </div>\n\n      {/* Create form */}\n      {showCreate && (\n        <div style={{ ...card, marginTop: 12 }}>\n          <div style={{ fontSize: 13, fontWeight: 600, marginBottom: 10, color: 'var(--text-primary)' }}>New Workspace</div>\n          <input placeholder=\"Workspace name\" value={name} onChange={e => setName(e.target.value)} style={{ ...input, marginBottom: 8 }} />\n          <input placeholder=\"Description (optional)\" value={desc} onChange={e => setDesc(e.target.value)} style={{ ...input, marginBottom: 10 }} />\n          <div style={{ display: 'flex', gap: 6 }}>\n            <button style={btnPrimary} onClick={handleCreate} disabled={busy || !name.trim()}>{busy ? 'Creating...' : 'Create'}</button>\n            <button style={btn} onClick={() => setShowCreate(false)}>Cancel</button>\n          </div>\n        </div>\n      )}\n\n      {/* Join form */}\n      {showJoin && (\n        <div style={{ ...card, marginTop: 12 }}>\n          <div style={{ fontSize: 13, fontWeight: 600, marginBottom: 10, color: 'var(--text-primary)' }}>Join Workspace</div>\n          <input placeholder=\"Paste invite code...\" value={joinCode} onChange={e => setJoinCode(e.target.value)} style={{ ...input, marginBottom: 10, fontFamily: 'var(--font-mono)' }} />\n          <div style={{ display: 'flex', gap: 6 }}>\n            <button style={btnPrimary} onClick={handleJoin} disabled={busy || !joinCode.trim()}>{busy ? 'Joining...' : 'Join'}</button>\n            <button style={btn} onClick={() => setShowJoin(false)}>Cancel</button>\n          </div>\n        </div>\n      )}\n    </div>\n  )\n}\n\n// ─── Members Tab ─────────────────────────────────────────────────────\n\nfunction MembersTab({ ws, permissions, setError }: { ws: Workspace; permissions: WorkspacePermissions | null; setError: (e: string | null) => void }) {\n  const [members, setMembers] = useState<WorkspaceMember[]>([])\n  const [loading, setLoading] = useState(true)\n  const [inviteLink, setInviteLink] = useState<string | null>(null)\n  const [inviteRole, setInviteRole] = useState('member')\n  const [copied, setCopied] = useState(false)\n  const canManage = permissions?.can_manage_members ?? false\n\n  useEffect(() => {\n    setLoading(true)\n    listMembers(ws.id).then(d => setMembers(d.members)).catch(e => setError(e.message)).finally(() => setLoading(false))\n  }, [ws.id])\n\n  const handleInvite = async () => {\n    try {\n      const inv = await createInvite(ws.id, { role: inviteRole, expires_hours: 168 })\n      setInviteLink(inv.invite_url || inv.invite_code)\n    } catch (e: any) { setError(e.message) }\n  }\n\n  const handleCopy = () => {\n    if (inviteLink) {\n      navigator.clipboard.writeText(inviteLink)\n      setCopied(true); setTimeout(() => setCopied(false), 2000)\n    }\n  }\n\n  const handleRemove = async (uuid: string) => {\n    if (!confirm('Remove this member?')) return\n    try {\n      await removeMember(ws.id, uuid)\n      setMembers(m => m.filter(x => x.user_uuid !== uuid))\n    } catch (e: any) { setError(e.message) }\n  }\n\n  const handleRoleChange = async (uuid: string, newRole: string) => {\n    try {\n      await changeMemberRole(ws.id, uuid, newRole)\n      setMembers(m => m.map(x => x.user_uuid === uuid ? { ...x, role: newRole as any } : x))\n    } catch (e: any) { setError(e.message) }\n  }\n\n  if (loading) return <div style={{ color: 'var(--text-muted)', fontSize: 12, padding: 20 }}>Loading members...</div>\n\n  return (\n    <div>\n      {/* Invite */}\n      {canManage && (\n        <div style={{ ...card, background: 'rgba(251,191,36,0.03)' }}>\n          <div style={{ fontSize: 13, fontWeight: 600, marginBottom: 10, color: 'var(--text-primary)' }}>\n            <UserPlus size={13} style={{ marginRight: 6 }} /> Invite People\n          </div>\n          <div style={{ display: 'flex', gap: 8, alignItems: 'center', flexWrap: 'wrap' }}>\n            <select value={inviteRole} onChange={e => setInviteRole(e.target.value)} style={{ ...input, width: 'auto' }}>\n              <option value=\"member\">Member</option>\n              <option value=\"admin\">Admin</option>\n              <option value=\"viewer\">Viewer</option>\n            </select>\n            <button style={btnPrimary} onClick={handleInvite}>Generate Invite Link</button>\n          </div>\n          {inviteLink && (\n            <div style={{ marginTop: 10, display: 'flex', gap: 6, alignItems: 'center' }}>\n              <code style={{ flex: 1, fontSize: 11, padding: '6px 8px', background: 'var(--bg-hover)', borderRadius: 6, color: '#fbbf24', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{inviteLink}</code>\n              <button style={btn} onClick={handleCopy}>{copied ? <Check size={12} /> : <Copy size={12} />} {copied ? 'Copied' : 'Copy'}</button>\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* Member list */}\n      {members.map(m => (\n        <div key={m.user_uuid} style={{ ...card, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\n          <div>\n            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n              <span style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)' }}>{m.display_name || m.email}</span>\n              <span style={pill(roleColor[m.role])}>{roleIcon(m.role)} {m.role}</span>\n            </div>\n            <div style={{ fontSize: 11, color: 'var(--text-muted)' }}>{m.email}{m.last_active_at ? ` · Last active ${new Date(m.last_active_at).toLocaleDateString()}` : ''}</div>\n          </div>\n          {canManage && m.role !== 'owner' && (\n            <div style={{ display: 'flex', gap: 4 }}>\n              <select\n                value={m.role}\n                onChange={e => handleRoleChange(m.user_uuid, e.target.value)}\n                style={{ ...input, width: 'auto', fontSize: 11, padding: '3px 6px' }}\n              >\n                <option value=\"admin\">Admin</option>\n                <option value=\"member\">Member</option>\n                <option value=\"viewer\">Viewer</option>\n              </select>\n              <button style={{ ...btn, padding: '3px 6px', color: '#ef4444' }} onClick={() => handleRemove(m.user_uuid)}>\n                <Trash2 size={11} />\n              </button>\n            </div>\n          )}\n        </div>\n      ))}\n    </div>\n  )\n}\n\n// ─── Resources Tab ───────────────────────────────────────────────────\n\nfunction ResourcesTab({ ws, permissions, setError }: { ws: Workspace; permissions: WorkspacePermissions | null; setError: (e: string | null) => void }) {\n  const [resources, setResources] = useState<SharedResource[]>([])\n  const [loading, setLoading] = useState(true)\n  const [showAdd, setShowAdd] = useState(false)\n  const [title, setTitle] = useState('')\n  const [resType, setResType] = useState('note')\n  const [content, setContent] = useState('')\n  const [busy, setBusy] = useState(false)\n  const canEdit = permissions?.can_edit_data ?? false\n\n  useEffect(() => {\n    setLoading(true)\n    listResources(ws.id).then(d => setResources(d.resources)).catch(e => setError(e.message)).finally(() => setLoading(false))\n  }, [ws.id])\n\n  const handleAdd = async () => {\n    if (!title.trim()) return\n    setBusy(true)\n    try {\n      await createResource(ws.id, { title: title.trim(), resource_type: resType, content: content.trim() || undefined })\n      setShowAdd(false); setTitle(''); setContent('')\n      const d = await listResources(ws.id); setResources(d.resources)\n    } catch (e: any) { setError(e.message) }\n    setBusy(false)\n  }\n\n  const handleDelete = async (uuid: string) => {\n    if (!confirm('Delete this resource?')) return\n    try {\n      await deleteResource(uuid)\n      setResources(r => r.filter(x => x.uuid !== uuid))\n    } catch (e: any) { setError(e.message) }\n  }\n\n  const typeIcon: Record<string, string> = { document: '📄', note: '📝', template: '📋', snapshot: '💾', config: '⚙️' }\n\n  if (loading) return <div style={{ color: 'var(--text-muted)', fontSize: 12, padding: 20 }}>Loading resources...</div>\n\n  return (\n    <div>\n      {canEdit && (\n        <button style={{ ...btnPrimary, marginBottom: 12 }} onClick={() => setShowAdd(!showAdd)}>\n          <Plus size={12} /> Add Resource\n        </button>\n      )}\n\n      {showAdd && (\n        <div style={{ ...card }}>\n          <div style={{ display: 'flex', gap: 8, marginBottom: 8 }}>\n            <input placeholder=\"Title\" value={title} onChange={e => setTitle(e.target.value)} style={{ ...input, flex: 1 }} />\n            <select value={resType} onChange={e => setResType(e.target.value)} style={{ ...input, width: 'auto' }}>\n              <option value=\"note\">Note</option>\n              <option value=\"document\">Document</option>\n              <option value=\"template\">Template</option>\n              <option value=\"config\">Config</option>\n            </select>\n          </div>\n          <textarea\n            placeholder=\"Content (notes, data, JSON, etc.)\"\n            value={content}\n            onChange={e => setContent(e.target.value)}\n            rows={4}\n            style={{ ...input, resize: 'vertical', fontFamily: 'var(--font-mono)', fontSize: 11 }}\n          />\n          <div style={{ display: 'flex', gap: 6, marginTop: 8 }}>\n            <button style={btnPrimary} onClick={handleAdd} disabled={busy || !title.trim()}>{busy ? 'Saving...' : 'Save'}</button>\n            <button style={btn} onClick={() => setShowAdd(false)}>Cancel</button>\n          </div>\n        </div>\n      )}\n\n      {resources.length === 0 ? (\n        <div style={{ ...card, textAlign: 'center', color: 'var(--text-muted)', fontSize: 13 }}>No shared resources yet</div>\n      ) : resources.map(r => (\n        <div key={r.uuid} style={{ ...card, display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>\n          <div>\n            <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>\n              <span>{typeIcon[r.type] || '📎'}</span>\n              <span style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)' }}>{r.title}</span>\n              {r.is_pinned && <span style={pill('#f59e0b')}>📌 Pinned</span>}\n            </div>\n            <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 2 }}>\n              {r.uploaded_by} · {new Date(r.created_at).toLocaleDateString()}\n              {r.tags.length > 0 && ` · ${r.tags.join(', ')}`}\n            </div>\n          </div>\n          {canEdit && (\n            <button style={{ ...btn, padding: '3px 6px', color: '#ef4444' }} onClick={() => handleDelete(r.uuid)}>\n              <Trash2 size={11} />\n            </button>\n          )}\n        </div>\n      ))}\n    </div>\n  )\n}\n\n// ─── AI Keys Tab ─────────────────────────────────────────────────────\n\nfunction KeysTab({ ws, permissions, setError }: { ws: Workspace; permissions: WorkspacePermissions | null; setError: (e: string | null) => void }) {\n  const [keys, setKeys] = useState<SharedAIKey[]>([])\n  const [loading, setLoading] = useState(true)\n  const [showAdd, setShowAdd] = useState(false)\n  const [provider, setProvider] = useState('openrouter')\n  const [keyVal, setKeyVal] = useState('')\n  const [label, setLabel] = useState('')\n  const [busy, setBusy] = useState(false)\n  const canManage = permissions?.can_manage_keys ?? false\n\n  useEffect(() => {\n    setLoading(true)\n    listAIKeys(ws.id).then(d => setKeys(d.keys)).catch(e => setError(e.message)).finally(() => setLoading(false))\n  }, [ws.id])\n\n  const handleAdd = async () => {\n    if (!keyVal.trim()) return\n    setBusy(true)\n    try {\n      await addAIKey(ws.id, provider, keyVal.trim(), label.trim() || undefined)\n      setShowAdd(false); setKeyVal(''); setLabel('')\n      const d = await listAIKeys(ws.id); setKeys(d.keys)\n    } catch (e: any) { setError(e.message) }\n    setBusy(false)\n  }\n\n  const handleDelete = async (id: number) => {\n    if (!confirm('Remove this API key?')) return\n    try {\n      await deleteAIKey(id)\n      setKeys(k => k.filter(x => x.id !== id))\n    } catch (e: any) { setError(e.message) }\n  }\n\n  const providerIcon: Record<string, string> = { anthropic: '🟠', openai: '🟢', gemini: '🔵', openrouter: '🟣' }\n\n  if (loading) return <div style={{ color: 'var(--text-muted)', fontSize: 12, padding: 20 }}>Loading keys...</div>\n\n  return (\n    <div>\n      <div style={{ ...card, background: 'rgba(139,92,246,0.03)', fontSize: 12, color: 'var(--text-secondary)', lineHeight: 1.5 }}>\n        <Key size={13} style={{ marginRight: 6, verticalAlign: 'middle' }} />\n        Shared API keys are encrypted on the server and used by all workspace members for the AI Advisor. Members never see the actual key.\n      </div>\n\n      {canManage && (\n        <button style={{ ...btnPrimary, marginBottom: 12 }} onClick={() => setShowAdd(!showAdd)}>\n          <Plus size={12} /> Add API Key\n        </button>\n      )}\n\n      {showAdd && (\n        <div style={{ ...card }}>\n          <div style={{ display: 'flex', gap: 8, marginBottom: 8 }}>\n            <select value={provider} onChange={e => setProvider(e.target.value)} style={{ ...input, width: 'auto' }}>\n              <option value=\"anthropic\">🟠 Anthropic</option>\n              <option value=\"openai\">🟢 OpenAI</option>\n              <option value=\"gemini\">🔵 Gemini</option>\n              <option value=\"openrouter\">🟣 OpenRouter</option>\n            </select>\n            <input placeholder=\"Label (optional)\" value={label} onChange={e => setLabel(e.target.value)} style={{ ...input, flex: 1 }} />\n          </div>\n          <input\n            type=\"password\"\n            placeholder=\"API key...\"\n            value={keyVal}\n            onChange={e => setKeyVal(e.target.value)}\n            style={{ ...input, marginBottom: 10, fontFamily: 'var(--font-mono)' }}\n          />\n          <div style={{ display: 'flex', gap: 6 }}>\n            <button style={btnPrimary} onClick={handleAdd} disabled={busy || !keyVal.trim()}>{busy ? 'Adding...' : 'Add Key'}</button>\n            <button style={btn} onClick={() => setShowAdd(false)}>Cancel</button>\n          </div>\n        </div>\n      )}\n\n      {keys.length === 0 ? (\n        <div style={{ ...card, textAlign: 'center', color: 'var(--text-muted)', fontSize: 13 }}>No shared API keys configured</div>\n      ) : keys.map(k => (\n        <div key={k.id} style={{ ...card, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\n          <div>\n            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>\n              <span>{providerIcon[k.provider] || '⚪'}</span>\n              <span style={{ fontSize: 13, fontWeight: 500, color: 'var(--text-primary)' }}>{k.label || k.provider}</span>\n              {k.is_active ? <span style={pill('#10b981')}>Active</span> : <span style={pill('#6b7280')}>Inactive</span>}\n            </div>\n            <div style={{ fontSize: 11, color: 'var(--text-muted)', marginTop: 2, fontFamily: 'var(--font-mono)' }}>\n              {k.key_preview} · {k.usage_count} uses · Added by {k.added_by}\n            </div>\n          </div>\n          {canManage && (\n            <button style={{ ...btn, padding: '3px 6px', color: '#ef4444' }} onClick={() => handleDelete(k.id)}>\n              <Trash2 size={11} />\n            </button>\n          )}\n        </div>\n      ))}\n    </div>\n  )\n}\n\n// ─── Activity Tab ────────────────────────────────────────────────────\n\nfunction ActivityTab({ ws }: { ws: Workspace }) {\n  const [activity, setActivity] = useState<ActivityEntry[]>([])\n  const [loading, setLoading] = useState(true)\n\n  useEffect(() => {\n    setLoading(true)\n    getActivity(ws.id).then(d => setActivity(d.activity)).catch(() => {}).finally(() => setLoading(false))\n  }, [ws.id])\n\n  const actionIcon: Record<string, string> = {\n    created: '🏗️', joined: '👋', left: '🚪', saved_state: '💾', uploaded_resource: '📎',\n    deleted_resource: '🗑️', added_key: '🔑', removed_key: '🔓', created_invite: '✉️',\n    role_changed: '🔄', removed_member: '❌', updated_settings: '⚙️',\n  }\n\n  if (loading) return <div style={{ color: 'var(--text-muted)', fontSize: 12, padding: 20 }}>Loading activity...</div>\n\n  return (\n    <div>\n      {activity.length === 0 ? (\n        <div style={{ ...card, textAlign: 'center', color: 'var(--text-muted)', fontSize: 13 }}>No activity yet</div>\n      ) : activity.map((a, i) => (\n        <div key={i} style={{ display: 'flex', gap: 10, padding: '8px 0', borderBottom: '1px solid var(--border-subtle)' }}>\n          <span style={{ fontSize: 14, lineHeight: '20px' }}>{actionIcon[a.action] || '•'}</span>\n          <div>\n            <div style={{ fontSize: 12, color: 'var(--text-primary)' }}>\n              <strong>{a.user}</strong> {a.detail || a.action.replace(/_/g, ' ')}\n            </div>\n            <div style={{ fontSize: 10, color: 'var(--text-muted)' }}>{new Date(a.created_at).toLocaleString()}</div>\n          </div>\n        </div>\n      ))}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]}]
